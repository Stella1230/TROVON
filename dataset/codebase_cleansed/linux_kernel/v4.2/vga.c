u8\r\nnv_rdport(void *obj, int head, u16 port)\r\n{\r\nstruct nvkm_device *device = nv_device(obj);\r\nif (device->card_type >= NV_50)\r\nreturn nv_rd08(obj, 0x601000 + port);\r\nif (port == 0x03c0 || port == 0x03c1 ||\r\nport == 0x03c2 || port == 0x03da ||\r\nport == 0x03d4 || port == 0x03d5)\r\nreturn nv_rd08(obj, 0x601000 + (head * 0x2000) + port);\r\nif (port == 0x03c2 || port == 0x03cc ||\r\nport == 0x03c4 || port == 0x03c5 ||\r\nport == 0x03ce || port == 0x03cf) {\r\nif (device->card_type < NV_40)\r\nhead = 0;\r\nreturn nv_rd08(obj, 0x0c0000 + (head * 0x2000) + port);\r\n}\r\nnv_error(obj, "unknown vga port 0x%04x\n", port);\r\nreturn 0x00;\r\n}\r\nvoid\r\nnv_wrport(void *obj, int head, u16 port, u8 data)\r\n{\r\nstruct nvkm_device *device = nv_device(obj);\r\nif (device->card_type >= NV_50)\r\nnv_wr08(obj, 0x601000 + port, data);\r\nelse\r\nif (port == 0x03c0 || port == 0x03c1 ||\r\nport == 0x03c2 || port == 0x03da ||\r\nport == 0x03d4 || port == 0x03d5)\r\nnv_wr08(obj, 0x601000 + (head * 0x2000) + port, data);\r\nelse\r\nif (port == 0x03c2 || port == 0x03cc ||\r\nport == 0x03c4 || port == 0x03c5 ||\r\nport == 0x03ce || port == 0x03cf) {\r\nif (device->card_type < NV_40)\r\nhead = 0;\r\nnv_wr08(obj, 0x0c0000 + (head * 0x2000) + port, data);\r\n} else\r\nnv_error(obj, "unknown vga port 0x%04x\n", port);\r\n}\r\nu8\r\nnv_rdvgas(void *obj, int head, u8 index)\r\n{\r\nnv_wrport(obj, head, 0x03c4, index);\r\nreturn nv_rdport(obj, head, 0x03c5);\r\n}\r\nvoid\r\nnv_wrvgas(void *obj, int head, u8 index, u8 value)\r\n{\r\nnv_wrport(obj, head, 0x03c4, index);\r\nnv_wrport(obj, head, 0x03c5, value);\r\n}\r\nu8\r\nnv_rdvgag(void *obj, int head, u8 index)\r\n{\r\nnv_wrport(obj, head, 0x03ce, index);\r\nreturn nv_rdport(obj, head, 0x03cf);\r\n}\r\nvoid\r\nnv_wrvgag(void *obj, int head, u8 index, u8 value)\r\n{\r\nnv_wrport(obj, head, 0x03ce, index);\r\nnv_wrport(obj, head, 0x03cf, value);\r\n}\r\nu8\r\nnv_rdvgac(void *obj, int head, u8 index)\r\n{\r\nnv_wrport(obj, head, 0x03d4, index);\r\nreturn nv_rdport(obj, head, 0x03d5);\r\n}\r\nvoid\r\nnv_wrvgac(void *obj, int head, u8 index, u8 value)\r\n{\r\nnv_wrport(obj, head, 0x03d4, index);\r\nnv_wrport(obj, head, 0x03d5, value);\r\n}\r\nu8\r\nnv_rdvgai(void *obj, int head, u16 port, u8 index)\r\n{\r\nif (port == 0x03c4) return nv_rdvgas(obj, head, index);\r\nif (port == 0x03ce) return nv_rdvgag(obj, head, index);\r\nif (port == 0x03d4) return nv_rdvgac(obj, head, index);\r\nnv_error(obj, "unknown indexed vga port 0x%04x\n", port);\r\nreturn 0x00;\r\n}\r\nvoid\r\nnv_wrvgai(void *obj, int head, u16 port, u8 index, u8 value)\r\n{\r\nif (port == 0x03c4) nv_wrvgas(obj, head, index, value);\r\nelse if (port == 0x03ce) nv_wrvgag(obj, head, index, value);\r\nelse if (port == 0x03d4) nv_wrvgac(obj, head, index, value);\r\nelse nv_error(obj, "unknown indexed vga port 0x%04x\n", port);\r\n}\r\nbool\r\nnv_lockvgac(void *obj, bool lock)\r\n{\r\nstruct nvkm_device *dev = nv_device(obj);\r\nbool locked = !nv_rdvgac(obj, 0, 0x1f);\r\nu8 data = lock ? 0x99 : 0x57;\r\nif (dev->card_type < NV_50)\r\nnv_wrvgac(obj, 0, 0x1f, data);\r\nelse\r\nnv_wrvgac(obj, 0, 0x3f, data);\r\nif (dev->chipset == 0x11) {\r\nif (!(nv_rd32(obj, 0x001084) & 0x10000000))\r\nnv_wrvgac(obj, 1, 0x1f, data);\r\n}\r\nreturn locked;\r\n}\r\nu8\r\nnv_rdvgaowner(void *obj)\r\n{\r\nif (nv_device(obj)->card_type < NV_50) {\r\nif (nv_device(obj)->chipset == 0x11) {\r\nu32 tied = nv_rd32(obj, 0x001084) & 0x10000000;\r\nif (tied == 0) {\r\nu8 slA = nv_rdvgac(obj, 0, 0x28) & 0x80;\r\nu8 tvA = nv_rdvgac(obj, 0, 0x33) & 0x01;\r\nu8 slB = nv_rdvgac(obj, 1, 0x28) & 0x80;\r\nu8 tvB = nv_rdvgac(obj, 1, 0x33) & 0x01;\r\nif (slA && !tvA) return 0x00;\r\nif (slB && !tvB) return 0x03;\r\nif (slA) return 0x00;\r\nif (slB) return 0x03;\r\nreturn 0x00;\r\n}\r\nreturn 0x04;\r\n}\r\nreturn nv_rdvgac(obj, 0, 0x44);\r\n}\r\nnv_error(obj, "rdvgaowner after nv4x\n");\r\nreturn 0x00;\r\n}\r\nvoid\r\nnv_wrvgaowner(void *obj, u8 select)\r\n{\r\nif (nv_device(obj)->card_type < NV_50) {\r\nu8 owner = (select == 1) ? 3 : select;\r\nif (nv_device(obj)->chipset == 0x11) {\r\nnv_rdvgac(obj, 0, 0x1f);\r\nnv_rdvgac(obj, 1, 0x1f);\r\n}\r\nnv_wrvgac(obj, 0, 0x44, owner);\r\nif (nv_device(obj)->chipset == 0x11) {\r\nnv_wrvgac(obj, 0, 0x2e, owner);\r\nnv_wrvgac(obj, 0, 0x2e, owner);\r\n}\r\n} else\r\nnv_error(obj, "wrvgaowner after nv4x\n");\r\n}

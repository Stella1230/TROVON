u32 hw_read_otgsc(struct ci_hdrc *ci, u32 mask)\r\n{\r\nreturn hw_read(ci, OP_OTGSC, mask);\r\n}\r\nvoid hw_write_otgsc(struct ci_hdrc *ci, u32 mask, u32 data)\r\n{\r\nhw_write(ci, OP_OTGSC, mask | OTGSC_INT_STATUS_BITS, data);\r\n}\r\nenum ci_role ci_otg_role(struct ci_hdrc *ci)\r\n{\r\nenum ci_role role = hw_read_otgsc(ci, OTGSC_ID)\r\n? CI_ROLE_GADGET\r\n: CI_ROLE_HOST;\r\nreturn role;\r\n}\r\nvoid ci_handle_vbus_change(struct ci_hdrc *ci)\r\n{\r\nif (!ci->is_otg)\r\nreturn;\r\nif (hw_read_otgsc(ci, OTGSC_BSV))\r\nusb_gadget_vbus_connect(&ci->gadget);\r\nelse\r\nusb_gadget_vbus_disconnect(&ci->gadget);\r\n}\r\nstatic void ci_handle_id_switch(struct ci_hdrc *ci)\r\n{\r\nenum ci_role role = ci_otg_role(ci);\r\nif (role != ci->role) {\r\ndev_dbg(ci->dev, "switching from %s to %s\n",\r\nci_role(ci)->name, ci->roles[role]->name);\r\nci_role_stop(ci);\r\nhw_wait_reg(ci, OP_OTGSC, OTGSC_BSV, 0,\r\nCI_VBUS_STABLE_TIMEOUT_MS);\r\nci_role_start(ci, role);\r\n}\r\n}\r\nstatic void ci_otg_work(struct work_struct *work)\r\n{\r\nstruct ci_hdrc *ci = container_of(work, struct ci_hdrc, work);\r\nif (ci_otg_is_fsm_mode(ci) && !ci_otg_fsm_work(ci)) {\r\nenable_irq(ci->irq);\r\nreturn;\r\n}\r\npm_runtime_get_sync(ci->dev);\r\nif (ci->id_event) {\r\nci->id_event = false;\r\nci_handle_id_switch(ci);\r\n} else if (ci->b_sess_valid_event) {\r\nci->b_sess_valid_event = false;\r\nci_handle_vbus_change(ci);\r\n} else\r\ndev_err(ci->dev, "unexpected event occurs at %s\n", __func__);\r\npm_runtime_put_sync(ci->dev);\r\nenable_irq(ci->irq);\r\n}\r\nint ci_hdrc_otg_init(struct ci_hdrc *ci)\r\n{\r\nINIT_WORK(&ci->work, ci_otg_work);\r\nci->wq = create_singlethread_workqueue("ci_otg");\r\nif (!ci->wq) {\r\ndev_err(ci->dev, "can't create workqueue\n");\r\nreturn -ENODEV;\r\n}\r\nif (ci_otg_is_fsm_mode(ci))\r\nreturn ci_hdrc_otg_fsm_init(ci);\r\nreturn 0;\r\n}\r\nvoid ci_hdrc_otg_destroy(struct ci_hdrc *ci)\r\n{\r\nif (ci->wq) {\r\nflush_workqueue(ci->wq);\r\ndestroy_workqueue(ci->wq);\r\n}\r\nhw_write_otgsc(ci, OTGSC_INT_EN_BITS | OTGSC_INT_STATUS_BITS,\r\nOTGSC_INT_STATUS_BITS);\r\nif (ci_otg_is_fsm_mode(ci))\r\nci_hdrc_otg_fsm_remove(ci);\r\n}

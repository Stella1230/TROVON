static inline void\r\ntakara_update_irq_hw(unsigned long irq, unsigned long mask)\r\n{\r\nint regaddr;\r\nmask = (irq >= 64 ? mask << 16 : mask >> ((irq - 16) & 0x30));\r\nregaddr = 0x510 + (((irq - 16) >> 2) & 0x0c);\r\noutl(mask & 0xffff0000UL, regaddr);\r\n}\r\nstatic inline void\r\ntakara_enable_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nunsigned long mask;\r\nmask = (cached_irq_mask[irq >= 64] &= ~(1UL << (irq & 63)));\r\ntakara_update_irq_hw(irq, mask);\r\n}\r\nstatic void\r\ntakara_disable_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nunsigned long mask;\r\nmask = (cached_irq_mask[irq >= 64] |= 1UL << (irq & 63));\r\ntakara_update_irq_hw(irq, mask);\r\n}\r\nstatic void\r\ntakara_device_interrupt(unsigned long vector)\r\n{\r\nunsigned intstatus;\r\nintstatus = inw(0x500) & 15;\r\nif (intstatus) {\r\nif (intstatus & 8) handle_irq(16+3);\r\nif (intstatus & 4) handle_irq(16+2);\r\nif (intstatus & 2) handle_irq(16+1);\r\nif (intstatus & 1) handle_irq(16+0);\r\n} else {\r\nisa_device_interrupt (vector);\r\n}\r\n}\r\nstatic void\r\ntakara_srm_device_interrupt(unsigned long vector)\r\n{\r\nint irq = (vector - 0x800) >> 4;\r\nhandle_irq(irq);\r\n}\r\nstatic void __init\r\ntakara_init_irq(void)\r\n{\r\nlong i;\r\ninit_i8259a_irqs();\r\nif (alpha_using_srm) {\r\nalpha_mv.device_interrupt = takara_srm_device_interrupt;\r\n} else {\r\nunsigned int ctlreg = inl(0x500);\r\nctlreg &= ~0x8000;\r\noutl(ctlreg, 0x500);\r\nctlreg = 0x05107c00;\r\noutl(ctlreg, 0x500);\r\n}\r\nfor (i = 16; i < 128; i += 16)\r\ntakara_update_irq_hw(i, -1);\r\nfor (i = 16; i < 128; ++i) {\r\nirq_set_chip_and_handler(i, &takara_irq_type,\r\nhandle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\ncommon_init_isa_dma();\r\n}\r\nstatic int __init\r\ntakara_map_irq_srm(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[15][5] __initdata = {\r\n{ 16+3, 16+3, 16+3, 16+3, 16+3},\r\n{ 16+2, 16+2, 16+2, 16+2, 16+2},\r\n{ 16+1, 16+1, 16+1, 16+1, 16+1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ 12, 12, 13, 14, 15},\r\n{ 8, 8, 9, 19, 11},\r\n{ 4, 4, 5, 6, 7},\r\n{ 0, 0, 1, 2, 3},\r\n{ -1, -1, -1, -1, -1},\r\n{64+ 0, 64+0, 64+1, 64+2, 64+3},\r\n{48+ 0, 48+0, 48+1, 48+2, 48+3},\r\n{32+ 0, 32+0, 32+1, 32+2, 32+3},\r\n{16+ 0, 16+0, 16+1, 16+2, 16+3},\r\n};\r\nconst long min_idsel = 6, max_idsel = 20, irqs_per_slot = 5;\r\nint irq = COMMON_TABLE_LOOKUP;\r\nif (irq >= 0 && irq < 16) {\r\nunsigned int busslot = PCI_SLOT(dev->bus->self->devfn);\r\nirq += irq_tab[busslot-min_idsel][0];\r\n}\r\nreturn irq;\r\n}\r\nstatic int __init\r\ntakara_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[15][5] __initdata = {\r\n{ 16+3, 16+3, 16+3, 16+3, 16+3},\r\n{ 16+2, 16+2, 16+2, 16+2, 16+2},\r\n{ 16+1, 16+1, 16+1, 16+1, 16+1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ 16+3, 16+3, 16+3, 16+3, 16+3},\r\n{ 16+2, 16+2, 16+2, 16+2, 16+2},\r\n{ 16+1, 16+1, 16+1, 16+1, 16+1},\r\n};\r\nconst long min_idsel = 6, max_idsel = 20, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic u8 __init\r\ntakara_swizzle(struct pci_dev *dev, u8 *pinp)\r\n{\r\nint slot = PCI_SLOT(dev->devfn);\r\nint pin = *pinp;\r\nunsigned int ctlreg = inl(0x500);\r\nunsigned int busslot;\r\nif (!dev->bus->self)\r\nreturn slot;\r\nbusslot = PCI_SLOT(dev->bus->self->devfn);\r\nif (dev->bus->number != 0\r\n&& busslot > 16\r\n&& ((1<<(36-busslot)) & ctlreg)) {\r\nif (pin == 1)\r\npin += (20 - busslot);\r\nelse {\r\nprintk(KERN_WARNING "takara_swizzle: can only "\r\n"handle cards with INTA IRQ pin.\n");\r\n}\r\n} else {\r\nprintk(KERN_WARNING "takara_swizzle: cannot handle "\r\n"card-bridge behind builtin bridge yet.\n");\r\n}\r\n*pinp = pin;\r\nreturn slot;\r\n}\r\nstatic void __init\r\ntakara_init_pci(void)\r\n{\r\nif (alpha_using_srm)\r\nalpha_mv.pci_map_irq = takara_map_irq_srm;\r\ncia_init_pci();\r\nif (pc873xx_probe() == -1) {\r\nprintk(KERN_ERR "Probing for PC873xx Super IO chip failed.\n");\r\n} else {\r\nprintk(KERN_INFO "Found %s Super IO chip at 0x%x\n",\r\npc873xx_get_model(), pc873xx_get_base());\r\npc873xx_enable_ide();\r\n}\r\n}

int perf_config_colorbool(const char *var, const char *value, int stdout_is_tty)\r\n{\r\nif (value) {\r\nif (!strcasecmp(value, "never"))\r\nreturn 0;\r\nif (!strcasecmp(value, "always"))\r\nreturn 1;\r\nif (!strcasecmp(value, "auto"))\r\ngoto auto_color;\r\n}\r\nif (!perf_config_bool(var, value))\r\nreturn 0;\r\nauto_color:\r\nif (stdout_is_tty < 0)\r\nstdout_is_tty = isatty(1);\r\nif (stdout_is_tty || (pager_in_use() && pager_use_color)) {\r\nchar *term = getenv("TERM");\r\nif (term && strcmp(term, "dumb"))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint perf_color_default_config(const char *var, const char *value, void *cb)\r\n{\r\nif (!strcmp(var, "color.ui")) {\r\nperf_use_color_default = perf_config_colorbool(var, value, -1);\r\nreturn 0;\r\n}\r\nreturn perf_default_config(var, value, cb);\r\n}\r\nstatic int __color_vsnprintf(char *bf, size_t size, const char *color,\r\nconst char *fmt, va_list args, const char *trail)\r\n{\r\nint r = 0;\r\nif (perf_use_color_default < 0) {\r\nif (isatty(1) || pager_in_use())\r\nperf_use_color_default = 1;\r\nelse\r\nperf_use_color_default = 0;\r\n}\r\nif (perf_use_color_default && *color)\r\nr += scnprintf(bf, size, "%s", color);\r\nr += vscnprintf(bf + r, size - r, fmt, args);\r\nif (perf_use_color_default && *color)\r\nr += scnprintf(bf + r, size - r, "%s", PERF_COLOR_RESET);\r\nif (trail)\r\nr += scnprintf(bf + r, size - r, "%s", trail);\r\nreturn r;\r\n}\r\nstatic int __color_vfprintf(FILE *fp, const char *color, const char *fmt,\r\nva_list args, const char *trail)\r\n{\r\nint r = 0;\r\nif (perf_use_color_default < 0) {\r\nif (isatty(fileno(fp)) || pager_in_use())\r\nperf_use_color_default = 1;\r\nelse\r\nperf_use_color_default = 0;\r\n}\r\nif (perf_use_color_default && *color)\r\nr += fprintf(fp, "%s", color);\r\nr += vfprintf(fp, fmt, args);\r\nif (perf_use_color_default && *color)\r\nr += fprintf(fp, "%s", PERF_COLOR_RESET);\r\nif (trail)\r\nr += fprintf(fp, "%s", trail);\r\nreturn r;\r\n}\r\nint color_vsnprintf(char *bf, size_t size, const char *color,\r\nconst char *fmt, va_list args)\r\n{\r\nreturn __color_vsnprintf(bf, size, color, fmt, args, NULL);\r\n}\r\nint color_vfprintf(FILE *fp, const char *color, const char *fmt, va_list args)\r\n{\r\nreturn __color_vfprintf(fp, color, fmt, args, NULL);\r\n}\r\nint color_snprintf(char *bf, size_t size, const char *color,\r\nconst char *fmt, ...)\r\n{\r\nva_list args;\r\nint r;\r\nva_start(args, fmt);\r\nr = color_vsnprintf(bf, size, color, fmt, args);\r\nva_end(args);\r\nreturn r;\r\n}\r\nint color_fprintf(FILE *fp, const char *color, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint r;\r\nva_start(args, fmt);\r\nr = color_vfprintf(fp, color, fmt, args);\r\nva_end(args);\r\nreturn r;\r\n}\r\nint color_fprintf_ln(FILE *fp, const char *color, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint r;\r\nva_start(args, fmt);\r\nr = __color_vfprintf(fp, color, fmt, args, "\n");\r\nva_end(args);\r\nreturn r;\r\n}\r\nint color_fwrite_lines(FILE *fp, const char *color,\r\nsize_t count, const char *buf)\r\n{\r\nif (!*color)\r\nreturn fwrite(buf, count, 1, fp) != 1;\r\nwhile (count) {\r\nchar *p = memchr(buf, '\n', count);\r\nif (p != buf && (fputs(color, fp) < 0 ||\r\nfwrite(buf, p ? (size_t)(p - buf) : count, 1, fp) != 1 ||\r\nfputs(PERF_COLOR_RESET, fp) < 0))\r\nreturn -1;\r\nif (!p)\r\nreturn 0;\r\nif (fputc('\n', fp) < 0)\r\nreturn -1;\r\ncount -= p + 1 - buf;\r\nbuf = p + 1;\r\n}\r\nreturn 0;\r\n}\r\nconst char *get_percent_color(double percent)\r\n{\r\nconst char *color = PERF_COLOR_NORMAL;\r\nif (fabs(percent) >= MIN_RED)\r\ncolor = PERF_COLOR_RED;\r\nelse {\r\nif (fabs(percent) > MIN_GREEN)\r\ncolor = PERF_COLOR_GREEN;\r\n}\r\nreturn color;\r\n}\r\nint percent_color_fprintf(FILE *fp, const char *fmt, double percent)\r\n{\r\nint r;\r\nconst char *color;\r\ncolor = get_percent_color(percent);\r\nr = color_fprintf(fp, color, fmt, percent);\r\nreturn r;\r\n}\r\nint value_color_snprintf(char *bf, size_t size, const char *fmt, double value)\r\n{\r\nconst char *color = get_percent_color(value);\r\nreturn color_snprintf(bf, size, color, fmt, value);\r\n}\r\nint percent_color_snprintf(char *bf, size_t size, const char *fmt, ...)\r\n{\r\nva_list args;\r\ndouble percent;\r\nva_start(args, fmt);\r\npercent = va_arg(args, double);\r\nva_end(args);\r\nreturn value_color_snprintf(bf, size, fmt, percent);\r\n}\r\nint percent_color_len_snprintf(char *bf, size_t size, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint len;\r\ndouble percent;\r\nconst char *color;\r\nva_start(args, fmt);\r\nlen = va_arg(args, int);\r\npercent = va_arg(args, double);\r\nva_end(args);\r\ncolor = get_percent_color(percent);\r\nreturn color_snprintf(bf, size, color, fmt, len, percent);\r\n}

static void via_gpio_set(struct gpio_chip *chip, unsigned int nr,\r\nint value)\r\n{\r\nstruct viafb_gpio_cfg *cfg = container_of(chip,\r\nstruct viafb_gpio_cfg,\r\ngpio_chip);\r\nu8 reg;\r\nstruct viafb_gpio *gpio;\r\nunsigned long flags;\r\nspin_lock_irqsave(&cfg->vdev->reg_lock, flags);\r\ngpio = cfg->active_gpios[nr];\r\nreg = via_read_reg(VIASR, gpio->vg_port_index);\r\nreg |= 0x40 << gpio->vg_mask_shift;\r\nif (value)\r\nreg |= 0x10 << gpio->vg_mask_shift;\r\nelse\r\nreg &= ~(0x10 << gpio->vg_mask_shift);\r\nvia_write_reg(VIASR, gpio->vg_port_index, reg);\r\nspin_unlock_irqrestore(&cfg->vdev->reg_lock, flags);\r\n}\r\nstatic int via_gpio_dir_out(struct gpio_chip *chip, unsigned int nr,\r\nint value)\r\n{\r\nvia_gpio_set(chip, nr, value);\r\nreturn 0;\r\n}\r\nstatic int via_gpio_dir_input(struct gpio_chip *chip, unsigned int nr)\r\n{\r\nstruct viafb_gpio_cfg *cfg = container_of(chip,\r\nstruct viafb_gpio_cfg,\r\ngpio_chip);\r\nstruct viafb_gpio *gpio;\r\nunsigned long flags;\r\nspin_lock_irqsave(&cfg->vdev->reg_lock, flags);\r\ngpio = cfg->active_gpios[nr];\r\nvia_write_reg_mask(VIASR, gpio->vg_port_index, 0,\r\n0x40 << gpio->vg_mask_shift);\r\nspin_unlock_irqrestore(&cfg->vdev->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int via_gpio_get(struct gpio_chip *chip, unsigned int nr)\r\n{\r\nstruct viafb_gpio_cfg *cfg = container_of(chip,\r\nstruct viafb_gpio_cfg,\r\ngpio_chip);\r\nu8 reg;\r\nstruct viafb_gpio *gpio;\r\nunsigned long flags;\r\nspin_lock_irqsave(&cfg->vdev->reg_lock, flags);\r\ngpio = cfg->active_gpios[nr];\r\nreg = via_read_reg(VIASR, gpio->vg_port_index);\r\nspin_unlock_irqrestore(&cfg->vdev->reg_lock, flags);\r\nreturn reg & (0x04 << gpio->vg_mask_shift);\r\n}\r\nstatic void viafb_gpio_enable(struct viafb_gpio *gpio)\r\n{\r\nvia_write_reg_mask(VIASR, gpio->vg_port_index, 0x02, 0x02);\r\n}\r\nstatic void viafb_gpio_disable(struct viafb_gpio *gpio)\r\n{\r\nvia_write_reg_mask(VIASR, gpio->vg_port_index, 0, 0x02);\r\n}\r\nstatic int viafb_gpio_suspend(void *private)\r\n{\r\nreturn 0;\r\n}\r\nstatic int viafb_gpio_resume(void *private)\r\n{\r\nint i;\r\nfor (i = 0; i < viafb_gpio_config.gpio_chip.ngpio; i += 2)\r\nviafb_gpio_enable(viafb_gpio_config.active_gpios[i]);\r\nreturn 0;\r\n}\r\nint viafb_gpio_lookup(const char *name)\r\n{\r\nint i;\r\nfor (i = 0; i < viafb_gpio_config.gpio_chip.ngpio; i++)\r\nif (!strcmp(name, viafb_gpio_config.active_gpios[i]->vg_name))\r\nreturn viafb_gpio_config.gpio_chip.base + i;\r\nreturn -1;\r\n}\r\nstatic int viafb_gpio_probe(struct platform_device *platdev)\r\n{\r\nstruct viafb_dev *vdev = platdev->dev.platform_data;\r\nstruct via_port_cfg *port_cfg = vdev->port_cfg;\r\nint i, ngpio = 0, ret;\r\nstruct viafb_gpio *gpio;\r\nunsigned long flags;\r\nfor (i = 0; i < VIAFB_NUM_PORTS; i++) {\r\nif (port_cfg[i].mode != VIA_MODE_GPIO)\r\ncontinue;\r\nfor (gpio = viafb_all_gpios;\r\ngpio < viafb_all_gpios + VIAFB_NUM_GPIOS; gpio++)\r\nif (gpio->vg_port_index == port_cfg[i].ioport_index) {\r\nviafb_gpio_config.active_gpios[ngpio] = gpio;\r\nviafb_gpio_config.gpio_names[ngpio] =\r\ngpio->vg_name;\r\nngpio++;\r\n}\r\n}\r\nviafb_gpio_config.gpio_chip.ngpio = ngpio;\r\nviafb_gpio_config.gpio_chip.names = viafb_gpio_config.gpio_names;\r\nviafb_gpio_config.vdev = vdev;\r\nif (ngpio == 0) {\r\nprintk(KERN_INFO "viafb: no GPIOs configured\n");\r\nreturn 0;\r\n}\r\nspin_lock_irqsave(&viafb_gpio_config.vdev->reg_lock, flags);\r\nfor (i = 0; i < ngpio; i += 2)\r\nviafb_gpio_enable(viafb_gpio_config.active_gpios[i]);\r\nspin_unlock_irqrestore(&viafb_gpio_config.vdev->reg_lock, flags);\r\nviafb_gpio_config.gpio_chip.base = -1;\r\nret = gpiochip_add(&viafb_gpio_config.gpio_chip);\r\nif (ret) {\r\nprintk(KERN_ERR "viafb: failed to add gpios (%d)\n", ret);\r\nviafb_gpio_config.gpio_chip.ngpio = 0;\r\n}\r\n#ifdef CONFIG_PM\r\nviafb_pm_register(&viafb_gpio_pm_hooks);\r\n#endif\r\nreturn ret;\r\n}\r\nstatic int viafb_gpio_remove(struct platform_device *platdev)\r\n{\r\nunsigned long flags;\r\nint i;\r\n#ifdef CONFIG_PM\r\nviafb_pm_unregister(&viafb_gpio_pm_hooks);\r\n#endif\r\nif (viafb_gpio_config.gpio_chip.ngpio > 0) {\r\ngpiochip_remove(&viafb_gpio_config.gpio_chip);\r\n}\r\nspin_lock_irqsave(&viafb_gpio_config.vdev->reg_lock, flags);\r\nfor (i = 0; i < viafb_gpio_config.gpio_chip.ngpio; i += 2)\r\nviafb_gpio_disable(viafb_gpio_config.active_gpios[i]);\r\nviafb_gpio_config.gpio_chip.ngpio = 0;\r\nspin_unlock_irqrestore(&viafb_gpio_config.vdev->reg_lock, flags);\r\nreturn 0;\r\n}\r\nint viafb_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&via_gpio_driver);\r\n}\r\nvoid viafb_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&via_gpio_driver);\r\n}

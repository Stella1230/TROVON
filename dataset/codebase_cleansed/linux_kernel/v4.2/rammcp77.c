static int\r\nmcp77_ram_ctor(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *data, u32 datasize,\r\nstruct nvkm_object **pobject)\r\n{\r\nu32 rsvd_head = ( 256 * 1024);\r\nu32 rsvd_tail = (1024 * 1024);\r\nstruct nvkm_fb *pfb = nvkm_fb(parent);\r\nstruct mcp77_ram_priv *priv;\r\nint ret;\r\nret = nvkm_ram_create(parent, engine, oclass, &priv);\r\n*pobject = nv_object(priv);\r\nif (ret)\r\nreturn ret;\r\npriv->base.type = NV_MEM_TYPE_STOLEN;\r\npriv->base.stolen = (u64)nv_rd32(pfb, 0x100e10) << 12;\r\npriv->base.size = (u64)nv_rd32(pfb, 0x100e14) << 12;\r\nrsvd_tail += 0x1000;\r\npriv->poller_base = priv->base.size - rsvd_tail;\r\nret = nvkm_mm_init(&pfb->vram, rsvd_head >> 12,\r\n(priv->base.size - (rsvd_head + rsvd_tail)) >> 12,\r\n1);\r\nif (ret)\r\nreturn ret;\r\npriv->base.get = nv50_ram_get;\r\npriv->base.put = nv50_ram_put;\r\nreturn 0;\r\n}\r\nstatic int\r\nmcp77_ram_init(struct nvkm_object *object)\r\n{\r\nstruct nvkm_fb *pfb = nvkm_fb(object);\r\nstruct mcp77_ram_priv *priv = (void *)object;\r\nint ret;\r\nu64 dniso, hostnb, flush;\r\nret = nvkm_ram_init(&priv->base);\r\nif (ret)\r\nreturn ret;\r\ndniso = ((priv->base.size - (priv->poller_base + 0x00)) >> 5) - 1;\r\nhostnb = ((priv->base.size - (priv->poller_base + 0x20)) >> 5) - 1;\r\nflush = ((priv->base.size - (priv->poller_base + 0x40)) >> 5) - 1;\r\nnv_wr32(pfb, 0x100c18, dniso);\r\nnv_mask(pfb, 0x100c14, 0x00000000, 0x00000001);\r\nnv_wr32(pfb, 0x100c1c, hostnb);\r\nnv_mask(pfb, 0x100c14, 0x00000000, 0x00000002);\r\nnv_wr32(pfb, 0x100c24, flush);\r\nnv_mask(pfb, 0x100c14, 0x00000000, 0x00010000);\r\nreturn 0;\r\n}

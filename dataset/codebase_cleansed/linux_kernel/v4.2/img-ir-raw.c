static void img_ir_refresh_raw(struct img_ir_priv *priv, u32 irq_status)\r\n{\r\nstruct img_ir_priv_raw *raw = &priv->raw;\r\nstruct rc_dev *rc_dev = priv->raw.rdev;\r\nint multiple;\r\nu32 ir_status;\r\nmultiple = ((irq_status & IMG_IR_IRQ_EDGE) == IMG_IR_IRQ_EDGE);\r\nir_status = img_ir_read(priv, IMG_IR_STATUS) & IMG_IR_IRRXD;\r\nif (multiple && ir_status == raw->last_status)\r\nreturn;\r\nraw->last_status = ir_status;\r\nif (ir_status)\r\nir_raw_event_store_edge(rc_dev, IR_SPACE);\r\nelse\r\nir_raw_event_store_edge(rc_dev, IR_PULSE);\r\nir_raw_event_handle(rc_dev);\r\n}\r\nvoid img_ir_isr_raw(struct img_ir_priv *priv, u32 irq_status)\r\n{\r\nstruct img_ir_priv_raw *raw = &priv->raw;\r\nif (!raw->rdev)\r\nreturn;\r\nimg_ir_refresh_raw(priv, irq_status);\r\nmod_timer(&raw->timer, jiffies + msecs_to_jiffies(ECHO_TIMEOUT_MS));\r\n}\r\nstatic void img_ir_echo_timer(unsigned long arg)\r\n{\r\nstruct img_ir_priv *priv = (struct img_ir_priv *)arg;\r\nspin_lock_irq(&priv->lock);\r\nif (priv->raw.rdev)\r\nimg_ir_refresh_raw(priv, 0);\r\nspin_unlock_irq(&priv->lock);\r\n}\r\nvoid img_ir_setup_raw(struct img_ir_priv *priv)\r\n{\r\nu32 irq_en;\r\nif (!priv->raw.rdev)\r\nreturn;\r\nspin_lock_irq(&priv->lock);\r\nirq_en = img_ir_read(priv, IMG_IR_IRQ_ENABLE);\r\nirq_en |= IMG_IR_IRQ_EDGE;\r\nimg_ir_write(priv, IMG_IR_IRQ_CLEAR, IMG_IR_IRQ_EDGE);\r\nimg_ir_write(priv, IMG_IR_IRQ_ENABLE, irq_en);\r\nspin_unlock_irq(&priv->lock);\r\n}\r\nint img_ir_probe_raw(struct img_ir_priv *priv)\r\n{\r\nstruct img_ir_priv_raw *raw = &priv->raw;\r\nstruct rc_dev *rdev;\r\nint error;\r\nsetup_timer(&raw->timer, img_ir_echo_timer, (unsigned long)priv);\r\nraw->rdev = rdev = rc_allocate_device();\r\nif (!rdev) {\r\ndev_err(priv->dev, "cannot allocate raw input device\n");\r\nreturn -ENOMEM;\r\n}\r\nrdev->priv = priv;\r\nrdev->map_name = RC_MAP_EMPTY;\r\nrdev->input_name = "IMG Infrared Decoder Raw";\r\nrdev->driver_type = RC_DRIVER_IR_RAW;\r\nerror = rc_register_device(rdev);\r\nif (error) {\r\ndev_err(priv->dev, "failed to register raw IR input device\n");\r\nrc_free_device(rdev);\r\nraw->rdev = NULL;\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nvoid img_ir_remove_raw(struct img_ir_priv *priv)\r\n{\r\nstruct img_ir_priv_raw *raw = &priv->raw;\r\nstruct rc_dev *rdev = raw->rdev;\r\nu32 irq_en;\r\nif (!rdev)\r\nreturn;\r\nspin_lock_irq(&priv->lock);\r\nraw->rdev = NULL;\r\nirq_en = img_ir_read(priv, IMG_IR_IRQ_ENABLE);\r\nirq_en &= ~IMG_IR_IRQ_EDGE;\r\nimg_ir_write(priv, IMG_IR_IRQ_ENABLE, irq_en);\r\nimg_ir_write(priv, IMG_IR_IRQ_CLEAR, IMG_IR_IRQ_EDGE);\r\nspin_unlock_irq(&priv->lock);\r\nrc_unregister_device(rdev);\r\ndel_timer_sync(&raw->timer);\r\n}

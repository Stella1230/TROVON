static void ftrace_dump_buf(int skip_lines, long cpu_file)\r\n{\r\nstatic struct trace_iterator iter;\r\nstatic struct ring_buffer_iter *buffer_iter[CONFIG_NR_CPUS];\r\nunsigned int old_userobj;\r\nint cnt = 0, cpu;\r\ntrace_init_global_iter(&iter);\r\niter.buffer_iter = buffer_iter;\r\nfor_each_tracing_cpu(cpu) {\r\natomic_inc(&per_cpu_ptr(iter.trace_buffer->data, cpu)->disabled);\r\n}\r\nold_userobj = trace_flags;\r\ntrace_flags &= ~TRACE_ITER_SYM_USEROBJ;\r\nkdb_printf("Dumping ftrace buffer:\n");\r\nmemset(&iter.seq, 0,\r\nsizeof(struct trace_iterator) -\r\noffsetof(struct trace_iterator, seq));\r\niter.iter_flags |= TRACE_FILE_LAT_FMT;\r\niter.pos = -1;\r\nif (cpu_file == RING_BUFFER_ALL_CPUS) {\r\nfor_each_tracing_cpu(cpu) {\r\niter.buffer_iter[cpu] =\r\nring_buffer_read_prepare(iter.trace_buffer->buffer, cpu);\r\nring_buffer_read_start(iter.buffer_iter[cpu]);\r\ntracing_iter_reset(&iter, cpu);\r\n}\r\n} else {\r\niter.cpu_file = cpu_file;\r\niter.buffer_iter[cpu_file] =\r\nring_buffer_read_prepare(iter.trace_buffer->buffer, cpu_file);\r\nring_buffer_read_start(iter.buffer_iter[cpu_file]);\r\ntracing_iter_reset(&iter, cpu_file);\r\n}\r\nwhile (trace_find_next_entry_inc(&iter)) {\r\nif (!cnt)\r\nkdb_printf("---------------------------------\n");\r\ncnt++;\r\nif (!skip_lines) {\r\nprint_trace_line(&iter);\r\ntrace_printk_seq(&iter.seq);\r\n} else {\r\nskip_lines--;\r\n}\r\nif (KDB_FLAG(CMD_INTERRUPT))\r\ngoto out;\r\n}\r\nif (!cnt)\r\nkdb_printf(" (ftrace buffer empty)\n");\r\nelse\r\nkdb_printf("---------------------------------\n");\r\nout:\r\ntrace_flags = old_userobj;\r\nfor_each_tracing_cpu(cpu) {\r\natomic_dec(&per_cpu_ptr(iter.trace_buffer->data, cpu)->disabled);\r\n}\r\nfor_each_tracing_cpu(cpu) {\r\nif (iter.buffer_iter[cpu]) {\r\nring_buffer_read_finish(iter.buffer_iter[cpu]);\r\niter.buffer_iter[cpu] = NULL;\r\n}\r\n}\r\n}\r\nstatic int kdb_ftdump(int argc, const char **argv)\r\n{\r\nint skip_lines = 0;\r\nlong cpu_file;\r\nchar *cp;\r\nif (argc > 2)\r\nreturn KDB_ARGCOUNT;\r\nif (argc) {\r\nskip_lines = simple_strtol(argv[1], &cp, 0);\r\nif (*cp)\r\nskip_lines = 0;\r\n}\r\nif (argc == 2) {\r\ncpu_file = simple_strtol(argv[2], &cp, 0);\r\nif (*cp || cpu_file >= NR_CPUS || cpu_file < 0 ||\r\n!cpu_online(cpu_file))\r\nreturn KDB_BADINT;\r\n} else {\r\ncpu_file = RING_BUFFER_ALL_CPUS;\r\n}\r\nkdb_trap_printk++;\r\nftrace_dump_buf(skip_lines, cpu_file);\r\nkdb_trap_printk--;\r\nreturn 0;\r\n}\r\nstatic __init int kdb_ftrace_register(void)\r\n{\r\nkdb_register_flags("ftdump", kdb_ftdump, "[skip_#lines] [cpu]",\r\n"Dump ftrace log", 0, KDB_ENABLE_ALWAYS_SAFE);\r\nreturn 0;\r\n}

int\r\nmtfsf(unsigned int FM, u32 *frB)\r\n{\r\nu32 mask;\r\nu32 fpscr;\r\nif (likely(FM == 1))\r\nmask = 0x0f;\r\nelse if (likely(FM == 0xff))\r\nmask = ~0;\r\nelse {\r\nmask = ((FM & 1) |\r\n((FM << 3) & 0x10) |\r\n((FM << 6) & 0x100) |\r\n((FM << 9) & 0x1000) |\r\n((FM << 12) & 0x10000) |\r\n((FM << 15) & 0x100000) |\r\n((FM << 18) & 0x1000000) |\r\n((FM << 21) & 0x10000000)) * 15;\r\n}\r\nfpscr = ((__FPU_FPSCR & ~mask) | (frB[1] & mask)) &\r\n~(FPSCR_VX | FPSCR_FEX | 0x800);\r\nif (fpscr & (FPSCR_VXSNAN | FPSCR_VXISI | FPSCR_VXIDI |\r\nFPSCR_VXZDZ | FPSCR_VXIMZ | FPSCR_VXVC |\r\nFPSCR_VXSOFT | FPSCR_VXSQRT | FPSCR_VXCVI))\r\nfpscr |= FPSCR_VX;\r\nif (fpscr & (fpscr >> 22) & 0xf8)\r\nfpscr |= FPSCR_FEX;\r\n__FPU_FPSCR = fpscr;\r\n#ifdef DEBUG\r\nprintk("%s: %02x %p: %08lx\n", __func__, FM, frB, __FPU_FPSCR);\r\n#endif\r\nreturn 0;\r\n}

static inline void cache_wback_all(void)\r\n{\r\nunsigned long ways, waysize, addrstart;\r\nways = current_cpu_data.dcache.ways;\r\nwaysize = current_cpu_data.dcache.sets;\r\nwaysize <<= current_cpu_data.dcache.entry_shift;\r\naddrstart = CACHE_OC_ADDRESS_ARRAY;\r\ndo {\r\nunsigned long addr;\r\nfor (addr = addrstart;\r\naddr < addrstart + waysize;\r\naddr += current_cpu_data.dcache.linesz) {\r\nunsigned long data;\r\nint v = SH_CACHE_UPDATED | SH_CACHE_VALID;\r\ndata = __raw_readl(addr);\r\nif ((data & v) == v)\r\n__raw_writel(data & ~v, addr);\r\n}\r\naddrstart += current_cpu_data.dcache.way_incr;\r\n} while (--ways);\r\n}\r\nstatic void sh7705_flush_icache_range(void *args)\r\n{\r\nstruct flusher_data *data = args;\r\nunsigned long start, end;\r\nstart = data->addr1;\r\nend = data->addr2;\r\n__flush_wback_region((void *)start, end - start);\r\n}\r\nstatic void __flush_dcache_page(unsigned long phys)\r\n{\r\nunsigned long ways, waysize, addrstart;\r\nunsigned long flags;\r\nphys |= SH_CACHE_VALID;\r\nlocal_irq_save(flags);\r\njump_to_uncached();\r\nways = current_cpu_data.dcache.ways;\r\nwaysize = current_cpu_data.dcache.sets;\r\nwaysize <<= current_cpu_data.dcache.entry_shift;\r\naddrstart = CACHE_OC_ADDRESS_ARRAY;\r\ndo {\r\nunsigned long addr;\r\nfor (addr = addrstart;\r\naddr < addrstart + waysize;\r\naddr += current_cpu_data.dcache.linesz) {\r\nunsigned long data;\r\ndata = __raw_readl(addr) & (0x1ffffC00 | SH_CACHE_VALID);\r\nif (data == phys) {\r\ndata &= ~(SH_CACHE_VALID | SH_CACHE_UPDATED);\r\n__raw_writel(data, addr);\r\n}\r\n}\r\naddrstart += current_cpu_data.dcache.way_incr;\r\n} while (--ways);\r\nback_to_cached();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void sh7705_flush_dcache_page(void *arg)\r\n{\r\nstruct page *page = arg;\r\nstruct address_space *mapping = page_mapping(page);\r\nif (mapping && !mapping_mapped(mapping))\r\nclear_bit(PG_dcache_clean, &page->flags);\r\nelse\r\n__flush_dcache_page(__pa(page_address(page)));\r\n}\r\nstatic void sh7705_flush_cache_all(void *args)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\njump_to_uncached();\r\ncache_wback_all();\r\nback_to_cached();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void sh7705_flush_cache_page(void *args)\r\n{\r\nstruct flusher_data *data = args;\r\nunsigned long pfn = data->addr2;\r\n__flush_dcache_page(pfn << PAGE_SHIFT);\r\n}\r\nstatic void sh7705_flush_icache_page(void *page)\r\n{\r\n__flush_purge_region(page_address(page), PAGE_SIZE);\r\n}\r\nvoid __init sh7705_cache_init(void)\r\n{\r\nlocal_flush_icache_range = sh7705_flush_icache_range;\r\nlocal_flush_dcache_page = sh7705_flush_dcache_page;\r\nlocal_flush_cache_all = sh7705_flush_cache_all;\r\nlocal_flush_cache_mm = sh7705_flush_cache_all;\r\nlocal_flush_cache_dup_mm = sh7705_flush_cache_all;\r\nlocal_flush_cache_range = sh7705_flush_cache_all;\r\nlocal_flush_cache_page = sh7705_flush_cache_page;\r\nlocal_flush_icache_page = sh7705_flush_icache_page;\r\n}

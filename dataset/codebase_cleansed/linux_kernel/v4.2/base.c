static int\r\nnvkm_ltc_tags_alloc(struct nvkm_ltc *ltc, u32 n, struct nvkm_mm_node **pnode)\r\n{\r\nstruct nvkm_ltc_priv *priv = (void *)ltc;\r\nint ret;\r\nret = nvkm_mm_head(&priv->tags, 0, 1, n, n, 1, pnode);\r\nif (ret)\r\n*pnode = NULL;\r\nreturn ret;\r\n}\r\nstatic void\r\nnvkm_ltc_tags_free(struct nvkm_ltc *ltc, struct nvkm_mm_node **pnode)\r\n{\r\nstruct nvkm_ltc_priv *priv = (void *)ltc;\r\nnvkm_mm_free(&priv->tags, pnode);\r\n}\r\nstatic void\r\nnvkm_ltc_tags_clear(struct nvkm_ltc *ltc, u32 first, u32 count)\r\n{\r\nconst struct nvkm_ltc_impl *impl = (void *)nv_oclass(ltc);\r\nstruct nvkm_ltc_priv *priv = (void *)ltc;\r\nconst u32 limit = first + count - 1;\r\nBUG_ON((first > limit) || (limit >= priv->num_tags));\r\nimpl->cbc_clear(priv, first, limit);\r\nimpl->cbc_wait(priv);\r\n}\r\nstatic int\r\nnvkm_ltc_zbc_color_get(struct nvkm_ltc *ltc, int index, const u32 color[4])\r\n{\r\nconst struct nvkm_ltc_impl *impl = (void *)nv_oclass(ltc);\r\nstruct nvkm_ltc_priv *priv = (void *)ltc;\r\nmemcpy(priv->zbc_color[index], color, sizeof(priv->zbc_color[index]));\r\nimpl->zbc_clear_color(priv, index, color);\r\nreturn index;\r\n}\r\nstatic int\r\nnvkm_ltc_zbc_depth_get(struct nvkm_ltc *ltc, int index, const u32 depth)\r\n{\r\nconst struct nvkm_ltc_impl *impl = (void *)nv_oclass(ltc);\r\nstruct nvkm_ltc_priv *priv = (void *)ltc;\r\npriv->zbc_depth[index] = depth;\r\nimpl->zbc_clear_depth(priv, index, depth);\r\nreturn index;\r\n}\r\nint\r\n_nvkm_ltc_init(struct nvkm_object *object)\r\n{\r\nconst struct nvkm_ltc_impl *impl = (void *)nv_oclass(object);\r\nstruct nvkm_ltc_priv *priv = (void *)object;\r\nint ret, i;\r\nret = nvkm_subdev_init(&priv->base.base);\r\nif (ret)\r\nreturn ret;\r\nfor (i = priv->base.zbc_min; i <= priv->base.zbc_max; i++) {\r\nimpl->zbc_clear_color(priv, i, priv->zbc_color[i]);\r\nimpl->zbc_clear_depth(priv, i, priv->zbc_depth[i]);\r\n}\r\nreturn 0;\r\n}\r\nint\r\nnvkm_ltc_create_(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, int length, void **pobject)\r\n{\r\nconst struct nvkm_ltc_impl *impl = (void *)oclass;\r\nstruct nvkm_ltc_priv *priv;\r\nint ret;\r\nret = nvkm_subdev_create_(parent, engine, oclass, 0, "PLTCG",\r\n"l2c", length, pobject);\r\npriv = *pobject;\r\nif (ret)\r\nreturn ret;\r\nmemset(priv->zbc_color, 0x00, sizeof(priv->zbc_color));\r\nmemset(priv->zbc_depth, 0x00, sizeof(priv->zbc_depth));\r\npriv->base.base.intr = impl->intr;\r\npriv->base.tags_alloc = nvkm_ltc_tags_alloc;\r\npriv->base.tags_free = nvkm_ltc_tags_free;\r\npriv->base.tags_clear = nvkm_ltc_tags_clear;\r\npriv->base.zbc_min = 1;\r\npriv->base.zbc_max = min(impl->zbc, NVKM_LTC_MAX_ZBC_CNT) - 1;\r\npriv->base.zbc_color_get = nvkm_ltc_zbc_color_get;\r\npriv->base.zbc_depth_get = nvkm_ltc_zbc_depth_get;\r\nreturn 0;\r\n}

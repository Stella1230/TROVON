static void vfio_platform_mask(struct vfio_platform_irq *irq_ctx)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&irq_ctx->lock, flags);\r\nif (!irq_ctx->masked) {\r\ndisable_irq_nosync(irq_ctx->hwirq);\r\nirq_ctx->masked = true;\r\n}\r\nspin_unlock_irqrestore(&irq_ctx->lock, flags);\r\n}\r\nstatic int vfio_platform_mask_handler(void *opaque, void *unused)\r\n{\r\nstruct vfio_platform_irq *irq_ctx = opaque;\r\nvfio_platform_mask(irq_ctx);\r\nreturn 0;\r\n}\r\nstatic int vfio_platform_set_irq_mask(struct vfio_platform_device *vdev,\r\nunsigned index, unsigned start,\r\nunsigned count, uint32_t flags,\r\nvoid *data)\r\n{\r\nif (start != 0 || count != 1)\r\nreturn -EINVAL;\r\nif (!(vdev->irqs[index].flags & VFIO_IRQ_INFO_MASKABLE))\r\nreturn -EINVAL;\r\nif (flags & VFIO_IRQ_SET_DATA_EVENTFD) {\r\nint32_t fd = *(int32_t *)data;\r\nif (fd >= 0)\r\nreturn vfio_virqfd_enable((void *) &vdev->irqs[index],\r\nvfio_platform_mask_handler,\r\nNULL, NULL,\r\n&vdev->irqs[index].mask, fd);\r\nvfio_virqfd_disable(&vdev->irqs[index].mask);\r\nreturn 0;\r\n}\r\nif (flags & VFIO_IRQ_SET_DATA_NONE) {\r\nvfio_platform_mask(&vdev->irqs[index]);\r\n} else if (flags & VFIO_IRQ_SET_DATA_BOOL) {\r\nuint8_t mask = *(uint8_t *)data;\r\nif (mask)\r\nvfio_platform_mask(&vdev->irqs[index]);\r\n}\r\nreturn 0;\r\n}\r\nstatic void vfio_platform_unmask(struct vfio_platform_irq *irq_ctx)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&irq_ctx->lock, flags);\r\nif (irq_ctx->masked) {\r\nenable_irq(irq_ctx->hwirq);\r\nirq_ctx->masked = false;\r\n}\r\nspin_unlock_irqrestore(&irq_ctx->lock, flags);\r\n}\r\nstatic int vfio_platform_unmask_handler(void *opaque, void *unused)\r\n{\r\nstruct vfio_platform_irq *irq_ctx = opaque;\r\nvfio_platform_unmask(irq_ctx);\r\nreturn 0;\r\n}\r\nstatic int vfio_platform_set_irq_unmask(struct vfio_platform_device *vdev,\r\nunsigned index, unsigned start,\r\nunsigned count, uint32_t flags,\r\nvoid *data)\r\n{\r\nif (start != 0 || count != 1)\r\nreturn -EINVAL;\r\nif (!(vdev->irqs[index].flags & VFIO_IRQ_INFO_MASKABLE))\r\nreturn -EINVAL;\r\nif (flags & VFIO_IRQ_SET_DATA_EVENTFD) {\r\nint32_t fd = *(int32_t *)data;\r\nif (fd >= 0)\r\nreturn vfio_virqfd_enable((void *) &vdev->irqs[index],\r\nvfio_platform_unmask_handler,\r\nNULL, NULL,\r\n&vdev->irqs[index].unmask,\r\nfd);\r\nvfio_virqfd_disable(&vdev->irqs[index].unmask);\r\nreturn 0;\r\n}\r\nif (flags & VFIO_IRQ_SET_DATA_NONE) {\r\nvfio_platform_unmask(&vdev->irqs[index]);\r\n} else if (flags & VFIO_IRQ_SET_DATA_BOOL) {\r\nuint8_t unmask = *(uint8_t *)data;\r\nif (unmask)\r\nvfio_platform_unmask(&vdev->irqs[index]);\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t vfio_automasked_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct vfio_platform_irq *irq_ctx = dev_id;\r\nunsigned long flags;\r\nint ret = IRQ_NONE;\r\nspin_lock_irqsave(&irq_ctx->lock, flags);\r\nif (!irq_ctx->masked) {\r\nret = IRQ_HANDLED;\r\ndisable_irq_nosync(irq_ctx->hwirq);\r\nirq_ctx->masked = true;\r\n}\r\nspin_unlock_irqrestore(&irq_ctx->lock, flags);\r\nif (ret == IRQ_HANDLED)\r\neventfd_signal(irq_ctx->trigger, 1);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t vfio_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct vfio_platform_irq *irq_ctx = dev_id;\r\neventfd_signal(irq_ctx->trigger, 1);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int vfio_set_trigger(struct vfio_platform_device *vdev, int index,\r\nint fd, irq_handler_t handler)\r\n{\r\nstruct vfio_platform_irq *irq = &vdev->irqs[index];\r\nstruct eventfd_ctx *trigger;\r\nint ret;\r\nif (irq->trigger) {\r\nfree_irq(irq->hwirq, irq);\r\nkfree(irq->name);\r\neventfd_ctx_put(irq->trigger);\r\nirq->trigger = NULL;\r\n}\r\nif (fd < 0)\r\nreturn 0;\r\nirq->name = kasprintf(GFP_KERNEL, "vfio-irq[%d](%s)",\r\nirq->hwirq, vdev->name);\r\nif (!irq->name)\r\nreturn -ENOMEM;\r\ntrigger = eventfd_ctx_fdget(fd);\r\nif (IS_ERR(trigger)) {\r\nkfree(irq->name);\r\nreturn PTR_ERR(trigger);\r\n}\r\nirq->trigger = trigger;\r\nirq_set_status_flags(irq->hwirq, IRQ_NOAUTOEN);\r\nret = request_irq(irq->hwirq, handler, 0, irq->name, irq);\r\nif (ret) {\r\nkfree(irq->name);\r\neventfd_ctx_put(trigger);\r\nirq->trigger = NULL;\r\nreturn ret;\r\n}\r\nif (!irq->masked)\r\nenable_irq(irq->hwirq);\r\nreturn 0;\r\n}\r\nstatic int vfio_platform_set_irq_trigger(struct vfio_platform_device *vdev,\r\nunsigned index, unsigned start,\r\nunsigned count, uint32_t flags,\r\nvoid *data)\r\n{\r\nstruct vfio_platform_irq *irq = &vdev->irqs[index];\r\nirq_handler_t handler;\r\nif (vdev->irqs[index].flags & VFIO_IRQ_INFO_AUTOMASKED)\r\nhandler = vfio_automasked_irq_handler;\r\nelse\r\nhandler = vfio_irq_handler;\r\nif (!count && (flags & VFIO_IRQ_SET_DATA_NONE))\r\nreturn vfio_set_trigger(vdev, index, -1, handler);\r\nif (start != 0 || count != 1)\r\nreturn -EINVAL;\r\nif (flags & VFIO_IRQ_SET_DATA_EVENTFD) {\r\nint32_t fd = *(int32_t *)data;\r\nreturn vfio_set_trigger(vdev, index, fd, handler);\r\n}\r\nif (flags & VFIO_IRQ_SET_DATA_NONE) {\r\nhandler(irq->hwirq, irq);\r\n} else if (flags & VFIO_IRQ_SET_DATA_BOOL) {\r\nuint8_t trigger = *(uint8_t *)data;\r\nif (trigger)\r\nhandler(irq->hwirq, irq);\r\n}\r\nreturn 0;\r\n}\r\nint vfio_platform_set_irqs_ioctl(struct vfio_platform_device *vdev,\r\nuint32_t flags, unsigned index, unsigned start,\r\nunsigned count, void *data)\r\n{\r\nint (*func)(struct vfio_platform_device *vdev, unsigned index,\r\nunsigned start, unsigned count, uint32_t flags,\r\nvoid *data) = NULL;\r\nswitch (flags & VFIO_IRQ_SET_ACTION_TYPE_MASK) {\r\ncase VFIO_IRQ_SET_ACTION_MASK:\r\nfunc = vfio_platform_set_irq_mask;\r\nbreak;\r\ncase VFIO_IRQ_SET_ACTION_UNMASK:\r\nfunc = vfio_platform_set_irq_unmask;\r\nbreak;\r\ncase VFIO_IRQ_SET_ACTION_TRIGGER:\r\nfunc = vfio_platform_set_irq_trigger;\r\nbreak;\r\n}\r\nif (!func)\r\nreturn -ENOTTY;\r\nreturn func(vdev, index, start, count, flags, data);\r\n}\r\nint vfio_platform_irq_init(struct vfio_platform_device *vdev)\r\n{\r\nint cnt = 0, i;\r\nwhile (vdev->get_irq(vdev, cnt) >= 0)\r\ncnt++;\r\nvdev->irqs = kcalloc(cnt, sizeof(struct vfio_platform_irq), GFP_KERNEL);\r\nif (!vdev->irqs)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < cnt; i++) {\r\nint hwirq = vdev->get_irq(vdev, i);\r\nif (hwirq < 0)\r\ngoto err;\r\nspin_lock_init(&vdev->irqs[i].lock);\r\nvdev->irqs[i].flags = VFIO_IRQ_INFO_EVENTFD;\r\nif (irq_get_trigger_type(hwirq) & IRQ_TYPE_LEVEL_MASK)\r\nvdev->irqs[i].flags |= VFIO_IRQ_INFO_MASKABLE\r\n| VFIO_IRQ_INFO_AUTOMASKED;\r\nvdev->irqs[i].count = 1;\r\nvdev->irqs[i].hwirq = hwirq;\r\nvdev->irqs[i].masked = false;\r\n}\r\nvdev->num_irqs = cnt;\r\nreturn 0;\r\nerr:\r\nkfree(vdev->irqs);\r\nreturn -EINVAL;\r\n}\r\nvoid vfio_platform_irq_cleanup(struct vfio_platform_device *vdev)\r\n{\r\nint i;\r\nfor (i = 0; i < vdev->num_irqs; i++)\r\nvfio_set_trigger(vdev, i, -1, NULL);\r\nvdev->num_irqs = 0;\r\nkfree(vdev->irqs);\r\n}

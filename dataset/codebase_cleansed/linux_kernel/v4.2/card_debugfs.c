static void dbg_uidn_show(struct seq_file *s, struct genwqe_reg *regs,\r\nint entries)\r\n{\r\nunsigned int i;\r\nu32 v_hi, v_lo;\r\nfor (i = 0; i < entries; i++) {\r\nv_hi = (regs[i].val >> 32) & 0xffffffff;\r\nv_lo = (regs[i].val) & 0xffffffff;\r\nseq_printf(s, " 0x%08x 0x%08x 0x%08x 0x%08x EXT_ERR_REC\n",\r\nregs[i].addr, regs[i].idx, v_hi, v_lo);\r\n}\r\n}\r\nstatic int curr_dbg_uidn_show(struct seq_file *s, void *unused, int uid)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\nint entries;\r\nstruct genwqe_reg *regs;\r\nentries = genwqe_ffdc_buff_size(cd, uid);\r\nif (entries < 0)\r\nreturn -EINVAL;\r\nif (entries == 0)\r\nreturn 0;\r\nregs = kcalloc(entries, sizeof(*regs), GFP_KERNEL);\r\nif (regs == NULL)\r\nreturn -ENOMEM;\r\ngenwqe_stop_traps(cd);\r\ngenwqe_ffdc_buff_read(cd, uid, regs, entries);\r\ngenwqe_start_traps(cd);\r\ndbg_uidn_show(s, regs, entries);\r\nkfree(regs);\r\nreturn 0;\r\n}\r\nstatic int genwqe_curr_dbg_uid0_show(struct seq_file *s, void *unused)\r\n{\r\nreturn curr_dbg_uidn_show(s, unused, 0);\r\n}\r\nstatic int genwqe_curr_dbg_uid1_show(struct seq_file *s, void *unused)\r\n{\r\nreturn curr_dbg_uidn_show(s, unused, 1);\r\n}\r\nstatic int genwqe_curr_dbg_uid2_show(struct seq_file *s, void *unused)\r\n{\r\nreturn curr_dbg_uidn_show(s, unused, 2);\r\n}\r\nstatic int prev_dbg_uidn_show(struct seq_file *s, void *unused, int uid)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\ndbg_uidn_show(s, cd->ffdc[uid].regs, cd->ffdc[uid].entries);\r\nreturn 0;\r\n}\r\nstatic int genwqe_prev_dbg_uid0_show(struct seq_file *s, void *unused)\r\n{\r\nreturn prev_dbg_uidn_show(s, unused, 0);\r\n}\r\nstatic int genwqe_prev_dbg_uid1_show(struct seq_file *s, void *unused)\r\n{\r\nreturn prev_dbg_uidn_show(s, unused, 1);\r\n}\r\nstatic int genwqe_prev_dbg_uid2_show(struct seq_file *s, void *unused)\r\n{\r\nreturn prev_dbg_uidn_show(s, unused, 2);\r\n}\r\nstatic int genwqe_curr_regs_show(struct seq_file *s, void *unused)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\nunsigned int i;\r\nstruct genwqe_reg *regs;\r\nregs = kcalloc(GENWQE_FFDC_REGS, sizeof(*regs), GFP_KERNEL);\r\nif (regs == NULL)\r\nreturn -ENOMEM;\r\ngenwqe_stop_traps(cd);\r\ngenwqe_read_ffdc_regs(cd, regs, GENWQE_FFDC_REGS, 1);\r\ngenwqe_start_traps(cd);\r\nfor (i = 0; i < GENWQE_FFDC_REGS; i++) {\r\nif (regs[i].addr == 0xffffffff)\r\nbreak;\r\nif (regs[i].val == 0x0ull)\r\ncontinue;\r\nseq_printf(s, " 0x%08x 0x%016llx\n",\r\nregs[i].addr, regs[i].val);\r\n}\r\nreturn 0;\r\n}\r\nstatic int genwqe_prev_regs_show(struct seq_file *s, void *unused)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\nunsigned int i;\r\nstruct genwqe_reg *regs = cd->ffdc[GENWQE_DBG_REGS].regs;\r\nif (regs == NULL)\r\nreturn -EINVAL;\r\nfor (i = 0; i < GENWQE_FFDC_REGS; i++) {\r\nif (regs[i].addr == 0xffffffff)\r\nbreak;\r\nif (regs[i].val == 0x0ull)\r\ncontinue;\r\nseq_printf(s, " 0x%08x 0x%016llx\n",\r\nregs[i].addr, regs[i].val);\r\n}\r\nreturn 0;\r\n}\r\nstatic int genwqe_jtimer_show(struct seq_file *s, void *unused)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\nunsigned int vf_num;\r\nu64 jtimer;\r\njtimer = genwqe_read_vreg(cd, IO_SLC_VF_APPJOB_TIMEOUT, 0);\r\nseq_printf(s, " PF 0x%016llx %d msec\n", jtimer,\r\ngenwqe_pf_jobtimeout_msec);\r\nfor (vf_num = 0; vf_num < cd->num_vfs; vf_num++) {\r\njtimer = genwqe_read_vreg(cd, IO_SLC_VF_APPJOB_TIMEOUT,\r\nvf_num + 1);\r\nseq_printf(s, " VF%-2d 0x%016llx %d msec\n", vf_num, jtimer,\r\ncd->vf_jobtimeout_msec[vf_num]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int genwqe_queue_working_time_show(struct seq_file *s, void *unused)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\nunsigned int vf_num;\r\nu64 t;\r\nt = genwqe_read_vreg(cd, IO_SLC_VF_QUEUE_WTIME, 0);\r\nseq_printf(s, " PF 0x%016llx\n", t);\r\nfor (vf_num = 0; vf_num < cd->num_vfs; vf_num++) {\r\nt = genwqe_read_vreg(cd, IO_SLC_VF_QUEUE_WTIME, vf_num + 1);\r\nseq_printf(s, " VF%-2d 0x%016llx\n", vf_num, t);\r\n}\r\nreturn 0;\r\n}\r\nstatic int genwqe_ddcb_info_show(struct seq_file *s, void *unused)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\nunsigned int i;\r\nstruct ddcb_queue *queue;\r\nstruct ddcb *pddcb;\r\nqueue = &cd->queue;\r\nseq_puts(s, "DDCB QUEUE:\n");\r\nseq_printf(s, " ddcb_max: %d\n"\r\n" ddcb_daddr: %016llx - %016llx\n"\r\n" ddcb_vaddr: %016llx\n"\r\n" ddcbs_in_flight: %u\n"\r\n" ddcbs_max_in_flight: %u\n"\r\n" ddcbs_completed: %u\n"\r\n" return_on_busy: %u\n"\r\n" wait_on_busy: %u\n"\r\n" irqs_processed: %u\n",\r\nqueue->ddcb_max, (long long)queue->ddcb_daddr,\r\n(long long)queue->ddcb_daddr +\r\n(queue->ddcb_max * DDCB_LENGTH),\r\n(long long)queue->ddcb_vaddr, queue->ddcbs_in_flight,\r\nqueue->ddcbs_max_in_flight, queue->ddcbs_completed,\r\nqueue->return_on_busy, queue->wait_on_busy,\r\ncd->irqs_processed);\r\nseq_printf(s, " 0x%08x 0x%016llx IO_QUEUE_CONFIG\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_STATUS\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_SEGMENT\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_INITSQN\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_WRAP\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_OFFSET\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_WTIME\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_ERRCNTS\n"\r\n" 0x%08x 0x%016llx IO_QUEUE_LRW\n",\r\nqueue->IO_QUEUE_CONFIG,\r\n__genwqe_readq(cd, queue->IO_QUEUE_CONFIG),\r\nqueue->IO_QUEUE_STATUS,\r\n__genwqe_readq(cd, queue->IO_QUEUE_STATUS),\r\nqueue->IO_QUEUE_SEGMENT,\r\n__genwqe_readq(cd, queue->IO_QUEUE_SEGMENT),\r\nqueue->IO_QUEUE_INITSQN,\r\n__genwqe_readq(cd, queue->IO_QUEUE_INITSQN),\r\nqueue->IO_QUEUE_WRAP,\r\n__genwqe_readq(cd, queue->IO_QUEUE_WRAP),\r\nqueue->IO_QUEUE_OFFSET,\r\n__genwqe_readq(cd, queue->IO_QUEUE_OFFSET),\r\nqueue->IO_QUEUE_WTIME,\r\n__genwqe_readq(cd, queue->IO_QUEUE_WTIME),\r\nqueue->IO_QUEUE_ERRCNTS,\r\n__genwqe_readq(cd, queue->IO_QUEUE_ERRCNTS),\r\nqueue->IO_QUEUE_LRW,\r\n__genwqe_readq(cd, queue->IO_QUEUE_LRW));\r\nseq_printf(s, "DDCB list (ddcb_act=%d/ddcb_next=%d):\n",\r\nqueue->ddcb_act, queue->ddcb_next);\r\npddcb = queue->ddcb_vaddr;\r\nfor (i = 0; i < queue->ddcb_max; i++) {\r\nseq_printf(s, " %-3d: RETC=%03x SEQ=%04x HSI/SHI=%02x/%02x ",\r\ni, be16_to_cpu(pddcb->retc_16),\r\nbe16_to_cpu(pddcb->seqnum_16),\r\npddcb->hsi, pddcb->shi);\r\nseq_printf(s, "PRIV=%06llx CMD=%02x\n",\r\nbe64_to_cpu(pddcb->priv_64), pddcb->cmd);\r\npddcb++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int genwqe_info_show(struct seq_file *s, void *unused)\r\n{\r\nstruct genwqe_dev *cd = s->private;\r\nu16 val16, type;\r\nu64 app_id, slu_id, bitstream = -1;\r\nstruct pci_dev *pci_dev = cd->pci_dev;\r\nslu_id = __genwqe_readq(cd, IO_SLU_UNITCFG);\r\napp_id = __genwqe_readq(cd, IO_APP_UNITCFG);\r\nif (genwqe_is_privileged(cd))\r\nbitstream = __genwqe_readq(cd, IO_SLU_BITSTREAM);\r\nval16 = (u16)(slu_id & 0x0fLLU);\r\ntype = (u16)((slu_id >> 20) & 0xffLLU);\r\nseq_printf(s, "%s driver version: %s\n"\r\n" Device Name/Type: %s %s CardIdx: %d\n"\r\n" SLU/APP Config : 0x%016llx/0x%016llx\n"\r\n" Build Date : %u/%x/%u\n"\r\n" Base Clock : %u MHz\n"\r\n" Arch/SVN Release: %u/%llx\n"\r\n" Bitstream : %llx\n",\r\nGENWQE_DEVNAME, DRV_VERSION, dev_name(&pci_dev->dev),\r\ngenwqe_is_privileged(cd) ?\r\n"Physical" : "Virtual or no SR-IOV",\r\ncd->card_idx, slu_id, app_id,\r\n(u16)((slu_id >> 12) & 0x0fLLU),\r\n(u16)((slu_id >> 4) & 0xffLLU),\r\n(u16)((slu_id >> 16) & 0x0fLLU) + 2010,\r\ngenwqe_base_clock_frequency(cd),\r\n(u16)((slu_id >> 32) & 0xffLLU), slu_id >> 40,\r\nbitstream);\r\nreturn 0;\r\n}\r\nint genwqe_init_debugfs(struct genwqe_dev *cd)\r\n{\r\nstruct dentry *root;\r\nstruct dentry *file;\r\nint ret;\r\nchar card_name[64];\r\nchar name[64];\r\nunsigned int i;\r\nsprintf(card_name, "%s%d_card", GENWQE_DEVNAME, cd->card_idx);\r\nroot = debugfs_create_dir(card_name, cd->debugfs_genwqe);\r\nif (!root) {\r\nret = -ENOMEM;\r\ngoto err0;\r\n}\r\nfile = debugfs_create_file("ddcb_info", S_IRUGO, root, cd,\r\n&genwqe_ddcb_info_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("info", S_IRUGO, root, cd,\r\n&genwqe_info_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_x64("err_inject", 0666, root, &cd->err_inject);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_u32("ddcb_software_timeout", 0666, root,\r\n&cd->ddcb_software_timeout);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_u32("kill_timeout", 0666, root,\r\n&cd->kill_timeout);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nif (!genwqe_is_privileged(cd)) {\r\ncd->debugfs_root = root;\r\nreturn 0;\r\n}\r\nfile = debugfs_create_file("curr_regs", S_IRUGO, root, cd,\r\n&genwqe_curr_regs_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("curr_dbg_uid0", S_IRUGO, root, cd,\r\n&genwqe_curr_dbg_uid0_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("curr_dbg_uid1", S_IRUGO, root, cd,\r\n&genwqe_curr_dbg_uid1_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("curr_dbg_uid2", S_IRUGO, root, cd,\r\n&genwqe_curr_dbg_uid2_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("prev_regs", S_IRUGO, root, cd,\r\n&genwqe_prev_regs_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("prev_dbg_uid0", S_IRUGO, root, cd,\r\n&genwqe_prev_dbg_uid0_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("prev_dbg_uid1", S_IRUGO, root, cd,\r\n&genwqe_prev_dbg_uid1_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("prev_dbg_uid2", S_IRUGO, root, cd,\r\n&genwqe_prev_dbg_uid2_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfor (i = 0; i < GENWQE_MAX_VFS; i++) {\r\nsprintf(name, "vf%u_jobtimeout_msec", i);\r\nfile = debugfs_create_u32(name, 0666, root,\r\n&cd->vf_jobtimeout_msec[i]);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\n}\r\nfile = debugfs_create_file("jobtimer", S_IRUGO, root, cd,\r\n&genwqe_jtimer_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_file("queue_working_time", S_IRUGO, root, cd,\r\n&genwqe_queue_working_time_fops);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_u32("skip_recovery", 0666, root,\r\n&cd->skip_recovery);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nfile = debugfs_create_u32("use_platform_recovery", 0666, root,\r\n&cd->use_platform_recovery);\r\nif (!file) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\ncd->debugfs_root = root;\r\nreturn 0;\r\nerr1:\r\ndebugfs_remove_recursive(root);\r\nerr0:\r\nreturn ret;\r\n}\r\nvoid genqwe_exit_debugfs(struct genwqe_dev *cd)\r\n{\r\ndebugfs_remove_recursive(cd->debugfs_root);\r\n}

static ssize_t xgbe_common_read(char __user *buffer, size_t count,\r\nloff_t *ppos, unsigned int value)\r\n{\r\nchar *buf;\r\nssize_t len;\r\nif (*ppos != 0)\r\nreturn 0;\r\nbuf = kasprintf(GFP_KERNEL, "0x%08x\n", value);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nif (count < strlen(buf)) {\r\nkfree(buf);\r\nreturn -ENOSPC;\r\n}\r\nlen = simple_read_from_buffer(buffer, count, ppos, buf, strlen(buf));\r\nkfree(buf);\r\nreturn len;\r\n}\r\nstatic ssize_t xgbe_common_write(const char __user *buffer, size_t count,\r\nloff_t *ppos, unsigned int *value)\r\n{\r\nchar workarea[32];\r\nssize_t len;\r\nint ret;\r\nif (*ppos != 0)\r\nreturn 0;\r\nif (count >= sizeof(workarea))\r\nreturn -ENOSPC;\r\nlen = simple_write_to_buffer(workarea, sizeof(workarea) - 1, ppos,\r\nbuffer, count);\r\nif (len < 0)\r\nreturn len;\r\nworkarea[len] = '\0';\r\nret = kstrtouint(workarea, 16, value);\r\nif (ret)\r\nreturn -EIO;\r\nreturn len;\r\n}\r\nstatic ssize_t xgmac_reg_addr_read(struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nreturn xgbe_common_read(buffer, count, ppos, pdata->debugfs_xgmac_reg);\r\n}\r\nstatic ssize_t xgmac_reg_addr_write(struct file *filp,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nreturn xgbe_common_write(buffer, count, ppos,\r\n&pdata->debugfs_xgmac_reg);\r\n}\r\nstatic ssize_t xgmac_reg_value_read(struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nunsigned int value;\r\nvalue = XGMAC_IOREAD(pdata, pdata->debugfs_xgmac_reg);\r\nreturn xgbe_common_read(buffer, count, ppos, value);\r\n}\r\nstatic ssize_t xgmac_reg_value_write(struct file *filp,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nunsigned int value;\r\nssize_t len;\r\nlen = xgbe_common_write(buffer, count, ppos, &value);\r\nif (len < 0)\r\nreturn len;\r\nXGMAC_IOWRITE(pdata, pdata->debugfs_xgmac_reg, value);\r\nreturn len;\r\n}\r\nstatic ssize_t xpcs_mmd_read(struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nreturn xgbe_common_read(buffer, count, ppos, pdata->debugfs_xpcs_mmd);\r\n}\r\nstatic ssize_t xpcs_mmd_write(struct file *filp, const char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nreturn xgbe_common_write(buffer, count, ppos,\r\n&pdata->debugfs_xpcs_mmd);\r\n}\r\nstatic ssize_t xpcs_reg_addr_read(struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nreturn xgbe_common_read(buffer, count, ppos, pdata->debugfs_xpcs_reg);\r\n}\r\nstatic ssize_t xpcs_reg_addr_write(struct file *filp, const char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nreturn xgbe_common_write(buffer, count, ppos,\r\n&pdata->debugfs_xpcs_reg);\r\n}\r\nstatic ssize_t xpcs_reg_value_read(struct file *filp, char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nunsigned int value;\r\nvalue = XMDIO_READ(pdata, pdata->debugfs_xpcs_mmd,\r\npdata->debugfs_xpcs_reg);\r\nreturn xgbe_common_read(buffer, count, ppos, value);\r\n}\r\nstatic ssize_t xpcs_reg_value_write(struct file *filp,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct xgbe_prv_data *pdata = filp->private_data;\r\nunsigned int value;\r\nssize_t len;\r\nlen = xgbe_common_write(buffer, count, ppos, &value);\r\nif (len < 0)\r\nreturn len;\r\nXMDIO_WRITE(pdata, pdata->debugfs_xpcs_mmd, pdata->debugfs_xpcs_reg,\r\nvalue);\r\nreturn len;\r\n}\r\nvoid xgbe_debugfs_init(struct xgbe_prv_data *pdata)\r\n{\r\nstruct dentry *pfile;\r\nchar *buf;\r\npdata->debugfs_xgmac_reg = 0;\r\npdata->debugfs_xpcs_mmd = 1;\r\npdata->debugfs_xpcs_reg = 0;\r\nbuf = kasprintf(GFP_KERNEL, "amd-xgbe-%s", pdata->netdev->name);\r\npdata->xgbe_debugfs = debugfs_create_dir(buf, NULL);\r\nif (!pdata->xgbe_debugfs) {\r\nnetdev_err(pdata->netdev, "debugfs_create_dir failed\n");\r\nreturn;\r\n}\r\npfile = debugfs_create_file("xgmac_register", 0600,\r\npdata->xgbe_debugfs, pdata,\r\n&xgmac_reg_addr_fops);\r\nif (!pfile)\r\nnetdev_err(pdata->netdev, "debugfs_create_file failed\n");\r\npfile = debugfs_create_file("xgmac_register_value", 0600,\r\npdata->xgbe_debugfs, pdata,\r\n&xgmac_reg_value_fops);\r\nif (!pfile)\r\nnetdev_err(pdata->netdev, "debugfs_create_file failed\n");\r\npfile = debugfs_create_file("xpcs_mmd", 0600,\r\npdata->xgbe_debugfs, pdata,\r\n&xpcs_mmd_fops);\r\nif (!pfile)\r\nnetdev_err(pdata->netdev, "debugfs_create_file failed\n");\r\npfile = debugfs_create_file("xpcs_register", 0600,\r\npdata->xgbe_debugfs, pdata,\r\n&xpcs_reg_addr_fops);\r\nif (!pfile)\r\nnetdev_err(pdata->netdev, "debugfs_create_file failed\n");\r\npfile = debugfs_create_file("xpcs_register_value", 0600,\r\npdata->xgbe_debugfs, pdata,\r\n&xpcs_reg_value_fops);\r\nif (!pfile)\r\nnetdev_err(pdata->netdev, "debugfs_create_file failed\n");\r\nkfree(buf);\r\n}\r\nvoid xgbe_debugfs_exit(struct xgbe_prv_data *pdata)\r\n{\r\ndebugfs_remove_recursive(pdata->xgbe_debugfs);\r\npdata->xgbe_debugfs = NULL;\r\n}

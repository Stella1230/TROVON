int\r\nxfs_symlink_blocks(\r\nstruct xfs_mount *mp,\r\nint pathlen)\r\n{\r\nint buflen = XFS_SYMLINK_BUF_SPACE(mp, mp->m_sb.sb_blocksize);\r\nreturn (pathlen + buflen - 1) / buflen;\r\n}\r\nint\r\nxfs_symlink_hdr_set(\r\nstruct xfs_mount *mp,\r\nxfs_ino_t ino,\r\nuint32_t offset,\r\nuint32_t size,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dsymlink_hdr *dsl = bp->b_addr;\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn 0;\r\ndsl->sl_magic = cpu_to_be32(XFS_SYMLINK_MAGIC);\r\ndsl->sl_offset = cpu_to_be32(offset);\r\ndsl->sl_bytes = cpu_to_be32(size);\r\nuuid_copy(&dsl->sl_uuid, &mp->m_sb.sb_uuid);\r\ndsl->sl_owner = cpu_to_be64(ino);\r\ndsl->sl_blkno = cpu_to_be64(bp->b_bn);\r\nbp->b_ops = &xfs_symlink_buf_ops;\r\nreturn sizeof(struct xfs_dsymlink_hdr);\r\n}\r\nbool\r\nxfs_symlink_hdr_ok(\r\nxfs_ino_t ino,\r\nuint32_t offset,\r\nuint32_t size,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dsymlink_hdr *dsl = bp->b_addr;\r\nif (offset != be32_to_cpu(dsl->sl_offset))\r\nreturn false;\r\nif (size != be32_to_cpu(dsl->sl_bytes))\r\nreturn false;\r\nif (ino != be64_to_cpu(dsl->sl_owner))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic bool\r\nxfs_symlink_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_dsymlink_hdr *dsl = bp->b_addr;\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn false;\r\nif (dsl->sl_magic != cpu_to_be32(XFS_SYMLINK_MAGIC))\r\nreturn false;\r\nif (!uuid_equal(&dsl->sl_uuid, &mp->m_sb.sb_uuid))\r\nreturn false;\r\nif (bp->b_bn != be64_to_cpu(dsl->sl_blkno))\r\nreturn false;\r\nif (be32_to_cpu(dsl->sl_offset) +\r\nbe32_to_cpu(dsl->sl_bytes) >= MAXPATHLEN)\r\nreturn false;\r\nif (dsl->sl_owner == 0)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void\r\nxfs_symlink_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn;\r\nif (!xfs_buf_verify_cksum(bp, XFS_SYMLINK_CRC_OFF))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_symlink_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error)\r\nxfs_verifier_error(bp);\r\n}\r\nstatic void\r\nxfs_symlink_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn;\r\nif (!xfs_symlink_verify(bp)) {\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nif (bip) {\r\nstruct xfs_dsymlink_hdr *dsl = bp->b_addr;\r\ndsl->sl_lsn = cpu_to_be64(bip->bli_item.li_lsn);\r\n}\r\nxfs_buf_update_cksum(bp, XFS_SYMLINK_CRC_OFF);\r\n}\r\nvoid\r\nxfs_symlink_local_to_remote(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nstruct xfs_inode *ip,\r\nstruct xfs_ifork *ifp)\r\n{\r\nstruct xfs_mount *mp = ip->i_mount;\r\nchar *buf;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_SYMLINK_BUF);\r\nif (!xfs_sb_version_hascrc(&mp->m_sb)) {\r\nbp->b_ops = NULL;\r\nmemcpy(bp->b_addr, ifp->if_u1.if_data, ifp->if_bytes);\r\nreturn;\r\n}\r\nASSERT(BBTOB(bp->b_length) >=\r\nifp->if_bytes + sizeof(struct xfs_dsymlink_hdr));\r\nbp->b_ops = &xfs_symlink_buf_ops;\r\nbuf = bp->b_addr;\r\nbuf += xfs_symlink_hdr_set(mp, ip->i_ino, 0, ifp->if_bytes, bp);\r\nmemcpy(buf, ifp->if_u1.if_data, ifp->if_bytes);\r\n}

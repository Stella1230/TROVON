int rt5677_spi_write(u8 *txbuf, size_t len)\r\n{\r\nint status;\r\nstatus = spi_write(g_spi, txbuf, len);\r\nif (status)\r\ndev_err(&g_spi->dev, "rt5677_spi_write error %d\n", status);\r\nreturn status;\r\n}\r\nint rt5677_spi_burst_write(u32 addr, const struct firmware *fw)\r\n{\r\nu8 spi_cmd = RT5677_SPI_CMD_BURST_WRITE;\r\nu8 *write_buf;\r\nunsigned int i, end, offset = 0;\r\nwrite_buf = kmalloc(RT5677_SPI_BUF_LEN + 6, GFP_KERNEL);\r\nif (write_buf == NULL)\r\nreturn -ENOMEM;\r\nwhile (offset < fw->size) {\r\nif (offset + RT5677_SPI_BUF_LEN <= fw->size)\r\nend = RT5677_SPI_BUF_LEN;\r\nelse\r\nend = fw->size % RT5677_SPI_BUF_LEN;\r\nwrite_buf[0] = spi_cmd;\r\nwrite_buf[1] = ((addr + offset) & 0xff000000) >> 24;\r\nwrite_buf[2] = ((addr + offset) & 0x00ff0000) >> 16;\r\nwrite_buf[3] = ((addr + offset) & 0x0000ff00) >> 8;\r\nwrite_buf[4] = ((addr + offset) & 0x000000ff) >> 0;\r\nfor (i = 0; i < end; i += 8) {\r\nwrite_buf[i + 12] = fw->data[offset + i + 0];\r\nwrite_buf[i + 11] = fw->data[offset + i + 1];\r\nwrite_buf[i + 10] = fw->data[offset + i + 2];\r\nwrite_buf[i + 9] = fw->data[offset + i + 3];\r\nwrite_buf[i + 8] = fw->data[offset + i + 4];\r\nwrite_buf[i + 7] = fw->data[offset + i + 5];\r\nwrite_buf[i + 6] = fw->data[offset + i + 6];\r\nwrite_buf[i + 5] = fw->data[offset + i + 7];\r\n}\r\nwrite_buf[end + 5] = spi_cmd;\r\nrt5677_spi_write(write_buf, end + 6);\r\noffset += RT5677_SPI_BUF_LEN;\r\n}\r\nkfree(write_buf);\r\nreturn 0;\r\n}\r\nstatic int rt5677_spi_probe(struct spi_device *spi)\r\n{\r\ng_spi = spi;\r\nreturn 0;\r\n}

static inline struct da9055_gpio *to_da9055_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct da9055_gpio, gp);\r\n}\r\nstatic int da9055_gpio_get(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct da9055_gpio *gpio = to_da9055_gpio(gc);\r\nint gpio_direction = 0;\r\nint ret;\r\nret = da9055_reg_read(gpio->da9055, (offset >> 1) + DA9055_REG_GPIO0_1);\r\nif (ret < 0)\r\nreturn ret;\r\ngpio_direction = ret & (DA9055_PORT_MASK) << DA9055_PORT_SHIFT(offset);\r\ngpio_direction >>= DA9055_PORT_SHIFT(offset);\r\nswitch (gpio_direction) {\r\ncase DA9055_INPUT:\r\nret = da9055_reg_read(gpio->da9055, DA9055_REG_STATUS_B);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ncase DA9055_OUTPUT:\r\nret = da9055_reg_read(gpio->da9055, DA9055_REG_GPIO_MODE0_2);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn ret & (1 << offset);\r\n}\r\nstatic void da9055_gpio_set(struct gpio_chip *gc, unsigned offset, int value)\r\n{\r\nstruct da9055_gpio *gpio = to_da9055_gpio(gc);\r\nda9055_reg_update(gpio->da9055,\r\nDA9055_REG_GPIO_MODE0_2,\r\n1 << offset,\r\nvalue << offset);\r\n}\r\nstatic int da9055_gpio_direction_input(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct da9055_gpio *gpio = to_da9055_gpio(gc);\r\nunsigned char reg_byte;\r\nreg_byte = (DA9055_ACT_LOW | DA9055_GPI)\r\n<< DA9055_PORT_SHIFT(offset);\r\nreturn da9055_reg_update(gpio->da9055, (offset >> 1) +\r\nDA9055_REG_GPIO0_1,\r\nDA9055_PORT_MASK <<\r\nDA9055_PORT_SHIFT(offset),\r\nreg_byte);\r\n}\r\nstatic int da9055_gpio_direction_output(struct gpio_chip *gc,\r\nunsigned offset, int value)\r\n{\r\nstruct da9055_gpio *gpio = to_da9055_gpio(gc);\r\nunsigned char reg_byte;\r\nint ret;\r\nreg_byte = (DA9055_VDD_IO | DA9055_PUSH_PULL)\r\n<< DA9055_PORT_SHIFT(offset);\r\nret = da9055_reg_update(gpio->da9055, (offset >> 1) +\r\nDA9055_REG_GPIO0_1,\r\nDA9055_PORT_MASK <<\r\nDA9055_PORT_SHIFT(offset),\r\nreg_byte);\r\nif (ret < 0)\r\nreturn ret;\r\nda9055_gpio_set(gc, offset, value);\r\nreturn 0;\r\n}\r\nstatic int da9055_gpio_to_irq(struct gpio_chip *gc, u32 offset)\r\n{\r\nstruct da9055_gpio *gpio = to_da9055_gpio(gc);\r\nstruct da9055 *da9055 = gpio->da9055;\r\nreturn regmap_irq_get_virq(da9055->irq_data,\r\nDA9055_IRQ_GPI0 + offset);\r\n}\r\nstatic int da9055_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct da9055_gpio *gpio;\r\nstruct da9055_pdata *pdata;\r\nint ret;\r\ngpio = devm_kzalloc(&pdev->dev, sizeof(*gpio), GFP_KERNEL);\r\nif (!gpio)\r\nreturn -ENOMEM;\r\ngpio->da9055 = dev_get_drvdata(pdev->dev.parent);\r\npdata = dev_get_platdata(gpio->da9055->dev);\r\ngpio->gp = reference_gp;\r\nif (pdata && pdata->gpio_base)\r\ngpio->gp.base = pdata->gpio_base;\r\nret = gpiochip_add(&gpio->gp);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Could not register gpiochip, %d\n", ret);\r\ngoto err_mem;\r\n}\r\nplatform_set_drvdata(pdev, gpio);\r\nreturn 0;\r\nerr_mem:\r\nreturn ret;\r\n}\r\nstatic int da9055_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct da9055_gpio *gpio = platform_get_drvdata(pdev);\r\ngpiochip_remove(&gpio->gp);\r\nreturn 0;\r\n}\r\nstatic int __init da9055_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&da9055_gpio_driver);\r\n}\r\nstatic void __exit da9055_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&da9055_gpio_driver);\r\n}

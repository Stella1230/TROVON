static int buddha_test_irq(ide_hwif_t *hwif)\r\n{\r\nunsigned char ch;\r\nch = z_readb(hwif->io_ports.irq_addr);\r\nif (!(ch & 0x80))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void xsurf_clear_irq(ide_drive_t *drive)\r\n{\r\nz_writeb(0, drive->hwif->io_ports.irq_addr);\r\n}\r\nstatic void __init buddha_setup_ports(struct ide_hw *hw, unsigned long base,\r\nunsigned long ctl, unsigned long irq_port)\r\n{\r\nint i;\r\nmemset(hw, 0, sizeof(*hw));\r\nhw->io_ports.data_addr = base;\r\nfor (i = 1; i < 8; i++)\r\nhw->io_ports_array[i] = base + 2 + i * 4;\r\nhw->io_ports.ctl_addr = ctl;\r\nhw->io_ports.irq_addr = irq_port;\r\nhw->irq = IRQ_AMIGA_PORTS;\r\n}\r\nstatic int __init buddha_init(void)\r\n{\r\nstruct zorro_dev *z = NULL;\r\nu_long buddha_board = 0;\r\nBuddhaType type;\r\nint buddha_num_hwifs, i;\r\nwhile ((z = zorro_find_device(ZORRO_WILDCARD, z))) {\r\nunsigned long board;\r\nstruct ide_hw hw[MAX_NUM_HWIFS], *hws[MAX_NUM_HWIFS];\r\nstruct ide_port_info d = buddha_port_info;\r\nif (z->id == ZORRO_PROD_INDIVIDUAL_COMPUTERS_BUDDHA) {\r\nbuddha_num_hwifs = BUDDHA_NUM_HWIFS;\r\ntype=BOARD_BUDDHA;\r\n} else if (z->id == ZORRO_PROD_INDIVIDUAL_COMPUTERS_CATWEASEL) {\r\nbuddha_num_hwifs = CATWEASEL_NUM_HWIFS;\r\ntype=BOARD_CATWEASEL;\r\n} else if (z->id == ZORRO_PROD_INDIVIDUAL_COMPUTERS_X_SURF) {\r\nbuddha_num_hwifs = XSURF_NUM_HWIFS;\r\ntype=BOARD_XSURF;\r\nd.port_ops = &xsurf_port_ops;\r\n} else\r\ncontinue;\r\nboard = z->resource.start;\r\nif(type != BOARD_XSURF) {\r\nif (!request_mem_region(board+BUDDHA_BASE1, 0x800, "IDE"))\r\ncontinue;\r\n} else {\r\nif (!request_mem_region(board+XSURF_BASE1, 0x1000, "IDE"))\r\ncontinue;\r\nif (!request_mem_region(board+XSURF_BASE2, 0x1000, "IDE"))\r\ngoto fail_base2;\r\nif (!request_mem_region(board+XSURF_IRQ1, 0x8, "IDE")) {\r\nrelease_mem_region(board+XSURF_BASE2, 0x1000);\r\nfail_base2:\r\nrelease_mem_region(board+XSURF_BASE1, 0x1000);\r\ncontinue;\r\n}\r\n}\r\nbuddha_board = (unsigned long)ZTWO_VADDR(board);\r\nif (type != BOARD_XSURF)\r\nz_writeb(0, buddha_board+BUDDHA_IRQ_MR);\r\nprintk(KERN_INFO "ide: %s IDE controller\n",\r\nbuddha_board_name[type]);\r\nfor (i = 0; i < buddha_num_hwifs; i++) {\r\nunsigned long base, ctl, irq_port;\r\nif (type != BOARD_XSURF) {\r\nbase = buddha_board + buddha_bases[i];\r\nctl = base + BUDDHA_CONTROL;\r\nirq_port = buddha_board + buddha_irqports[i];\r\n} else {\r\nbase = buddha_board + xsurf_bases[i];\r\nctl = 0;\r\nirq_port = buddha_board + xsurf_irqports[i];\r\n}\r\nbuddha_setup_ports(&hw[i], base, ctl, irq_port);\r\nhws[i] = &hw[i];\r\n}\r\nide_host_add(&d, hws, i, NULL);\r\n}\r\nreturn 0;\r\n}

void kick_register_func(struct kick_irq_handler *kh)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&kick_handlers_lock, flags);\r\nlist_add_tail(&kh->list, &kick_handlers_list);\r\nspin_unlock_irqrestore(&kick_handlers_lock, flags);\r\n}\r\nvoid kick_unregister_func(struct kick_irq_handler *kh)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&kick_handlers_lock, flags);\r\nlist_del(&kh->list);\r\nspin_unlock_irqrestore(&kick_handlers_lock, flags);\r\n}\r\nTBIRES\r\nkick_handler(TBIRES State, int SigNum, int Triggers, int Inst, PTBI pTBI)\r\n{\r\nstruct pt_regs *old_regs;\r\nstruct kick_irq_handler *kh;\r\nstruct list_head *lh;\r\nint handled = 0;\r\nTBIRES ret;\r\nhead_end(State, ~INTS_OFF_MASK);\r\nif (State.Sig.SaveMask & TBICTX_PRIV_BIT)\r\nrestart_critical_section(State);\r\ntrace_hardirqs_off();\r\nold_regs = set_irq_regs((struct pt_regs *)State.Sig.pCtx);\r\nirq_enter();\r\nspin_lock(&kick_handlers_lock);\r\nlist_for_each(lh, &kick_handlers_list) {\r\nkh = list_entry(lh, struct kick_irq_handler, list);\r\nret = kh->func(State, SigNum, Triggers, Inst, pTBI, &handled);\r\nif (handled)\r\nbreak;\r\n}\r\nspin_unlock(&kick_handlers_lock);\r\nWARN_ON(!handled);\r\nirq_exit();\r\nset_irq_regs(old_regs);\r\nreturn tail_end(ret);\r\n}

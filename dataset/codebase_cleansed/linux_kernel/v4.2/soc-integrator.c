static const char *integrator_arch_str(u32 id)\r\n{\r\nswitch ((id >> 16) & 0xff) {\r\ncase 0x00:\r\nreturn "ASB little-endian";\r\ncase 0x01:\r\nreturn "AHB little-endian";\r\ncase 0x03:\r\nreturn "AHB-Lite system bus, bi-endian";\r\ncase 0x04:\r\nreturn "AHB";\r\ncase 0x08:\r\nreturn "AHB system bus, ASB processor bus";\r\ndefault:\r\nreturn "Unknown";\r\n}\r\n}\r\nstatic const char *integrator_fpga_str(u32 id)\r\n{\r\nswitch ((id >> 12) & 0xf) {\r\ncase 0x01:\r\nreturn "XC4062";\r\ncase 0x02:\r\nreturn "XC4085";\r\ncase 0x03:\r\nreturn "XVC600";\r\ncase 0x04:\r\nreturn "EPM7256AE (Altera PLD)";\r\ndefault:\r\nreturn "Unknown";\r\n}\r\n}\r\nstatic ssize_t integrator_get_manf(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%02x\n", integrator_coreid >> 24);\r\n}\r\nstatic ssize_t integrator_get_arch(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%s\n", integrator_arch_str(integrator_coreid));\r\n}\r\nstatic ssize_t integrator_get_fpga(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%s\n", integrator_fpga_str(integrator_coreid));\r\n}\r\nstatic ssize_t integrator_get_build(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%02x\n", (integrator_coreid >> 4) & 0xFF);\r\n}\r\nstatic int __init integrator_soc_init(void)\r\n{\r\nstatic struct regmap *syscon_regmap;\r\nstruct soc_device *soc_dev;\r\nstruct soc_device_attribute *soc_dev_attr;\r\nstruct device_node *np;\r\nstruct device *dev;\r\nu32 val;\r\nint ret;\r\nnp = of_find_matching_node(NULL, integrator_cm_match);\r\nif (!np)\r\nreturn -ENODEV;\r\nsyscon_regmap = syscon_node_to_regmap(np);\r\nif (IS_ERR(syscon_regmap))\r\nreturn PTR_ERR(syscon_regmap);\r\nret = regmap_read(syscon_regmap, INTEGRATOR_HDR_ID_OFFSET,\r\n&val);\r\nif (ret)\r\nreturn -ENODEV;\r\nintegrator_coreid = val;\r\nsoc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);\r\nif (!soc_dev_attr)\r\nreturn -ENOMEM;\r\nsoc_dev_attr->soc_id = "Integrator";\r\nsoc_dev_attr->machine = "Integrator";\r\nsoc_dev_attr->family = "Versatile";\r\nsoc_dev = soc_device_register(soc_dev_attr);\r\nif (IS_ERR(soc_dev)) {\r\nkfree(soc_dev_attr);\r\nreturn -ENODEV;\r\n}\r\ndev = soc_device_to_device(soc_dev);\r\ndevice_create_file(dev, &integrator_manf_attr);\r\ndevice_create_file(dev, &integrator_arch_attr);\r\ndevice_create_file(dev, &integrator_fpga_attr);\r\ndevice_create_file(dev, &integrator_build_attr);\r\ndev_info(dev, "Detected ARM core module:\n");\r\ndev_info(dev, " Manufacturer: %02x\n", (val >> 24));\r\ndev_info(dev, " Architecture: %s\n", integrator_arch_str(val));\r\ndev_info(dev, " FPGA: %s\n", integrator_fpga_str(val));\r\ndev_info(dev, " Build: %02x\n", (val >> 4) & 0xFF);\r\ndev_info(dev, " Rev: %c\n", ('A' + (val & 0x03)));\r\nreturn 0;\r\n}

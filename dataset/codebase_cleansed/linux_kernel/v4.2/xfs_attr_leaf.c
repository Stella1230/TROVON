static void\r\nxfs_attr3_leaf_firstused_from_disk(\r\nstruct xfs_da_geometry *geo,\r\nstruct xfs_attr3_icleaf_hdr *to,\r\nstruct xfs_attr_leafblock *from)\r\n{\r\nstruct xfs_attr3_leaf_hdr *hdr3;\r\nif (from->hdr.info.magic == cpu_to_be16(XFS_ATTR3_LEAF_MAGIC)) {\r\nhdr3 = (struct xfs_attr3_leaf_hdr *) from;\r\nto->firstused = be16_to_cpu(hdr3->firstused);\r\n} else {\r\nto->firstused = be16_to_cpu(from->hdr.firstused);\r\n}\r\nif (to->firstused == XFS_ATTR3_LEAF_NULLOFF) {\r\nASSERT(!to->count && !to->usedbytes);\r\nASSERT(geo->blksize > USHRT_MAX);\r\nto->firstused = geo->blksize;\r\n}\r\n}\r\nstatic void\r\nxfs_attr3_leaf_firstused_to_disk(\r\nstruct xfs_da_geometry *geo,\r\nstruct xfs_attr_leafblock *to,\r\nstruct xfs_attr3_icleaf_hdr *from)\r\n{\r\nstruct xfs_attr3_leaf_hdr *hdr3;\r\nuint32_t firstused;\r\nASSERT(from->firstused != XFS_ATTR3_LEAF_NULLOFF);\r\nfirstused = from->firstused;\r\nif (firstused > USHRT_MAX) {\r\nASSERT(from->firstused == geo->blksize);\r\nfirstused = XFS_ATTR3_LEAF_NULLOFF;\r\n}\r\nif (from->magic == XFS_ATTR3_LEAF_MAGIC) {\r\nhdr3 = (struct xfs_attr3_leaf_hdr *) to;\r\nhdr3->firstused = cpu_to_be16(firstused);\r\n} else {\r\nto->hdr.firstused = cpu_to_be16(firstused);\r\n}\r\n}\r\nvoid\r\nxfs_attr3_leaf_hdr_from_disk(\r\nstruct xfs_da_geometry *geo,\r\nstruct xfs_attr3_icleaf_hdr *to,\r\nstruct xfs_attr_leafblock *from)\r\n{\r\nint i;\r\nASSERT(from->hdr.info.magic == cpu_to_be16(XFS_ATTR_LEAF_MAGIC) ||\r\nfrom->hdr.info.magic == cpu_to_be16(XFS_ATTR3_LEAF_MAGIC));\r\nif (from->hdr.info.magic == cpu_to_be16(XFS_ATTR3_LEAF_MAGIC)) {\r\nstruct xfs_attr3_leaf_hdr *hdr3 = (struct xfs_attr3_leaf_hdr *)from;\r\nto->forw = be32_to_cpu(hdr3->info.hdr.forw);\r\nto->back = be32_to_cpu(hdr3->info.hdr.back);\r\nto->magic = be16_to_cpu(hdr3->info.hdr.magic);\r\nto->count = be16_to_cpu(hdr3->count);\r\nto->usedbytes = be16_to_cpu(hdr3->usedbytes);\r\nxfs_attr3_leaf_firstused_from_disk(geo, to, from);\r\nto->holes = hdr3->holes;\r\nfor (i = 0; i < XFS_ATTR_LEAF_MAPSIZE; i++) {\r\nto->freemap[i].base = be16_to_cpu(hdr3->freemap[i].base);\r\nto->freemap[i].size = be16_to_cpu(hdr3->freemap[i].size);\r\n}\r\nreturn;\r\n}\r\nto->forw = be32_to_cpu(from->hdr.info.forw);\r\nto->back = be32_to_cpu(from->hdr.info.back);\r\nto->magic = be16_to_cpu(from->hdr.info.magic);\r\nto->count = be16_to_cpu(from->hdr.count);\r\nto->usedbytes = be16_to_cpu(from->hdr.usedbytes);\r\nxfs_attr3_leaf_firstused_from_disk(geo, to, from);\r\nto->holes = from->hdr.holes;\r\nfor (i = 0; i < XFS_ATTR_LEAF_MAPSIZE; i++) {\r\nto->freemap[i].base = be16_to_cpu(from->hdr.freemap[i].base);\r\nto->freemap[i].size = be16_to_cpu(from->hdr.freemap[i].size);\r\n}\r\n}\r\nvoid\r\nxfs_attr3_leaf_hdr_to_disk(\r\nstruct xfs_da_geometry *geo,\r\nstruct xfs_attr_leafblock *to,\r\nstruct xfs_attr3_icleaf_hdr *from)\r\n{\r\nint i;\r\nASSERT(from->magic == XFS_ATTR_LEAF_MAGIC ||\r\nfrom->magic == XFS_ATTR3_LEAF_MAGIC);\r\nif (from->magic == XFS_ATTR3_LEAF_MAGIC) {\r\nstruct xfs_attr3_leaf_hdr *hdr3 = (struct xfs_attr3_leaf_hdr *)to;\r\nhdr3->info.hdr.forw = cpu_to_be32(from->forw);\r\nhdr3->info.hdr.back = cpu_to_be32(from->back);\r\nhdr3->info.hdr.magic = cpu_to_be16(from->magic);\r\nhdr3->count = cpu_to_be16(from->count);\r\nhdr3->usedbytes = cpu_to_be16(from->usedbytes);\r\nxfs_attr3_leaf_firstused_to_disk(geo, to, from);\r\nhdr3->holes = from->holes;\r\nhdr3->pad1 = 0;\r\nfor (i = 0; i < XFS_ATTR_LEAF_MAPSIZE; i++) {\r\nhdr3->freemap[i].base = cpu_to_be16(from->freemap[i].base);\r\nhdr3->freemap[i].size = cpu_to_be16(from->freemap[i].size);\r\n}\r\nreturn;\r\n}\r\nto->hdr.info.forw = cpu_to_be32(from->forw);\r\nto->hdr.info.back = cpu_to_be32(from->back);\r\nto->hdr.info.magic = cpu_to_be16(from->magic);\r\nto->hdr.count = cpu_to_be16(from->count);\r\nto->hdr.usedbytes = cpu_to_be16(from->usedbytes);\r\nxfs_attr3_leaf_firstused_to_disk(geo, to, from);\r\nto->hdr.holes = from->holes;\r\nto->hdr.pad1 = 0;\r\nfor (i = 0; i < XFS_ATTR_LEAF_MAPSIZE; i++) {\r\nto->hdr.freemap[i].base = cpu_to_be16(from->freemap[i].base);\r\nto->hdr.freemap[i].size = cpu_to_be16(from->freemap[i].size);\r\n}\r\n}\r\nstatic bool\r\nxfs_attr3_leaf_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_attr_leafblock *leaf = bp->b_addr;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nxfs_attr3_leaf_hdr_from_disk(mp->m_attr_geo, &ichdr, leaf);\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nstruct xfs_da3_node_hdr *hdr3 = bp->b_addr;\r\nif (ichdr.magic != XFS_ATTR3_LEAF_MAGIC)\r\nreturn false;\r\nif (!uuid_equal(&hdr3->info.uuid, &mp->m_sb.sb_uuid))\r\nreturn false;\r\nif (be64_to_cpu(hdr3->info.blkno) != bp->b_bn)\r\nreturn false;\r\n} else {\r\nif (ichdr.magic != XFS_ATTR_LEAF_MAGIC)\r\nreturn false;\r\n}\r\nif (ichdr.count == 0)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void\r\nxfs_attr3_leaf_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nstruct xfs_attr3_leaf_hdr *hdr3 = bp->b_addr;\r\nif (!xfs_attr3_leaf_verify(bp)) {\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn;\r\nif (bip)\r\nhdr3->info.lsn = cpu_to_be64(bip->bli_item.li_lsn);\r\nxfs_buf_update_cksum(bp, XFS_ATTR3_LEAF_CRC_OFF);\r\n}\r\nstatic void\r\nxfs_attr3_leaf_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nif (xfs_sb_version_hascrc(&mp->m_sb) &&\r\n!xfs_buf_verify_cksum(bp, XFS_ATTR3_LEAF_CRC_OFF))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_attr3_leaf_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error)\r\nxfs_verifier_error(bp);\r\n}\r\nint\r\nxfs_attr3_leaf_read(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nxfs_dablk_t bno,\r\nxfs_daddr_t mappedbno,\r\nstruct xfs_buf **bpp)\r\n{\r\nint err;\r\nerr = xfs_da_read_buf(tp, dp, bno, mappedbno, bpp,\r\nXFS_ATTR_FORK, &xfs_attr3_leaf_buf_ops);\r\nif (!err && tp)\r\nxfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_ATTR_LEAF_BUF);\r\nreturn err;\r\n}\r\nSTATIC int\r\nxfs_attr_namesp_match(int arg_flags, int ondisk_flags)\r\n{\r\nreturn XFS_ATTR_NSP_ONDISK(ondisk_flags) == XFS_ATTR_NSP_ARGS_TO_ONDISK(arg_flags);\r\n}\r\nint\r\nxfs_attr_shortform_bytesfit(xfs_inode_t *dp, int bytes)\r\n{\r\nint offset;\r\nint minforkoff;\r\nint maxforkoff;\r\nint dsize;\r\nxfs_mount_t *mp = dp->i_mount;\r\noffset = (XFS_LITINO(mp, dp->i_d.di_version) - bytes) >> 3;\r\nswitch (dp->i_d.di_format) {\r\ncase XFS_DINODE_FMT_DEV:\r\nminforkoff = roundup(sizeof(xfs_dev_t), 8) >> 3;\r\nreturn (offset >= minforkoff) ? minforkoff : 0;\r\ncase XFS_DINODE_FMT_UUID:\r\nminforkoff = roundup(sizeof(uuid_t), 8) >> 3;\r\nreturn (offset >= minforkoff) ? minforkoff : 0;\r\n}\r\nif (bytes <= XFS_IFORK_ASIZE(dp))\r\nreturn dp->i_d.di_forkoff;\r\nif (!(mp->m_flags & XFS_MOUNT_ATTR2))\r\nreturn 0;\r\ndsize = dp->i_df.if_bytes;\r\nswitch (dp->i_d.di_format) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nif (!dp->i_d.di_forkoff && dp->i_df.if_bytes >\r\nxfs_default_attroffset(dp))\r\ndsize = XFS_BMDR_SPACE_CALC(MINDBTPTRS);\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nif (dp->i_d.di_forkoff) {\r\nif (offset < dp->i_d.di_forkoff)\r\nreturn 0;\r\nreturn dp->i_d.di_forkoff;\r\n}\r\ndsize = XFS_BMAP_BROOT_SPACE(mp, dp->i_df.if_broot);\r\nbreak;\r\n}\r\nminforkoff = MAX(dsize, XFS_BMDR_SPACE_CALC(MINDBTPTRS));\r\nminforkoff = roundup(minforkoff, 8) >> 3;\r\nmaxforkoff = XFS_LITINO(mp, dp->i_d.di_version) -\r\nXFS_BMDR_SPACE_CALC(MINABTPTRS);\r\nmaxforkoff = maxforkoff >> 3;\r\nif (offset >= maxforkoff)\r\nreturn maxforkoff;\r\nif (offset >= minforkoff)\r\nreturn offset;\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_sbversion_add_attr2(xfs_mount_t *mp, xfs_trans_t *tp)\r\n{\r\nif ((mp->m_flags & XFS_MOUNT_ATTR2) &&\r\n!(xfs_sb_version_hasattr2(&mp->m_sb))) {\r\nspin_lock(&mp->m_sb_lock);\r\nif (!xfs_sb_version_hasattr2(&mp->m_sb)) {\r\nxfs_sb_version_addattr2(&mp->m_sb);\r\nspin_unlock(&mp->m_sb_lock);\r\nxfs_log_sb(tp);\r\n} else\r\nspin_unlock(&mp->m_sb_lock);\r\n}\r\n}\r\nvoid\r\nxfs_attr_shortform_create(xfs_da_args_t *args)\r\n{\r\nxfs_attr_sf_hdr_t *hdr;\r\nxfs_inode_t *dp;\r\nxfs_ifork_t *ifp;\r\ntrace_xfs_attr_sf_create(args);\r\ndp = args->dp;\r\nASSERT(dp != NULL);\r\nifp = dp->i_afp;\r\nASSERT(ifp != NULL);\r\nASSERT(ifp->if_bytes == 0);\r\nif (dp->i_d.di_aformat == XFS_DINODE_FMT_EXTENTS) {\r\nifp->if_flags &= ~XFS_IFEXTENTS;\r\ndp->i_d.di_aformat = XFS_DINODE_FMT_LOCAL;\r\nifp->if_flags |= XFS_IFINLINE;\r\n} else {\r\nASSERT(ifp->if_flags & XFS_IFINLINE);\r\n}\r\nxfs_idata_realloc(dp, sizeof(*hdr), XFS_ATTR_FORK);\r\nhdr = (xfs_attr_sf_hdr_t *)ifp->if_u1.if_data;\r\nhdr->count = 0;\r\nhdr->totsize = cpu_to_be16(sizeof(*hdr));\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_ADATA);\r\n}\r\nvoid\r\nxfs_attr_shortform_add(xfs_da_args_t *args, int forkoff)\r\n{\r\nxfs_attr_shortform_t *sf;\r\nxfs_attr_sf_entry_t *sfe;\r\nint i, offset, size;\r\nxfs_mount_t *mp;\r\nxfs_inode_t *dp;\r\nxfs_ifork_t *ifp;\r\ntrace_xfs_attr_sf_add(args);\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ndp->i_d.di_forkoff = forkoff;\r\nifp = dp->i_afp;\r\nASSERT(ifp->if_flags & XFS_IFINLINE);\r\nsf = (xfs_attr_shortform_t *)ifp->if_u1.if_data;\r\nsfe = &sf->list[0];\r\nfor (i = 0; i < sf->hdr.count; sfe = XFS_ATTR_SF_NEXTENTRY(sfe), i++) {\r\n#ifdef DEBUG\r\nif (sfe->namelen != args->namelen)\r\ncontinue;\r\nif (memcmp(args->name, sfe->nameval, args->namelen) != 0)\r\ncontinue;\r\nif (!xfs_attr_namesp_match(args->flags, sfe->flags))\r\ncontinue;\r\nASSERT(0);\r\n#endif\r\n}\r\noffset = (char *)sfe - (char *)sf;\r\nsize = XFS_ATTR_SF_ENTSIZE_BYNAME(args->namelen, args->valuelen);\r\nxfs_idata_realloc(dp, size, XFS_ATTR_FORK);\r\nsf = (xfs_attr_shortform_t *)ifp->if_u1.if_data;\r\nsfe = (xfs_attr_sf_entry_t *)((char *)sf + offset);\r\nsfe->namelen = args->namelen;\r\nsfe->valuelen = args->valuelen;\r\nsfe->flags = XFS_ATTR_NSP_ARGS_TO_ONDISK(args->flags);\r\nmemcpy(sfe->nameval, args->name, args->namelen);\r\nmemcpy(&sfe->nameval[args->namelen], args->value, args->valuelen);\r\nsf->hdr.count++;\r\nbe16_add_cpu(&sf->hdr.totsize, size);\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_ADATA);\r\nxfs_sbversion_add_attr2(mp, args->trans);\r\n}\r\nvoid\r\nxfs_attr_fork_remove(\r\nstruct xfs_inode *ip,\r\nstruct xfs_trans *tp)\r\n{\r\nxfs_idestroy_fork(ip, XFS_ATTR_FORK);\r\nip->i_d.di_forkoff = 0;\r\nip->i_d.di_aformat = XFS_DINODE_FMT_EXTENTS;\r\nASSERT(ip->i_d.di_anextents == 0);\r\nASSERT(ip->i_afp == NULL);\r\nxfs_trans_log_inode(tp, ip, XFS_ILOG_CORE);\r\n}\r\nint\r\nxfs_attr_shortform_remove(xfs_da_args_t *args)\r\n{\r\nxfs_attr_shortform_t *sf;\r\nxfs_attr_sf_entry_t *sfe;\r\nint base, size=0, end, totsize, i;\r\nxfs_mount_t *mp;\r\nxfs_inode_t *dp;\r\ntrace_xfs_attr_sf_remove(args);\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\nbase = sizeof(xfs_attr_sf_hdr_t);\r\nsf = (xfs_attr_shortform_t *)dp->i_afp->if_u1.if_data;\r\nsfe = &sf->list[0];\r\nend = sf->hdr.count;\r\nfor (i = 0; i < end; sfe = XFS_ATTR_SF_NEXTENTRY(sfe),\r\nbase += size, i++) {\r\nsize = XFS_ATTR_SF_ENTSIZE(sfe);\r\nif (sfe->namelen != args->namelen)\r\ncontinue;\r\nif (memcmp(sfe->nameval, args->name, args->namelen) != 0)\r\ncontinue;\r\nif (!xfs_attr_namesp_match(args->flags, sfe->flags))\r\ncontinue;\r\nbreak;\r\n}\r\nif (i == end)\r\nreturn -ENOATTR;\r\nend = base + size;\r\ntotsize = be16_to_cpu(sf->hdr.totsize);\r\nif (end != totsize)\r\nmemmove(&((char *)sf)[base], &((char *)sf)[end], totsize - end);\r\nsf->hdr.count--;\r\nbe16_add_cpu(&sf->hdr.totsize, -size);\r\ntotsize -= size;\r\nif (totsize == sizeof(xfs_attr_sf_hdr_t) &&\r\n(mp->m_flags & XFS_MOUNT_ATTR2) &&\r\n(dp->i_d.di_format != XFS_DINODE_FMT_BTREE) &&\r\n!(args->op_flags & XFS_DA_OP_ADDNAME)) {\r\nxfs_attr_fork_remove(dp, args->trans);\r\n} else {\r\nxfs_idata_realloc(dp, -size, XFS_ATTR_FORK);\r\ndp->i_d.di_forkoff = xfs_attr_shortform_bytesfit(dp, totsize);\r\nASSERT(dp->i_d.di_forkoff);\r\nASSERT(totsize > sizeof(xfs_attr_sf_hdr_t) ||\r\n(args->op_flags & XFS_DA_OP_ADDNAME) ||\r\n!(mp->m_flags & XFS_MOUNT_ATTR2) ||\r\ndp->i_d.di_format == XFS_DINODE_FMT_BTREE);\r\nxfs_trans_log_inode(args->trans, dp,\r\nXFS_ILOG_CORE | XFS_ILOG_ADATA);\r\n}\r\nxfs_sbversion_add_attr2(mp, args->trans);\r\nreturn 0;\r\n}\r\nint\r\nxfs_attr_shortform_lookup(xfs_da_args_t *args)\r\n{\r\nxfs_attr_shortform_t *sf;\r\nxfs_attr_sf_entry_t *sfe;\r\nint i;\r\nxfs_ifork_t *ifp;\r\ntrace_xfs_attr_sf_lookup(args);\r\nifp = args->dp->i_afp;\r\nASSERT(ifp->if_flags & XFS_IFINLINE);\r\nsf = (xfs_attr_shortform_t *)ifp->if_u1.if_data;\r\nsfe = &sf->list[0];\r\nfor (i = 0; i < sf->hdr.count;\r\nsfe = XFS_ATTR_SF_NEXTENTRY(sfe), i++) {\r\nif (sfe->namelen != args->namelen)\r\ncontinue;\r\nif (memcmp(args->name, sfe->nameval, args->namelen) != 0)\r\ncontinue;\r\nif (!xfs_attr_namesp_match(args->flags, sfe->flags))\r\ncontinue;\r\nreturn -EEXIST;\r\n}\r\nreturn -ENOATTR;\r\n}\r\nint\r\nxfs_attr_shortform_getvalue(xfs_da_args_t *args)\r\n{\r\nxfs_attr_shortform_t *sf;\r\nxfs_attr_sf_entry_t *sfe;\r\nint i;\r\nASSERT(args->dp->i_afp->if_flags == XFS_IFINLINE);\r\nsf = (xfs_attr_shortform_t *)args->dp->i_afp->if_u1.if_data;\r\nsfe = &sf->list[0];\r\nfor (i = 0; i < sf->hdr.count;\r\nsfe = XFS_ATTR_SF_NEXTENTRY(sfe), i++) {\r\nif (sfe->namelen != args->namelen)\r\ncontinue;\r\nif (memcmp(args->name, sfe->nameval, args->namelen) != 0)\r\ncontinue;\r\nif (!xfs_attr_namesp_match(args->flags, sfe->flags))\r\ncontinue;\r\nif (args->flags & ATTR_KERNOVAL) {\r\nargs->valuelen = sfe->valuelen;\r\nreturn -EEXIST;\r\n}\r\nif (args->valuelen < sfe->valuelen) {\r\nargs->valuelen = sfe->valuelen;\r\nreturn -ERANGE;\r\n}\r\nargs->valuelen = sfe->valuelen;\r\nmemcpy(args->value, &sfe->nameval[args->namelen],\r\nargs->valuelen);\r\nreturn -EEXIST;\r\n}\r\nreturn -ENOATTR;\r\n}\r\nint\r\nxfs_attr_shortform_to_leaf(xfs_da_args_t *args)\r\n{\r\nxfs_inode_t *dp;\r\nxfs_attr_shortform_t *sf;\r\nxfs_attr_sf_entry_t *sfe;\r\nxfs_da_args_t nargs;\r\nchar *tmpbuffer;\r\nint error, i, size;\r\nxfs_dablk_t blkno;\r\nstruct xfs_buf *bp;\r\nxfs_ifork_t *ifp;\r\ntrace_xfs_attr_sf_to_leaf(args);\r\ndp = args->dp;\r\nifp = dp->i_afp;\r\nsf = (xfs_attr_shortform_t *)ifp->if_u1.if_data;\r\nsize = be16_to_cpu(sf->hdr.totsize);\r\ntmpbuffer = kmem_alloc(size, KM_SLEEP);\r\nASSERT(tmpbuffer != NULL);\r\nmemcpy(tmpbuffer, ifp->if_u1.if_data, size);\r\nsf = (xfs_attr_shortform_t *)tmpbuffer;\r\nxfs_idata_realloc(dp, -size, XFS_ATTR_FORK);\r\nxfs_bmap_local_to_extents_empty(dp, XFS_ATTR_FORK);\r\nbp = NULL;\r\nerror = xfs_da_grow_inode(args, &blkno);\r\nif (error) {\r\nif (error == -EIO)\r\ngoto out;\r\nxfs_idata_realloc(dp, size, XFS_ATTR_FORK);\r\nmemcpy(ifp->if_u1.if_data, tmpbuffer, size);\r\ngoto out;\r\n}\r\nASSERT(blkno == 0);\r\nerror = xfs_attr3_leaf_create(args, blkno, &bp);\r\nif (error) {\r\nerror = xfs_da_shrink_inode(args, 0, bp);\r\nbp = NULL;\r\nif (error)\r\ngoto out;\r\nxfs_idata_realloc(dp, size, XFS_ATTR_FORK);\r\nmemcpy(ifp->if_u1.if_data, tmpbuffer, size);\r\ngoto out;\r\n}\r\nmemset((char *)&nargs, 0, sizeof(nargs));\r\nnargs.dp = dp;\r\nnargs.geo = args->geo;\r\nnargs.firstblock = args->firstblock;\r\nnargs.flist = args->flist;\r\nnargs.total = args->total;\r\nnargs.whichfork = XFS_ATTR_FORK;\r\nnargs.trans = args->trans;\r\nnargs.op_flags = XFS_DA_OP_OKNOENT;\r\nsfe = &sf->list[0];\r\nfor (i = 0; i < sf->hdr.count; i++) {\r\nnargs.name = sfe->nameval;\r\nnargs.namelen = sfe->namelen;\r\nnargs.value = &sfe->nameval[nargs.namelen];\r\nnargs.valuelen = sfe->valuelen;\r\nnargs.hashval = xfs_da_hashname(sfe->nameval,\r\nsfe->namelen);\r\nnargs.flags = XFS_ATTR_NSP_ONDISK_TO_ARGS(sfe->flags);\r\nerror = xfs_attr3_leaf_lookup_int(bp, &nargs);\r\nASSERT(error == -ENOATTR);\r\nerror = xfs_attr3_leaf_add(bp, &nargs);\r\nASSERT(error != -ENOSPC);\r\nif (error)\r\ngoto out;\r\nsfe = XFS_ATTR_SF_NEXTENTRY(sfe);\r\n}\r\nerror = 0;\r\nout:\r\nkmem_free(tmpbuffer);\r\nreturn error;\r\n}\r\nint\r\nxfs_attr_shortform_allfit(\r\nstruct xfs_buf *bp,\r\nstruct xfs_inode *dp)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr_leaf_entry *entry;\r\nxfs_attr_leaf_name_local_t *name_loc;\r\nstruct xfs_attr3_icleaf_hdr leafhdr;\r\nint bytes;\r\nint i;\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nleaf = bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(mp->m_attr_geo, &leafhdr, leaf);\r\nentry = xfs_attr3_leaf_entryp(leaf);\r\nbytes = sizeof(struct xfs_attr_sf_hdr);\r\nfor (i = 0; i < leafhdr.count; entry++, i++) {\r\nif (entry->flags & XFS_ATTR_INCOMPLETE)\r\ncontinue;\r\nif (!(entry->flags & XFS_ATTR_LOCAL))\r\nreturn 0;\r\nname_loc = xfs_attr3_leaf_name_local(leaf, i);\r\nif (name_loc->namelen >= XFS_ATTR_SF_ENTSIZE_MAX)\r\nreturn 0;\r\nif (be16_to_cpu(name_loc->valuelen) >= XFS_ATTR_SF_ENTSIZE_MAX)\r\nreturn 0;\r\nbytes += sizeof(struct xfs_attr_sf_entry) - 1\r\n+ name_loc->namelen\r\n+ be16_to_cpu(name_loc->valuelen);\r\n}\r\nif ((dp->i_mount->m_flags & XFS_MOUNT_ATTR2) &&\r\n(dp->i_d.di_format != XFS_DINODE_FMT_BTREE) &&\r\n(bytes == sizeof(struct xfs_attr_sf_hdr)))\r\nreturn -1;\r\nreturn xfs_attr_shortform_bytesfit(dp, bytes);\r\n}\r\nint\r\nxfs_attr3_leaf_to_shortform(\r\nstruct xfs_buf *bp,\r\nstruct xfs_da_args *args,\r\nint forkoff)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nstruct xfs_attr_leaf_entry *entry;\r\nstruct xfs_attr_leaf_name_local *name_loc;\r\nstruct xfs_da_args nargs;\r\nstruct xfs_inode *dp = args->dp;\r\nchar *tmpbuffer;\r\nint error;\r\nint i;\r\ntrace_xfs_attr_leaf_to_sf(args);\r\ntmpbuffer = kmem_alloc(args->geo->blksize, KM_SLEEP);\r\nif (!tmpbuffer)\r\nreturn -ENOMEM;\r\nmemcpy(tmpbuffer, bp->b_addr, args->geo->blksize);\r\nleaf = (xfs_attr_leafblock_t *)tmpbuffer;\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr, leaf);\r\nentry = xfs_attr3_leaf_entryp(leaf);\r\nmemset(bp->b_addr, 0, args->geo->blksize);\r\nerror = xfs_da_shrink_inode(args, 0, bp);\r\nif (error)\r\ngoto out;\r\nif (forkoff == -1) {\r\nASSERT(dp->i_mount->m_flags & XFS_MOUNT_ATTR2);\r\nASSERT(dp->i_d.di_format != XFS_DINODE_FMT_BTREE);\r\nxfs_attr_fork_remove(dp, args->trans);\r\ngoto out;\r\n}\r\nxfs_attr_shortform_create(args);\r\nmemset((char *)&nargs, 0, sizeof(nargs));\r\nnargs.geo = args->geo;\r\nnargs.dp = dp;\r\nnargs.firstblock = args->firstblock;\r\nnargs.flist = args->flist;\r\nnargs.total = args->total;\r\nnargs.whichfork = XFS_ATTR_FORK;\r\nnargs.trans = args->trans;\r\nnargs.op_flags = XFS_DA_OP_OKNOENT;\r\nfor (i = 0; i < ichdr.count; entry++, i++) {\r\nif (entry->flags & XFS_ATTR_INCOMPLETE)\r\ncontinue;\r\nif (!entry->nameidx)\r\ncontinue;\r\nASSERT(entry->flags & XFS_ATTR_LOCAL);\r\nname_loc = xfs_attr3_leaf_name_local(leaf, i);\r\nnargs.name = name_loc->nameval;\r\nnargs.namelen = name_loc->namelen;\r\nnargs.value = &name_loc->nameval[nargs.namelen];\r\nnargs.valuelen = be16_to_cpu(name_loc->valuelen);\r\nnargs.hashval = be32_to_cpu(entry->hashval);\r\nnargs.flags = XFS_ATTR_NSP_ONDISK_TO_ARGS(entry->flags);\r\nxfs_attr_shortform_add(&nargs, forkoff);\r\n}\r\nerror = 0;\r\nout:\r\nkmem_free(tmpbuffer);\r\nreturn error;\r\n}\r\nint\r\nxfs_attr3_leaf_to_node(\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr3_icleaf_hdr icleafhdr;\r\nstruct xfs_attr_leaf_entry *entries;\r\nstruct xfs_da_node_entry *btree;\r\nstruct xfs_da3_icnode_hdr icnodehdr;\r\nstruct xfs_da_intnode *node;\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_mount *mp = dp->i_mount;\r\nstruct xfs_buf *bp1 = NULL;\r\nstruct xfs_buf *bp2 = NULL;\r\nxfs_dablk_t blkno;\r\nint error;\r\ntrace_xfs_attr_leaf_to_node(args);\r\nerror = xfs_da_grow_inode(args, &blkno);\r\nif (error)\r\ngoto out;\r\nerror = xfs_attr3_leaf_read(args->trans, dp, 0, -1, &bp1);\r\nif (error)\r\ngoto out;\r\nerror = xfs_da_get_buf(args->trans, dp, blkno, -1, &bp2, XFS_ATTR_FORK);\r\nif (error)\r\ngoto out;\r\nxfs_trans_buf_set_type(args->trans, bp2, XFS_BLFT_ATTR_LEAF_BUF);\r\nbp2->b_ops = bp1->b_ops;\r\nmemcpy(bp2->b_addr, bp1->b_addr, args->geo->blksize);\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nstruct xfs_da3_blkinfo *hdr3 = bp2->b_addr;\r\nhdr3->blkno = cpu_to_be64(bp2->b_bn);\r\n}\r\nxfs_trans_log_buf(args->trans, bp2, 0, args->geo->blksize - 1);\r\nerror = xfs_da3_node_create(args, 0, 1, &bp1, XFS_ATTR_FORK);\r\nif (error)\r\ngoto out;\r\nnode = bp1->b_addr;\r\ndp->d_ops->node_hdr_from_disk(&icnodehdr, node);\r\nbtree = dp->d_ops->node_tree_p(node);\r\nleaf = bp2->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &icleafhdr, leaf);\r\nentries = xfs_attr3_leaf_entryp(leaf);\r\nbtree[0].hashval = entries[icleafhdr.count - 1].hashval;\r\nbtree[0].before = cpu_to_be32(blkno);\r\nicnodehdr.count = 1;\r\ndp->d_ops->node_hdr_to_disk(node, &icnodehdr);\r\nxfs_trans_log_buf(args->trans, bp1, 0, args->geo->blksize - 1);\r\nerror = 0;\r\nout:\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_attr3_leaf_create(\r\nstruct xfs_da_args *args,\r\nxfs_dablk_t blkno,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_mount *mp = dp->i_mount;\r\nstruct xfs_buf *bp;\r\nint error;\r\ntrace_xfs_attr_leaf_create(args);\r\nerror = xfs_da_get_buf(args->trans, args->dp, blkno, -1, &bp,\r\nXFS_ATTR_FORK);\r\nif (error)\r\nreturn error;\r\nbp->b_ops = &xfs_attr3_leaf_buf_ops;\r\nxfs_trans_buf_set_type(args->trans, bp, XFS_BLFT_ATTR_LEAF_BUF);\r\nleaf = bp->b_addr;\r\nmemset(leaf, 0, args->geo->blksize);\r\nmemset(&ichdr, 0, sizeof(ichdr));\r\nichdr.firstused = args->geo->blksize;\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nstruct xfs_da3_blkinfo *hdr3 = bp->b_addr;\r\nichdr.magic = XFS_ATTR3_LEAF_MAGIC;\r\nhdr3->blkno = cpu_to_be64(bp->b_bn);\r\nhdr3->owner = cpu_to_be64(dp->i_ino);\r\nuuid_copy(&hdr3->uuid, &mp->m_sb.sb_uuid);\r\nichdr.freemap[0].base = sizeof(struct xfs_attr3_leaf_hdr);\r\n} else {\r\nichdr.magic = XFS_ATTR_LEAF_MAGIC;\r\nichdr.freemap[0].base = sizeof(struct xfs_attr_leaf_hdr);\r\n}\r\nichdr.freemap[0].size = ichdr.firstused - ichdr.freemap[0].base;\r\nxfs_attr3_leaf_hdr_to_disk(args->geo, leaf, &ichdr);\r\nxfs_trans_log_buf(args->trans, bp, 0, args->geo->blksize - 1);\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nint\r\nxfs_attr3_leaf_split(\r\nstruct xfs_da_state *state,\r\nstruct xfs_da_state_blk *oldblk,\r\nstruct xfs_da_state_blk *newblk)\r\n{\r\nxfs_dablk_t blkno;\r\nint error;\r\ntrace_xfs_attr_leaf_split(state->args);\r\nASSERT(oldblk->magic == XFS_ATTR_LEAF_MAGIC);\r\nerror = xfs_da_grow_inode(state->args, &blkno);\r\nif (error)\r\nreturn error;\r\nerror = xfs_attr3_leaf_create(state->args, blkno, &newblk->bp);\r\nif (error)\r\nreturn error;\r\nnewblk->blkno = blkno;\r\nnewblk->magic = XFS_ATTR_LEAF_MAGIC;\r\nxfs_attr3_leaf_rebalance(state, oldblk, newblk);\r\nerror = xfs_da3_blk_link(state, oldblk, newblk);\r\nif (error)\r\nreturn error;\r\nif (state->inleaf) {\r\ntrace_xfs_attr_leaf_add_old(state->args);\r\nerror = xfs_attr3_leaf_add(oldblk->bp, state->args);\r\n} else {\r\ntrace_xfs_attr_leaf_add_new(state->args);\r\nerror = xfs_attr3_leaf_add(newblk->bp, state->args);\r\n}\r\noldblk->hashval = xfs_attr_leaf_lasthash(oldblk->bp, NULL);\r\nnewblk->hashval = xfs_attr_leaf_lasthash(newblk->bp, NULL);\r\nreturn error;\r\n}\r\nint\r\nxfs_attr3_leaf_add(\r\nstruct xfs_buf *bp,\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nint tablesize;\r\nint entsize;\r\nint sum;\r\nint tmp;\r\nint i;\r\ntrace_xfs_attr_leaf_add(args);\r\nleaf = bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr, leaf);\r\nASSERT(args->index >= 0 && args->index <= ichdr.count);\r\nentsize = xfs_attr_leaf_newentsize(args, NULL);\r\ntablesize = (ichdr.count + 1) * sizeof(xfs_attr_leaf_entry_t)\r\n+ xfs_attr3_leaf_hdr_size(leaf);\r\nfor (sum = 0, i = XFS_ATTR_LEAF_MAPSIZE - 1; i >= 0; i--) {\r\nif (tablesize > ichdr.firstused) {\r\nsum += ichdr.freemap[i].size;\r\ncontinue;\r\n}\r\nif (!ichdr.freemap[i].size)\r\ncontinue;\r\ntmp = entsize;\r\nif (ichdr.freemap[i].base < ichdr.firstused)\r\ntmp += sizeof(xfs_attr_leaf_entry_t);\r\nif (ichdr.freemap[i].size >= tmp) {\r\ntmp = xfs_attr3_leaf_add_work(bp, &ichdr, args, i);\r\ngoto out_log_hdr;\r\n}\r\nsum += ichdr.freemap[i].size;\r\n}\r\nif (!ichdr.holes && sum < entsize)\r\nreturn -ENOSPC;\r\nxfs_attr3_leaf_compact(args, &ichdr, bp);\r\nif (ichdr.freemap[0].size < (entsize + sizeof(xfs_attr_leaf_entry_t))) {\r\ntmp = -ENOSPC;\r\ngoto out_log_hdr;\r\n}\r\ntmp = xfs_attr3_leaf_add_work(bp, &ichdr, args, 0);\r\nout_log_hdr:\r\nxfs_attr3_leaf_hdr_to_disk(args->geo, leaf, &ichdr);\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, &leaf->hdr,\r\nxfs_attr3_leaf_hdr_size(leaf)));\r\nreturn tmp;\r\n}\r\nSTATIC int\r\nxfs_attr3_leaf_add_work(\r\nstruct xfs_buf *bp,\r\nstruct xfs_attr3_icleaf_hdr *ichdr,\r\nstruct xfs_da_args *args,\r\nint mapindex)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr_leaf_entry *entry;\r\nstruct xfs_attr_leaf_name_local *name_loc;\r\nstruct xfs_attr_leaf_name_remote *name_rmt;\r\nstruct xfs_mount *mp;\r\nint tmp;\r\nint i;\r\ntrace_xfs_attr_leaf_add_work(args);\r\nleaf = bp->b_addr;\r\nASSERT(mapindex >= 0 && mapindex < XFS_ATTR_LEAF_MAPSIZE);\r\nASSERT(args->index >= 0 && args->index <= ichdr->count);\r\nentry = &xfs_attr3_leaf_entryp(leaf)[args->index];\r\nif (args->index < ichdr->count) {\r\ntmp = ichdr->count - args->index;\r\ntmp *= sizeof(xfs_attr_leaf_entry_t);\r\nmemmove(entry + 1, entry, tmp);\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, entry, tmp + sizeof(*entry)));\r\n}\r\nichdr->count++;\r\nmp = args->trans->t_mountp;\r\nASSERT(ichdr->freemap[mapindex].base < args->geo->blksize);\r\nASSERT((ichdr->freemap[mapindex].base & 0x3) == 0);\r\nASSERT(ichdr->freemap[mapindex].size >=\r\nxfs_attr_leaf_newentsize(args, NULL));\r\nASSERT(ichdr->freemap[mapindex].size < args->geo->blksize);\r\nASSERT((ichdr->freemap[mapindex].size & 0x3) == 0);\r\nichdr->freemap[mapindex].size -= xfs_attr_leaf_newentsize(args, &tmp);\r\nentry->nameidx = cpu_to_be16(ichdr->freemap[mapindex].base +\r\nichdr->freemap[mapindex].size);\r\nentry->hashval = cpu_to_be32(args->hashval);\r\nentry->flags = tmp ? XFS_ATTR_LOCAL : 0;\r\nentry->flags |= XFS_ATTR_NSP_ARGS_TO_ONDISK(args->flags);\r\nif (args->op_flags & XFS_DA_OP_RENAME) {\r\nentry->flags |= XFS_ATTR_INCOMPLETE;\r\nif ((args->blkno2 == args->blkno) &&\r\n(args->index2 <= args->index)) {\r\nargs->index2++;\r\n}\r\n}\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, entry, sizeof(*entry)));\r\nASSERT((args->index == 0) ||\r\n(be32_to_cpu(entry->hashval) >= be32_to_cpu((entry-1)->hashval)));\r\nASSERT((args->index == ichdr->count - 1) ||\r\n(be32_to_cpu(entry->hashval) <= be32_to_cpu((entry+1)->hashval)));\r\nif (entry->flags & XFS_ATTR_LOCAL) {\r\nname_loc = xfs_attr3_leaf_name_local(leaf, args->index);\r\nname_loc->namelen = args->namelen;\r\nname_loc->valuelen = cpu_to_be16(args->valuelen);\r\nmemcpy((char *)name_loc->nameval, args->name, args->namelen);\r\nmemcpy((char *)&name_loc->nameval[args->namelen], args->value,\r\nbe16_to_cpu(name_loc->valuelen));\r\n} else {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf, args->index);\r\nname_rmt->namelen = args->namelen;\r\nmemcpy((char *)name_rmt->name, args->name, args->namelen);\r\nentry->flags |= XFS_ATTR_INCOMPLETE;\r\nname_rmt->valuelen = 0;\r\nname_rmt->valueblk = 0;\r\nargs->rmtblkno = 1;\r\nargs->rmtblkcnt = xfs_attr3_rmt_blocks(mp, args->valuelen);\r\nargs->rmtvaluelen = args->valuelen;\r\n}\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, xfs_attr3_leaf_name(leaf, args->index),\r\nxfs_attr_leaf_entsize(leaf, args->index)));\r\nif (be16_to_cpu(entry->nameidx) < ichdr->firstused)\r\nichdr->firstused = be16_to_cpu(entry->nameidx);\r\nASSERT(ichdr->firstused >= ichdr->count * sizeof(xfs_attr_leaf_entry_t)\r\n+ xfs_attr3_leaf_hdr_size(leaf));\r\ntmp = (ichdr->count - 1) * sizeof(xfs_attr_leaf_entry_t)\r\n+ xfs_attr3_leaf_hdr_size(leaf);\r\nfor (i = 0; i < XFS_ATTR_LEAF_MAPSIZE; i++) {\r\nif (ichdr->freemap[i].base == tmp) {\r\nichdr->freemap[i].base += sizeof(xfs_attr_leaf_entry_t);\r\nichdr->freemap[i].size -= sizeof(xfs_attr_leaf_entry_t);\r\n}\r\n}\r\nichdr->usedbytes += xfs_attr_leaf_entsize(leaf, args->index);\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_attr3_leaf_compact(\r\nstruct xfs_da_args *args,\r\nstruct xfs_attr3_icleaf_hdr *ichdr_dst,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_attr_leafblock *leaf_src;\r\nstruct xfs_attr_leafblock *leaf_dst;\r\nstruct xfs_attr3_icleaf_hdr ichdr_src;\r\nstruct xfs_trans *trans = args->trans;\r\nchar *tmpbuffer;\r\ntrace_xfs_attr_leaf_compact(args);\r\ntmpbuffer = kmem_alloc(args->geo->blksize, KM_SLEEP);\r\nmemcpy(tmpbuffer, bp->b_addr, args->geo->blksize);\r\nmemset(bp->b_addr, 0, args->geo->blksize);\r\nleaf_src = (xfs_attr_leafblock_t *)tmpbuffer;\r\nleaf_dst = bp->b_addr;\r\nmemcpy(bp->b_addr, tmpbuffer, xfs_attr3_leaf_hdr_size(leaf_src));\r\nichdr_src = *ichdr_dst;\r\nichdr_dst->firstused = args->geo->blksize;\r\nichdr_dst->usedbytes = 0;\r\nichdr_dst->count = 0;\r\nichdr_dst->holes = 0;\r\nichdr_dst->freemap[0].base = xfs_attr3_leaf_hdr_size(leaf_src);\r\nichdr_dst->freemap[0].size = ichdr_dst->firstused -\r\nichdr_dst->freemap[0].base;\r\nxfs_attr3_leaf_hdr_to_disk(args->geo, leaf_dst, ichdr_dst);\r\nxfs_attr3_leaf_moveents(args, leaf_src, &ichdr_src, 0,\r\nleaf_dst, ichdr_dst, 0, ichdr_src.count);\r\nxfs_trans_log_buf(trans, bp, 0, args->geo->blksize - 1);\r\nkmem_free(tmpbuffer);\r\n}\r\nstatic int\r\nxfs_attr3_leaf_order(\r\nstruct xfs_buf *leaf1_bp,\r\nstruct xfs_attr3_icleaf_hdr *leaf1hdr,\r\nstruct xfs_buf *leaf2_bp,\r\nstruct xfs_attr3_icleaf_hdr *leaf2hdr)\r\n{\r\nstruct xfs_attr_leaf_entry *entries1;\r\nstruct xfs_attr_leaf_entry *entries2;\r\nentries1 = xfs_attr3_leaf_entryp(leaf1_bp->b_addr);\r\nentries2 = xfs_attr3_leaf_entryp(leaf2_bp->b_addr);\r\nif (leaf1hdr->count > 0 && leaf2hdr->count > 0 &&\r\n((be32_to_cpu(entries2[0].hashval) <\r\nbe32_to_cpu(entries1[0].hashval)) ||\r\n(be32_to_cpu(entries2[leaf2hdr->count - 1].hashval) <\r\nbe32_to_cpu(entries1[leaf1hdr->count - 1].hashval)))) {\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_attr_leaf_order(\r\nstruct xfs_buf *leaf1_bp,\r\nstruct xfs_buf *leaf2_bp)\r\n{\r\nstruct xfs_attr3_icleaf_hdr ichdr1;\r\nstruct xfs_attr3_icleaf_hdr ichdr2;\r\nstruct xfs_mount *mp = leaf1_bp->b_target->bt_mount;\r\nxfs_attr3_leaf_hdr_from_disk(mp->m_attr_geo, &ichdr1, leaf1_bp->b_addr);\r\nxfs_attr3_leaf_hdr_from_disk(mp->m_attr_geo, &ichdr2, leaf2_bp->b_addr);\r\nreturn xfs_attr3_leaf_order(leaf1_bp, &ichdr1, leaf2_bp, &ichdr2);\r\n}\r\nSTATIC void\r\nxfs_attr3_leaf_rebalance(\r\nstruct xfs_da_state *state,\r\nstruct xfs_da_state_blk *blk1,\r\nstruct xfs_da_state_blk *blk2)\r\n{\r\nstruct xfs_da_args *args;\r\nstruct xfs_attr_leafblock *leaf1;\r\nstruct xfs_attr_leafblock *leaf2;\r\nstruct xfs_attr3_icleaf_hdr ichdr1;\r\nstruct xfs_attr3_icleaf_hdr ichdr2;\r\nstruct xfs_attr_leaf_entry *entries1;\r\nstruct xfs_attr_leaf_entry *entries2;\r\nint count;\r\nint totallen;\r\nint max;\r\nint space;\r\nint swap;\r\nASSERT(blk1->magic == XFS_ATTR_LEAF_MAGIC);\r\nASSERT(blk2->magic == XFS_ATTR_LEAF_MAGIC);\r\nleaf1 = blk1->bp->b_addr;\r\nleaf2 = blk2->bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(state->args->geo, &ichdr1, leaf1);\r\nxfs_attr3_leaf_hdr_from_disk(state->args->geo, &ichdr2, leaf2);\r\nASSERT(ichdr2.count == 0);\r\nargs = state->args;\r\ntrace_xfs_attr_leaf_rebalance(args);\r\nswap = 0;\r\nif (xfs_attr3_leaf_order(blk1->bp, &ichdr1, blk2->bp, &ichdr2)) {\r\nstruct xfs_da_state_blk *tmp_blk;\r\nstruct xfs_attr3_icleaf_hdr tmp_ichdr;\r\ntmp_blk = blk1;\r\nblk1 = blk2;\r\nblk2 = tmp_blk;\r\ntmp_ichdr = ichdr1;\r\nichdr1 = ichdr2;\r\nichdr2 = tmp_ichdr;\r\nleaf1 = blk1->bp->b_addr;\r\nleaf2 = blk2->bp->b_addr;\r\nswap = 1;\r\n}\r\nstate->inleaf = xfs_attr3_leaf_figure_balance(state, blk1, &ichdr1,\r\nblk2, &ichdr2,\r\n&count, &totallen);\r\nif (swap)\r\nstate->inleaf = !state->inleaf;\r\nif (count < ichdr1.count) {\r\ncount = ichdr1.count - count;\r\nspace = ichdr1.usedbytes - totallen;\r\nspace += count * sizeof(xfs_attr_leaf_entry_t);\r\nmax = ichdr2.firstused - xfs_attr3_leaf_hdr_size(leaf1);\r\nmax -= ichdr2.count * sizeof(xfs_attr_leaf_entry_t);\r\nif (space > max)\r\nxfs_attr3_leaf_compact(args, &ichdr2, blk2->bp);\r\nxfs_attr3_leaf_moveents(args, leaf1, &ichdr1,\r\nichdr1.count - count, leaf2, &ichdr2, 0, count);\r\n} else if (count > ichdr1.count) {\r\nASSERT(0);\r\ncount -= ichdr1.count;\r\nspace = totallen - ichdr1.usedbytes;\r\nspace += count * sizeof(xfs_attr_leaf_entry_t);\r\nmax = ichdr1.firstused - xfs_attr3_leaf_hdr_size(leaf1);\r\nmax -= ichdr1.count * sizeof(xfs_attr_leaf_entry_t);\r\nif (space > max)\r\nxfs_attr3_leaf_compact(args, &ichdr1, blk1->bp);\r\nxfs_attr3_leaf_moveents(args, leaf2, &ichdr2, 0, leaf1, &ichdr1,\r\nichdr1.count, count);\r\n}\r\nxfs_attr3_leaf_hdr_to_disk(state->args->geo, leaf1, &ichdr1);\r\nxfs_attr3_leaf_hdr_to_disk(state->args->geo, leaf2, &ichdr2);\r\nxfs_trans_log_buf(args->trans, blk1->bp, 0, args->geo->blksize - 1);\r\nxfs_trans_log_buf(args->trans, blk2->bp, 0, args->geo->blksize - 1);\r\nentries1 = xfs_attr3_leaf_entryp(leaf1);\r\nentries2 = xfs_attr3_leaf_entryp(leaf2);\r\nblk1->hashval = be32_to_cpu(entries1[ichdr1.count - 1].hashval);\r\nblk2->hashval = be32_to_cpu(entries2[ichdr2.count - 1].hashval);\r\nif (blk1->index > ichdr1.count) {\r\nASSERT(state->inleaf == 0);\r\nblk2->index = blk1->index - ichdr1.count;\r\nargs->index = args->index2 = blk2->index;\r\nargs->blkno = args->blkno2 = blk2->blkno;\r\n} else if (blk1->index == ichdr1.count) {\r\nif (state->inleaf) {\r\nargs->index = blk1->index;\r\nargs->blkno = blk1->blkno;\r\nargs->index2 = 0;\r\nargs->blkno2 = blk2->blkno;\r\n} else {\r\nblk2->index = blk1->index - ichdr1.count;\r\nargs->index = blk2->index;\r\nargs->blkno = blk2->blkno;\r\nif (!state->extravalid) {\r\nargs->index2 = blk2->index;\r\nargs->blkno2 = blk2->blkno;\r\n}\r\n}\r\n} else {\r\nASSERT(state->inleaf == 1);\r\nargs->index = args->index2 = blk1->index;\r\nargs->blkno = args->blkno2 = blk1->blkno;\r\n}\r\n}\r\nSTATIC int\r\nxfs_attr3_leaf_figure_balance(\r\nstruct xfs_da_state *state,\r\nstruct xfs_da_state_blk *blk1,\r\nstruct xfs_attr3_icleaf_hdr *ichdr1,\r\nstruct xfs_da_state_blk *blk2,\r\nstruct xfs_attr3_icleaf_hdr *ichdr2,\r\nint *countarg,\r\nint *usedbytesarg)\r\n{\r\nstruct xfs_attr_leafblock *leaf1 = blk1->bp->b_addr;\r\nstruct xfs_attr_leafblock *leaf2 = blk2->bp->b_addr;\r\nstruct xfs_attr_leaf_entry *entry;\r\nint count;\r\nint max;\r\nint index;\r\nint totallen = 0;\r\nint half;\r\nint lastdelta;\r\nint foundit = 0;\r\nint tmp;\r\nmax = ichdr1->count + ichdr2->count;\r\nhalf = (max + 1) * sizeof(*entry);\r\nhalf += ichdr1->usedbytes + ichdr2->usedbytes +\r\nxfs_attr_leaf_newentsize(state->args, NULL);\r\nhalf /= 2;\r\nlastdelta = state->args->geo->blksize;\r\nentry = xfs_attr3_leaf_entryp(leaf1);\r\nfor (count = index = 0; count < max; entry++, index++, count++) {\r\n#define XFS_ATTR_ABS(A) (((A) < 0) ? -(A) : (A))\r\nif (count == blk1->index) {\r\ntmp = totallen + sizeof(*entry) +\r\nxfs_attr_leaf_newentsize(state->args, NULL);\r\nif (XFS_ATTR_ABS(half - tmp) > lastdelta)\r\nbreak;\r\nlastdelta = XFS_ATTR_ABS(half - tmp);\r\ntotallen = tmp;\r\nfoundit = 1;\r\n}\r\nif (count == ichdr1->count) {\r\nleaf1 = leaf2;\r\nentry = xfs_attr3_leaf_entryp(leaf1);\r\nindex = 0;\r\n}\r\ntmp = totallen + sizeof(*entry) + xfs_attr_leaf_entsize(leaf1,\r\nindex);\r\nif (XFS_ATTR_ABS(half - tmp) > lastdelta)\r\nbreak;\r\nlastdelta = XFS_ATTR_ABS(half - tmp);\r\ntotallen = tmp;\r\n#undef XFS_ATTR_ABS\r\n}\r\ntotallen -= count * sizeof(*entry);\r\nif (foundit) {\r\ntotallen -= sizeof(*entry) +\r\nxfs_attr_leaf_newentsize(state->args, NULL);\r\n}\r\n*countarg = count;\r\n*usedbytesarg = totallen;\r\nreturn foundit;\r\n}\r\nint\r\nxfs_attr3_leaf_toosmall(\r\nstruct xfs_da_state *state,\r\nint *action)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_da_state_blk *blk;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nstruct xfs_buf *bp;\r\nxfs_dablk_t blkno;\r\nint bytes;\r\nint forward;\r\nint error;\r\nint retval;\r\nint i;\r\ntrace_xfs_attr_leaf_toosmall(state->args);\r\nblk = &state->path.blk[ state->path.active-1 ];\r\nleaf = blk->bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(state->args->geo, &ichdr, leaf);\r\nbytes = xfs_attr3_leaf_hdr_size(leaf) +\r\nichdr.count * sizeof(xfs_attr_leaf_entry_t) +\r\nichdr.usedbytes;\r\nif (bytes > (state->args->geo->blksize >> 1)) {\r\n*action = 0;\r\nreturn 0;\r\n}\r\nif (ichdr.count == 0) {\r\nforward = (ichdr.forw != 0);\r\nmemcpy(&state->altpath, &state->path, sizeof(state->path));\r\nerror = xfs_da3_path_shift(state, &state->altpath, forward,\r\n0, &retval);\r\nif (error)\r\nreturn error;\r\nif (retval) {\r\n*action = 0;\r\n} else {\r\n*action = 2;\r\n}\r\nreturn 0;\r\n}\r\nforward = ichdr.forw < ichdr.back;\r\nfor (i = 0; i < 2; forward = !forward, i++) {\r\nstruct xfs_attr3_icleaf_hdr ichdr2;\r\nif (forward)\r\nblkno = ichdr.forw;\r\nelse\r\nblkno = ichdr.back;\r\nif (blkno == 0)\r\ncontinue;\r\nerror = xfs_attr3_leaf_read(state->args->trans, state->args->dp,\r\nblkno, -1, &bp);\r\nif (error)\r\nreturn error;\r\nxfs_attr3_leaf_hdr_from_disk(state->args->geo, &ichdr2, bp->b_addr);\r\nbytes = state->args->geo->blksize -\r\n(state->args->geo->blksize >> 2) -\r\nichdr.usedbytes - ichdr2.usedbytes -\r\n((ichdr.count + ichdr2.count) *\r\nsizeof(xfs_attr_leaf_entry_t)) -\r\nxfs_attr3_leaf_hdr_size(leaf);\r\nxfs_trans_brelse(state->args->trans, bp);\r\nif (bytes >= 0)\r\nbreak;\r\n}\r\nif (i >= 2) {\r\n*action = 0;\r\nreturn 0;\r\n}\r\nmemcpy(&state->altpath, &state->path, sizeof(state->path));\r\nif (blkno < blk->blkno) {\r\nerror = xfs_da3_path_shift(state, &state->altpath, forward,\r\n0, &retval);\r\n} else {\r\nerror = xfs_da3_path_shift(state, &state->path, forward,\r\n0, &retval);\r\n}\r\nif (error)\r\nreturn error;\r\nif (retval) {\r\n*action = 0;\r\n} else {\r\n*action = 1;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_attr3_leaf_remove(\r\nstruct xfs_buf *bp,\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nstruct xfs_attr_leaf_entry *entry;\r\nint before;\r\nint after;\r\nint smallest;\r\nint entsize;\r\nint tablesize;\r\nint tmp;\r\nint i;\r\ntrace_xfs_attr_leaf_remove(args);\r\nleaf = bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr, leaf);\r\nASSERT(ichdr.count > 0 && ichdr.count < args->geo->blksize / 8);\r\nASSERT(args->index >= 0 && args->index < ichdr.count);\r\nASSERT(ichdr.firstused >= ichdr.count * sizeof(*entry) +\r\nxfs_attr3_leaf_hdr_size(leaf));\r\nentry = &xfs_attr3_leaf_entryp(leaf)[args->index];\r\nASSERT(be16_to_cpu(entry->nameidx) >= ichdr.firstused);\r\nASSERT(be16_to_cpu(entry->nameidx) < args->geo->blksize);\r\ntablesize = ichdr.count * sizeof(xfs_attr_leaf_entry_t)\r\n+ xfs_attr3_leaf_hdr_size(leaf);\r\ntmp = ichdr.freemap[0].size;\r\nbefore = after = -1;\r\nsmallest = XFS_ATTR_LEAF_MAPSIZE - 1;\r\nentsize = xfs_attr_leaf_entsize(leaf, args->index);\r\nfor (i = 0; i < XFS_ATTR_LEAF_MAPSIZE; i++) {\r\nASSERT(ichdr.freemap[i].base < args->geo->blksize);\r\nASSERT(ichdr.freemap[i].size < args->geo->blksize);\r\nif (ichdr.freemap[i].base == tablesize) {\r\nichdr.freemap[i].base -= sizeof(xfs_attr_leaf_entry_t);\r\nichdr.freemap[i].size += sizeof(xfs_attr_leaf_entry_t);\r\n}\r\nif (ichdr.freemap[i].base + ichdr.freemap[i].size ==\r\nbe16_to_cpu(entry->nameidx)) {\r\nbefore = i;\r\n} else if (ichdr.freemap[i].base ==\r\n(be16_to_cpu(entry->nameidx) + entsize)) {\r\nafter = i;\r\n} else if (ichdr.freemap[i].size < tmp) {\r\ntmp = ichdr.freemap[i].size;\r\nsmallest = i;\r\n}\r\n}\r\nif ((before >= 0) || (after >= 0)) {\r\nif ((before >= 0) && (after >= 0)) {\r\nichdr.freemap[before].size += entsize;\r\nichdr.freemap[before].size += ichdr.freemap[after].size;\r\nichdr.freemap[after].base = 0;\r\nichdr.freemap[after].size = 0;\r\n} else if (before >= 0) {\r\nichdr.freemap[before].size += entsize;\r\n} else {\r\nichdr.freemap[after].base = be16_to_cpu(entry->nameidx);\r\nichdr.freemap[after].size += entsize;\r\n}\r\n} else {\r\nif (ichdr.freemap[smallest].size < entsize) {\r\nichdr.freemap[smallest].base = be16_to_cpu(entry->nameidx);\r\nichdr.freemap[smallest].size = entsize;\r\n}\r\n}\r\nif (be16_to_cpu(entry->nameidx) == ichdr.firstused)\r\nsmallest = 1;\r\nelse\r\nsmallest = 0;\r\nmemset(xfs_attr3_leaf_name(leaf, args->index), 0, entsize);\r\nichdr.usedbytes -= entsize;\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, xfs_attr3_leaf_name(leaf, args->index),\r\nentsize));\r\ntmp = (ichdr.count - args->index) * sizeof(xfs_attr_leaf_entry_t);\r\nmemmove(entry, entry + 1, tmp);\r\nichdr.count--;\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, entry, tmp + sizeof(xfs_attr_leaf_entry_t)));\r\nentry = &xfs_attr3_leaf_entryp(leaf)[ichdr.count];\r\nmemset(entry, 0, sizeof(xfs_attr_leaf_entry_t));\r\nif (smallest) {\r\ntmp = args->geo->blksize;\r\nentry = xfs_attr3_leaf_entryp(leaf);\r\nfor (i = ichdr.count - 1; i >= 0; entry++, i--) {\r\nASSERT(be16_to_cpu(entry->nameidx) >= ichdr.firstused);\r\nASSERT(be16_to_cpu(entry->nameidx) < args->geo->blksize);\r\nif (be16_to_cpu(entry->nameidx) < tmp)\r\ntmp = be16_to_cpu(entry->nameidx);\r\n}\r\nichdr.firstused = tmp;\r\nASSERT(ichdr.firstused != 0);\r\n} else {\r\nichdr.holes = 1;\r\n}\r\nxfs_attr3_leaf_hdr_to_disk(args->geo, leaf, &ichdr);\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, &leaf->hdr,\r\nxfs_attr3_leaf_hdr_size(leaf)));\r\ntmp = ichdr.usedbytes + xfs_attr3_leaf_hdr_size(leaf) +\r\nichdr.count * sizeof(xfs_attr_leaf_entry_t);\r\nreturn tmp < args->geo->magicpct;\r\n}\r\nvoid\r\nxfs_attr3_leaf_unbalance(\r\nstruct xfs_da_state *state,\r\nstruct xfs_da_state_blk *drop_blk,\r\nstruct xfs_da_state_blk *save_blk)\r\n{\r\nstruct xfs_attr_leafblock *drop_leaf = drop_blk->bp->b_addr;\r\nstruct xfs_attr_leafblock *save_leaf = save_blk->bp->b_addr;\r\nstruct xfs_attr3_icleaf_hdr drophdr;\r\nstruct xfs_attr3_icleaf_hdr savehdr;\r\nstruct xfs_attr_leaf_entry *entry;\r\ntrace_xfs_attr_leaf_unbalance(state->args);\r\ndrop_leaf = drop_blk->bp->b_addr;\r\nsave_leaf = save_blk->bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(state->args->geo, &drophdr, drop_leaf);\r\nxfs_attr3_leaf_hdr_from_disk(state->args->geo, &savehdr, save_leaf);\r\nentry = xfs_attr3_leaf_entryp(drop_leaf);\r\ndrop_blk->hashval = be32_to_cpu(entry[drophdr.count - 1].hashval);\r\nif (savehdr.holes == 0) {\r\nif (xfs_attr3_leaf_order(save_blk->bp, &savehdr,\r\ndrop_blk->bp, &drophdr)) {\r\nxfs_attr3_leaf_moveents(state->args,\r\ndrop_leaf, &drophdr, 0,\r\nsave_leaf, &savehdr, 0,\r\ndrophdr.count);\r\n} else {\r\nxfs_attr3_leaf_moveents(state->args,\r\ndrop_leaf, &drophdr, 0,\r\nsave_leaf, &savehdr,\r\nsavehdr.count, drophdr.count);\r\n}\r\n} else {\r\nstruct xfs_attr_leafblock *tmp_leaf;\r\nstruct xfs_attr3_icleaf_hdr tmphdr;\r\ntmp_leaf = kmem_zalloc(state->args->geo->blksize, KM_SLEEP);\r\nmemcpy(tmp_leaf, save_leaf, xfs_attr3_leaf_hdr_size(save_leaf));\r\nmemset(&tmphdr, 0, sizeof(tmphdr));\r\ntmphdr.magic = savehdr.magic;\r\ntmphdr.forw = savehdr.forw;\r\ntmphdr.back = savehdr.back;\r\ntmphdr.firstused = state->args->geo->blksize;\r\nxfs_attr3_leaf_hdr_to_disk(state->args->geo, tmp_leaf, &tmphdr);\r\nif (xfs_attr3_leaf_order(save_blk->bp, &savehdr,\r\ndrop_blk->bp, &drophdr)) {\r\nxfs_attr3_leaf_moveents(state->args,\r\ndrop_leaf, &drophdr, 0,\r\ntmp_leaf, &tmphdr, 0,\r\ndrophdr.count);\r\nxfs_attr3_leaf_moveents(state->args,\r\nsave_leaf, &savehdr, 0,\r\ntmp_leaf, &tmphdr, tmphdr.count,\r\nsavehdr.count);\r\n} else {\r\nxfs_attr3_leaf_moveents(state->args,\r\nsave_leaf, &savehdr, 0,\r\ntmp_leaf, &tmphdr, 0,\r\nsavehdr.count);\r\nxfs_attr3_leaf_moveents(state->args,\r\ndrop_leaf, &drophdr, 0,\r\ntmp_leaf, &tmphdr, tmphdr.count,\r\ndrophdr.count);\r\n}\r\nmemcpy(save_leaf, tmp_leaf, state->args->geo->blksize);\r\nsavehdr = tmphdr;\r\nkmem_free(tmp_leaf);\r\n}\r\nxfs_attr3_leaf_hdr_to_disk(state->args->geo, save_leaf, &savehdr);\r\nxfs_trans_log_buf(state->args->trans, save_blk->bp, 0,\r\nstate->args->geo->blksize - 1);\r\nentry = xfs_attr3_leaf_entryp(save_leaf);\r\nsave_blk->hashval = be32_to_cpu(entry[savehdr.count - 1].hashval);\r\n}\r\nint\r\nxfs_attr3_leaf_lookup_int(\r\nstruct xfs_buf *bp,\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nstruct xfs_attr_leaf_entry *entry;\r\nstruct xfs_attr_leaf_entry *entries;\r\nstruct xfs_attr_leaf_name_local *name_loc;\r\nstruct xfs_attr_leaf_name_remote *name_rmt;\r\nxfs_dahash_t hashval;\r\nint probe;\r\nint span;\r\ntrace_xfs_attr_leaf_lookup(args);\r\nleaf = bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr, leaf);\r\nentries = xfs_attr3_leaf_entryp(leaf);\r\nASSERT(ichdr.count < args->geo->blksize / 8);\r\nhashval = args->hashval;\r\nprobe = span = ichdr.count / 2;\r\nfor (entry = &entries[probe]; span > 4; entry = &entries[probe]) {\r\nspan /= 2;\r\nif (be32_to_cpu(entry->hashval) < hashval)\r\nprobe += span;\r\nelse if (be32_to_cpu(entry->hashval) > hashval)\r\nprobe -= span;\r\nelse\r\nbreak;\r\n}\r\nASSERT(probe >= 0 && (!ichdr.count || probe < ichdr.count));\r\nASSERT(span <= 4 || be32_to_cpu(entry->hashval) == hashval);\r\nwhile (probe > 0 && be32_to_cpu(entry->hashval) >= hashval) {\r\nentry--;\r\nprobe--;\r\n}\r\nwhile (probe < ichdr.count &&\r\nbe32_to_cpu(entry->hashval) < hashval) {\r\nentry++;\r\nprobe++;\r\n}\r\nif (probe == ichdr.count || be32_to_cpu(entry->hashval) != hashval) {\r\nargs->index = probe;\r\nreturn -ENOATTR;\r\n}\r\nfor (; probe < ichdr.count && (be32_to_cpu(entry->hashval) == hashval);\r\nentry++, probe++) {\r\nif ((args->flags & XFS_ATTR_INCOMPLETE) !=\r\n(entry->flags & XFS_ATTR_INCOMPLETE)) {\r\ncontinue;\r\n}\r\nif (entry->flags & XFS_ATTR_LOCAL) {\r\nname_loc = xfs_attr3_leaf_name_local(leaf, probe);\r\nif (name_loc->namelen != args->namelen)\r\ncontinue;\r\nif (memcmp(args->name, name_loc->nameval,\r\nargs->namelen) != 0)\r\ncontinue;\r\nif (!xfs_attr_namesp_match(args->flags, entry->flags))\r\ncontinue;\r\nargs->index = probe;\r\nreturn -EEXIST;\r\n} else {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf, probe);\r\nif (name_rmt->namelen != args->namelen)\r\ncontinue;\r\nif (memcmp(args->name, name_rmt->name,\r\nargs->namelen) != 0)\r\ncontinue;\r\nif (!xfs_attr_namesp_match(args->flags, entry->flags))\r\ncontinue;\r\nargs->index = probe;\r\nargs->rmtvaluelen = be32_to_cpu(name_rmt->valuelen);\r\nargs->rmtblkno = be32_to_cpu(name_rmt->valueblk);\r\nargs->rmtblkcnt = xfs_attr3_rmt_blocks(\r\nargs->dp->i_mount,\r\nargs->rmtvaluelen);\r\nreturn -EEXIST;\r\n}\r\n}\r\nargs->index = probe;\r\nreturn -ENOATTR;\r\n}\r\nint\r\nxfs_attr3_leaf_getvalue(\r\nstruct xfs_buf *bp,\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nstruct xfs_attr_leaf_entry *entry;\r\nstruct xfs_attr_leaf_name_local *name_loc;\r\nstruct xfs_attr_leaf_name_remote *name_rmt;\r\nint valuelen;\r\nleaf = bp->b_addr;\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr, leaf);\r\nASSERT(ichdr.count < args->geo->blksize / 8);\r\nASSERT(args->index < ichdr.count);\r\nentry = &xfs_attr3_leaf_entryp(leaf)[args->index];\r\nif (entry->flags & XFS_ATTR_LOCAL) {\r\nname_loc = xfs_attr3_leaf_name_local(leaf, args->index);\r\nASSERT(name_loc->namelen == args->namelen);\r\nASSERT(memcmp(args->name, name_loc->nameval, args->namelen) == 0);\r\nvaluelen = be16_to_cpu(name_loc->valuelen);\r\nif (args->flags & ATTR_KERNOVAL) {\r\nargs->valuelen = valuelen;\r\nreturn 0;\r\n}\r\nif (args->valuelen < valuelen) {\r\nargs->valuelen = valuelen;\r\nreturn -ERANGE;\r\n}\r\nargs->valuelen = valuelen;\r\nmemcpy(args->value, &name_loc->nameval[args->namelen], valuelen);\r\n} else {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf, args->index);\r\nASSERT(name_rmt->namelen == args->namelen);\r\nASSERT(memcmp(args->name, name_rmt->name, args->namelen) == 0);\r\nargs->rmtvaluelen = be32_to_cpu(name_rmt->valuelen);\r\nargs->rmtblkno = be32_to_cpu(name_rmt->valueblk);\r\nargs->rmtblkcnt = xfs_attr3_rmt_blocks(args->dp->i_mount,\r\nargs->rmtvaluelen);\r\nif (args->flags & ATTR_KERNOVAL) {\r\nargs->valuelen = args->rmtvaluelen;\r\nreturn 0;\r\n}\r\nif (args->valuelen < args->rmtvaluelen) {\r\nargs->valuelen = args->rmtvaluelen;\r\nreturn -ERANGE;\r\n}\r\nargs->valuelen = args->rmtvaluelen;\r\n}\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_attr3_leaf_moveents(\r\nstruct xfs_da_args *args,\r\nstruct xfs_attr_leafblock *leaf_s,\r\nstruct xfs_attr3_icleaf_hdr *ichdr_s,\r\nint start_s,\r\nstruct xfs_attr_leafblock *leaf_d,\r\nstruct xfs_attr3_icleaf_hdr *ichdr_d,\r\nint start_d,\r\nint count)\r\n{\r\nstruct xfs_attr_leaf_entry *entry_s;\r\nstruct xfs_attr_leaf_entry *entry_d;\r\nint desti;\r\nint tmp;\r\nint i;\r\nif (count == 0)\r\nreturn;\r\nASSERT(ichdr_s->magic == XFS_ATTR_LEAF_MAGIC ||\r\nichdr_s->magic == XFS_ATTR3_LEAF_MAGIC);\r\nASSERT(ichdr_s->magic == ichdr_d->magic);\r\nASSERT(ichdr_s->count > 0 && ichdr_s->count < args->geo->blksize / 8);\r\nASSERT(ichdr_s->firstused >= (ichdr_s->count * sizeof(*entry_s))\r\n+ xfs_attr3_leaf_hdr_size(leaf_s));\r\nASSERT(ichdr_d->count < args->geo->blksize / 8);\r\nASSERT(ichdr_d->firstused >= (ichdr_d->count * sizeof(*entry_d))\r\n+ xfs_attr3_leaf_hdr_size(leaf_d));\r\nASSERT(start_s < ichdr_s->count);\r\nASSERT(start_d <= ichdr_d->count);\r\nASSERT(count <= ichdr_s->count);\r\nif (start_d < ichdr_d->count) {\r\ntmp = ichdr_d->count - start_d;\r\ntmp *= sizeof(xfs_attr_leaf_entry_t);\r\nentry_s = &xfs_attr3_leaf_entryp(leaf_d)[start_d];\r\nentry_d = &xfs_attr3_leaf_entryp(leaf_d)[start_d + count];\r\nmemmove(entry_d, entry_s, tmp);\r\n}\r\nentry_s = &xfs_attr3_leaf_entryp(leaf_s)[start_s];\r\nentry_d = &xfs_attr3_leaf_entryp(leaf_d)[start_d];\r\ndesti = start_d;\r\nfor (i = 0; i < count; entry_s++, entry_d++, desti++, i++) {\r\nASSERT(be16_to_cpu(entry_s->nameidx) >= ichdr_s->firstused);\r\ntmp = xfs_attr_leaf_entsize(leaf_s, start_s + i);\r\n#ifdef GROT\r\nif (entry_s->flags & XFS_ATTR_INCOMPLETE) {\r\nmemset(xfs_attr3_leaf_name(leaf_s, start_s + i), 0, tmp);\r\nichdr_s->usedbytes -= tmp;\r\nichdr_s->count -= 1;\r\nentry_d--;\r\ndesti--;\r\nif ((start_s + i) < offset)\r\nresult++;\r\n} else {\r\n#endif\r\nichdr_d->firstused -= tmp;\r\nentry_d->hashval = entry_s->hashval;\r\nentry_d->nameidx = cpu_to_be16(ichdr_d->firstused);\r\nentry_d->flags = entry_s->flags;\r\nASSERT(be16_to_cpu(entry_d->nameidx) + tmp\r\n<= args->geo->blksize);\r\nmemmove(xfs_attr3_leaf_name(leaf_d, desti),\r\nxfs_attr3_leaf_name(leaf_s, start_s + i), tmp);\r\nASSERT(be16_to_cpu(entry_s->nameidx) + tmp\r\n<= args->geo->blksize);\r\nmemset(xfs_attr3_leaf_name(leaf_s, start_s + i), 0, tmp);\r\nichdr_s->usedbytes -= tmp;\r\nichdr_d->usedbytes += tmp;\r\nichdr_s->count -= 1;\r\nichdr_d->count += 1;\r\ntmp = ichdr_d->count * sizeof(xfs_attr_leaf_entry_t)\r\n+ xfs_attr3_leaf_hdr_size(leaf_d);\r\nASSERT(ichdr_d->firstused >= tmp);\r\n#ifdef GROT\r\n}\r\n#endif\r\n}\r\nif (start_s == ichdr_s->count) {\r\ntmp = count * sizeof(xfs_attr_leaf_entry_t);\r\nentry_s = &xfs_attr3_leaf_entryp(leaf_s)[start_s];\r\nASSERT(((char *)entry_s + tmp) <=\r\n((char *)leaf_s + args->geo->blksize));\r\nmemset(entry_s, 0, tmp);\r\n} else {\r\ntmp = (ichdr_s->count - count) * sizeof(xfs_attr_leaf_entry_t);\r\nentry_s = &xfs_attr3_leaf_entryp(leaf_s)[start_s + count];\r\nentry_d = &xfs_attr3_leaf_entryp(leaf_s)[start_s];\r\nmemmove(entry_d, entry_s, tmp);\r\ntmp = count * sizeof(xfs_attr_leaf_entry_t);\r\nentry_s = &xfs_attr3_leaf_entryp(leaf_s)[ichdr_s->count];\r\nASSERT(((char *)entry_s + tmp) <=\r\n((char *)leaf_s + args->geo->blksize));\r\nmemset(entry_s, 0, tmp);\r\n}\r\nichdr_d->freemap[0].base = xfs_attr3_leaf_hdr_size(leaf_d);\r\nichdr_d->freemap[0].base += ichdr_d->count * sizeof(xfs_attr_leaf_entry_t);\r\nichdr_d->freemap[0].size = ichdr_d->firstused - ichdr_d->freemap[0].base;\r\nichdr_d->freemap[1].base = 0;\r\nichdr_d->freemap[2].base = 0;\r\nichdr_d->freemap[1].size = 0;\r\nichdr_d->freemap[2].size = 0;\r\nichdr_s->holes = 1;\r\n}\r\nxfs_dahash_t\r\nxfs_attr_leaf_lasthash(\r\nstruct xfs_buf *bp,\r\nint *count)\r\n{\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nstruct xfs_attr_leaf_entry *entries;\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nxfs_attr3_leaf_hdr_from_disk(mp->m_attr_geo, &ichdr, bp->b_addr);\r\nentries = xfs_attr3_leaf_entryp(bp->b_addr);\r\nif (count)\r\n*count = ichdr.count;\r\nif (!ichdr.count)\r\nreturn 0;\r\nreturn be32_to_cpu(entries[ichdr.count - 1].hashval);\r\n}\r\nSTATIC int\r\nxfs_attr_leaf_entsize(xfs_attr_leafblock_t *leaf, int index)\r\n{\r\nstruct xfs_attr_leaf_entry *entries;\r\nxfs_attr_leaf_name_local_t *name_loc;\r\nxfs_attr_leaf_name_remote_t *name_rmt;\r\nint size;\r\nentries = xfs_attr3_leaf_entryp(leaf);\r\nif (entries[index].flags & XFS_ATTR_LOCAL) {\r\nname_loc = xfs_attr3_leaf_name_local(leaf, index);\r\nsize = xfs_attr_leaf_entsize_local(name_loc->namelen,\r\nbe16_to_cpu(name_loc->valuelen));\r\n} else {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf, index);\r\nsize = xfs_attr_leaf_entsize_remote(name_rmt->namelen);\r\n}\r\nreturn size;\r\n}\r\nint\r\nxfs_attr_leaf_newentsize(\r\nstruct xfs_da_args *args,\r\nint *local)\r\n{\r\nint size;\r\nsize = xfs_attr_leaf_entsize_local(args->namelen, args->valuelen);\r\nif (size < xfs_attr_leaf_entsize_local_max(args->geo->blksize)) {\r\nif (local)\r\n*local = 1;\r\nreturn size;\r\n}\r\nif (local)\r\n*local = 0;\r\nreturn xfs_attr_leaf_entsize_remote(args->namelen);\r\n}\r\nint\r\nxfs_attr3_leaf_clearflag(\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr_leaf_entry *entry;\r\nstruct xfs_attr_leaf_name_remote *name_rmt;\r\nstruct xfs_buf *bp;\r\nint error;\r\n#ifdef DEBUG\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\nxfs_attr_leaf_name_local_t *name_loc;\r\nint namelen;\r\nchar *name;\r\n#endif\r\ntrace_xfs_attr_leaf_clearflag(args);\r\nerror = xfs_attr3_leaf_read(args->trans, args->dp, args->blkno, -1, &bp);\r\nif (error)\r\nreturn error;\r\nleaf = bp->b_addr;\r\nentry = &xfs_attr3_leaf_entryp(leaf)[args->index];\r\nASSERT(entry->flags & XFS_ATTR_INCOMPLETE);\r\n#ifdef DEBUG\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr, leaf);\r\nASSERT(args->index < ichdr.count);\r\nASSERT(args->index >= 0);\r\nif (entry->flags & XFS_ATTR_LOCAL) {\r\nname_loc = xfs_attr3_leaf_name_local(leaf, args->index);\r\nnamelen = name_loc->namelen;\r\nname = (char *)name_loc->nameval;\r\n} else {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf, args->index);\r\nnamelen = name_rmt->namelen;\r\nname = (char *)name_rmt->name;\r\n}\r\nASSERT(be32_to_cpu(entry->hashval) == args->hashval);\r\nASSERT(namelen == args->namelen);\r\nASSERT(memcmp(name, args->name, namelen) == 0);\r\n#endif\r\nentry->flags &= ~XFS_ATTR_INCOMPLETE;\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, entry, sizeof(*entry)));\r\nif (args->rmtblkno) {\r\nASSERT((entry->flags & XFS_ATTR_LOCAL) == 0);\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf, args->index);\r\nname_rmt->valueblk = cpu_to_be32(args->rmtblkno);\r\nname_rmt->valuelen = cpu_to_be32(args->rmtvaluelen);\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, name_rmt, sizeof(*name_rmt)));\r\n}\r\nreturn xfs_trans_roll(&args->trans, args->dp);\r\n}\r\nint\r\nxfs_attr3_leaf_setflag(\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf;\r\nstruct xfs_attr_leaf_entry *entry;\r\nstruct xfs_attr_leaf_name_remote *name_rmt;\r\nstruct xfs_buf *bp;\r\nint error;\r\n#ifdef DEBUG\r\nstruct xfs_attr3_icleaf_hdr ichdr;\r\n#endif\r\ntrace_xfs_attr_leaf_setflag(args);\r\nerror = xfs_attr3_leaf_read(args->trans, args->dp, args->blkno, -1, &bp);\r\nif (error)\r\nreturn error;\r\nleaf = bp->b_addr;\r\n#ifdef DEBUG\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr, leaf);\r\nASSERT(args->index < ichdr.count);\r\nASSERT(args->index >= 0);\r\n#endif\r\nentry = &xfs_attr3_leaf_entryp(leaf)[args->index];\r\nASSERT((entry->flags & XFS_ATTR_INCOMPLETE) == 0);\r\nentry->flags |= XFS_ATTR_INCOMPLETE;\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, entry, sizeof(*entry)));\r\nif ((entry->flags & XFS_ATTR_LOCAL) == 0) {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf, args->index);\r\nname_rmt->valueblk = 0;\r\nname_rmt->valuelen = 0;\r\nxfs_trans_log_buf(args->trans, bp,\r\nXFS_DA_LOGRANGE(leaf, name_rmt, sizeof(*name_rmt)));\r\n}\r\nreturn xfs_trans_roll(&args->trans, args->dp);\r\n}\r\nint\r\nxfs_attr3_leaf_flipflags(\r\nstruct xfs_da_args *args)\r\n{\r\nstruct xfs_attr_leafblock *leaf1;\r\nstruct xfs_attr_leafblock *leaf2;\r\nstruct xfs_attr_leaf_entry *entry1;\r\nstruct xfs_attr_leaf_entry *entry2;\r\nstruct xfs_attr_leaf_name_remote *name_rmt;\r\nstruct xfs_buf *bp1;\r\nstruct xfs_buf *bp2;\r\nint error;\r\n#ifdef DEBUG\r\nstruct xfs_attr3_icleaf_hdr ichdr1;\r\nstruct xfs_attr3_icleaf_hdr ichdr2;\r\nxfs_attr_leaf_name_local_t *name_loc;\r\nint namelen1, namelen2;\r\nchar *name1, *name2;\r\n#endif\r\ntrace_xfs_attr_leaf_flipflags(args);\r\nerror = xfs_attr3_leaf_read(args->trans, args->dp, args->blkno, -1, &bp1);\r\nif (error)\r\nreturn error;\r\nif (args->blkno2 != args->blkno) {\r\nerror = xfs_attr3_leaf_read(args->trans, args->dp, args->blkno2,\r\n-1, &bp2);\r\nif (error)\r\nreturn error;\r\n} else {\r\nbp2 = bp1;\r\n}\r\nleaf1 = bp1->b_addr;\r\nentry1 = &xfs_attr3_leaf_entryp(leaf1)[args->index];\r\nleaf2 = bp2->b_addr;\r\nentry2 = &xfs_attr3_leaf_entryp(leaf2)[args->index2];\r\n#ifdef DEBUG\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr1, leaf1);\r\nASSERT(args->index < ichdr1.count);\r\nASSERT(args->index >= 0);\r\nxfs_attr3_leaf_hdr_from_disk(args->geo, &ichdr2, leaf2);\r\nASSERT(args->index2 < ichdr2.count);\r\nASSERT(args->index2 >= 0);\r\nif (entry1->flags & XFS_ATTR_LOCAL) {\r\nname_loc = xfs_attr3_leaf_name_local(leaf1, args->index);\r\nnamelen1 = name_loc->namelen;\r\nname1 = (char *)name_loc->nameval;\r\n} else {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf1, args->index);\r\nnamelen1 = name_rmt->namelen;\r\nname1 = (char *)name_rmt->name;\r\n}\r\nif (entry2->flags & XFS_ATTR_LOCAL) {\r\nname_loc = xfs_attr3_leaf_name_local(leaf2, args->index2);\r\nnamelen2 = name_loc->namelen;\r\nname2 = (char *)name_loc->nameval;\r\n} else {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf2, args->index2);\r\nnamelen2 = name_rmt->namelen;\r\nname2 = (char *)name_rmt->name;\r\n}\r\nASSERT(be32_to_cpu(entry1->hashval) == be32_to_cpu(entry2->hashval));\r\nASSERT(namelen1 == namelen2);\r\nASSERT(memcmp(name1, name2, namelen1) == 0);\r\n#endif\r\nASSERT(entry1->flags & XFS_ATTR_INCOMPLETE);\r\nASSERT((entry2->flags & XFS_ATTR_INCOMPLETE) == 0);\r\nentry1->flags &= ~XFS_ATTR_INCOMPLETE;\r\nxfs_trans_log_buf(args->trans, bp1,\r\nXFS_DA_LOGRANGE(leaf1, entry1, sizeof(*entry1)));\r\nif (args->rmtblkno) {\r\nASSERT((entry1->flags & XFS_ATTR_LOCAL) == 0);\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf1, args->index);\r\nname_rmt->valueblk = cpu_to_be32(args->rmtblkno);\r\nname_rmt->valuelen = cpu_to_be32(args->rmtvaluelen);\r\nxfs_trans_log_buf(args->trans, bp1,\r\nXFS_DA_LOGRANGE(leaf1, name_rmt, sizeof(*name_rmt)));\r\n}\r\nentry2->flags |= XFS_ATTR_INCOMPLETE;\r\nxfs_trans_log_buf(args->trans, bp2,\r\nXFS_DA_LOGRANGE(leaf2, entry2, sizeof(*entry2)));\r\nif ((entry2->flags & XFS_ATTR_LOCAL) == 0) {\r\nname_rmt = xfs_attr3_leaf_name_remote(leaf2, args->index2);\r\nname_rmt->valueblk = 0;\r\nname_rmt->valuelen = 0;\r\nxfs_trans_log_buf(args->trans, bp2,\r\nXFS_DA_LOGRANGE(leaf2, name_rmt, sizeof(*name_rmt)));\r\n}\r\nerror = xfs_trans_roll(&args->trans, args->dp);\r\nreturn error;\r\n}

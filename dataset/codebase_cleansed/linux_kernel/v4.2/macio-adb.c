int macio_probe(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, "adb", "chrp,adb0");\r\nif (np) {\r\nof_node_put(np);\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint macio_init(void)\r\n{\r\nstruct device_node *adbs;\r\nstruct resource r;\r\nunsigned int irq;\r\nadbs = of_find_compatible_node(NULL, "adb", "chrp,adb0");\r\nif (adbs == 0)\r\nreturn -ENXIO;\r\nif (of_address_to_resource(adbs, 0, &r)) {\r\nof_node_put(adbs);\r\nreturn -ENXIO;\r\n}\r\nadb = ioremap(r.start, sizeof(struct adb_regs));\r\nout_8(&adb->ctrl.r, 0);\r\nout_8(&adb->intr.r, 0);\r\nout_8(&adb->error.r, 0);\r\nout_8(&adb->active_hi.r, 0xff);\r\nout_8(&adb->active_lo.r, 0xff);\r\nout_8(&adb->autopoll.r, APE);\r\nirq = irq_of_parse_and_map(adbs, 0);\r\nof_node_put(adbs);\r\nif (request_irq(irq, macio_adb_interrupt, 0, "ADB", (void *)0)) {\r\nprintk(KERN_ERR "ADB: can't get irq %d\n", irq);\r\nreturn -EAGAIN;\r\n}\r\nout_8(&adb->intr_enb.r, DFB | TAG);\r\nprintk("adb: mac-io driver 1.0 for unified ADB\n");\r\nreturn 0;\r\n}\r\nstatic int macio_adb_autopoll(int devs)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&macio_lock, flags);\r\nout_8(&adb->active_hi.r, devs >> 8);\r\nout_8(&adb->active_lo.r, devs);\r\nout_8(&adb->autopoll.r, devs? APE: 0);\r\nspin_unlock_irqrestore(&macio_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int macio_adb_reset_bus(void)\r\n{\r\nunsigned long flags;\r\nint timeout = 1000000;\r\nspin_lock_irqsave(&macio_lock, flags);\r\nout_8(&adb->ctrl.r, in_8(&adb->ctrl.r) | ADB_RST);\r\nwhile ((in_8(&adb->ctrl.r) & ADB_RST) != 0) {\r\nif (--timeout == 0) {\r\nout_8(&adb->ctrl.r, in_8(&adb->ctrl.r) & ~ADB_RST);\r\nspin_unlock_irqrestore(&macio_lock, flags);\r\nreturn -1;\r\n}\r\n}\r\nspin_unlock_irqrestore(&macio_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int macio_send_request(struct adb_request *req, int sync)\r\n{\r\nunsigned long flags;\r\nint i;\r\nif (req->data[0] != ADB_PACKET)\r\nreturn -EINVAL;\r\nfor (i = 0; i < req->nbytes - 1; ++i)\r\nreq->data[i] = req->data[i+1];\r\n--req->nbytes;\r\nreq->next = NULL;\r\nreq->sent = 0;\r\nreq->complete = 0;\r\nreq->reply_len = 0;\r\nspin_lock_irqsave(&macio_lock, flags);\r\nif (current_req != 0) {\r\nlast_req->next = req;\r\nlast_req = req;\r\n} else {\r\ncurrent_req = last_req = req;\r\nout_8(&adb->ctrl.r, in_8(&adb->ctrl.r) | TAR);\r\n}\r\nspin_unlock_irqrestore(&macio_lock, flags);\r\nif (sync) {\r\nwhile (!req->complete)\r\nmacio_adb_poll();\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t macio_adb_interrupt(int irq, void *arg)\r\n{\r\nint i, n, err;\r\nstruct adb_request *req = NULL;\r\nunsigned char ibuf[16];\r\nint ibuf_len = 0;\r\nint complete = 0;\r\nint autopoll = 0;\r\nint handled = 0;\r\nspin_lock(&macio_lock);\r\nif (in_8(&adb->intr.r) & TAG) {\r\nhandled = 1;\r\nif ((req = current_req) != 0) {\r\nfor (i = 0; i < req->nbytes; ++i)\r\nout_8(&adb->data[i].r, req->data[i]);\r\nout_8(&adb->dcount.r, req->nbytes & HMB);\r\nreq->sent = 1;\r\nif (req->reply_expected) {\r\nout_8(&adb->ctrl.r, DTB + CRE);\r\n} else {\r\nout_8(&adb->ctrl.r, DTB);\r\ncurrent_req = req->next;\r\ncomplete = 1;\r\nif (current_req)\r\nout_8(&adb->ctrl.r, in_8(&adb->ctrl.r) | TAR);\r\n}\r\n}\r\nout_8(&adb->intr.r, 0);\r\n}\r\nif (in_8(&adb->intr.r) & DFB) {\r\nhandled = 1;\r\nerr = in_8(&adb->error.r);\r\nif (current_req && current_req->sent) {\r\nreq = current_req;\r\nif (err == 0) {\r\nreq->reply_len = in_8(&adb->dcount.r) & HMB;\r\nfor (i = 0; i < req->reply_len; ++i)\r\nreq->reply[i] = in_8(&adb->data[i].r);\r\n}\r\ncurrent_req = req->next;\r\ncomplete = 1;\r\nif (current_req)\r\nout_8(&adb->ctrl.r, in_8(&adb->ctrl.r) | TAR);\r\n} else if (err == 0) {\r\nn = in_8(&adb->dcount.r) & HMB;\r\nfor (i = 0; i < n; ++i)\r\nibuf[i] = in_8(&adb->data[i].r);\r\nibuf_len = n;\r\nautopoll = (in_8(&adb->dcount.r) & APD) != 0;\r\n}\r\nout_8(&adb->error.r, 0);\r\nout_8(&adb->intr.r, 0);\r\n}\r\nspin_unlock(&macio_lock);\r\nif (complete && req) {\r\nvoid (*done)(struct adb_request *) = req->done;\r\nmb();\r\nreq->complete = 1;\r\nif (done)\r\n(*done)(req);\r\n}\r\nif (ibuf_len)\r\nadb_input(ibuf, ibuf_len, autopoll);\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic void macio_adb_poll(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (in_8(&adb->intr.r) != 0)\r\nmacio_adb_interrupt(0, NULL);\r\nlocal_irq_restore(flags);\r\n}

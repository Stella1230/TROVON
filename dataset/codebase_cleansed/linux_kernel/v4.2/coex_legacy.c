static int iwl_send_bt_prio_tbl(struct iwl_mvm *mvm)\r\n{\r\nif (unlikely(mvm->bt_force_ant_mode != BT_FORCE_ANT_DIS))\r\nreturn 0;\r\nreturn iwl_mvm_send_cmd_pdu(mvm, BT_COEX_PRIO_TABLE, 0,\r\nsizeof(struct iwl_bt_coex_prio_tbl_cmd),\r\n&iwl_bt_prio_tbl);\r\n}\r\nstatic enum iwl_bt_coex_lut_type\r\niwl_get_coex_type(struct iwl_mvm *mvm, const struct ieee80211_vif *vif)\r\n{\r\nstruct ieee80211_chanctx_conf *chanctx_conf;\r\nenum iwl_bt_coex_lut_type ret;\r\nu16 phy_ctx_id;\r\nrcu_read_lock();\r\nchanctx_conf = rcu_dereference(vif->chanctx_conf);\r\nif (!chanctx_conf ||\r\nchanctx_conf->def.chan->band != IEEE80211_BAND_2GHZ) {\r\nrcu_read_unlock();\r\nreturn BT_COEX_INVALID_LUT;\r\n}\r\nret = BT_COEX_TX_DIS_LUT;\r\nif (mvm->cfg->bt_shared_single_ant) {\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nphy_ctx_id = *((u16 *)chanctx_conf->drv_priv);\r\nif (mvm->last_bt_ci_cmd_old.primary_ch_phy_id == phy_ctx_id)\r\nret = le32_to_cpu(mvm->last_bt_notif_old.primary_ch_lut);\r\nelse if (mvm->last_bt_ci_cmd_old.secondary_ch_phy_id == phy_ctx_id)\r\nret = le32_to_cpu(mvm->last_bt_notif_old.secondary_ch_lut);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nint iwl_send_bt_init_conf_old(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_bt_coex_cmd_old *bt_cmd;\r\nstruct iwl_host_cmd cmd = {\r\n.id = BT_CONFIG,\r\n.len = { sizeof(*bt_cmd), },\r\n.dataflags = { IWL_HCMD_DFL_NOCOPY, },\r\n};\r\nint ret;\r\nu32 flags;\r\nret = iwl_send_bt_prio_tbl(mvm);\r\nif (ret)\r\nreturn ret;\r\nbt_cmd = kzalloc(sizeof(*bt_cmd), GFP_KERNEL);\r\nif (!bt_cmd)\r\nreturn -ENOMEM;\r\ncmd.data[0] = bt_cmd;\r\nlockdep_assert_held(&mvm->mutex);\r\nif (unlikely(mvm->bt_force_ant_mode != BT_FORCE_ANT_DIS)) {\r\nswitch (mvm->bt_force_ant_mode) {\r\ncase BT_FORCE_ANT_AUTO:\r\nflags = BT_COEX_AUTO_OLD;\r\nbreak;\r\ncase BT_FORCE_ANT_BT:\r\nflags = BT_COEX_BT_OLD;\r\nbreak;\r\ncase BT_FORCE_ANT_WIFI:\r\nflags = BT_COEX_WIFI_OLD;\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\nflags = 0;\r\n}\r\nbt_cmd->flags = cpu_to_le32(flags);\r\nbt_cmd->valid_bit_msk = cpu_to_le32(BT_VALID_ENABLE);\r\ngoto send_cmd;\r\n}\r\nbt_cmd->max_kill = 5;\r\nbt_cmd->bt4_antenna_isolation_thr =\r\nIWL_MVM_BT_COEX_ANTENNA_COUPLING_THRS;\r\nbt_cmd->bt4_antenna_isolation = iwlwifi_mod_params.ant_coupling;\r\nbt_cmd->bt4_tx_tx_delta_freq_thr = 15;\r\nbt_cmd->bt4_tx_rx_max_freq0 = 15;\r\nbt_cmd->override_primary_lut = BT_COEX_INVALID_LUT;\r\nbt_cmd->override_secondary_lut = BT_COEX_INVALID_LUT;\r\nflags = iwlwifi_mod_params.bt_coex_active ?\r\nBT_COEX_NW_OLD : BT_COEX_DISABLE_OLD;\r\nbt_cmd->flags = cpu_to_le32(flags);\r\nbt_cmd->valid_bit_msk = cpu_to_le32(BT_VALID_ENABLE |\r\nBT_VALID_BT_PRIO_BOOST |\r\nBT_VALID_MAX_KILL |\r\nBT_VALID_3W_TMRS |\r\nBT_VALID_KILL_ACK |\r\nBT_VALID_KILL_CTS |\r\nBT_VALID_REDUCED_TX_POWER |\r\nBT_VALID_LUT |\r\nBT_VALID_WIFI_RX_SW_PRIO_BOOST |\r\nBT_VALID_WIFI_TX_SW_PRIO_BOOST |\r\nBT_VALID_ANT_ISOLATION |\r\nBT_VALID_ANT_ISOLATION_THRS |\r\nBT_VALID_TXTX_DELTA_FREQ_THRS |\r\nBT_VALID_TXRX_MAX_FREQ_0 |\r\nBT_VALID_SYNC_TO_SCO |\r\nBT_VALID_TTC |\r\nBT_VALID_RRC);\r\nif (IWL_MVM_BT_COEX_SYNC2SCO)\r\nbt_cmd->flags |= cpu_to_le32(BT_COEX_SYNC2SCO);\r\nif (iwl_mvm_bt_is_plcr_supported(mvm)) {\r\nbt_cmd->valid_bit_msk |= cpu_to_le32(BT_VALID_CORUN_LUT_20 |\r\nBT_VALID_CORUN_LUT_40);\r\nbt_cmd->flags |= cpu_to_le32(BT_COEX_CORUNNING);\r\n}\r\nif (IWL_MVM_BT_COEX_MPLUT) {\r\nbt_cmd->flags |= cpu_to_le32(BT_COEX_MPLUT);\r\nbt_cmd->valid_bit_msk |= cpu_to_le32(BT_VALID_MULTI_PRIO_LUT);\r\n}\r\nif (IWL_MVM_BT_COEX_TTC)\r\nbt_cmd->flags |= cpu_to_le32(BT_COEX_TTC);\r\nif (iwl_mvm_bt_is_rrc_supported(mvm))\r\nbt_cmd->flags |= cpu_to_le32(BT_COEX_RRC);\r\nif (mvm->cfg->bt_shared_single_ant)\r\nmemcpy(&bt_cmd->decision_lut, iwl_single_shared_ant,\r\nsizeof(iwl_single_shared_ant));\r\nelse\r\nmemcpy(&bt_cmd->decision_lut, iwl_combined_lookup,\r\nsizeof(iwl_combined_lookup));\r\nmemcpy(bt_cmd->bt4_corun_lut20, antenna_coupling_ranges[0].lut20,\r\nsizeof(bt_cmd->bt4_corun_lut20));\r\nmemcpy(bt_cmd->bt4_corun_lut40, antenna_coupling_ranges[0].lut20,\r\nsizeof(bt_cmd->bt4_corun_lut40));\r\nmemcpy(&bt_cmd->bt_prio_boost, iwl_bt_prio_boost,\r\nsizeof(iwl_bt_prio_boost));\r\nbt_cmd->bt4_multiprio_lut[0] = cpu_to_le32(IWL_MVM_BT_COEX_MPLUT_REG0);\r\nbt_cmd->bt4_multiprio_lut[1] = cpu_to_le32(IWL_MVM_BT_COEX_MPLUT_REG1);\r\nsend_cmd:\r\nmemset(&mvm->last_bt_notif_old, 0, sizeof(mvm->last_bt_notif_old));\r\nmemset(&mvm->last_bt_ci_cmd_old, 0, sizeof(mvm->last_bt_ci_cmd_old));\r\nret = iwl_mvm_send_cmd(mvm, &cmd);\r\nkfree(bt_cmd);\r\nreturn ret;\r\n}\r\nstatic int iwl_mvm_bt_udpate_ctrl_kill_msk(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_bt_coex_profile_notif_old *notif = &mvm->last_bt_notif_old;\r\nu32 primary_lut = le32_to_cpu(notif->primary_ch_lut);\r\nu32 ag = le32_to_cpu(notif->bt_activity_grading);\r\nstruct iwl_bt_coex_cmd_old *bt_cmd;\r\nu8 ack_kill_msk, cts_kill_msk;\r\nstruct iwl_host_cmd cmd = {\r\n.id = BT_CONFIG,\r\n.data[0] = &bt_cmd,\r\n.len = { sizeof(*bt_cmd), },\r\n.dataflags = { IWL_HCMD_DFL_NOCOPY, },\r\n};\r\nint ret = 0;\r\nlockdep_assert_held(&mvm->mutex);\r\nack_kill_msk = iwl_bt_ack_kill_msk[ag][primary_lut];\r\ncts_kill_msk = iwl_bt_cts_kill_msk[ag][primary_lut];\r\nif (mvm->bt_ack_kill_msk[0] == ack_kill_msk &&\r\nmvm->bt_cts_kill_msk[0] == cts_kill_msk)\r\nreturn 0;\r\nmvm->bt_ack_kill_msk[0] = ack_kill_msk;\r\nmvm->bt_cts_kill_msk[0] = cts_kill_msk;\r\nbt_cmd = kzalloc(sizeof(*bt_cmd), GFP_KERNEL);\r\nif (!bt_cmd)\r\nreturn -ENOMEM;\r\ncmd.data[0] = bt_cmd;\r\nbt_cmd->flags = cpu_to_le32(BT_COEX_NW_OLD);\r\nbt_cmd->kill_ack_msk = cpu_to_le32(iwl_bt_ctl_kill_msk[ack_kill_msk]);\r\nbt_cmd->kill_cts_msk = cpu_to_le32(iwl_bt_ctl_kill_msk[cts_kill_msk]);\r\nbt_cmd->valid_bit_msk |= cpu_to_le32(BT_VALID_ENABLE |\r\nBT_VALID_KILL_ACK |\r\nBT_VALID_KILL_CTS);\r\nret = iwl_mvm_send_cmd(mvm, &cmd);\r\nkfree(bt_cmd);\r\nreturn ret;\r\n}\r\nstatic int iwl_mvm_bt_coex_reduced_txp(struct iwl_mvm *mvm, u8 sta_id,\r\nbool enable)\r\n{\r\nstruct iwl_bt_coex_cmd_old *bt_cmd;\r\nstruct iwl_host_cmd cmd = {\r\n.id = BT_CONFIG,\r\n.len = { sizeof(*bt_cmd), },\r\n.dataflags = { IWL_HCMD_DFL_DUP, },\r\n.flags = CMD_ASYNC,\r\n};\r\nstruct iwl_mvm_sta *mvmsta;\r\nint ret;\r\nmvmsta = iwl_mvm_sta_from_staid_protected(mvm, sta_id);\r\nif (!mvmsta)\r\nreturn 0;\r\nif (mvmsta->bt_reduced_txpower == enable)\r\nreturn 0;\r\nbt_cmd = kzalloc(sizeof(*bt_cmd), GFP_ATOMIC);\r\nif (!bt_cmd)\r\nreturn -ENOMEM;\r\ncmd.data[0] = bt_cmd;\r\nbt_cmd->flags = cpu_to_le32(BT_COEX_NW_OLD);\r\nbt_cmd->valid_bit_msk =\r\ncpu_to_le32(BT_VALID_ENABLE | BT_VALID_REDUCED_TX_POWER);\r\nbt_cmd->bt_reduced_tx_power = sta_id;\r\nif (enable)\r\nbt_cmd->bt_reduced_tx_power |= BT_REDUCED_TX_POWER_BIT;\r\nIWL_DEBUG_COEX(mvm, "%sable reduced Tx Power for sta %d\n",\r\nenable ? "en" : "dis", sta_id);\r\nmvmsta->bt_reduced_txpower = enable;\r\nret = iwl_mvm_send_cmd(mvm, &cmd);\r\nkfree(bt_cmd);\r\nreturn ret;\r\n}\r\nstatic inline\r\nvoid iwl_mvm_bt_coex_enable_rssi_event(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nbool enable, int rssi)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nmvmvif->bf_data.last_bt_coex_event = rssi;\r\nmvmvif->bf_data.bt_coex_max_thold =\r\nenable ? -IWL_MVM_BT_COEX_EN_RED_TXP_THRESH : 0;\r\nmvmvif->bf_data.bt_coex_min_thold =\r\nenable ? -IWL_MVM_BT_COEX_DIS_RED_TXP_THRESH : 0;\r\n}\r\nstatic void iwl_mvm_bt_notif_iterator(void *_data, u8 *mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_bt_iterator_data *data = _data;\r\nstruct iwl_mvm *mvm = data->mvm;\r\nstruct ieee80211_chanctx_conf *chanctx_conf;\r\nenum ieee80211_smps_mode smps_mode;\r\nu32 bt_activity_grading;\r\nint ave_rssi;\r\nlockdep_assert_held(&mvm->mutex);\r\nswitch (vif->type) {\r\ncase NL80211_IFTYPE_STATION:\r\nsmps_mode = IEEE80211_SMPS_AUTOMATIC;\r\nbreak;\r\ncase NL80211_IFTYPE_AP:\r\nif (!mvmvif->ap_ibss_active)\r\nreturn;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nchanctx_conf = rcu_dereference(vif->chanctx_conf);\r\nif ((!chanctx_conf ||\r\nchanctx_conf->def.chan->band != IEEE80211_BAND_2GHZ)) {\r\nif (vif->type == NL80211_IFTYPE_STATION) {\r\niwl_mvm_update_smps(mvm, vif, IWL_MVM_SMPS_REQ_BT_COEX,\r\nsmps_mode);\r\niwl_mvm_bt_coex_reduced_txp(mvm, mvmvif->ap_sta_id,\r\nfalse);\r\niwl_mvm_bt_coex_enable_rssi_event(mvm, vif, false, 0);\r\n}\r\nreturn;\r\n}\r\nbt_activity_grading = le32_to_cpu(data->notif->bt_activity_grading);\r\nif (bt_activity_grading >= BT_HIGH_TRAFFIC)\r\nsmps_mode = IEEE80211_SMPS_STATIC;\r\nelse if (bt_activity_grading >= BT_LOW_TRAFFIC)\r\nsmps_mode = vif->type == NL80211_IFTYPE_AP ?\r\nIEEE80211_SMPS_OFF :\r\nIEEE80211_SMPS_DYNAMIC;\r\nif (!vif->bss_conf.assoc)\r\nsmps_mode = IEEE80211_SMPS_AUTOMATIC;\r\nif (mvmvif->phy_ctxt &&\r\ndata->notif->rrc_enabled & BIT(mvmvif->phy_ctxt->id))\r\nsmps_mode = IEEE80211_SMPS_AUTOMATIC;\r\nIWL_DEBUG_COEX(data->mvm,\r\n"mac %d: bt_status %d bt_activity_grading %d smps_req %d\n",\r\nmvmvif->id, data->notif->bt_status, bt_activity_grading,\r\nsmps_mode);\r\nif (vif->type == NL80211_IFTYPE_STATION)\r\niwl_mvm_update_smps(mvm, vif, IWL_MVM_SMPS_REQ_BT_COEX,\r\nsmps_mode);\r\nif (iwl_mvm_vif_low_latency(mvmvif)) {\r\ndata->primary_ll = true;\r\ndata->secondary = data->primary;\r\ndata->primary = chanctx_conf;\r\n}\r\nif (vif->type == NL80211_IFTYPE_AP) {\r\nif (!mvmvif->ap_ibss_active)\r\nreturn;\r\nif (chanctx_conf == data->primary)\r\nreturn;\r\nif (!data->primary_ll) {\r\ndata->secondary = data->primary;\r\ndata->primary = chanctx_conf;\r\n} else {\r\ndata->secondary = chanctx_conf;\r\n}\r\nreturn;\r\n}\r\nif (!data->primary || data->primary == chanctx_conf)\r\ndata->primary = chanctx_conf;\r\nelse if (!data->secondary)\r\ndata->secondary = chanctx_conf;\r\nif (iwl_get_coex_type(mvm, vif) == BT_COEX_LOOSE_LUT ||\r\nmvm->cfg->bt_shared_single_ant || !vif->bss_conf.assoc ||\r\n!data->notif->bt_status) {\r\niwl_mvm_bt_coex_reduced_txp(mvm, mvmvif->ap_sta_id, false);\r\niwl_mvm_bt_coex_enable_rssi_event(mvm, vif, false, 0);\r\nreturn;\r\n}\r\nave_rssi = mvmvif->bf_data.ave_beacon_signal;\r\nif (!ave_rssi)\r\nave_rssi = -100;\r\nif (ave_rssi > -IWL_MVM_BT_COEX_EN_RED_TXP_THRESH) {\r\nif (iwl_mvm_bt_coex_reduced_txp(mvm, mvmvif->ap_sta_id, true))\r\nIWL_ERR(mvm, "Couldn't send BT_CONFIG cmd\n");\r\n} else if (ave_rssi < -IWL_MVM_BT_COEX_DIS_RED_TXP_THRESH) {\r\nif (iwl_mvm_bt_coex_reduced_txp(mvm, mvmvif->ap_sta_id, false))\r\nIWL_ERR(mvm, "Couldn't send BT_CONFIG cmd\n");\r\n}\r\niwl_mvm_bt_coex_enable_rssi_event(mvm, vif, true, ave_rssi);\r\n}\r\nstatic void iwl_mvm_bt_coex_notif_handle(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_bt_iterator_data data = {\r\n.mvm = mvm,\r\n.notif = &mvm->last_bt_notif_old,\r\n};\r\nstruct iwl_bt_coex_ci_cmd_old cmd = {};\r\nu8 ci_bw_idx;\r\nif (unlikely(mvm->bt_force_ant_mode != BT_FORCE_ANT_DIS))\r\nreturn;\r\nrcu_read_lock();\r\nieee80211_iterate_active_interfaces_atomic(\r\nmvm->hw, IEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_bt_notif_iterator, &data);\r\nif (data.primary) {\r\nstruct ieee80211_chanctx_conf *chan = data.primary;\r\nif (WARN_ON(!chan->def.chan)) {\r\nrcu_read_unlock();\r\nreturn;\r\n}\r\nif (chan->def.width < NL80211_CHAN_WIDTH_40) {\r\nci_bw_idx = 0;\r\ncmd.co_run_bw_primary = 0;\r\n} else {\r\ncmd.co_run_bw_primary = 1;\r\nif (chan->def.center_freq1 >\r\nchan->def.chan->center_freq)\r\nci_bw_idx = 2;\r\nelse\r\nci_bw_idx = 1;\r\n}\r\ncmd.bt_primary_ci =\r\niwl_ci_mask[chan->def.chan->hw_value][ci_bw_idx];\r\ncmd.primary_ch_phy_id = *((u16 *)data.primary->drv_priv);\r\n}\r\nif (data.secondary) {\r\nstruct ieee80211_chanctx_conf *chan = data.secondary;\r\nif (WARN_ON(!data.secondary->def.chan)) {\r\nrcu_read_unlock();\r\nreturn;\r\n}\r\nif (chan->def.width < NL80211_CHAN_WIDTH_40) {\r\nci_bw_idx = 0;\r\ncmd.co_run_bw_secondary = 0;\r\n} else {\r\ncmd.co_run_bw_secondary = 1;\r\nif (chan->def.center_freq1 >\r\nchan->def.chan->center_freq)\r\nci_bw_idx = 2;\r\nelse\r\nci_bw_idx = 1;\r\n}\r\ncmd.bt_secondary_ci =\r\niwl_ci_mask[chan->def.chan->hw_value][ci_bw_idx];\r\ncmd.secondary_ch_phy_id = *((u16 *)data.secondary->drv_priv);\r\n}\r\nrcu_read_unlock();\r\nif (memcmp(&cmd, &mvm->last_bt_ci_cmd_old, sizeof(cmd))) {\r\nif (iwl_mvm_send_cmd_pdu(mvm, BT_COEX_CI, 0,\r\nsizeof(cmd), &cmd))\r\nIWL_ERR(mvm, "Failed to send BT_CI cmd\n");\r\nmemcpy(&mvm->last_bt_ci_cmd_old, &cmd, sizeof(cmd));\r\n}\r\nif (iwl_mvm_bt_udpate_ctrl_kill_msk(mvm))\r\nIWL_ERR(mvm, "Failed to update the ctrl_kill_msk\n");\r\n}\r\nint iwl_mvm_rx_bt_coex_notif_old(struct iwl_mvm *mvm,\r\nstruct iwl_rx_cmd_buffer *rxb,\r\nstruct iwl_device_cmd *dev_cmd)\r\n{\r\nstruct iwl_rx_packet *pkt = rxb_addr(rxb);\r\nstruct iwl_bt_coex_profile_notif_old *notif = (void *)pkt->data;\r\nIWL_DEBUG_COEX(mvm, "BT Coex Notification received\n");\r\nIWL_DEBUG_COEX(mvm, "\tBT status: %s\n",\r\nnotif->bt_status ? "ON" : "OFF");\r\nIWL_DEBUG_COEX(mvm, "\tBT open conn %d\n", notif->bt_open_conn);\r\nIWL_DEBUG_COEX(mvm, "\tBT ci compliance %d\n", notif->bt_ci_compliance);\r\nIWL_DEBUG_COEX(mvm, "\tBT primary_ch_lut %d\n",\r\nle32_to_cpu(notif->primary_ch_lut));\r\nIWL_DEBUG_COEX(mvm, "\tBT secondary_ch_lut %d\n",\r\nle32_to_cpu(notif->secondary_ch_lut));\r\nIWL_DEBUG_COEX(mvm, "\tBT activity grading %d\n",\r\nle32_to_cpu(notif->bt_activity_grading));\r\nIWL_DEBUG_COEX(mvm, "\tBT agg traffic load %d\n",\r\nnotif->bt_agg_traffic_load);\r\nmemcpy(&mvm->last_bt_notif_old, notif, sizeof(mvm->last_bt_notif_old));\r\niwl_mvm_bt_coex_notif_handle(mvm);\r\nreturn 0;\r\n}\r\nstatic void iwl_mvm_bt_rssi_iterator(void *_data, u8 *mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_bt_iterator_data *data = _data;\r\nstruct iwl_mvm *mvm = data->mvm;\r\nstruct ieee80211_sta *sta;\r\nstruct iwl_mvm_sta *mvmsta;\r\nstruct ieee80211_chanctx_conf *chanctx_conf;\r\nrcu_read_lock();\r\nchanctx_conf = rcu_dereference(vif->chanctx_conf);\r\nif (!chanctx_conf ||\r\nchanctx_conf->def.chan->band != IEEE80211_BAND_2GHZ) {\r\nrcu_read_unlock();\r\nreturn;\r\n}\r\nrcu_read_unlock();\r\nif (vif->type != NL80211_IFTYPE_STATION ||\r\nmvmvif->ap_sta_id == IWL_MVM_STATION_COUNT)\r\nreturn;\r\nsta = rcu_dereference_protected(mvm->fw_id_to_mac_id[mvmvif->ap_sta_id],\r\nlockdep_is_held(&mvm->mutex));\r\nif (IS_ERR_OR_NULL(sta))\r\nreturn;\r\nmvmsta = iwl_mvm_sta_from_mac80211(sta);\r\n}\r\nvoid iwl_mvm_bt_rssi_event_old(struct iwl_mvm *mvm, struct ieee80211_vif *vif,\r\nenum ieee80211_rssi_event_data rssi_event)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_bt_iterator_data data = {\r\n.mvm = mvm,\r\n};\r\nint ret;\r\nlockdep_assert_held(&mvm->mutex);\r\nif (unlikely(mvm->bt_force_ant_mode != BT_FORCE_ANT_DIS))\r\nreturn;\r\nif (mvmvif->ap_sta_id == IWL_MVM_STATION_COUNT)\r\nreturn;\r\nif (!mvm->last_bt_notif_old.bt_status)\r\nreturn;\r\nIWL_DEBUG_COEX(mvm, "RSSI for %pM is now %s\n", vif->bss_conf.bssid,\r\nrssi_event == RSSI_EVENT_HIGH ? "HIGH" : "LOW");\r\nif (rssi_event == RSSI_EVENT_LOW || mvm->cfg->bt_shared_single_ant ||\r\niwl_get_coex_type(mvm, vif) == BT_COEX_LOOSE_LUT)\r\nret = iwl_mvm_bt_coex_reduced_txp(mvm, mvmvif->ap_sta_id,\r\nfalse);\r\nelse\r\nret = iwl_mvm_bt_coex_reduced_txp(mvm, mvmvif->ap_sta_id, true);\r\nif (ret)\r\nIWL_ERR(mvm, "couldn't send BT_CONFIG HCMD upon RSSI event\n");\r\nieee80211_iterate_active_interfaces_atomic(\r\nmvm->hw, IEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_bt_rssi_iterator, &data);\r\nif (iwl_mvm_bt_udpate_ctrl_kill_msk(mvm))\r\nIWL_ERR(mvm, "Failed to update the ctrl_kill_msk\n");\r\n}\r\nu16 iwl_mvm_coex_agg_time_limit_old(struct iwl_mvm *mvm,\r\nstruct ieee80211_sta *sta)\r\n{\r\nstruct iwl_mvm_sta *mvmsta = iwl_mvm_sta_from_mac80211(sta);\r\nenum iwl_bt_coex_lut_type lut_type;\r\nif (le32_to_cpu(mvm->last_bt_notif_old.bt_activity_grading) <\r\nBT_HIGH_TRAFFIC)\r\nreturn LINK_QUAL_AGG_TIME_LIMIT_DEF;\r\nif (mvm->last_bt_notif_old.ttc_enabled)\r\nreturn LINK_QUAL_AGG_TIME_LIMIT_DEF;\r\nlut_type = iwl_get_coex_type(mvm, mvmsta->vif);\r\nif (lut_type == BT_COEX_LOOSE_LUT || lut_type == BT_COEX_INVALID_LUT)\r\nreturn LINK_QUAL_AGG_TIME_LIMIT_DEF;\r\nreturn LINK_QUAL_AGG_TIME_LIMIT_BT_ACT;\r\n}\r\nbool iwl_mvm_bt_coex_is_mimo_allowed_old(struct iwl_mvm *mvm,\r\nstruct ieee80211_sta *sta)\r\n{\r\nstruct iwl_mvm_sta *mvmsta = iwl_mvm_sta_from_mac80211(sta);\r\nenum iwl_bt_coex_lut_type lut_type;\r\nif (mvm->last_bt_notif_old.ttc_enabled)\r\nreturn true;\r\nif (le32_to_cpu(mvm->last_bt_notif_old.bt_activity_grading) <\r\nBT_HIGH_TRAFFIC)\r\nreturn true;\r\nlut_type = iwl_get_coex_type(mvm, mvmsta->vif);\r\nreturn lut_type != BT_COEX_LOOSE_LUT;\r\n}\r\nbool iwl_mvm_bt_coex_is_shared_ant_avail_old(struct iwl_mvm *mvm)\r\n{\r\nu32 ag = le32_to_cpu(mvm->last_bt_notif_old.bt_activity_grading);\r\nreturn ag < BT_HIGH_TRAFFIC;\r\n}\r\nbool iwl_mvm_bt_coex_is_tpc_allowed_old(struct iwl_mvm *mvm,\r\nenum ieee80211_band band)\r\n{\r\nu32 bt_activity =\r\nle32_to_cpu(mvm->last_bt_notif_old.bt_activity_grading);\r\nif (band != IEEE80211_BAND_2GHZ)\r\nreturn false;\r\nreturn bt_activity >= BT_LOW_TRAFFIC;\r\n}\r\nvoid iwl_mvm_bt_coex_vif_change_old(struct iwl_mvm *mvm)\r\n{\r\niwl_mvm_bt_coex_notif_handle(mvm);\r\n}\r\nint iwl_mvm_rx_ant_coupling_notif_old(struct iwl_mvm *mvm,\r\nstruct iwl_rx_cmd_buffer *rxb,\r\nstruct iwl_device_cmd *dev_cmd)\r\n{\r\nstruct iwl_rx_packet *pkt = rxb_addr(rxb);\r\nu32 ant_isolation = le32_to_cpup((void *)pkt->data);\r\nu8 __maybe_unused lower_bound, upper_bound;\r\nint ret;\r\nu8 lut;\r\nstruct iwl_bt_coex_cmd_old *bt_cmd;\r\nstruct iwl_host_cmd cmd = {\r\n.id = BT_CONFIG,\r\n.len = { sizeof(*bt_cmd), },\r\n.dataflags = { IWL_HCMD_DFL_NOCOPY, },\r\n};\r\nif (!iwl_mvm_bt_is_plcr_supported(mvm))\r\nreturn 0;\r\nlockdep_assert_held(&mvm->mutex);\r\nif (unlikely(mvm->bt_force_ant_mode != BT_FORCE_ANT_DIS))\r\nreturn 0;\r\nif (ant_isolation == mvm->last_ant_isol)\r\nreturn 0;\r\nfor (lut = 0; lut < ARRAY_SIZE(antenna_coupling_ranges) - 1; lut++)\r\nif (ant_isolation < antenna_coupling_ranges[lut + 1].range)\r\nbreak;\r\nlower_bound = antenna_coupling_ranges[lut].range;\r\nif (lut < ARRAY_SIZE(antenna_coupling_ranges) - 1)\r\nupper_bound = antenna_coupling_ranges[lut + 1].range;\r\nelse\r\nupper_bound = antenna_coupling_ranges[lut].range;\r\nIWL_DEBUG_COEX(mvm, "Antenna isolation=%d in range [%d,%d[, lut=%d\n",\r\nant_isolation, lower_bound, upper_bound, lut);\r\nmvm->last_ant_isol = ant_isolation;\r\nif (mvm->last_corun_lut == lut)\r\nreturn 0;\r\nmvm->last_corun_lut = lut;\r\nbt_cmd = kzalloc(sizeof(*bt_cmd), GFP_KERNEL);\r\nif (!bt_cmd)\r\nreturn 0;\r\ncmd.data[0] = bt_cmd;\r\nbt_cmd->flags = cpu_to_le32(BT_COEX_NW_OLD);\r\nbt_cmd->valid_bit_msk |= cpu_to_le32(BT_VALID_ENABLE |\r\nBT_VALID_CORUN_LUT_20 |\r\nBT_VALID_CORUN_LUT_40);\r\nmemcpy(bt_cmd->bt4_corun_lut20, antenna_coupling_ranges[lut].lut20,\r\nsizeof(bt_cmd->bt4_corun_lut20));\r\nmemcpy(bt_cmd->bt4_corun_lut40, antenna_coupling_ranges[lut].lut20,\r\nsizeof(bt_cmd->bt4_corun_lut40));\r\nret = iwl_mvm_send_cmd(mvm, &cmd);\r\nkfree(bt_cmd);\r\nreturn ret;\r\n}

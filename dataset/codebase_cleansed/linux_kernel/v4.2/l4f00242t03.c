static void l4f00242t03_reset(unsigned int gpio)\r\n{\r\npr_debug("l4f00242t03_reset.\n");\r\ngpio_set_value(gpio, 1);\r\nmdelay(100);\r\ngpio_set_value(gpio, 0);\r\nmdelay(10);\r\ngpio_set_value(gpio, 1);\r\nmdelay(20);\r\n}\r\nstatic void l4f00242t03_lcd_init(struct spi_device *spi)\r\n{\r\nstruct l4f00242t03_pdata *pdata = dev_get_platdata(&spi->dev);\r\nstruct l4f00242t03_priv *priv = spi_get_drvdata(spi);\r\nconst u16 cmd[] = { 0x36, param(0), 0x3A, param(0x60) };\r\nint ret;\r\ndev_dbg(&spi->dev, "initializing LCD\n");\r\nret = regulator_set_voltage(priv->io_reg, 1800000, 1800000);\r\nif (ret) {\r\ndev_err(&spi->dev, "failed to set the IO regulator voltage.\n");\r\nreturn;\r\n}\r\nret = regulator_enable(priv->io_reg);\r\nif (ret) {\r\ndev_err(&spi->dev, "failed to enable the IO regulator.\n");\r\nreturn;\r\n}\r\nret = regulator_set_voltage(priv->core_reg, 2800000, 2800000);\r\nif (ret) {\r\ndev_err(&spi->dev, "failed to set the core regulator voltage.\n");\r\nregulator_disable(priv->io_reg);\r\nreturn;\r\n}\r\nret = regulator_enable(priv->core_reg);\r\nif (ret) {\r\ndev_err(&spi->dev, "failed to enable the core regulator.\n");\r\nregulator_disable(priv->io_reg);\r\nreturn;\r\n}\r\nl4f00242t03_reset(pdata->reset_gpio);\r\ngpio_set_value(pdata->data_enable_gpio, 1);\r\nmsleep(60);\r\nspi_write(spi, (const u8 *)cmd, ARRAY_SIZE(cmd) * sizeof(u16));\r\n}\r\nstatic void l4f00242t03_lcd_powerdown(struct spi_device *spi)\r\n{\r\nstruct l4f00242t03_pdata *pdata = dev_get_platdata(&spi->dev);\r\nstruct l4f00242t03_priv *priv = spi_get_drvdata(spi);\r\ndev_dbg(&spi->dev, "Powering down LCD\n");\r\ngpio_set_value(pdata->data_enable_gpio, 0);\r\nregulator_disable(priv->io_reg);\r\nregulator_disable(priv->core_reg);\r\n}\r\nstatic int l4f00242t03_lcd_power_get(struct lcd_device *ld)\r\n{\r\nstruct l4f00242t03_priv *priv = lcd_get_data(ld);\r\nreturn priv->lcd_state;\r\n}\r\nstatic int l4f00242t03_lcd_power_set(struct lcd_device *ld, int power)\r\n{\r\nstruct l4f00242t03_priv *priv = lcd_get_data(ld);\r\nstruct spi_device *spi = priv->spi;\r\nconst u16 slpout = 0x11;\r\nconst u16 dison = 0x29;\r\nconst u16 slpin = 0x10;\r\nconst u16 disoff = 0x28;\r\nif (power <= FB_BLANK_NORMAL) {\r\nif (priv->lcd_state <= FB_BLANK_NORMAL) {\r\n} else if (priv->lcd_state < FB_BLANK_POWERDOWN) {\r\ndev_dbg(&spi->dev, "Resuming LCD\n");\r\nspi_write(spi, (const u8 *)&slpout, sizeof(u16));\r\nmsleep(60);\r\nspi_write(spi, (const u8 *)&dison, sizeof(u16));\r\n} else {\r\nl4f00242t03_lcd_init(spi);\r\npriv->lcd_state = FB_BLANK_VSYNC_SUSPEND;\r\nl4f00242t03_lcd_power_set(priv->ld, power);\r\n}\r\n} else if (power < FB_BLANK_POWERDOWN) {\r\nif (priv->lcd_state <= FB_BLANK_NORMAL) {\r\ndev_dbg(&spi->dev, "Standby the LCD\n");\r\nspi_write(spi, (const u8 *)&disoff, sizeof(u16));\r\nmsleep(60);\r\nspi_write(spi, (const u8 *)&slpin, sizeof(u16));\r\n} else if (priv->lcd_state < FB_BLANK_POWERDOWN) {\r\n} else {\r\nl4f00242t03_lcd_init(spi);\r\npriv->lcd_state = FB_BLANK_UNBLANK;\r\nl4f00242t03_lcd_power_set(ld, power);\r\n}\r\n} else {\r\nif (priv->lcd_state != FB_BLANK_POWERDOWN) {\r\nspi_write(spi, (const u8 *)&disoff, sizeof(u16));\r\nmsleep(60);\r\nl4f00242t03_lcd_powerdown(spi);\r\n}\r\n}\r\npriv->lcd_state = power;\r\nreturn 0;\r\n}\r\nstatic int l4f00242t03_probe(struct spi_device *spi)\r\n{\r\nstruct l4f00242t03_priv *priv;\r\nstruct l4f00242t03_pdata *pdata = dev_get_platdata(&spi->dev);\r\nint ret;\r\nif (pdata == NULL) {\r\ndev_err(&spi->dev, "Uninitialized platform data.\n");\r\nreturn -EINVAL;\r\n}\r\npriv = devm_kzalloc(&spi->dev, sizeof(struct l4f00242t03_priv),\r\nGFP_KERNEL);\r\nif (priv == NULL)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, priv);\r\nspi->bits_per_word = 9;\r\nspi_setup(spi);\r\npriv->spi = spi;\r\nret = devm_gpio_request_one(&spi->dev, pdata->reset_gpio,\r\nGPIOF_OUT_INIT_HIGH, "lcd l4f00242t03 reset");\r\nif (ret) {\r\ndev_err(&spi->dev,\r\n"Unable to get the lcd l4f00242t03 reset gpio.\n");\r\nreturn ret;\r\n}\r\nret = devm_gpio_request_one(&spi->dev, pdata->data_enable_gpio,\r\nGPIOF_OUT_INIT_LOW, "lcd l4f00242t03 data enable");\r\nif (ret) {\r\ndev_err(&spi->dev,\r\n"Unable to get the lcd l4f00242t03 data en gpio.\n");\r\nreturn ret;\r\n}\r\npriv->io_reg = devm_regulator_get(&spi->dev, "vdd");\r\nif (IS_ERR(priv->io_reg)) {\r\ndev_err(&spi->dev, "%s: Unable to get the IO regulator\n",\r\n__func__);\r\nreturn PTR_ERR(priv->io_reg);\r\n}\r\npriv->core_reg = devm_regulator_get(&spi->dev, "vcore");\r\nif (IS_ERR(priv->core_reg)) {\r\ndev_err(&spi->dev, "%s: Unable to get the core regulator\n",\r\n__func__);\r\nreturn PTR_ERR(priv->core_reg);\r\n}\r\npriv->ld = devm_lcd_device_register(&spi->dev, "l4f00242t03", &spi->dev,\r\npriv, &l4f_ops);\r\nif (IS_ERR(priv->ld))\r\nreturn PTR_ERR(priv->ld);\r\nl4f00242t03_lcd_init(spi);\r\npriv->lcd_state = FB_BLANK_VSYNC_SUSPEND;\r\nl4f00242t03_lcd_power_set(priv->ld, FB_BLANK_UNBLANK);\r\ndev_info(&spi->dev, "Epson l4f00242t03 lcd probed.\n");\r\nreturn 0;\r\n}\r\nstatic int l4f00242t03_remove(struct spi_device *spi)\r\n{\r\nstruct l4f00242t03_priv *priv = spi_get_drvdata(spi);\r\nl4f00242t03_lcd_power_set(priv->ld, FB_BLANK_POWERDOWN);\r\nreturn 0;\r\n}\r\nstatic void l4f00242t03_shutdown(struct spi_device *spi)\r\n{\r\nstruct l4f00242t03_priv *priv = spi_get_drvdata(spi);\r\nif (priv)\r\nl4f00242t03_lcd_power_set(priv->ld, FB_BLANK_POWERDOWN);\r\n}

static irqreturn_t fnic_isr_legacy(int irq, void *data)\r\n{\r\nstruct fnic *fnic = data;\r\nu32 pba;\r\nunsigned long work_done = 0;\r\npba = vnic_intr_legacy_pba(fnic->legacy_pba);\r\nif (!pba)\r\nreturn IRQ_NONE;\r\nfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\r\natomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\r\nif (pba & (1 << FNIC_INTX_NOTIFY)) {\r\nvnic_intr_return_all_credits(&fnic->intr[FNIC_INTX_NOTIFY]);\r\nfnic_handle_link_event(fnic);\r\n}\r\nif (pba & (1 << FNIC_INTX_ERR)) {\r\nvnic_intr_return_all_credits(&fnic->intr[FNIC_INTX_ERR]);\r\nfnic_log_q_error(fnic);\r\n}\r\nif (pba & (1 << FNIC_INTX_WQ_RQ_COPYWQ)) {\r\nwork_done += fnic_wq_copy_cmpl_handler(fnic, -1);\r\nwork_done += fnic_wq_cmpl_handler(fnic, -1);\r\nwork_done += fnic_rq_cmpl_handler(fnic, -1);\r\nvnic_intr_return_credits(&fnic->intr[FNIC_INTX_WQ_RQ_COPYWQ],\r\nwork_done,\r\n1 ,\r\n1 );\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t fnic_isr_msi(int irq, void *data)\r\n{\r\nstruct fnic *fnic = data;\r\nunsigned long work_done = 0;\r\nfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\r\natomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\r\nwork_done += fnic_wq_copy_cmpl_handler(fnic, -1);\r\nwork_done += fnic_wq_cmpl_handler(fnic, -1);\r\nwork_done += fnic_rq_cmpl_handler(fnic, -1);\r\nvnic_intr_return_credits(&fnic->intr[0],\r\nwork_done,\r\n1 ,\r\n1 );\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t fnic_isr_msix_rq(int irq, void *data)\r\n{\r\nstruct fnic *fnic = data;\r\nunsigned long rq_work_done = 0;\r\nfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\r\natomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\r\nrq_work_done = fnic_rq_cmpl_handler(fnic, -1);\r\nvnic_intr_return_credits(&fnic->intr[FNIC_MSIX_RQ],\r\nrq_work_done,\r\n1 ,\r\n1 );\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t fnic_isr_msix_wq(int irq, void *data)\r\n{\r\nstruct fnic *fnic = data;\r\nunsigned long wq_work_done = 0;\r\nfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\r\natomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\r\nwq_work_done = fnic_wq_cmpl_handler(fnic, -1);\r\nvnic_intr_return_credits(&fnic->intr[FNIC_MSIX_WQ],\r\nwq_work_done,\r\n1 ,\r\n1 );\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t fnic_isr_msix_wq_copy(int irq, void *data)\r\n{\r\nstruct fnic *fnic = data;\r\nunsigned long wq_copy_work_done = 0;\r\nfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\r\natomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\r\nwq_copy_work_done = fnic_wq_copy_cmpl_handler(fnic, -1);\r\nvnic_intr_return_credits(&fnic->intr[FNIC_MSIX_WQ_COPY],\r\nwq_copy_work_done,\r\n1 ,\r\n1 );\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t fnic_isr_msix_err_notify(int irq, void *data)\r\n{\r\nstruct fnic *fnic = data;\r\nfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\r\natomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\r\nvnic_intr_return_all_credits(&fnic->intr[FNIC_MSIX_ERR_NOTIFY]);\r\nfnic_log_q_error(fnic);\r\nfnic_handle_link_event(fnic);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid fnic_free_intr(struct fnic *fnic)\r\n{\r\nint i;\r\nswitch (vnic_dev_get_intr_mode(fnic->vdev)) {\r\ncase VNIC_DEV_INTR_MODE_INTX:\r\ncase VNIC_DEV_INTR_MODE_MSI:\r\nfree_irq(fnic->pdev->irq, fnic);\r\nbreak;\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\nfor (i = 0; i < ARRAY_SIZE(fnic->msix); i++)\r\nif (fnic->msix[i].requested)\r\nfree_irq(fnic->msix_entry[i].vector,\r\nfnic->msix[i].devid);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint fnic_request_intr(struct fnic *fnic)\r\n{\r\nint err = 0;\r\nint i;\r\nswitch (vnic_dev_get_intr_mode(fnic->vdev)) {\r\ncase VNIC_DEV_INTR_MODE_INTX:\r\nerr = request_irq(fnic->pdev->irq, &fnic_isr_legacy,\r\nIRQF_SHARED, DRV_NAME, fnic);\r\nbreak;\r\ncase VNIC_DEV_INTR_MODE_MSI:\r\nerr = request_irq(fnic->pdev->irq, &fnic_isr_msi,\r\n0, fnic->name, fnic);\r\nbreak;\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\nsprintf(fnic->msix[FNIC_MSIX_RQ].devname,\r\n"%.11s-fcs-rq", fnic->name);\r\nfnic->msix[FNIC_MSIX_RQ].isr = fnic_isr_msix_rq;\r\nfnic->msix[FNIC_MSIX_RQ].devid = fnic;\r\nsprintf(fnic->msix[FNIC_MSIX_WQ].devname,\r\n"%.11s-fcs-wq", fnic->name);\r\nfnic->msix[FNIC_MSIX_WQ].isr = fnic_isr_msix_wq;\r\nfnic->msix[FNIC_MSIX_WQ].devid = fnic;\r\nsprintf(fnic->msix[FNIC_MSIX_WQ_COPY].devname,\r\n"%.11s-scsi-wq", fnic->name);\r\nfnic->msix[FNIC_MSIX_WQ_COPY].isr = fnic_isr_msix_wq_copy;\r\nfnic->msix[FNIC_MSIX_WQ_COPY].devid = fnic;\r\nsprintf(fnic->msix[FNIC_MSIX_ERR_NOTIFY].devname,\r\n"%.11s-err-notify", fnic->name);\r\nfnic->msix[FNIC_MSIX_ERR_NOTIFY].isr =\r\nfnic_isr_msix_err_notify;\r\nfnic->msix[FNIC_MSIX_ERR_NOTIFY].devid = fnic;\r\nfor (i = 0; i < ARRAY_SIZE(fnic->msix); i++) {\r\nerr = request_irq(fnic->msix_entry[i].vector,\r\nfnic->msix[i].isr, 0,\r\nfnic->msix[i].devname,\r\nfnic->msix[i].devid);\r\nif (err) {\r\nshost_printk(KERN_ERR, fnic->lport->host,\r\n"MSIX: request_irq"\r\n" failed %d\n", err);\r\nfnic_free_intr(fnic);\r\nbreak;\r\n}\r\nfnic->msix[i].requested = 1;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nint fnic_set_intr_mode(struct fnic *fnic)\r\n{\r\nunsigned int n = ARRAY_SIZE(fnic->rq);\r\nunsigned int m = ARRAY_SIZE(fnic->wq);\r\nunsigned int o = ARRAY_SIZE(fnic->wq_copy);\r\nunsigned int i;\r\nBUG_ON(ARRAY_SIZE(fnic->msix_entry) < n + m + o + 1);\r\nfor (i = 0; i < n + m + o + 1; i++)\r\nfnic->msix_entry[i].entry = i;\r\nif (fnic->rq_count >= n &&\r\nfnic->raw_wq_count >= m &&\r\nfnic->wq_copy_count >= o &&\r\nfnic->cq_count >= n + m + o) {\r\nif (!pci_enable_msix_exact(fnic->pdev, fnic->msix_entry,\r\nn + m + o + 1)) {\r\nfnic->rq_count = n;\r\nfnic->raw_wq_count = m;\r\nfnic->wq_copy_count = o;\r\nfnic->wq_count = m + o;\r\nfnic->cq_count = n + m + o;\r\nfnic->intr_count = n + m + o + 1;\r\nfnic->err_intr_offset = FNIC_MSIX_ERR_NOTIFY;\r\nFNIC_ISR_DBG(KERN_DEBUG, fnic->lport->host,\r\n"Using MSI-X Interrupts\n");\r\nvnic_dev_set_intr_mode(fnic->vdev,\r\nVNIC_DEV_INTR_MODE_MSIX);\r\nreturn 0;\r\n}\r\n}\r\nif (fnic->rq_count >= 1 &&\r\nfnic->raw_wq_count >= 1 &&\r\nfnic->wq_copy_count >= 1 &&\r\nfnic->cq_count >= 3 &&\r\nfnic->intr_count >= 1 &&\r\n!pci_enable_msi(fnic->pdev)) {\r\nfnic->rq_count = 1;\r\nfnic->raw_wq_count = 1;\r\nfnic->wq_copy_count = 1;\r\nfnic->wq_count = 2;\r\nfnic->cq_count = 3;\r\nfnic->intr_count = 1;\r\nfnic->err_intr_offset = 0;\r\nFNIC_ISR_DBG(KERN_DEBUG, fnic->lport->host,\r\n"Using MSI Interrupts\n");\r\nvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_MSI);\r\nreturn 0;\r\n}\r\nif (fnic->rq_count >= 1 &&\r\nfnic->raw_wq_count >= 1 &&\r\nfnic->wq_copy_count >= 1 &&\r\nfnic->cq_count >= 3 &&\r\nfnic->intr_count >= 3) {\r\nfnic->rq_count = 1;\r\nfnic->raw_wq_count = 1;\r\nfnic->wq_copy_count = 1;\r\nfnic->cq_count = 3;\r\nfnic->intr_count = 3;\r\nFNIC_ISR_DBG(KERN_DEBUG, fnic->lport->host,\r\n"Using Legacy Interrupts\n");\r\nvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_INTX);\r\nreturn 0;\r\n}\r\nvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_UNKNOWN);\r\nreturn -EINVAL;\r\n}\r\nvoid fnic_clear_intr_mode(struct fnic *fnic)\r\n{\r\nswitch (vnic_dev_get_intr_mode(fnic->vdev)) {\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\npci_disable_msix(fnic->pdev);\r\nbreak;\r\ncase VNIC_DEV_INTR_MODE_MSI:\r\npci_disable_msi(fnic->pdev);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_INTX);\r\n}

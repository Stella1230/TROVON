static void tilegx_start_ohc(void)\r\n{\r\n}\r\nstatic void tilegx_stop_ohc(void)\r\n{\r\n}\r\nstatic int tilegx_ohci_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nret = ohci_init(ohci);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\ndev_err(hcd->self.controller, "can't start %s\n",\r\nhcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_tilegx_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct tilegx_usb_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\npte_t pte = { 0 };\r\nint my_cpu = smp_processor_id();\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nif (gxio_usb_host_init(&pdata->usb_ctx, pdata->dev_index, 0) != 0)\r\nreturn -ENXIO;\r\nhcd = usb_create_hcd(&ohci_tilegx_hc_driver, &pdev->dev,\r\ndev_name(&pdev->dev));\r\nif (!hcd) {\r\nret = -ENOMEM;\r\ngoto err_hcd;\r\n}\r\nhcd->rsrc_start =\r\n(ulong) gxio_usb_host_get_reg_start(&pdata->usb_ctx);\r\nhcd->rsrc_len = gxio_usb_host_get_reg_len(&pdata->usb_ctx);\r\nhcd->regs = gxio_usb_host_get_reg_start(&pdata->usb_ctx);\r\ntilegx_start_ohc();\r\npdata->irq = irq_alloc_hwirq(-1);\r\nif (!pdata->irq) {\r\nret = -ENXIO;\r\ngoto err_no_irq;\r\n}\r\ntile_irq_activate(pdata->irq, TILE_IRQ_PERCPU);\r\nret = gxio_usb_host_cfg_interrupt(&pdata->usb_ctx,\r\ncpu_x(my_cpu), cpu_y(my_cpu),\r\nKERNEL_PL, pdata->irq);\r\nif (ret) {\r\nret = -ENXIO;\r\ngoto err_have_irq;\r\n}\r\npte = pte_set_home(pte, PAGE_HOME_HASH);\r\nret = gxio_usb_host_register_client_memory(&pdata->usb_ctx, pte, 0);\r\nif (ret) {\r\nret = -ENXIO;\r\ngoto err_have_irq;\r\n}\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nret = usb_add_hcd(hcd, pdata->irq, IRQF_SHARED);\r\nif (ret == 0) {\r\nplatform_set_drvdata(pdev, hcd);\r\ndevice_wakeup_enable(hcd->self.controller);\r\nreturn ret;\r\n}\r\nerr_have_irq:\r\nirq_free_hwirq(pdata->irq);\r\nerr_no_irq:\r\ntilegx_stop_ohc();\r\nusb_put_hcd(hcd);\r\nerr_hcd:\r\ngxio_usb_host_destroy(&pdata->usb_ctx);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_tilegx_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct tilegx_usb_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\ntilegx_stop_ohc();\r\ngxio_usb_host_destroy(&pdata->usb_ctx);\r\nirq_free_hwirq(pdata->irq);\r\nreturn 0;\r\n}\r\nstatic void ohci_hcd_tilegx_drv_shutdown(struct platform_device *pdev)\r\n{\r\nusb_hcd_platform_shutdown(pdev);\r\nohci_hcd_tilegx_drv_remove(pdev);\r\n}

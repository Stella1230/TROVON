static int\r\nnvkm_connector_hpd(struct nvkm_notify *notify)\r\n{\r\nstruct nvkm_connector *conn = container_of(notify, typeof(*conn), hpd);\r\nstruct nvkm_disp *disp = nvkm_disp(conn);\r\nstruct nvkm_gpio *gpio = nvkm_gpio(conn);\r\nconst struct nvkm_gpio_ntfy_rep *line = notify->data;\r\nstruct nvif_notify_conn_rep_v0 rep;\r\nint index = conn->index;\r\nDBG("HPD: %d\n", line->mask);\r\nif (!gpio->get(gpio, 0, DCB_GPIO_UNUSED, conn->hpd.index))\r\nrep.mask = NVIF_NOTIFY_CONN_V0_UNPLUG;\r\nelse\r\nrep.mask = NVIF_NOTIFY_CONN_V0_PLUG;\r\nrep.version = 0;\r\nnvkm_event_send(&disp->hpd, rep.mask, index, &rep, sizeof(rep));\r\nreturn NVKM_NOTIFY_KEEP;\r\n}\r\nint\r\n_nvkm_connector_fini(struct nvkm_object *object, bool suspend)\r\n{\r\nstruct nvkm_connector *conn = (void *)object;\r\nnvkm_notify_put(&conn->hpd);\r\nreturn nvkm_object_fini(&conn->base, suspend);\r\n}\r\nint\r\n_nvkm_connector_init(struct nvkm_object *object)\r\n{\r\nstruct nvkm_connector *conn = (void *)object;\r\nint ret = nvkm_object_init(&conn->base);\r\nif (ret == 0)\r\nnvkm_notify_get(&conn->hpd);\r\nreturn ret;\r\n}\r\nvoid\r\n_nvkm_connector_dtor(struct nvkm_object *object)\r\n{\r\nstruct nvkm_connector *conn = (void *)object;\r\nnvkm_notify_fini(&conn->hpd);\r\nnvkm_object_destroy(&conn->base);\r\n}\r\nint\r\nnvkm_connector_create_(struct nvkm_object *parent,\r\nstruct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass,\r\nstruct nvbios_connE *info, int index,\r\nint length, void **pobject)\r\n{\r\nstatic const u8 hpd[] = { 0x07, 0x08, 0x51, 0x52, 0x5e, 0x5f, 0x60 };\r\nstruct nvkm_disp *disp = nvkm_disp(parent);\r\nstruct nvkm_gpio *gpio = nvkm_gpio(parent);\r\nstruct nvkm_connector *conn;\r\nstruct nvkm_output *outp;\r\nstruct dcb_gpio_func func;\r\nint ret;\r\nlist_for_each_entry(outp, &disp->outp, head) {\r\nif (outp->conn && outp->conn->index == index) {\r\natomic_inc(&nv_object(outp->conn)->refcount);\r\n*pobject = outp->conn;\r\nreturn 1;\r\n}\r\n}\r\nret = nvkm_object_create_(parent, engine, oclass, 0, length, pobject);\r\nconn = *pobject;\r\nif (ret)\r\nreturn ret;\r\nconn->info = *info;\r\nconn->index = index;\r\nDBG("type %02x loc %d hpd %02x dp %x di %x sr %x lcdid %x\n",\r\ninfo->type, info->location, info->hpd, info->dp,\r\ninfo->di, info->sr, info->lcdid);\r\nif ((info->hpd = ffs(info->hpd))) {\r\nif (--info->hpd >= ARRAY_SIZE(hpd)) {\r\nERR("hpd %02x unknown\n", info->hpd);\r\nreturn 0;\r\n}\r\ninfo->hpd = hpd[info->hpd];\r\nret = gpio->find(gpio, 0, info->hpd, DCB_GPIO_UNUSED, &func);\r\nif (ret) {\r\nERR("func %02x lookup failed, %d\n", info->hpd, ret);\r\nreturn 0;\r\n}\r\nret = nvkm_notify_init(NULL, &gpio->event, nvkm_connector_hpd,\r\ntrue, &(struct nvkm_gpio_ntfy_req) {\r\n.mask = NVKM_GPIO_TOGGLED,\r\n.line = func.line,\r\n},\r\nsizeof(struct nvkm_gpio_ntfy_req),\r\nsizeof(struct nvkm_gpio_ntfy_rep),\r\n&conn->hpd);\r\nif (ret) {\r\nERR("func %02x failed, %d\n", info->hpd, ret);\r\n} else {\r\nDBG("func %02x (HPD)\n", info->hpd);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint\r\n_nvkm_connector_ctor(struct nvkm_object *parent,\r\nstruct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *info, u32 index,\r\nstruct nvkm_object **pobject)\r\n{\r\nstruct nvkm_connector *conn;\r\nint ret;\r\nret = nvkm_connector_create(parent, engine, oclass, info, index, &conn);\r\n*pobject = nv_object(conn);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}

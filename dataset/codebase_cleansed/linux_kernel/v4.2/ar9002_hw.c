static int ar9002_hw_init_mode_regs(struct ath_hw *ah)\r\n{\r\nif (AR_SREV_9271(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModes, ar9271Modes_9271);\r\nINIT_INI_ARRAY(&ah->iniCommon, ar9271Common_9271);\r\nINIT_INI_ARRAY(&ah->iniModes_9271_ANI_reg, ar9271Modes_9271_ANI_reg);\r\nreturn 0;\r\n}\r\nINIT_INI_ARRAY(&ah->iniPcieSerdes,\r\nar9280PciePhy_clkreq_always_on_L1_9280);\r\nif (AR_SREV_9287_11_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModes, ar9287Modes_9287_1_1);\r\nINIT_INI_ARRAY(&ah->iniCommon, ar9287Common_9287_1_1);\r\n} else if (AR_SREV_9285_12_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModes, ar9285Modes_9285_1_2);\r\nINIT_INI_ARRAY(&ah->iniCommon, ar9285Common_9285_1_2);\r\n} else if (AR_SREV_9280_20_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModes, ar9280Modes_9280_2);\r\nINIT_INI_ARRAY(&ah->iniCommon, ar9280Common_9280_2);\r\nINIT_INI_ARRAY(&ah->iniModesFastClock,\r\nar9280Modes_fast_clock_9280_2);\r\n} else if (AR_SREV_9160_10_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModes, ar5416Modes_9160);\r\nINIT_INI_ARRAY(&ah->iniCommon, ar5416Common_9160);\r\nif (AR_SREV_9160_11(ah)) {\r\nINIT_INI_ARRAY(&ah->iniAddac,\r\nar5416Addac_9160_1_1);\r\n} else {\r\nINIT_INI_ARRAY(&ah->iniAddac, ar5416Addac_9160);\r\n}\r\n} else if (AR_SREV_9100_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModes, ar5416Modes_9100);\r\nINIT_INI_ARRAY(&ah->iniCommon, ar5416Common_9100);\r\nINIT_INI_ARRAY(&ah->iniAddac, ar5416Addac_9100);\r\n} else {\r\nINIT_INI_ARRAY(&ah->iniModes, ar5416Modes);\r\nINIT_INI_ARRAY(&ah->iniCommon, ar5416Common);\r\nINIT_INI_ARRAY(&ah->iniAddac, ar5416Addac);\r\n}\r\nif (!AR_SREV_9280_20_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniBB_RfGain, ar5416BB_RfGain);\r\nif (!AR_SREV_5416(ah))\r\nINIT_INI_ARRAY(&ah->iniBank6, ar5416Bank6TPC_9100);\r\nelse\r\nINIT_INI_ARRAY(&ah->iniBank6, ar5416Bank6TPC);\r\n}\r\nif (AR_SREV_9160(ah) || !AR_SREV_5416_22_OR_LATER(ah)) {\r\nstruct ar5416IniArray *addac = &ah->iniAddac;\r\nu32 size = sizeof(u32) * addac->ia_rows * addac->ia_columns;\r\nu32 *data;\r\ndata = devm_kzalloc(ah->dev, size, GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nmemcpy(data, addac->ia_array, size);\r\naddac->ia_array = data;\r\nif (!AR_SREV_5416_22_OR_LATER(ah)) {\r\nINI_RA(addac, 31,1) = 0;\r\n}\r\n}\r\nif (AR_SREV_9287_11_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniCckfirNormal,\r\nar9287Common_normal_cck_fir_coeff_9287_1_1);\r\nINIT_INI_ARRAY(&ah->iniCckfirJapan2484,\r\nar9287Common_japan_2484_cck_fir_coeff_9287_1_1);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ar9280_20_hw_init_rxgain_ini(struct ath_hw *ah)\r\n{\r\nu32 rxgain_type;\r\nif (ah->eep_ops->get_eeprom(ah, EEP_MINOR_REV) >=\r\nAR5416_EEP_MINOR_VER_17) {\r\nrxgain_type = ah->eep_ops->get_eeprom(ah, EEP_RXGAIN_TYPE);\r\nif (rxgain_type == AR5416_EEP_RXGAIN_13DB_BACKOFF)\r\nINIT_INI_ARRAY(&ah->iniModesRxGain,\r\nar9280Modes_backoff_13db_rxgain_9280_2);\r\nelse if (rxgain_type == AR5416_EEP_RXGAIN_23DB_BACKOFF)\r\nINIT_INI_ARRAY(&ah->iniModesRxGain,\r\nar9280Modes_backoff_23db_rxgain_9280_2);\r\nelse\r\nINIT_INI_ARRAY(&ah->iniModesRxGain,\r\nar9280Modes_original_rxgain_9280_2);\r\n} else {\r\nINIT_INI_ARRAY(&ah->iniModesRxGain,\r\nar9280Modes_original_rxgain_9280_2);\r\n}\r\n}\r\nstatic void ar9280_20_hw_init_txgain_ini(struct ath_hw *ah, u32 txgain_type)\r\n{\r\nif (ah->eep_ops->get_eeprom(ah, EEP_MINOR_REV) >=\r\nAR5416_EEP_MINOR_VER_19) {\r\nif (txgain_type == AR5416_EEP_TXGAIN_HIGH_POWER)\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9280Modes_high_power_tx_gain_9280_2);\r\nelse\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9280Modes_original_tx_gain_9280_2);\r\n} else {\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9280Modes_original_tx_gain_9280_2);\r\n}\r\n}\r\nstatic void ar9271_hw_init_txgain_ini(struct ath_hw *ah, u32 txgain_type)\r\n{\r\nif (txgain_type == AR5416_EEP_TXGAIN_HIGH_POWER)\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9271Modes_high_power_tx_gain_9271);\r\nelse\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9271Modes_normal_power_tx_gain_9271);\r\n}\r\nstatic void ar9002_hw_init_mode_gain_regs(struct ath_hw *ah)\r\n{\r\nu32 txgain_type = ah->eep_ops->get_eeprom(ah, EEP_TXGAIN_TYPE);\r\nif (AR_SREV_9287_11_OR_LATER(ah))\r\nINIT_INI_ARRAY(&ah->iniModesRxGain,\r\nar9287Modes_rx_gain_9287_1_1);\r\nelse if (AR_SREV_9280_20(ah))\r\nar9280_20_hw_init_rxgain_ini(ah);\r\nif (AR_SREV_9271(ah)) {\r\nar9271_hw_init_txgain_ini(ah, txgain_type);\r\n} else if (AR_SREV_9287_11_OR_LATER(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9287Modes_tx_gain_9287_1_1);\r\n} else if (AR_SREV_9280_20(ah)) {\r\nar9280_20_hw_init_txgain_ini(ah, txgain_type);\r\n} else if (AR_SREV_9285_12_OR_LATER(ah)) {\r\nif (txgain_type == AR5416_EEP_TXGAIN_HIGH_POWER) {\r\nif (AR_SREV_9285E_20(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9285Modes_XE2_0_high_power);\r\n} else {\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9285Modes_high_power_tx_gain_9285_1_2);\r\n}\r\n} else {\r\nif (AR_SREV_9285E_20(ah)) {\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9285Modes_XE2_0_normal_power);\r\n} else {\r\nINIT_INI_ARRAY(&ah->iniModesTxGain,\r\nar9285Modes_original_tx_gain_9285_1_2);\r\n}\r\n}\r\n}\r\n}\r\nstatic void ar9002_hw_configpcipowersave(struct ath_hw *ah,\r\nbool power_off)\r\n{\r\nu8 i;\r\nu32 val;\r\nif (!power_off ) {\r\nif (AR_SREV_9280_20_OR_LATER(ah)) {\r\nfor (i = 0; i < ah->iniPcieSerdes.ia_rows; i++) {\r\nREG_WRITE(ah, INI_RA(&ah->iniPcieSerdes, i, 0),\r\nINI_RA(&ah->iniPcieSerdes, i, 1));\r\n}\r\n} else {\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0x9248fc00);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0x24924924);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0x28000039);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0x53160824);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0xe5980579);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0x001defff);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0x1aaabe40);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0xbe105554);\r\nREG_WRITE(ah, AR_PCIE_SERDES, 0x000e3007);\r\nREG_WRITE(ah, AR_PCIE_SERDES2, 0x00000000);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\n}\r\nudelay(1000);\r\n}\r\nif (power_off) {\r\nREG_CLR_BIT(ah, AR_PCIE_PM_CTRL, AR_PCIE_PM_CTRL_ENA);\r\nval = REG_READ(ah, AR_WA);\r\nif (ah->config.pcie_waen) {\r\nif (ah->config.pcie_waen & AR_WA_D3_L1_DISABLE)\r\nval |= AR_WA_D3_L1_DISABLE;\r\n} else {\r\nif (AR_SREV_9285(ah) || AR_SREV_9271(ah) || AR_SREV_9287(ah)) {\r\nif (AR9285_WA_DEFAULT & AR_WA_D3_L1_DISABLE)\r\nval |= AR_WA_D3_L1_DISABLE;\r\n} else if (AR_SREV_9280(ah)) {\r\nif (AR9280_WA_DEFAULT & AR_WA_D3_L1_DISABLE)\r\nval |= AR_WA_D3_L1_DISABLE;\r\n}\r\n}\r\nif (AR_SREV_9280(ah) || AR_SREV_9285(ah) || AR_SREV_9287(ah)) {\r\nval &= ~(AR_WA_BIT6 | AR_WA_BIT7);\r\n}\r\nif (AR_SREV_9280(ah))\r\nval |= AR_WA_BIT22;\r\nif (AR_SREV_9285E_20(ah))\r\nval |= AR_WA_BIT23;\r\nREG_WRITE(ah, AR_WA, val);\r\n} else {\r\nif (ah->config.pcie_waen) {\r\nval = ah->config.pcie_waen;\r\nval &= (~AR_WA_D3_L1_DISABLE);\r\n} else {\r\nif (AR_SREV_9285(ah) || AR_SREV_9271(ah) || AR_SREV_9287(ah)) {\r\nval = AR9285_WA_DEFAULT;\r\nval &= (~AR_WA_D3_L1_DISABLE);\r\n} else if (AR_SREV_9280(ah)) {\r\nval = AR9280_WA_DEFAULT;\r\nval &= (~AR_WA_D3_L1_DISABLE);\r\n} else {\r\nval = AR_WA_DEFAULT;\r\n}\r\n}\r\nif (AR_SREV_9285(ah) || AR_SREV_9287(ah))\r\nval |= (AR_WA_BIT6 | AR_WA_BIT7);\r\nif (AR_SREV_9285E_20(ah))\r\nval |= AR_WA_BIT23;\r\nREG_WRITE(ah, AR_WA, val);\r\nREG_SET_BIT(ah, AR_PCIE_PM_CTRL, AR_PCIE_PM_CTRL_ENA);\r\n}\r\n}\r\nstatic int ar9002_hw_get_radiorev(struct ath_hw *ah)\r\n{\r\nu32 val;\r\nint i;\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_PHY(0x36), 0x00007058);\r\nfor (i = 0; i < 8; i++)\r\nREG_WRITE(ah, AR_PHY(0x20), 0x00010000);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\nval = (REG_READ(ah, AR_PHY(256)) >> 24) & 0xff;\r\nval = ((val & 0xf0) >> 4) | ((val & 0x0f) << 4);\r\nreturn ath9k_hw_reverse_bits(val, 8);\r\n}\r\nint ar9002_hw_rf_claim(struct ath_hw *ah)\r\n{\r\nu32 val;\r\nREG_WRITE(ah, AR_PHY(0), 0x00000007);\r\nval = ar9002_hw_get_radiorev(ah);\r\nswitch (val & AR_RADIO_SREV_MAJOR) {\r\ncase 0:\r\nval = AR_RAD5133_SREV_MAJOR;\r\nbreak;\r\ncase AR_RAD5133_SREV_MAJOR:\r\ncase AR_RAD5122_SREV_MAJOR:\r\ncase AR_RAD2133_SREV_MAJOR:\r\ncase AR_RAD2122_SREV_MAJOR:\r\nbreak;\r\ndefault:\r\nath_err(ath9k_hw_common(ah),\r\n"Radio Chip Rev 0x%02X not supported\n",\r\nval & AR_RADIO_SREV_MAJOR);\r\nreturn -EOPNOTSUPP;\r\n}\r\nah->hw_version.analog5GhzRev = val;\r\nreturn 0;\r\n}\r\nvoid ar9002_hw_enable_async_fifo(struct ath_hw *ah)\r\n{\r\nif (AR_SREV_9287_13_OR_LATER(ah)) {\r\nREG_SET_BIT(ah, AR_MAC_PCU_ASYNC_FIFO_REG3,\r\nAR_MAC_PCU_ASYNC_FIFO_REG3_DATAPATH_SEL);\r\nREG_SET_BIT(ah, AR_PHY_MODE, AR_PHY_MODE_ASYNCFIFO);\r\nREG_CLR_BIT(ah, AR_MAC_PCU_ASYNC_FIFO_REG3,\r\nAR_MAC_PCU_ASYNC_FIFO_REG3_SOFT_RESET);\r\nREG_SET_BIT(ah, AR_MAC_PCU_ASYNC_FIFO_REG3,\r\nAR_MAC_PCU_ASYNC_FIFO_REG3_SOFT_RESET);\r\n}\r\n}\r\nstatic void ar9002_hw_init_hang_checks(struct ath_hw *ah)\r\n{\r\nif (AR_SREV_9100(ah) || AR_SREV_9160(ah)) {\r\nah->config.hw_hang_checks |= HW_BB_RIFS_HANG;\r\nah->config.hw_hang_checks |= HW_BB_DFS_HANG;\r\n}\r\nif (AR_SREV_9280(ah))\r\nah->config.hw_hang_checks |= HW_BB_RX_CLEAR_STUCK_HANG;\r\nif (AR_SREV_5416(ah) || AR_SREV_9100(ah) || AR_SREV_9160(ah))\r\nah->config.hw_hang_checks |= HW_MAC_HANG;\r\n}\r\nint ar9002_hw_attach_ops(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\r\nstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\r\nint ret;\r\nret = ar9002_hw_init_mode_regs(ah);\r\nif (ret)\r\nreturn ret;\r\npriv_ops->init_mode_gain_regs = ar9002_hw_init_mode_gain_regs;\r\npriv_ops->init_hang_checks = ar9002_hw_init_hang_checks;\r\nops->config_pci_powersave = ar9002_hw_configpcipowersave;\r\nret = ar5008_hw_attach_phy_ops(ah);\r\nif (ret)\r\nreturn ret;\r\nif (AR_SREV_9280_20_OR_LATER(ah))\r\nar9002_hw_attach_phy_ops(ah);\r\nar9002_hw_attach_calib_ops(ah);\r\nar9002_hw_attach_mac_ops(ah);\r\nreturn 0;\r\n}\r\nvoid ar9002_hw_load_ani_reg(struct ath_hw *ah, struct ath9k_channel *chan)\r\n{\r\nu32 modesIndex;\r\nint i;\r\nif (IS_CHAN_5GHZ(chan))\r\nmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\r\nelse\r\nmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\r\nENABLE_REGWRITE_BUFFER(ah);\r\nfor (i = 0; i < ah->iniModes_9271_ANI_reg.ia_rows; i++) {\r\nu32 reg = INI_RA(&ah->iniModes_9271_ANI_reg, i, 0);\r\nu32 val = INI_RA(&ah->iniModes_9271_ANI_reg, i, modesIndex);\r\nu32 val_orig;\r\nif (reg == AR_PHY_CCK_DETECT) {\r\nval_orig = REG_READ(ah, reg);\r\nval &= AR_PHY_CCK_DETECT_WEAK_SIG_THR_CCK;\r\nval_orig &= ~AR_PHY_CCK_DETECT_WEAK_SIG_THR_CCK;\r\nREG_WRITE(ah, reg, val|val_orig);\r\n} else\r\nREG_WRITE(ah, reg, val);\r\n}\r\nREGWRITE_BUFFER_FLUSH(ah);\r\n}

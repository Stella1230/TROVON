static struct nvkm_handle *\r\nnvkm_namedb_lookup(struct nvkm_namedb *namedb, u32 name)\r\n{\r\nstruct nvkm_handle *handle;\r\nlist_for_each_entry(handle, &namedb->list, node) {\r\nif (handle->name == name)\r\nreturn handle;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct nvkm_handle *\r\nnvkm_namedb_lookup_class(struct nvkm_namedb *namedb, u16 oclass)\r\n{\r\nstruct nvkm_handle *handle;\r\nlist_for_each_entry(handle, &namedb->list, node) {\r\nif (nv_mclass(handle->object) == oclass)\r\nreturn handle;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct nvkm_handle *\r\nnvkm_namedb_lookup_vinst(struct nvkm_namedb *namedb, u64 vinst)\r\n{\r\nstruct nvkm_handle *handle;\r\nlist_for_each_entry(handle, &namedb->list, node) {\r\nif (nv_iclass(handle->object, NV_GPUOBJ_CLASS)) {\r\nif (nv_gpuobj(handle->object)->addr == vinst)\r\nreturn handle;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct nvkm_handle *\r\nnvkm_namedb_lookup_cinst(struct nvkm_namedb *namedb, u32 cinst)\r\n{\r\nstruct nvkm_handle *handle;\r\nlist_for_each_entry(handle, &namedb->list, node) {\r\nif (nv_iclass(handle->object, NV_GPUOBJ_CLASS)) {\r\nif (nv_gpuobj(handle->object)->node &&\r\nnv_gpuobj(handle->object)->node->offset == cinst)\r\nreturn handle;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nint\r\nnvkm_namedb_insert(struct nvkm_namedb *namedb, u32 name,\r\nstruct nvkm_object *object,\r\nstruct nvkm_handle *handle)\r\n{\r\nint ret = -EEXIST;\r\nwrite_lock_irq(&namedb->lock);\r\nif (!nvkm_namedb_lookup(namedb, name)) {\r\nnvkm_object_ref(object, &handle->object);\r\nhandle->namedb = namedb;\r\nlist_add(&handle->node, &namedb->list);\r\nret = 0;\r\n}\r\nwrite_unlock_irq(&namedb->lock);\r\nreturn ret;\r\n}\r\nvoid\r\nnvkm_namedb_remove(struct nvkm_handle *handle)\r\n{\r\nstruct nvkm_namedb *namedb = handle->namedb;\r\nstruct nvkm_object *object = handle->object;\r\nwrite_lock_irq(&namedb->lock);\r\nlist_del(&handle->node);\r\nwrite_unlock_irq(&namedb->lock);\r\nnvkm_object_ref(NULL, &object);\r\n}\r\nstruct nvkm_handle *\r\nnvkm_namedb_get(struct nvkm_namedb *namedb, u32 name)\r\n{\r\nstruct nvkm_handle *handle;\r\nread_lock(&namedb->lock);\r\nhandle = nvkm_namedb_lookup(namedb, name);\r\nif (handle == NULL)\r\nread_unlock(&namedb->lock);\r\nreturn handle;\r\n}\r\nstruct nvkm_handle *\r\nnvkm_namedb_get_class(struct nvkm_namedb *namedb, u16 oclass)\r\n{\r\nstruct nvkm_handle *handle;\r\nread_lock(&namedb->lock);\r\nhandle = nvkm_namedb_lookup_class(namedb, oclass);\r\nif (handle == NULL)\r\nread_unlock(&namedb->lock);\r\nreturn handle;\r\n}\r\nstruct nvkm_handle *\r\nnvkm_namedb_get_vinst(struct nvkm_namedb *namedb, u64 vinst)\r\n{\r\nstruct nvkm_handle *handle;\r\nread_lock(&namedb->lock);\r\nhandle = nvkm_namedb_lookup_vinst(namedb, vinst);\r\nif (handle == NULL)\r\nread_unlock(&namedb->lock);\r\nreturn handle;\r\n}\r\nstruct nvkm_handle *\r\nnvkm_namedb_get_cinst(struct nvkm_namedb *namedb, u32 cinst)\r\n{\r\nstruct nvkm_handle *handle;\r\nread_lock(&namedb->lock);\r\nhandle = nvkm_namedb_lookup_cinst(namedb, cinst);\r\nif (handle == NULL)\r\nread_unlock(&namedb->lock);\r\nreturn handle;\r\n}\r\nvoid\r\nnvkm_namedb_put(struct nvkm_handle *handle)\r\n{\r\nif (handle)\r\nread_unlock(&handle->namedb->lock);\r\n}\r\nint\r\nnvkm_namedb_create_(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, u32 pclass,\r\nstruct nvkm_oclass *sclass, u64 engcls,\r\nint length, void **pobject)\r\n{\r\nstruct nvkm_namedb *namedb;\r\nint ret;\r\nret = nvkm_parent_create_(parent, engine, oclass, pclass |\r\nNV_NAMEDB_CLASS, sclass, engcls,\r\nlength, pobject);\r\nnamedb = *pobject;\r\nif (ret)\r\nreturn ret;\r\nrwlock_init(&namedb->lock);\r\nINIT_LIST_HEAD(&namedb->list);\r\nreturn 0;\r\n}\r\nint\r\n_nvkm_namedb_ctor(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nstruct nvkm_namedb *object;\r\nint ret;\r\nret = nvkm_namedb_create(parent, engine, oclass, 0, NULL, 0, &object);\r\n*pobject = nv_object(object);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}

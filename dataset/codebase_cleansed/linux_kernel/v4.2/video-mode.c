void probe_cards(int unsafe)\r\n{\r\nstruct card_info *card;\r\nstatic u8 probed[2];\r\nif (probed[unsafe])\r\nreturn;\r\nprobed[unsafe] = 1;\r\nfor (card = video_cards; card < video_cards_end; card++) {\r\nif (card->unsafe == unsafe) {\r\nif (card->probe)\r\ncard->nmodes = card->probe();\r\nelse\r\ncard->nmodes = 0;\r\n}\r\n}\r\n}\r\nint mode_defined(u16 mode)\r\n{\r\nstruct card_info *card;\r\nstruct mode_info *mi;\r\nint i;\r\nfor (card = video_cards; card < video_cards_end; card++) {\r\nmi = card->modes;\r\nfor (i = 0; i < card->nmodes; i++, mi++) {\r\nif (mi->mode == mode)\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int raw_set_mode(u16 mode, u16 *real_mode)\r\n{\r\nint nmode, i;\r\nstruct card_info *card;\r\nstruct mode_info *mi;\r\nmode &= ~VIDEO_RECALC;\r\nnmode = 0;\r\nfor (card = video_cards; card < video_cards_end; card++) {\r\nmi = card->modes;\r\nfor (i = 0; i < card->nmodes; i++, mi++) {\r\nint visible = mi->x || mi->y;\r\nif ((mode == nmode && visible) ||\r\nmode == mi->mode ||\r\nmode == (mi->y << 8)+mi->x) {\r\n*real_mode = mi->mode;\r\nreturn card->set_mode(mi);\r\n}\r\nif (visible)\r\nnmode++;\r\n}\r\n}\r\nfor (card = video_cards; card < video_cards_end; card++) {\r\nif (mode >= card->xmode_first &&\r\nmode < card->xmode_first+card->xmode_n) {\r\nstruct mode_info mix;\r\n*real_mode = mix.mode = mode;\r\nmix.x = mix.y = 0;\r\nreturn card->set_mode(&mix);\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic void vga_recalc_vertical(void)\r\n{\r\nunsigned int font_size, rows;\r\nu16 crtc;\r\nu8 pt, ov;\r\nset_fs(0);\r\nfont_size = rdfs8(0x485);\r\nrows = force_y ? force_y : rdfs8(0x484)+1;\r\nrows *= font_size;\r\nrows--;\r\ncrtc = vga_crtc();\r\npt = in_idx(crtc, 0x11);\r\npt &= ~0x80;\r\nout_idx(pt, crtc, 0x11);\r\nout_idx((u8)rows, crtc, 0x12);\r\nov = in_idx(crtc, 0x07);\r\nov &= 0xbd;\r\nov |= (rows >> (8-1)) & 0x02;\r\nov |= (rows >> (9-6)) & 0x40;\r\nout_idx(ov, crtc, 0x07);\r\n}\r\nint set_mode(u16 mode)\r\n{\r\nint rv;\r\nu16 real_mode;\r\nif (mode == VIDEO_CURRENT_MODE)\r\nreturn 0;\r\nelse if (mode == NORMAL_VGA)\r\nmode = VIDEO_80x25;\r\nelse if (mode == EXTENDED_VGA)\r\nmode = VIDEO_8POINT;\r\nrv = raw_set_mode(mode, &real_mode);\r\nif (rv)\r\nreturn rv;\r\nif (mode & VIDEO_RECALC)\r\nvga_recalc_vertical();\r\n#ifndef _WAKEUP\r\nboot_params.hdr.vid_mode = real_mode;\r\n#endif\r\nreturn 0;\r\n}

static void imx3_idle(void)\r\n{\r\nunsigned long reg = 0;\r\nmx3_cpu_lp_set(MX3_WAIT);\r\n__asm__ __volatile__(\r\n"mrc p15, 0, %0, c1, c0, 0\n"\r\n"bic %0, %0, #0x00001000\n"\r\n"bic %0, %0, #0x00000004\n"\r\n"mcr p15, 0, %0, c1, c0, 0\n"\r\n"mov %0, #0\n"\r\n"mcr p15, 0, %0, c7, c5, 0\n"\r\n"mov %0, #0\n"\r\n"mcr p15, 0, %0, c7, c14, 0\n"\r\n"mov %0, #0\n"\r\n"mcr p15, 0, %0, c7, c0, 4\n"\r\n"nop\n" "nop\n" "nop\n" "nop\n"\r\n"nop\n" "nop\n" "nop\n"\r\n"mrc p15, 0, %0, c1, c0, 0\n"\r\n"orr %0, %0, #0x00001000\n"\r\n"orr %0, %0, #0x00000004\n"\r\n"mcr p15, 0, %0, c1, c0, 0\n"\r\n: "=r" (reg));\r\n}\r\nstatic void __iomem *imx3_ioremap_caller(phys_addr_t phys_addr, size_t size,\r\nunsigned int mtype, void *caller)\r\n{\r\nif (mtype == MT_DEVICE) {\r\nif (phys_addr < 0x80000000 &&\r\n!addr_in_module(phys_addr, MX3x_L2CC))\r\nmtype = MT_DEVICE_NONSHARED;\r\n}\r\nreturn __arm_ioremap_caller(phys_addr, size, mtype, caller);\r\n}\r\nstatic void __init imx3_init_l2x0(void)\r\n{\r\n#ifdef CONFIG_CACHE_L2X0\r\nvoid __iomem *l2x0_base;\r\nvoid __iomem *clkctl_base;\r\n#define L2_MEM_VAL 0x10\r\nclkctl_base = ioremap(MX35_CLKCTL_BASE_ADDR, 4096);\r\nif (clkctl_base != NULL) {\r\nwritel(0x00000515, clkctl_base + L2_MEM_VAL);\r\niounmap(clkctl_base);\r\n} else {\r\npr_err("L2 cache: Cannot fix timing. Trying to continue without\n");\r\n}\r\nl2x0_base = ioremap(MX3x_L2CC_BASE_ADDR, 4096);\r\nif (!l2x0_base) {\r\nprintk(KERN_ERR "remapping L2 cache area failed\n");\r\nreturn;\r\n}\r\nl2x0_init(l2x0_base, 0x00030024, 0x00000000);\r\n#endif\r\n}\r\nvoid __init mx31_map_io(void)\r\n{\r\niotable_init(mx31_io_desc, ARRAY_SIZE(mx31_io_desc));\r\n}\r\nvoid __init imx31_init_early(void)\r\n{\r\nmxc_set_cpu_type(MXC_CPU_MX31);\r\narch_ioremap_caller = imx3_ioremap_caller;\r\narm_pm_idle = imx3_idle;\r\nmx3_ccm_base = MX31_IO_ADDRESS(MX31_CCM_BASE_ADDR);\r\n}\r\nvoid __init mx31_init_irq(void)\r\n{\r\nmxc_init_irq(MX31_IO_ADDRESS(MX31_AVIC_BASE_ADDR));\r\n}\r\nvoid __init imx31_soc_init(void)\r\n{\r\nint to_version = mx31_revision() >> 4;\r\nimx3_init_l2x0();\r\nmxc_arch_reset_init(MX31_IO_ADDRESS(MX31_WDOG_BASE_ADDR));\r\nmxc_device_init();\r\nmxc_register_gpio("imx31-gpio", 0, MX31_GPIO1_BASE_ADDR, SZ_16K, MX31_INT_GPIO1, 0);\r\nmxc_register_gpio("imx31-gpio", 1, MX31_GPIO2_BASE_ADDR, SZ_16K, MX31_INT_GPIO2, 0);\r\nmxc_register_gpio("imx31-gpio", 2, MX31_GPIO3_BASE_ADDR, SZ_16K, MX31_INT_GPIO3, 0);\r\npinctrl_provide_dummies();\r\nif (to_version == 1) {\r\nstrncpy(imx31_sdma_pdata.fw_name, "sdma-imx31-to1.bin",\r\nstrlen(imx31_sdma_pdata.fw_name));\r\nimx31_sdma_pdata.script_addrs = &imx31_to1_sdma_script;\r\n}\r\nimx_add_imx_sdma("imx31-sdma", MX31_SDMA_BASE_ADDR, MX31_INT_SDMA, &imx31_sdma_pdata);\r\nimx_set_aips(MX31_IO_ADDRESS(MX31_AIPS1_BASE_ADDR));\r\nimx_set_aips(MX31_IO_ADDRESS(MX31_AIPS2_BASE_ADDR));\r\nplatform_device_register_simple("imx31-audmux", 0, imx31_audmux_res,\r\nARRAY_SIZE(imx31_audmux_res));\r\n}\r\nvoid __init mx35_map_io(void)\r\n{\r\niotable_init(mx35_io_desc, ARRAY_SIZE(mx35_io_desc));\r\n}\r\nvoid __init imx35_init_early(void)\r\n{\r\nmxc_set_cpu_type(MXC_CPU_MX35);\r\nmxc_iomux_v3_init(MX35_IO_ADDRESS(MX35_IOMUXC_BASE_ADDR));\r\narm_pm_idle = imx3_idle;\r\narch_ioremap_caller = imx3_ioremap_caller;\r\nmx3_ccm_base = MX35_IO_ADDRESS(MX35_CCM_BASE_ADDR);\r\n}\r\nvoid __init mx35_init_irq(void)\r\n{\r\nmxc_init_irq(MX35_IO_ADDRESS(MX35_AVIC_BASE_ADDR));\r\n}\r\nvoid __init imx35_soc_init(void)\r\n{\r\nint to_version = mx35_revision() >> 4;\r\nimx3_init_l2x0();\r\nmxc_arch_reset_init(MX35_IO_ADDRESS(MX35_WDOG_BASE_ADDR));\r\nmxc_device_init();\r\nmxc_register_gpio("imx35-gpio", 0, MX35_GPIO1_BASE_ADDR, SZ_16K, MX35_INT_GPIO1, 0);\r\nmxc_register_gpio("imx35-gpio", 1, MX35_GPIO2_BASE_ADDR, SZ_16K, MX35_INT_GPIO2, 0);\r\nmxc_register_gpio("imx35-gpio", 2, MX35_GPIO3_BASE_ADDR, SZ_16K, MX35_INT_GPIO3, 0);\r\npinctrl_provide_dummies();\r\nif (to_version == 1) {\r\nstrncpy(imx35_sdma_pdata.fw_name, "sdma-imx35-to1.bin",\r\nstrlen(imx35_sdma_pdata.fw_name));\r\nimx35_sdma_pdata.script_addrs = &imx35_to1_sdma_script;\r\n}\r\nimx_add_imx_sdma("imx35-sdma", MX35_SDMA_BASE_ADDR, MX35_INT_SDMA, &imx35_sdma_pdata);\r\nimx_set_aips(MX35_IO_ADDRESS(MX35_AIPS1_BASE_ADDR));\r\nimx_set_aips(MX35_IO_ADDRESS(MX35_AIPS2_BASE_ADDR));\r\nplatform_device_register_simple("imx31-audmux", 0, imx35_audmux_res,\r\nARRAY_SIZE(imx35_audmux_res));\r\n}

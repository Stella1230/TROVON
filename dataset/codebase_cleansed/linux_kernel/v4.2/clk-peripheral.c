static int clk_peripheral_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_peripheral *periph = to_clk_peripheral(hw);\r\nstruct at91_pmc *pmc = periph->pmc;\r\nint offset = AT91_PMC_PCER;\r\nu32 id = periph->id;\r\nif (id < PERIPHERAL_ID_MIN)\r\nreturn 0;\r\nif (id > PERIPHERAL_ID_MAX)\r\noffset = AT91_PMC_PCER1;\r\npmc_write(pmc, offset, PERIPHERAL_MASK(id));\r\nreturn 0;\r\n}\r\nstatic void clk_peripheral_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_peripheral *periph = to_clk_peripheral(hw);\r\nstruct at91_pmc *pmc = periph->pmc;\r\nint offset = AT91_PMC_PCDR;\r\nu32 id = periph->id;\r\nif (id < PERIPHERAL_ID_MIN)\r\nreturn;\r\nif (id > PERIPHERAL_ID_MAX)\r\noffset = AT91_PMC_PCDR1;\r\npmc_write(pmc, offset, PERIPHERAL_MASK(id));\r\n}\r\nstatic int clk_peripheral_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_peripheral *periph = to_clk_peripheral(hw);\r\nstruct at91_pmc *pmc = periph->pmc;\r\nint offset = AT91_PMC_PCSR;\r\nu32 id = periph->id;\r\nif (id < PERIPHERAL_ID_MIN)\r\nreturn 1;\r\nif (id > PERIPHERAL_ID_MAX)\r\noffset = AT91_PMC_PCSR1;\r\nreturn !!(pmc_read(pmc, offset) & PERIPHERAL_MASK(id));\r\n}\r\nstatic struct clk * __init\r\nat91_clk_register_peripheral(struct at91_pmc *pmc, const char *name,\r\nconst char *parent_name, u32 id)\r\n{\r\nstruct clk_peripheral *periph;\r\nstruct clk *clk = NULL;\r\nstruct clk_init_data init;\r\nif (!pmc || !name || !parent_name || id > PERIPHERAL_ID_MAX)\r\nreturn ERR_PTR(-EINVAL);\r\nperiph = kzalloc(sizeof(*periph), GFP_KERNEL);\r\nif (!periph)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &peripheral_ops;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\ninit.flags = 0;\r\nperiph->id = id;\r\nperiph->hw.init = &init;\r\nperiph->pmc = pmc;\r\nclk = clk_register(NULL, &periph->hw);\r\nif (IS_ERR(clk))\r\nkfree(periph);\r\nreturn clk;\r\n}\r\nstatic void clk_sam9x5_peripheral_autodiv(struct clk_sam9x5_peripheral *periph)\r\n{\r\nstruct clk *parent;\r\nunsigned long parent_rate;\r\nint shift = 0;\r\nif (!periph->auto_div)\r\nreturn;\r\nif (periph->range.max) {\r\nparent = clk_get_parent_by_index(periph->hw.clk, 0);\r\nparent_rate = __clk_get_rate(parent);\r\nif (!parent_rate)\r\nreturn;\r\nfor (; shift < PERIPHERAL_MAX_SHIFT; shift++) {\r\nif (parent_rate >> shift <= periph->range.max)\r\nbreak;\r\n}\r\n}\r\nperiph->auto_div = false;\r\nperiph->div = shift;\r\n}\r\nstatic int clk_sam9x5_peripheral_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_sam9x5_peripheral *periph = to_clk_sam9x5_peripheral(hw);\r\nstruct at91_pmc *pmc = periph->pmc;\r\nif (periph->id < PERIPHERAL_ID_MIN)\r\nreturn 0;\r\npmc_write(pmc, AT91_PMC_PCR, (periph->id & AT91_PMC_PCR_PID) |\r\nAT91_PMC_PCR_CMD |\r\nAT91_PMC_PCR_DIV(periph->div) |\r\nAT91_PMC_PCR_EN);\r\nreturn 0;\r\n}\r\nstatic void clk_sam9x5_peripheral_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_sam9x5_peripheral *periph = to_clk_sam9x5_peripheral(hw);\r\nstruct at91_pmc *pmc = periph->pmc;\r\nif (periph->id < PERIPHERAL_ID_MIN)\r\nreturn;\r\npmc_write(pmc, AT91_PMC_PCR, (periph->id & AT91_PMC_PCR_PID) |\r\nAT91_PMC_PCR_CMD);\r\n}\r\nstatic int clk_sam9x5_peripheral_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_sam9x5_peripheral *periph = to_clk_sam9x5_peripheral(hw);\r\nstruct at91_pmc *pmc = periph->pmc;\r\nint ret;\r\nif (periph->id < PERIPHERAL_ID_MIN)\r\nreturn 1;\r\npmc_lock(pmc);\r\npmc_write(pmc, AT91_PMC_PCR, (periph->id & AT91_PMC_PCR_PID));\r\nret = !!(pmc_read(pmc, AT91_PMC_PCR) & AT91_PMC_PCR_EN);\r\npmc_unlock(pmc);\r\nreturn ret;\r\n}\r\nstatic unsigned long\r\nclk_sam9x5_peripheral_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_sam9x5_peripheral *periph = to_clk_sam9x5_peripheral(hw);\r\nstruct at91_pmc *pmc = periph->pmc;\r\nu32 tmp;\r\nif (periph->id < PERIPHERAL_ID_MIN)\r\nreturn parent_rate;\r\npmc_lock(pmc);\r\npmc_write(pmc, AT91_PMC_PCR, (periph->id & AT91_PMC_PCR_PID));\r\ntmp = pmc_read(pmc, AT91_PMC_PCR);\r\npmc_unlock(pmc);\r\nif (tmp & AT91_PMC_PCR_EN) {\r\nperiph->div = PERIPHERAL_RSHIFT(tmp);\r\nperiph->auto_div = false;\r\n} else {\r\nclk_sam9x5_peripheral_autodiv(periph);\r\n}\r\nreturn parent_rate >> periph->div;\r\n}\r\nstatic long clk_sam9x5_peripheral_round_rate(struct clk_hw *hw,\r\nunsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nint shift = 0;\r\nunsigned long best_rate;\r\nunsigned long best_diff;\r\nunsigned long cur_rate = *parent_rate;\r\nunsigned long cur_diff;\r\nstruct clk_sam9x5_peripheral *periph = to_clk_sam9x5_peripheral(hw);\r\nif (periph->id < PERIPHERAL_ID_MIN || !periph->range.max)\r\nreturn *parent_rate;\r\nif (periph->range.max) {\r\nfor (; shift <= PERIPHERAL_MAX_SHIFT; shift++) {\r\ncur_rate = *parent_rate >> shift;\r\nif (cur_rate <= periph->range.max)\r\nbreak;\r\n}\r\n}\r\nif (rate >= cur_rate)\r\nreturn cur_rate;\r\nbest_diff = cur_rate - rate;\r\nbest_rate = cur_rate;\r\nfor (; shift <= PERIPHERAL_MAX_SHIFT; shift++) {\r\ncur_rate = *parent_rate >> shift;\r\nif (cur_rate < rate)\r\ncur_diff = rate - cur_rate;\r\nelse\r\ncur_diff = cur_rate - rate;\r\nif (cur_diff < best_diff) {\r\nbest_diff = cur_diff;\r\nbest_rate = cur_rate;\r\n}\r\nif (!best_diff || cur_rate < rate)\r\nbreak;\r\n}\r\nreturn best_rate;\r\n}\r\nstatic int clk_sam9x5_peripheral_set_rate(struct clk_hw *hw,\r\nunsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nint shift;\r\nstruct clk_sam9x5_peripheral *periph = to_clk_sam9x5_peripheral(hw);\r\nif (periph->id < PERIPHERAL_ID_MIN || !periph->range.max) {\r\nif (parent_rate == rate)\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nif (periph->range.max && rate > periph->range.max)\r\nreturn -EINVAL;\r\nfor (shift = 0; shift <= PERIPHERAL_MAX_SHIFT; shift++) {\r\nif (parent_rate >> shift == rate) {\r\nperiph->auto_div = false;\r\nperiph->div = shift;\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic struct clk * __init\r\nat91_clk_register_sam9x5_peripheral(struct at91_pmc *pmc, const char *name,\r\nconst char *parent_name, u32 id,\r\nconst struct clk_range *range)\r\n{\r\nstruct clk_sam9x5_peripheral *periph;\r\nstruct clk *clk = NULL;\r\nstruct clk_init_data init;\r\nif (!pmc || !name || !parent_name)\r\nreturn ERR_PTR(-EINVAL);\r\nperiph = kzalloc(sizeof(*periph), GFP_KERNEL);\r\nif (!periph)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &sam9x5_peripheral_ops;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\ninit.flags = 0;\r\nperiph->id = id;\r\nperiph->hw.init = &init;\r\nperiph->div = 0;\r\nperiph->pmc = pmc;\r\nperiph->auto_div = true;\r\nperiph->range = *range;\r\nclk = clk_register(NULL, &periph->hw);\r\nif (IS_ERR(clk))\r\nkfree(periph);\r\nelse\r\nclk_sam9x5_peripheral_autodiv(periph);\r\nreturn clk;\r\n}\r\nstatic void __init\r\nof_at91_clk_periph_setup(struct device_node *np, struct at91_pmc *pmc, u8 type)\r\n{\r\nint num;\r\nu32 id;\r\nstruct clk *clk;\r\nconst char *parent_name;\r\nconst char *name;\r\nstruct device_node *periphclknp;\r\nparent_name = of_clk_get_parent_name(np, 0);\r\nif (!parent_name)\r\nreturn;\r\nnum = of_get_child_count(np);\r\nif (!num || num > PERIPHERAL_MAX)\r\nreturn;\r\nfor_each_child_of_node(np, periphclknp) {\r\nif (of_property_read_u32(periphclknp, "reg", &id))\r\ncontinue;\r\nif (id >= PERIPHERAL_MAX)\r\ncontinue;\r\nif (of_property_read_string(np, "clock-output-names", &name))\r\nname = periphclknp->name;\r\nif (type == PERIPHERAL_AT91RM9200) {\r\nclk = at91_clk_register_peripheral(pmc, name,\r\nparent_name, id);\r\n} else {\r\nstruct clk_range range = CLK_RANGE(0, 0);\r\nof_at91_get_clk_range(periphclknp,\r\n"atmel,clk-output-range",\r\n&range);\r\nclk = at91_clk_register_sam9x5_peripheral(pmc, name,\r\nparent_name,\r\nid, &range);\r\n}\r\nif (IS_ERR(clk))\r\ncontinue;\r\nof_clk_add_provider(periphclknp, of_clk_src_simple_get, clk);\r\n}\r\n}\r\nvoid __init of_at91rm9200_clk_periph_setup(struct device_node *np,\r\nstruct at91_pmc *pmc)\r\n{\r\nof_at91_clk_periph_setup(np, pmc, PERIPHERAL_AT91RM9200);\r\n}\r\nvoid __init of_at91sam9x5_clk_periph_setup(struct device_node *np,\r\nstruct at91_pmc *pmc)\r\n{\r\nof_at91_clk_periph_setup(np, pmc, PERIPHERAL_AT91SAM9X5);\r\n}

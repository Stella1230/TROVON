static int sa1100dog_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(1, &sa1100wdt_users))\r\nreturn -EBUSY;\r\nwritel_relaxed(readl_relaxed(OSCR) + pre_margin, OSMR3);\r\nwritel_relaxed(OSSR_M3, OSSR);\r\nwritel_relaxed(OWER_WME, OWER);\r\nwritel_relaxed(readl_relaxed(OIER) | OIER_E3, OIER);\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int sa1100dog_release(struct inode *inode, struct file *file)\r\n{\r\npr_crit("Device closed - timer will not stop\n");\r\nclear_bit(1, &sa1100wdt_users);\r\nreturn 0;\r\n}\r\nstatic ssize_t sa1100dog_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len)\r\nwritel_relaxed(readl_relaxed(OSCR) + pre_margin, OSMR3);\r\nreturn len;\r\n}\r\nstatic long sa1100dog_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nint time;\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user(argp, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\nret = put_user(0, p);\r\nbreak;\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(boot_status, p);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nwritel_relaxed(readl_relaxed(OSCR) + pre_margin, OSMR3);\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, p);\r\nif (ret)\r\nbreak;\r\nif (time <= 0 || (oscr_freq * (long long)time >= 0xffffffff)) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\npre_margin = oscr_freq * time;\r\nwritel_relaxed(readl_relaxed(OSCR) + pre_margin, OSMR3);\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(pre_margin / oscr_freq, p);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init sa1100dog_init(void)\r\n{\r\nint ret;\r\noscr_freq = get_clock_tick_rate();\r\nboot_status = (reset_status & RESET_STATUS_WATCHDOG) ?\r\nWDIOF_CARDRESET : 0;\r\npre_margin = oscr_freq * margin;\r\nret = misc_register(&sa1100dog_miscdev);\r\nif (ret == 0)\r\npr_info("SA1100/PXA2xx Watchdog Timer: timer margin %d sec\n",\r\nmargin);\r\nreturn ret;\r\n}\r\nstatic void __exit sa1100dog_exit(void)\r\n{\r\nmisc_deregister(&sa1100dog_miscdev);\r\n}

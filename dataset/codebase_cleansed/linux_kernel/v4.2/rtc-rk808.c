static int rk808_rtc_readtime(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rk808_rtc *rk808_rtc = dev_get_drvdata(dev);\r\nstruct rk808 *rk808 = rk808_rtc->rk808;\r\nu8 rtc_data[NUM_TIME_REGS];\r\nint ret;\r\nret = regmap_update_bits(rk808->regmap, RK808_RTC_CTRL_REG,\r\nBIT_RTC_CTRL_REG_RTC_GET_TIME,\r\nBIT_RTC_CTRL_REG_RTC_GET_TIME);\r\nif (ret) {\r\ndev_err(dev, "Failed to update bits rtc_ctrl: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(rk808->regmap, RK808_RTC_CTRL_REG,\r\nBIT_RTC_CTRL_REG_RTC_GET_TIME,\r\n0);\r\nif (ret) {\r\ndev_err(dev, "Failed to update bits rtc_ctrl: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_bulk_read(rk808->regmap, RK808_SECONDS_REG,\r\nrtc_data, NUM_TIME_REGS);\r\nif (ret) {\r\ndev_err(dev, "Failed to bulk read rtc_data: %d\n", ret);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(rtc_data[0] & SECONDS_REG_MSK);\r\ntm->tm_min = bcd2bin(rtc_data[1] & MINUTES_REG_MAK);\r\ntm->tm_hour = bcd2bin(rtc_data[2] & HOURS_REG_MSK);\r\ntm->tm_mday = bcd2bin(rtc_data[3] & DAYS_REG_MSK);\r\ntm->tm_mon = (bcd2bin(rtc_data[4] & MONTHS_REG_MSK)) - 1;\r\ntm->tm_year = (bcd2bin(rtc_data[5] & YEARS_REG_MSK)) + 100;\r\ntm->tm_wday = bcd2bin(rtc_data[6] & WEEKS_REG_MSK);\r\ndev_dbg(dev, "RTC date/time %4d-%02d-%02d(%d) %02d:%02d:%02d\n",\r\n1900 + tm->tm_year, tm->tm_mon + 1, tm->tm_mday,\r\ntm->tm_wday, tm->tm_hour , tm->tm_min, tm->tm_sec);\r\nreturn ret;\r\n}\r\nstatic int rk808_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rk808_rtc *rk808_rtc = dev_get_drvdata(dev);\r\nstruct rk808 *rk808 = rk808_rtc->rk808;\r\nu8 rtc_data[NUM_TIME_REGS];\r\nint ret;\r\nrtc_data[0] = bin2bcd(tm->tm_sec);\r\nrtc_data[1] = bin2bcd(tm->tm_min);\r\nrtc_data[2] = bin2bcd(tm->tm_hour);\r\nrtc_data[3] = bin2bcd(tm->tm_mday);\r\nrtc_data[4] = bin2bcd(tm->tm_mon + 1);\r\nrtc_data[5] = bin2bcd(tm->tm_year - 100);\r\nrtc_data[6] = bin2bcd(tm->tm_wday);\r\ndev_dbg(dev, "set RTC date/time %4d-%02d-%02d(%d) %02d:%02d:%02d\n",\r\n1900 + tm->tm_year, tm->tm_mon + 1, tm->tm_mday,\r\ntm->tm_wday, tm->tm_hour , tm->tm_min, tm->tm_sec);\r\nret = regmap_update_bits(rk808->regmap, RK808_RTC_CTRL_REG,\r\nBIT_RTC_CTRL_REG_STOP_RTC_M,\r\nBIT_RTC_CTRL_REG_STOP_RTC_M);\r\nif (ret) {\r\ndev_err(dev, "Failed to update RTC control: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_bulk_write(rk808->regmap, RK808_SECONDS_REG,\r\nrtc_data, NUM_TIME_REGS);\r\nif (ret) {\r\ndev_err(dev, "Failed to bull write rtc_data: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(rk808->regmap, RK808_RTC_CTRL_REG,\r\nBIT_RTC_CTRL_REG_STOP_RTC_M, 0);\r\nif (ret) {\r\ndev_err(dev, "Failed to update RTC control: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rk808_rtc_readalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rk808_rtc *rk808_rtc = dev_get_drvdata(dev);\r\nstruct rk808 *rk808 = rk808_rtc->rk808;\r\nu8 alrm_data[NUM_ALARM_REGS];\r\nuint32_t int_reg;\r\nint ret;\r\nret = regmap_bulk_read(rk808->regmap, RK808_ALARM_SECONDS_REG,\r\nalrm_data, NUM_ALARM_REGS);\r\nalrm->time.tm_sec = bcd2bin(alrm_data[0] & SECONDS_REG_MSK);\r\nalrm->time.tm_min = bcd2bin(alrm_data[1] & MINUTES_REG_MAK);\r\nalrm->time.tm_hour = bcd2bin(alrm_data[2] & HOURS_REG_MSK);\r\nalrm->time.tm_mday = bcd2bin(alrm_data[3] & DAYS_REG_MSK);\r\nalrm->time.tm_mon = (bcd2bin(alrm_data[4] & MONTHS_REG_MSK)) - 1;\r\nalrm->time.tm_year = (bcd2bin(alrm_data[5] & YEARS_REG_MSK)) + 100;\r\nret = regmap_read(rk808->regmap, RK808_RTC_INT_REG, &int_reg);\r\nif (ret) {\r\ndev_err(dev, "Failed to read RTC INT REG: %d\n", ret);\r\nreturn ret;\r\n}\r\ndev_dbg(dev, "alrm read RTC date/time %4d-%02d-%02d(%d) %02d:%02d:%02d\n",\r\n1900 + alrm->time.tm_year, alrm->time.tm_mon + 1,\r\nalrm->time.tm_mday, alrm->time.tm_wday, alrm->time.tm_hour,\r\nalrm->time.tm_min, alrm->time.tm_sec);\r\nalrm->enabled = (int_reg & BIT_RTC_INTERRUPTS_REG_IT_ALARM_M) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int rk808_rtc_stop_alarm(struct rk808_rtc *rk808_rtc)\r\n{\r\nstruct rk808 *rk808 = rk808_rtc->rk808;\r\nint ret;\r\nret = regmap_update_bits(rk808->regmap, RK808_RTC_INT_REG,\r\nBIT_RTC_INTERRUPTS_REG_IT_ALARM_M, 0);\r\nreturn ret;\r\n}\r\nstatic int rk808_rtc_start_alarm(struct rk808_rtc *rk808_rtc)\r\n{\r\nstruct rk808 *rk808 = rk808_rtc->rk808;\r\nint ret;\r\nret = regmap_update_bits(rk808->regmap, RK808_RTC_INT_REG,\r\nBIT_RTC_INTERRUPTS_REG_IT_ALARM_M,\r\nBIT_RTC_INTERRUPTS_REG_IT_ALARM_M);\r\nreturn ret;\r\n}\r\nstatic int rk808_rtc_setalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rk808_rtc *rk808_rtc = dev_get_drvdata(dev);\r\nstruct rk808 *rk808 = rk808_rtc->rk808;\r\nu8 alrm_data[NUM_ALARM_REGS];\r\nint ret;\r\nret = rk808_rtc_stop_alarm(rk808_rtc);\r\nif (ret) {\r\ndev_err(dev, "Failed to stop alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\ndev_dbg(dev, "alrm set RTC date/time %4d-%02d-%02d(%d) %02d:%02d:%02d\n",\r\n1900 + alrm->time.tm_year, alrm->time.tm_mon + 1,\r\nalrm->time.tm_mday, alrm->time.tm_wday, alrm->time.tm_hour,\r\nalrm->time.tm_min, alrm->time.tm_sec);\r\nalrm_data[0] = bin2bcd(alrm->time.tm_sec);\r\nalrm_data[1] = bin2bcd(alrm->time.tm_min);\r\nalrm_data[2] = bin2bcd(alrm->time.tm_hour);\r\nalrm_data[3] = bin2bcd(alrm->time.tm_mday);\r\nalrm_data[4] = bin2bcd(alrm->time.tm_mon + 1);\r\nalrm_data[5] = bin2bcd(alrm->time.tm_year - 100);\r\nret = regmap_bulk_write(rk808->regmap, RK808_ALARM_SECONDS_REG,\r\nalrm_data, NUM_ALARM_REGS);\r\nif (ret) {\r\ndev_err(dev, "Failed to bulk write: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (alrm->enabled) {\r\nret = rk808_rtc_start_alarm(rk808_rtc);\r\nif (ret) {\r\ndev_err(dev, "Failed to start alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int rk808_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct rk808_rtc *rk808_rtc = dev_get_drvdata(dev);\r\nif (enabled)\r\nreturn rk808_rtc_start_alarm(rk808_rtc);\r\nreturn rk808_rtc_stop_alarm(rk808_rtc);\r\n}\r\nstatic irqreturn_t rk808_alarm_irq(int irq, void *data)\r\n{\r\nstruct rk808_rtc *rk808_rtc = data;\r\nstruct rk808 *rk808 = rk808_rtc->rk808;\r\nstruct i2c_client *client = rk808->i2c;\r\nint ret;\r\nret = regmap_write(rk808->regmap, RK808_RTC_STATUS_REG,\r\nRTC_STATUS_MASK);\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"%s:Failed to update RTC status: %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nrtc_update_irq(rk808_rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\ndev_dbg(&client->dev,\r\n"%s:irq=%d\n", __func__, irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int rk808_rtc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rk808_rtc *rk808_rtc = dev_get_drvdata(&pdev->dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(rk808_rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int rk808_rtc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rk808_rtc *rk808_rtc = dev_get_drvdata(&pdev->dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(rk808_rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int rk808_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rk808 *rk808 = dev_get_drvdata(pdev->dev.parent);\r\nstruct rk808_rtc *rk808_rtc;\r\nstruct rtc_time tm;\r\nint ret;\r\nrk808_rtc = devm_kzalloc(&pdev->dev, sizeof(*rk808_rtc), GFP_KERNEL);\r\nif (rk808_rtc == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, rk808_rtc);\r\nrk808_rtc->rk808 = rk808;\r\nret = regmap_update_bits(rk808->regmap, RK808_RTC_CTRL_REG,\r\nBIT_RTC_CTRL_REG_STOP_RTC_M |\r\nBIT_RTC_CTRL_REG_RTC_READSEL_M,\r\nBIT_RTC_CTRL_REG_RTC_READSEL_M);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Failed to update RTC control: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_write(rk808->regmap, RK808_RTC_STATUS_REG,\r\nRTC_STATUS_MASK);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Failed to write RTC status: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = rk808_rtc_readtime(&pdev->dev, &tm);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to read RTC time\n");\r\nreturn ret;\r\n}\r\nret = rtc_valid_tm(&tm);\r\nif (ret)\r\ndev_warn(&pdev->dev, "invalid date/time\n");\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nrk808_rtc->rtc = devm_rtc_device_register(&pdev->dev, "rk808-rtc",\r\n&rk808_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rk808_rtc->rtc)) {\r\nret = PTR_ERR(rk808_rtc->rtc);\r\nreturn ret;\r\n}\r\nrk808_rtc->irq = platform_get_irq(pdev, 0);\r\nif (rk808_rtc->irq < 0) {\r\nif (rk808_rtc->irq != -EPROBE_DEFER)\r\ndev_err(&pdev->dev, "Wake up is not possible as irq = %d\n",\r\nrk808_rtc->irq);\r\nreturn rk808_rtc->irq;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, rk808_rtc->irq, NULL,\r\nrk808_alarm_irq, 0,\r\n"RTC alarm", rk808_rtc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request alarm IRQ %d: %d\n",\r\nrk808_rtc->irq, ret);\r\n}\r\nreturn ret;\r\n}

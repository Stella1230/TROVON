static int slram_erase(struct mtd_info *mtd, struct erase_info *instr)\r\n{\r\nslram_priv_t *priv = mtd->priv;\r\nmemset(priv->start + instr->addr, 0xff, instr->len);\r\ninstr->state = MTD_ERASE_DONE;\r\nmtd_erase_callback(instr);\r\nreturn(0);\r\n}\r\nstatic int slram_point(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, void **virt, resource_size_t *phys)\r\n{\r\nslram_priv_t *priv = mtd->priv;\r\n*virt = priv->start + from;\r\n*retlen = len;\r\nreturn(0);\r\n}\r\nstatic int slram_unpoint(struct mtd_info *mtd, loff_t from, size_t len)\r\n{\r\nreturn 0;\r\n}\r\nstatic int slram_read(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, u_char *buf)\r\n{\r\nslram_priv_t *priv = mtd->priv;\r\nmemcpy(buf, priv->start + from, len);\r\n*retlen = len;\r\nreturn(0);\r\n}\r\nstatic int slram_write(struct mtd_info *mtd, loff_t to, size_t len,\r\nsize_t *retlen, const u_char *buf)\r\n{\r\nslram_priv_t *priv = mtd->priv;\r\nmemcpy(priv->start + to, buf, len);\r\n*retlen = len;\r\nreturn(0);\r\n}\r\nstatic int register_device(char *name, unsigned long start, unsigned long length)\r\n{\r\nslram_mtd_list_t **curmtd;\r\ncurmtd = &slram_mtdlist;\r\nwhile (*curmtd) {\r\ncurmtd = &(*curmtd)->next;\r\n}\r\n*curmtd = kmalloc(sizeof(slram_mtd_list_t), GFP_KERNEL);\r\nif (!(*curmtd)) {\r\nE("slram: Cannot allocate new MTD device.\n");\r\nreturn(-ENOMEM);\r\n}\r\n(*curmtd)->mtdinfo = kzalloc(sizeof(struct mtd_info), GFP_KERNEL);\r\n(*curmtd)->next = NULL;\r\nif ((*curmtd)->mtdinfo) {\r\n(*curmtd)->mtdinfo->priv =\r\nkzalloc(sizeof(slram_priv_t), GFP_KERNEL);\r\nif (!(*curmtd)->mtdinfo->priv) {\r\nkfree((*curmtd)->mtdinfo);\r\n(*curmtd)->mtdinfo = NULL;\r\n}\r\n}\r\nif (!(*curmtd)->mtdinfo) {\r\nE("slram: Cannot allocate new MTD device.\n");\r\nreturn(-ENOMEM);\r\n}\r\nif (!(((slram_priv_t *)(*curmtd)->mtdinfo->priv)->start =\r\nioremap(start, length))) {\r\nE("slram: ioremap failed\n");\r\nreturn -EIO;\r\n}\r\n((slram_priv_t *)(*curmtd)->mtdinfo->priv)->end =\r\n((slram_priv_t *)(*curmtd)->mtdinfo->priv)->start + length;\r\n(*curmtd)->mtdinfo->name = name;\r\n(*curmtd)->mtdinfo->size = length;\r\n(*curmtd)->mtdinfo->flags = MTD_CAP_RAM;\r\n(*curmtd)->mtdinfo->_erase = slram_erase;\r\n(*curmtd)->mtdinfo->_point = slram_point;\r\n(*curmtd)->mtdinfo->_unpoint = slram_unpoint;\r\n(*curmtd)->mtdinfo->_read = slram_read;\r\n(*curmtd)->mtdinfo->_write = slram_write;\r\n(*curmtd)->mtdinfo->owner = THIS_MODULE;\r\n(*curmtd)->mtdinfo->type = MTD_RAM;\r\n(*curmtd)->mtdinfo->erasesize = SLRAM_BLK_SZ;\r\n(*curmtd)->mtdinfo->writesize = 1;\r\nif (mtd_device_register((*curmtd)->mtdinfo, NULL, 0)) {\r\nE("slram: Failed to register new device\n");\r\niounmap(((slram_priv_t *)(*curmtd)->mtdinfo->priv)->start);\r\nkfree((*curmtd)->mtdinfo->priv);\r\nkfree((*curmtd)->mtdinfo);\r\nreturn(-EAGAIN);\r\n}\r\nT("slram: Registered device %s from %luKiB to %luKiB\n", name,\r\n(start / 1024), ((start + length) / 1024));\r\nT("slram: Mapped from 0x%p to 0x%p\n",\r\n((slram_priv_t *)(*curmtd)->mtdinfo->priv)->start,\r\n((slram_priv_t *)(*curmtd)->mtdinfo->priv)->end);\r\nreturn(0);\r\n}\r\nstatic void unregister_devices(void)\r\n{\r\nslram_mtd_list_t *nextitem;\r\nwhile (slram_mtdlist) {\r\nnextitem = slram_mtdlist->next;\r\nmtd_device_unregister(slram_mtdlist->mtdinfo);\r\niounmap(((slram_priv_t *)slram_mtdlist->mtdinfo->priv)->start);\r\nkfree(slram_mtdlist->mtdinfo->priv);\r\nkfree(slram_mtdlist->mtdinfo);\r\nkfree(slram_mtdlist);\r\nslram_mtdlist = nextitem;\r\n}\r\n}\r\nstatic unsigned long handle_unit(unsigned long value, char *unit)\r\n{\r\nif ((*unit == 'M') || (*unit == 'm')) {\r\nreturn(value * 1024 * 1024);\r\n} else if ((*unit == 'K') || (*unit == 'k')) {\r\nreturn(value * 1024);\r\n}\r\nreturn(value);\r\n}\r\nstatic int parse_cmdline(char *devname, char *szstart, char *szlength)\r\n{\r\nchar *buffer;\r\nunsigned long devstart;\r\nunsigned long devlength;\r\nif ((!devname) || (!szstart) || (!szlength)) {\r\nunregister_devices();\r\nreturn(-EINVAL);\r\n}\r\ndevstart = simple_strtoul(szstart, &buffer, 0);\r\ndevstart = handle_unit(devstart, buffer);\r\nif (*(szlength) != '+') {\r\ndevlength = simple_strtoul(szlength, &buffer, 0);\r\ndevlength = handle_unit(devlength, buffer);\r\nif (devlength < devstart)\r\ngoto err_out;\r\ndevlength -= devstart;\r\n} else {\r\ndevlength = simple_strtoul(szlength + 1, &buffer, 0);\r\ndevlength = handle_unit(devlength, buffer);\r\n}\r\nT("slram: devname=%s, devstart=0x%lx, devlength=0x%lx\n",\r\ndevname, devstart, devlength);\r\nif (devlength % SLRAM_BLK_SZ != 0)\r\ngoto err_out;\r\nif ((devstart = register_device(devname, devstart, devlength))){\r\nunregister_devices();\r\nreturn((int)devstart);\r\n}\r\nreturn(0);\r\nerr_out:\r\nE("slram: Illegal length parameter.\n");\r\nreturn(-EINVAL);\r\n}\r\nstatic int __init mtd_slram_setup(char *str)\r\n{\r\nmap = str;\r\nreturn(1);\r\n}\r\nstatic int __init init_slram(void)\r\n{\r\nchar *devname;\r\n#ifndef MODULE\r\nchar *devstart;\r\nchar *devlength;\r\nif (!map) {\r\nE("slram: not enough parameters.\n");\r\nreturn(-EINVAL);\r\n}\r\nwhile (map) {\r\ndevname = devstart = devlength = NULL;\r\nif (!(devname = strsep(&map, ","))) {\r\nE("slram: No devicename specified.\n");\r\nbreak;\r\n}\r\nT("slram: devname = %s\n", devname);\r\nif ((!map) || (!(devstart = strsep(&map, ",")))) {\r\nE("slram: No devicestart specified.\n");\r\n}\r\nT("slram: devstart = %s\n", devstart);\r\nif ((!map) || (!(devlength = strsep(&map, ",")))) {\r\nE("slram: No devicelength / -end specified.\n");\r\n}\r\nT("slram: devlength = %s\n", devlength);\r\nif (parse_cmdline(devname, devstart, devlength) != 0) {\r\nreturn(-EINVAL);\r\n}\r\n}\r\n#else\r\nint count;\r\nint i;\r\nfor (count = 0; count < SLRAM_MAX_DEVICES_PARAMS && map[count];\r\ncount++) {\r\n}\r\nif ((count % 3 != 0) || (count == 0)) {\r\nE("slram: not enough parameters.\n");\r\nreturn(-EINVAL);\r\n}\r\nfor (i = 0; i < (count / 3); i++) {\r\ndevname = map[i * 3];\r\nif (parse_cmdline(devname, map[i * 3 + 1], map[i * 3 + 2])!=0) {\r\nreturn(-EINVAL);\r\n}\r\n}\r\n#endif\r\nreturn(0);\r\n}\r\nstatic void __exit cleanup_slram(void)\r\n{\r\nunregister_devices();\r\n}

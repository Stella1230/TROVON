static unsigned int da9063_wdt_timeout_to_sel(unsigned int secs)\r\n{\r\nunsigned int i;\r\nfor (i = DA9063_TWDSCALE_MIN; i <= DA9063_TWDSCALE_MAX; i++) {\r\nif (wdt_timeout[i] >= secs)\r\nreturn i;\r\n}\r\nreturn DA9063_TWDSCALE_MAX;\r\n}\r\nstatic int _da9063_wdt_set_timeout(struct da9063 *da9063, unsigned int regval)\r\n{\r\nreturn regmap_update_bits(da9063->regmap, DA9063_REG_CONTROL_D,\r\nDA9063_TWDSCALE_MASK, regval);\r\n}\r\nstatic int da9063_wdt_start(struct watchdog_device *wdd)\r\n{\r\nstruct da9063_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nunsigned int selector;\r\nint ret;\r\nselector = da9063_wdt_timeout_to_sel(wdt->wdtdev.timeout);\r\nret = _da9063_wdt_set_timeout(wdt->da9063, selector);\r\nif (ret)\r\ndev_err(wdt->da9063->dev, "Watchdog failed to start (err = %d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int da9063_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nstruct da9063_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nint ret;\r\nret = regmap_update_bits(wdt->da9063->regmap, DA9063_REG_CONTROL_D,\r\nDA9063_TWDSCALE_MASK, DA9063_TWDSCALE_DISABLE);\r\nif (ret)\r\ndev_alert(wdt->da9063->dev, "Watchdog failed to stop (err = %d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int da9063_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nstruct da9063_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nint ret;\r\nret = regmap_write(wdt->da9063->regmap, DA9063_REG_CONTROL_F,\r\nDA9063_WATCHDOG);\r\nif (ret)\r\ndev_alert(wdt->da9063->dev, "Failed to ping the watchdog (err = %d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int da9063_wdt_set_timeout(struct watchdog_device *wdd,\r\nunsigned int timeout)\r\n{\r\nstruct da9063_watchdog *wdt = watchdog_get_drvdata(wdd);\r\nunsigned int selector;\r\nint ret;\r\nselector = da9063_wdt_timeout_to_sel(timeout);\r\nret = _da9063_wdt_set_timeout(wdt->da9063, selector);\r\nif (ret)\r\ndev_err(wdt->da9063->dev, "Failed to set watchdog timeout (err = %d)\n",\r\nret);\r\nelse\r\nwdd->timeout = wdt_timeout[selector];\r\nreturn ret;\r\n}\r\nstatic int da9063_wdt_restart_handler(struct notifier_block *this,\r\nunsigned long mode, void *cmd)\r\n{\r\nstruct da9063_watchdog *wdt = container_of(this,\r\nstruct da9063_watchdog,\r\nrestart_handler);\r\nint ret;\r\nret = regmap_write(wdt->da9063->regmap, DA9063_REG_CONTROL_F,\r\nDA9063_SHUTDOWN);\r\nif (ret)\r\ndev_alert(wdt->da9063->dev, "Failed to shutdown (err = %d)\n",\r\nret);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int da9063_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct da9063 *da9063;\r\nstruct da9063_watchdog *wdt;\r\nif (!pdev->dev.parent)\r\nreturn -EINVAL;\r\nda9063 = dev_get_drvdata(pdev->dev.parent);\r\nif (!da9063)\r\nreturn -EINVAL;\r\nwdt = devm_kzalloc(&pdev->dev, sizeof(*wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nwdt->da9063 = da9063;\r\nwdt->wdtdev.info = &da9063_watchdog_info;\r\nwdt->wdtdev.ops = &da9063_watchdog_ops;\r\nwdt->wdtdev.min_timeout = DA9063_WDT_MIN_TIMEOUT;\r\nwdt->wdtdev.max_timeout = DA9063_WDT_MAX_TIMEOUT;\r\nwdt->wdtdev.timeout = DA9063_WDG_TIMEOUT;\r\nwdt->wdtdev.status = WATCHDOG_NOWAYOUT_INIT_STATUS;\r\nwatchdog_set_drvdata(&wdt->wdtdev, wdt);\r\ndev_set_drvdata(&pdev->dev, wdt);\r\nret = watchdog_register_device(&wdt->wdtdev);\r\nif (ret)\r\nreturn ret;\r\nwdt->restart_handler.notifier_call = da9063_wdt_restart_handler;\r\nwdt->restart_handler.priority = 128;\r\nret = register_restart_handler(&wdt->restart_handler);\r\nif (ret)\r\ndev_err(wdt->da9063->dev,\r\n"Failed to register restart handler (err = %d)\n", ret);\r\nreturn 0;\r\n}\r\nstatic int da9063_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct da9063_watchdog *wdt = dev_get_drvdata(&pdev->dev);\r\nunregister_restart_handler(&wdt->restart_handler);\r\nwatchdog_unregister_device(&wdt->wdtdev);\r\nreturn 0;\r\n}

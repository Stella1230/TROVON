void __init via_init(void)\r\n{\r\nswitch(macintosh_config->via_type) {\r\ncase MAC_VIA_IICI:\r\nvia1 = (void *) VIA1_BASE;\r\nif (macintosh_config->ident == MAC_MODEL_IIFX) {\r\nvia2 = NULL;\r\nrbv_present = 0;\r\noss_present = 1;\r\n} else {\r\nvia2 = (void *) RBV_BASE;\r\nrbv_present = 1;\r\noss_present = 0;\r\n}\r\nif (macintosh_config->ident == MAC_MODEL_LCIII) {\r\nrbv_clear = 0x00;\r\n} else {\r\nrbv_clear = 0x80;\r\n}\r\ngIER = rIER;\r\ngIFR = rIFR;\r\ngBufA = rSIFR;\r\ngBufB = rBufB;\r\nbreak;\r\ncase MAC_VIA_QUADRA:\r\ncase MAC_VIA_II:\r\nvia1 = (void *) VIA1_BASE;\r\nvia2 = (void *) VIA2_BASE;\r\nrbv_present = 0;\r\noss_present = 0;\r\nrbv_clear = 0x00;\r\ngIER = vIER;\r\ngIFR = vIFR;\r\ngBufA = vBufA;\r\ngBufB = vBufB;\r\nbreak;\r\ndefault:\r\npanic("UNKNOWN VIA TYPE");\r\n}\r\nprintk(KERN_INFO "VIA1 at %p is a 6522 or clone\n", via1);\r\nprintk(KERN_INFO "VIA2 at %p is ", via2);\r\nif (rbv_present) {\r\nprintk("an RBV\n");\r\n} else if (oss_present) {\r\nprintk("an OSS\n");\r\n} else {\r\nprintk("a 6522 or clone\n");\r\n}\r\n#ifdef DEBUG_VIA\r\nvia_debug_dump();\r\n#endif\r\nvia1[vIER] = 0x7F;\r\nvia1[vIFR] = 0x7F;\r\nvia1[vT1LL] = 0;\r\nvia1[vT1LH] = 0;\r\nvia1[vT1CL] = 0;\r\nvia1[vT1CH] = 0;\r\nvia1[vT2CL] = 0;\r\nvia1[vT2CH] = 0;\r\nvia1[vACR] &= ~0xC0;\r\nvia1[vACR] &= ~0x03;\r\nif (macintosh_config->ident == MAC_MODEL_SE30) {\r\nvia1[vDirB] |= 0x40;\r\nvia1[vBufB] |= 0x40;\r\n}\r\nvia1[vDirB] |= (VIA1B_vRTCEnb | VIA1B_vRTCClk | VIA1B_vRTCData);\r\nvia1[vBufB] |= (VIA1B_vRTCEnb | VIA1B_vRTCClk);\r\nif (oss_present)\r\nreturn;\r\nif ((macintosh_config->via_type == MAC_VIA_QUADRA) &&\r\n(macintosh_config->adb_type != MAC_ADB_PB1) &&\r\n(macintosh_config->adb_type != MAC_ADB_PB2) &&\r\n(macintosh_config->ident != MAC_MODEL_C660) &&\r\n(macintosh_config->ident != MAC_MODEL_Q840)) {\r\nvia_alt_mapping = 1;\r\nvia1[vDirB] |= 0x40;\r\nvia1[vBufB] &= ~0x40;\r\n} else {\r\nvia_alt_mapping = 0;\r\n}\r\nvia2[gIER] = 0x7F;\r\nvia2[gIFR] = 0x7F | rbv_clear;\r\nif (!rbv_present) {\r\nvia2[vT1LL] = 0;\r\nvia2[vT1LH] = 0;\r\nvia2[vT1CL] = 0;\r\nvia2[vT1CH] = 0;\r\nvia2[vT2CL] = 0;\r\nvia2[vT2CH] = 0;\r\nvia2[vACR] &= ~0xC0;\r\nvia2[vACR] &= ~0x03;\r\n}\r\nif (rbv_present)\r\nreturn;\r\npr_debug("VIA2 vPCR is 0x%02X\n", via2[vPCR]);\r\nif (macintosh_config->via_type == MAC_VIA_II) {\r\nvia2[vPCR] = 0x66;\r\n} else {\r\nvia2[vPCR] = 0x22;\r\n}\r\n}\r\nvoid __init via_init_clock(irq_handler_t func)\r\n{\r\nvia1[vACR] |= 0x40;\r\nvia1[vT1LL] = MAC_CLOCK_LOW;\r\nvia1[vT1LH] = MAC_CLOCK_HIGH;\r\nvia1[vT1CL] = MAC_CLOCK_LOW;\r\nvia1[vT1CH] = MAC_CLOCK_HIGH;\r\nif (request_irq(IRQ_MAC_TIMER_1, func, 0, "timer", func))\r\npr_err("Couldn't register %s interrupt\n", "timer");\r\n}\r\nvoid via_debug_dump(void)\r\n{\r\nprintk(KERN_DEBUG "VIA1: DDRA = 0x%02X DDRB = 0x%02X ACR = 0x%02X\n",\r\n(uint) via1[vDirA], (uint) via1[vDirB], (uint) via1[vACR]);\r\nprintk(KERN_DEBUG " PCR = 0x%02X IFR = 0x%02X IER = 0x%02X\n",\r\n(uint) via1[vPCR], (uint) via1[vIFR], (uint) via1[vIER]);\r\nif (oss_present) {\r\nprintk(KERN_DEBUG "VIA2: <OSS>\n");\r\n} else if (rbv_present) {\r\nprintk(KERN_DEBUG "VIA2: IFR = 0x%02X IER = 0x%02X\n",\r\n(uint) via2[rIFR], (uint) via2[rIER]);\r\nprintk(KERN_DEBUG " SIFR = 0x%02X SIER = 0x%02X\n",\r\n(uint) via2[rSIFR], (uint) via2[rSIER]);\r\n} else {\r\nprintk(KERN_DEBUG "VIA2: DDRA = 0x%02X DDRB = 0x%02X ACR = 0x%02X\n",\r\n(uint) via2[vDirA], (uint) via2[vDirB],\r\n(uint) via2[vACR]);\r\nprintk(KERN_DEBUG " PCR = 0x%02X IFR = 0x%02X IER = 0x%02X\n",\r\n(uint) via2[vPCR],\r\n(uint) via2[vIFR], (uint) via2[vIER]);\r\n}\r\n}\r\nu32 mac_gettimeoffset(void)\r\n{\r\nunsigned long ticks, offset = 0;\r\nticks = via1[vT1CL] | (via1[vT1CH] << 8);\r\nif (ticks > MAC_CLOCK_TICK - MAC_CLOCK_TICK / 50)\r\nif (via1[vIFR] & 0x40) offset = TICK_SIZE;\r\nticks = MAC_CLOCK_TICK - ticks;\r\nticks = ticks * 10000L / MAC_CLOCK_TICK;\r\nreturn (ticks + offset) * 1000;\r\n}\r\nvoid via_flush_cache(void)\r\n{\r\nvia2[gBufB] &= ~VIA2B_vMode32;\r\nvia2[gBufB] |= VIA2B_vMode32;\r\n}\r\nint via_get_cache_disable(void)\r\n{\r\nif (!via2) {\r\nprintk(KERN_ERR "via_get_cache_disable called on a non-VIA machine!\n");\r\nreturn 1;\r\n}\r\nreturn (int) via2[gBufB] & VIA2B_vCDis;\r\n}\r\nvoid __init via_nubus_init(void)\r\n{\r\nif ((macintosh_config->adb_type != MAC_ADB_PB1) &&\r\n(macintosh_config->adb_type != MAC_ADB_PB2)) {\r\nif (!rbv_present)\r\nvia2[vDirB] |= 0x02;\r\nvia2[gBufB] |= 0x02;\r\n}\r\nswitch (macintosh_config->via_type) {\r\ncase MAC_VIA_II:\r\ncase MAC_VIA_QUADRA:\r\npr_debug("VIA2 vDirA is 0x%02X\n", via2[vDirA]);\r\nbreak;\r\ncase MAC_VIA_IICI:\r\nvia2[rSIER] = 0x7F;\r\nbreak;\r\n}\r\n}\r\nvoid via_nubus_irq_startup(int irq)\r\n{\r\nint irq_idx = IRQ_IDX(irq);\r\nswitch (macintosh_config->via_type) {\r\ncase MAC_VIA_II:\r\ncase MAC_VIA_QUADRA:\r\nif (macintosh_config->via_type == MAC_VIA_II) {\r\nvia2[vDirA] &= 0xC0 | ~(1 << irq_idx);\r\n} else {\r\nvia2[vDirA] &= 0x80 | ~(1 << irq_idx);\r\n}\r\ncase MAC_VIA_IICI:\r\nvia_irq_enable(irq);\r\nbreak;\r\n}\r\n}\r\nvoid via_nubus_irq_shutdown(int irq)\r\n{\r\nswitch (macintosh_config->via_type) {\r\ncase MAC_VIA_II:\r\ncase MAC_VIA_QUADRA:\r\nvia_irq_enable(irq);\r\nbreak;\r\ncase MAC_VIA_IICI:\r\nvia_irq_disable(irq);\r\nbreak;\r\n}\r\n}\r\nvoid via1_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nint irq_num;\r\nunsigned char irq_bit, events;\r\nevents = via1[vIFR] & via1[vIER] & 0x7F;\r\nif (!events)\r\nreturn;\r\nirq_num = VIA1_SOURCE_BASE;\r\nirq_bit = 1;\r\ndo {\r\nif (events & irq_bit) {\r\nvia1[vIFR] = irq_bit;\r\ngeneric_handle_irq(irq_num);\r\n}\r\n++irq_num;\r\nirq_bit <<= 1;\r\n} while (events >= irq_bit);\r\n}\r\nstatic void via2_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nint irq_num;\r\nunsigned char irq_bit, events;\r\nevents = via2[gIFR] & via2[gIER] & 0x7F;\r\nif (!events)\r\nreturn;\r\nirq_num = VIA2_SOURCE_BASE;\r\nirq_bit = 1;\r\ndo {\r\nif (events & irq_bit) {\r\nvia2[gIFR] = irq_bit | rbv_clear;\r\ngeneric_handle_irq(irq_num);\r\n}\r\n++irq_num;\r\nirq_bit <<= 1;\r\n} while (events >= irq_bit);\r\n}\r\nvoid via_nubus_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nint slot_irq;\r\nunsigned char slot_bit, events;\r\nevents = ~via2[gBufA] & 0x7F;\r\nif (rbv_present)\r\nevents &= via2[rSIER];\r\nelse\r\nevents &= ~via2[vDirA];\r\nif (!events)\r\nreturn;\r\ndo {\r\nslot_irq = IRQ_NUBUS_F;\r\nslot_bit = 0x40;\r\ndo {\r\nif (events & slot_bit) {\r\nevents &= ~slot_bit;\r\ngeneric_handle_irq(slot_irq);\r\n}\r\n--slot_irq;\r\nslot_bit >>= 1;\r\n} while (events);\r\nvia2[gIFR] = 0x02 | rbv_clear;\r\nevents = ~via2[gBufA] & 0x7F;\r\nif (rbv_present)\r\nevents &= via2[rSIER];\r\nelse\r\nevents &= ~via2[vDirA];\r\n} while (events);\r\n}\r\nvoid __init via_register_interrupts(void)\r\n{\r\nif (via_alt_mapping) {\r\nirq_set_chained_handler(IRQ_AUTO_1, via1_irq);\r\nirq_set_chained_handler(IRQ_AUTO_6, via1_irq);\r\n} else {\r\nirq_set_chained_handler(IRQ_AUTO_1, via1_irq);\r\n}\r\nirq_set_chained_handler(IRQ_AUTO_2, via2_irq);\r\nirq_set_chained_handler(IRQ_MAC_NUBUS, via_nubus_irq);\r\n}\r\nvoid via_irq_enable(int irq) {\r\nint irq_src = IRQ_SRC(irq);\r\nint irq_idx = IRQ_IDX(irq);\r\n#ifdef DEBUG_IRQUSE\r\nprintk(KERN_DEBUG "via_irq_enable(%d)\n", irq);\r\n#endif\r\nif (irq_src == 1) {\r\nvia1[vIER] = IER_SET_BIT(irq_idx);\r\n} else if (irq_src == 2) {\r\nif (irq != IRQ_MAC_NUBUS || nubus_disabled == 0)\r\nvia2[gIER] = IER_SET_BIT(irq_idx);\r\n} else if (irq_src == 7) {\r\nswitch (macintosh_config->via_type) {\r\ncase MAC_VIA_II:\r\ncase MAC_VIA_QUADRA:\r\nnubus_disabled &= ~(1 << irq_idx);\r\nif (!nubus_disabled)\r\nvia2[gIER] = IER_SET_BIT(1);\r\nbreak;\r\ncase MAC_VIA_IICI:\r\nvia2[rSIER] = IER_SET_BIT(irq_idx);\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid via_irq_disable(int irq) {\r\nint irq_src = IRQ_SRC(irq);\r\nint irq_idx = IRQ_IDX(irq);\r\n#ifdef DEBUG_IRQUSE\r\nprintk(KERN_DEBUG "via_irq_disable(%d)\n", irq);\r\n#endif\r\nif (irq_src == 1) {\r\nvia1[vIER] = IER_CLR_BIT(irq_idx);\r\n} else if (irq_src == 2) {\r\nvia2[gIER] = IER_CLR_BIT(irq_idx);\r\n} else if (irq_src == 7) {\r\nswitch (macintosh_config->via_type) {\r\ncase MAC_VIA_II:\r\ncase MAC_VIA_QUADRA:\r\nnubus_disabled |= 1 << irq_idx;\r\nif (nubus_disabled)\r\nvia2[gIER] = IER_CLR_BIT(1);\r\nbreak;\r\ncase MAC_VIA_IICI:\r\nvia2[rSIER] = IER_CLR_BIT(irq_idx);\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid via1_set_head(int head)\r\n{\r\nif (head == 0)\r\nvia1[vBufA] &= ~VIA1A_vHeadSel;\r\nelse\r\nvia1[vBufA] |= VIA1A_vHeadSel;\r\n}\r\nint via2_scsi_drq_pending(void)\r\n{\r\nreturn via2[gIFR] & (1 << IRQ_IDX(IRQ_MAC_SCSIDRQ));\r\n}

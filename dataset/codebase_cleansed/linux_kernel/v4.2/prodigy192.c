static inline void stac9460_put(struct snd_ice1712 *ice, int reg, unsigned char val)\r\n{\r\nsnd_vt1724_write_i2c(ice, PRODIGY192_STAC9460_ADDR, reg, val);\r\n}\r\nstatic inline unsigned char stac9460_get(struct snd_ice1712 *ice, int reg)\r\n{\r\nreturn snd_vt1724_read_i2c(ice, PRODIGY192_STAC9460_ADDR, reg);\r\n}\r\nstatic int stac9460_dac_mute(struct snd_ice1712 *ice, int idx,\r\nunsigned char mute)\r\n{\r\nunsigned char new, old;\r\nint change;\r\nold = stac9460_get(ice, idx);\r\nnew = (~mute << 7 & 0x80) | (old & ~0x80);\r\nchange = (new != old);\r\nif (change)\r\nstac9460_put(ice, idx, new);\r\nreturn change;\r\n}\r\nstatic int stac9460_dac_mute_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nint idx;\r\nif (kcontrol->private_value)\r\nidx = STAC946X_MASTER_VOLUME;\r\nelse\r\nidx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id) + STAC946X_LF_VOLUME;\r\nval = stac9460_get(ice, idx);\r\nucontrol->value.integer.value[0] = (~val >> 7) & 0x1;\r\nreturn 0;\r\n}\r\nstatic int stac9460_dac_mute_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nstruct prodigy192_spec *spec = ice->spec;\r\nint idx, change;\r\nif (kcontrol->private_value)\r\nidx = STAC946X_MASTER_VOLUME;\r\nelse\r\nidx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id) + STAC946X_LF_VOLUME;\r\nmutex_lock(&spec->mute_mutex);\r\nchange = stac9460_dac_mute(ice, idx, ucontrol->value.integer.value[0]);\r\nmutex_unlock(&spec->mute_mutex);\r\nreturn change;\r\n}\r\nstatic int stac9460_dac_vol_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 0x7f;\r\nreturn 0;\r\n}\r\nstatic int stac9460_dac_vol_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint idx;\r\nunsigned char vol;\r\nif (kcontrol->private_value)\r\nidx = STAC946X_MASTER_VOLUME;\r\nelse\r\nidx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id) + STAC946X_LF_VOLUME;\r\nvol = stac9460_get(ice, idx) & 0x7f;\r\nucontrol->value.integer.value[0] = 0x7f - vol;\r\nreturn 0;\r\n}\r\nstatic int stac9460_dac_vol_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint idx;\r\nunsigned char tmp, ovol, nvol;\r\nint change;\r\nif (kcontrol->private_value)\r\nidx = STAC946X_MASTER_VOLUME;\r\nelse\r\nidx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id) + STAC946X_LF_VOLUME;\r\nnvol = ucontrol->value.integer.value[0];\r\ntmp = stac9460_get(ice, idx);\r\novol = 0x7f - (tmp & 0x7f);\r\nchange = (ovol != nvol);\r\nif (change) {\r\novol = (0x7f - nvol) | (tmp & 0x80);\r\nstac9460_put(ice, idx, (0x7f - nvol) | (tmp & 0x80));\r\n}\r\nreturn change;\r\n}\r\nstatic int stac9460_adc_mute_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nint i;\r\nfor (i = 0; i < 2; ++i) {\r\nval = stac9460_get(ice, STAC946X_MIC_L_VOLUME + i);\r\nucontrol->value.integer.value[i] = ~val>>7 & 0x1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stac9460_adc_mute_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char new, old;\r\nint i, reg;\r\nint change;\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nold = stac9460_get(ice, reg);\r\nnew = (~ucontrol->value.integer.value[i]<<7&0x80) | (old&~0x80);\r\nchange = (new != old);\r\nif (change)\r\nstac9460_put(ice, reg, new);\r\n}\r\nreturn change;\r\n}\r\nstatic int stac9460_adc_vol_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 0x0f;\r\nreturn 0;\r\n}\r\nstatic int stac9460_adc_vol_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint i, reg;\r\nunsigned char vol;\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nvol = stac9460_get(ice, reg) & 0x0f;\r\nucontrol->value.integer.value[i] = 0x0f - vol;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stac9460_adc_vol_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint i, reg;\r\nunsigned char ovol, nvol;\r\nint change;\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nnvol = ucontrol->value.integer.value[i] & 0x0f;\r\novol = 0x0f - stac9460_get(ice, reg);\r\nchange = ((ovol & 0x0f) != nvol);\r\nif (change)\r\nstac9460_put(ice, reg, (0x0f - nvol) | (ovol & ~0x0f));\r\n}\r\nreturn change;\r\n}\r\nstatic int stac9460_mic_sw_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[2] = { "Line In", "Mic" };\r\nreturn snd_ctl_enum_info(uinfo, 1, 2, texts);\r\n}\r\nstatic int stac9460_mic_sw_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nval = stac9460_get(ice, STAC946X_GENERAL_PURPOSE);\r\nucontrol->value.enumerated.item[0] = (val >> 7) & 0x1;\r\nreturn 0;\r\n}\r\nstatic int stac9460_mic_sw_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char new, old;\r\nint change;\r\nold = stac9460_get(ice, STAC946X_GENERAL_PURPOSE);\r\nnew = (ucontrol->value.enumerated.item[0] << 7 & 0x80) | (old & ~0x80);\r\nchange = (new != old);\r\nif (change)\r\nstac9460_put(ice, STAC946X_GENERAL_PURPOSE, new);\r\nreturn change;\r\n}\r\nstatic void stac9460_set_rate_val(struct snd_ice1712 *ice, unsigned int rate)\r\n{\r\nunsigned char old, new;\r\nint idx;\r\nunsigned char changed[7];\r\nstruct prodigy192_spec *spec = ice->spec;\r\nif (rate == 0)\r\nreturn;\r\nelse if (rate <= 48000)\r\nnew = 0x08;\r\nelse if (rate <= 96000)\r\nnew = 0x11;\r\nelse\r\nnew = 0x12;\r\nold = stac9460_get(ice, STAC946X_MASTER_CLOCKING);\r\nif (old == new)\r\nreturn;\r\nmutex_lock(&spec->mute_mutex);\r\nfor (idx = 0; idx < 7 ; ++idx)\r\nchanged[idx] = stac9460_dac_mute(ice,\r\nSTAC946X_MASTER_VOLUME + idx, 0);\r\nstac9460_put(ice, STAC946X_MASTER_CLOCKING, new);\r\nudelay(10);\r\nfor (idx = 0; idx < 7 ; ++idx) {\r\nif (changed[idx])\r\nstac9460_dac_mute(ice, STAC946X_MASTER_VOLUME + idx, 1);\r\n}\r\nmutex_unlock(&spec->mute_mutex);\r\n}\r\nstatic void write_data(struct snd_ice1712 *ice, unsigned int gpio,\r\nunsigned int data, int idx)\r\n{\r\nfor (; idx >= 0; idx--) {\r\ngpio &= ~VT1724_PRODIGY192_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\nif (data & (1 << idx))\r\ngpio |= VT1724_PRODIGY192_CDOUT;\r\nelse\r\ngpio &= ~VT1724_PRODIGY192_CDOUT;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\ngpio |= VT1724_PRODIGY192_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\n}\r\n}\r\nstatic unsigned char read_data(struct snd_ice1712 *ice, unsigned int gpio,\r\nint idx)\r\n{\r\nunsigned char data = 0;\r\nfor (; idx >= 0; idx--) {\r\ngpio &= ~VT1724_PRODIGY192_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\nif (snd_ice1712_gpio_read(ice) & VT1724_PRODIGY192_CDIN)\r\ndata |= (1 << idx);\r\nudelay(1);\r\ngpio |= VT1724_PRODIGY192_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\n}\r\nreturn data;\r\n}\r\nstatic unsigned int prodigy192_4wire_start(struct snd_ice1712 *ice)\r\n{\r\nunsigned int tmp;\r\nsnd_ice1712_save_gpio_status(ice);\r\ntmp = snd_ice1712_gpio_read(ice);\r\ntmp |= VT1724_PRODIGY192_CCLK;\r\ntmp &= ~VT1724_PRODIGY192_CS;\r\nsnd_ice1712_gpio_write(ice, tmp);\r\nudelay(1);\r\nreturn tmp;\r\n}\r\nstatic void prodigy192_4wire_finish(struct snd_ice1712 *ice, unsigned int tmp)\r\n{\r\ntmp |= VT1724_PRODIGY192_CS;\r\nsnd_ice1712_gpio_write(ice, tmp);\r\nudelay(1);\r\nsnd_ice1712_restore_gpio_status(ice);\r\n}\r\nstatic void prodigy192_ak4114_write(void *private_data, unsigned char addr,\r\nunsigned char data)\r\n{\r\nstruct snd_ice1712 *ice = private_data;\r\nunsigned int tmp, addrdata;\r\ntmp = prodigy192_4wire_start(ice);\r\naddrdata = (AK4114_ADDR << 6) | 0x20 | (addr & 0x1f);\r\naddrdata = (addrdata << 8) | data;\r\nwrite_data(ice, tmp, addrdata, 15);\r\nprodigy192_4wire_finish(ice, tmp);\r\n}\r\nstatic unsigned char prodigy192_ak4114_read(void *private_data,\r\nunsigned char addr)\r\n{\r\nstruct snd_ice1712 *ice = private_data;\r\nunsigned int tmp;\r\nunsigned char data;\r\ntmp = prodigy192_4wire_start(ice);\r\nwrite_data(ice, tmp, (AK4114_ADDR << 6) | (addr & 0x1f), 7);\r\ndata = read_data(ice, tmp, 7);\r\nprodigy192_4wire_finish(ice, tmp);\r\nreturn data;\r\n}\r\nstatic int ak4114_input_sw_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[2] = { "Toslink", "Coax" };\r\nreturn snd_ctl_enum_info(uinfo, 1, 2, texts);\r\n}\r\nstatic int ak4114_input_sw_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nval = prodigy192_ak4114_read(ice, AK4114_REG_IO1);\r\nucontrol->value.enumerated.item[0] = (val & AK4114_IPS0) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int ak4114_input_sw_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char new, old, itemvalue;\r\nint change;\r\nold = prodigy192_ak4114_read(ice, AK4114_REG_IO1);\r\nitemvalue = (ucontrol->value.enumerated.item[0]) ? 0xff : 0x00;\r\nnew = (itemvalue & AK4114_IPS0) | (old & ~AK4114_IPS0);\r\nchange = (new != old);\r\nif (change)\r\nprodigy192_ak4114_write(ice, AK4114_REG_IO1, new);\r\nreturn change;\r\n}\r\nstatic int prodigy192_ak4114_init(struct snd_ice1712 *ice)\r\n{\r\nstatic const unsigned char ak4114_init_vals[] = {\r\nAK4114_RST | AK4114_PWN | AK4114_OCKS0 | AK4114_OCKS1,\r\nAK4114_DIF_I24I2S | AK4114_DEM0 ,\r\nAK4114_TX1E,\r\nAK4114_EFH_1024 | AK4114_DIT,\r\n0,\r\n0\r\n};\r\nstatic const unsigned char ak4114_init_txcsb[] = {\r\n0x41, 0x02, 0x2c, 0x00, 0x00\r\n};\r\nstruct prodigy192_spec *spec = ice->spec;\r\nint err;\r\nerr = snd_ak4114_create(ice->card,\r\nprodigy192_ak4114_read,\r\nprodigy192_ak4114_write,\r\nak4114_init_vals, ak4114_init_txcsb,\r\nice, &spec->ak4114);\r\nif (err < 0)\r\nreturn err;\r\nspec->ak4114->check_flags = AK4114_CHECK_NO_RATE;\r\nreturn 0;\r\n}\r\nstatic void stac9460_proc_regs_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ice1712 *ice = entry->private_data;\r\nint reg, val;\r\nfor (reg = 0; reg <= 0x15; reg++) {\r\nval = stac9460_get(ice, reg);\r\nsnd_iprintf(buffer, "0x%02x = 0x%02x\n", reg, val);\r\n}\r\n}\r\nstatic void stac9460_proc_init(struct snd_ice1712 *ice)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (!snd_card_proc_new(ice->card, "stac9460_codec", &entry))\r\nsnd_info_set_text_ops(entry, ice, stac9460_proc_regs_read);\r\n}\r\nstatic int prodigy192_add_controls(struct snd_ice1712 *ice)\r\n{\r\nstruct prodigy192_spec *spec = ice->spec;\r\nunsigned int i;\r\nint err;\r\nfor (i = 0; i < ARRAY_SIZE(stac_controls); i++) {\r\nerr = snd_ctl_add(ice->card,\r\nsnd_ctl_new1(&stac_controls[i], ice));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (spec->ak4114) {\r\nfor (i = 0; i < ARRAY_SIZE(ak4114_controls); i++) {\r\nerr = snd_ctl_add(ice->card,\r\nsnd_ctl_new1(&ak4114_controls[i],\r\nice));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nerr = snd_ak4114_build(spec->ak4114,\r\nNULL,\r\nice->pcm->streams[SNDRV_PCM_STREAM_CAPTURE].substream);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nstac9460_proc_init(ice);\r\nreturn 0;\r\n}\r\nstatic int prodigy192_miodio_exists(struct snd_ice1712 *ice)\r\n{\r\nunsigned char orig_value;\r\nconst unsigned char test_data = 0xd1;\r\nunsigned char addr = AK4114_REG_INT0_MASK;\r\nint exists = 0;\r\norig_value = prodigy192_ak4114_read(ice, addr);\r\nprodigy192_ak4114_write(ice, addr, test_data);\r\nif (prodigy192_ak4114_read(ice, addr) == test_data) {\r\nprodigy192_ak4114_write(ice, addr, orig_value);\r\nexists = 1;\r\n}\r\nreturn exists;\r\n}\r\nstatic int prodigy192_init(struct snd_ice1712 *ice)\r\n{\r\nstatic const unsigned short stac_inits_prodigy[] = {\r\nSTAC946X_RESET, 0,\r\nSTAC946X_MASTER_CLOCKING, 0x11,\r\n(unsigned short)-1\r\n};\r\nconst unsigned short *p;\r\nint err = 0;\r\nstruct prodigy192_spec *spec;\r\nice->num_total_dacs = 6;\r\nice->num_total_adcs = 2;\r\nice->vt1720 = 0;\r\nspec = kzalloc(sizeof(*spec), GFP_KERNEL);\r\nif (!spec)\r\nreturn -ENOMEM;\r\nice->spec = spec;\r\nmutex_init(&spec->mute_mutex);\r\np = stac_inits_prodigy;\r\nfor (; *p != (unsigned short)-1; p += 2)\r\nstac9460_put(ice, p[0], p[1]);\r\nice->gpio.set_pro_rate = stac9460_set_rate_val;\r\nif (prodigy192_miodio_exists(ice)) {\r\nerr = prodigy192_ak4114_init(ice);\r\ndev_dbg(ice->card->dev,\r\n"AK4114 initialized with status %d\n", err);\r\n} else\r\ndev_dbg(ice->card->dev, "AK4114 not found\n");\r\nreturn err;\r\n}

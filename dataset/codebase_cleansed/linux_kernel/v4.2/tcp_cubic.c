static inline void bictcp_reset(struct bictcp *ca)\r\n{\r\nca->cnt = 0;\r\nca->last_max_cwnd = 0;\r\nca->last_cwnd = 0;\r\nca->last_time = 0;\r\nca->bic_origin_point = 0;\r\nca->bic_K = 0;\r\nca->delay_min = 0;\r\nca->epoch_start = 0;\r\nca->ack_cnt = 0;\r\nca->tcp_cwnd = 0;\r\nca->found = 0;\r\n}\r\nstatic inline u32 bictcp_clock(void)\r\n{\r\n#if HZ < 1000\r\nreturn ktime_to_ms(ktime_get_real());\r\n#else\r\nreturn jiffies_to_msecs(jiffies);\r\n#endif\r\n}\r\nstatic inline void bictcp_hystart_reset(struct sock *sk)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct bictcp *ca = inet_csk_ca(sk);\r\nca->round_start = ca->last_ack = bictcp_clock();\r\nca->end_seq = tp->snd_nxt;\r\nca->curr_rtt = 0;\r\nca->sample_cnt = 0;\r\n}\r\nstatic void bictcp_init(struct sock *sk)\r\n{\r\nstruct bictcp *ca = inet_csk_ca(sk);\r\nbictcp_reset(ca);\r\nca->loss_cwnd = 0;\r\nif (hystart)\r\nbictcp_hystart_reset(sk);\r\nif (!hystart && initial_ssthresh)\r\ntcp_sk(sk)->snd_ssthresh = initial_ssthresh;\r\n}\r\nstatic u32 cubic_root(u64 a)\r\n{\r\nu32 x, b, shift;\r\nstatic const u8 v[] = {\r\n0, 54, 54, 54, 118, 118, 118, 118,\r\n123, 129, 134, 138, 143, 147, 151, 156,\r\n157, 161, 164, 168, 170, 173, 176, 179,\r\n181, 185, 187, 190, 192, 194, 197, 199,\r\n200, 202, 204, 206, 209, 211, 213, 215,\r\n217, 219, 221, 222, 224, 225, 227, 229,\r\n231, 232, 234, 236, 237, 239, 240, 242,\r\n244, 245, 246, 248, 250, 251, 252, 254,\r\n};\r\nb = fls64(a);\r\nif (b < 7) {\r\nreturn ((u32)v[(u32)a] + 35) >> 6;\r\n}\r\nb = ((b * 84) >> 8) - 1;\r\nshift = (a >> (b * 3));\r\nx = ((u32)(((u32)v[shift] + 10) << b)) >> 6;\r\nx = (2 * x + (u32)div64_u64(a, (u64)x * (u64)(x - 1)));\r\nx = ((x * 341) >> 10);\r\nreturn x;\r\n}\r\nstatic inline void bictcp_update(struct bictcp *ca, u32 cwnd, u32 acked)\r\n{\r\nu32 delta, bic_target, max_cnt;\r\nu64 offs, t;\r\nca->ack_cnt += acked;\r\nif (ca->last_cwnd == cwnd &&\r\n(s32)(tcp_time_stamp - ca->last_time) <= HZ / 32)\r\nreturn;\r\nif (ca->epoch_start && tcp_time_stamp == ca->last_time)\r\ngoto tcp_friendliness;\r\nca->last_cwnd = cwnd;\r\nca->last_time = tcp_time_stamp;\r\nif (ca->epoch_start == 0) {\r\nca->epoch_start = tcp_time_stamp;\r\nca->ack_cnt = acked;\r\nca->tcp_cwnd = cwnd;\r\nif (ca->last_max_cwnd <= cwnd) {\r\nca->bic_K = 0;\r\nca->bic_origin_point = cwnd;\r\n} else {\r\nca->bic_K = cubic_root(cube_factor\r\n* (ca->last_max_cwnd - cwnd));\r\nca->bic_origin_point = ca->last_max_cwnd;\r\n}\r\n}\r\nt = (s32)(tcp_time_stamp - ca->epoch_start);\r\nt += msecs_to_jiffies(ca->delay_min >> 3);\r\nt <<= BICTCP_HZ;\r\ndo_div(t, HZ);\r\nif (t < ca->bic_K)\r\noffs = ca->bic_K - t;\r\nelse\r\noffs = t - ca->bic_K;\r\ndelta = (cube_rtt_scale * offs * offs * offs) >> (10+3*BICTCP_HZ);\r\nif (t < ca->bic_K)\r\nbic_target = ca->bic_origin_point - delta;\r\nelse\r\nbic_target = ca->bic_origin_point + delta;\r\nif (bic_target > cwnd) {\r\nca->cnt = cwnd / (bic_target - cwnd);\r\n} else {\r\nca->cnt = 100 * cwnd;\r\n}\r\nif (ca->last_max_cwnd == 0 && ca->cnt > 20)\r\nca->cnt = 20;\r\ntcp_friendliness:\r\nif (tcp_friendliness) {\r\nu32 scale = beta_scale;\r\ndelta = (cwnd * scale) >> 3;\r\nwhile (ca->ack_cnt > delta) {\r\nca->ack_cnt -= delta;\r\nca->tcp_cwnd++;\r\n}\r\nif (ca->tcp_cwnd > cwnd) {\r\ndelta = ca->tcp_cwnd - cwnd;\r\nmax_cnt = cwnd / delta;\r\nif (ca->cnt > max_cnt)\r\nca->cnt = max_cnt;\r\n}\r\n}\r\nca->cnt = max(ca->cnt, 2U);\r\n}\r\nstatic void bictcp_cong_avoid(struct sock *sk, u32 ack, u32 acked)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct bictcp *ca = inet_csk_ca(sk);\r\nif (!tcp_is_cwnd_limited(sk))\r\nreturn;\r\nif (tp->snd_cwnd <= tp->snd_ssthresh) {\r\nif (hystart && after(ack, ca->end_seq))\r\nbictcp_hystart_reset(sk);\r\nacked = tcp_slow_start(tp, acked);\r\nif (!acked)\r\nreturn;\r\n}\r\nbictcp_update(ca, tp->snd_cwnd, acked);\r\ntcp_cong_avoid_ai(tp, ca->cnt, acked);\r\n}\r\nstatic u32 bictcp_recalc_ssthresh(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct bictcp *ca = inet_csk_ca(sk);\r\nca->epoch_start = 0;\r\nif (tp->snd_cwnd < ca->last_max_cwnd && fast_convergence)\r\nca->last_max_cwnd = (tp->snd_cwnd * (BICTCP_BETA_SCALE + beta))\r\n/ (2 * BICTCP_BETA_SCALE);\r\nelse\r\nca->last_max_cwnd = tp->snd_cwnd;\r\nca->loss_cwnd = tp->snd_cwnd;\r\nreturn max((tp->snd_cwnd * beta) / BICTCP_BETA_SCALE, 2U);\r\n}\r\nstatic u32 bictcp_undo_cwnd(struct sock *sk)\r\n{\r\nstruct bictcp *ca = inet_csk_ca(sk);\r\nreturn max(tcp_sk(sk)->snd_cwnd, ca->loss_cwnd);\r\n}\r\nstatic void bictcp_state(struct sock *sk, u8 new_state)\r\n{\r\nif (new_state == TCP_CA_Loss) {\r\nbictcp_reset(inet_csk_ca(sk));\r\nbictcp_hystart_reset(sk);\r\n}\r\n}\r\nstatic void hystart_update(struct sock *sk, u32 delay)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct bictcp *ca = inet_csk_ca(sk);\r\nif (ca->found & hystart_detect)\r\nreturn;\r\nif (hystart_detect & HYSTART_ACK_TRAIN) {\r\nu32 now = bictcp_clock();\r\nif ((s32)(now - ca->last_ack) <= hystart_ack_delta) {\r\nca->last_ack = now;\r\nif ((s32)(now - ca->round_start) > ca->delay_min >> 4) {\r\nca->found |= HYSTART_ACK_TRAIN;\r\nNET_INC_STATS_BH(sock_net(sk),\r\nLINUX_MIB_TCPHYSTARTTRAINDETECT);\r\nNET_ADD_STATS_BH(sock_net(sk),\r\nLINUX_MIB_TCPHYSTARTTRAINCWND,\r\ntp->snd_cwnd);\r\ntp->snd_ssthresh = tp->snd_cwnd;\r\n}\r\n}\r\n}\r\nif (hystart_detect & HYSTART_DELAY) {\r\nif (ca->sample_cnt < HYSTART_MIN_SAMPLES) {\r\nif (ca->curr_rtt == 0 || ca->curr_rtt > delay)\r\nca->curr_rtt = delay;\r\nca->sample_cnt++;\r\n} else {\r\nif (ca->curr_rtt > ca->delay_min +\r\nHYSTART_DELAY_THRESH(ca->delay_min >> 3)) {\r\nca->found |= HYSTART_DELAY;\r\nNET_INC_STATS_BH(sock_net(sk),\r\nLINUX_MIB_TCPHYSTARTDELAYDETECT);\r\nNET_ADD_STATS_BH(sock_net(sk),\r\nLINUX_MIB_TCPHYSTARTDELAYCWND,\r\ntp->snd_cwnd);\r\ntp->snd_ssthresh = tp->snd_cwnd;\r\n}\r\n}\r\n}\r\n}\r\nstatic void bictcp_acked(struct sock *sk, u32 cnt, s32 rtt_us)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct bictcp *ca = inet_csk_ca(sk);\r\nu32 delay;\r\nif (rtt_us < 0)\r\nreturn;\r\nif (ca->epoch_start && (s32)(tcp_time_stamp - ca->epoch_start) < HZ)\r\nreturn;\r\ndelay = (rtt_us << 3) / USEC_PER_MSEC;\r\nif (delay == 0)\r\ndelay = 1;\r\nif (ca->delay_min == 0 || ca->delay_min > delay)\r\nca->delay_min = delay;\r\nif (hystart && tp->snd_cwnd <= tp->snd_ssthresh &&\r\ntp->snd_cwnd >= hystart_low_window)\r\nhystart_update(sk, delay);\r\n}\r\nstatic int __init cubictcp_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct bictcp) > ICSK_CA_PRIV_SIZE);\r\nbeta_scale = 8*(BICTCP_BETA_SCALE+beta) / 3\r\n/ (BICTCP_BETA_SCALE - beta);\r\ncube_rtt_scale = (bic_scale * 10);\r\ncube_factor = 1ull << (10+3*BICTCP_HZ);\r\ndo_div(cube_factor, bic_scale * 10);\r\nreturn tcp_register_congestion_control(&cubictcp);\r\n}\r\nstatic void __exit cubictcp_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&cubictcp);\r\n}

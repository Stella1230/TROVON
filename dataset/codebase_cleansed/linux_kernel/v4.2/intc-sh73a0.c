static irqreturn_t sh73a0_intcs_demux(int irq, void *dev_id)\r\n{\r\nunsigned int evtcodeas = ioread32((void __iomem *)dev_id);\r\ngeneric_handle_irq(intcs_evt2irq(evtcodeas));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void pint_demux(void __iomem *rr, void __iomem *er, int base_irq)\r\n{\r\nunsigned long value = ioread32(rr) & ioread32(er);\r\nint k;\r\nfor (k = 0; k < 32; k++) {\r\nif (value & (1 << (31 - k))) {\r\ngeneric_handle_irq(base_irq + k);\r\niowrite32(~(1 << (31 - k)), rr);\r\n}\r\n}\r\n}\r\nstatic irqreturn_t sh73a0_pint0_demux(int irq, void *dev_id)\r\n{\r\npint_demux(PINTRR0, PINTER0_VIRT, SH73A0_PINT0_IRQ(0));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t sh73a0_pint1_demux(int irq, void *dev_id)\r\n{\r\npint_demux(PINTRR1, PINTER1_VIRT, SH73A0_PINT1_IRQ(0));\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init sh73a0_init_irq(void)\r\n{\r\nvoid __iomem *gic_dist_base = IOMEM(0xf0001000);\r\nvoid __iomem *gic_cpu_base = IOMEM(0xf0000100);\r\nvoid __iomem *intevtsa = ioremap_nocache(0xffd20100, PAGE_SIZE);\r\ngic_set_irqchip_flags(IRQCHIP_SKIP_SET_WAKE);\r\ngic_init(0, 29, gic_dist_base, gic_cpu_base);\r\nregister_intc_controller(&intcs_desc);\r\nregister_intc_controller(&intc_pint0_desc);\r\nregister_intc_controller(&intc_pint1_desc);\r\nsh73a0_intcs_cascade.name = "INTCS cascade";\r\nsh73a0_intcs_cascade.handler = sh73a0_intcs_demux;\r\nsh73a0_intcs_cascade.dev_id = intevtsa;\r\nsetup_irq(gic_spi(50), &sh73a0_intcs_cascade);\r\nsh73a0_pint0_cascade.name = "PINT0 cascade";\r\nsh73a0_pint0_cascade.handler = sh73a0_pint0_demux;\r\nsetup_irq(gic_spi(33), &sh73a0_pint0_cascade);\r\nsh73a0_pint1_cascade.name = "PINT1 cascade";\r\nsh73a0_pint1_cascade.handler = sh73a0_pint1_demux;\r\nsetup_irq(gic_spi(34), &sh73a0_pint1_cascade);\r\n}

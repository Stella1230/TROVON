static\r\nint iwl_mvm_beacon_filter_send_cmd(struct iwl_mvm *mvm,\r\nstruct iwl_beacon_filter_cmd *cmd,\r\nu32 flags)\r\n{\r\nIWL_DEBUG_POWER(mvm, "ba_enable_beacon_abort is: %d\n",\r\nle32_to_cpu(cmd->ba_enable_beacon_abort));\r\nIWL_DEBUG_POWER(mvm, "ba_escape_timer is: %d\n",\r\nle32_to_cpu(cmd->ba_escape_timer));\r\nIWL_DEBUG_POWER(mvm, "bf_debug_flag is: %d\n",\r\nle32_to_cpu(cmd->bf_debug_flag));\r\nIWL_DEBUG_POWER(mvm, "bf_enable_beacon_filter is: %d\n",\r\nle32_to_cpu(cmd->bf_enable_beacon_filter));\r\nIWL_DEBUG_POWER(mvm, "bf_energy_delta is: %d\n",\r\nle32_to_cpu(cmd->bf_energy_delta));\r\nIWL_DEBUG_POWER(mvm, "bf_escape_timer is: %d\n",\r\nle32_to_cpu(cmd->bf_escape_timer));\r\nIWL_DEBUG_POWER(mvm, "bf_roaming_energy_delta is: %d\n",\r\nle32_to_cpu(cmd->bf_roaming_energy_delta));\r\nIWL_DEBUG_POWER(mvm, "bf_roaming_state is: %d\n",\r\nle32_to_cpu(cmd->bf_roaming_state));\r\nIWL_DEBUG_POWER(mvm, "bf_temp_threshold is: %d\n",\r\nle32_to_cpu(cmd->bf_temp_threshold));\r\nIWL_DEBUG_POWER(mvm, "bf_temp_fast_filter is: %d\n",\r\nle32_to_cpu(cmd->bf_temp_fast_filter));\r\nIWL_DEBUG_POWER(mvm, "bf_temp_slow_filter is: %d\n",\r\nle32_to_cpu(cmd->bf_temp_slow_filter));\r\nreturn iwl_mvm_send_cmd_pdu(mvm, REPLY_BEACON_FILTERING_CMD, flags,\r\nsizeof(struct iwl_beacon_filter_cmd), cmd);\r\n}\r\nstatic\r\nvoid iwl_mvm_beacon_filter_set_cqm_params(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nstruct iwl_beacon_filter_cmd *cmd)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nif (vif->bss_conf.cqm_rssi_thold) {\r\ncmd->bf_energy_delta =\r\ncpu_to_le32(vif->bss_conf.cqm_rssi_hyst);\r\ncmd->bf_roaming_state =\r\ncpu_to_le32(-vif->bss_conf.cqm_rssi_thold);\r\n}\r\ncmd->ba_enable_beacon_abort = cpu_to_le32(mvmvif->bf_data.ba_enabled);\r\n}\r\nstatic void iwl_mvm_power_log(struct iwl_mvm *mvm,\r\nstruct iwl_mac_power_cmd *cmd)\r\n{\r\nIWL_DEBUG_POWER(mvm,\r\n"Sending power table command on mac id 0x%X for power level %d, flags = 0x%X\n",\r\ncmd->id_and_color, iwlmvm_mod_params.power_scheme,\r\nle16_to_cpu(cmd->flags));\r\nIWL_DEBUG_POWER(mvm, "Keep alive = %u sec\n",\r\nle16_to_cpu(cmd->keep_alive_seconds));\r\nif (!(cmd->flags & cpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK))) {\r\nIWL_DEBUG_POWER(mvm, "Disable power management\n");\r\nreturn;\r\n}\r\nIWL_DEBUG_POWER(mvm, "Rx timeout = %u usec\n",\r\nle32_to_cpu(cmd->rx_data_timeout));\r\nIWL_DEBUG_POWER(mvm, "Tx timeout = %u usec\n",\r\nle32_to_cpu(cmd->tx_data_timeout));\r\nif (cmd->flags & cpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK))\r\nIWL_DEBUG_POWER(mvm, "DTIM periods to skip = %u\n",\r\ncmd->skip_dtim_periods);\r\nif (cmd->flags & cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK))\r\nIWL_DEBUG_POWER(mvm, "LP RX RSSI threshold = %u\n",\r\ncmd->lprx_rssi_threshold);\r\nif (cmd->flags & cpu_to_le16(POWER_FLAGS_ADVANCE_PM_ENA_MSK)) {\r\nIWL_DEBUG_POWER(mvm, "uAPSD enabled\n");\r\nIWL_DEBUG_POWER(mvm, "Rx timeout (uAPSD) = %u usec\n",\r\nle32_to_cpu(cmd->rx_data_timeout_uapsd));\r\nIWL_DEBUG_POWER(mvm, "Tx timeout (uAPSD) = %u usec\n",\r\nle32_to_cpu(cmd->tx_data_timeout_uapsd));\r\nIWL_DEBUG_POWER(mvm, "QNDP TID = %d\n", cmd->qndp_tid);\r\nIWL_DEBUG_POWER(mvm, "ACs flags = 0x%x\n", cmd->uapsd_ac_flags);\r\nIWL_DEBUG_POWER(mvm, "Max SP = %d\n", cmd->uapsd_max_sp);\r\n}\r\n}\r\nstatic void iwl_mvm_power_configure_uapsd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nstruct iwl_mac_power_cmd *cmd)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nenum ieee80211_ac_numbers ac;\r\nbool tid_found = false;\r\nfor (ac = IEEE80211_AC_VO; ac <= IEEE80211_AC_BK; ac++) {\r\nif (!mvmvif->queue_params[ac].uapsd)\r\ncontinue;\r\nif (mvm->cur_ucode != IWL_UCODE_WOWLAN)\r\ncmd->flags |=\r\ncpu_to_le16(POWER_FLAGS_ADVANCE_PM_ENA_MSK);\r\ncmd->uapsd_ac_flags |= BIT(ac);\r\nif (!tid_found && !mvmvif->queue_params[ac].acm) {\r\ntid_found = true;\r\nswitch (ac) {\r\ncase IEEE80211_AC_VO:\r\ncmd->qndp_tid = 6;\r\nbreak;\r\ncase IEEE80211_AC_VI:\r\ncmd->qndp_tid = 5;\r\nbreak;\r\ncase IEEE80211_AC_BE:\r\ncmd->qndp_tid = 0;\r\nbreak;\r\ncase IEEE80211_AC_BK:\r\ncmd->qndp_tid = 1;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (!(cmd->flags & cpu_to_le16(POWER_FLAGS_ADVANCE_PM_ENA_MSK))) {\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (mvmvif->dbgfs_pm.use_ps_poll)\r\ncmd->flags |=\r\ncpu_to_le16(POWER_FLAGS_ADVANCE_PM_ENA_MSK);\r\n#endif\r\nreturn;\r\n}\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_UAPSD_MISBEHAVING_ENA_MSK);\r\nif (cmd->uapsd_ac_flags == (BIT(IEEE80211_AC_VO) |\r\nBIT(IEEE80211_AC_VI) |\r\nBIT(IEEE80211_AC_BE) |\r\nBIT(IEEE80211_AC_BK))) {\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_SNOOZE_ENA_MSK);\r\ncmd->snooze_interval = cpu_to_le16(IWL_MVM_PS_SNOOZE_INTERVAL);\r\ncmd->snooze_window = (mvm->cur_ucode == IWL_UCODE_WOWLAN) ?\r\ncpu_to_le16(IWL_MVM_WOWLAN_PS_SNOOZE_WINDOW) :\r\ncpu_to_le16(IWL_MVM_PS_SNOOZE_WINDOW);\r\n}\r\ncmd->uapsd_max_sp = IWL_UAPSD_MAX_SP;\r\nif (mvm->cur_ucode == IWL_UCODE_WOWLAN || cmd->flags &\r\ncpu_to_le16(POWER_FLAGS_SNOOZE_ENA_MSK)) {\r\ncmd->rx_data_timeout_uapsd =\r\ncpu_to_le32(IWL_MVM_WOWLAN_PS_RX_DATA_TIMEOUT);\r\ncmd->tx_data_timeout_uapsd =\r\ncpu_to_le32(IWL_MVM_WOWLAN_PS_TX_DATA_TIMEOUT);\r\n} else {\r\ncmd->rx_data_timeout_uapsd =\r\ncpu_to_le32(IWL_MVM_UAPSD_RX_DATA_TIMEOUT);\r\ncmd->tx_data_timeout_uapsd =\r\ncpu_to_le32(IWL_MVM_UAPSD_TX_DATA_TIMEOUT);\r\n}\r\nif (cmd->flags & cpu_to_le16(POWER_FLAGS_SNOOZE_ENA_MSK)) {\r\ncmd->heavy_tx_thld_packets =\r\nIWL_MVM_PS_SNOOZE_HEAVY_TX_THLD_PACKETS;\r\ncmd->heavy_rx_thld_packets =\r\nIWL_MVM_PS_SNOOZE_HEAVY_RX_THLD_PACKETS;\r\n} else {\r\ncmd->heavy_tx_thld_packets =\r\nIWL_MVM_PS_HEAVY_TX_THLD_PACKETS;\r\ncmd->heavy_rx_thld_packets =\r\nIWL_MVM_PS_HEAVY_RX_THLD_PACKETS;\r\n}\r\ncmd->heavy_tx_thld_percentage =\r\nIWL_MVM_PS_HEAVY_TX_THLD_PERCENT;\r\ncmd->heavy_rx_thld_percentage =\r\nIWL_MVM_PS_HEAVY_RX_THLD_PERCENT;\r\n}\r\nstatic bool iwl_mvm_power_allow_uapsd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nif (!memcmp(mvmvif->uapsd_misbehaving_bssid, vif->bss_conf.bssid,\r\nETH_ALEN))\r\nreturn false;\r\nif (vif->p2p &&\r\n!(mvm->fw->ucode_capa.flags & IWL_UCODE_TLV_FLAGS_P2P_PS_UAPSD))\r\nreturn false;\r\nif (vif->p2p &&\r\n(vif->bss_conf.p2p_noa_attr.oppps_ctwindow &\r\nIEEE80211_P2P_OPPPS_ENABLE_BIT))\r\nreturn false;\r\nif (iwl_mvm_phy_ctx_count(mvm) >= 2)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic int iwl_mvm_power_get_skip_over_dtim(int dtimper, int bi)\r\n{\r\nint numerator;\r\nint dtim_interval = dtimper * bi;\r\nif (WARN_ON(!dtim_interval))\r\nreturn 0;\r\nif (dtimper == 1) {\r\nif (bi > 100)\r\nnumerator = 408;\r\nelse\r\nnumerator = 510;\r\n} else if (dtimper < 10) {\r\nnumerator = 612;\r\n} else {\r\nreturn 0;\r\n}\r\nreturn max(1, (numerator / dtim_interval));\r\n}\r\nstatic bool iwl_mvm_power_is_radar(struct ieee80211_vif *vif)\r\n{\r\nstruct ieee80211_chanctx_conf *chanctx_conf;\r\nstruct ieee80211_channel *chan;\r\nbool radar_detect = false;\r\nrcu_read_lock();\r\nchanctx_conf = rcu_dereference(vif->chanctx_conf);\r\nWARN_ON(!chanctx_conf);\r\nif (chanctx_conf) {\r\nchan = chanctx_conf->def.chan;\r\nradar_detect = chan->flags & IEEE80211_CHAN_RADAR;\r\n}\r\nrcu_read_unlock();\r\nreturn radar_detect;\r\n}\r\nstatic void iwl_mvm_power_build_cmd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nstruct iwl_mac_power_cmd *cmd)\r\n{\r\nint dtimper, bi;\r\nint keep_alive;\r\nbool radar_detect = false;\r\nstruct iwl_mvm_vif *mvmvif __maybe_unused =\r\niwl_mvm_vif_from_mac80211(vif);\r\ncmd->id_and_color = cpu_to_le32(FW_CMD_ID_AND_COLOR(mvmvif->id,\r\nmvmvif->color));\r\ndtimper = vif->bss_conf.dtim_period;\r\nbi = vif->bss_conf.beacon_int;\r\nkeep_alive = DIV_ROUND_UP(ieee80211_tu_to_usec(3 * dtimper * bi),\r\nUSEC_PER_SEC);\r\nkeep_alive = max(keep_alive, POWER_KEEP_ALIVE_PERIOD_SEC);\r\ncmd->keep_alive_seconds = cpu_to_le16(keep_alive);\r\nif (mvm->ps_disabled)\r\nreturn;\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_POWER_SAVE_ENA_MSK);\r\nif (!vif->bss_conf.ps || iwl_mvm_vif_low_latency(mvmvif) ||\r\n!mvmvif->pm_enabled)\r\nreturn;\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK);\r\nif (vif->bss_conf.beacon_rate &&\r\n(vif->bss_conf.beacon_rate->bitrate == 10 ||\r\nvif->bss_conf.beacon_rate->bitrate == 60)) {\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK);\r\ncmd->lprx_rssi_threshold = POWER_LPRX_RSSI_THRESHOLD;\r\n}\r\nradar_detect = iwl_mvm_power_is_radar(vif);\r\nif (!radar_detect && (dtimper < 10) &&\r\n(iwlmvm_mod_params.power_scheme == IWL_POWER_SCHEME_LP ||\r\nmvm->cur_ucode == IWL_UCODE_WOWLAN)) {\r\ncmd->skip_dtim_periods =\r\niwl_mvm_power_get_skip_over_dtim(dtimper, bi);\r\nif (cmd->skip_dtim_periods)\r\ncmd->flags |=\r\ncpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK);\r\n}\r\nif (mvm->cur_ucode != IWL_UCODE_WOWLAN) {\r\ncmd->rx_data_timeout =\r\ncpu_to_le32(IWL_MVM_DEFAULT_PS_RX_DATA_TIMEOUT);\r\ncmd->tx_data_timeout =\r\ncpu_to_le32(IWL_MVM_DEFAULT_PS_TX_DATA_TIMEOUT);\r\n} else {\r\ncmd->rx_data_timeout =\r\ncpu_to_le32(IWL_MVM_WOWLAN_PS_RX_DATA_TIMEOUT);\r\ncmd->tx_data_timeout =\r\ncpu_to_le32(IWL_MVM_WOWLAN_PS_TX_DATA_TIMEOUT);\r\n}\r\nif (iwl_mvm_power_allow_uapsd(mvm, vif))\r\niwl_mvm_power_configure_uapsd(mvm, vif, cmd);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_KEEP_ALIVE)\r\ncmd->keep_alive_seconds =\r\ncpu_to_le16(mvmvif->dbgfs_pm.keep_alive_seconds);\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_SKIP_OVER_DTIM) {\r\nif (mvmvif->dbgfs_pm.skip_over_dtim)\r\ncmd->flags |=\r\ncpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK);\r\nelse\r\ncmd->flags &=\r\ncpu_to_le16(~POWER_FLAGS_SKIP_OVER_DTIM_MSK);\r\n}\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_RX_DATA_TIMEOUT)\r\ncmd->rx_data_timeout =\r\ncpu_to_le32(mvmvif->dbgfs_pm.rx_data_timeout);\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_TX_DATA_TIMEOUT)\r\ncmd->tx_data_timeout =\r\ncpu_to_le32(mvmvif->dbgfs_pm.tx_data_timeout);\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_SKIP_DTIM_PERIODS)\r\ncmd->skip_dtim_periods = mvmvif->dbgfs_pm.skip_dtim_periods;\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_LPRX_ENA) {\r\nif (mvmvif->dbgfs_pm.lprx_ena)\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK);\r\nelse\r\ncmd->flags &= cpu_to_le16(~POWER_FLAGS_LPRX_ENA_MSK);\r\n}\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_LPRX_RSSI_THRESHOLD)\r\ncmd->lprx_rssi_threshold = mvmvif->dbgfs_pm.lprx_rssi_threshold;\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_SNOOZE_ENABLE) {\r\nif (mvmvif->dbgfs_pm.snooze_ena)\r\ncmd->flags |=\r\ncpu_to_le16(POWER_FLAGS_SNOOZE_ENA_MSK);\r\nelse\r\ncmd->flags &=\r\ncpu_to_le16(~POWER_FLAGS_SNOOZE_ENA_MSK);\r\n}\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_UAPSD_MISBEHAVING) {\r\nu16 flag = POWER_FLAGS_UAPSD_MISBEHAVING_ENA_MSK;\r\nif (mvmvif->dbgfs_pm.uapsd_misbehaving)\r\ncmd->flags |= cpu_to_le16(flag);\r\nelse\r\ncmd->flags &= cpu_to_le16(flag);\r\n}\r\n#endif\r\n}\r\nstatic int iwl_mvm_power_send_cmd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mac_power_cmd cmd = {};\r\niwl_mvm_power_build_cmd(mvm, vif, &cmd);\r\niwl_mvm_power_log(mvm, &cmd);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nmemcpy(&iwl_mvm_vif_from_mac80211(vif)->mac_pwr_cmd, &cmd, sizeof(cmd));\r\n#endif\r\nreturn iwl_mvm_send_cmd_pdu(mvm, MAC_PM_POWER_TABLE, 0,\r\nsizeof(cmd), &cmd);\r\n}\r\nint iwl_mvm_power_update_device(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_device_power_cmd cmd = {\r\n.flags = cpu_to_le16(DEVICE_POWER_FLAGS_POWER_SAVE_ENA_MSK),\r\n};\r\nif (iwlmvm_mod_params.power_scheme == IWL_POWER_SCHEME_CAM)\r\nmvm->ps_disabled = true;\r\nif (mvm->ps_disabled)\r\ncmd.flags |= cpu_to_le16(DEVICE_POWER_FLAGS_CAM_MSK);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif ((mvm->cur_ucode == IWL_UCODE_WOWLAN) ? mvm->disable_power_off_d3 :\r\nmvm->disable_power_off)\r\ncmd.flags &=\r\ncpu_to_le16(~DEVICE_POWER_FLAGS_POWER_SAVE_ENA_MSK);\r\n#endif\r\nIWL_DEBUG_POWER(mvm,\r\n"Sending device power command with flags = 0x%X\n",\r\ncmd.flags);\r\nreturn iwl_mvm_send_cmd_pdu(mvm, POWER_TABLE_CMD, 0, sizeof(cmd),\r\n&cmd);\r\n}\r\nvoid iwl_mvm_power_vif_assoc(struct iwl_mvm *mvm, struct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nif (memcmp(vif->bss_conf.bssid, mvmvif->uapsd_misbehaving_bssid,\r\nETH_ALEN))\r\neth_zero_addr(mvmvif->uapsd_misbehaving_bssid);\r\n}\r\nstatic void iwl_mvm_power_uapsd_misbehav_ap_iterator(void *_data, u8 *mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nu8 *ap_sta_id = _data;\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nif (mvmvif->ap_sta_id == *ap_sta_id)\r\nmemcpy(mvmvif->uapsd_misbehaving_bssid, vif->bss_conf.bssid,\r\nETH_ALEN);\r\n}\r\nint iwl_mvm_power_uapsd_misbehaving_ap_notif(struct iwl_mvm *mvm,\r\nstruct iwl_rx_cmd_buffer *rxb,\r\nstruct iwl_device_cmd *cmd)\r\n{\r\nstruct iwl_rx_packet *pkt = rxb_addr(rxb);\r\nstruct iwl_uapsd_misbehaving_ap_notif *notif = (void *)pkt->data;\r\nu8 ap_sta_id = le32_to_cpu(notif->sta_id);\r\nieee80211_iterate_active_interfaces_atomic(\r\nmvm->hw, IEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_power_uapsd_misbehav_ap_iterator, &ap_sta_id);\r\nreturn 0;\r\n}\r\nstatic void iwl_mvm_power_disable_pm_iterator(void *_data, u8* mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nmvmvif->pm_enabled = false;\r\n}\r\nstatic void iwl_mvm_power_ps_disabled_iterator(void *_data, u8* mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nbool *disable_ps = _data;\r\nif (mvmvif->phy_ctxt)\r\nif (mvmvif->phy_ctxt->id < MAX_PHYS)\r\n*disable_ps |= mvmvif->ps_disabled;\r\n}\r\nstatic void iwl_mvm_power_get_vifs_iterator(void *_data, u8 *mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_power_vifs *power_iterator = _data;\r\nswitch (ieee80211_vif_type_p2p(vif)) {\r\ncase NL80211_IFTYPE_P2P_DEVICE:\r\nbreak;\r\ncase NL80211_IFTYPE_P2P_GO:\r\ncase NL80211_IFTYPE_AP:\r\nWARN_ON(power_iterator->ap_vif);\r\npower_iterator->ap_vif = vif;\r\nif (mvmvif->phy_ctxt)\r\nif (mvmvif->phy_ctxt->id < MAX_PHYS)\r\npower_iterator->ap_active = true;\r\nbreak;\r\ncase NL80211_IFTYPE_MONITOR:\r\nWARN_ON(power_iterator->monitor_vif);\r\npower_iterator->monitor_vif = vif;\r\nif (mvmvif->phy_ctxt)\r\nif (mvmvif->phy_ctxt->id < MAX_PHYS)\r\npower_iterator->monitor_active = true;\r\nbreak;\r\ncase NL80211_IFTYPE_P2P_CLIENT:\r\nWARN_ON(power_iterator->p2p_vif);\r\npower_iterator->p2p_vif = vif;\r\nif (mvmvif->phy_ctxt)\r\nif (mvmvif->phy_ctxt->id < MAX_PHYS)\r\npower_iterator->p2p_active = true;\r\nbreak;\r\ncase NL80211_IFTYPE_STATION:\r\nWARN_ON(power_iterator->bss_vif);\r\npower_iterator->bss_vif = vif;\r\nif (mvmvif->phy_ctxt)\r\nif (mvmvif->phy_ctxt->id < MAX_PHYS)\r\npower_iterator->bss_active = true;\r\nif (mvmvif->bf_data.bf_enabled &&\r\n!WARN_ON(power_iterator->bf_vif))\r\npower_iterator->bf_vif = vif;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void iwl_mvm_power_set_pm(struct iwl_mvm *mvm,\r\nstruct iwl_power_vifs *vifs)\r\n{\r\nstruct iwl_mvm_vif *bss_mvmvif = NULL;\r\nstruct iwl_mvm_vif *p2p_mvmvif = NULL;\r\nstruct iwl_mvm_vif *ap_mvmvif = NULL;\r\nbool client_same_channel = false;\r\nbool ap_same_channel = false;\r\nlockdep_assert_held(&mvm->mutex);\r\nieee80211_iterate_active_interfaces_atomic(mvm->hw,\r\nIEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_power_disable_pm_iterator,\r\nNULL);\r\nif (vifs->bss_vif)\r\nbss_mvmvif = iwl_mvm_vif_from_mac80211(vifs->bss_vif);\r\nif (vifs->p2p_vif)\r\np2p_mvmvif = iwl_mvm_vif_from_mac80211(vifs->p2p_vif);\r\nif (vifs->ap_vif)\r\nap_mvmvif = iwl_mvm_vif_from_mac80211(vifs->ap_vif);\r\nif (iwl_mvm_tdls_sta_count(mvm, NULL))\r\nreturn;\r\nif (vifs->bss_active && !vifs->p2p_active && !vifs->ap_active) {\r\nbss_mvmvif->pm_enabled = true;\r\nreturn;\r\n}\r\nif (vifs->p2p_active && !vifs->bss_active && !vifs->ap_active) {\r\nif (mvm->fw->ucode_capa.flags & IWL_UCODE_TLV_FLAGS_P2P_PM)\r\np2p_mvmvif->pm_enabled = true;\r\nreturn;\r\n}\r\nif (vifs->bss_active && vifs->p2p_active)\r\nclient_same_channel = (bss_mvmvif->phy_ctxt->id ==\r\np2p_mvmvif->phy_ctxt->id);\r\nif (vifs->bss_active && vifs->ap_active)\r\nap_same_channel = (bss_mvmvif->phy_ctxt->id ==\r\nap_mvmvif->phy_ctxt->id);\r\nif (!(client_same_channel || ap_same_channel) &&\r\n(mvm->fw->ucode_capa.flags & IWL_UCODE_TLV_FLAGS_BSS_P2P_PS_DCM)) {\r\nif (vifs->bss_active)\r\nbss_mvmvif->pm_enabled = true;\r\nif (vifs->p2p_active &&\r\n(mvm->fw->ucode_capa.flags & IWL_UCODE_TLV_FLAGS_P2P_PM))\r\np2p_mvmvif->pm_enabled = true;\r\nreturn;\r\n}\r\nif (client_same_channel && !vifs->ap_active &&\r\n(mvm->fw->ucode_capa.flags & IWL_UCODE_TLV_FLAGS_BSS_P2P_PS_SCM)) {\r\nbss_mvmvif->pm_enabled = true;\r\nif (mvm->fw->ucode_capa.flags & IWL_UCODE_TLV_FLAGS_P2P_PM)\r\np2p_mvmvif->pm_enabled = true;\r\n}\r\n}\r\nint iwl_mvm_power_mac_dbgfs_read(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif, char *buf,\r\nint bufsz)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_mac_power_cmd cmd = {};\r\nint pos = 0;\r\nmutex_lock(&mvm->mutex);\r\nmemcpy(&cmd, &mvmvif->mac_pwr_cmd, sizeof(cmd));\r\nmutex_unlock(&mvm->mutex);\r\npos += scnprintf(buf+pos, bufsz-pos, "power_scheme = %d\n",\r\niwlmvm_mod_params.power_scheme);\r\npos += scnprintf(buf+pos, bufsz-pos, "flags = 0x%x\n",\r\nle16_to_cpu(cmd.flags));\r\npos += scnprintf(buf+pos, bufsz-pos, "keep_alive = %d\n",\r\nle16_to_cpu(cmd.keep_alive_seconds));\r\nif (!(cmd.flags & cpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK)))\r\nreturn pos;\r\npos += scnprintf(buf+pos, bufsz-pos, "skip_over_dtim = %d\n",\r\n(cmd.flags &\r\ncpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK)) ? 1 : 0);\r\npos += scnprintf(buf+pos, bufsz-pos, "skip_dtim_periods = %d\n",\r\ncmd.skip_dtim_periods);\r\nif (!(cmd.flags & cpu_to_le16(POWER_FLAGS_ADVANCE_PM_ENA_MSK))) {\r\npos += scnprintf(buf+pos, bufsz-pos, "rx_data_timeout = %d\n",\r\nle32_to_cpu(cmd.rx_data_timeout));\r\npos += scnprintf(buf+pos, bufsz-pos, "tx_data_timeout = %d\n",\r\nle32_to_cpu(cmd.tx_data_timeout));\r\n}\r\nif (cmd.flags & cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK))\r\npos += scnprintf(buf+pos, bufsz-pos,\r\n"lprx_rssi_threshold = %d\n",\r\ncmd.lprx_rssi_threshold);\r\nif (!(cmd.flags & cpu_to_le16(POWER_FLAGS_ADVANCE_PM_ENA_MSK)))\r\nreturn pos;\r\npos += scnprintf(buf+pos, bufsz-pos, "rx_data_timeout_uapsd = %d\n",\r\nle32_to_cpu(cmd.rx_data_timeout_uapsd));\r\npos += scnprintf(buf+pos, bufsz-pos, "tx_data_timeout_uapsd = %d\n",\r\nle32_to_cpu(cmd.tx_data_timeout_uapsd));\r\npos += scnprintf(buf+pos, bufsz-pos, "qndp_tid = %d\n", cmd.qndp_tid);\r\npos += scnprintf(buf+pos, bufsz-pos, "uapsd_ac_flags = 0x%x\n",\r\ncmd.uapsd_ac_flags);\r\npos += scnprintf(buf+pos, bufsz-pos, "uapsd_max_sp = %d\n",\r\ncmd.uapsd_max_sp);\r\npos += scnprintf(buf+pos, bufsz-pos, "heavy_tx_thld_packets = %d\n",\r\ncmd.heavy_tx_thld_packets);\r\npos += scnprintf(buf+pos, bufsz-pos, "heavy_rx_thld_packets = %d\n",\r\ncmd.heavy_rx_thld_packets);\r\npos += scnprintf(buf+pos, bufsz-pos, "heavy_tx_thld_percentage = %d\n",\r\ncmd.heavy_tx_thld_percentage);\r\npos += scnprintf(buf+pos, bufsz-pos, "heavy_rx_thld_percentage = %d\n",\r\ncmd.heavy_rx_thld_percentage);\r\npos += scnprintf(buf+pos, bufsz-pos, "uapsd_misbehaving_enable = %d\n",\r\n(cmd.flags &\r\ncpu_to_le16(POWER_FLAGS_UAPSD_MISBEHAVING_ENA_MSK)) ?\r\n1 : 0);\r\nif (!(cmd.flags & cpu_to_le16(POWER_FLAGS_SNOOZE_ENA_MSK)))\r\nreturn pos;\r\npos += scnprintf(buf+pos, bufsz-pos, "snooze_interval = %d\n",\r\ncmd.snooze_interval);\r\npos += scnprintf(buf+pos, bufsz-pos, "snooze_window = %d\n",\r\ncmd.snooze_window);\r\nreturn pos;\r\n}\r\nvoid\r\niwl_mvm_beacon_filter_debugfs_parameters(struct ieee80211_vif *vif,\r\nstruct iwl_beacon_filter_cmd *cmd)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_dbgfs_bf *dbgfs_bf = &mvmvif->dbgfs_bf;\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_ENERGY_DELTA)\r\ncmd->bf_energy_delta = cpu_to_le32(dbgfs_bf->bf_energy_delta);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_ROAMING_ENERGY_DELTA)\r\ncmd->bf_roaming_energy_delta =\r\ncpu_to_le32(dbgfs_bf->bf_roaming_energy_delta);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_ROAMING_STATE)\r\ncmd->bf_roaming_state = cpu_to_le32(dbgfs_bf->bf_roaming_state);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_TEMP_THRESHOLD)\r\ncmd->bf_temp_threshold =\r\ncpu_to_le32(dbgfs_bf->bf_temp_threshold);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_TEMP_FAST_FILTER)\r\ncmd->bf_temp_fast_filter =\r\ncpu_to_le32(dbgfs_bf->bf_temp_fast_filter);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_TEMP_SLOW_FILTER)\r\ncmd->bf_temp_slow_filter =\r\ncpu_to_le32(dbgfs_bf->bf_temp_slow_filter);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_DEBUG_FLAG)\r\ncmd->bf_debug_flag = cpu_to_le32(dbgfs_bf->bf_debug_flag);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BF_ESCAPE_TIMER)\r\ncmd->bf_escape_timer = cpu_to_le32(dbgfs_bf->bf_escape_timer);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BA_ESCAPE_TIMER)\r\ncmd->ba_escape_timer = cpu_to_le32(dbgfs_bf->ba_escape_timer);\r\nif (dbgfs_bf->mask & MVM_DEBUGFS_BA_ENABLE_BEACON_ABORT)\r\ncmd->ba_enable_beacon_abort =\r\ncpu_to_le32(dbgfs_bf->ba_enable_beacon_abort);\r\n}\r\nstatic int _iwl_mvm_enable_beacon_filter(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nstruct iwl_beacon_filter_cmd *cmd,\r\nu32 cmd_flags,\r\nbool d0i3)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nint ret;\r\nif (mvmvif != mvm->bf_allowed_vif || !vif->bss_conf.dtim_period ||\r\nvif->type != NL80211_IFTYPE_STATION || vif->p2p)\r\nreturn 0;\r\niwl_mvm_beacon_filter_set_cqm_params(mvm, vif, cmd);\r\nif (!d0i3)\r\niwl_mvm_beacon_filter_debugfs_parameters(vif, cmd);\r\nret = iwl_mvm_beacon_filter_send_cmd(mvm, cmd, cmd_flags);\r\nif (!ret && !d0i3)\r\nmvmvif->bf_data.bf_enabled = true;\r\nreturn ret;\r\n}\r\nint iwl_mvm_enable_beacon_filter(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nu32 flags)\r\n{\r\nstruct iwl_beacon_filter_cmd cmd = {\r\nIWL_BF_CMD_CONFIG_DEFAULTS,\r\n.bf_enable_beacon_filter = cpu_to_le32(1),\r\n};\r\nreturn _iwl_mvm_enable_beacon_filter(mvm, vif, &cmd, flags, false);\r\n}\r\nstatic int iwl_mvm_update_beacon_abort(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nbool enable)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_beacon_filter_cmd cmd = {\r\nIWL_BF_CMD_CONFIG_DEFAULTS,\r\n.bf_enable_beacon_filter = cpu_to_le32(1),\r\n};\r\nif (!mvmvif->bf_data.bf_enabled)\r\nreturn 0;\r\nif (mvm->cur_ucode == IWL_UCODE_WOWLAN)\r\ncmd.ba_escape_timer = cpu_to_le32(IWL_BA_ESCAPE_TIMER_D3);\r\nmvmvif->bf_data.ba_enabled = enable;\r\nreturn _iwl_mvm_enable_beacon_filter(mvm, vif, &cmd, 0, false);\r\n}\r\nint iwl_mvm_disable_beacon_filter(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nu32 flags)\r\n{\r\nstruct iwl_beacon_filter_cmd cmd = {};\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nint ret;\r\nif (vif->type != NL80211_IFTYPE_STATION || vif->p2p)\r\nreturn 0;\r\nret = iwl_mvm_beacon_filter_send_cmd(mvm, &cmd, flags);\r\nif (!ret)\r\nmvmvif->bf_data.bf_enabled = false;\r\nreturn ret;\r\n}\r\nstatic int iwl_mvm_power_set_ps(struct iwl_mvm *mvm)\r\n{\r\nbool disable_ps;\r\nint ret;\r\ndisable_ps = (iwlmvm_mod_params.power_scheme == IWL_POWER_SCHEME_CAM);\r\nieee80211_iterate_active_interfaces_atomic(mvm->hw,\r\nIEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_power_ps_disabled_iterator,\r\n&disable_ps);\r\nif (mvm->ps_disabled != disable_ps) {\r\nbool old_ps_disabled = mvm->ps_disabled;\r\nmvm->ps_disabled = disable_ps;\r\nret = iwl_mvm_power_update_device(mvm);\r\nif (ret) {\r\nmvm->ps_disabled = old_ps_disabled;\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int iwl_mvm_power_set_ba(struct iwl_mvm *mvm,\r\nstruct iwl_power_vifs *vifs)\r\n{\r\nstruct iwl_mvm_vif *mvmvif;\r\nbool ba_enable;\r\nif (!vifs->bf_vif)\r\nreturn 0;\r\nmvmvif = iwl_mvm_vif_from_mac80211(vifs->bf_vif);\r\nba_enable = !(!mvmvif->pm_enabled || mvm->ps_disabled ||\r\n!vifs->bf_vif->bss_conf.ps ||\r\niwl_mvm_vif_low_latency(mvmvif));\r\nreturn iwl_mvm_update_beacon_abort(mvm, vifs->bf_vif, ba_enable);\r\n}\r\nint iwl_mvm_power_update_ps(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_power_vifs vifs = {\r\n.mvm = mvm,\r\n};\r\nint ret;\r\nlockdep_assert_held(&mvm->mutex);\r\nieee80211_iterate_active_interfaces_atomic(mvm->hw,\r\nIEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_power_get_vifs_iterator, &vifs);\r\nret = iwl_mvm_power_set_ps(mvm);\r\nif (ret)\r\nreturn ret;\r\nreturn iwl_mvm_power_set_ba(mvm, &vifs);\r\n}\r\nint iwl_mvm_power_update_mac(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_power_vifs vifs = {\r\n.mvm = mvm,\r\n};\r\nint ret;\r\nlockdep_assert_held(&mvm->mutex);\r\nieee80211_iterate_active_interfaces_atomic(mvm->hw,\r\nIEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_power_get_vifs_iterator, &vifs);\r\niwl_mvm_power_set_pm(mvm, &vifs);\r\nret = iwl_mvm_power_set_ps(mvm);\r\nif (ret)\r\nreturn ret;\r\nif (vifs.bss_vif) {\r\nret = iwl_mvm_power_send_cmd(mvm, vifs.bss_vif);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (vifs.p2p_vif) {\r\nret = iwl_mvm_power_send_cmd(mvm, vifs.p2p_vif);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn iwl_mvm_power_set_ba(mvm, &vifs);\r\n}\r\nint iwl_mvm_update_d0i3_power_mode(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nbool enable, u32 flags)\r\n{\r\nint ret;\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_mac_power_cmd cmd = {};\r\nif (vif->type != NL80211_IFTYPE_STATION || vif->p2p)\r\nreturn 0;\r\nif (!vif->bss_conf.assoc)\r\nreturn 0;\r\niwl_mvm_power_build_cmd(mvm, vif, &cmd);\r\nif (enable) {\r\nint dtimper = vif->bss_conf.dtim_period ?: 1;\r\nint dtimper_tu = dtimper * vif->bss_conf.beacon_int;\r\nbool radar_detect = iwl_mvm_power_is_radar(vif);\r\nif (WARN_ON(!dtimper_tu))\r\nreturn 0;\r\nif (!radar_detect && (dtimper < 10)) {\r\ncmd.skip_dtim_periods = 306 / dtimper_tu;\r\nif (cmd.skip_dtim_periods)\r\ncmd.flags |= cpu_to_le16(\r\nPOWER_FLAGS_SKIP_OVER_DTIM_MSK);\r\n}\r\n}\r\niwl_mvm_power_log(mvm, &cmd);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nmemcpy(&mvmvif->mac_pwr_cmd, &cmd, sizeof(cmd));\r\n#endif\r\nret = iwl_mvm_send_cmd_pdu(mvm, MAC_PM_POWER_TABLE, flags,\r\nsizeof(cmd), &cmd);\r\nif (ret)\r\nreturn ret;\r\nif (mvmvif != mvm->bf_allowed_vif)\r\nreturn 0;\r\nif (enable) {\r\nstruct iwl_beacon_filter_cmd cmd_bf = {\r\nIWL_BF_CMD_CONFIG_D0I3,\r\n.bf_enable_beacon_filter = cpu_to_le32(1),\r\n};\r\nret = _iwl_mvm_enable_beacon_filter(mvm, vif, &cmd_bf,\r\nflags, true);\r\n} else {\r\nif (mvmvif->bf_data.bf_enabled)\r\nret = iwl_mvm_enable_beacon_filter(mvm, vif, flags);\r\nelse\r\nret = iwl_mvm_disable_beacon_filter(mvm, vif, flags);\r\n}\r\nreturn ret;\r\n}

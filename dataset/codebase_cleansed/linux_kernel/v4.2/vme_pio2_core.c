static int pio2_get_led(struct pio2_card *card)\r\n{\r\nreturn card->led;\r\n}\r\nstatic int pio2_set_led(struct pio2_card *card, int state)\r\n{\r\nu8 reg;\r\nint retval;\r\nreg = card->irq_level;\r\nif (!state)\r\nreg |= PIO2_LED;\r\nif (loopback)\r\nreg |= PIO2_LOOP;\r\nretval = vme_master_write(card->window, &reg, 1, PIO2_REGS_CTRL);\r\nif (retval < 0)\r\nreturn retval;\r\ncard->led = state ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic void pio2_int(int level, int vector, void *ptr)\r\n{\r\nint vec, i, channel, retval;\r\nu8 reg;\r\nstruct pio2_card *card = ptr;\r\nvec = vector & ~PIO2_VME_VECTOR_MASK;\r\nswitch (vec) {\r\ncase 0:\r\ndev_warn(&card->vdev->dev, "Spurious Interrupt\n");\r\nbreak;\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\nretval = vme_master_read(card->window, &reg, 1,\r\nPIO2_REGS_INT_STAT[vec - 1]);\r\nif (retval < 0) {\r\ndev_err(&card->vdev->dev,\r\n"Unable to read IRQ status register\n");\r\nreturn;\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nchannel = ((vec - 1) * 8) + i;\r\nif (reg & PIO2_CHANNEL_BIT[channel])\r\ndev_info(&card->vdev->dev,\r\n"Interrupt on I/O channel %d\n",\r\nchannel);\r\n}\r\nbreak;\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\ncase 8:\r\ncase 9:\r\ncase 10:\r\ndev_err(&card->vdev->dev,\r\n"Counter interrupt\n");\r\nbreak;\r\n}\r\n}\r\nstatic int pio2_reset_card(struct pio2_card *card)\r\n{\r\nint retval = 0;\r\nu8 data = 0;\r\nretval = vme_master_write(card->window, &data, 1, PIO2_REGS_CTRL);\r\nif (retval < 0)\r\nreturn retval;\r\nretval = vme_master_write(card->window, &data, 1, PIO2_REGS_VME_VECTOR);\r\nif (retval < 0)\r\nreturn retval;\r\nretval = pio2_gpio_reset(card);\r\nif (retval < 0)\r\nreturn retval;\r\nretval = pio2_cntr_reset(card);\r\nif (retval < 0)\r\nreturn retval;\r\nreturn 0;\r\n}\r\nstatic int __init pio2_init(void)\r\n{\r\nif (bus_num == 0) {\r\npr_err("No cards, skipping registration\n");\r\nreturn -ENODEV;\r\n}\r\nif (bus_num > PIO2_CARDS_MAX) {\r\npr_err("Driver only able to handle %d PIO2 Cards\n",\r\nPIO2_CARDS_MAX);\r\nbus_num = PIO2_CARDS_MAX;\r\n}\r\nreturn vme_register_driver(&pio2_driver, bus_num);\r\n}\r\nstatic int pio2_match(struct vme_dev *vdev)\r\n{\r\nif (vdev->num >= bus_num) {\r\ndev_err(&vdev->dev,\r\n"The enumeration of the VMEbus to which the board is connected must be specified\n");\r\nreturn 0;\r\n}\r\nif (vdev->num >= base_num) {\r\ndev_err(&vdev->dev,\r\n"The VME address for the cards registers must be specified\n");\r\nreturn 0;\r\n}\r\nif (vdev->num >= vector_num) {\r\ndev_err(&vdev->dev,\r\n"The IRQ vector used by the card must be specified\n");\r\nreturn 0;\r\n}\r\nif (vdev->num >= level_num) {\r\ndev_err(&vdev->dev,\r\n"The IRQ level used by the card must be specified\n");\r\nreturn 0;\r\n}\r\nif (vdev->num >= variant_num) {\r\ndev_err(&vdev->dev, "The variant of the card must be specified\n");\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int pio2_probe(struct vme_dev *vdev)\r\n{\r\nstruct pio2_card *card;\r\nint retval;\r\nint i;\r\nu8 reg;\r\nint vec;\r\ncard = kzalloc(sizeof(struct pio2_card), GFP_KERNEL);\r\nif (card == NULL) {\r\nretval = -ENOMEM;\r\ngoto err_struct;\r\n}\r\ncard->id = vdev->num;\r\ncard->bus = bus[card->id];\r\ncard->base = base[card->id];\r\ncard->irq_vector = vector[card->id];\r\ncard->irq_level = level[card->id] & PIO2_VME_INT_MASK;\r\nstrncpy(card->variant, variant[card->id], PIO2_VARIANT_LENGTH);\r\ncard->vdev = vdev;\r\nfor (i = 0; i < PIO2_VARIANT_LENGTH; i++) {\r\nif (isdigit(card->variant[i]) == 0) {\r\ndev_err(&card->vdev->dev, "Variant invalid\n");\r\nretval = -EINVAL;\r\ngoto err_variant;\r\n}\r\n}\r\nif (card->irq_vector & ~PIO2_VME_VECTOR_MASK) {\r\ndev_err(&card->vdev->dev,\r\n"Invalid VME IRQ Vector, vector must not use lower 4 bits\n");\r\nretval = -EINVAL;\r\ngoto err_vector;\r\n}\r\nfor (i = 1; i < PIO2_VARIANT_LENGTH; i++) {\r\nswitch (card->variant[i]) {\r\ncase '0':\r\ncard->bank[i-1].config = NOFIT;\r\nbreak;\r\ncase '1':\r\ncase '2':\r\ncase '3':\r\ncase '4':\r\ncard->bank[i-1].config = INPUT;\r\nbreak;\r\ncase '5':\r\ncard->bank[i-1].config = OUTPUT;\r\nbreak;\r\ncase '6':\r\ncase '7':\r\ncase '8':\r\ncase '9':\r\ncard->bank[i-1].config = BOTH;\r\nbreak;\r\n}\r\n}\r\ncard->window = vme_master_request(vdev, VME_A24, VME_SCT, VME_D16);\r\nif (card->window == NULL) {\r\ndev_err(&card->vdev->dev,\r\n"Unable to assign VME master resource\n");\r\nretval = -EIO;\r\ngoto err_window;\r\n}\r\nretval = vme_master_set(card->window, 1, card->base, 0x10000, VME_A24,\r\n(VME_SCT | VME_USER | VME_DATA), VME_D16);\r\nif (retval) {\r\ndev_err(&card->vdev->dev,\r\n"Unable to configure VME master resource\n");\r\ngoto err_set;\r\n}\r\nretval = vme_master_read(card->window, &reg, 1, PIO2_REGS_ID);\r\nif (retval < 0) {\r\ndev_err(&card->vdev->dev, "Unable to read from device\n");\r\ngoto err_read;\r\n}\r\ndev_dbg(&card->vdev->dev, "ID Register:%x\n", reg);\r\nretval = pio2_reset_card(card);\r\nif (retval) {\r\ndev_err(&card->vdev->dev,\r\n"Failed to reset card, is location valid?\n");\r\nretval = -ENODEV;\r\ngoto err_reset;\r\n}\r\nreg = card->irq_level;\r\nif (pio2_get_led(card))\r\nreg |= PIO2_LED;\r\nif (loopback)\r\nreg |= PIO2_LOOP;\r\nretval = vme_master_write(card->window, &reg, 1, PIO2_REGS_CTRL);\r\nif (retval < 0)\r\nreturn retval;\r\nretval = vme_master_write(card->window, &card->irq_vector, 1,\r\nPIO2_REGS_VME_VECTOR);\r\nif (retval < 0)\r\nreturn retval;\r\nvec = card->irq_vector | PIO2_VME_VECTOR_SPUR;\r\nretval = vme_irq_request(vdev, card->irq_level, vec,\r\n&pio2_int, (void *)card);\r\nif (retval < 0) {\r\ndev_err(&card->vdev->dev,\r\n"Unable to attach VME interrupt vector0x%x, level 0x%x\n",\r\nvec, card->irq_level);\r\ngoto err_irq;\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nvec = card->irq_vector | PIO2_VECTOR_BANK[i];\r\nretval = vme_irq_request(vdev, card->irq_level, vec,\r\n&pio2_int, (void *)card);\r\nif (retval < 0) {\r\ndev_err(&card->vdev->dev,\r\n"Unable to attach VME interrupt vector0x%x, level 0x%x\n",\r\nvec, card->irq_level);\r\ngoto err_gpio_irq;\r\n}\r\n}\r\nfor (i = 0; i < 6; i++) {\r\nvec = card->irq_vector | PIO2_VECTOR_CNTR[i];\r\nretval = vme_irq_request(vdev, card->irq_level, vec,\r\n&pio2_int, (void *)card);\r\nif (retval < 0) {\r\ndev_err(&card->vdev->dev,\r\n"Unable to attach VME interrupt vector0x%x, level 0x%x\n",\r\nvec, card->irq_level);\r\ngoto err_cntr_irq;\r\n}\r\n}\r\nretval = pio2_gpio_init(card);\r\nif (retval < 0) {\r\ndev_err(&card->vdev->dev,\r\n"Unable to register with GPIO framework\n");\r\ngoto err_gpio;\r\n}\r\nretval = pio2_set_led(card, 0);\r\nif (retval < 0) {\r\ndev_err(&card->vdev->dev, "Unable to set LED\n");\r\ngoto err_led;\r\n}\r\ndev_set_drvdata(&card->vdev->dev, card);\r\ndev_info(&card->vdev->dev,\r\n"PIO2 (variant %s) configured at 0x%lx\n", card->variant,\r\ncard->base);\r\nreturn 0;\r\nerr_led:\r\npio2_gpio_exit(card);\r\nerr_gpio:\r\ni = 6;\r\nerr_cntr_irq:\r\nwhile (i > 0) {\r\ni--;\r\nvec = card->irq_vector | PIO2_VECTOR_CNTR[i];\r\nvme_irq_free(vdev, card->irq_level, vec);\r\n}\r\ni = 4;\r\nerr_gpio_irq:\r\nwhile (i > 0) {\r\ni--;\r\nvec = card->irq_vector | PIO2_VECTOR_BANK[i];\r\nvme_irq_free(vdev, card->irq_level, vec);\r\n}\r\nvec = (card->irq_vector & PIO2_VME_VECTOR_MASK) | PIO2_VME_VECTOR_SPUR;\r\nvme_irq_free(vdev, card->irq_level, vec);\r\nerr_irq:\r\npio2_reset_card(card);\r\nerr_reset:\r\nerr_read:\r\nvme_master_set(card->window, 0, 0, 0, VME_A16, 0, VME_D16);\r\nerr_set:\r\nvme_master_free(card->window);\r\nerr_window:\r\nerr_vector:\r\nerr_variant:\r\nkfree(card);\r\nerr_struct:\r\nreturn retval;\r\n}\r\nstatic int pio2_remove(struct vme_dev *vdev)\r\n{\r\nint vec;\r\nint i;\r\nstruct pio2_card *card = dev_get_drvdata(&vdev->dev);\r\npio2_gpio_exit(card);\r\nfor (i = 0; i < 6; i++) {\r\nvec = card->irq_vector | PIO2_VECTOR_CNTR[i];\r\nvme_irq_free(vdev, card->irq_level, vec);\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nvec = card->irq_vector | PIO2_VECTOR_BANK[i];\r\nvme_irq_free(vdev, card->irq_level, vec);\r\n}\r\nvec = (card->irq_vector & PIO2_VME_VECTOR_MASK) | PIO2_VME_VECTOR_SPUR;\r\nvme_irq_free(vdev, card->irq_level, vec);\r\npio2_reset_card(card);\r\nvme_master_set(card->window, 0, 0, 0, VME_A16, 0, VME_D16);\r\nvme_master_free(card->window);\r\nkfree(card);\r\nreturn 0;\r\n}\r\nstatic void __exit pio2_exit(void)\r\n{\r\nvme_unregister_driver(&pio2_driver);\r\n}

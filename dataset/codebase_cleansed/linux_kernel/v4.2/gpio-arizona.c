static inline struct arizona_gpio *to_arizona_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct arizona_gpio, gpio_chip);\r\n}\r\nstatic int arizona_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct arizona_gpio *arizona_gpio = to_arizona_gpio(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nreturn regmap_update_bits(arizona->regmap, ARIZONA_GPIO1_CTRL + offset,\r\nARIZONA_GPN_DIR, ARIZONA_GPN_DIR);\r\n}\r\nstatic int arizona_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct arizona_gpio *arizona_gpio = to_arizona_gpio(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(arizona->regmap, ARIZONA_GPIO1_CTRL + offset, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (val & ARIZONA_GPN_LVL)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int arizona_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct arizona_gpio *arizona_gpio = to_arizona_gpio(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nif (value)\r\nvalue = ARIZONA_GPN_LVL;\r\nreturn regmap_update_bits(arizona->regmap, ARIZONA_GPIO1_CTRL + offset,\r\nARIZONA_GPN_DIR | ARIZONA_GPN_LVL, value);\r\n}\r\nstatic void arizona_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct arizona_gpio *arizona_gpio = to_arizona_gpio(chip);\r\nstruct arizona *arizona = arizona_gpio->arizona;\r\nif (value)\r\nvalue = ARIZONA_GPN_LVL;\r\nregmap_update_bits(arizona->regmap, ARIZONA_GPIO1_CTRL + offset,\r\nARIZONA_GPN_LVL, value);\r\n}\r\nstatic int arizona_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct arizona_pdata *pdata = dev_get_platdata(arizona->dev);\r\nstruct arizona_gpio *arizona_gpio;\r\nint ret;\r\narizona_gpio = devm_kzalloc(&pdev->dev, sizeof(*arizona_gpio),\r\nGFP_KERNEL);\r\nif (!arizona_gpio)\r\nreturn -ENOMEM;\r\narizona_gpio->arizona = arizona;\r\narizona_gpio->gpio_chip = template_chip;\r\narizona_gpio->gpio_chip.dev = &pdev->dev;\r\n#ifdef CONFIG_OF_GPIO\r\narizona_gpio->gpio_chip.of_node = arizona->dev->of_node;\r\n#endif\r\nswitch (arizona->type) {\r\ncase WM5102:\r\ncase WM5110:\r\ncase WM8280:\r\ncase WM8997:\r\narizona_gpio->gpio_chip.ngpio = 5;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "Unknown chip variant %d\n",\r\narizona->type);\r\nreturn -EINVAL;\r\n}\r\nif (pdata && pdata->gpio_base)\r\narizona_gpio->gpio_chip.base = pdata->gpio_base;\r\nelse\r\narizona_gpio->gpio_chip.base = -1;\r\nret = gpiochip_add(&arizona_gpio->gpio_chip);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Could not register gpiochip, %d\n",\r\nret);\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, arizona_gpio);\r\nreturn ret;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int arizona_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct arizona_gpio *arizona_gpio = platform_get_drvdata(pdev);\r\ngpiochip_remove(&arizona_gpio->gpio_chip);\r\nreturn 0;\r\n}

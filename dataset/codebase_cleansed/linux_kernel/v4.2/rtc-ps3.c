static u64 read_rtc(void)\r\n{\r\nint result;\r\nu64 rtc_val;\r\nu64 tb_val;\r\nresult = lv1_get_rtc(&rtc_val, &tb_val);\r\nBUG_ON(result);\r\nreturn rtc_val;\r\n}\r\nstatic int ps3_get_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nrtc_time_to_tm(read_rtc() + ps3_os_area_get_rtc_diff(), tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int ps3_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long now;\r\nrtc_tm_to_time(tm, &now);\r\nps3_os_area_set_rtc_diff(now - read_rtc());\r\nreturn 0;\r\n}\r\nstatic int __init ps3_rtc_probe(struct platform_device *dev)\r\n{\r\nstruct rtc_device *rtc;\r\nrtc = devm_rtc_device_register(&dev->dev, "rtc-ps3", &ps3_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nplatform_set_drvdata(dev, rtc);\r\nreturn 0;\r\n}

static int devfreq_userspace_func(struct devfreq *df, unsigned long *freq)\r\n{\r\nstruct userspace_data *data = df->data;\r\nif (data->valid) {\r\nunsigned long adjusted_freq = data->user_frequency;\r\nif (df->max_freq && adjusted_freq > df->max_freq)\r\nadjusted_freq = df->max_freq;\r\nif (df->min_freq && adjusted_freq < df->min_freq)\r\nadjusted_freq = df->min_freq;\r\n*freq = adjusted_freq;\r\n} else {\r\n*freq = df->previous_freq;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t store_freq(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct devfreq *devfreq = to_devfreq(dev);\r\nstruct userspace_data *data;\r\nunsigned long wanted;\r\nint err = 0;\r\nmutex_lock(&devfreq->lock);\r\ndata = devfreq->data;\r\nsscanf(buf, "%lu", &wanted);\r\ndata->user_frequency = wanted;\r\ndata->valid = true;\r\nerr = update_devfreq(devfreq);\r\nif (err == 0)\r\nerr = count;\r\nmutex_unlock(&devfreq->lock);\r\nreturn err;\r\n}\r\nstatic ssize_t show_freq(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct devfreq *devfreq = to_devfreq(dev);\r\nstruct userspace_data *data;\r\nint err = 0;\r\nmutex_lock(&devfreq->lock);\r\ndata = devfreq->data;\r\nif (data->valid)\r\nerr = sprintf(buf, "%lu\n", data->user_frequency);\r\nelse\r\nerr = sprintf(buf, "undefined\n");\r\nmutex_unlock(&devfreq->lock);\r\nreturn err;\r\n}\r\nstatic int userspace_init(struct devfreq *devfreq)\r\n{\r\nint err = 0;\r\nstruct userspace_data *data = kzalloc(sizeof(struct userspace_data),\r\nGFP_KERNEL);\r\nif (!data) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\ndata->valid = false;\r\ndevfreq->data = data;\r\nerr = sysfs_create_group(&devfreq->dev.kobj, &dev_attr_group);\r\nout:\r\nreturn err;\r\n}\r\nstatic void userspace_exit(struct devfreq *devfreq)\r\n{\r\nsysfs_remove_group(&devfreq->dev.kobj, &dev_attr_group);\r\nkfree(devfreq->data);\r\ndevfreq->data = NULL;\r\n}\r\nstatic int devfreq_userspace_handler(struct devfreq *devfreq,\r\nunsigned int event, void *data)\r\n{\r\nint ret = 0;\r\nswitch (event) {\r\ncase DEVFREQ_GOV_START:\r\nret = userspace_init(devfreq);\r\nbreak;\r\ncase DEVFREQ_GOV_STOP:\r\nuserspace_exit(devfreq);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init devfreq_userspace_init(void)\r\n{\r\nreturn devfreq_add_governor(&devfreq_userspace);\r\n}\r\nstatic void __exit devfreq_userspace_exit(void)\r\n{\r\nint ret;\r\nret = devfreq_remove_governor(&devfreq_userspace);\r\nif (ret)\r\npr_err("%s: failed remove governor %d\n", __func__, ret);\r\nreturn;\r\n}

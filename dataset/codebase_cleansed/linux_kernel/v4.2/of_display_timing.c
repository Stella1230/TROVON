static int parse_timing_property(const struct device_node *np, const char *name,\r\nstruct timing_entry *result)\r\n{\r\nstruct property *prop;\r\nint length, cells, ret;\r\nprop = of_find_property(np, name, &length);\r\nif (!prop) {\r\npr_err("%s: could not find property %s\n",\r\nof_node_full_name(np), name);\r\nreturn -EINVAL;\r\n}\r\ncells = length / sizeof(u32);\r\nif (cells == 1) {\r\nret = of_property_read_u32(np, name, &result->typ);\r\nresult->min = result->typ;\r\nresult->max = result->typ;\r\n} else if (cells == 3) {\r\nret = of_property_read_u32_array(np, name, &result->min, cells);\r\n} else {\r\npr_err("%s: illegal timing specification in %s\n",\r\nof_node_full_name(np), name);\r\nreturn -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int of_parse_display_timing(const struct device_node *np,\r\nstruct display_timing *dt)\r\n{\r\nu32 val = 0;\r\nint ret = 0;\r\nmemset(dt, 0, sizeof(*dt));\r\nret |= parse_timing_property(np, "hback-porch", &dt->hback_porch);\r\nret |= parse_timing_property(np, "hfront-porch", &dt->hfront_porch);\r\nret |= parse_timing_property(np, "hactive", &dt->hactive);\r\nret |= parse_timing_property(np, "hsync-len", &dt->hsync_len);\r\nret |= parse_timing_property(np, "vback-porch", &dt->vback_porch);\r\nret |= parse_timing_property(np, "vfront-porch", &dt->vfront_porch);\r\nret |= parse_timing_property(np, "vactive", &dt->vactive);\r\nret |= parse_timing_property(np, "vsync-len", &dt->vsync_len);\r\nret |= parse_timing_property(np, "clock-frequency", &dt->pixelclock);\r\ndt->flags = 0;\r\nif (!of_property_read_u32(np, "vsync-active", &val))\r\ndt->flags |= val ? DISPLAY_FLAGS_VSYNC_HIGH :\r\nDISPLAY_FLAGS_VSYNC_LOW;\r\nif (!of_property_read_u32(np, "hsync-active", &val))\r\ndt->flags |= val ? DISPLAY_FLAGS_HSYNC_HIGH :\r\nDISPLAY_FLAGS_HSYNC_LOW;\r\nif (!of_property_read_u32(np, "de-active", &val))\r\ndt->flags |= val ? DISPLAY_FLAGS_DE_HIGH :\r\nDISPLAY_FLAGS_DE_LOW;\r\nif (!of_property_read_u32(np, "pixelclk-active", &val))\r\ndt->flags |= val ? DISPLAY_FLAGS_PIXDATA_POSEDGE :\r\nDISPLAY_FLAGS_PIXDATA_NEGEDGE;\r\nif (of_property_read_bool(np, "interlaced"))\r\ndt->flags |= DISPLAY_FLAGS_INTERLACED;\r\nif (of_property_read_bool(np, "doublescan"))\r\ndt->flags |= DISPLAY_FLAGS_DOUBLESCAN;\r\nif (of_property_read_bool(np, "doubleclk"))\r\ndt->flags |= DISPLAY_FLAGS_DOUBLECLK;\r\nif (ret) {\r\npr_err("%s: error reading timing properties\n",\r\nof_node_full_name(np));\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint of_get_display_timing(struct device_node *np, const char *name,\r\nstruct display_timing *dt)\r\n{\r\nstruct device_node *timing_np;\r\nif (!np)\r\nreturn -EINVAL;\r\ntiming_np = of_get_child_by_name(np, name);\r\nif (!timing_np) {\r\npr_err("%s: could not find node '%s'\n",\r\nof_node_full_name(np), name);\r\nreturn -ENOENT;\r\n}\r\nreturn of_parse_display_timing(timing_np, dt);\r\n}\r\nstruct display_timings *of_get_display_timings(struct device_node *np)\r\n{\r\nstruct device_node *timings_np;\r\nstruct device_node *entry;\r\nstruct device_node *native_mode;\r\nstruct display_timings *disp;\r\nif (!np)\r\nreturn NULL;\r\ntimings_np = of_get_child_by_name(np, "display-timings");\r\nif (!timings_np) {\r\npr_err("%s: could not find display-timings node\n",\r\nof_node_full_name(np));\r\nreturn NULL;\r\n}\r\ndisp = kzalloc(sizeof(*disp), GFP_KERNEL);\r\nif (!disp) {\r\npr_err("%s: could not allocate struct disp'\n",\r\nof_node_full_name(np));\r\ngoto dispfail;\r\n}\r\nentry = of_parse_phandle(timings_np, "native-mode", 0);\r\nif (!entry)\r\nentry = of_get_next_child(timings_np, NULL);\r\nif (!entry) {\r\npr_err("%s: no timing specifications given\n",\r\nof_node_full_name(np));\r\ngoto entryfail;\r\n}\r\npr_debug("%s: using %s as default timing\n",\r\nof_node_full_name(np), entry->name);\r\nnative_mode = entry;\r\ndisp->num_timings = of_get_child_count(timings_np);\r\nif (disp->num_timings == 0) {\r\npr_err("%s: no timings specified\n", of_node_full_name(np));\r\ngoto entryfail;\r\n}\r\ndisp->timings = kzalloc(sizeof(struct display_timing *) *\r\ndisp->num_timings, GFP_KERNEL);\r\nif (!disp->timings) {\r\npr_err("%s: could not allocate timings array\n",\r\nof_node_full_name(np));\r\ngoto entryfail;\r\n}\r\ndisp->num_timings = 0;\r\ndisp->native_mode = 0;\r\nfor_each_child_of_node(timings_np, entry) {\r\nstruct display_timing *dt;\r\nint r;\r\ndt = kzalloc(sizeof(*dt), GFP_KERNEL);\r\nif (!dt) {\r\npr_err("%s: could not allocate display_timing struct\n",\r\nof_node_full_name(np));\r\ngoto timingfail;\r\n}\r\nr = of_parse_display_timing(entry, dt);\r\nif (r) {\r\npr_err("%s: error in timing %d\n",\r\nof_node_full_name(np), disp->num_timings + 1);\r\ngoto timingfail;\r\n}\r\nif (native_mode == entry)\r\ndisp->native_mode = disp->num_timings;\r\ndisp->timings[disp->num_timings] = dt;\r\ndisp->num_timings++;\r\n}\r\nof_node_put(timings_np);\r\nof_node_put(native_mode);\r\npr_debug("%s: got %d timings. Using timing #%d as default\n",\r\nof_node_full_name(np), disp->num_timings,\r\ndisp->native_mode + 1);\r\nreturn disp;\r\ntimingfail:\r\nof_node_put(native_mode);\r\ndisplay_timings_release(disp);\r\ndisp = NULL;\r\nentryfail:\r\nkfree(disp);\r\ndispfail:\r\nof_node_put(timings_np);\r\nreturn NULL;\r\n}\r\nint of_display_timings_exist(struct device_node *np)\r\n{\r\nstruct device_node *timings_np;\r\nif (!np)\r\nreturn -EINVAL;\r\ntimings_np = of_parse_phandle(np, "display-timings", 0);\r\nif (!timings_np)\r\nreturn -EINVAL;\r\nof_node_put(timings_np);\r\nreturn 1;\r\n}

int of_get_dma_window(struct device_node *dn, const char *prefix, int index,\r\nunsigned long *busno, dma_addr_t *addr, size_t *size)\r\n{\r\nconst __be32 *dma_window, *end;\r\nint bytes, cur_index = 0;\r\nchar propname[NAME_MAX], addrname[NAME_MAX], sizename[NAME_MAX];\r\nif (!dn || !addr || !size)\r\nreturn -EINVAL;\r\nif (!prefix)\r\nprefix = "";\r\nsnprintf(propname, sizeof(propname), "%sdma-window", prefix);\r\nsnprintf(addrname, sizeof(addrname), "%s#dma-address-cells", prefix);\r\nsnprintf(sizename, sizeof(sizename), "%s#dma-size-cells", prefix);\r\ndma_window = of_get_property(dn, propname, &bytes);\r\nif (!dma_window)\r\nreturn -ENODEV;\r\nend = dma_window + bytes / sizeof(*dma_window);\r\nwhile (dma_window < end) {\r\nu32 cells;\r\nconst void *prop;\r\nif (busno)\r\n*busno = be32_to_cpup(dma_window++);\r\nprop = of_get_property(dn, addrname, NULL);\r\nif (!prop)\r\nprop = of_get_property(dn, "#address-cells", NULL);\r\ncells = prop ? be32_to_cpup(prop) : of_n_addr_cells(dn);\r\nif (!cells)\r\nreturn -EINVAL;\r\n*addr = of_read_number(dma_window, cells);\r\ndma_window += cells;\r\nprop = of_get_property(dn, sizename, NULL);\r\ncells = prop ? be32_to_cpup(prop) : of_n_size_cells(dn);\r\nif (!cells)\r\nreturn -EINVAL;\r\n*size = of_read_number(dma_window, cells);\r\ndma_window += cells;\r\nif (cur_index++ == index)\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid of_iommu_set_ops(struct device_node *np, struct iommu_ops *ops)\r\n{\r\nstruct of_iommu_node *iommu = kzalloc(sizeof(*iommu), GFP_KERNEL);\r\nif (WARN_ON(!iommu))\r\nreturn;\r\nINIT_LIST_HEAD(&iommu->list);\r\niommu->np = np;\r\niommu->ops = ops;\r\nspin_lock(&of_iommu_lock);\r\nlist_add_tail(&iommu->list, &of_iommu_list);\r\nspin_unlock(&of_iommu_lock);\r\n}\r\nstruct iommu_ops *of_iommu_get_ops(struct device_node *np)\r\n{\r\nstruct of_iommu_node *node;\r\nstruct iommu_ops *ops = NULL;\r\nspin_lock(&of_iommu_lock);\r\nlist_for_each_entry(node, &of_iommu_list, list)\r\nif (node->np == np) {\r\nops = node->ops;\r\nbreak;\r\n}\r\nspin_unlock(&of_iommu_lock);\r\nreturn ops;\r\n}\r\nstruct iommu_ops *of_iommu_configure(struct device *dev,\r\nstruct device_node *master_np)\r\n{\r\nstruct of_phandle_args iommu_spec;\r\nstruct device_node *np;\r\nstruct iommu_ops *ops = NULL;\r\nint idx = 0;\r\nif (dev_is_pci(dev)) {\r\ndev_err(dev, "IOMMU is currently not supported for PCI\n");\r\nreturn NULL;\r\n}\r\nwhile (!of_parse_phandle_with_args(master_np, "iommus",\r\n"#iommu-cells", idx,\r\n&iommu_spec)) {\r\nnp = iommu_spec.np;\r\nops = of_iommu_get_ops(np);\r\nif (!ops || !ops->of_xlate || ops->of_xlate(dev, &iommu_spec))\r\ngoto err_put_node;\r\nof_node_put(np);\r\nidx++;\r\n}\r\nreturn ops;\r\nerr_put_node:\r\nof_node_put(np);\r\nreturn NULL;\r\n}\r\nvoid __init of_iommu_init(void)\r\n{\r\nstruct device_node *np;\r\nconst struct of_device_id *match, *matches = &__iommu_of_table;\r\nfor_each_matching_node_and_match(np, matches, &match) {\r\nconst of_iommu_init_fn init_fn = match->data;\r\nif (init_fn(np))\r\npr_err("Failed to initialise IOMMU %s\n",\r\nof_node_full_name(np));\r\n}\r\n}

static int com20020pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct com20020_pci_card_info *ci;\r\nstruct net_device *dev;\r\nstruct arcnet_local *lp;\r\nstruct com20020_priv *priv;\r\nint i, ioaddr, ret;\r\nstruct resource *r;\r\nif (pci_enable_device(pdev))\r\nreturn -EIO;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(struct com20020_priv),\r\nGFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nci = (struct com20020_pci_card_info *)id->driver_data;\r\npriv->ci = ci;\r\nINIT_LIST_HEAD(&priv->list_dev);\r\nfor (i = 0; i < ci->devcount; i++) {\r\nstruct com20020_pci_channel_map *cm = &ci->chan_map_tbl[i];\r\nstruct com20020_dev *card;\r\ndev = alloc_arcdev(device);\r\nif (!dev) {\r\nret = -ENOMEM;\r\ngoto out_port;\r\n}\r\ndev->netdev_ops = &com20020_netdev_ops;\r\nlp = netdev_priv(dev);\r\nBUGMSG(D_NORMAL, "%s Controls\n", ci->name);\r\nioaddr = pci_resource_start(pdev, cm->bar) + cm->offset;\r\nr = devm_request_region(&pdev->dev, ioaddr, cm->size,\r\n"com20020-pci");\r\nif (!r) {\r\npr_err("IO region %xh-%xh already allocated.\n",\r\nioaddr, ioaddr + cm->size - 1);\r\nret = -EBUSY;\r\ngoto out_port;\r\n}\r\noutb(0x00, ioaddr + 1);\r\ninb(ioaddr + 1);\r\ndev->base_addr = ioaddr;\r\ndev->dev_addr[0] = node;\r\ndev->irq = pdev->irq;\r\nlp->card_name = "PCI COM20020";\r\nlp->card_flags = ci->flags;\r\nlp->backplane = backplane;\r\nlp->clockp = clockp & 7;\r\nlp->clockm = clockm & 3;\r\nlp->timeout = timeout;\r\nlp->hw.owner = THIS_MODULE;\r\nif (ASTATUS() == 0xFF) {\r\npr_err("IO address %Xh is empty!\n", ioaddr);\r\nret = -EIO;\r\ngoto out_port;\r\n}\r\nif (com20020_check(dev)) {\r\nret = -EIO;\r\ngoto out_port;\r\n}\r\ncard = devm_kzalloc(&pdev->dev, sizeof(struct com20020_dev),\r\nGFP_KERNEL);\r\nif (!card) {\r\npr_err("%s out of memory!\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\ncard->index = i;\r\ncard->pci_priv = priv;\r\ncard->dev = dev;\r\ndev_set_drvdata(&dev->dev, card);\r\nret = com20020_found(dev, IRQF_SHARED);\r\nif (ret)\r\ngoto out_port;\r\nlist_add(&card->list, &priv->list_dev);\r\n}\r\npci_set_drvdata(pdev, priv);\r\nreturn 0;\r\nout_port:\r\ncom20020pci_remove(pdev);\r\nreturn ret;\r\n}\r\nstatic void com20020pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct com20020_dev *card, *tmpcard;\r\nstruct com20020_priv *priv;\r\npriv = pci_get_drvdata(pdev);\r\nlist_for_each_entry_safe(card, tmpcard, &priv->list_dev, list) {\r\nstruct net_device *dev = card->dev;\r\nunregister_netdev(dev);\r\nfree_irq(dev->irq, dev);\r\nfree_netdev(dev);\r\n}\r\n}\r\nstatic int __init com20020pci_init(void)\r\n{\r\nBUGLVL(D_NORMAL) printk(VERSION);\r\nreturn pci_register_driver(&com20020pci_driver);\r\n}\r\nstatic void __exit com20020pci_cleanup(void)\r\n{\r\npci_unregister_driver(&com20020pci_driver);\r\n}

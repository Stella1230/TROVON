static int rsnd_is_accessible_reg(struct rsnd_priv *priv,\r\nstruct rsnd_gen *gen, enum rsnd_reg reg)\r\n{\r\nif (!gen->regs[reg]) {\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\ndev_err(dev, "unsupported register access %x\n", reg);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nu32 rsnd_read(struct rsnd_priv *priv,\r\nstruct rsnd_mod *mod, enum rsnd_reg reg)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nu32 val;\r\nif (!rsnd_is_accessible_reg(priv, gen, reg))\r\nreturn 0;\r\ndev_dbg(dev, "r %s[%d] - %4d : %08x\n",\r\nrsnd_mod_name(mod), rsnd_mod_id(mod), reg, val);\r\nregmap_fields_read(gen->regs[reg], rsnd_mod_id(mod), &val);\r\nreturn val;\r\n}\r\nvoid rsnd_write(struct rsnd_priv *priv,\r\nstruct rsnd_mod *mod,\r\nenum rsnd_reg reg, u32 data)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nif (!rsnd_is_accessible_reg(priv, gen, reg))\r\nreturn;\r\ndev_dbg(dev, "w %s[%d] - %4d : %08x\n",\r\nrsnd_mod_name(mod), rsnd_mod_id(mod), reg, data);\r\nregmap_fields_write(gen->regs[reg], rsnd_mod_id(mod), data);\r\n}\r\nvoid rsnd_bset(struct rsnd_priv *priv, struct rsnd_mod *mod,\r\nenum rsnd_reg reg, u32 mask, u32 data)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nif (!rsnd_is_accessible_reg(priv, gen, reg))\r\nreturn;\r\ndev_dbg(dev, "b %s[%d] - %4d : %08x/%08x\n",\r\nrsnd_mod_name(mod), rsnd_mod_id(mod), reg, data, mask);\r\nregmap_fields_update_bits(gen->regs[reg], rsnd_mod_id(mod),\r\nmask, data);\r\n}\r\nphys_addr_t rsnd_gen_get_phy_addr(struct rsnd_priv *priv, int reg_id)\r\n{\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nreturn gen->res[reg_id];\r\n}\r\nstatic int _rsnd_gen_regmap_init(struct rsnd_priv *priv,\r\nint id_size,\r\nint reg_id,\r\nconst char *name,\r\nstruct rsnd_regmap_field_conf *conf,\r\nint conf_size)\r\n{\r\nstruct platform_device *pdev = rsnd_priv_to_pdev(priv);\r\nstruct rsnd_gen *gen = rsnd_priv_to_gen(priv);\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct resource *res;\r\nstruct regmap_config regc;\r\nstruct regmap_field *regs;\r\nstruct regmap *regmap;\r\nstruct reg_field regf;\r\nvoid __iomem *base;\r\nint i;\r\nmemset(&regc, 0, sizeof(regc));\r\nregc.reg_bits = 32;\r\nregc.val_bits = 32;\r\nregc.reg_stride = 4;\r\nregc.name = name;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, name);\r\nif (!res)\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, reg_id);\r\nif (!res)\r\nreturn -ENODEV;\r\nbase = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nregmap = devm_regmap_init_mmio(dev, base, &regc);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\ngen->base[reg_id] = base;\r\ngen->regmap[reg_id] = regmap;\r\ngen->res[reg_id] = res->start;\r\nfor (i = 0; i < conf_size; i++) {\r\nregf.reg = conf[i].reg_offset;\r\nregf.id_offset = conf[i].id_offset;\r\nregf.lsb = 0;\r\nregf.msb = 31;\r\nregf.id_size = id_size;\r\nregs = devm_regmap_field_alloc(dev, regmap, regf);\r\nif (IS_ERR(regs))\r\nreturn PTR_ERR(regs);\r\ngen->regs[conf[i].idx] = regs;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rsnd_gen2_probe(struct platform_device *pdev,\r\nstruct rsnd_priv *priv)\r\n{\r\nstruct rsnd_regmap_field_conf conf_ssiu[] = {\r\nRSND_GEN_S_REG(SSI_MODE0, 0x800),\r\nRSND_GEN_S_REG(SSI_MODE1, 0x804),\r\nRSND_GEN_M_REG(SSI_BUSIF_MODE, 0x0, 0x80),\r\nRSND_GEN_M_REG(SSI_BUSIF_ADINR, 0x4, 0x80),\r\nRSND_GEN_M_REG(BUSIF_DALIGN, 0x8, 0x80),\r\nRSND_GEN_M_REG(SSI_CTRL, 0x10, 0x80),\r\nRSND_GEN_M_REG(INT_ENABLE, 0x18, 0x80),\r\n};\r\nstruct rsnd_regmap_field_conf conf_scu[] = {\r\nRSND_GEN_M_REG(SRC_BUSIF_MODE, 0x0, 0x20),\r\nRSND_GEN_M_REG(SRC_ROUTE_MODE0, 0xc, 0x20),\r\nRSND_GEN_M_REG(SRC_CTRL, 0x10, 0x20),\r\nRSND_GEN_M_REG(SRC_INT_ENABLE0, 0x18, 0x20),\r\nRSND_GEN_M_REG(CMD_ROUTE_SLCT, 0x18c, 0x20),\r\nRSND_GEN_M_REG(CMD_CTRL, 0x190, 0x20),\r\nRSND_GEN_S_REG(SCU_SYS_STATUS0, 0x1c8),\r\nRSND_GEN_S_REG(SCU_SYS_INT_EN0, 0x1cc),\r\nRSND_GEN_S_REG(SCU_SYS_STATUS1, 0x1d0),\r\nRSND_GEN_S_REG(SCU_SYS_INT_EN1, 0x1c4),\r\nRSND_GEN_M_REG(SRC_SWRSR, 0x200, 0x40),\r\nRSND_GEN_M_REG(SRC_SRCIR, 0x204, 0x40),\r\nRSND_GEN_M_REG(SRC_ADINR, 0x214, 0x40),\r\nRSND_GEN_M_REG(SRC_IFSCR, 0x21c, 0x40),\r\nRSND_GEN_M_REG(SRC_IFSVR, 0x220, 0x40),\r\nRSND_GEN_M_REG(SRC_SRCCR, 0x224, 0x40),\r\nRSND_GEN_M_REG(SRC_BSDSR, 0x22c, 0x40),\r\nRSND_GEN_M_REG(SRC_BSISR, 0x238, 0x40),\r\nRSND_GEN_M_REG(DVC_SWRSR, 0xe00, 0x100),\r\nRSND_GEN_M_REG(DVC_DVUIR, 0xe04, 0x100),\r\nRSND_GEN_M_REG(DVC_ADINR, 0xe08, 0x100),\r\nRSND_GEN_M_REG(DVC_DVUCR, 0xe10, 0x100),\r\nRSND_GEN_M_REG(DVC_ZCMCR, 0xe14, 0x100),\r\nRSND_GEN_M_REG(DVC_VRCTR, 0xe18, 0x100),\r\nRSND_GEN_M_REG(DVC_VRPDR, 0xe1c, 0x100),\r\nRSND_GEN_M_REG(DVC_VRDBR, 0xe20, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL0R, 0xe28, 0x100),\r\nRSND_GEN_M_REG(DVC_VOL1R, 0xe2c, 0x100),\r\nRSND_GEN_M_REG(DVC_DVUER, 0xe48, 0x100),\r\n};\r\nstruct rsnd_regmap_field_conf conf_adg[] = {\r\nRSND_GEN_S_REG(BRRA, 0x00),\r\nRSND_GEN_S_REG(BRRB, 0x04),\r\nRSND_GEN_S_REG(SSICKR, 0x08),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL0, 0x0c),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL1, 0x10),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL2, 0x14),\r\nRSND_GEN_S_REG(DIV_EN, 0x30),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL0, 0x34),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL1, 0x38),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL2, 0x3c),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL3, 0x40),\r\nRSND_GEN_S_REG(SRCIN_TIMSEL4, 0x44),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL0, 0x48),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL1, 0x4c),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL2, 0x50),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL3, 0x54),\r\nRSND_GEN_S_REG(SRCOUT_TIMSEL4, 0x58),\r\nRSND_GEN_S_REG(CMDOUT_TIMSEL, 0x5c),\r\n};\r\nstruct rsnd_regmap_field_conf conf_ssi[] = {\r\nRSND_GEN_M_REG(SSICR, 0x00, 0x40),\r\nRSND_GEN_M_REG(SSISR, 0x04, 0x40),\r\nRSND_GEN_M_REG(SSITDR, 0x08, 0x40),\r\nRSND_GEN_M_REG(SSIRDR, 0x0c, 0x40),\r\nRSND_GEN_M_REG(SSIWSR, 0x20, 0x40),\r\n};\r\nint ret_ssiu;\r\nint ret_scu;\r\nint ret_adg;\r\nint ret_ssi;\r\nret_ssiu = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_SSIU, "ssiu", conf_ssiu);\r\nret_scu = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_SCU, "scu", conf_scu);\r\nret_adg = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_ADG, "adg", conf_adg);\r\nret_ssi = rsnd_gen_regmap_init(priv, 10, RSND_GEN2_SSI, "ssi", conf_ssi);\r\nif (ret_ssiu < 0 ||\r\nret_scu < 0 ||\r\nret_adg < 0 ||\r\nret_ssi < 0)\r\nreturn ret_ssiu | ret_scu | ret_adg | ret_ssi;\r\nreturn 0;\r\n}\r\nstatic int rsnd_gen1_probe(struct platform_device *pdev,\r\nstruct rsnd_priv *priv)\r\n{\r\nstruct rsnd_regmap_field_conf conf_sru[] = {\r\nRSND_GEN_S_REG(SRC_ROUTE_SEL, 0x00),\r\nRSND_GEN_S_REG(SRC_TMG_SEL0, 0x08),\r\nRSND_GEN_S_REG(SRC_TMG_SEL1, 0x0c),\r\nRSND_GEN_S_REG(SRC_TMG_SEL2, 0x10),\r\nRSND_GEN_S_REG(SRC_ROUTE_CTRL, 0xc0),\r\nRSND_GEN_S_REG(SSI_MODE0, 0xD0),\r\nRSND_GEN_S_REG(SSI_MODE1, 0xD4),\r\nRSND_GEN_M_REG(SRC_BUSIF_MODE, 0x20, 0x4),\r\nRSND_GEN_M_REG(SRC_ROUTE_MODE0, 0x50, 0x8),\r\nRSND_GEN_M_REG(SRC_SWRSR, 0x200, 0x40),\r\nRSND_GEN_M_REG(SRC_SRCIR, 0x204, 0x40),\r\nRSND_GEN_M_REG(SRC_ADINR, 0x214, 0x40),\r\nRSND_GEN_M_REG(SRC_IFSCR, 0x21c, 0x40),\r\nRSND_GEN_M_REG(SRC_IFSVR, 0x220, 0x40),\r\nRSND_GEN_M_REG(SRC_SRCCR, 0x224, 0x40),\r\nRSND_GEN_M_REG(SRC_MNFSR, 0x228, 0x40),\r\n};\r\nstruct rsnd_regmap_field_conf conf_adg[] = {\r\nRSND_GEN_S_REG(BRRA, 0x00),\r\nRSND_GEN_S_REG(BRRB, 0x04),\r\nRSND_GEN_S_REG(SSICKR, 0x08),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL0, 0x0c),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL1, 0x10),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL3, 0x18),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL4, 0x1c),\r\nRSND_GEN_S_REG(AUDIO_CLK_SEL5, 0x20),\r\n};\r\nstruct rsnd_regmap_field_conf conf_ssi[] = {\r\nRSND_GEN_M_REG(SSICR, 0x00, 0x40),\r\nRSND_GEN_M_REG(SSISR, 0x04, 0x40),\r\nRSND_GEN_M_REG(SSITDR, 0x08, 0x40),\r\nRSND_GEN_M_REG(SSIRDR, 0x0c, 0x40),\r\nRSND_GEN_M_REG(SSIWSR, 0x20, 0x40),\r\n};\r\nint ret_sru;\r\nint ret_adg;\r\nint ret_ssi;\r\nret_sru = rsnd_gen_regmap_init(priv, 9, RSND_GEN1_SRU, "sru", conf_sru);\r\nret_adg = rsnd_gen_regmap_init(priv, 9, RSND_GEN1_ADG, "adg", conf_adg);\r\nret_ssi = rsnd_gen_regmap_init(priv, 9, RSND_GEN1_SSI, "ssi", conf_ssi);\r\nif (ret_sru < 0 ||\r\nret_adg < 0 ||\r\nret_ssi < 0)\r\nreturn ret_sru | ret_adg | ret_ssi;\r\nreturn 0;\r\n}\r\nstatic void rsnd_of_parse_gen(struct platform_device *pdev,\r\nconst struct rsnd_of_data *of_data,\r\nstruct rsnd_priv *priv)\r\n{\r\nstruct rcar_snd_info *info = priv->info;\r\nif (!of_data)\r\nreturn;\r\ninfo->flags = of_data->flags;\r\n}\r\nint rsnd_gen_probe(struct platform_device *pdev,\r\nconst struct rsnd_of_data *of_data,\r\nstruct rsnd_priv *priv)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_gen *gen;\r\nint ret;\r\nrsnd_of_parse_gen(pdev, of_data, priv);\r\ngen = devm_kzalloc(dev, sizeof(*gen), GFP_KERNEL);\r\nif (!gen) {\r\ndev_err(dev, "GEN allocate failed\n");\r\nreturn -ENOMEM;\r\n}\r\npriv->gen = gen;\r\nret = -ENODEV;\r\nif (rsnd_is_gen1(priv))\r\nret = rsnd_gen1_probe(pdev, priv);\r\nelse if (rsnd_is_gen2(priv))\r\nret = rsnd_gen2_probe(pdev, priv);\r\nif (ret < 0)\r\ndev_err(dev, "unknown generation R-Car sound device\n");\r\nreturn ret;\r\n}

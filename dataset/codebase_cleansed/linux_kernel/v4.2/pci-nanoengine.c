static void __iomem *nanoengine_pci_map_bus(struct pci_bus *bus,\r\nunsigned int devfn, int where)\r\n{\r\nif (bus->number != 0 || (devfn >> 3) != 0)\r\nreturn NULL;\r\nreturn (void __iomem *)NANO_PCI_CONFIG_SPACE_VIRT +\r\n((bus->number << 16) | (devfn << 8) | (where & ~3));\r\n}\r\nstatic int __init pci_nanoengine_map_irq(const struct pci_dev *dev, u8 slot,\r\nu8 pin)\r\n{\r\nreturn NANOENGINE_IRQ_GPIO_PCI;\r\n}\r\nstatic int __init pci_nanoengine_setup_resources(struct pci_sys_data *sys)\r\n{\r\nif (request_resource(&ioport_resource, &pci_io_ports)) {\r\nprintk(KERN_ERR "PCI: unable to allocate io port region\n");\r\nreturn -EBUSY;\r\n}\r\nif (request_resource(&iomem_resource, &pci_non_prefetchable_memory)) {\r\nrelease_resource(&pci_io_ports);\r\nprintk(KERN_ERR "PCI: unable to allocate non prefetchable\n");\r\nreturn -EBUSY;\r\n}\r\nif (request_resource(&iomem_resource, &pci_prefetchable_memory)) {\r\nrelease_resource(&pci_io_ports);\r\nrelease_resource(&pci_non_prefetchable_memory);\r\nprintk(KERN_ERR "PCI: unable to allocate prefetchable\n");\r\nreturn -EBUSY;\r\n}\r\npci_add_resource_offset(&sys->resources, &pci_io_ports, sys->io_offset);\r\npci_add_resource_offset(&sys->resources,\r\n&pci_non_prefetchable_memory, sys->mem_offset);\r\npci_add_resource_offset(&sys->resources,\r\n&pci_prefetchable_memory, sys->mem_offset);\r\nreturn 1;\r\n}\r\nint __init pci_nanoengine_setup(int nr, struct pci_sys_data *sys)\r\n{\r\nint ret = 0;\r\npcibios_min_io = 0;\r\npcibios_min_mem = 0;\r\nif (nr == 0) {\r\nsys->mem_offset = NANO_PCI_MEM_RW_PHYS;\r\nsys->io_offset = 0x400;\r\nret = pci_nanoengine_setup_resources(sys);\r\nGPDR = (GPDR & ~GPIO_MBREQ) | GPIO_MBGNT;\r\nGAFR |= GPIO_MBGNT | GPIO_MBREQ;\r\nTUCR |= TUCR_MBGPIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init nanoengine_pci_init(void)\r\n{\r\nif (machine_is_nanoengine())\r\npci_common_init(&nanoengine_pci);\r\nreturn 0;\r\n}

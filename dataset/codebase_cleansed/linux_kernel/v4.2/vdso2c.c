static void fail(const char *format, ...)\r\n{\r\nva_list ap;\r\nva_start(ap, format);\r\nfprintf(stderr, "Error: ");\r\nvfprintf(stderr, format, ap);\r\nif (outfilename)\r\nunlink(outfilename);\r\nexit(1);\r\nva_end(ap);\r\n}\r\nstatic void go(void *raw_addr, size_t raw_len,\r\nvoid *stripped_addr, size_t stripped_len,\r\nFILE *outfile, const char *name)\r\n{\r\nElf64_Ehdr *hdr = (Elf64_Ehdr *)raw_addr;\r\nif (hdr->e_ident[EI_CLASS] == ELFCLASS64) {\r\ngo64(raw_addr, raw_len, stripped_addr, stripped_len,\r\noutfile, name);\r\n} else if (hdr->e_ident[EI_CLASS] == ELFCLASS32) {\r\ngo32(raw_addr, raw_len, stripped_addr, stripped_len,\r\noutfile, name);\r\n} else {\r\nfail("unknown ELF class\n");\r\n}\r\n}\r\nstatic void map_input(const char *name, void **addr, size_t *len, int prot)\r\n{\r\noff_t tmp_len;\r\nint fd = open(name, O_RDONLY);\r\nif (fd == -1)\r\nerr(1, "%s", name);\r\ntmp_len = lseek(fd, 0, SEEK_END);\r\nif (tmp_len == (off_t)-1)\r\nerr(1, "lseek");\r\n*len = (size_t)tmp_len;\r\n*addr = mmap(NULL, tmp_len, prot, MAP_PRIVATE, fd, 0);\r\nif (*addr == MAP_FAILED)\r\nerr(1, "mmap");\r\nclose(fd);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nsize_t raw_len, stripped_len;\r\nvoid *raw_addr, *stripped_addr;\r\nFILE *outfile;\r\nchar *name, *tmp;\r\nint namelen;\r\nif (argc != 4) {\r\nprintf("Usage: vdso2c RAW_INPUT STRIPPED_INPUT OUTPUT\n");\r\nreturn 1;\r\n}\r\nname = strdup(argv[3]);\r\nnamelen = strlen(name);\r\nif (namelen >= 3 && !strcmp(name + namelen - 3, ".so")) {\r\nname = NULL;\r\n} else {\r\ntmp = strrchr(name, '/');\r\nif (tmp)\r\nname = tmp + 1;\r\ntmp = strchr(name, '.');\r\nif (tmp)\r\n*tmp = '\0';\r\nfor (tmp = name; *tmp; tmp++)\r\nif (*tmp == '-')\r\n*tmp = '_';\r\n}\r\nmap_input(argv[1], &raw_addr, &raw_len, PROT_READ);\r\nmap_input(argv[2], &stripped_addr, &stripped_len, PROT_READ);\r\noutfilename = argv[3];\r\noutfile = fopen(outfilename, "w");\r\nif (!outfile)\r\nerr(1, "%s", argv[2]);\r\ngo(raw_addr, raw_len, stripped_addr, stripped_len, outfile, name);\r\nmunmap(raw_addr, raw_len);\r\nmunmap(stripped_addr, stripped_len);\r\nfclose(outfile);\r\nreturn 0;\r\n}

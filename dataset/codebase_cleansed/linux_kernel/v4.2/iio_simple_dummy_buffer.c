static irqreturn_t iio_simple_dummy_trigger_h(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nint len = 0;\r\nu16 *data;\r\ndata = kmalloc(indio_dev->scan_bytes, GFP_KERNEL);\r\nif (!data)\r\ngoto done;\r\nif (!bitmap_empty(indio_dev->active_scan_mask, indio_dev->masklength)) {\r\nint i, j;\r\nfor (i = 0, j = 0;\r\ni < bitmap_weight(indio_dev->active_scan_mask,\r\nindio_dev->masklength);\r\ni++, j++) {\r\nj = find_next_bit(indio_dev->active_scan_mask,\r\nindio_dev->masklength, j);\r\ndata[i] = fakedata[j];\r\nlen += 2;\r\n}\r\n}\r\niio_push_to_buffers_with_timestamp(indio_dev, data, iio_get_time_ns());\r\nkfree(data);\r\ndone:\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nint iio_simple_dummy_configure_buffer(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct iio_buffer *buffer;\r\nbuffer = iio_kfifo_allocate();\r\nif (!buffer) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\niio_device_attach_buffer(indio_dev, buffer);\r\nbuffer->scan_timestamp = true;\r\nindio_dev->setup_ops = &iio_simple_dummy_buffer_setup_ops;\r\nindio_dev->pollfunc = iio_alloc_pollfunc(NULL,\r\n&iio_simple_dummy_trigger_h,\r\nIRQF_ONESHOT,\r\nindio_dev,\r\n"iio_simple_dummy_consumer%d",\r\nindio_dev->id);\r\nif (!indio_dev->pollfunc) {\r\nret = -ENOMEM;\r\ngoto error_free_buffer;\r\n}\r\nindio_dev->modes |= INDIO_BUFFER_TRIGGERED;\r\nreturn 0;\r\nerror_free_buffer:\r\niio_kfifo_free(indio_dev->buffer);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nvoid iio_simple_dummy_unconfigure_buffer(struct iio_dev *indio_dev)\r\n{\r\niio_dealloc_pollfunc(indio_dev->pollfunc);\r\niio_kfifo_free(indio_dev->buffer);\r\n}

static void nft_reject_inet_eval(const struct nft_expr *expr,\r\nstruct nft_regs *regs,\r\nconst struct nft_pktinfo *pkt)\r\n{\r\nstruct nft_reject *priv = nft_expr_priv(expr);\r\nstruct net *net = dev_net((pkt->in != NULL) ? pkt->in : pkt->out);\r\nswitch (pkt->ops->pf) {\r\ncase NFPROTO_IPV4:\r\nswitch (priv->type) {\r\ncase NFT_REJECT_ICMP_UNREACH:\r\nnf_send_unreach(pkt->skb, priv->icmp_code,\r\npkt->ops->hooknum);\r\nbreak;\r\ncase NFT_REJECT_TCP_RST:\r\nnf_send_reset(pkt->skb, pkt->ops->hooknum);\r\nbreak;\r\ncase NFT_REJECT_ICMPX_UNREACH:\r\nnf_send_unreach(pkt->skb,\r\nnft_reject_icmp_code(priv->icmp_code),\r\npkt->ops->hooknum);\r\nbreak;\r\n}\r\nbreak;\r\ncase NFPROTO_IPV6:\r\nswitch (priv->type) {\r\ncase NFT_REJECT_ICMP_UNREACH:\r\nnf_send_unreach6(net, pkt->skb, priv->icmp_code,\r\npkt->ops->hooknum);\r\nbreak;\r\ncase NFT_REJECT_TCP_RST:\r\nnf_send_reset6(net, pkt->skb, pkt->ops->hooknum);\r\nbreak;\r\ncase NFT_REJECT_ICMPX_UNREACH:\r\nnf_send_unreach6(net, pkt->skb,\r\nnft_reject_icmpv6_code(priv->icmp_code),\r\npkt->ops->hooknum);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nregs->verdict.code = NF_DROP;\r\n}\r\nstatic int nft_reject_inet_init(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nlattr * const tb[])\r\n{\r\nstruct nft_reject *priv = nft_expr_priv(expr);\r\nint icmp_code;\r\nif (tb[NFTA_REJECT_TYPE] == NULL)\r\nreturn -EINVAL;\r\npriv->type = ntohl(nla_get_be32(tb[NFTA_REJECT_TYPE]));\r\nswitch (priv->type) {\r\ncase NFT_REJECT_ICMP_UNREACH:\r\ncase NFT_REJECT_ICMPX_UNREACH:\r\nif (tb[NFTA_REJECT_ICMP_CODE] == NULL)\r\nreturn -EINVAL;\r\nicmp_code = nla_get_u8(tb[NFTA_REJECT_ICMP_CODE]);\r\nif (priv->type == NFT_REJECT_ICMPX_UNREACH &&\r\nicmp_code > NFT_REJECT_ICMPX_MAX)\r\nreturn -EINVAL;\r\npriv->icmp_code = icmp_code;\r\nbreak;\r\ncase NFT_REJECT_TCP_RST:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nft_reject_inet_dump(struct sk_buff *skb,\r\nconst struct nft_expr *expr)\r\n{\r\nconst struct nft_reject *priv = nft_expr_priv(expr);\r\nif (nla_put_be32(skb, NFTA_REJECT_TYPE, htonl(priv->type)))\r\ngoto nla_put_failure;\r\nswitch (priv->type) {\r\ncase NFT_REJECT_ICMP_UNREACH:\r\ncase NFT_REJECT_ICMPX_UNREACH:\r\nif (nla_put_u8(skb, NFTA_REJECT_ICMP_CODE, priv->icmp_code))\r\ngoto nla_put_failure;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -1;\r\n}\r\nstatic int __init nft_reject_inet_module_init(void)\r\n{\r\nreturn nft_register_expr(&nft_reject_inet_type);\r\n}\r\nstatic void __exit nft_reject_inet_module_exit(void)\r\n{\r\nnft_unregister_expr(&nft_reject_inet_type);\r\n}

static void adp5520_keys_report_event(struct adp5520_keys *dev,\r\nunsigned short keymask, int value)\r\n{\r\nint i;\r\nfor (i = 0; i < ADP5520_MAXKEYS; i++)\r\nif (keymask & (1 << i))\r\ninput_report_key(dev->input, dev->keycode[i], value);\r\ninput_sync(dev->input);\r\n}\r\nstatic int adp5520_keys_notifier(struct notifier_block *nb,\r\nunsigned long event, void *data)\r\n{\r\nstruct adp5520_keys *dev;\r\nuint8_t reg_val_lo, reg_val_hi;\r\nunsigned short keymask;\r\ndev = container_of(nb, struct adp5520_keys, notifier);\r\nif (event & ADP5520_KP_INT) {\r\nadp5520_read(dev->master, ADP5520_KP_INT_STAT_1, &reg_val_lo);\r\nadp5520_read(dev->master, ADP5520_KP_INT_STAT_2, &reg_val_hi);\r\nkeymask = (reg_val_hi << 8) | reg_val_lo;\r\nadp5520_read(dev->master, ADP5520_KP_INT_STAT_1, &reg_val_lo);\r\nadp5520_read(dev->master, ADP5520_KP_INT_STAT_2, &reg_val_hi);\r\nkeymask |= (reg_val_hi << 8) | reg_val_lo;\r\nadp5520_keys_report_event(dev, keymask, 1);\r\n}\r\nif (event & ADP5520_KR_INT) {\r\nadp5520_read(dev->master, ADP5520_KR_INT_STAT_1, &reg_val_lo);\r\nadp5520_read(dev->master, ADP5520_KR_INT_STAT_2, &reg_val_hi);\r\nkeymask = (reg_val_hi << 8) | reg_val_lo;\r\nadp5520_read(dev->master, ADP5520_KR_INT_STAT_1, &reg_val_lo);\r\nadp5520_read(dev->master, ADP5520_KR_INT_STAT_2, &reg_val_hi);\r\nkeymask |= (reg_val_hi << 8) | reg_val_lo;\r\nadp5520_keys_report_event(dev, keymask, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int adp5520_keys_probe(struct platform_device *pdev)\r\n{\r\nstruct adp5520_keys_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct input_dev *input;\r\nstruct adp5520_keys *dev;\r\nint ret, i;\r\nunsigned char en_mask, ctl_mask = 0;\r\nif (pdev->id != ID_ADP5520) {\r\ndev_err(&pdev->dev, "only ADP5520 supports Keypad\n");\r\nreturn -EINVAL;\r\n}\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "missing platform data\n");\r\nreturn -EINVAL;\r\n}\r\nif (!(pdata->rows_en_mask && pdata->cols_en_mask))\r\nreturn -EINVAL;\r\ndev = devm_kzalloc(&pdev->dev, sizeof(*dev), GFP_KERNEL);\r\nif (!dev) {\r\ndev_err(&pdev->dev, "failed to alloc memory\n");\r\nreturn -ENOMEM;\r\n}\r\ninput = devm_input_allocate_device(&pdev->dev);\r\nif (!input)\r\nreturn -ENOMEM;\r\ndev->master = pdev->dev.parent;\r\ndev->input = input;\r\ninput->name = pdev->name;\r\ninput->phys = "adp5520-keys/input0";\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_drvdata(input, dev);\r\ninput->id.bustype = BUS_I2C;\r\ninput->id.vendor = 0x0001;\r\ninput->id.product = 0x5520;\r\ninput->id.version = 0x0001;\r\ninput->keycodesize = sizeof(dev->keycode[0]);\r\ninput->keycodemax = pdata->keymapsize;\r\ninput->keycode = dev->keycode;\r\nmemcpy(dev->keycode, pdata->keymap,\r\npdata->keymapsize * input->keycodesize);\r\n__set_bit(EV_KEY, input->evbit);\r\nif (pdata->repeat)\r\n__set_bit(EV_REP, input->evbit);\r\nfor (i = 0; i < input->keycodemax; i++)\r\n__set_bit(dev->keycode[i], input->keybit);\r\n__clear_bit(KEY_RESERVED, input->keybit);\r\nret = input_register_device(input);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to register input device\n");\r\nreturn ret;\r\n}\r\nen_mask = pdata->rows_en_mask | pdata->cols_en_mask;\r\nret = adp5520_set_bits(dev->master, ADP5520_GPIO_CFG_1, en_mask);\r\nif (en_mask & ADP5520_COL_C3)\r\nctl_mask |= ADP5520_C3_MODE;\r\nif (en_mask & ADP5520_ROW_R3)\r\nctl_mask |= ADP5520_R3_MODE;\r\nif (ctl_mask)\r\nret |= adp5520_set_bits(dev->master, ADP5520_LED_CONTROL,\r\nctl_mask);\r\nret |= adp5520_set_bits(dev->master, ADP5520_GPIO_PULLUP,\r\npdata->rows_en_mask);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to write\n");\r\nreturn -EIO;\r\n}\r\ndev->notifier.notifier_call = adp5520_keys_notifier;\r\nret = adp5520_register_notifier(dev->master, &dev->notifier,\r\nADP5520_KP_IEN | ADP5520_KR_IEN);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register notifier\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, dev);\r\nreturn 0;\r\n}\r\nstatic int adp5520_keys_remove(struct platform_device *pdev)\r\n{\r\nstruct adp5520_keys *dev = platform_get_drvdata(pdev);\r\nadp5520_unregister_notifier(dev->master, &dev->notifier,\r\nADP5520_KP_IEN | ADP5520_KR_IEN);\r\nreturn 0;\r\n}

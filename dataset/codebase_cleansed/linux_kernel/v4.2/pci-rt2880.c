static u32 rt2880_pci_reg_read(u32 reg)\r\n{\r\nreturn readl(rt2880_pci_base + reg);\r\n}\r\nstatic void rt2880_pci_reg_write(u32 val, u32 reg)\r\n{\r\nwritel(val, rt2880_pci_base + reg);\r\n}\r\nstatic inline u32 rt2880_pci_get_cfgaddr(unsigned int bus, unsigned int slot,\r\nunsigned int func, unsigned int where)\r\n{\r\nreturn ((bus << 16) | (slot << 11) | (func << 8) | (where & 0xfc) |\r\n0x80000000);\r\n}\r\nstatic int rt2880_pci_config_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nunsigned long flags;\r\nu32 address;\r\nu32 data;\r\naddress = rt2880_pci_get_cfgaddr(bus->number, PCI_SLOT(devfn),\r\nPCI_FUNC(devfn), where);\r\nspin_lock_irqsave(&rt2880_pci_lock, flags);\r\nrt2880_pci_reg_write(address, RT2880_PCI_REG_CONFIG_ADDR);\r\ndata = rt2880_pci_reg_read(RT2880_PCI_REG_CONFIG_DATA);\r\nspin_unlock_irqrestore(&rt2880_pci_lock, flags);\r\nswitch (size) {\r\ncase 1:\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nbreak;\r\ncase 2:\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nbreak;\r\ncase 4:\r\n*val = data;\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int rt2880_pci_config_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nunsigned long flags;\r\nu32 address;\r\nu32 data;\r\naddress = rt2880_pci_get_cfgaddr(bus->number, PCI_SLOT(devfn),\r\nPCI_FUNC(devfn), where);\r\nspin_lock_irqsave(&rt2880_pci_lock, flags);\r\nrt2880_pci_reg_write(address, RT2880_PCI_REG_CONFIG_ADDR);\r\ndata = rt2880_pci_reg_read(RT2880_PCI_REG_CONFIG_DATA);\r\nswitch (size) {\r\ncase 1:\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nbreak;\r\ncase 2:\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nbreak;\r\ncase 4:\r\ndata = val;\r\nbreak;\r\n}\r\nrt2880_pci_reg_write(data, RT2880_PCI_REG_CONFIG_DATA);\r\nspin_unlock_irqrestore(&rt2880_pci_lock, flags);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic inline u32 rt2880_pci_read_u32(unsigned long reg)\r\n{\r\nunsigned long flags;\r\nu32 address;\r\nu32 ret;\r\naddress = rt2880_pci_get_cfgaddr(0, 0, 0, reg);\r\nspin_lock_irqsave(&rt2880_pci_lock, flags);\r\nrt2880_pci_reg_write(address, RT2880_PCI_REG_CONFIG_ADDR);\r\nret = rt2880_pci_reg_read(RT2880_PCI_REG_CONFIG_DATA);\r\nspin_unlock_irqrestore(&rt2880_pci_lock, flags);\r\nreturn ret;\r\n}\r\nstatic inline void rt2880_pci_write_u32(unsigned long reg, u32 val)\r\n{\r\nunsigned long flags;\r\nu32 address;\r\naddress = rt2880_pci_get_cfgaddr(0, 0, 0, reg);\r\nspin_lock_irqsave(&rt2880_pci_lock, flags);\r\nrt2880_pci_reg_write(address, RT2880_PCI_REG_CONFIG_ADDR);\r\nrt2880_pci_reg_write(val, RT2880_PCI_REG_CONFIG_DATA);\r\nspin_unlock_irqrestore(&rt2880_pci_lock, flags);\r\n}\r\nint __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nu16 cmd;\r\nint irq = -1;\r\nif (dev->bus->number != 0)\r\nreturn irq;\r\nswitch (PCI_SLOT(dev->devfn)) {\r\ncase 0x00:\r\nrt2880_pci_write_u32(PCI_BASE_ADDRESS_0, 0x08000000);\r\n(void) rt2880_pci_read_u32(PCI_BASE_ADDRESS_0);\r\nbreak;\r\ncase 0x11:\r\nirq = RT288X_CPU_IRQ_PCI;\r\nbreak;\r\ndefault:\r\npr_err("%s:%s[%d] trying to alloc unknown pci irq\n",\r\n__FILE__, __func__, __LINE__);\r\nBUG();\r\nbreak;\r\n}\r\npci_write_config_byte((struct pci_dev *) dev,\r\nPCI_CACHE_LINE_SIZE, 0x14);\r\npci_write_config_byte((struct pci_dev *) dev, PCI_LATENCY_TIMER, 0xFF);\r\npci_read_config_word((struct pci_dev *) dev, PCI_COMMAND, &cmd);\r\ncmd |= PCI_COMMAND_MASTER | PCI_COMMAND_IO | PCI_COMMAND_MEMORY |\r\nPCI_COMMAND_INVALIDATE | PCI_COMMAND_FAST_BACK |\r\nPCI_COMMAND_SERR | PCI_COMMAND_WAIT | PCI_COMMAND_PARITY;\r\npci_write_config_word((struct pci_dev *) dev, PCI_COMMAND, cmd);\r\npci_write_config_byte((struct pci_dev *) dev, PCI_INTERRUPT_LINE,\r\ndev->irq);\r\nreturn irq;\r\n}\r\nstatic int rt288x_pci_probe(struct platform_device *pdev)\r\n{\r\nvoid __iomem *io_map_base;\r\nint i;\r\nrt2880_pci_base = ioremap_nocache(RT2880_PCI_BASE, PAGE_SIZE);\r\nio_map_base = ioremap(RT2880_PCI_IO_BASE, RT2880_PCI_IO_SIZE);\r\nrt2880_pci_controller.io_map_base = (unsigned long) io_map_base;\r\nset_io_port_base((unsigned long) io_map_base);\r\nioport_resource.start = RT2880_PCI_IO_BASE;\r\nioport_resource.end = RT2880_PCI_IO_BASE + RT2880_PCI_IO_SIZE - 1;\r\nrt2880_pci_reg_write(0, RT2880_PCI_REG_PCICFG_ADDR);\r\nfor (i = 0; i < 0xfffff; i++)\r\n;\r\nrt2880_pci_reg_write(0x79, RT2880_PCI_REG_ARBCTL);\r\nrt2880_pci_reg_write(0x07FF0001, RT2880_PCI_REG_BAR0SETUP_ADDR);\r\nrt2880_pci_reg_write(RT2880_PCI_MEM_BASE, RT2880_PCI_REG_MEMBASE);\r\nrt2880_pci_reg_write(RT2880_PCI_IO_BASE, RT2880_PCI_REG_IOBASE);\r\nrt2880_pci_reg_write(0x08000000, RT2880_PCI_REG_IMBASEBAR0_ADDR);\r\nrt2880_pci_reg_write(0x08021814, RT2880_PCI_REG_ID);\r\nrt2880_pci_reg_write(0x00800001, RT2880_PCI_REG_CLASS);\r\nrt2880_pci_reg_write(0x28801814, RT2880_PCI_REG_SUBID);\r\nrt2880_pci_reg_write(0x000c0000, RT2880_PCI_REG_PCIMSK_ADDR);\r\nrt2880_pci_write_u32(PCI_BASE_ADDRESS_0, 0x08000000);\r\n(void) rt2880_pci_read_u32(PCI_BASE_ADDRESS_0);\r\nregister_pci_controller(&rt2880_pci_controller);\r\nreturn 0;\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nint __init pcibios_init(void)\r\n{\r\nint ret = platform_driver_register(&rt288x_pci_driver);\r\nif (ret)\r\npr_info("rt288x-pci: Error registering platform driver!");\r\nreturn ret;\r\n}

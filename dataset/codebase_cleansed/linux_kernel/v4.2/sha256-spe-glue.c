static void spe_begin(void)\r\n{\r\npreempt_disable();\r\nenable_kernel_spe();\r\n}\r\nstatic void spe_end(void)\r\n{\r\npreempt_enable();\r\n}\r\nstatic inline void ppc_sha256_clear_context(struct sha256_state *sctx)\r\n{\r\nint count = sizeof(struct sha256_state) >> 2;\r\nu32 *ptr = (u32 *)sctx;\r\nBUILD_BUG_ON(sizeof(struct sha256_state) % 4);\r\ndo { *ptr++ = 0; } while (--count);\r\n}\r\nstatic int ppc_spe_sha256_init(struct shash_desc *desc)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nsctx->state[0] = SHA256_H0;\r\nsctx->state[1] = SHA256_H1;\r\nsctx->state[2] = SHA256_H2;\r\nsctx->state[3] = SHA256_H3;\r\nsctx->state[4] = SHA256_H4;\r\nsctx->state[5] = SHA256_H5;\r\nsctx->state[6] = SHA256_H6;\r\nsctx->state[7] = SHA256_H7;\r\nsctx->count = 0;\r\nreturn 0;\r\n}\r\nstatic int ppc_spe_sha224_init(struct shash_desc *desc)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nsctx->state[0] = SHA224_H0;\r\nsctx->state[1] = SHA224_H1;\r\nsctx->state[2] = SHA224_H2;\r\nsctx->state[3] = SHA224_H3;\r\nsctx->state[4] = SHA224_H4;\r\nsctx->state[5] = SHA224_H5;\r\nsctx->state[6] = SHA224_H6;\r\nsctx->state[7] = SHA224_H7;\r\nsctx->count = 0;\r\nreturn 0;\r\n}\r\nstatic int ppc_spe_sha256_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nconst unsigned int offset = sctx->count & 0x3f;\r\nconst unsigned int avail = 64 - offset;\r\nunsigned int bytes;\r\nconst u8 *src = data;\r\nif (avail > len) {\r\nsctx->count += len;\r\nmemcpy((char *)sctx->buf + offset, src, len);\r\nreturn 0;\r\n}\r\nsctx->count += len;\r\nif (offset) {\r\nmemcpy((char *)sctx->buf + offset, src, avail);\r\nspe_begin();\r\nppc_spe_sha256_transform(sctx->state, (const u8 *)sctx->buf, 1);\r\nspe_end();\r\nlen -= avail;\r\nsrc += avail;\r\n}\r\nwhile (len > 63) {\r\nbytes = (len > MAX_BYTES) ? MAX_BYTES : len;\r\nbytes = bytes & ~0x3f;\r\nspe_begin();\r\nppc_spe_sha256_transform(sctx->state, src, bytes >> 6);\r\nspe_end();\r\nsrc += bytes;\r\nlen -= bytes;\r\n};\r\nmemcpy((char *)sctx->buf, src, len);\r\nreturn 0;\r\n}\r\nstatic int ppc_spe_sha256_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nconst unsigned int offset = sctx->count & 0x3f;\r\nchar *p = (char *)sctx->buf + offset;\r\nint padlen;\r\n__be64 *pbits = (__be64 *)(((char *)&sctx->buf) + 56);\r\n__be32 *dst = (__be32 *)out;\r\npadlen = 55 - offset;\r\n*p++ = 0x80;\r\nspe_begin();\r\nif (padlen < 0) {\r\nmemset(p, 0x00, padlen + sizeof (u64));\r\nppc_spe_sha256_transform(sctx->state, sctx->buf, 1);\r\np = (char *)sctx->buf;\r\npadlen = 56;\r\n}\r\nmemset(p, 0, padlen);\r\n*pbits = cpu_to_be64(sctx->count << 3);\r\nppc_spe_sha256_transform(sctx->state, sctx->buf, 1);\r\nspe_end();\r\ndst[0] = cpu_to_be32(sctx->state[0]);\r\ndst[1] = cpu_to_be32(sctx->state[1]);\r\ndst[2] = cpu_to_be32(sctx->state[2]);\r\ndst[3] = cpu_to_be32(sctx->state[3]);\r\ndst[4] = cpu_to_be32(sctx->state[4]);\r\ndst[5] = cpu_to_be32(sctx->state[5]);\r\ndst[6] = cpu_to_be32(sctx->state[6]);\r\ndst[7] = cpu_to_be32(sctx->state[7]);\r\nppc_sha256_clear_context(sctx);\r\nreturn 0;\r\n}\r\nstatic int ppc_spe_sha224_final(struct shash_desc *desc, u8 *out)\r\n{\r\nu32 D[SHA256_DIGEST_SIZE >> 2];\r\n__be32 *dst = (__be32 *)out;\r\nppc_spe_sha256_final(desc, (u8 *)D);\r\ndst[0] = D[0];\r\ndst[1] = D[1];\r\ndst[2] = D[2];\r\ndst[3] = D[3];\r\ndst[4] = D[4];\r\ndst[5] = D[5];\r\ndst[6] = D[6];\r\nmemzero_explicit(D, SHA256_DIGEST_SIZE);\r\nreturn 0;\r\n}\r\nstatic int ppc_spe_sha256_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(out, sctx, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int ppc_spe_sha256_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(sctx, in, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int __init ppc_spe_sha256_mod_init(void)\r\n{\r\nreturn crypto_register_shashes(algs, ARRAY_SIZE(algs));\r\n}\r\nstatic void __exit ppc_spe_sha256_mod_fini(void)\r\n{\r\ncrypto_unregister_shashes(algs, ARRAY_SIZE(algs));\r\n}

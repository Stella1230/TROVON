static dword pri_ram_offset(ADAPTER *a) {\r\nreturn ((dword)MP_SHARED_RAM_OFFSET);\r\n}\r\nstatic void pri_cpu_trapped(PISDN_ADAPTER IoAdapter) {\r\nbyte __iomem *base;\r\nword *Xlog;\r\ndword regs[4], TrapID, size;\r\nXdesc xlogDesc;\r\nbase = DIVA_OS_MEM_ATTACH_ADDRESS(IoAdapter);\r\nTrapID = READ_DWORD(&base[0x80]);\r\nif ((TrapID == 0x99999999) || (TrapID == 0x99999901))\r\n{\r\ndump_trap_frame(IoAdapter, &base[0x90]);\r\nIoAdapter->trapped = 1;\r\n}\r\nregs[0] = READ_DWORD(&base[MP_PROTOCOL_OFFSET + 0x70]);\r\nregs[1] = READ_DWORD(&base[MP_PROTOCOL_OFFSET + 0x74]);\r\nregs[2] = READ_DWORD(&base[MP_PROTOCOL_OFFSET + 0x78]);\r\nregs[3] = READ_DWORD(&base[MP_PROTOCOL_OFFSET + 0x7c]);\r\nregs[0] &= IoAdapter->MemorySize - 1;\r\nif ((regs[0] < IoAdapter->MemorySize - 1))\r\n{\r\nif (!(Xlog = (word *)diva_os_malloc(0, MAX_XLOG_SIZE))) {\r\nDIVA_OS_MEM_DETACH_ADDRESS(IoAdapter, base);\r\nreturn;\r\n}\r\nsize = IoAdapter->MemorySize - regs[0];\r\nif (size > MAX_XLOG_SIZE)\r\nsize = MAX_XLOG_SIZE;\r\nmemcpy_fromio(Xlog, &base[regs[0]], size);\r\nxlogDesc.buf = Xlog;\r\nxlogDesc.cnt = READ_WORD(&base[regs[1] & (IoAdapter->MemorySize - 1)]);\r\nxlogDesc.out = READ_WORD(&base[regs[2] & (IoAdapter->MemorySize - 1)]);\r\ndump_xlog_buffer(IoAdapter, &xlogDesc);\r\ndiva_os_free(0, Xlog);\r\nIoAdapter->trapped = 2;\r\n}\r\nDIVA_OS_MEM_DETACH_ADDRESS(IoAdapter, base);\r\n}\r\nstatic void reset_pri_hardware(PISDN_ADAPTER IoAdapter) {\r\nbyte __iomem *p = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nWRITE_BYTE(p, _MP_RISC_RESET | _MP_LED1 | _MP_LED2);\r\ndiva_os_wait(50);\r\nWRITE_BYTE(p, 0x00);\r\ndiva_os_wait(50);\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\n}\r\nstatic void stop_pri_hardware(PISDN_ADAPTER IoAdapter) {\r\ndword i;\r\nbyte __iomem *p;\r\ndword volatile __iomem *cfgReg = (void __iomem *)DIVA_OS_MEM_ATTACH_CFG(IoAdapter);\r\nWRITE_DWORD(&cfgReg[3], 0);\r\nWRITE_DWORD(&cfgReg[1], 0);\r\nDIVA_OS_MEM_DETACH_CFG(IoAdapter, cfgReg);\r\nIoAdapter->a.ram_out(&IoAdapter->a, &RAM->SWReg, SWREG_HALT_CPU);\r\ni = 0;\r\nwhile ((i < 100) && (IoAdapter->a.ram_in(&IoAdapter->a, &RAM->SWReg) != 0))\r\n{\r\ndiva_os_wait(1);\r\ni++;\r\n}\r\nDBG_TRC(("%s: PRI stopped (%d)", IoAdapter->Name, i))\r\ncfgReg = (void __iomem *)DIVA_OS_MEM_ATTACH_CFG(IoAdapter);\r\nWRITE_DWORD(&cfgReg[0], ((dword)(~0x03E00000)));\r\nDIVA_OS_MEM_DETACH_CFG(IoAdapter, cfgReg);\r\ndiva_os_wait(1);\r\np = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nWRITE_BYTE(p, _MP_RISC_RESET | _MP_LED1 | _MP_LED2);\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\n}\r\nstatic int load_pri_hardware(PISDN_ADAPTER IoAdapter) {\r\nreturn (0);\r\n}\r\nstatic int pri_ISR(struct _ISDN_ADAPTER *IoAdapter) {\r\nbyte __iomem *cfg = DIVA_OS_MEM_ATTACH_CFG(IoAdapter);\r\nif (!(READ_DWORD(cfg) & 0x80000000)) {\r\nDIVA_OS_MEM_DETACH_CFG(IoAdapter, cfg);\r\nreturn (0);\r\n}\r\nWRITE_DWORD(cfg, (dword)~0x03E00000);\r\nDIVA_OS_MEM_DETACH_CFG(IoAdapter, cfg);\r\nIoAdapter->IrqCount++;\r\nif (IoAdapter->Initialized)\r\n{\r\ndiva_os_schedule_soft_isr(&IoAdapter->isr_soft_isr);\r\n}\r\nreturn (1);\r\n}\r\nstatic void disable_pri_interrupt(PISDN_ADAPTER IoAdapter) {\r\ndword volatile __iomem *cfgReg = (dword volatile __iomem *)DIVA_OS_MEM_ATTACH_CFG(IoAdapter);\r\nWRITE_DWORD(&cfgReg[3], 0);\r\nWRITE_DWORD(&cfgReg[1], 0);\r\nWRITE_DWORD(&cfgReg[0], (dword)(~0x03E00000));\r\nDIVA_OS_MEM_DETACH_CFG(IoAdapter, cfgReg);\r\n}\r\nstatic void prepare_common_pri_functions(PISDN_ADAPTER IoAdapter) {\r\nADAPTER *a = &IoAdapter->a;\r\na->ram_in = mem_in;\r\na->ram_inw = mem_inw;\r\na->ram_in_buffer = mem_in_buffer;\r\na->ram_look_ahead = mem_look_ahead;\r\na->ram_out = mem_out;\r\na->ram_outw = mem_outw;\r\na->ram_out_buffer = mem_out_buffer;\r\na->ram_inc = mem_inc;\r\na->ram_offset = pri_ram_offset;\r\na->ram_out_dw = mem_out_dw;\r\na->ram_in_dw = mem_in_dw;\r\na->istream_wakeup = pr_stream;\r\nIoAdapter->out = pr_out;\r\nIoAdapter->dpc = pr_dpc;\r\nIoAdapter->tst_irq = scom_test_int;\r\nIoAdapter->clr_irq = scom_clear_int;\r\nIoAdapter->pcm = (struct pc_maint *)(MIPS_MAINT_OFFS\r\n- MP_SHARED_RAM_OFFSET);\r\nIoAdapter->load = load_pri_hardware;\r\nIoAdapter->disIrq = disable_pri_interrupt;\r\nIoAdapter->rstFnc = reset_pri_hardware;\r\nIoAdapter->stop = stop_pri_hardware;\r\nIoAdapter->trapFnc = pri_cpu_trapped;\r\nIoAdapter->diva_isr_handler = pri_ISR;\r\n}\r\nvoid prepare_pri_functions(PISDN_ADAPTER IoAdapter) {\r\nIoAdapter->MemorySize = MP_MEMORY_SIZE;\r\nprepare_common_pri_functions(IoAdapter);\r\ndiva_os_prepare_pri_functions(IoAdapter);\r\n}\r\nvoid prepare_pri2_functions(PISDN_ADAPTER IoAdapter) {\r\nIoAdapter->MemorySize = MP2_MEMORY_SIZE;\r\nprepare_common_pri_functions(IoAdapter);\r\ndiva_os_prepare_pri2_functions(IoAdapter);\r\n}

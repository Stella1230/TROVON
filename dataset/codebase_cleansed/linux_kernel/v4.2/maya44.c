static void wm8776_write(struct snd_ice1712 *ice, struct snd_wm8776 *wm,\r\nunsigned char reg, unsigned short val)\r\n{\r\nsnd_vt1724_write_i2c(ice, wm->addr,\r\n(reg << 1) | ((val >> 8) & 1),\r\nval & 0xff);\r\nwm->regs[reg] = val;\r\n}\r\nstatic int wm8776_write_bits(struct snd_ice1712 *ice, struct snd_wm8776 *wm,\r\nunsigned char reg,\r\nunsigned short mask, unsigned short val)\r\n{\r\nval |= wm->regs[reg] & ~mask;\r\nif (val != wm->regs[reg]) {\r\nwm8776_write(ice, wm, reg, val);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int maya_vol_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nunsigned int idx = kcontrol->private_value;\r\nstruct maya_vol_info *vol = &vol_info[idx];\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = vol->maxval;\r\nreturn 0;\r\n}\r\nstatic int maya_vol_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nstruct snd_wm8776 *wm =\r\n&chip->wm[snd_ctl_get_ioff(kcontrol, &ucontrol->id)];\r\nunsigned int idx = kcontrol->private_value;\r\nmutex_lock(&chip->mutex);\r\nucontrol->value.integer.value[0] = wm->volumes[idx][0];\r\nucontrol->value.integer.value[1] = wm->volumes[idx][1];\r\nmutex_unlock(&chip->mutex);\r\nreturn 0;\r\n}\r\nstatic int maya_vol_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nstruct snd_wm8776 *wm =\r\n&chip->wm[snd_ctl_get_ioff(kcontrol, &ucontrol->id)];\r\nunsigned int idx = kcontrol->private_value;\r\nstruct maya_vol_info *vol = &vol_info[idx];\r\nunsigned int val, data;\r\nint ch, changed = 0;\r\nmutex_lock(&chip->mutex);\r\nfor (ch = 0; ch < 2; ch++) {\r\nval = ucontrol->value.integer.value[ch];\r\nif (val > vol->maxval)\r\nval = vol->maxval;\r\nif (val == wm->volumes[idx][ch])\r\ncontinue;\r\nif (!val)\r\ndata = vol->mute;\r\nelse\r\ndata = (val - 1) + vol->offset;\r\ndata |= vol->update;\r\nchanged |= wm8776_write_bits(chip->ice, wm, vol->regs[ch],\r\nvol->mask | vol->update, data);\r\nif (vol->mux_bits[ch])\r\nwm8776_write_bits(chip->ice, wm, WM8776_REG_ADC_MUX,\r\nvol->mux_bits[ch],\r\nval ? 0 : vol->mux_bits[ch]);\r\nwm->volumes[idx][ch] = val;\r\n}\r\nmutex_unlock(&chip->mutex);\r\nreturn changed;\r\n}\r\nstatic int maya_sw_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nstruct snd_wm8776 *wm =\r\n&chip->wm[snd_ctl_get_ioff(kcontrol, &ucontrol->id)];\r\nunsigned int idx = GET_SW_VAL_IDX(kcontrol->private_value);\r\nucontrol->value.integer.value[0] = (wm->switch_bits >> idx) & 1;\r\nreturn 0;\r\n}\r\nstatic int maya_sw_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nstruct snd_wm8776 *wm =\r\n&chip->wm[snd_ctl_get_ioff(kcontrol, &ucontrol->id)];\r\nunsigned int idx = GET_SW_VAL_IDX(kcontrol->private_value);\r\nunsigned int mask, val;\r\nint changed;\r\nmutex_lock(&chip->mutex);\r\nmask = 1 << idx;\r\nwm->switch_bits &= ~mask;\r\nval = ucontrol->value.integer.value[0];\r\nif (val)\r\nwm->switch_bits |= mask;\r\nmask = GET_SW_VAL_MASK(kcontrol->private_value);\r\nchanged = wm8776_write_bits(chip->ice, wm,\r\nGET_SW_VAL_REG(kcontrol->private_value),\r\nmask, val ? mask : 0);\r\nmutex_unlock(&chip->mutex);\r\nreturn changed;\r\n}\r\nstatic int maya_set_gpio_bits(struct snd_ice1712 *ice, unsigned int mask,\r\nunsigned int bits)\r\n{\r\nunsigned int data;\r\ndata = snd_ice1712_gpio_read(ice);\r\nif ((data & mask) == bits)\r\nreturn 0;\r\nsnd_ice1712_gpio_write(ice, (data & ~mask) | bits);\r\nreturn 1;\r\n}\r\nstatic int maya_gpio_sw_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nunsigned int shift = GET_GPIO_VAL_SHIFT(kcontrol->private_value);\r\nunsigned int val;\r\nval = (snd_ice1712_gpio_read(chip->ice) >> shift) & 1;\r\nif (GET_GPIO_VAL_INV(kcontrol->private_value))\r\nval = !val;\r\nucontrol->value.integer.value[0] = val;\r\nreturn 0;\r\n}\r\nstatic int maya_gpio_sw_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nunsigned int shift = GET_GPIO_VAL_SHIFT(kcontrol->private_value);\r\nunsigned int val, mask;\r\nint changed;\r\nmutex_lock(&chip->mutex);\r\nmask = 1 << shift;\r\nval = ucontrol->value.integer.value[0];\r\nif (GET_GPIO_VAL_INV(kcontrol->private_value))\r\nval = !val;\r\nval = val ? mask : 0;\r\nchanged = maya_set_gpio_bits(chip->ice, mask, val);\r\nmutex_unlock(&chip->mutex);\r\nreturn changed;\r\n}\r\nstatic void wm8776_select_input(struct snd_maya44 *chip, int idx, int line)\r\n{\r\nwm8776_write_bits(chip->ice, &chip->wm[idx], WM8776_REG_ADC_MUX,\r\n0x1f, 1 << line);\r\n}\r\nstatic int maya_rec_src_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[] = { "Line", "Mic" };\r\nreturn snd_ctl_enum_info(uinfo, 1, ARRAY_SIZE(texts), texts);\r\n}\r\nstatic int maya_rec_src_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nint sel;\r\nif (snd_ice1712_gpio_read(chip->ice) & (1 << GPIO_MIC_RELAY))\r\nsel = 1;\r\nelse\r\nsel = 0;\r\nucontrol->value.enumerated.item[0] = sel;\r\nreturn 0;\r\n}\r\nstatic int maya_rec_src_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nint sel = ucontrol->value.enumerated.item[0];\r\nint changed;\r\nmutex_lock(&chip->mutex);\r\nchanged = maya_set_gpio_bits(chip->ice, 1 << GPIO_MIC_RELAY,\r\nsel ? (1 << GPIO_MIC_RELAY) : 0);\r\nwm8776_select_input(chip, 0, sel ? MAYA_MIC_IN : MAYA_LINE_IN);\r\nmutex_unlock(&chip->mutex);\r\nreturn changed;\r\n}\r\nstatic int maya_pb_route_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[] = {\r\n"PCM Out",\r\n"Input 1", "Input 2", "Input 3", "Input 4"\r\n};\r\nreturn snd_ctl_enum_info(uinfo, 1, ARRAY_SIZE(texts), texts);\r\n}\r\nstatic int maya_pb_route_shift(int idx)\r\n{\r\nstatic const unsigned char shift[10] =\r\n{ 8, 20, 0, 3, 11, 23, 14, 26, 17, 29 };\r\nreturn shift[idx % 10];\r\n}\r\nstatic int maya_pb_route_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nint idx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nucontrol->value.enumerated.item[0] =\r\nsnd_ice1724_get_route_val(chip->ice, maya_pb_route_shift(idx));\r\nreturn 0;\r\n}\r\nstatic int maya_pb_route_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_maya44 *chip = snd_kcontrol_chip(kcontrol);\r\nint idx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nreturn snd_ice1724_put_route_val(chip->ice,\r\nucontrol->value.enumerated.item[0],\r\nmaya_pb_route_shift(idx));\r\n}\r\nstatic int maya44_add_controls(struct snd_ice1712 *ice)\r\n{\r\nint err, i;\r\nfor (i = 0; i < ARRAY_SIZE(maya_controls); i++) {\r\nerr = snd_ctl_add(ice->card, snd_ctl_new1(&maya_controls[i],\r\nice->spec));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void wm8776_init(struct snd_ice1712 *ice,\r\nstruct snd_wm8776 *wm, unsigned int addr)\r\n{\r\nstatic const unsigned short inits_wm8776[] = {\r\n0x02, 0x100,\r\n0x05, 0x100,\r\n0x06, 0x000,\r\n0x07, 0x091,\r\n0x08, 0x000,\r\n0x09, 0x000,\r\n0x0a, 0x022,\r\n0x0b, 0x022,\r\n0x0c, 0x042,\r\n0x0d, 0x000,\r\n0x0e, 0x100,\r\n0x0f, 0x100,\r\n0x11, 0x000,\r\n0x15, 0x000,\r\n0x16, 0x001,\r\n0xff, 0xff\r\n};\r\nconst unsigned short *ptr;\r\nunsigned char reg;\r\nunsigned short data;\r\nwm->addr = addr;\r\nwm->switch_bits = (1 << WM_SW_DAC);\r\nptr = inits_wm8776;\r\nwhile (*ptr != 0xff) {\r\nreg = *ptr++;\r\ndata = *ptr++;\r\nwm8776_write(ice, wm, reg, data);\r\n}\r\n}\r\nstatic void set_rate(struct snd_ice1712 *ice, unsigned int rate)\r\n{\r\nstruct snd_maya44 *chip = ice->spec;\r\nunsigned int ratio, adc_ratio, val;\r\nint i;\r\nswitch (rate) {\r\ncase 192000:\r\nratio = WM8776_CLOCK_RATIO_128FS;\r\nbreak;\r\ncase 176400:\r\nratio = WM8776_CLOCK_RATIO_128FS;\r\nbreak;\r\ncase 96000:\r\nratio = WM8776_CLOCK_RATIO_256FS;\r\nbreak;\r\ncase 88200:\r\nratio = WM8776_CLOCK_RATIO_384FS;\r\nbreak;\r\ncase 48000:\r\nratio = WM8776_CLOCK_RATIO_512FS;\r\nbreak;\r\ncase 44100:\r\nratio = WM8776_CLOCK_RATIO_512FS;\r\nbreak;\r\ncase 32000:\r\nratio = WM8776_CLOCK_RATIO_768FS;\r\nbreak;\r\ncase 0:\r\nreturn;\r\ndefault:\r\nsnd_BUG();\r\nreturn;\r\n}\r\nadc_ratio = ratio;\r\nif (adc_ratio < WM8776_CLOCK_RATIO_256FS)\r\nadc_ratio = WM8776_CLOCK_RATIO_256FS;\r\nval = adc_ratio;\r\nif (adc_ratio == WM8776_CLOCK_RATIO_256FS)\r\nval |= 8;\r\nval |= ratio << 4;\r\nmutex_lock(&chip->mutex);\r\nfor (i = 0; i < 2; i++)\r\nwm8776_write_bits(ice, &chip->wm[i],\r\nWM8776_REG_MASTER_MODE_CONTROL,\r\n0x180, val);\r\nmutex_unlock(&chip->mutex);\r\n}\r\nstatic int maya44_init(struct snd_ice1712 *ice)\r\n{\r\nint i;\r\nstruct snd_maya44 *chip;\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nmutex_init(&chip->mutex);\r\nchip->ice = ice;\r\nice->spec = chip;\r\nice->num_total_dacs = 4;\r\nice->num_total_adcs = 4;\r\nice->akm_codecs = 0;\r\nfor (i = 0; i < 2; i++) {\r\nwm8776_init(ice, &chip->wm[i], wm8776_addr[i]);\r\nwm8776_select_input(chip, i, MAYA_LINE_IN);\r\n}\r\nice->hw_rates = &dac_rates;\r\nice->gpio.set_pro_rate = set_rate;\r\nice->force_rdma1 = 1;\r\nice->own_routing = 1;\r\nreturn 0;\r\n}

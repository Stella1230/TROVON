static void vnt_cmd_timer_wait(struct vnt_private *priv, unsigned long msecs)\r\n{\r\nschedule_delayed_work(&priv->run_command_work, msecs_to_jiffies(msecs));\r\n}\r\nstatic int vnt_cmd_complete(struct vnt_private *priv)\r\n{\r\npriv->command_state = WLAN_CMD_IDLE;\r\nif (priv->free_cmd_queue == CMD_Q_SIZE) {\r\npriv->cmd_running = false;\r\nreturn true;\r\n}\r\npriv->command = priv->cmd_queue[priv->cmd_dequeue_idx];\r\nADD_ONE_WITH_WRAP_AROUND(priv->cmd_dequeue_idx, CMD_Q_SIZE);\r\npriv->free_cmd_queue++;\r\npriv->cmd_running = true;\r\nswitch (priv->command) {\r\ncase WLAN_CMD_INIT_MAC80211:\r\npriv->command_state = WLAN_CMD_INIT_MAC80211_START;\r\nbreak;\r\ncase WLAN_CMD_TBTT_WAKEUP:\r\npriv->command_state = WLAN_CMD_TBTT_WAKEUP_START;\r\nbreak;\r\ncase WLAN_CMD_BECON_SEND:\r\npriv->command_state = WLAN_CMD_BECON_SEND_START;\r\nbreak;\r\ncase WLAN_CMD_SETPOWER:\r\npriv->command_state = WLAN_CMD_SETPOWER_START;\r\nbreak;\r\ncase WLAN_CMD_CHANGE_ANTENNA:\r\npriv->command_state = WLAN_CMD_CHANGE_ANTENNA_START;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nvnt_cmd_timer_wait(priv, 0);\r\nreturn true;\r\n}\r\nvoid vnt_run_command(struct work_struct *work)\r\n{\r\nstruct vnt_private *priv =\r\ncontainer_of(work, struct vnt_private, run_command_work.work);\r\nif (test_bit(DEVICE_FLAGS_DISCONNECTED, &priv->flags))\r\nreturn;\r\nif (priv->cmd_running != true)\r\nreturn;\r\nswitch (priv->command_state) {\r\ncase WLAN_CMD_INIT_MAC80211_START:\r\nif (priv->mac_hw)\r\nbreak;\r\ndev_info(&priv->usb->dev, "Starting mac80211\n");\r\nif (vnt_init(priv)) {\r\ndev_err(&priv->usb->dev, "failed to start\n");\r\nieee80211_free_hw(priv->hw);\r\nreturn;\r\n}\r\nbreak;\r\ncase WLAN_CMD_TBTT_WAKEUP_START:\r\nvnt_next_tbtt_wakeup(priv);\r\nbreak;\r\ncase WLAN_CMD_BECON_SEND_START:\r\nif (!priv->vif)\r\nbreak;\r\nvnt_beacon_make(priv, priv->vif);\r\nvnt_mac_reg_bits_on(priv, MAC_REG_TCR, TCR_AUTOBCNTX);\r\nbreak;\r\ncase WLAN_CMD_SETPOWER_START:\r\nvnt_rf_setpower(priv, priv->current_rate,\r\npriv->hw->conf.chandef.chan->hw_value);\r\nbreak;\r\ncase WLAN_CMD_CHANGE_ANTENNA_START:\r\ndev_dbg(&priv->usb->dev, "Change from Antenna%d to",\r\npriv->rx_antenna_sel);\r\nif (priv->rx_antenna_sel == 0) {\r\npriv->rx_antenna_sel = 1;\r\nif (priv->tx_rx_ant_inv == true)\r\nvnt_set_antenna_mode(priv, ANT_RXA);\r\nelse\r\nvnt_set_antenna_mode(priv, ANT_RXB);\r\n} else {\r\npriv->rx_antenna_sel = 0;\r\nif (priv->tx_rx_ant_inv == true)\r\nvnt_set_antenna_mode(priv, ANT_RXB);\r\nelse\r\nvnt_set_antenna_mode(priv, ANT_RXA);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nvnt_cmd_complete(priv);\r\n}\r\nint vnt_schedule_command(struct vnt_private *priv, enum vnt_cmd command)\r\n{\r\nif (priv->free_cmd_queue == 0)\r\nreturn false;\r\npriv->cmd_queue[priv->cmd_enqueue_idx] = command;\r\nADD_ONE_WITH_WRAP_AROUND(priv->cmd_enqueue_idx, CMD_Q_SIZE);\r\npriv->free_cmd_queue--;\r\nif (priv->cmd_running == false)\r\nvnt_cmd_complete(priv);\r\nreturn true;\r\n}\r\nvoid vnt_reset_command_timer(struct vnt_private *priv)\r\n{\r\npriv->free_cmd_queue = CMD_Q_SIZE;\r\npriv->cmd_dequeue_idx = 0;\r\npriv->cmd_enqueue_idx = 0;\r\npriv->command_state = WLAN_CMD_IDLE;\r\npriv->cmd_running = false;\r\n}

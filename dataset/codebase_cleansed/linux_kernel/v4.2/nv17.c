static int\r\nnv17_fifo_chan_ctor(struct nvkm_object *parent,\r\nstruct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nunion {\r\nstruct nv03_channel_dma_v0 v0;\r\n} *args = data;\r\nstruct nv04_fifo_priv *priv = (void *)engine;\r\nstruct nv04_fifo_chan *chan;\r\nint ret;\r\nnv_ioctl(parent, "create channel dma size %d\n", size);\r\nif (nvif_unpack(args->v0, 0, 0, false)) {\r\nnv_ioctl(parent, "create channel dma vers %d pushbuf %08x "\r\n"offset %016llx\n", args->v0.version,\r\nargs->v0.pushbuf, args->v0.offset);\r\n} else\r\nreturn ret;\r\nret = nvkm_fifo_channel_create(parent, engine, oclass, 0, 0x800000,\r\n0x10000, args->v0.pushbuf,\r\n(1ULL << NVDEV_ENGINE_DMAOBJ) |\r\n(1ULL << NVDEV_ENGINE_SW) |\r\n(1ULL << NVDEV_ENGINE_GR) |\r\n(1ULL << NVDEV_ENGINE_MPEG),\r\n&chan);\r\n*pobject = nv_object(chan);\r\nif (ret)\r\nreturn ret;\r\nargs->v0.chid = chan->base.chid;\r\nnv_parent(chan)->object_attach = nv04_fifo_object_attach;\r\nnv_parent(chan)->object_detach = nv04_fifo_object_detach;\r\nnv_parent(chan)->context_attach = nv04_fifo_context_attach;\r\nchan->ramfc = chan->base.chid * 64;\r\nnv_wo32(priv->ramfc, chan->ramfc + 0x00, args->v0.offset);\r\nnv_wo32(priv->ramfc, chan->ramfc + 0x04, args->v0.offset);\r\nnv_wo32(priv->ramfc, chan->ramfc + 0x0c, chan->base.pushgpu->addr >> 4);\r\nnv_wo32(priv->ramfc, chan->ramfc + 0x14,\r\nNV_PFIFO_CACHE1_DMA_FETCH_TRIG_128_BYTES |\r\nNV_PFIFO_CACHE1_DMA_FETCH_SIZE_128_BYTES |\r\n#ifdef __BIG_ENDIAN\r\nNV_PFIFO_CACHE1_BIG_ENDIAN |\r\n#endif\r\nNV_PFIFO_CACHE1_DMA_FETCH_MAX_REQS_8);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv17_fifo_ctor(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nstruct nv04_instmem_priv *imem = nv04_instmem(parent);\r\nstruct nv04_fifo_priv *priv;\r\nint ret;\r\nret = nvkm_fifo_create(parent, engine, oclass, 0, 31, &priv);\r\n*pobject = nv_object(priv);\r\nif (ret)\r\nreturn ret;\r\nnvkm_ramht_ref(imem->ramht, &priv->ramht);\r\nnvkm_gpuobj_ref(imem->ramro, &priv->ramro);\r\nnvkm_gpuobj_ref(imem->ramfc, &priv->ramfc);\r\nnv_subdev(priv)->unit = 0x00000100;\r\nnv_subdev(priv)->intr = nv04_fifo_intr;\r\nnv_engine(priv)->cclass = &nv17_fifo_cclass;\r\nnv_engine(priv)->sclass = nv17_fifo_sclass;\r\npriv->base.pause = nv04_fifo_pause;\r\npriv->base.start = nv04_fifo_start;\r\npriv->ramfc_desc = nv17_ramfc;\r\nreturn 0;\r\n}\r\nstatic int\r\nnv17_fifo_init(struct nvkm_object *object)\r\n{\r\nstruct nv04_fifo_priv *priv = (void *)object;\r\nint ret;\r\nret = nvkm_fifo_init(&priv->base);\r\nif (ret)\r\nreturn ret;\r\nnv_wr32(priv, NV04_PFIFO_DELAY_0, 0x000000ff);\r\nnv_wr32(priv, NV04_PFIFO_DMA_TIMESLICE, 0x0101ffff);\r\nnv_wr32(priv, NV03_PFIFO_RAMHT, (0x03 << 24) |\r\n((priv->ramht->bits - 9) << 16) |\r\n(priv->ramht->gpuobj.addr >> 8));\r\nnv_wr32(priv, NV03_PFIFO_RAMRO, priv->ramro->addr >> 8);\r\nnv_wr32(priv, NV03_PFIFO_RAMFC, priv->ramfc->addr >> 8 | 0x00010000);\r\nnv_wr32(priv, NV03_PFIFO_CACHE1_PUSH1, priv->base.max);\r\nnv_wr32(priv, NV03_PFIFO_INTR_0, 0xffffffff);\r\nnv_wr32(priv, NV03_PFIFO_INTR_EN_0, 0xffffffff);\r\nnv_wr32(priv, NV03_PFIFO_CACHE1_PUSH0, 1);\r\nnv_wr32(priv, NV04_PFIFO_CACHE1_PULL0, 1);\r\nnv_wr32(priv, NV03_PFIFO_CACHES, 1);\r\nreturn 0;\r\n}

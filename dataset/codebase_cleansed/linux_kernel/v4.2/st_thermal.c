static int st_thermal_alloc_regfields(struct st_thermal_sensor *sensor)\r\n{\r\nstruct device *dev = sensor->dev;\r\nstruct regmap *regmap = sensor->regmap;\r\nconst struct reg_field *reg_fields = sensor->cdata->reg_fields;\r\nsensor->dcorrect = devm_regmap_field_alloc(dev, regmap,\r\nreg_fields[DCORRECT]);\r\nsensor->overflow = devm_regmap_field_alloc(dev, regmap,\r\nreg_fields[OVERFLOW]);\r\nsensor->temp_data = devm_regmap_field_alloc(dev, regmap,\r\nreg_fields[DATA]);\r\nif (IS_ERR(sensor->dcorrect) ||\r\nIS_ERR(sensor->overflow) ||\r\nIS_ERR(sensor->temp_data)) {\r\ndev_err(dev, "failed to allocate common regfields\n");\r\nreturn -EINVAL;\r\n}\r\nreturn sensor->ops->alloc_regfields(sensor);\r\n}\r\nstatic int st_thermal_sensor_on(struct st_thermal_sensor *sensor)\r\n{\r\nint ret;\r\nstruct device *dev = sensor->dev;\r\nret = clk_prepare_enable(sensor->clk);\r\nif (ret) {\r\ndev_err(dev, "failed to enable clk\n");\r\nreturn ret;\r\n}\r\nret = sensor->ops->power_ctrl(sensor, POWER_ON);\r\nif (ret) {\r\ndev_err(dev, "failed to power on sensor\n");\r\nclk_disable_unprepare(sensor->clk);\r\n}\r\nreturn ret;\r\n}\r\nstatic int st_thermal_sensor_off(struct st_thermal_sensor *sensor)\r\n{\r\nint ret;\r\nret = sensor->ops->power_ctrl(sensor, POWER_OFF);\r\nif (ret)\r\nreturn ret;\r\nclk_disable_unprepare(sensor->clk);\r\nreturn 0;\r\n}\r\nstatic int st_thermal_calibration(struct st_thermal_sensor *sensor)\r\n{\r\nint ret;\r\nunsigned int val;\r\nstruct device *dev = sensor->dev;\r\nret = regmap_field_read(sensor->dcorrect, &val);\r\nif (ret) {\r\ndev_err(dev, "failed to read calibration data\n");\r\nreturn ret;\r\n}\r\nif (!val) {\r\nret = regmap_field_write(sensor->dcorrect,\r\nsensor->cdata->calibration_val);\r\nif (ret)\r\ndev_err(dev, "failed to set calibration data\n");\r\n}\r\nreturn ret;\r\n}\r\nstatic int st_thermal_get_temp(struct thermal_zone_device *th,\r\nunsigned long *temperature)\r\n{\r\nstruct st_thermal_sensor *sensor = th->devdata;\r\nstruct device *dev = sensor->dev;\r\nunsigned int temp;\r\nunsigned int overflow;\r\nint ret;\r\nret = regmap_field_read(sensor->overflow, &overflow);\r\nif (ret)\r\nreturn ret;\r\nif (overflow)\r\nreturn -EIO;\r\nret = regmap_field_read(sensor->temp_data, &temp);\r\nif (ret)\r\nreturn ret;\r\ntemp += sensor->cdata->temp_adjust_val;\r\ntemp = mcelsius(temp);\r\ndev_dbg(dev, "temperature: %d\n", temp);\r\n*temperature = temp;\r\nreturn 0;\r\n}\r\nstatic int st_thermal_get_trip_type(struct thermal_zone_device *th,\r\nint trip, enum thermal_trip_type *type)\r\n{\r\nstruct st_thermal_sensor *sensor = th->devdata;\r\nstruct device *dev = sensor->dev;\r\nswitch (trip) {\r\ncase 0:\r\n*type = THERMAL_TRIP_CRITICAL;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid trip point\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_thermal_get_trip_temp(struct thermal_zone_device *th,\r\nint trip, unsigned long *temp)\r\n{\r\nstruct st_thermal_sensor *sensor = th->devdata;\r\nstruct device *dev = sensor->dev;\r\nswitch (trip) {\r\ncase 0:\r\n*temp = mcelsius(sensor->cdata->crit_temp);\r\nbreak;\r\ndefault:\r\ndev_err(dev, "Invalid trip point\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint st_thermal_register(struct platform_device *pdev,\r\nconst struct of_device_id *st_thermal_of_match)\r\n{\r\nstruct st_thermal_sensor *sensor;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nconst struct of_device_id *match;\r\nint polling_delay;\r\nint ret;\r\nif (!np) {\r\ndev_err(dev, "device tree node not found\n");\r\nreturn -EINVAL;\r\n}\r\nsensor = devm_kzalloc(dev, sizeof(*sensor), GFP_KERNEL);\r\nif (!sensor)\r\nreturn -ENOMEM;\r\nsensor->dev = dev;\r\nmatch = of_match_device(st_thermal_of_match, dev);\r\nif (!(match && match->data))\r\nreturn -EINVAL;\r\nsensor->cdata = match->data;\r\nif (!sensor->cdata->ops)\r\nreturn -EINVAL;\r\nsensor->ops = sensor->cdata->ops;\r\nret = sensor->ops->regmap_init(sensor);\r\nif (ret)\r\nreturn ret;\r\nret = st_thermal_alloc_regfields(sensor);\r\nif (ret)\r\nreturn ret;\r\nsensor->clk = devm_clk_get(dev, "thermal");\r\nif (IS_ERR(sensor->clk)) {\r\ndev_err(dev, "failed to fetch clock\n");\r\nreturn PTR_ERR(sensor->clk);\r\n}\r\nif (sensor->ops->register_enable_irq) {\r\nret = sensor->ops->register_enable_irq(sensor);\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = st_thermal_sensor_on(sensor);\r\nif (ret)\r\nreturn ret;\r\nret = st_thermal_calibration(sensor);\r\nif (ret)\r\ngoto sensor_off;\r\npolling_delay = sensor->ops->register_enable_irq ? 0 : 1000;\r\nsensor->thermal_dev =\r\nthermal_zone_device_register(dev_name(dev), 1, 0, sensor,\r\n&st_tz_ops, NULL, 0, polling_delay);\r\nif (IS_ERR(sensor->thermal_dev)) {\r\ndev_err(dev, "failed to register thermal zone device\n");\r\nret = PTR_ERR(sensor->thermal_dev);\r\ngoto sensor_off;\r\n}\r\nplatform_set_drvdata(pdev, sensor);\r\nreturn 0;\r\nsensor_off:\r\nst_thermal_sensor_off(sensor);\r\nreturn ret;\r\n}\r\nint st_thermal_unregister(struct platform_device *pdev)\r\n{\r\nstruct st_thermal_sensor *sensor = platform_get_drvdata(pdev);\r\nst_thermal_sensor_off(sensor);\r\nthermal_zone_device_unregister(sensor->thermal_dev);\r\nreturn 0;\r\n}\r\nstatic int st_thermal_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct st_thermal_sensor *sensor = platform_get_drvdata(pdev);\r\nreturn st_thermal_sensor_off(sensor);\r\n}\r\nstatic int st_thermal_resume(struct device *dev)\r\n{\r\nint ret;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct st_thermal_sensor *sensor = platform_get_drvdata(pdev);\r\nret = st_thermal_sensor_on(sensor);\r\nif (ret)\r\nreturn ret;\r\nret = st_thermal_calibration(sensor);\r\nif (ret)\r\nreturn ret;\r\nif (sensor->ops->enable_irq) {\r\nret = sensor->ops->enable_irq(sensor);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

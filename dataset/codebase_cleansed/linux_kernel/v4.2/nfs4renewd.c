void\r\nnfs4_renew_state(struct work_struct *work)\r\n{\r\nconst struct nfs4_state_maintenance_ops *ops;\r\nstruct nfs_client *clp =\r\ncontainer_of(work, struct nfs_client, cl_renewd.work);\r\nstruct rpc_cred *cred;\r\nlong lease;\r\nunsigned long last, now;\r\nunsigned renew_flags = 0;\r\nops = clp->cl_mvops->state_renewal_ops;\r\ndprintk("%s: start\n", __func__);\r\nif (test_bit(NFS_CS_STOP_RENEW, &clp->cl_res_state))\r\ngoto out;\r\nspin_lock(&clp->cl_lock);\r\nlease = clp->cl_lease_time;\r\nlast = clp->cl_last_renewal;\r\nnow = jiffies;\r\nif (time_after(now, last + lease/3))\r\nrenew_flags |= NFS4_RENEW_TIMEOUT;\r\nif (nfs_delegations_present(clp))\r\nrenew_flags |= NFS4_RENEW_DELEGATION_CB;\r\nif (renew_flags != 0) {\r\ncred = ops->get_state_renewal_cred_locked(clp);\r\nspin_unlock(&clp->cl_lock);\r\nif (cred == NULL) {\r\nif (!(renew_flags & NFS4_RENEW_DELEGATION_CB)) {\r\nset_bit(NFS4CLNT_LEASE_EXPIRED, &clp->cl_state);\r\ngoto out;\r\n}\r\nnfs_expire_all_delegations(clp);\r\n} else {\r\nint ret;\r\nret = ops->sched_state_renewal(clp, cred, renew_flags);\r\nput_rpccred(cred);\r\nswitch (ret) {\r\ndefault:\r\ngoto out_exp;\r\ncase -EAGAIN:\r\ncase -ENOMEM:\r\nbreak;\r\n}\r\n}\r\n} else {\r\ndprintk("%s: failed to call renewd. Reason: lease not expired \n",\r\n__func__);\r\nspin_unlock(&clp->cl_lock);\r\n}\r\nnfs4_schedule_state_renewal(clp);\r\nout_exp:\r\nnfs_expire_unreferenced_delegations(clp);\r\nout:\r\ndprintk("%s: done\n", __func__);\r\n}\r\nvoid\r\nnfs4_schedule_state_renewal(struct nfs_client *clp)\r\n{\r\nlong timeout;\r\nspin_lock(&clp->cl_lock);\r\ntimeout = (2 * clp->cl_lease_time) / 3 + (long)clp->cl_last_renewal\r\n- (long)jiffies;\r\nif (timeout < 5 * HZ)\r\ntimeout = 5 * HZ;\r\ndprintk("%s: requeueing work. Lease period = %ld\n",\r\n__func__, (timeout + HZ - 1) / HZ);\r\nmod_delayed_work(system_wq, &clp->cl_renewd, timeout);\r\nset_bit(NFS_CS_RENEWD, &clp->cl_res_state);\r\nspin_unlock(&clp->cl_lock);\r\n}\r\nvoid\r\nnfs4_kill_renewd(struct nfs_client *clp)\r\n{\r\ncancel_delayed_work_sync(&clp->cl_renewd);\r\n}

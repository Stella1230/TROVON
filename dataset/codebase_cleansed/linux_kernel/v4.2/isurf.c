static u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn (readb(cs->hw.isurf.isac + offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwriteb(value, cs->hw.isurf.isac + offset); mb();\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nregister int i;\r\nfor (i = 0; i < size; i++)\r\ndata[i] = readb(cs->hw.isurf.isac);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nregister int i;\r\nfor (i = 0; i < size; i++) {\r\nwriteb(data[i], cs->hw.isurf.isac); mb();\r\n}\r\n}\r\nstatic u_char\r\nReadISAR(struct IsdnCardState *cs, int mode, u_char offset)\r\n{\r\nreturn (readb(cs->hw.isurf.isar + offset));\r\n}\r\nstatic void\r\nWriteISAR(struct IsdnCardState *cs, int mode, u_char offset, u_char value)\r\n{\r\nwriteb(value, cs->hw.isurf.isar + offset); mb();\r\n}\r\nstatic irqreturn_t\r\nisurf_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val;\r\nint cnt = 5;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nval = readb(cs->hw.isurf.isar + ISAR_IRQBIT);\r\nStart_ISAR:\r\nif (val & ISAR_IRQSTA)\r\nisar_int_main(cs);\r\nval = readb(cs->hw.isurf.isac + ISAC_ISTA);\r\nStart_ISAC:\r\nif (val)\r\nisac_interrupt(cs, val);\r\nval = readb(cs->hw.isurf.isar + ISAR_IRQBIT);\r\nif ((val & ISAR_IRQSTA) && --cnt) {\r\nif (cs->debug & L1_DEB_HSCX)\r\ndebugl1(cs, "ISAR IntStat after IntRoutine");\r\ngoto Start_ISAR;\r\n}\r\nval = readb(cs->hw.isurf.isac + ISAC_ISTA);\r\nif (val && --cnt) {\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "ISAC IntStat after IntRoutine");\r\ngoto Start_ISAC;\r\n}\r\nif (!cnt)\r\nprintk(KERN_WARNING "ISurf IRQ LOOP\n");\r\nwriteb(0, cs->hw.isurf.isar + ISAR_IRQBIT); mb();\r\nwriteb(0xFF, cs->hw.isurf.isac + ISAC_MASK); mb();\r\nwriteb(0, cs->hw.isurf.isac + ISAC_MASK); mb();\r\nwriteb(ISAR_IRQMSK, cs->hw.isurf.isar + ISAR_IRQBIT); mb();\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nrelease_io_isurf(struct IsdnCardState *cs)\r\n{\r\nrelease_region(cs->hw.isurf.reset, 1);\r\niounmap(cs->hw.isurf.isar);\r\nrelease_mem_region(cs->hw.isurf.phymem, ISURF_IOMEM_SIZE);\r\n}\r\nstatic void\r\nreset_isurf(struct IsdnCardState *cs, u_char chips)\r\n{\r\nprintk(KERN_INFO "ISurf: resetting card\n");\r\nbyteout(cs->hw.isurf.reset, chips);\r\nmdelay(10);\r\nbyteout(cs->hw.isurf.reset, ISURF_ISAR_EA);\r\nmdelay(10);\r\n}\r\nstatic int\r\nISurf_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_isurf(cs, ISURF_RESET);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_RELEASE:\r\nrelease_io_isurf(cs);\r\nreturn (0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_isurf(cs, ISURF_RESET);\r\nclear_pending_isac_ints(cs);\r\nwriteb(0, cs->hw.isurf.isar + ISAR_IRQBIT); mb();\r\ninitisac(cs);\r\ninitisar(cs);\r\ncs->writeisac(cs, ISAC_MASK, 0);\r\ncs->writeisac(cs, ISAC_CMDR, 0x41);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_TEST:\r\nreturn (0);\r\n}\r\nreturn (0);\r\n}\r\nstatic int\r\nisurf_auxcmd(struct IsdnCardState *cs, isdn_ctrl *ic) {\r\nint ret;\r\nu_long flags;\r\nif ((ic->command == ISDN_CMD_IOCTL) && (ic->arg == 9)) {\r\nret = isar_auxcmd(cs, ic);\r\nspin_lock_irqsave(&cs->lock, flags);\r\nif (!ret) {\r\nreset_isurf(cs, ISURF_ISAR_EA | ISURF_ISAC_RESET |\r\nISURF_ARCOFI_RESET);\r\ninitisac(cs);\r\ncs->writeisac(cs, ISAC_MASK, 0);\r\ncs->writeisac(cs, ISAC_CMDR, 0x41);\r\n}\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (ret);\r\n}\r\nreturn (isar_auxcmd(cs, ic));\r\n}\r\nint setup_isurf(struct IsdnCard *card)\r\n{\r\nint ver;\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, ISurf_revision);\r\nprintk(KERN_INFO "HiSax: ISurf driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_ISURF)\r\nreturn (0);\r\nif (card->para[1] && card->para[2]) {\r\ncs->hw.isurf.reset = card->para[1];\r\ncs->hw.isurf.phymem = card->para[2];\r\ncs->irq = card->para[0];\r\n} else {\r\n#ifdef __ISAPNP__\r\nif (isapnp_present()) {\r\nstruct pnp_dev *pnp_d = NULL;\r\nint err;\r\ncs->subtyp = 0;\r\nif ((pnp_c = pnp_find_card(\r\nISAPNP_VENDOR('S', 'I', 'E'),\r\nISAPNP_FUNCTION(0x0010), pnp_c))) {\r\nif (!(pnp_d = pnp_find_dev(pnp_c,\r\nISAPNP_VENDOR('S', 'I', 'E'),\r\nISAPNP_FUNCTION(0x0010), pnp_d))) {\r\nprintk(KERN_ERR "ISurfPnP: PnP error card found, no device\n");\r\nreturn (0);\r\n}\r\npnp_disable_dev(pnp_d);\r\nerr = pnp_activate_dev(pnp_d);\r\nif (err < 0) {\r\npr_warn("%s: pnp_activate_dev ret=%d\n",\r\n__func__, err);\r\nreturn 0;\r\n}\r\ncs->hw.isurf.reset = pnp_port_start(pnp_d, 0);\r\ncs->hw.isurf.phymem = pnp_mem_start(pnp_d, 1);\r\ncs->irq = pnp_irq(pnp_d, 0);\r\nif (!cs->irq || !cs->hw.isurf.reset || !cs->hw.isurf.phymem) {\r\nprintk(KERN_ERR "ISurfPnP:some resources are missing %d/%x/%lx\n",\r\ncs->irq, cs->hw.isurf.reset, cs->hw.isurf.phymem);\r\npnp_disable_dev(pnp_d);\r\nreturn (0);\r\n}\r\n} else {\r\nprintk(KERN_INFO "ISurfPnP: no ISAPnP card found\n");\r\nreturn (0);\r\n}\r\n} else {\r\nprintk(KERN_INFO "ISurfPnP: no ISAPnP bus found\n");\r\nreturn (0);\r\n}\r\n#else\r\nprintk(KERN_WARNING "HiSax: Siemens I-Surf port/mem not set\n");\r\nreturn (0);\r\n#endif\r\n}\r\nif (!request_region(cs->hw.isurf.reset, 1, "isurf isdn")) {\r\nprintk(KERN_WARNING\r\n"HiSax: Siemens I-Surf config port %x already in use\n",\r\ncs->hw.isurf.reset);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.isurf.phymem, ISURF_IOMEM_SIZE, "isurf iomem")) {\r\nprintk(KERN_WARNING "HiSax: Siemens I-Surf memory region "\r\n"%lx-%lx already in use\n",\r\ncs->hw.isurf.phymem,\r\ncs->hw.isurf.phymem + ISURF_IOMEM_SIZE);\r\nrelease_region(cs->hw.isurf.reset, 1);\r\nreturn (0);\r\n}\r\ncs->hw.isurf.isar = ioremap(cs->hw.isurf.phymem, ISURF_IOMEM_SIZE);\r\ncs->hw.isurf.isac = cs->hw.isurf.isar + ISURF_ISAC_OFFSET;\r\nprintk(KERN_INFO\r\n"ISurf: defined at 0x%x 0x%lx IRQ %d\n",\r\ncs->hw.isurf.reset,\r\ncs->hw.isurf.phymem,\r\ncs->irq);\r\nsetup_isac(cs);\r\ncs->cardmsg = &ISurf_card_msg;\r\ncs->irq_func = &isurf_interrupt;\r\ncs->auxcmd = &isurf_auxcmd;\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->bcs[0].hw.isar.reg = &cs->hw.isurf.isar_r;\r\ncs->bcs[1].hw.isar.reg = &cs->hw.isurf.isar_r;\r\ntest_and_set_bit(HW_ISAR, &cs->HW_Flags);\r\nISACVersion(cs, "ISurf:");\r\ncs->BC_Read_Reg = &ReadISAR;\r\ncs->BC_Write_Reg = &WriteISAR;\r\ncs->BC_Send_Data = &isar_fill_fifo;\r\nver = ISARVersion(cs, "ISurf:");\r\nif (ver < 0) {\r\nprintk(KERN_WARNING\r\n"ISurf: wrong ISAR version (ret = %d)\n", ver);\r\nrelease_io_isurf(cs);\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}

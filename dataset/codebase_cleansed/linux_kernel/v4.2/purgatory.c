static int copy_backup_region(void)\r\n{\r\nif (backup_dest)\r\nmemcpy((void *)backup_dest, (void *)backup_src, backup_sz);\r\nreturn 0;\r\n}\r\nint verify_sha256_digest(void)\r\n{\r\nstruct sha_region *ptr, *end;\r\nu8 digest[SHA256_DIGEST_SIZE];\r\nstruct sha256_state sctx;\r\nsha256_init(&sctx);\r\nend = &sha_regions[sizeof(sha_regions)/sizeof(sha_regions[0])];\r\nfor (ptr = sha_regions; ptr < end; ptr++)\r\nsha256_update(&sctx, (uint8_t *)(ptr->start), ptr->len);\r\nsha256_final(&sctx, digest);\r\nif (memcmp(digest, sha256_digest, sizeof(digest)))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid purgatory(void)\r\n{\r\nint ret;\r\nret = verify_sha256_digest();\r\nif (ret) {\r\nfor (;;)\r\n;\r\n}\r\ncopy_backup_region();\r\n}

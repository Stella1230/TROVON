static inline int NCR5380_pwrite(struct Scsi_Host *instance, unsigned char *addr,\r\nint len)\r\n{\r\nvoid __iomem *base = priv(instance)->base;\r\nprintk("writing %p len %d\n",addr, len);\r\nif(!len) return -1;\r\nwhile(1)\r\n{\r\nint status;\r\nwhile (((status = readw(base + STAT)) & 0x100)==0);\r\n}\r\n}\r\nstatic inline int NCR5380_pread(struct Scsi_Host *instance, unsigned char *addr,\r\nint len)\r\n{\r\nvoid __iomem *base = priv(instance)->base;\r\nprintk("reading %p len %d\n", addr, len);\r\nwhile(len > 0)\r\n{\r\nunsigned int status, timeout;\r\nunsigned long b;\r\ntimeout = 0x01FFFFFF;\r\nwhile (((status = readw(base + STAT)) & 0x100)==0)\r\n{\r\ntimeout--;\r\nif(status & 0x200 || !timeout)\r\n{\r\nprintk("status = %08X\n", status);\r\nreturn 1;\r\n}\r\n}\r\nif(len >= 128)\r\n{\r\nreadsw(base + DATA, addr, 128);\r\naddr += 128;\r\nlen -= 128;\r\n}\r\nelse\r\n{\r\nb = (unsigned long) readw(base + DATA);\r\n*addr ++ = b;\r\nlen -= 1;\r\nif(len)\r\n*addr ++ = b>>8;\r\nlen -= 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int oakscsi_probe(struct expansion_card *ec, const struct ecard_id *id)\r\n{\r\nstruct Scsi_Host *host;\r\nint ret = -ENOMEM;\r\nret = ecard_request_resources(ec);\r\nif (ret)\r\ngoto out;\r\nhost = scsi_host_alloc(&oakscsi_template, sizeof(struct NCR5380_hostdata));\r\nif (!host) {\r\nret = -ENOMEM;\r\ngoto release;\r\n}\r\npriv(host)->base = ioremap(ecard_resource_start(ec, ECARD_RES_MEMC),\r\necard_resource_len(ec, ECARD_RES_MEMC));\r\nif (!priv(host)->base) {\r\nret = -ENOMEM;\r\ngoto unreg;\r\n}\r\nhost->irq = NO_IRQ;\r\nhost->n_io_port = 255;\r\nNCR5380_init(host, 0);\r\nret = scsi_add_host(host, &ec->dev);\r\nif (ret)\r\ngoto out_unmap;\r\nscsi_scan_host(host);\r\ngoto out;\r\nout_unmap:\r\niounmap(priv(host)->base);\r\nunreg:\r\nscsi_host_put(host);\r\nrelease:\r\necard_release_resources(ec);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void oakscsi_remove(struct expansion_card *ec)\r\n{\r\nstruct Scsi_Host *host = ecard_get_drvdata(ec);\r\necard_set_drvdata(ec, NULL);\r\nscsi_remove_host(host);\r\nNCR5380_exit(host);\r\niounmap(priv(host)->base);\r\nscsi_host_put(host);\r\necard_release_resources(ec);\r\n}\r\nstatic int __init oakscsi_init(void)\r\n{\r\nreturn ecard_register_driver(&oakscsi_driver);\r\n}\r\nstatic void __exit oakscsi_exit(void)\r\n{\r\necard_remove_driver(&oakscsi_driver);\r\n}

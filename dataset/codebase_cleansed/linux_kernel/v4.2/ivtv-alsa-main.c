static inline\r\nstruct snd_ivtv_card *to_snd_ivtv_card(struct v4l2_device *v4l2_dev)\r\n{\r\nreturn to_ivtv(v4l2_dev)->alsa;\r\n}\r\nstatic inline\r\nstruct snd_ivtv_card *p_to_snd_ivtv_card(struct v4l2_device **v4l2_dev)\r\n{\r\nreturn container_of(v4l2_dev, struct snd_ivtv_card, v4l2_dev);\r\n}\r\nstatic void snd_ivtv_card_free(struct snd_ivtv_card *itvsc)\r\n{\r\nif (itvsc == NULL)\r\nreturn;\r\nif (itvsc->v4l2_dev != NULL)\r\nto_ivtv(itvsc->v4l2_dev)->alsa = NULL;\r\nkfree(itvsc);\r\n}\r\nstatic void snd_ivtv_card_private_free(struct snd_card *sc)\r\n{\r\nif (sc == NULL)\r\nreturn;\r\nsnd_ivtv_card_free(sc->private_data);\r\nsc->private_data = NULL;\r\nsc->private_free = NULL;\r\n}\r\nstatic int snd_ivtv_card_create(struct v4l2_device *v4l2_dev,\r\nstruct snd_card *sc,\r\nstruct snd_ivtv_card **itvsc)\r\n{\r\n*itvsc = kzalloc(sizeof(struct snd_ivtv_card), GFP_KERNEL);\r\nif (*itvsc == NULL)\r\nreturn -ENOMEM;\r\n(*itvsc)->v4l2_dev = v4l2_dev;\r\n(*itvsc)->sc = sc;\r\nsc->private_data = *itvsc;\r\nsc->private_free = snd_ivtv_card_private_free;\r\nreturn 0;\r\n}\r\nstatic int snd_ivtv_card_set_names(struct snd_ivtv_card *itvsc)\r\n{\r\nstruct ivtv *itv = to_ivtv(itvsc->v4l2_dev);\r\nstruct snd_card *sc = itvsc->sc;\r\nstrlcpy(sc->driver, "CX2341[56]", sizeof(sc->driver));\r\nsnprintf(sc->shortname, sizeof(sc->shortname), "IVTV-%d",\r\nitv->instance);\r\nsnprintf(sc->longname, sizeof(sc->longname),\r\n"CX2341[56] #%d %s TV/FM Radio/Line-In Capture",\r\nitv->instance, itv->card_name);\r\nreturn 0;\r\n}\r\nstatic int snd_ivtv_init(struct v4l2_device *v4l2_dev)\r\n{\r\nstruct ivtv *itv = to_ivtv(v4l2_dev);\r\nstruct snd_card *sc = NULL;\r\nstruct snd_ivtv_card *itvsc;\r\nint ret;\r\nret = snd_card_new(&itv->pdev->dev,\r\nSNDRV_DEFAULT_IDX1,\r\nSNDRV_DEFAULT_STR1,\r\nTHIS_MODULE, 0, &sc);\r\nif (ret) {\r\nIVTV_ALSA_ERR("%s: snd_card_new() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit;\r\n}\r\nret = snd_ivtv_card_create(v4l2_dev, sc, &itvsc);\r\nif (ret) {\r\nIVTV_ALSA_ERR("%s: snd_ivtv_card_create() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit_free;\r\n}\r\nsnd_ivtv_card_set_names(itvsc);\r\n#if 0\r\nret = snd_ivtv_mixer_create(itvsc);\r\nif (ret) {\r\nIVTV_ALSA_WARN("%s: snd_ivtv_mixer_create() failed with err %d:"\r\n" proceeding anyway\n", __func__, ret);\r\n}\r\n#endif\r\nret = snd_ivtv_pcm_create(itvsc);\r\nif (ret) {\r\nIVTV_ALSA_ERR("%s: snd_ivtv_pcm_create() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit_free;\r\n}\r\nitv->alsa = itvsc;\r\nret = snd_card_register(sc);\r\nif (ret) {\r\nitv->alsa = NULL;\r\nIVTV_ALSA_ERR("%s: snd_card_register() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit_free;\r\n}\r\nreturn 0;\r\nerr_exit_free:\r\nif (sc != NULL)\r\nsnd_card_free(sc);\r\nkfree(itvsc);\r\nerr_exit:\r\nreturn ret;\r\n}\r\nstatic int ivtv_alsa_load(struct ivtv *itv)\r\n{\r\nstruct v4l2_device *v4l2_dev = &itv->v4l2_dev;\r\nstruct ivtv_stream *s;\r\nif (v4l2_dev == NULL) {\r\npr_err("ivtv-alsa: %s: struct v4l2_device * is NULL\n",\r\n__func__);\r\nreturn 0;\r\n}\r\nitv = to_ivtv(v4l2_dev);\r\nif (itv == NULL) {\r\npr_err("ivtv-alsa itv is NULL\n");\r\nreturn 0;\r\n}\r\ns = &itv->streams[IVTV_ENC_STREAM_TYPE_PCM];\r\nif (s->vdev.v4l2_dev == NULL) {\r\nIVTV_DEBUG_ALSA_INFO("%s: PCM stream for card is disabled - "\r\n"skipping\n", __func__);\r\nreturn 0;\r\n}\r\nif (itv->alsa != NULL) {\r\nIVTV_ALSA_ERR("%s: struct snd_ivtv_card * already exists\n",\r\n__func__);\r\nreturn 0;\r\n}\r\nif (snd_ivtv_init(v4l2_dev)) {\r\nIVTV_ALSA_ERR("%s: failed to create struct snd_ivtv_card\n",\r\n__func__);\r\n} else {\r\nIVTV_DEBUG_ALSA_INFO("%s: created ivtv ALSA interface instance "\r\n"\n", __func__);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ivtv_alsa_init(void)\r\n{\r\npr_info("ivtv-alsa: module loading...\n");\r\nivtv_ext_init = &ivtv_alsa_load;\r\nreturn 0;\r\n}\r\nstatic void __exit snd_ivtv_exit(struct snd_ivtv_card *itvsc)\r\n{\r\nstruct ivtv *itv = to_ivtv(itvsc->v4l2_dev);\r\nsnd_card_free(itvsc->sc);\r\nitv->alsa = NULL;\r\n}\r\nstatic int __exit ivtv_alsa_exit_callback(struct device *dev, void *data)\r\n{\r\nstruct v4l2_device *v4l2_dev = dev_get_drvdata(dev);\r\nstruct snd_ivtv_card *itvsc;\r\nif (v4l2_dev == NULL) {\r\npr_err("ivtv-alsa: %s: struct v4l2_device * is NULL\n",\r\n__func__);\r\nreturn 0;\r\n}\r\nitvsc = to_snd_ivtv_card(v4l2_dev);\r\nif (itvsc == NULL) {\r\nIVTV_ALSA_WARN("%s: struct snd_ivtv_card * is NULL\n",\r\n__func__);\r\nreturn 0;\r\n}\r\nsnd_ivtv_exit(itvsc);\r\nreturn 0;\r\n}\r\nstatic void __exit ivtv_alsa_exit(void)\r\n{\r\nstruct device_driver *drv;\r\nint ret;\r\npr_info("ivtv-alsa: module unloading...\n");\r\ndrv = driver_find("ivtv", &pci_bus_type);\r\nret = driver_for_each_device(drv, NULL, NULL, ivtv_alsa_exit_callback);\r\n(void)ret;\r\nivtv_ext_init = NULL;\r\npr_info("ivtv-alsa: module unload complete\n");\r\n}

static int map_foreign_page(unsigned long lpfn, unsigned long fgmfn,\r\nunsigned int domid)\r\n{\r\nint rc;\r\nstruct xen_add_to_physmap_range xatp = {\r\n.domid = DOMID_SELF,\r\n.foreign_domid = domid,\r\n.size = 1,\r\n.space = XENMAPSPACE_gmfn_foreign,\r\n};\r\nxen_ulong_t idx = fgmfn;\r\nxen_pfn_t gpfn = lpfn;\r\nint err = 0;\r\nset_xen_guest_handle(xatp.idxs, &idx);\r\nset_xen_guest_handle(xatp.gpfns, &gpfn);\r\nset_xen_guest_handle(xatp.errs, &err);\r\nrc = HYPERVISOR_memory_op(XENMEM_add_to_physmap_range, &xatp);\r\nreturn rc < 0 ? rc : err;\r\n}\r\nstatic int remap_pte_fn(pte_t *ptep, pgtable_t token, unsigned long addr,\r\nvoid *data)\r\n{\r\nstruct remap_data *info = data;\r\nstruct page *page = info->pages[info->index++];\r\nunsigned long pfn = page_to_pfn(page);\r\npte_t pte = pte_mkspecial(pfn_pte(pfn, info->prot));\r\nint rc;\r\nrc = map_foreign_page(pfn, *info->fgmfn, info->domid);\r\n*info->err_ptr++ = rc;\r\nif (!rc) {\r\nset_pte_at(info->vma->vm_mm, addr, ptep, pte);\r\ninfo->mapped++;\r\n}\r\ninfo->fgmfn++;\r\nreturn 0;\r\n}\r\nint xen_xlate_remap_gfn_array(struct vm_area_struct *vma,\r\nunsigned long addr,\r\nxen_pfn_t *mfn, int nr,\r\nint *err_ptr, pgprot_t prot,\r\nunsigned domid,\r\nstruct page **pages)\r\n{\r\nint err;\r\nstruct remap_data data;\r\nunsigned long range = nr << PAGE_SHIFT;\r\nBUG_ON(!((vma->vm_flags & (VM_PFNMAP | VM_IO)) == (VM_PFNMAP | VM_IO)));\r\ndata.fgmfn = mfn;\r\ndata.prot = prot;\r\ndata.domid = domid;\r\ndata.vma = vma;\r\ndata.pages = pages;\r\ndata.index = 0;\r\ndata.err_ptr = err_ptr;\r\ndata.mapped = 0;\r\nerr = apply_to_page_range(vma->vm_mm, addr, range,\r\nremap_pte_fn, &data);\r\nreturn err < 0 ? err : data.mapped;\r\n}\r\nint xen_xlate_unmap_gfn_range(struct vm_area_struct *vma,\r\nint nr, struct page **pages)\r\n{\r\nint i;\r\nfor (i = 0; i < nr; i++) {\r\nstruct xen_remove_from_physmap xrp;\r\nunsigned long pfn;\r\npfn = page_to_pfn(pages[i]);\r\nxrp.domid = DOMID_SELF;\r\nxrp.gpfn = pfn;\r\n(void)HYPERVISOR_memory_op(XENMEM_remove_from_physmap, &xrp);\r\n}\r\nreturn 0;\r\n}

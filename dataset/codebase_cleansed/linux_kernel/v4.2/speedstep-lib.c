static unsigned int pentium3_get_frequency(enum speedstep_processor processor)\r\n{\r\nstruct {\r\nunsigned int ratio;\r\nu8 bitmap;\r\n} msr_decode_mult[] = {\r\n{ 30, 0x01 },\r\n{ 35, 0x05 },\r\n{ 40, 0x02 },\r\n{ 45, 0x06 },\r\n{ 50, 0x00 },\r\n{ 55, 0x04 },\r\n{ 60, 0x0b },\r\n{ 65, 0x0f },\r\n{ 70, 0x09 },\r\n{ 75, 0x0d },\r\n{ 80, 0x0a },\r\n{ 85, 0x26 },\r\n{ 90, 0x20 },\r\n{ 100, 0x2b },\r\n{ 0, 0xff }\r\n};\r\nstruct {\r\nunsigned int value;\r\nu8 bitmap;\r\n} msr_decode_fsb[] = {\r\n{ 66, 0x0 },\r\n{ 100, 0x2 },\r\n{ 133, 0x1 },\r\n{ 0, 0xff}\r\n};\r\nu32 msr_lo, msr_tmp;\r\nint i = 0, j = 0;\r\nrdmsr(MSR_IA32_EBL_CR_POWERON, msr_lo, msr_tmp);\r\npr_debug("P3 - MSR_IA32_EBL_CR_POWERON: 0x%x 0x%x\n", msr_lo, msr_tmp);\r\nmsr_tmp = msr_lo;\r\nmsr_tmp &= 0x00c0000;\r\nmsr_tmp >>= 18;\r\nwhile (msr_tmp != msr_decode_fsb[i].bitmap) {\r\nif (msr_decode_fsb[i].bitmap == 0xff)\r\nreturn 0;\r\ni++;\r\n}\r\nif (processor == SPEEDSTEP_CPU_PIII_C_EARLY) {\r\npr_debug("workaround for early PIIIs\n");\r\nmsr_lo &= 0x03c00000;\r\n} else\r\nmsr_lo &= 0x0bc00000;\r\nmsr_lo >>= 22;\r\nwhile (msr_lo != msr_decode_mult[j].bitmap) {\r\nif (msr_decode_mult[j].bitmap == 0xff)\r\nreturn 0;\r\nj++;\r\n}\r\npr_debug("speed is %u\n",\r\n(msr_decode_mult[j].ratio * msr_decode_fsb[i].value * 100));\r\nreturn msr_decode_mult[j].ratio * msr_decode_fsb[i].value * 100;\r\n}\r\nstatic unsigned int pentiumM_get_frequency(void)\r\n{\r\nu32 msr_lo, msr_tmp;\r\nrdmsr(MSR_IA32_EBL_CR_POWERON, msr_lo, msr_tmp);\r\npr_debug("PM - MSR_IA32_EBL_CR_POWERON: 0x%x 0x%x\n", msr_lo, msr_tmp);\r\nif (msr_lo & 0x00040000) {\r\nprintk(KERN_DEBUG PFX "PM - invalid FSB: 0x%x 0x%x\n",\r\nmsr_lo, msr_tmp);\r\nreturn 0;\r\n}\r\nmsr_tmp = (msr_lo >> 22) & 0x1f;\r\npr_debug("bits 22-26 are 0x%x, speed is %u\n",\r\nmsr_tmp, (msr_tmp * 100 * 1000));\r\nreturn msr_tmp * 100 * 1000;\r\n}\r\nstatic unsigned int pentium_core_get_frequency(void)\r\n{\r\nu32 fsb = 0;\r\nu32 msr_lo, msr_tmp;\r\nint ret;\r\nrdmsr(MSR_FSB_FREQ, msr_lo, msr_tmp);\r\nswitch (msr_lo & 0x07) {\r\ncase 5:\r\nfsb = 100000;\r\nbreak;\r\ncase 1:\r\nfsb = 133333;\r\nbreak;\r\ncase 3:\r\nfsb = 166667;\r\nbreak;\r\ncase 2:\r\nfsb = 200000;\r\nbreak;\r\ncase 0:\r\nfsb = 266667;\r\nbreak;\r\ncase 4:\r\nfsb = 333333;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "PCORE - MSR_FSB_FREQ undefined value");\r\n}\r\nrdmsr(MSR_IA32_EBL_CR_POWERON, msr_lo, msr_tmp);\r\npr_debug("PCORE - MSR_IA32_EBL_CR_POWERON: 0x%x 0x%x\n",\r\nmsr_lo, msr_tmp);\r\nmsr_tmp = (msr_lo >> 22) & 0x1f;\r\npr_debug("bits 22-26 are 0x%x, speed is %u\n",\r\nmsr_tmp, (msr_tmp * fsb));\r\nret = (msr_tmp * fsb);\r\nreturn ret;\r\n}\r\nstatic unsigned int pentium4_get_frequency(void)\r\n{\r\nstruct cpuinfo_x86 *c = &boot_cpu_data;\r\nu32 msr_lo, msr_hi, mult;\r\nunsigned int fsb = 0;\r\nunsigned int ret;\r\nu8 fsb_code;\r\nif (c->x86_model < 2)\r\nreturn cpu_khz;\r\nrdmsr(0x2c, msr_lo, msr_hi);\r\npr_debug("P4 - MSR_EBC_FREQUENCY_ID: 0x%x 0x%x\n", msr_lo, msr_hi);\r\nfsb_code = (msr_lo >> 16) & 0x7;\r\nswitch (fsb_code) {\r\ncase 0:\r\nfsb = 100 * 1000;\r\nbreak;\r\ncase 1:\r\nfsb = 13333 * 10;\r\nbreak;\r\ncase 2:\r\nfsb = 200 * 1000;\r\nbreak;\r\n}\r\nif (!fsb)\r\nprintk(KERN_DEBUG PFX "couldn't detect FSB speed. "\r\n"Please send an e-mail to <linux@brodo.de>\n");\r\nmult = msr_lo >> 24;\r\npr_debug("P4 - FSB %u kHz; Multiplier %u; Speed %u kHz\n",\r\nfsb, mult, (fsb * mult));\r\nret = (fsb * mult);\r\nreturn ret;\r\n}\r\nunsigned int speedstep_get_frequency(enum speedstep_processor processor)\r\n{\r\nswitch (processor) {\r\ncase SPEEDSTEP_CPU_PCORE:\r\nreturn pentium_core_get_frequency();\r\ncase SPEEDSTEP_CPU_PM:\r\nreturn pentiumM_get_frequency();\r\ncase SPEEDSTEP_CPU_P4D:\r\ncase SPEEDSTEP_CPU_P4M:\r\nreturn pentium4_get_frequency();\r\ncase SPEEDSTEP_CPU_PIII_T:\r\ncase SPEEDSTEP_CPU_PIII_C:\r\ncase SPEEDSTEP_CPU_PIII_C_EARLY:\r\nreturn pentium3_get_frequency(processor);\r\ndefault:\r\nreturn 0;\r\n};\r\nreturn 0;\r\n}\r\nunsigned int speedstep_detect_processor(void)\r\n{\r\nstruct cpuinfo_x86 *c = &cpu_data(0);\r\nu32 ebx, msr_lo, msr_hi;\r\npr_debug("x86: %x, model: %x\n", c->x86, c->x86_model);\r\nif ((c->x86_vendor != X86_VENDOR_INTEL) ||\r\n((c->x86 != 6) && (c->x86 != 0xF)))\r\nreturn 0;\r\nif (c->x86 == 0xF) {\r\nif (c->x86_model != 2)\r\nreturn 0;\r\nebx = cpuid_ebx(0x00000001);\r\nebx &= 0x000000FF;\r\npr_debug("ebx value is %x, x86_mask is %x\n", ebx, c->x86_mask);\r\nswitch (c->x86_mask) {\r\ncase 4:\r\nif ((ebx == 0x0e) || (ebx == 0x0f))\r\nreturn SPEEDSTEP_CPU_P4M;\r\nbreak;\r\ncase 7:\r\nif (ebx == 0x0e)\r\nreturn SPEEDSTEP_CPU_P4M;\r\nbreak;\r\ncase 9:\r\nif ((ebx == 0x0e) ||\r\n(strstr(c->x86_model_id,\r\n"Mobile Intel(R) Pentium(R) 4") != NULL))\r\nreturn SPEEDSTEP_CPU_P4M;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nswitch (c->x86_model) {\r\ncase 0x0B:\r\nebx = cpuid_ebx(0x00000001);\r\npr_debug("ebx is %x\n", ebx);\r\nebx &= 0x000000FF;\r\nif (ebx != 0x06)\r\nreturn 0;\r\nreturn SPEEDSTEP_CPU_PIII_T;\r\ncase 0x08:\r\nrdmsr(MSR_IA32_EBL_CR_POWERON, msr_lo, msr_hi);\r\npr_debug("Coppermine: MSR_IA32_EBL_CR_POWERON is 0x%x, 0x%x\n",\r\nmsr_lo, msr_hi);\r\nmsr_lo &= 0x00c0000;\r\nif (msr_lo != 0x0080000)\r\nreturn 0;\r\nrdmsr(MSR_IA32_PLATFORM_ID, msr_lo, msr_hi);\r\npr_debug("Coppermine: MSR_IA32_PLATFORM ID is 0x%x, 0x%x\n",\r\nmsr_lo, msr_hi);\r\nif ((msr_hi & (1<<18)) &&\r\n(relaxed_check ? 1 : (msr_hi & (3<<24)))) {\r\nif (c->x86_mask == 0x01) {\r\npr_debug("early PIII version\n");\r\nreturn SPEEDSTEP_CPU_PIII_C_EARLY;\r\n} else\r\nreturn SPEEDSTEP_CPU_PIII_C;\r\n}\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nunsigned int speedstep_get_freqs(enum speedstep_processor processor,\r\nunsigned int *low_speed,\r\nunsigned int *high_speed,\r\nunsigned int *transition_latency,\r\nvoid (*set_state) (unsigned int state))\r\n{\r\nunsigned int prev_speed;\r\nunsigned int ret = 0;\r\nunsigned long flags;\r\nstruct timeval tv1, tv2;\r\nif ((!processor) || (!low_speed) || (!high_speed) || (!set_state))\r\nreturn -EINVAL;\r\npr_debug("trying to determine both speeds\n");\r\nprev_speed = speedstep_get_frequency(processor);\r\nif (!prev_speed)\r\nreturn -EIO;\r\npr_debug("previous speed is %u\n", prev_speed);\r\npreempt_disable();\r\nlocal_irq_save(flags);\r\nset_state(SPEEDSTEP_LOW);\r\n*low_speed = speedstep_get_frequency(processor);\r\nif (!*low_speed) {\r\nret = -EIO;\r\ngoto out;\r\n}\r\npr_debug("low speed is %u\n", *low_speed);\r\nif (transition_latency)\r\ndo_gettimeofday(&tv1);\r\nset_state(SPEEDSTEP_HIGH);\r\nif (transition_latency)\r\ndo_gettimeofday(&tv2);\r\n*high_speed = speedstep_get_frequency(processor);\r\nif (!*high_speed) {\r\nret = -EIO;\r\ngoto out;\r\n}\r\npr_debug("high speed is %u\n", *high_speed);\r\nif (*low_speed == *high_speed) {\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nif (*high_speed != prev_speed)\r\nset_state(SPEEDSTEP_LOW);\r\nif (transition_latency) {\r\n*transition_latency = (tv2.tv_sec - tv1.tv_sec) * USEC_PER_SEC +\r\ntv2.tv_usec - tv1.tv_usec;\r\npr_debug("transition latency is %u uSec\n", *transition_latency);\r\n*transition_latency *= 1200;\r\nif (*transition_latency > 10000000 ||\r\n*transition_latency < 50000) {\r\nprintk(KERN_WARNING PFX "frequency transition "\r\n"measured seems out of range (%u "\r\n"nSec), falling back to a safe one of"\r\n"%u nSec.\n",\r\n*transition_latency, 500000);\r\n*transition_latency = 500000;\r\n}\r\n}\r\nout:\r\nlocal_irq_restore(flags);\r\npreempt_enable();\r\nreturn ret;\r\n}

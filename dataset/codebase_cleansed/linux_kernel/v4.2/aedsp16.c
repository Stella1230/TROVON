static int __init aedsp16_wait_data(int port)\r\n{\r\nint loop = STATUSRETRY;\r\nunsigned char ret = 0;\r\nDBG1(("aedsp16_wait_data (0x%x): ", port));\r\ndo {\r\nret = inb(port + DSP_DATAVAIL);\r\n} while (!(ret & 0x80) && loop--);\r\nif (ret & 0x80) {\r\nDBG1(("success.\n"));\r\nreturn TRUE;\r\n}\r\nDBG1(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nstatic int __init aedsp16_read(int port)\r\n{\r\nint inbyte;\r\nDBG((" Read DSP Byte (0x%x): ", port));\r\nif (aedsp16_wait_data(port) == FALSE) {\r\nDBG(("failure.\n"));\r\nreturn -1;\r\n}\r\ninbyte = inb(port + DSP_READ);\r\nDBG(("read [0x%x]/{%c}.\n", inbyte, inbyte));\r\nreturn inbyte;\r\n}\r\nstatic int __init aedsp16_test_dsp(int port)\r\n{\r\nreturn ((aedsp16_read(port) == 0xaa) ? TRUE : FALSE);\r\n}\r\nstatic int __init aedsp16_dsp_reset(int port)\r\n{\r\nDBG(("Reset DSP:\n"));\r\noutb(1, (port + DSP_RESET));\r\nudelay(10);\r\noutb(0, (port + DSP_RESET));\r\nudelay(10);\r\nudelay(10);\r\nif (aedsp16_test_dsp(port) == TRUE) {\r\nDBG(("success.\n"));\r\nreturn TRUE;\r\n} else\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nstatic int __init aedsp16_write(int port, int cmd)\r\n{\r\nunsigned char ret;\r\nint loop = HARDRETRY;\r\nDBG((" Write DSP Byte (0x%x) [0x%x]: ", port, cmd));\r\ndo {\r\nret = inb(port + DSP_STATUS);\r\nif (!(ret & 0x80)) {\r\noutb(cmd, port + DSP_COMMAND);\r\nDBG(("success.\n"));\r\nreturn 0;\r\n}\r\n} while (loop--);\r\nDBG(("timeout.\n"));\r\nprintk("[AEDSP16] DSP Command (0x%x) timeout.\n", cmd);\r\nreturn -1;\r\n}\r\nvoid __init aedsp16_pinfo(void) {\r\nDBG(("\n Base address: %x\n", decoded_hcfg.iobase));\r\nDBG((" Joystick : %s present\n", decoded_hcfg.joystick?"":" not"));\r\nDBG((" WSS addr : %x\n", decoded_hcfg.wssbase));\r\nDBG((" MPU-401 addr: %x\n", decoded_hcfg.mpubase));\r\nDBG((" CDROM : %s present\n", (decoded_hcfg.cdrom!=4)?"":" not"));\r\nDBG((" CDROMADDR : %x\n\n", decoded_hcfg.cdrombase));\r\n}\r\nstatic void __init aedsp16_hard_decode(void) {\r\nDBG((" aedsp16_hard_decode: 0x%x, 0x%x\n", hard_cfg[0], hard_cfg[1]));\r\ndecoded_hcfg.iobase = IOBASE(hard_cfg[0]);\r\ndecoded_hcfg.joystick = JOY(hard_cfg[0]);\r\ndecoded_hcfg.wssbase = WSSADDR(hard_cfg[0]);\r\ndecoded_hcfg.mpubase = MPUADDR(hard_cfg[0]);\r\ndecoded_hcfg.cdrom = CDROM(hard_cfg[1]);\r\ndecoded_hcfg.cdrombase = CDROMADDR(hard_cfg[1]);\r\n#if defined(AEDSP16_INFO) || defined(AEDSP16_DEBUG)\r\nprintk(" Original sound card configuration:\n");\r\naedsp16_pinfo();\r\n#endif\r\ndecoded_hcfg.iobase = ae_config.base_io;\r\ndecoded_hcfg.wssbase = ae_config.mss_base;\r\ndecoded_hcfg.mpubase = ae_config.mpu_base;\r\n#if defined(CONFIG_SC6600_JOY)\r\ndecoded_hcfg.joystick = CONFIG_SC6600_JOY;\r\n#endif\r\n#if defined(CONFIG_SC6600_CDROM)\r\ndecoded_hcfg.cdrom = CONFIG_SC6600_CDROM;\r\n#endif\r\n#if defined(CONFIG_SC6600_CDROMBASE)\r\ndecoded_hcfg.cdrombase = CONFIG_SC6600_CDROMBASE;\r\n#endif\r\n#if defined(AEDSP16_DEBUG)\r\nDBG((" New Values:\n"));\r\naedsp16_pinfo();\r\n#endif\r\nDBG(("success.\n"));\r\n}\r\nstatic void __init aedsp16_hard_encode(void) {\r\nDBG((" aedsp16_hard_encode: 0x%x, 0x%x\n", hard_cfg[0], hard_cfg[1]));\r\nhard_cfg[0] = 0;\r\nhard_cfg[1] = 0;\r\nhard_cfg[0] |= 0x20;\r\nBLDIOBASE (hard_cfg[0], decoded_hcfg.iobase);\r\nBLDWSSADDR(hard_cfg[0], decoded_hcfg.wssbase);\r\nBLDMPUADDR(hard_cfg[0], decoded_hcfg.mpubase);\r\nBLDJOY(hard_cfg[0], decoded_hcfg.joystick);\r\nBLDCDROM(hard_cfg[1], decoded_hcfg.cdrom);\r\nBLDCDROMADDR(hard_cfg[1], decoded_hcfg.cdrombase);\r\n#if defined(AEDSP16_DEBUG)\r\naedsp16_pinfo();\r\n#endif\r\nDBG((" aedsp16_hard_encode: 0x%x, 0x%x\n", hard_cfg[0], hard_cfg[1]));\r\nDBG(("success.\n"));\r\n}\r\nstatic int __init aedsp16_hard_write(int port) {\r\nDBG(("aedsp16_hard_write:\n"));\r\nif (aedsp16_write(port, COMMAND_6C)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_6C);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, COMMAND_5C)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_5C);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, hard_cfg[0])) {\r\nprintk("[AEDSP16] DATA 0x%x: failed!\n", hard_cfg[0]);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, hard_cfg[1])) {\r\nprintk("[AEDSP16] DATA 0x%x: failed!\n", hard_cfg[1]);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, COMMAND_C5)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_C5);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nDBG(("success.\n"));\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_hard_read(int port) {\r\nDBG(("aedsp16_hard_read:\n"));\r\nif (aedsp16_write(port, READ_HARD_CFG)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", READ_HARD_CFG);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nif ((hard_cfg[0] = aedsp16_read(port)) == -1) {\r\nprintk("[AEDSP16] aedsp16_read after CMD 0x%x: failed\n",\r\nREAD_HARD_CFG);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nif ((hard_cfg[1] = aedsp16_read(port)) == -1) {\r\nprintk("[AEDSP16] aedsp16_read after CMD 0x%x: failed\n",\r\nREAD_HARD_CFG);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nif (aedsp16_read(port) == -1) {\r\nprintk("[AEDSP16] aedsp16_read after CMD 0x%x: failed\n",\r\nREAD_HARD_CFG);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nDBG(("success.\n"));\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_ext_cfg_write(int port) {\r\nint extcfg, val;\r\nif (aedsp16_write(port, COMMAND_66)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_66);\r\nreturn FALSE;\r\n}\r\nextcfg = 7;\r\nif (decoded_hcfg.cdrom != 2)\r\nextcfg = 0x0F;\r\nif ((decoded_hcfg.cdrom == 4) ||\r\n(decoded_hcfg.cdrom == 3))\r\nextcfg &= ~2;\r\nif (decoded_hcfg.cdrombase == 0)\r\nextcfg &= ~2;\r\nif (decoded_hcfg.mpubase == 0)\r\nextcfg &= ~1;\r\nif (aedsp16_write(port, extcfg)) {\r\nprintk("[AEDSP16] Write extcfg: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, 0)) {\r\nprintk("[AEDSP16] Write extcfg: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (decoded_hcfg.cdrom == 3) {\r\nif (aedsp16_write(port, COMMAND_52)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_52);\r\nreturn FALSE;\r\n}\r\nif ((val = aedsp16_read(port)) == -1) {\r\nprintk("[AEDSP16] aedsp16_read after CMD 0x%x: failed\n"\r\n, COMMAND_52);\r\nreturn FALSE;\r\n}\r\nval &= 0x7F;\r\nif (aedsp16_write(port, COMMAND_60)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_60);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, val)) {\r\nprintk("[AEDSP16] Write val: failed!\n");\r\nreturn FALSE;\r\n}\r\n}\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_cfg_write(int port) {\r\nif (aedsp16_write(port, WRITE_MDIRQ_CFG)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", WRITE_MDIRQ_CFG);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, soft_cfg)) {\r\nprintk("[AEDSP16] Initialization of (M)IRQ and DMA: failed!\n");\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_init_mss(int port)\r\n{\r\nDBG(("aedsp16_init_mss:\n"));\r\nmdelay(10);\r\nif (aedsp16_write(port, DSP_INIT_MSS)) {\r\nprintk("[AEDSP16] aedsp16_init_mss [0x%x]: failed!\n",\r\nDSP_INIT_MSS);\r\nDBG(("failure.\n"));\r\nreturn FALSE;\r\n}\r\nmdelay(10);\r\nif (aedsp16_cfg_write(port) == FALSE)\r\nreturn FALSE;\r\noutb(soft_cfg_mss, ae_config.mss_base);\r\nDBG(("success.\n"));\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_setup_board(int port) {\r\nint loop = RETRY;\r\n#if defined(CONFIG_SC6600)\r\nint val = 0;\r\nif (aedsp16_hard_read(port) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_hard_read: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, COMMAND_52)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_52);\r\nreturn FALSE;\r\n}\r\nif ((val = aedsp16_read(port)) == -1) {\r\nprintk("[AEDSP16] aedsp16_read after CMD 0x%x: failed\n",\r\nCOMMAND_52);\r\nreturn FALSE;\r\n}\r\n#endif\r\ndo {\r\nif (aedsp16_write(port, COMMAND_88)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_88);\r\nreturn FALSE;\r\n}\r\nmdelay(10);\r\n} while ((aedsp16_wait_data(port) == FALSE) && loop--);\r\nif (aedsp16_read(port) == -1) {\r\nprintk("[AEDSP16] aedsp16_read after CMD 0x%x: failed\n",\r\nCOMMAND_88);\r\nreturn FALSE;\r\n}\r\n#if !defined(CONFIG_SC6600)\r\nif (aedsp16_write(port, COMMAND_5C)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_5C);\r\nreturn FALSE;\r\n}\r\n#endif\r\nif (aedsp16_cfg_write(port) == FALSE)\r\nreturn FALSE;\r\n#if defined(CONFIG_SC6600)\r\nif (aedsp16_write(port, COMMAND_60)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_60);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, val)) {\r\nprintk("[AEDSP16] DATA 0x%x: failed!\n", val);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, COMMAND_6E)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_6E);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, ver[0])) {\r\nprintk("[AEDSP16] DATA 0x%x: failed!\n", ver[0]);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, ver[1])) {\r\nprintk("[AEDSP16] DATA 0x%x: failed!\n", ver[1]);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_hard_write(port) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_hard_write: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, COMMAND_5C)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", COMMAND_5C);\r\nreturn FALSE;\r\n}\r\n#if defined(THIS_IS_A_THING_I_HAVE_NOT_TESTED_YET)\r\nif (aedsp16_cfg_write(port) == FALSE)\r\nreturn FALSE;\r\n#endif\r\n#endif\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_stdcfg(int port) {\r\nif (aedsp16_write(port, WRITE_MDIRQ_CFG)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", WRITE_MDIRQ_CFG);\r\nreturn FALSE;\r\n}\r\nif (aedsp16_write(port, 0x0A)) {\r\nprintk("[AEDSP16] aedsp16_stdcfg: failed!\n");\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_dsp_version(int port)\r\n{\r\nint len = 0;\r\nint ret;\r\nDBG(("Get DSP Version:\n"));\r\nif (aedsp16_write(ae_config.base_io, GET_DSP_VERSION)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", GET_DSP_VERSION);\r\nDBG(("failed.\n"));\r\nreturn FALSE;\r\n}\r\ndo {\r\nif ((ret = aedsp16_read(port)) == -1) {\r\nDBG(("failed.\n"));\r\nreturn FALSE;\r\n}\r\nver[len++] = ret;\r\n} while (len < CARDVERDIGITS);\r\nsprintf(DSPVersion, "%d.%d", ver[0], ver[1]);\r\nDBG(("success.\n"));\r\nreturn TRUE;\r\n}\r\nstatic int __init aedsp16_dsp_copyright(int port)\r\n{\r\nint len = 0;\r\nint ret;\r\nDBG(("Get DSP Copyright:\n"));\r\nif (aedsp16_write(ae_config.base_io, GET_DSP_COPYRIGHT)) {\r\nprintk("[AEDSP16] CMD 0x%x: failed!\n", GET_DSP_COPYRIGHT);\r\nDBG(("failed.\n"));\r\nreturn FALSE;\r\n}\r\ndo {\r\nif ((ret = aedsp16_read(port)) == -1) {\r\nif (len)\r\nbreak;\r\nelse {\r\nDBG(("failed.\n"));\r\nreturn FALSE;\r\n}\r\n}\r\nDSPCopyright[len++] = ret;\r\n} while (len < CARDNAMELEN);\r\nDBG(("success.\n"));\r\nreturn TRUE;\r\n}\r\nstatic void __init aedsp16_init_tables(void)\r\n{\r\nint i = 0;\r\nmemset(DSPCopyright, 0, CARDNAMELEN + 1);\r\nmemset(DSPVersion, 0, CARDVERLEN + 1);\r\nfor (i = 0; orIRQ[i].or; i++)\r\nif (orIRQ[i].val == ae_config.irq) {\r\nsoft_cfg |= orIRQ[i].or;\r\nsoft_cfg_mss |= orIRQ[i].or;\r\n}\r\nfor (i = 0; orMIRQ[i].or; i++)\r\nif (orMIRQ[i].or == ae_config.mpu_irq)\r\nsoft_cfg |= orMIRQ[i].or;\r\nfor (i = 0; orDMA[i].or; i++)\r\nif (orDMA[i].val == ae_config.dma) {\r\nsoft_cfg |= orDMA[i].or;\r\nsoft_cfg_mss |= orDMA[i].or;\r\n}\r\n}\r\nstatic int __init aedsp16_init_board(void)\r\n{\r\naedsp16_init_tables();\r\nif (aedsp16_dsp_reset(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_dsp_reset: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (aedsp16_dsp_copyright(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_dsp_copyright: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (strcmp("SC-6000", DSPCopyright))\r\nprintk("[AEDSP16] Warning: non SC-6000 audio card!\n");\r\nif (aedsp16_dsp_version(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_dsp_version: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (aedsp16_stdcfg(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_stdcfg: failed!\n");\r\nreturn FALSE;\r\n}\r\n#if defined(CONFIG_SC6600)\r\nif (aedsp16_hard_read(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_hard_read: failed!\n");\r\nreturn FALSE;\r\n}\r\naedsp16_hard_decode();\r\naedsp16_hard_encode();\r\nif (aedsp16_hard_write(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_hard_write: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (aedsp16_ext_cfg_write(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_ext_cfg_write: failed!\n");\r\nreturn FALSE;\r\n}\r\n#endif\r\nif (aedsp16_setup_board(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] aedsp16_setup_board: failed!\n");\r\nreturn FALSE;\r\n}\r\nif (ae_config.mss_base != -1) {\r\nif (ae_config.init & INIT_MSS) {\r\nif (aedsp16_init_mss(ae_config.base_io) == FALSE) {\r\nprintk("[AEDSP16] Can not initialize"\r\n"Microsoft Sound System mode.\n");\r\nreturn FALSE;\r\n}\r\n}\r\n}\r\n#if !defined(MODULE) || defined(AEDSP16_INFO) || defined(AEDSP16_DEBUG)\r\nprintk("Audio Excel DSP 16 init v%s (%s %s) [",\r\nVERSION, DSPCopyright,\r\nDSPVersion);\r\nif (ae_config.mpu_base != -1) {\r\nif (ae_config.init & INIT_MPU401) {\r\nprintk("MPU401");\r\nif ((ae_config.init & INIT_MSS) ||\r\n(ae_config.init & INIT_SBPRO))\r\nprintk(" ");\r\n}\r\n}\r\nif (ae_config.mss_base == -1) {\r\nif (ae_config.init & INIT_SBPRO) {\r\nprintk("SBPro");\r\nif (ae_config.init & INIT_MSS)\r\nprintk(" ");\r\n}\r\n}\r\nif (ae_config.mss_base != -1)\r\nif (ae_config.init & INIT_MSS)\r\nprintk("MSS");\r\nprintk("]\n");\r\n#endif\r\nmdelay(10);\r\nreturn TRUE;\r\n}\r\nstatic int __init init_aedsp16_sb(void)\r\n{\r\nDBG(("init_aedsp16_sb: "));\r\nif (ae_config.init & INIT_MSS)\r\nreturn FALSE;\r\nif (ae_config.init & INIT_SBPRO)\r\nreturn FALSE;\r\nae_config.init |= INIT_SBPRO;\r\nDBG(("done.\n"));\r\nreturn TRUE;\r\n}\r\nstatic void uninit_aedsp16_sb(void)\r\n{\r\nDBG(("uninit_aedsp16_sb: "));\r\nae_config.init &= ~INIT_SBPRO;\r\nDBG(("done.\n"));\r\n}\r\nstatic int __init init_aedsp16_mss(void)\r\n{\r\nDBG(("init_aedsp16_mss: "));\r\nif (ae_config.init & INIT_SBPRO)\r\nreturn FALSE;\r\nif (ae_config.init & INIT_MSS)\r\nreturn FALSE;\r\nif (!(ae_config.init & INIT_MPU401)) {\r\nif (!request_region(ae_config.base_io, IOBASE_REGION_SIZE,\r\n"aedsp16 (base)")) {\r\nprintk(\r\n"AEDSP16 BASE I/O port region is already in use.\n");\r\nreturn FALSE;\r\n}\r\n}\r\nae_config.init |= INIT_MSS;\r\nDBG(("done.\n"));\r\nreturn TRUE;\r\n}\r\nstatic void uninit_aedsp16_mss(void)\r\n{\r\nDBG(("uninit_aedsp16_mss: "));\r\nif ((!(ae_config.init & INIT_MPU401)) &&\r\n(ae_config.init & INIT_MSS)) {\r\nrelease_region(ae_config.base_io, IOBASE_REGION_SIZE);\r\nDBG(("AEDSP16 base region released.\n"));\r\n}\r\nae_config.init &= ~INIT_MSS;\r\nDBG(("done.\n"));\r\n}\r\nstatic int __init init_aedsp16_mpu(void)\r\n{\r\nDBG(("init_aedsp16_mpu: "));\r\nif (ae_config.init & INIT_MPU401)\r\nreturn FALSE;\r\nif (!(ae_config.init & (INIT_MSS | INIT_SBPRO))) {\r\nif (!request_region(ae_config.base_io, IOBASE_REGION_SIZE,\r\n"aedsp16 (base)")) {\r\nprintk(\r\n"AEDSP16 BASE I/O port region is already in use.\n");\r\nreturn FALSE;\r\n}\r\n}\r\nae_config.init |= INIT_MPU401;\r\nDBG(("done.\n"));\r\nreturn TRUE;\r\n}\r\nstatic void uninit_aedsp16_mpu(void)\r\n{\r\nDBG(("uninit_aedsp16_mpu: "));\r\nif ((!(ae_config.init & (INIT_MSS | INIT_SBPRO))) &&\r\n(ae_config.init & INIT_MPU401)) {\r\nrelease_region(ae_config.base_io, IOBASE_REGION_SIZE);\r\nDBG(("AEDSP16 base region released.\n"));\r\n}\r\nae_config.init &= ~INIT_MPU401;\r\nDBG(("done.\n"));\r\n}\r\nstatic int __init init_aedsp16(void)\r\n{\r\nint initialized = FALSE;\r\nDBG(("Initializing BASE[0x%x] IRQ[%d] DMA[%d] MIRQ[%d]\n",\r\nae_config.base_io,ae_config.irq,ae_config.dma,ae_config.mpu_irq));\r\nif (ae_config.mss_base == -1) {\r\nif (init_aedsp16_sb() == FALSE) {\r\nuninit_aedsp16_sb();\r\n} else {\r\ninitialized = TRUE;\r\n}\r\n}\r\nif (ae_config.mpu_base != -1) {\r\nif (init_aedsp16_mpu() == FALSE) {\r\nuninit_aedsp16_mpu();\r\n} else {\r\ninitialized = TRUE;\r\n}\r\n}\r\nif (ae_config.mss_base != -1) {\r\nif (init_aedsp16_mss() == FALSE) {\r\nuninit_aedsp16_mss();\r\n} else {\r\ninitialized = TRUE;\r\n}\r\n}\r\nif (initialized)\r\ninitialized = aedsp16_init_board();\r\nreturn initialized;\r\n}\r\nstatic void __exit uninit_aedsp16(void)\r\n{\r\nif (ae_config.mss_base != -1)\r\nuninit_aedsp16_mss();\r\nelse\r\nuninit_aedsp16_sb();\r\nif (ae_config.mpu_base != -1)\r\nuninit_aedsp16_mpu();\r\n}\r\nstatic int __init do_init_aedsp16(void) {\r\nprintk("Audio Excel DSP 16 init driver Copyright (C) Riccardo Facchetti 1995-98\n");\r\nif (io == -1 || dma == -1 || irq == -1) {\r\nprintk(KERN_INFO "aedsp16: I/O, IRQ and DMA are mandatory\n");\r\nreturn -EINVAL;\r\n}\r\nae_config.base_io = io;\r\nae_config.irq = irq;\r\nae_config.dma = dma;\r\nae_config.mss_base = mss_base;\r\nae_config.mpu_base = mpu_base;\r\nae_config.mpu_irq = mpu_irq;\r\nif (init_aedsp16() == FALSE) {\r\nprintk(KERN_ERR "aedsp16: initialization failed\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit cleanup_aedsp16(void) {\r\nuninit_aedsp16();\r\n}\r\nstatic int __init setup_aedsp16(char *str)\r\n{\r\nint ints[7];\r\nstr = get_options(str, ARRAY_SIZE(ints), ints);\r\nio = ints[1];\r\nirq = ints[2];\r\ndma = ints[3];\r\nmss_base = ints[4];\r\nmpu_base = ints[5];\r\nmpu_irq = ints[6];\r\nreturn 1;\r\n}

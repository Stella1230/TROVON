static bool __init pcpu_need_numa(void)\r\n{\r\n#ifdef CONFIG_NEED_MULTIPLE_NODES\r\npg_data_t *last = NULL;\r\nunsigned int cpu;\r\nfor_each_possible_cpu(cpu) {\r\nint node = early_cpu_to_node(cpu);\r\nif (node_online(node) && NODE_DATA(node) &&\r\nlast && last != NODE_DATA(node))\r\nreturn true;\r\nlast = NODE_DATA(node);\r\n}\r\n#endif\r\nreturn false;\r\n}\r\nstatic void * __init pcpu_alloc_bootmem(unsigned int cpu, unsigned long size,\r\nunsigned long align)\r\n{\r\nconst unsigned long goal = __pa(MAX_DMA_ADDRESS);\r\n#ifdef CONFIG_NEED_MULTIPLE_NODES\r\nint node = early_cpu_to_node(cpu);\r\nvoid *ptr;\r\nif (!node_online(node) || !NODE_DATA(node)) {\r\nptr = __alloc_bootmem_nopanic(size, align, goal);\r\npr_info("cpu %d has no node %d or node-local memory\n",\r\ncpu, node);\r\npr_debug("per cpu data for cpu%d %lu bytes at %016lx\n",\r\ncpu, size, __pa(ptr));\r\n} else {\r\nptr = __alloc_bootmem_node_nopanic(NODE_DATA(node),\r\nsize, align, goal);\r\npr_debug("per cpu data for cpu%d %lu bytes on node%d at %016lx\n",\r\ncpu, size, node, __pa(ptr));\r\n}\r\nreturn ptr;\r\n#else\r\nreturn __alloc_bootmem_nopanic(size, align, goal);\r\n#endif\r\n}\r\nstatic void * __init pcpu_fc_alloc(unsigned int cpu, size_t size, size_t align)\r\n{\r\nreturn pcpu_alloc_bootmem(cpu, size, align);\r\n}\r\nstatic void __init pcpu_fc_free(void *ptr, size_t size)\r\n{\r\nfree_bootmem(__pa(ptr), size);\r\n}\r\nstatic int __init pcpu_cpu_distance(unsigned int from, unsigned int to)\r\n{\r\n#ifdef CONFIG_NEED_MULTIPLE_NODES\r\nif (early_cpu_to_node(from) == early_cpu_to_node(to))\r\nreturn LOCAL_DISTANCE;\r\nelse\r\nreturn REMOTE_DISTANCE;\r\n#else\r\nreturn LOCAL_DISTANCE;\r\n#endif\r\n}\r\nstatic void __init pcpup_populate_pte(unsigned long addr)\r\n{\r\npopulate_extra_pte(addr);\r\n}\r\nstatic inline void setup_percpu_segment(int cpu)\r\n{\r\n#ifdef CONFIG_X86_32\r\nstruct desc_struct gdt;\r\npack_descriptor(&gdt, per_cpu_offset(cpu), 0xFFFFF,\r\n0x2 | DESCTYPE_S, 0x8);\r\ngdt.s = 1;\r\nwrite_gdt_entry(get_cpu_gdt_table(cpu),\r\nGDT_ENTRY_PERCPU, &gdt, DESCTYPE_S);\r\n#endif\r\n}\r\nvoid __init setup_per_cpu_areas(void)\r\n{\r\nunsigned int cpu;\r\nunsigned long delta;\r\nint rc;\r\npr_info("NR_CPUS:%d nr_cpumask_bits:%d nr_cpu_ids:%d nr_node_ids:%d\n",\r\nNR_CPUS, nr_cpumask_bits, nr_cpu_ids, nr_node_ids);\r\n#ifdef CONFIG_X86_32\r\nif (pcpu_chosen_fc == PCPU_FC_AUTO && pcpu_need_numa())\r\npcpu_chosen_fc = PCPU_FC_PAGE;\r\n#endif\r\nrc = -EINVAL;\r\nif (pcpu_chosen_fc != PCPU_FC_PAGE) {\r\nconst size_t dyn_size = PERCPU_MODULE_RESERVE +\r\nPERCPU_DYNAMIC_RESERVE - PERCPU_FIRST_CHUNK_RESERVE;\r\nsize_t atom_size;\r\n#ifdef CONFIG_X86_64\r\natom_size = PMD_SIZE;\r\n#else\r\natom_size = PAGE_SIZE;\r\n#endif\r\nrc = pcpu_embed_first_chunk(PERCPU_FIRST_CHUNK_RESERVE,\r\ndyn_size, atom_size,\r\npcpu_cpu_distance,\r\npcpu_fc_alloc, pcpu_fc_free);\r\nif (rc < 0)\r\npr_warning("%s allocator failed (%d), falling back to page size\n",\r\npcpu_fc_names[pcpu_chosen_fc], rc);\r\n}\r\nif (rc < 0)\r\nrc = pcpu_page_first_chunk(PERCPU_FIRST_CHUNK_RESERVE,\r\npcpu_fc_alloc, pcpu_fc_free,\r\npcpup_populate_pte);\r\nif (rc < 0)\r\npanic("cannot initialize percpu area (err=%d)", rc);\r\ndelta = (unsigned long)pcpu_base_addr - (unsigned long)__per_cpu_start;\r\nfor_each_possible_cpu(cpu) {\r\nper_cpu_offset(cpu) = delta + pcpu_unit_offsets[cpu];\r\nper_cpu(this_cpu_off, cpu) = per_cpu_offset(cpu);\r\nper_cpu(cpu_number, cpu) = cpu;\r\nsetup_percpu_segment(cpu);\r\nsetup_stack_canary_segment(cpu);\r\n#ifdef CONFIG_X86_LOCAL_APIC\r\nper_cpu(x86_cpu_to_apicid, cpu) =\r\nearly_per_cpu_map(x86_cpu_to_apicid, cpu);\r\nper_cpu(x86_bios_cpu_apicid, cpu) =\r\nearly_per_cpu_map(x86_bios_cpu_apicid, cpu);\r\n#endif\r\n#ifdef CONFIG_X86_32\r\nper_cpu(x86_cpu_to_logical_apicid, cpu) =\r\nearly_per_cpu_map(x86_cpu_to_logical_apicid, cpu);\r\n#endif\r\n#ifdef CONFIG_X86_64\r\nper_cpu(irq_stack_ptr, cpu) =\r\nper_cpu(irq_stack_union.irq_stack, cpu) +\r\nIRQ_STACK_SIZE - 64;\r\n#endif\r\n#ifdef CONFIG_NUMA\r\nper_cpu(x86_cpu_to_node_map, cpu) =\r\nearly_per_cpu_map(x86_cpu_to_node_map, cpu);\r\nset_cpu_numa_node(cpu, early_cpu_to_node(cpu));\r\n#endif\r\nif (!cpu)\r\nswitch_to_new_gdt(cpu);\r\n}\r\n#ifdef CONFIG_X86_LOCAL_APIC\r\nearly_per_cpu_ptr(x86_cpu_to_apicid) = NULL;\r\nearly_per_cpu_ptr(x86_bios_cpu_apicid) = NULL;\r\n#endif\r\n#ifdef CONFIG_X86_32\r\nearly_per_cpu_ptr(x86_cpu_to_logical_apicid) = NULL;\r\n#endif\r\n#ifdef CONFIG_NUMA\r\nearly_per_cpu_ptr(x86_cpu_to_node_map) = NULL;\r\n#endif\r\nsetup_node_to_cpumask_map();\r\nsetup_cpu_local_masks();\r\n}

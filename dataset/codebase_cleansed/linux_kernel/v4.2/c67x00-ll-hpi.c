static inline u16 hpi_read_reg(struct c67x00_device *dev, int reg)\r\n{\r\nndelay(HPI_T_CYC_NS);\r\nreturn __raw_readw(dev->hpi.base + reg * dev->hpi.regstep);\r\n}\r\nstatic inline void hpi_write_reg(struct c67x00_device *dev, int reg, u16 value)\r\n{\r\nndelay(HPI_T_CYC_NS);\r\n__raw_writew(value, dev->hpi.base + reg * dev->hpi.regstep);\r\n}\r\nstatic inline u16 hpi_read_word_nolock(struct c67x00_device *dev, u16 reg)\r\n{\r\nhpi_write_reg(dev, HPI_ADDR, reg);\r\nreturn hpi_read_reg(dev, HPI_DATA);\r\n}\r\nstatic u16 hpi_read_word(struct c67x00_device *dev, u16 reg)\r\n{\r\nu16 value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nvalue = hpi_read_word_nolock(dev, reg);\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\nreturn value;\r\n}\r\nstatic void hpi_write_word_nolock(struct c67x00_device *dev, u16 reg, u16 value)\r\n{\r\nhpi_write_reg(dev, HPI_ADDR, reg);\r\nhpi_write_reg(dev, HPI_DATA, value);\r\n}\r\nstatic void hpi_write_word(struct c67x00_device *dev, u16 reg, u16 value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nhpi_write_word_nolock(dev, reg, value);\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\n}\r\nstatic void hpi_write_words_le16(struct c67x00_device *dev, u16 addr,\r\n__le16 *data, u16 count)\r\n{\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nhpi_write_reg(dev, HPI_ADDR, addr);\r\nfor (i = 0; i < count; i++)\r\nhpi_write_reg(dev, HPI_DATA, le16_to_cpu(*data++));\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\n}\r\nstatic void hpi_read_words_le16(struct c67x00_device *dev, u16 addr,\r\n__le16 *data, u16 count)\r\n{\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nhpi_write_reg(dev, HPI_ADDR, addr);\r\nfor (i = 0; i < count; i++)\r\n*data++ = cpu_to_le16(hpi_read_reg(dev, HPI_DATA));\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\n}\r\nstatic void hpi_set_bits(struct c67x00_device *dev, u16 reg, u16 mask)\r\n{\r\nu16 value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nvalue = hpi_read_word_nolock(dev, reg);\r\nhpi_write_word_nolock(dev, reg, value | mask);\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\n}\r\nstatic void hpi_clear_bits(struct c67x00_device *dev, u16 reg, u16 mask)\r\n{\r\nu16 value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nvalue = hpi_read_word_nolock(dev, reg);\r\nhpi_write_word_nolock(dev, reg, value & ~mask);\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\n}\r\nstatic u16 hpi_recv_mbox(struct c67x00_device *dev)\r\n{\r\nu16 value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nvalue = hpi_read_reg(dev, HPI_MAILBOX);\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\nreturn value;\r\n}\r\nstatic u16 hpi_send_mbox(struct c67x00_device *dev, u16 value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nhpi_write_reg(dev, HPI_MAILBOX, value);\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\nreturn value;\r\n}\r\nu16 c67x00_ll_hpi_status(struct c67x00_device *dev)\r\n{\r\nu16 value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->hpi.lock, flags);\r\nvalue = hpi_read_reg(dev, HPI_STATUS);\r\nspin_unlock_irqrestore(&dev->hpi.lock, flags);\r\nreturn value;\r\n}\r\nvoid c67x00_ll_hpi_reg_init(struct c67x00_device *dev)\r\n{\r\nint i;\r\nhpi_recv_mbox(dev);\r\nc67x00_ll_hpi_status(dev);\r\nhpi_write_word(dev, HPI_IRQ_ROUTING_REG, 0);\r\nfor (i = 0; i < C67X00_SIES; i++) {\r\nhpi_write_word(dev, SIEMSG_REG(i), 0);\r\nhpi_read_word(dev, SIEMSG_REG(i));\r\n}\r\n}\r\nvoid c67x00_ll_hpi_enable_sofeop(struct c67x00_sie *sie)\r\n{\r\nhpi_set_bits(sie->dev, HPI_IRQ_ROUTING_REG,\r\nSOFEOP_TO_HPI_EN(sie->sie_num));\r\n}\r\nvoid c67x00_ll_hpi_disable_sofeop(struct c67x00_sie *sie)\r\n{\r\nhpi_clear_bits(sie->dev, HPI_IRQ_ROUTING_REG,\r\nSOFEOP_TO_HPI_EN(sie->sie_num));\r\n}\r\nstatic inline int ll_recv_msg(struct c67x00_device *dev)\r\n{\r\nu16 res;\r\nres = wait_for_completion_timeout(&dev->hpi.lcp.msg_received, 5 * HZ);\r\nWARN_ON(!res);\r\nreturn (res == 0) ? -EIO : 0;\r\n}\r\nu16 c67x00_ll_fetch_siemsg(struct c67x00_device *dev, int sie_num)\r\n{\r\nu16 val;\r\nval = hpi_read_word(dev, SIEMSG_REG(sie_num));\r\nhpi_write_word(dev, SIEMSG_REG(sie_num), 0);\r\nreturn val;\r\n}\r\nu16 c67x00_ll_get_usb_ctl(struct c67x00_sie *sie)\r\n{\r\nreturn hpi_read_word(sie->dev, USB_CTL_REG(sie->sie_num));\r\n}\r\nvoid c67x00_ll_usb_clear_status(struct c67x00_sie *sie, u16 bits)\r\n{\r\nhpi_write_word(sie->dev, USB_STAT_REG(sie->sie_num), bits);\r\n}\r\nu16 c67x00_ll_usb_get_status(struct c67x00_sie *sie)\r\n{\r\nreturn hpi_read_word(sie->dev, USB_STAT_REG(sie->sie_num));\r\n}\r\nstatic int c67x00_comm_exec_int(struct c67x00_device *dev, u16 nr,\r\nstruct c67x00_lcp_int_data *data)\r\n{\r\nint i, rc;\r\nmutex_lock(&dev->hpi.lcp.mutex);\r\nhpi_write_word(dev, COMM_INT_NUM, nr);\r\nfor (i = 0; i < COMM_REGS; i++)\r\nhpi_write_word(dev, COMM_R(i), data->regs[i]);\r\nhpi_send_mbox(dev, COMM_EXEC_INT);\r\nrc = ll_recv_msg(dev);\r\nmutex_unlock(&dev->hpi.lcp.mutex);\r\nreturn rc;\r\n}\r\nvoid c67x00_ll_set_husb_eot(struct c67x00_device *dev, u16 value)\r\n{\r\nmutex_lock(&dev->hpi.lcp.mutex);\r\nhpi_write_word(dev, HUSB_pEOT, value);\r\nmutex_unlock(&dev->hpi.lcp.mutex);\r\n}\r\nstatic inline void c67x00_ll_husb_sie_init(struct c67x00_sie *sie)\r\n{\r\nstruct c67x00_device *dev = sie->dev;\r\nstruct c67x00_lcp_int_data data;\r\nint rc;\r\nrc = c67x00_comm_exec_int(dev, HUSB_SIE_INIT_INT(sie->sie_num), &data);\r\nBUG_ON(rc);\r\n}\r\nvoid c67x00_ll_husb_reset(struct c67x00_sie *sie, int port)\r\n{\r\nstruct c67x00_device *dev = sie->dev;\r\nstruct c67x00_lcp_int_data data;\r\nint rc;\r\ndata.regs[0] = 50;\r\ndata.regs[1] = port | (sie->sie_num << 1);\r\nrc = c67x00_comm_exec_int(dev, HUSB_RESET_INT, &data);\r\nBUG_ON(rc);\r\n}\r\nvoid c67x00_ll_husb_set_current_td(struct c67x00_sie *sie, u16 addr)\r\n{\r\nhpi_write_word(sie->dev, HUSB_SIE_pCurrentTDPtr(sie->sie_num), addr);\r\n}\r\nu16 c67x00_ll_husb_get_current_td(struct c67x00_sie *sie)\r\n{\r\nreturn hpi_read_word(sie->dev, HUSB_SIE_pCurrentTDPtr(sie->sie_num));\r\n}\r\nu16 c67x00_ll_husb_get_frame(struct c67x00_sie *sie)\r\n{\r\nreturn hpi_read_word(sie->dev, HOST_FRAME_REG(sie->sie_num));\r\n}\r\nvoid c67x00_ll_husb_init_host_port(struct c67x00_sie *sie)\r\n{\r\nhpi_set_bits(sie->dev, USB_CTL_REG(sie->sie_num), HOST_MODE);\r\nc67x00_ll_husb_sie_init(sie);\r\nc67x00_ll_usb_clear_status(sie, HOST_STAT_MASK);\r\nif (!(hpi_read_word(sie->dev, USB_CTL_REG(sie->sie_num)) & HOST_MODE))\r\ndev_warn(sie_dev(sie),\r\n"SIE %d not set to host mode\n", sie->sie_num);\r\n}\r\nvoid c67x00_ll_husb_reset_port(struct c67x00_sie *sie, int port)\r\n{\r\nc67x00_ll_usb_clear_status(sie, PORT_CONNECT_CHANGE(port));\r\nhpi_set_bits(sie->dev, HPI_IRQ_ROUTING_REG,\r\nSOFEOP_TO_CPU_EN(sie->sie_num));\r\nhpi_set_bits(sie->dev, HOST_IRQ_EN_REG(sie->sie_num),\r\nSOF_EOP_IRQ_EN | DONE_IRQ_EN);\r\nhpi_set_bits(sie->dev, USB_CTL_REG(sie->sie_num), PORT_RES_EN(port));\r\n}\r\nvoid c67x00_ll_irq(struct c67x00_device *dev, u16 int_status)\r\n{\r\nif ((int_status & MBX_OUT_FLG) == 0)\r\nreturn;\r\ndev->hpi.lcp.last_msg = hpi_recv_mbox(dev);\r\ncomplete(&dev->hpi.lcp.msg_received);\r\n}\r\nint c67x00_ll_reset(struct c67x00_device *dev)\r\n{\r\nint rc;\r\nmutex_lock(&dev->hpi.lcp.mutex);\r\nhpi_send_mbox(dev, COMM_RESET);\r\nrc = ll_recv_msg(dev);\r\nmutex_unlock(&dev->hpi.lcp.mutex);\r\nreturn rc;\r\n}\r\nvoid c67x00_ll_write_mem_le16(struct c67x00_device *dev, u16 addr,\r\nvoid *data, int len)\r\n{\r\nu8 *buf = data;\r\nif (addr + len > 0xffff) {\r\ndev_err(&dev->pdev->dev,\r\n"Trying to write beyond writable region!\n");\r\nreturn;\r\n}\r\nif (addr & 0x01) {\r\nu16 tmp;\r\ntmp = hpi_read_word(dev, addr - 1);\r\ntmp = (tmp & 0x00ff) | (*buf++ << 8);\r\nhpi_write_word(dev, addr - 1, tmp);\r\naddr++;\r\nlen--;\r\n}\r\nhpi_write_words_le16(dev, addr, (__le16 *)buf, len / 2);\r\nbuf += len & ~0x01;\r\naddr += len & ~0x01;\r\nlen &= 0x01;\r\nif (len) {\r\nu16 tmp;\r\ntmp = hpi_read_word(dev, addr);\r\ntmp = (tmp & 0xff00) | *buf;\r\nhpi_write_word(dev, addr, tmp);\r\n}\r\n}\r\nvoid c67x00_ll_read_mem_le16(struct c67x00_device *dev, u16 addr,\r\nvoid *data, int len)\r\n{\r\nu8 *buf = data;\r\nif (addr & 0x01) {\r\nu16 tmp;\r\ntmp = hpi_read_word(dev, addr - 1);\r\n*buf++ = (tmp >> 8) & 0x00ff;\r\naddr++;\r\nlen--;\r\n}\r\nhpi_read_words_le16(dev, addr, (__le16 *)buf, len / 2);\r\nbuf += len & ~0x01;\r\naddr += len & ~0x01;\r\nlen &= 0x01;\r\nif (len) {\r\nu16 tmp;\r\ntmp = hpi_read_word(dev, addr);\r\n*buf = tmp & 0x00ff;\r\n}\r\n}\r\nvoid c67x00_ll_init(struct c67x00_device *dev)\r\n{\r\nmutex_init(&dev->hpi.lcp.mutex);\r\ninit_completion(&dev->hpi.lcp.msg_received);\r\n}\r\nvoid c67x00_ll_release(struct c67x00_device *dev)\r\n{\r\n}

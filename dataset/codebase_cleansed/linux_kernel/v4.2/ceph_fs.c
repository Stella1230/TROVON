int ceph_file_layout_is_valid(const struct ceph_file_layout *layout)\r\n{\r\n__u32 su = le32_to_cpu(layout->fl_stripe_unit);\r\n__u32 sc = le32_to_cpu(layout->fl_stripe_count);\r\n__u32 os = le32_to_cpu(layout->fl_object_size);\r\nif (!su || (su & (CEPH_MIN_STRIPE_UNIT-1)))\r\nreturn 0;\r\nif (!os || (os & (CEPH_MIN_STRIPE_UNIT-1)))\r\nreturn 0;\r\nif (os < su || os % su)\r\nreturn 0;\r\nif (!sc)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint ceph_flags_to_mode(int flags)\r\n{\r\nint mode;\r\n#ifdef O_DIRECTORY\r\nif ((flags & O_DIRECTORY) == O_DIRECTORY)\r\nreturn CEPH_FILE_MODE_PIN;\r\n#endif\r\nswitch (flags & O_ACCMODE) {\r\ncase O_WRONLY:\r\nmode = CEPH_FILE_MODE_WR;\r\nbreak;\r\ncase O_RDONLY:\r\nmode = CEPH_FILE_MODE_RD;\r\nbreak;\r\ncase O_RDWR:\r\ncase O_ACCMODE:\r\nmode = CEPH_FILE_MODE_RDWR;\r\nbreak;\r\n}\r\n#ifdef O_LAZY\r\nif (flags & O_LAZY)\r\nmode |= CEPH_FILE_MODE_LAZY;\r\n#endif\r\nreturn mode;\r\n}\r\nint ceph_caps_for_mode(int mode)\r\n{\r\nint caps = CEPH_CAP_PIN;\r\nif (mode & CEPH_FILE_MODE_RD)\r\ncaps |= CEPH_CAP_FILE_SHARED |\r\nCEPH_CAP_FILE_RD | CEPH_CAP_FILE_CACHE;\r\nif (mode & CEPH_FILE_MODE_WR)\r\ncaps |= CEPH_CAP_FILE_EXCL |\r\nCEPH_CAP_FILE_WR | CEPH_CAP_FILE_BUFFER |\r\nCEPH_CAP_AUTH_SHARED | CEPH_CAP_AUTH_EXCL |\r\nCEPH_CAP_XATTR_SHARED | CEPH_CAP_XATTR_EXCL;\r\nif (mode & CEPH_FILE_MODE_LAZY)\r\ncaps |= CEPH_CAP_FILE_LAZYIO;\r\nreturn caps;\r\n}

static void smsdvb_print_dvb_stats(struct smsdvb_debugfs *debug_data,\r\nstruct sms_stats *p)\r\n{\r\nint n = 0;\r\nchar *buf;\r\nspin_lock(&debug_data->lock);\r\nif (debug_data->stats_count) {\r\nspin_unlock(&debug_data->lock);\r\nreturn;\r\n}\r\nbuf = debug_data->stats_data;\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_rf_locked = %d\n", p->is_rf_locked);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_demod_locked = %d\n", p->is_demod_locked);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_external_lna_on = %d\n", p->is_external_lna_on);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"SNR = %d\n", p->SNR);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"ber = %d\n", p->ber);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"FIB_CRC = %d\n", p->FIB_CRC);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"ts_per = %d\n", p->ts_per);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"MFER = %d\n", p->MFER);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"RSSI = %d\n", p->RSSI);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"in_band_pwr = %d\n", p->in_band_pwr);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"carrier_offset = %d\n", p->carrier_offset);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"modem_state = %d\n", p->modem_state);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"frequency = %d\n", p->frequency);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"bandwidth = %d\n", p->bandwidth);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"transmission_mode = %d\n", p->transmission_mode);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"modem_state = %d\n", p->modem_state);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"guard_interval = %d\n", p->guard_interval);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"code_rate = %d\n", p->code_rate);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"lp_code_rate = %d\n", p->lp_code_rate);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"hierarchy = %d\n", p->hierarchy);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"constellation = %d\n", p->constellation);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"burst_size = %d\n", p->burst_size);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"burst_duration = %d\n", p->burst_duration);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"burst_cycle_time = %d\n", p->burst_cycle_time);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"calc_burst_cycle_time = %d\n",\r\np->calc_burst_cycle_time);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_rows = %d\n", p->num_of_rows);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_padd_cols = %d\n", p->num_of_padd_cols);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_punct_cols = %d\n", p->num_of_punct_cols);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"error_ts_packets = %d\n", p->error_ts_packets);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"total_ts_packets = %d\n", p->total_ts_packets);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_valid_mpe_tlbs = %d\n", p->num_of_valid_mpe_tlbs);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_invalid_mpe_tlbs = %d\n", p->num_of_invalid_mpe_tlbs);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_corrected_mpe_tlbs = %d\n", p->num_of_corrected_mpe_tlbs);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"ber_error_count = %d\n", p->ber_error_count);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"ber_bit_count = %d\n", p->ber_bit_count);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"sms_to_host_tx_errors = %d\n", p->sms_to_host_tx_errors);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"pre_ber = %d\n", p->pre_ber);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"cell_id = %d\n", p->cell_id);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"dvbh_srv_ind_hp = %d\n", p->dvbh_srv_ind_hp);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"dvbh_srv_ind_lp = %d\n", p->dvbh_srv_ind_lp);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_mpe_received = %d\n", p->num_mpe_received);\r\ndebug_data->stats_count = n;\r\nspin_unlock(&debug_data->lock);\r\nwake_up(&debug_data->stats_queue);\r\n}\r\nstatic void smsdvb_print_isdb_stats(struct smsdvb_debugfs *debug_data,\r\nstruct sms_isdbt_stats *p)\r\n{\r\nint i, n = 0;\r\nchar *buf;\r\nspin_lock(&debug_data->lock);\r\nif (debug_data->stats_count) {\r\nspin_unlock(&debug_data->lock);\r\nreturn;\r\n}\r\nbuf = debug_data->stats_data;\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"statistics_type = %d\t", p->statistics_type);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"full_size = %d\n", p->full_size);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_rf_locked = %d\t\t", p->is_rf_locked);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_demod_locked = %d\t", p->is_demod_locked);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_external_lna_on = %d\n", p->is_external_lna_on);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"SNR = %d dB\t\t", p->SNR);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"RSSI = %d dBm\t\t", p->RSSI);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"in_band_pwr = %d dBm\n", p->in_band_pwr);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"carrier_offset = %d\t", p->carrier_offset);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"bandwidth = %d\t\t", p->bandwidth);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"frequency = %d Hz\n", p->frequency);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"transmission_mode = %d\t", p->transmission_mode);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"modem_state = %d\t\t", p->modem_state);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"guard_interval = %d\n", p->guard_interval);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"system_type = %d\t\t", p->system_type);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"partial_reception = %d\t", p->partial_reception);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_layers = %d\n", p->num_of_layers);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"sms_to_host_tx_errors = %d\n", p->sms_to_host_tx_errors);\r\nfor (i = 0; i < 3; i++) {\r\nif (p->layer_info[i].number_of_segments < 1 ||\r\np->layer_info[i].number_of_segments > 13)\r\ncontinue;\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\nLayer %d\n", i);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tcode_rate = %d\t",\r\np->layer_info[i].code_rate);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "constellation = %d\n",\r\np->layer_info[i].constellation);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tber = %-5d\t",\r\np->layer_info[i].ber);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tber_error_count = %-5d\t",\r\np->layer_info[i].ber_error_count);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "ber_bit_count = %-5d\n",\r\np->layer_info[i].ber_bit_count);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tpre_ber = %-5d\t",\r\np->layer_info[i].pre_ber);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tts_per = %-5d\n",\r\np->layer_info[i].ts_per);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\terror_ts_packets = %-5d\t",\r\np->layer_info[i].error_ts_packets);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "total_ts_packets = %-5d\t",\r\np->layer_info[i].total_ts_packets);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "ti_ldepth_i = %d\n",\r\np->layer_info[i].ti_ldepth_i);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"\tnumber_of_segments = %d\t",\r\np->layer_info[i].number_of_segments);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "tmcc_errors = %d\n",\r\np->layer_info[i].tmcc_errors);\r\n}\r\ndebug_data->stats_count = n;\r\nspin_unlock(&debug_data->lock);\r\nwake_up(&debug_data->stats_queue);\r\n}\r\nstatic void smsdvb_print_isdb_stats_ex(struct smsdvb_debugfs *debug_data,\r\nstruct sms_isdbt_stats_ex *p)\r\n{\r\nint i, n = 0;\r\nchar *buf;\r\nspin_lock(&debug_data->lock);\r\nif (debug_data->stats_count) {\r\nspin_unlock(&debug_data->lock);\r\nreturn;\r\n}\r\nbuf = debug_data->stats_data;\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"statistics_type = %d\t", p->statistics_type);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"full_size = %d\n", p->full_size);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_rf_locked = %d\t\t", p->is_rf_locked);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_demod_locked = %d\t", p->is_demod_locked);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"is_external_lna_on = %d\n", p->is_external_lna_on);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"SNR = %d dB\t\t", p->SNR);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"RSSI = %d dBm\t\t", p->RSSI);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"in_band_pwr = %d dBm\n", p->in_band_pwr);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"carrier_offset = %d\t", p->carrier_offset);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"bandwidth = %d\t\t", p->bandwidth);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"frequency = %d Hz\n", p->frequency);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"transmission_mode = %d\t", p->transmission_mode);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"modem_state = %d\t\t", p->modem_state);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"guard_interval = %d\n", p->guard_interval);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"system_type = %d\t\t", p->system_type);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"partial_reception = %d\t", p->partial_reception);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"num_of_layers = %d\n", p->num_of_layers);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "segment_number = %d\t",\r\np->segment_number);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "tune_bw = %d\n",\r\np->tune_bw);\r\nfor (i = 0; i < 3; i++) {\r\nif (p->layer_info[i].number_of_segments < 1 ||\r\np->layer_info[i].number_of_segments > 13)\r\ncontinue;\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\nLayer %d\n", i);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tcode_rate = %d\t",\r\np->layer_info[i].code_rate);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "constellation = %d\n",\r\np->layer_info[i].constellation);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tber = %-5d\t",\r\np->layer_info[i].ber);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tber_error_count = %-5d\t",\r\np->layer_info[i].ber_error_count);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "ber_bit_count = %-5d\n",\r\np->layer_info[i].ber_bit_count);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tpre_ber = %-5d\t",\r\np->layer_info[i].pre_ber);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\tts_per = %-5d\n",\r\np->layer_info[i].ts_per);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "\terror_ts_packets = %-5d\t",\r\np->layer_info[i].error_ts_packets);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "total_ts_packets = %-5d\t",\r\np->layer_info[i].total_ts_packets);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "ti_ldepth_i = %d\n",\r\np->layer_info[i].ti_ldepth_i);\r\nn += snprintf(&buf[n], PAGE_SIZE - n,\r\n"\tnumber_of_segments = %d\t",\r\np->layer_info[i].number_of_segments);\r\nn += snprintf(&buf[n], PAGE_SIZE - n, "tmcc_errors = %d\n",\r\np->layer_info[i].tmcc_errors);\r\n}\r\ndebug_data->stats_count = n;\r\nspin_unlock(&debug_data->lock);\r\nwake_up(&debug_data->stats_queue);\r\n}\r\nstatic int smsdvb_stats_open(struct inode *inode, struct file *file)\r\n{\r\nstruct smsdvb_client_t *client = inode->i_private;\r\nstruct smsdvb_debugfs *debug_data = client->debug_data;\r\nkref_get(&debug_data->refcount);\r\nspin_lock(&debug_data->lock);\r\ndebug_data->stats_count = 0;\r\ndebug_data->stats_was_read = false;\r\nspin_unlock(&debug_data->lock);\r\nfile->private_data = debug_data;\r\nreturn 0;\r\n}\r\nstatic void smsdvb_debugfs_data_release(struct kref *ref)\r\n{\r\nstruct smsdvb_debugfs *debug_data;\r\ndebug_data = container_of(ref, struct smsdvb_debugfs, refcount);\r\nkfree(debug_data);\r\n}\r\nstatic int smsdvb_stats_wait_read(struct smsdvb_debugfs *debug_data)\r\n{\r\nint rc = 1;\r\nspin_lock(&debug_data->lock);\r\nif (debug_data->stats_was_read)\r\ngoto exit;\r\nrc = debug_data->stats_count;\r\nexit:\r\nspin_unlock(&debug_data->lock);\r\nreturn rc;\r\n}\r\nstatic unsigned int smsdvb_stats_poll(struct file *file, poll_table *wait)\r\n{\r\nstruct smsdvb_debugfs *debug_data = file->private_data;\r\nint rc;\r\nkref_get(&debug_data->refcount);\r\npoll_wait(file, &debug_data->stats_queue, wait);\r\nrc = smsdvb_stats_wait_read(debug_data);\r\nif (rc > 0)\r\nrc = POLLIN | POLLRDNORM;\r\nkref_put(&debug_data->refcount, smsdvb_debugfs_data_release);\r\nreturn rc;\r\n}\r\nstatic ssize_t smsdvb_stats_read(struct file *file, char __user *user_buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nint rc = 0, len;\r\nstruct smsdvb_debugfs *debug_data = file->private_data;\r\nkref_get(&debug_data->refcount);\r\nif (file->f_flags & O_NONBLOCK) {\r\nrc = smsdvb_stats_wait_read(debug_data);\r\nif (!rc) {\r\nrc = -EWOULDBLOCK;\r\ngoto ret;\r\n}\r\n} else {\r\nrc = wait_event_interruptible(debug_data->stats_queue,\r\nsmsdvb_stats_wait_read(debug_data));\r\nif (rc < 0)\r\ngoto ret;\r\n}\r\nif (debug_data->stats_was_read) {\r\nrc = 0;\r\ngoto ret;\r\n}\r\nlen = debug_data->stats_count - *ppos;\r\nif (len >= 0)\r\nrc = simple_read_from_buffer(user_buf, nbytes, ppos,\r\ndebug_data->stats_data, len);\r\nelse\r\nrc = 0;\r\nif (*ppos >= debug_data->stats_count) {\r\nspin_lock(&debug_data->lock);\r\ndebug_data->stats_was_read = true;\r\nspin_unlock(&debug_data->lock);\r\n}\r\nret:\r\nkref_put(&debug_data->refcount, smsdvb_debugfs_data_release);\r\nreturn rc;\r\n}\r\nstatic int smsdvb_stats_release(struct inode *inode, struct file *file)\r\n{\r\nstruct smsdvb_debugfs *debug_data = file->private_data;\r\nspin_lock(&debug_data->lock);\r\ndebug_data->stats_was_read = true;\r\nspin_unlock(&debug_data->lock);\r\nwake_up_interruptible_sync(&debug_data->stats_queue);\r\nkref_put(&debug_data->refcount, smsdvb_debugfs_data_release);\r\nfile->private_data = NULL;\r\nreturn 0;\r\n}\r\nint smsdvb_debugfs_create(struct smsdvb_client_t *client)\r\n{\r\nstruct smscore_device_t *coredev = client->coredev;\r\nstruct dentry *d;\r\nstruct smsdvb_debugfs *debug_data;\r\nif (!smsdvb_debugfs_usb_root || !coredev->is_usb_device)\r\nreturn -ENODEV;\r\nclient->debugfs = debugfs_create_dir(coredev->devpath,\r\nsmsdvb_debugfs_usb_root);\r\nif (IS_ERR_OR_NULL(client->debugfs)) {\r\npr_info("Unable to create debugfs %s directory.\n",\r\ncoredev->devpath);\r\nreturn -ENODEV;\r\n}\r\nd = debugfs_create_file("stats", S_IRUGO | S_IWUSR, client->debugfs,\r\nclient, &debugfs_stats_ops);\r\nif (!d) {\r\ndebugfs_remove(client->debugfs);\r\nreturn -ENOMEM;\r\n}\r\ndebug_data = kzalloc(sizeof(*client->debug_data), GFP_KERNEL);\r\nif (!debug_data)\r\nreturn -ENOMEM;\r\nclient->debug_data = debug_data;\r\nclient->prt_dvb_stats = smsdvb_print_dvb_stats;\r\nclient->prt_isdb_stats = smsdvb_print_isdb_stats;\r\nclient->prt_isdb_stats_ex = smsdvb_print_isdb_stats_ex;\r\ninit_waitqueue_head(&debug_data->stats_queue);\r\nspin_lock_init(&debug_data->lock);\r\nkref_init(&debug_data->refcount);\r\nreturn 0;\r\n}\r\nvoid smsdvb_debugfs_release(struct smsdvb_client_t *client)\r\n{\r\nif (!client->debugfs)\r\nreturn;\r\nclient->prt_dvb_stats = NULL;\r\nclient->prt_isdb_stats = NULL;\r\nclient->prt_isdb_stats_ex = NULL;\r\ndebugfs_remove_recursive(client->debugfs);\r\nkref_put(&client->debug_data->refcount, smsdvb_debugfs_data_release);\r\nclient->debug_data = NULL;\r\nclient->debugfs = NULL;\r\n}\r\nint smsdvb_debugfs_register(void)\r\n{\r\nstruct dentry *d;\r\nd = debugfs_create_dir("smsdvb", usb_debug_root);\r\nif (IS_ERR_OR_NULL(d)) {\r\npr_err("Couldn't create sysfs node for smsdvb\n");\r\nreturn PTR_ERR(d);\r\n} else {\r\nsmsdvb_debugfs_usb_root = d;\r\n}\r\nreturn 0;\r\n}\r\nvoid smsdvb_debugfs_unregister(void)\r\n{\r\ndebugfs_remove_recursive(smsdvb_debugfs_usb_root);\r\nsmsdvb_debugfs_usb_root = NULL;\r\n}

u32 rcar_gen2_read_mode_pins(void)\r\n{\r\nstatic u32 mode;\r\nstatic bool mode_valid;\r\nif (!mode_valid) {\r\nvoid __iomem *modemr = ioremap_nocache(MODEMR, 4);\r\nBUG_ON(!modemr);\r\nmode = ioread32(modemr);\r\niounmap(modemr);\r\nmode_valid = true;\r\n}\r\nreturn mode;\r\n}\r\nvoid __init rcar_gen2_timer_init(void)\r\n{\r\nu32 mode = rcar_gen2_read_mode_pins();\r\n#ifdef CONFIG_ARM_ARCH_TIMER\r\nvoid __iomem *base;\r\nint extal_mhz = 0;\r\nu32 freq;\r\nif (of_machine_is_compatible("renesas,r8a7794")) {\r\nfreq = 260000000 / 8;\r\nasm volatile(\r\n" cps 0x16\n"\r\n" mrc p15, 0, r1, c1, c1, 0\n"\r\n" orr r0, r1, #1\n"\r\n" mcr p15, 0, r0, c1, c1, 0\n"\r\n" isb\n"\r\n" mov r0, #0\n"\r\n" mcrr p15, 4, r0, r0, c14\n"\r\n" isb\n"\r\n" mcr p15, 0, r1, c1, c1, 0\n"\r\n" isb\n"\r\n" cps 0x13\n"\r\n: : : "r0", "r1");\r\n} else {\r\nswitch (mode & (MD(14) | MD(13))) {\r\ncase 0:\r\nextal_mhz = 15;\r\nbreak;\r\ncase MD(13):\r\nextal_mhz = 20;\r\nbreak;\r\ncase MD(14):\r\nextal_mhz = 26;\r\nbreak;\r\ncase MD(13) | MD(14):\r\nextal_mhz = 30;\r\nbreak;\r\n}\r\nfreq = extal_mhz * (1000000 / 2);\r\n}\r\nbase = ioremap(0xe6080000, PAGE_SIZE);\r\nif ((ioread32(base + CNTCR) & 1) == 0 ||\r\nioread32(base + CNTFID0) != freq) {\r\niowrite32(freq, base + CNTFID0);\r\nasm volatile("mcr p15, 0, %0, c14, c0, 0" : : "r" (freq));\r\niowrite32(1, base + CNTCR);\r\n}\r\niounmap(base);\r\n#endif\r\nrcar_gen2_clocks_init(mode);\r\n#ifdef CONFIG_ARCH_SHMOBILE_MULTI\r\nclocksource_of_init();\r\n#endif\r\n}\r\nstatic int __init rcar_gen2_scan_mem(unsigned long node, const char *uname,\r\nint depth, void *data)\r\n{\r\nconst char *type = of_get_flat_dt_prop(node, "device_type", NULL);\r\nconst __be32 *reg, *endp;\r\nint l;\r\nstruct memory_reserve_config *mrc = data;\r\nu64 lpae_start = 1ULL << 32;\r\nif (type == NULL || strcmp(type, "memory"))\r\nreturn 0;\r\nreg = of_get_flat_dt_prop(node, "linux,usable-memory", &l);\r\nif (reg == NULL)\r\nreg = of_get_flat_dt_prop(node, "reg", &l);\r\nif (reg == NULL)\r\nreturn 0;\r\nendp = reg + (l / sizeof(__be32));\r\nwhile ((endp - reg) >= (dt_root_addr_cells + dt_root_size_cells)) {\r\nu64 base, size;\r\nbase = dt_mem_next_cell(dt_root_addr_cells, &reg);\r\nsize = dt_mem_next_cell(dt_root_size_cells, &reg);\r\nif (base >= lpae_start)\r\ncontinue;\r\nif ((base + size) >= lpae_start)\r\nsize = lpae_start - base;\r\nif (size < mrc->reserved)\r\ncontinue;\r\nif (base < mrc->base)\r\ncontinue;\r\nmrc->base = base + size - mrc->reserved;\r\nmrc->size = mrc->reserved;\r\n}\r\nreturn 0;\r\n}\r\nvoid __init rcar_gen2_reserve(void)\r\n{\r\nstruct memory_reserve_config mrc;\r\nmemset(&mrc, 0, sizeof(mrc));\r\nmrc.reserved = SZ_256M;\r\nof_scan_flat_dt(rcar_gen2_scan_mem, &mrc);\r\n#ifdef CONFIG_DMA_CMA\r\nif (mrc.size && memblock_is_region_memory(mrc.base, mrc.size))\r\ndma_contiguous_reserve_area(mrc.size, mrc.base, 0,\r\n&rcar_gen2_dma_contiguous, true);\r\n#endif\r\n}

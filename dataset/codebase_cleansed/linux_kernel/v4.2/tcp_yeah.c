static void tcp_yeah_init(struct sock *sk)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct yeah *yeah = inet_csk_ca(sk);\r\ntcp_vegas_init(sk);\r\nyeah->doing_reno_now = 0;\r\nyeah->lastQ = 0;\r\nyeah->reno_count = 2;\r\ntp->snd_cwnd_clamp = min_t(u32, tp->snd_cwnd_clamp, 0xffffffff/128);\r\n}\r\nstatic void tcp_yeah_pkts_acked(struct sock *sk, u32 pkts_acked, s32 rtt_us)\r\n{\r\nconst struct inet_connection_sock *icsk = inet_csk(sk);\r\nstruct yeah *yeah = inet_csk_ca(sk);\r\nif (icsk->icsk_ca_state == TCP_CA_Open)\r\nyeah->pkts_acked = pkts_acked;\r\ntcp_vegas_pkts_acked(sk, pkts_acked, rtt_us);\r\n}\r\nstatic void tcp_yeah_cong_avoid(struct sock *sk, u32 ack, u32 acked)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct yeah *yeah = inet_csk_ca(sk);\r\nif (!tcp_is_cwnd_limited(sk))\r\nreturn;\r\nif (tp->snd_cwnd <= tp->snd_ssthresh)\r\ntcp_slow_start(tp, acked);\r\nelse if (!yeah->doing_reno_now) {\r\ntp->snd_cwnd_cnt += yeah->pkts_acked;\r\nif (tp->snd_cwnd_cnt > min(tp->snd_cwnd, TCP_SCALABLE_AI_CNT)) {\r\nif (tp->snd_cwnd < tp->snd_cwnd_clamp)\r\ntp->snd_cwnd++;\r\ntp->snd_cwnd_cnt = 0;\r\n}\r\nyeah->pkts_acked = 1;\r\n} else {\r\ntcp_cong_avoid_ai(tp, tp->snd_cwnd, 1);\r\n}\r\nif (after(ack, yeah->vegas.beg_snd_nxt)) {\r\nif (yeah->vegas.cntRTT > 2) {\r\nu32 rtt, queue;\r\nu64 bw;\r\nrtt = yeah->vegas.minRTT;\r\nbw = tp->snd_cwnd;\r\nbw *= rtt - yeah->vegas.baseRTT;\r\ndo_div(bw, rtt);\r\nqueue = bw;\r\nif (queue > TCP_YEAH_ALPHA ||\r\nrtt - yeah->vegas.baseRTT > (yeah->vegas.baseRTT / TCP_YEAH_PHY)) {\r\nif (queue > TCP_YEAH_ALPHA &&\r\ntp->snd_cwnd > yeah->reno_count) {\r\nu32 reduction = min(queue / TCP_YEAH_GAMMA ,\r\ntp->snd_cwnd >> TCP_YEAH_EPSILON);\r\ntp->snd_cwnd -= reduction;\r\ntp->snd_cwnd = max(tp->snd_cwnd,\r\nyeah->reno_count);\r\ntp->snd_ssthresh = tp->snd_cwnd;\r\n}\r\nif (yeah->reno_count <= 2)\r\nyeah->reno_count = max(tp->snd_cwnd>>1, 2U);\r\nelse\r\nyeah->reno_count++;\r\nyeah->doing_reno_now = min(yeah->doing_reno_now + 1,\r\n0xffffffU);\r\n} else {\r\nyeah->fast_count++;\r\nif (yeah->fast_count > TCP_YEAH_ZETA) {\r\nyeah->reno_count = 2;\r\nyeah->fast_count = 0;\r\n}\r\nyeah->doing_reno_now = 0;\r\n}\r\nyeah->lastQ = queue;\r\n}\r\nyeah->vegas.beg_snd_una = yeah->vegas.beg_snd_nxt;\r\nyeah->vegas.beg_snd_nxt = tp->snd_nxt;\r\nyeah->vegas.beg_snd_cwnd = tp->snd_cwnd;\r\nyeah->vegas.cntRTT = 0;\r\nyeah->vegas.minRTT = 0x7fffffff;\r\n}\r\n}\r\nstatic u32 tcp_yeah_ssthresh(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct yeah *yeah = inet_csk_ca(sk);\r\nu32 reduction;\r\nif (yeah->doing_reno_now < TCP_YEAH_RHO) {\r\nreduction = yeah->lastQ;\r\nreduction = min(reduction, max(tp->snd_cwnd>>1, 2U));\r\nreduction = max(reduction, tp->snd_cwnd >> TCP_YEAH_DELTA);\r\n} else\r\nreduction = max(tp->snd_cwnd>>1, 2U);\r\nyeah->fast_count = 0;\r\nyeah->reno_count = max(yeah->reno_count>>1, 2U);\r\nreturn tp->snd_cwnd - reduction;\r\n}\r\nstatic int __init tcp_yeah_register(void)\r\n{\r\nBUG_ON(sizeof(struct yeah) > ICSK_CA_PRIV_SIZE);\r\ntcp_register_congestion_control(&tcp_yeah);\r\nreturn 0;\r\n}\r\nstatic void __exit tcp_yeah_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&tcp_yeah);\r\n}

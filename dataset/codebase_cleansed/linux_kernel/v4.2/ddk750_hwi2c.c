int hwI2CInit(\r\nunsigned char busSpeedMode\r\n)\r\n{\r\nunsigned int value;\r\nvalue = PEEK32(GPIO_MUX);\r\nvalue = FIELD_SET(value, GPIO_MUX, 30, I2C) |\r\nFIELD_SET(0, GPIO_MUX, 31, I2C);\r\nPOKE32(GPIO_MUX, value);\r\nenableI2C(1);\r\nvalue = PEEK32(I2C_CTRL);\r\nif (busSpeedMode == 0)\r\nvalue = FIELD_SET(value, I2C_CTRL, MODE, STANDARD);\r\nelse\r\nvalue = FIELD_SET(value, I2C_CTRL, MODE, FAST);\r\nvalue = FIELD_SET(value, I2C_CTRL, EN, ENABLE);\r\nPOKE32(I2C_CTRL, value);\r\nreturn 0;\r\n}\r\nvoid hwI2CClose(void)\r\n{\r\nunsigned int value;\r\nvalue = PEEK32(I2C_CTRL);\r\nvalue = FIELD_SET(value, I2C_CTRL, EN, DISABLE);\r\nPOKE32(I2C_CTRL, value);\r\nenableI2C(0);\r\nvalue = PEEK32(GPIO_MUX);\r\nvalue = FIELD_SET(value, GPIO_MUX, 30, GPIO);\r\nvalue = FIELD_SET(value, GPIO_MUX, 31, GPIO);\r\nPOKE32(GPIO_MUX, value);\r\n}\r\nstatic long hwI2CWaitTXDone(void)\r\n{\r\nunsigned int timeout;\r\ntimeout = HWI2C_WAIT_TIMEOUT;\r\nwhile ((FIELD_GET(PEEK32(I2C_STATUS), I2C_STATUS, TX) != I2C_STATUS_TX_COMPLETED) &&\r\n(timeout != 0))\r\ntimeout--;\r\nif (timeout == 0)\r\nreturn (-1);\r\nreturn 0;\r\n}\r\nstatic unsigned int hwI2CWriteData(\r\nunsigned char deviceAddress,\r\nunsigned int length,\r\nunsigned char *pBuffer\r\n)\r\n{\r\nunsigned char count, i;\r\nunsigned int totalBytes = 0;\r\nPOKE32(I2C_SLAVE_ADDRESS, deviceAddress & ~0x01);\r\ndo\r\n{\r\nPOKE32(I2C_RESET, 0);\r\nif (length < MAX_HWI2C_FIFO)\r\ncount = length - 1;\r\nelse\r\ncount = MAX_HWI2C_FIFO - 1;\r\nPOKE32(I2C_BYTE_COUNT, count);\r\nfor (i = 0; i <= count; i++)\r\nPOKE32(I2C_DATA0 + i, *pBuffer++);\r\nPOKE32(I2C_CTRL, FIELD_SET(PEEK32(I2C_CTRL), I2C_CTRL, CTRL, START));\r\nif (hwI2CWaitTXDone() != 0)\r\nbreak;\r\nlength -= (count + 1);\r\ntotalBytes += (count + 1);\r\n} while (length > 0);\r\nreturn totalBytes;\r\n}\r\nstatic unsigned int hwI2CReadData(\r\nunsigned char deviceAddress,\r\nunsigned int length,\r\nunsigned char *pBuffer\r\n)\r\n{\r\nunsigned char count, i;\r\nunsigned int totalBytes = 0;\r\nPOKE32(I2C_SLAVE_ADDRESS, deviceAddress | 0x01);\r\ndo\r\n{\r\nPOKE32(I2C_RESET, 0);\r\nif (length <= MAX_HWI2C_FIFO)\r\ncount = length - 1;\r\nelse\r\ncount = MAX_HWI2C_FIFO - 1;\r\nPOKE32(I2C_BYTE_COUNT, count);\r\nPOKE32(I2C_CTRL, FIELD_SET(PEEK32(I2C_CTRL), I2C_CTRL, CTRL, START));\r\nif (hwI2CWaitTXDone() != 0)\r\nbreak;\r\nfor (i = 0; i <= count; i++)\r\n*pBuffer++ = PEEK32(I2C_DATA0 + i);\r\nlength -= (count + 1);\r\ntotalBytes += (count + 1);\r\n} while (length > 0);\r\nreturn totalBytes;\r\n}\r\nunsigned char hwI2CReadReg(\r\nunsigned char deviceAddress,\r\nunsigned char registerIndex\r\n)\r\n{\r\nunsigned char value = (0xFF);\r\nif (hwI2CWriteData(deviceAddress, 1, &registerIndex) == 1)\r\nhwI2CReadData(deviceAddress, 1, &value);\r\nreturn value;\r\n}\r\nint hwI2CWriteReg(\r\nunsigned char deviceAddress,\r\nunsigned char registerIndex,\r\nunsigned char data\r\n)\r\n{\r\nunsigned char value[2];\r\nvalue[0] = registerIndex;\r\nvalue[1] = data;\r\nif (hwI2CWriteData(deviceAddress, 2, value) == 2)\r\nreturn 0;\r\nreturn (-1);\r\n}

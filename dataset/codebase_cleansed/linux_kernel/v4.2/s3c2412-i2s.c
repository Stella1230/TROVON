static int s3c2412_i2s_probe(struct snd_soc_dai *dai)\r\n{\r\nint ret;\r\npr_debug("Entered %s\n", __func__);\r\nsamsung_asoc_init_dma_data(dai, &s3c2412_i2s_pcm_stereo_out,\r\n&s3c2412_i2s_pcm_stereo_in);\r\nret = s3c_i2sv2_probe(dai, &s3c2412_i2s, S3C2410_PA_IIS);\r\nif (ret)\r\nreturn ret;\r\ns3c2412_i2s.dma_capture = &s3c2412_i2s_pcm_stereo_in;\r\ns3c2412_i2s.dma_playback = &s3c2412_i2s_pcm_stereo_out;\r\ns3c2412_i2s.iis_cclk = devm_clk_get(dai->dev, "i2sclk");\r\nif (IS_ERR(s3c2412_i2s.iis_cclk)) {\r\npr_err("failed to get i2sclk clock\n");\r\nreturn PTR_ERR(s3c2412_i2s.iis_cclk);\r\n}\r\nclk_set_parent(s3c2412_i2s.iis_cclk, clk_get(NULL, "mpll"));\r\nclk_prepare_enable(s3c2412_i2s.iis_cclk);\r\ns3c2412_i2s.iis_cclk = s3c2412_i2s.iis_pclk;\r\ns3c_gpio_cfgall_range(S3C2410_GPE(0), 5, S3C_GPIO_SFN(2),\r\nS3C_GPIO_PULL_NONE);\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_remove(struct snd_soc_dai *dai)\r\n{\r\nclk_disable_unprepare(s3c2412_i2s.iis_cclk);\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *cpu_dai)\r\n{\r\nstruct s3c_i2sv2_info *i2s = snd_soc_dai_get_drvdata(cpu_dai);\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\niismod = readl(i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: r: IISMOD: %x\n", __func__, iismod);\r\nswitch (params_width(params)) {\r\ncase 8:\r\niismod |= S3C2412_IISMOD_8BIT;\r\nbreak;\r\ncase 16:\r\niismod &= ~S3C2412_IISMOD_8BIT;\r\nbreak;\r\n}\r\nwritel(iismod, i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: w: IISMOD: %x\n", __func__, iismod);\r\nreturn 0;\r\n}\r\nstatic int s3c2412_iis_dev_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ns3c2412_i2s.regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(s3c2412_i2s.regs))\r\nreturn PTR_ERR(s3c2412_i2s.regs);\r\ns3c2412_i2s_pcm_stereo_out.dma_addr = res->start + S3C2412_IISTXD;\r\ns3c2412_i2s_pcm_stereo_in.dma_addr = res->start + S3C2412_IISRXD;\r\nret = s3c_i2sv2_register_component(&pdev->dev, -1,\r\n&s3c2412_i2s_component,\r\n&s3c2412_i2s_dai);\r\nif (ret) {\r\npr_err("failed to register the dai\n");\r\nreturn ret;\r\n}\r\nret = samsung_asoc_dma_platform_register(&pdev->dev);\r\nif (ret)\r\npr_err("failed to register the DMA: %d\n", ret);\r\nreturn ret;\r\n}

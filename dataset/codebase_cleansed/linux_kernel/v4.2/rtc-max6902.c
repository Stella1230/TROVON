static int max6902_set_reg(struct device *dev, unsigned char address,\r\nunsigned char data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nunsigned char buf[2];\r\nbuf[0] = address & 0x7f;\r\nbuf[1] = data;\r\nreturn spi_write_then_read(spi, buf, 2, NULL, 0);\r\n}\r\nstatic int max6902_get_reg(struct device *dev, unsigned char address,\r\nunsigned char *data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\n*data = address | 0x80;\r\nreturn spi_write_then_read(spi, data, 1, data, 1);\r\n}\r\nstatic int max6902_read_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nint err, century;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nunsigned char buf[8];\r\nbuf[0] = 0xbf;\r\nerr = spi_write_then_read(spi, buf, 1, buf, 8);\r\nif (err != 0)\r\nreturn err;\r\ndt->tm_sec = bcd2bin(buf[0]);\r\ndt->tm_min = bcd2bin(buf[1]);\r\ndt->tm_hour = bcd2bin(buf[2]);\r\ndt->tm_mday = bcd2bin(buf[3]);\r\ndt->tm_mon = bcd2bin(buf[4]) - 1;\r\ndt->tm_wday = bcd2bin(buf[5]);\r\ndt->tm_year = bcd2bin(buf[6]);\r\nerr = max6902_get_reg(dev, MAX6902_REG_CENTURY, &buf[0]);\r\nif (err != 0)\r\nreturn err;\r\ncentury = bcd2bin(buf[0]) * 100;\r\ndt->tm_year += century;\r\ndt->tm_year -= 1900;\r\nreturn rtc_valid_tm(dt);\r\n}\r\nstatic int max6902_set_time(struct device *dev, struct rtc_time *dt)\r\n{\r\ndt->tm_year = dt->tm_year + 1900;\r\nmax6902_set_reg(dev, MAX6902_REG_CONTROL, 0);\r\nmax6902_set_reg(dev, MAX6902_REG_SECONDS, bin2bcd(dt->tm_sec));\r\nmax6902_set_reg(dev, MAX6902_REG_MINUTES, bin2bcd(dt->tm_min));\r\nmax6902_set_reg(dev, MAX6902_REG_HOURS, bin2bcd(dt->tm_hour));\r\nmax6902_set_reg(dev, MAX6902_REG_DATE, bin2bcd(dt->tm_mday));\r\nmax6902_set_reg(dev, MAX6902_REG_MONTH, bin2bcd(dt->tm_mon + 1));\r\nmax6902_set_reg(dev, MAX6902_REG_DAY, bin2bcd(dt->tm_wday));\r\nmax6902_set_reg(dev, MAX6902_REG_YEAR, bin2bcd(dt->tm_year % 100));\r\nmax6902_set_reg(dev, MAX6902_REG_CENTURY, bin2bcd(dt->tm_year / 100));\r\nmax6902_set_reg(dev, MAX6902_REG_CONTROL, 0x80);\r\nreturn 0;\r\n}\r\nstatic int max6902_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nunsigned char tmp;\r\nint res;\r\nspi->mode = SPI_MODE_3;\r\nspi->bits_per_word = 8;\r\nspi_setup(spi);\r\nres = max6902_get_reg(&spi->dev, MAX6902_REG_SECONDS, &tmp);\r\nif (res != 0)\r\nreturn res;\r\nrtc = devm_rtc_device_register(&spi->dev, "max6902",\r\n&max6902_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nspi_set_drvdata(spi, rtc);\r\nreturn 0;\r\n}

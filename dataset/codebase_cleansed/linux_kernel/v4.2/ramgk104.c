static void\r\ngk104_ram_train(struct gk104_ramfuc *fuc, u32 mask, u32 data)\r\n{\r\nstruct gk104_ram *ram = container_of(fuc, typeof(*ram), fuc);\r\nu32 addr = 0x110974, i;\r\nram_mask(fuc, 0x10f910, mask, data);\r\nram_mask(fuc, 0x10f914, mask, data);\r\nfor (i = 0; (data & 0x80000000) && i < ram->parts; addr += 0x1000, i++) {\r\nif (ram->pmask & (1 << i))\r\ncontinue;\r\nram_wait(fuc, addr, 0x0000000f, 0x00000000, 500000);\r\n}\r\n}\r\nstatic void\r\nr1373f4_init(struct gk104_ramfuc *fuc)\r\n{\r\nstruct gk104_ram *ram = container_of(fuc, typeof(*ram), fuc);\r\nconst u32 mcoef = ((--ram->P2 << 28) | (ram->N2 << 8) | ram->M2);\r\nconst u32 rcoef = (( ram->P1 << 16) | (ram->N1 << 8) | ram->M1);\r\nconst u32 runk0 = ram->fN1 << 16;\r\nconst u32 runk1 = ram->fN1;\r\nif (ram->from == 2) {\r\nram_mask(fuc, 0x1373f4, 0x00000000, 0x00001100);\r\nram_mask(fuc, 0x1373f4, 0x00000000, 0x00000010);\r\n} else {\r\nram_mask(fuc, 0x1373f4, 0x00000000, 0x00010010);\r\n}\r\nram_mask(fuc, 0x1373f4, 0x00000003, 0x00000000);\r\nram_mask(fuc, 0x1373f4, 0x00000010, 0x00000000);\r\nif ((ram_rd32(fuc, 0x132024) & 0xffffffff) != rcoef ||\r\n(ram_rd32(fuc, 0x132034) & 0x0000ffff) != runk1) {\r\nram_mask(fuc, 0x132000, 0x00000001, 0x00000000);\r\nram_mask(fuc, 0x132020, 0x00000001, 0x00000000);\r\nram_wr32(fuc, 0x137320, 0x00000000);\r\nram_mask(fuc, 0x132030, 0xffff0000, runk0);\r\nram_mask(fuc, 0x132034, 0x0000ffff, runk1);\r\nram_wr32(fuc, 0x132024, rcoef);\r\nram_mask(fuc, 0x132028, 0x00080000, 0x00080000);\r\nram_mask(fuc, 0x132020, 0x00000001, 0x00000001);\r\nram_wait(fuc, 0x137390, 0x00020000, 0x00020000, 64000);\r\nram_mask(fuc, 0x132028, 0x00080000, 0x00000000);\r\n}\r\nif (ram->mode == 2) {\r\nram_mask(fuc, 0x1373f4, 0x00010000, 0x00000000);\r\nram_mask(fuc, 0x132000, 0x80000000, 0x80000000);\r\nram_mask(fuc, 0x132000, 0x00000001, 0x00000000);\r\nram_mask(fuc, 0x132004, 0x103fffff, mcoef);\r\nram_mask(fuc, 0x132000, 0x00000001, 0x00000001);\r\nram_wait(fuc, 0x137390, 0x00000002, 0x00000002, 64000);\r\nram_mask(fuc, 0x1373f4, 0x00000000, 0x00001100);\r\n} else {\r\nram_mask(fuc, 0x1373f4, 0x00000000, 0x00010100);\r\n}\r\nram_mask(fuc, 0x1373f4, 0x00000000, 0x00000010);\r\n}\r\nstatic void\r\nr1373f4_fini(struct gk104_ramfuc *fuc)\r\n{\r\nstruct gk104_ram *ram = container_of(fuc, typeof(*ram), fuc);\r\nstruct nvkm_ram_data *next = ram->base.next;\r\nu8 v0 = next->bios.ramcfg_11_03_c0;\r\nu8 v1 = next->bios.ramcfg_11_03_30;\r\nu32 tmp;\r\ntmp = ram_rd32(fuc, 0x1373ec) & ~0x00030000;\r\nram_wr32(fuc, 0x1373ec, tmp | (v1 << 16));\r\nram_mask(fuc, 0x1373f0, (~ram->mode & 3), 0x00000000);\r\nif (ram->mode == 2) {\r\nram_mask(fuc, 0x1373f4, 0x00000003, 0x000000002);\r\nram_mask(fuc, 0x1373f4, 0x00001100, 0x000000000);\r\n} else {\r\nram_mask(fuc, 0x1373f4, 0x00000003, 0x000000001);\r\nram_mask(fuc, 0x1373f4, 0x00010000, 0x000000000);\r\n}\r\nram_mask(fuc, 0x10f800, 0x00000030, (v0 ^ v1) << 4);\r\n}\r\nstatic void\r\ngk104_ram_nuts(struct gk104_ram *ram, struct ramfuc_reg *reg,\r\nu32 _mask, u32 _data, u32 _copy)\r\n{\r\nstruct gk104_fb_priv *priv = (void *)nvkm_fb(ram);\r\nstruct ramfuc *fuc = &ram->fuc.base;\r\nu32 addr = 0x110000 + (reg->addr & 0xfff);\r\nu32 mask = _mask | _copy;\r\nu32 data = (_data & _mask) | (reg->data & _copy);\r\nu32 i;\r\nfor (i = 0; i < 16; i++, addr += 0x1000) {\r\nif (ram->pnuts & (1 << i)) {\r\nu32 prev = nv_rd32(priv, addr);\r\nu32 next = (prev & ~mask) | data;\r\nnvkm_memx_wr32(fuc->memx, addr, next);\r\n}\r\n}\r\n}\r\nstatic int\r\ngk104_ram_calc_gddr5(struct nvkm_fb *pfb, u32 freq)\r\n{\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct gk104_ramfuc *fuc = &ram->fuc;\r\nstruct nvkm_ram_data *next = ram->base.next;\r\nint vc = !next->bios.ramcfg_11_02_08;\r\nint mv = !next->bios.ramcfg_11_02_04;\r\nu32 mask, data;\r\nram_mask(fuc, 0x10f808, 0x40000000, 0x40000000);\r\nram_block(fuc);\r\nram_wr32(fuc, 0x62c000, 0x0f0f0000);\r\nif ((ram->base.mr[1] & 0x03c) != 0x030) {\r\nram_mask(fuc, mr[1], 0x03c, ram->base.mr[1] & 0x03c);\r\nram_nuts(ram, mr[1], 0x03c, ram->base.mr1_nuts & 0x03c, 0x000);\r\n}\r\nif (vc == 1 && ram_have(fuc, gpio2E)) {\r\nu32 temp = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[1]);\r\nif (temp != ram_rd32(fuc, gpio2E)) {\r\nram_wr32(fuc, gpiotrig, 1);\r\nram_nsec(fuc, 20000);\r\n}\r\n}\r\nram_mask(fuc, 0x10f200, 0x00000800, 0x00000000);\r\ngk104_ram_train(fuc, 0x01020000, 0x000c0000);\r\nram_wr32(fuc, 0x10f210, 0x00000000);\r\nram_nsec(fuc, 1000);\r\nram_wr32(fuc, 0x10f310, 0x00000001);\r\nram_nsec(fuc, 1000);\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\r\nram_wr32(fuc, 0x10f314, 0x00000001);\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\r\nram_wr32(fuc, 0x10f090, 0x00000061);\r\nram_wr32(fuc, 0x10f090, 0xc000007f);\r\nram_nsec(fuc, 1000);\r\nram_wr32(fuc, 0x10f698, 0x00000000);\r\nram_wr32(fuc, 0x10f69c, 0x00000000);\r\nmask = 0x800f07e0;\r\ndata = 0x00030000;\r\nif (ram_rd32(fuc, 0x10f978) & 0x00800000)\r\ndata |= 0x00040000;\r\nif (1) {\r\ndata |= 0x800807e0;\r\nswitch (next->bios.ramcfg_11_03_c0) {\r\ncase 3: data &= ~0x00000040; break;\r\ncase 2: data &= ~0x00000100; break;\r\ncase 1: data &= ~0x80000000; break;\r\ncase 0: data &= ~0x00000400; break;\r\n}\r\nswitch (next->bios.ramcfg_11_03_30) {\r\ncase 3: data &= ~0x00000020; break;\r\ncase 2: data &= ~0x00000080; break;\r\ncase 1: data &= ~0x00080000; break;\r\ncase 0: data &= ~0x00000200; break;\r\n}\r\n}\r\nif (next->bios.ramcfg_11_02_80)\r\nmask |= 0x03000000;\r\nif (next->bios.ramcfg_11_02_40)\r\nmask |= 0x00002000;\r\nif (next->bios.ramcfg_11_07_10)\r\nmask |= 0x00004000;\r\nif (next->bios.ramcfg_11_07_08)\r\nmask |= 0x00000003;\r\nelse {\r\nmask |= 0x34000000;\r\nif (ram_rd32(fuc, 0x10f978) & 0x00800000)\r\nmask |= 0x40000000;\r\n}\r\nram_mask(fuc, 0x10f824, mask, data);\r\nram_mask(fuc, 0x132040, 0x00010000, 0x00000000);\r\nif (ram->from == 2 && ram->mode != 2) {\r\nram_mask(fuc, 0x10f808, 0x00080000, 0x00000000);\r\nram_mask(fuc, 0x10f200, 0x18008000, 0x00008000);\r\nram_mask(fuc, 0x10f800, 0x00000000, 0x00000004);\r\nram_mask(fuc, 0x10f830, 0x00008000, 0x01040010);\r\nram_mask(fuc, 0x10f830, 0x01000000, 0x00000000);\r\nr1373f4_init(fuc);\r\nram_mask(fuc, 0x1373f0, 0x00000002, 0x00000001);\r\nr1373f4_fini(fuc);\r\nram_mask(fuc, 0x10f830, 0x00c00000, 0x00240001);\r\n} else\r\nif (ram->from != 2 && ram->mode != 2) {\r\nr1373f4_init(fuc);\r\nr1373f4_fini(fuc);\r\n}\r\nif (ram_have(fuc, gpioMV)) {\r\nu32 temp = ram_mask(fuc, gpioMV, 0x3000, fuc->r_funcMV[mv]);\r\nif (temp != ram_rd32(fuc, gpioMV)) {\r\nram_wr32(fuc, gpiotrig, 1);\r\nram_nsec(fuc, 64000);\r\n}\r\n}\r\nif (next->bios.ramcfg_11_02_40 ||\r\nnext->bios.ramcfg_11_07_10) {\r\nram_mask(fuc, 0x132040, 0x00010000, 0x00010000);\r\nram_nsec(fuc, 20000);\r\n}\r\nif (ram->from != 2 && ram->mode == 2) {\r\nif (0 )\r\nram_mask(fuc, 0x10f200, 0x18000000, 0x18000000);\r\nram_mask(fuc, 0x10f800, 0x00000004, 0x00000000);\r\nram_mask(fuc, 0x1373f0, 0x00000000, 0x00000002);\r\nram_mask(fuc, 0x10f830, 0x00800001, 0x00408010);\r\nr1373f4_init(fuc);\r\nr1373f4_fini(fuc);\r\nram_mask(fuc, 0x10f808, 0x00000000, 0x00080000);\r\nram_mask(fuc, 0x10f200, 0x00808000, 0x00800000);\r\n} else\r\nif (ram->from == 2 && ram->mode == 2) {\r\nram_mask(fuc, 0x10f800, 0x00000004, 0x00000000);\r\nr1373f4_init(fuc);\r\nr1373f4_fini(fuc);\r\n}\r\nif (ram->mode != 2) {\r\nif (next->bios.ramcfg_11_07_40)\r\nram_mask(fuc, 0x10f670, 0x80000000, 0x80000000);\r\n}\r\nram_wr32(fuc, 0x10f65c, 0x00000011 * next->bios.rammap_11_11_0c);\r\nram_wr32(fuc, 0x10f6b8, 0x01010101 * next->bios.ramcfg_11_09);\r\nram_wr32(fuc, 0x10f6bc, 0x01010101 * next->bios.ramcfg_11_09);\r\nif (!next->bios.ramcfg_11_07_08 && !next->bios.ramcfg_11_07_04) {\r\nram_wr32(fuc, 0x10f698, 0x01010101 * next->bios.ramcfg_11_04);\r\nram_wr32(fuc, 0x10f69c, 0x01010101 * next->bios.ramcfg_11_04);\r\n} else\r\nif (!next->bios.ramcfg_11_07_08) {\r\nram_wr32(fuc, 0x10f698, 0x00000000);\r\nram_wr32(fuc, 0x10f69c, 0x00000000);\r\n}\r\nif (ram->mode != 2) {\r\nu32 data = 0x01000100 * next->bios.ramcfg_11_04;\r\nram_nuke(fuc, 0x10f694);\r\nram_mask(fuc, 0x10f694, 0xff00ff00, data);\r\n}\r\nif (ram->mode == 2 && next->bios.ramcfg_11_08_10)\r\ndata = 0x00000080;\r\nelse\r\ndata = 0x00000000;\r\nram_mask(fuc, 0x10f60c, 0x00000080, data);\r\nmask = 0x00070000;\r\ndata = 0x00000000;\r\nif (!next->bios.ramcfg_11_02_80)\r\ndata |= 0x03000000;\r\nif (!next->bios.ramcfg_11_02_40)\r\ndata |= 0x00002000;\r\nif (!next->bios.ramcfg_11_07_10)\r\ndata |= 0x00004000;\r\nif (!next->bios.ramcfg_11_07_08)\r\ndata |= 0x00000003;\r\nelse\r\ndata |= 0x74000000;\r\nram_mask(fuc, 0x10f824, mask, data);\r\nif (next->bios.ramcfg_11_01_08)\r\ndata = 0x00000000;\r\nelse\r\ndata = 0x00001000;\r\nram_mask(fuc, 0x10f200, 0x00001000, data);\r\nif (ram_rd32(fuc, 0x10f670) & 0x80000000) {\r\nram_nsec(fuc, 10000);\r\nram_mask(fuc, 0x10f670, 0x80000000, 0x00000000);\r\n}\r\nif (next->bios.ramcfg_11_08_01)\r\ndata = 0x00100000;\r\nelse\r\ndata = 0x00000000;\r\nram_mask(fuc, 0x10f82c, 0x00100000, data);\r\ndata = 0x00000000;\r\nif (next->bios.ramcfg_11_08_08)\r\ndata |= 0x00002000;\r\nif (next->bios.ramcfg_11_08_04)\r\ndata |= 0x00001000;\r\nif (next->bios.ramcfg_11_08_02)\r\ndata |= 0x00004000;\r\nram_mask(fuc, 0x10f830, 0x00007000, data);\r\nram_mask(fuc, 0x10f248, 0xffffffff, next->bios.timing[10]);\r\nram_mask(fuc, 0x10f290, 0xffffffff, next->bios.timing[0]);\r\nram_mask(fuc, 0x10f294, 0xffffffff, next->bios.timing[1]);\r\nram_mask(fuc, 0x10f298, 0xffffffff, next->bios.timing[2]);\r\nram_mask(fuc, 0x10f29c, 0xffffffff, next->bios.timing[3]);\r\nram_mask(fuc, 0x10f2a0, 0xffffffff, next->bios.timing[4]);\r\nram_mask(fuc, 0x10f2a4, 0xffffffff, next->bios.timing[5]);\r\nram_mask(fuc, 0x10f2a8, 0xffffffff, next->bios.timing[6]);\r\nram_mask(fuc, 0x10f2ac, 0xffffffff, next->bios.timing[7]);\r\nram_mask(fuc, 0x10f2cc, 0xffffffff, next->bios.timing[8]);\r\nram_mask(fuc, 0x10f2e8, 0xffffffff, next->bios.timing[9]);\r\ndata = mask = 0x00000000;\r\nif (ram->diff.ramcfg_11_08_20) {\r\nif (next->bios.ramcfg_11_08_20)\r\ndata |= 0x01000000;\r\nmask |= 0x01000000;\r\n}\r\nram_mask(fuc, 0x10f200, mask, data);\r\ndata = mask = 0x00000000;\r\nif (ram->diff.ramcfg_11_02_03) {\r\ndata |= next->bios.ramcfg_11_02_03 << 8;\r\nmask |= 0x00000300;\r\n}\r\nif (ram->diff.ramcfg_11_01_10) {\r\nif (next->bios.ramcfg_11_01_10)\r\ndata |= 0x70000000;\r\nmask |= 0x70000000;\r\n}\r\nram_mask(fuc, 0x10f604, mask, data);\r\ndata = mask = 0x00000000;\r\nif (ram->diff.timing_20_30_07) {\r\ndata |= next->bios.timing_20_30_07 << 28;\r\nmask |= 0x70000000;\r\n}\r\nif (ram->diff.ramcfg_11_01_01) {\r\nif (next->bios.ramcfg_11_01_01)\r\ndata |= 0x00000100;\r\nmask |= 0x00000100;\r\n}\r\nram_mask(fuc, 0x10f614, mask, data);\r\ndata = mask = 0x00000000;\r\nif (ram->diff.timing_20_30_07) {\r\ndata |= next->bios.timing_20_30_07 << 28;\r\nmask |= 0x70000000;\r\n}\r\nif (ram->diff.ramcfg_11_01_02) {\r\nif (next->bios.ramcfg_11_01_02)\r\ndata |= 0x00000100;\r\nmask |= 0x00000100;\r\n}\r\nram_mask(fuc, 0x10f610, mask, data);\r\nmask = 0x33f00000;\r\ndata = 0x00000000;\r\nif (!next->bios.ramcfg_11_01_04)\r\ndata |= 0x20200000;\r\nif (!next->bios.ramcfg_11_07_80)\r\ndata |= 0x12800000;\r\nif (next->bios.ramcfg_11_03_f0) {\r\nif (next->bios.rammap_11_08_0c) {\r\nif (!next->bios.ramcfg_11_07_80)\r\nmask |= 0x00000020;\r\nelse\r\ndata |= 0x00000020;\r\nmask |= 0x00000004;\r\n}\r\n} else {\r\nmask |= 0x40000020;\r\ndata |= 0x00000004;\r\n}\r\nram_mask(fuc, 0x10f808, mask, data);\r\nram_wr32(fuc, 0x10f870, 0x11111111 * next->bios.ramcfg_11_03_0f);\r\ndata = mask = 0x00000000;\r\nif (ram->diff.ramcfg_11_02_03) {\r\ndata |= next->bios.ramcfg_11_02_03;\r\nmask |= 0x00000003;\r\n}\r\nif (ram->diff.ramcfg_11_01_10) {\r\nif (next->bios.ramcfg_11_01_10)\r\ndata |= 0x00000004;\r\nmask |= 0x00000004;\r\n}\r\nif ((ram_mask(fuc, 0x100770, mask, data) & mask & 4) != (data & 4)) {\r\nram_mask(fuc, 0x100750, 0x00000008, 0x00000008);\r\nram_wr32(fuc, 0x100710, 0x00000000);\r\nram_wait(fuc, 0x100710, 0x80000000, 0x80000000, 200000);\r\n}\r\ndata = next->bios.timing_20_30_07 << 8;\r\nif (next->bios.ramcfg_11_01_01)\r\ndata |= 0x80000000;\r\nram_mask(fuc, 0x100778, 0x00000700, data);\r\nram_mask(fuc, 0x10f250, 0x000003f0, next->bios.timing_20_2c_003f << 4);\r\ndata = (next->bios.timing[10] & 0x7f000000) >> 24;\r\nif (data < next->bios.timing_20_2c_1fc0)\r\ndata = next->bios.timing_20_2c_1fc0;\r\nram_mask(fuc, 0x10f24c, 0x7f000000, data << 24);\r\nram_mask(fuc, 0x10f224, 0x001f0000, next->bios.timing_20_30_f8 << 16);\r\nram_mask(fuc, 0x10fec4, 0x041e0f07, next->bios.timing_20_31_0800 << 26 |\r\nnext->bios.timing_20_31_0780 << 17 |\r\nnext->bios.timing_20_31_0078 << 8 |\r\nnext->bios.timing_20_31_0007);\r\nram_mask(fuc, 0x10fec8, 0x00000027, next->bios.timing_20_31_8000 << 5 |\r\nnext->bios.timing_20_31_7000);\r\nram_wr32(fuc, 0x10f090, 0x4000007e);\r\nram_nsec(fuc, 2000);\r\nram_wr32(fuc, 0x10f314, 0x00000001);\r\nram_wr32(fuc, 0x10f310, 0x00000001);\r\nram_wr32(fuc, 0x10f210, 0x80000000);\r\nif (next->bios.ramcfg_11_08_10 && (ram->mode == 2) ) {\r\nu32 temp = ram_mask(fuc, 0x10f294, 0xff000000, 0x24000000);\r\ngk104_ram_train(fuc, 0xbc0e0000, 0xa4010000);\r\nram_nsec(fuc, 1000);\r\nram_wr32(fuc, 0x10f294, temp);\r\n}\r\nram_mask(fuc, mr[3], 0xfff, ram->base.mr[3]);\r\nram_wr32(fuc, mr[0], ram->base.mr[0]);\r\nram_mask(fuc, mr[8], 0xfff, ram->base.mr[8]);\r\nram_nsec(fuc, 1000);\r\nram_mask(fuc, mr[1], 0xfff, ram->base.mr[1]);\r\nram_mask(fuc, mr[5], 0xfff, ram->base.mr[5] & ~0x004);\r\nram_mask(fuc, mr[6], 0xfff, ram->base.mr[6]);\r\nram_mask(fuc, mr[7], 0xfff, ram->base.mr[7]);\r\nif (vc == 0 && ram_have(fuc, gpio2E)) {\r\nu32 temp = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[0]);\r\nif (temp != ram_rd32(fuc, gpio2E)) {\r\nram_wr32(fuc, gpiotrig, 1);\r\nram_nsec(fuc, 20000);\r\n}\r\n}\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\r\nram_wr32(fuc, 0x10f318, 0x00000001);\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\r\nram_nsec(fuc, 1000);\r\nram_nuts(ram, 0x10f200, 0x18808800, 0x00000000, 0x18808800);\r\ndata = ram_rd32(fuc, 0x10f978);\r\ndata &= ~0x00046144;\r\ndata |= 0x0000000b;\r\nif (!next->bios.ramcfg_11_07_08) {\r\nif (!next->bios.ramcfg_11_07_04)\r\ndata |= 0x0000200c;\r\nelse\r\ndata |= 0x00000000;\r\n} else {\r\ndata |= 0x00040044;\r\n}\r\nram_wr32(fuc, 0x10f978, data);\r\nif (ram->mode == 1) {\r\ndata = ram_rd32(fuc, 0x10f830) | 0x00000001;\r\nram_wr32(fuc, 0x10f830, data);\r\n}\r\nif (!next->bios.ramcfg_11_07_08) {\r\ndata = 0x88020000;\r\nif ( next->bios.ramcfg_11_07_04)\r\ndata |= 0x10000000;\r\nif (!next->bios.rammap_11_08_10)\r\ndata |= 0x00080000;\r\n} else {\r\ndata = 0xa40e0000;\r\n}\r\ngk104_ram_train(fuc, 0xbc0f0000, data);\r\nif (1)\r\nram_nsec(fuc, 1000);\r\nif (ram->mode == 2) {\r\nram_mask(fuc, 0x10f800, 0x00000004, 0x00000004);\r\n}\r\nif (ram_mask(fuc, mr[5], 0x004, ram->base.mr[5]) != ram->base.mr[5])\r\nram_nsec(fuc, 1000);\r\nif (ram->mode != 2) {\r\nram_mask(fuc, 0x10f830, 0x01000000, 0x01000000);\r\nram_mask(fuc, 0x10f830, 0x01000000, 0x00000000);\r\n}\r\nif (next->bios.ramcfg_11_07_02)\r\ngk104_ram_train(fuc, 0x80020000, 0x01000000);\r\nram_unblock(fuc);\r\nram_wr32(fuc, 0x62c000, 0x0f0f0f00);\r\nif (next->bios.rammap_11_08_01)\r\ndata = 0x00000800;\r\nelse\r\ndata = 0x00000000;\r\nram_mask(fuc, 0x10f200, 0x00000800, data);\r\nram_nuts(ram, 0x10f200, 0x18808800, data, 0x18808800);\r\nreturn 0;\r\n}\r\nstatic int\r\ngk104_ram_calc_sddr3(struct nvkm_fb *pfb, u32 freq)\r\n{\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct gk104_ramfuc *fuc = &ram->fuc;\r\nconst u32 rcoef = (( ram->P1 << 16) | (ram->N1 << 8) | ram->M1);\r\nconst u32 runk0 = ram->fN1 << 16;\r\nconst u32 runk1 = ram->fN1;\r\nstruct nvkm_ram_data *next = ram->base.next;\r\nint vc = !next->bios.ramcfg_11_02_08;\r\nint mv = !next->bios.ramcfg_11_02_04;\r\nu32 mask, data;\r\nram_mask(fuc, 0x10f808, 0x40000000, 0x40000000);\r\nram_block(fuc);\r\nram_wr32(fuc, 0x62c000, 0x0f0f0000);\r\nif (vc == 1 && ram_have(fuc, gpio2E)) {\r\nu32 temp = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[1]);\r\nif (temp != ram_rd32(fuc, gpio2E)) {\r\nram_wr32(fuc, gpiotrig, 1);\r\nram_nsec(fuc, 20000);\r\n}\r\n}\r\nram_mask(fuc, 0x10f200, 0x00000800, 0x00000000);\r\nif (next->bios.ramcfg_11_03_f0)\r\nram_mask(fuc, 0x10f808, 0x04000000, 0x04000000);\r\nram_wr32(fuc, 0x10f314, 0x00000001);\r\nram_wr32(fuc, 0x10f210, 0x00000000);\r\nram_wr32(fuc, 0x10f310, 0x00000001);\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\r\nram_wr32(fuc, 0x10f310, 0x00000001);\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\r\nram_nsec(fuc, 1000);\r\nram_wr32(fuc, 0x10f090, 0x00000060);\r\nram_wr32(fuc, 0x10f090, 0xc000007e);\r\nmask = 0x00010000;\r\ndata = 0x00010000;\r\nif (1) {\r\nmask |= 0x800807e0;\r\ndata |= 0x800807e0;\r\nswitch (next->bios.ramcfg_11_03_c0) {\r\ncase 3: data &= ~0x00000040; break;\r\ncase 2: data &= ~0x00000100; break;\r\ncase 1: data &= ~0x80000000; break;\r\ncase 0: data &= ~0x00000400; break;\r\n}\r\nswitch (next->bios.ramcfg_11_03_30) {\r\ncase 3: data &= ~0x00000020; break;\r\ncase 2: data &= ~0x00000080; break;\r\ncase 1: data &= ~0x00080000; break;\r\ncase 0: data &= ~0x00000200; break;\r\n}\r\n}\r\nif (next->bios.ramcfg_11_02_80)\r\nmask |= 0x03000000;\r\nif (next->bios.ramcfg_11_02_40)\r\nmask |= 0x00002000;\r\nif (next->bios.ramcfg_11_07_10)\r\nmask |= 0x00004000;\r\nif (next->bios.ramcfg_11_07_08)\r\nmask |= 0x00000003;\r\nelse\r\nmask |= 0x14000000;\r\nram_mask(fuc, 0x10f824, mask, data);\r\nram_mask(fuc, 0x132040, 0x00010000, 0x00000000);\r\nram_mask(fuc, 0x1373f4, 0x00000000, 0x00010010);\r\ndata = ram_rd32(fuc, 0x1373ec) & ~0x00030000;\r\ndata |= next->bios.ramcfg_11_03_30 << 16;\r\nram_wr32(fuc, 0x1373ec, data);\r\nram_mask(fuc, 0x1373f4, 0x00000003, 0x00000000);\r\nram_mask(fuc, 0x1373f4, 0x00000010, 0x00000000);\r\nif ((ram_rd32(fuc, 0x132024) & 0xffffffff) != rcoef ||\r\n(ram_rd32(fuc, 0x132034) & 0x0000ffff) != runk1) {\r\nram_mask(fuc, 0x132000, 0x00000001, 0x00000000);\r\nram_mask(fuc, 0x132020, 0x00000001, 0x00000000);\r\nram_wr32(fuc, 0x137320, 0x00000000);\r\nram_mask(fuc, 0x132030, 0xffff0000, runk0);\r\nram_mask(fuc, 0x132034, 0x0000ffff, runk1);\r\nram_wr32(fuc, 0x132024, rcoef);\r\nram_mask(fuc, 0x132028, 0x00080000, 0x00080000);\r\nram_mask(fuc, 0x132020, 0x00000001, 0x00000001);\r\nram_wait(fuc, 0x137390, 0x00020000, 0x00020000, 64000);\r\nram_mask(fuc, 0x132028, 0x00080000, 0x00000000);\r\n}\r\nram_mask(fuc, 0x1373f4, 0x00000010, 0x00000010);\r\nram_mask(fuc, 0x1373f4, 0x00000003, 0x00000001);\r\nram_mask(fuc, 0x1373f4, 0x00010000, 0x00000000);\r\nif (ram_have(fuc, gpioMV)) {\r\nu32 temp = ram_mask(fuc, gpioMV, 0x3000, fuc->r_funcMV[mv]);\r\nif (temp != ram_rd32(fuc, gpioMV)) {\r\nram_wr32(fuc, gpiotrig, 1);\r\nram_nsec(fuc, 64000);\r\n}\r\n}\r\nif (next->bios.ramcfg_11_02_40 ||\r\nnext->bios.ramcfg_11_07_10) {\r\nram_mask(fuc, 0x132040, 0x00010000, 0x00010000);\r\nram_nsec(fuc, 20000);\r\n}\r\nif (ram->mode != 2) {\r\nif (next->bios.ramcfg_11_07_40)\r\nram_mask(fuc, 0x10f670, 0x80000000, 0x80000000);\r\n}\r\nram_wr32(fuc, 0x10f65c, 0x00000011 * next->bios.rammap_11_11_0c);\r\nram_wr32(fuc, 0x10f6b8, 0x01010101 * next->bios.ramcfg_11_09);\r\nram_wr32(fuc, 0x10f6bc, 0x01010101 * next->bios.ramcfg_11_09);\r\nmask = 0x00010000;\r\ndata = 0x00000000;\r\nif (!next->bios.ramcfg_11_02_80)\r\ndata |= 0x03000000;\r\nif (!next->bios.ramcfg_11_02_40)\r\ndata |= 0x00002000;\r\nif (!next->bios.ramcfg_11_07_10)\r\ndata |= 0x00004000;\r\nif (!next->bios.ramcfg_11_07_08)\r\ndata |= 0x00000003;\r\nelse\r\ndata |= 0x14000000;\r\nram_mask(fuc, 0x10f824, mask, data);\r\nram_nsec(fuc, 1000);\r\nif (next->bios.ramcfg_11_08_01)\r\ndata = 0x00100000;\r\nelse\r\ndata = 0x00000000;\r\nram_mask(fuc, 0x10f82c, 0x00100000, data);\r\nram_mask(fuc, 0x10f248, 0xffffffff, next->bios.timing[10]);\r\nram_mask(fuc, 0x10f290, 0xffffffff, next->bios.timing[0]);\r\nram_mask(fuc, 0x10f294, 0xffffffff, next->bios.timing[1]);\r\nram_mask(fuc, 0x10f298, 0xffffffff, next->bios.timing[2]);\r\nram_mask(fuc, 0x10f29c, 0xffffffff, next->bios.timing[3]);\r\nram_mask(fuc, 0x10f2a0, 0xffffffff, next->bios.timing[4]);\r\nram_mask(fuc, 0x10f2a4, 0xffffffff, next->bios.timing[5]);\r\nram_mask(fuc, 0x10f2a8, 0xffffffff, next->bios.timing[6]);\r\nram_mask(fuc, 0x10f2ac, 0xffffffff, next->bios.timing[7]);\r\nram_mask(fuc, 0x10f2cc, 0xffffffff, next->bios.timing[8]);\r\nram_mask(fuc, 0x10f2e8, 0xffffffff, next->bios.timing[9]);\r\nmask = 0x33f00000;\r\ndata = 0x00000000;\r\nif (!next->bios.ramcfg_11_01_04)\r\ndata |= 0x20200000;\r\nif (!next->bios.ramcfg_11_07_80)\r\ndata |= 0x12800000;\r\nif (next->bios.ramcfg_11_03_f0) {\r\nif (next->bios.rammap_11_08_0c) {\r\nif (!next->bios.ramcfg_11_07_80)\r\nmask |= 0x00000020;\r\nelse\r\ndata |= 0x00000020;\r\nmask |= 0x08000004;\r\n}\r\ndata |= 0x04000000;\r\n} else {\r\nmask |= 0x44000020;\r\ndata |= 0x08000004;\r\n}\r\nram_mask(fuc, 0x10f808, mask, data);\r\nram_wr32(fuc, 0x10f870, 0x11111111 * next->bios.ramcfg_11_03_0f);\r\nram_mask(fuc, 0x10f250, 0x000003f0, next->bios.timing_20_2c_003f << 4);\r\ndata = (next->bios.timing[10] & 0x7f000000) >> 24;\r\nif (data < next->bios.timing_20_2c_1fc0)\r\ndata = next->bios.timing_20_2c_1fc0;\r\nram_mask(fuc, 0x10f24c, 0x7f000000, data << 24);\r\nram_mask(fuc, 0x10f224, 0x001f0000, next->bios.timing_20_30_f8 << 16);\r\nram_wr32(fuc, 0x10f090, 0x4000007f);\r\nram_nsec(fuc, 1000);\r\nram_wr32(fuc, 0x10f314, 0x00000001);\r\nram_wr32(fuc, 0x10f310, 0x00000001);\r\nram_wr32(fuc, 0x10f210, 0x80000000);\r\nram_nsec(fuc, 1000);\r\nram_nuke(fuc, mr[0]);\r\nram_mask(fuc, mr[0], 0x100, 0x100);\r\nram_mask(fuc, mr[0], 0x100, 0x000);\r\nram_mask(fuc, mr[2], 0xfff, ram->base.mr[2]);\r\nram_wr32(fuc, mr[0], ram->base.mr[0]);\r\nram_nsec(fuc, 1000);\r\nram_nuke(fuc, mr[0]);\r\nram_mask(fuc, mr[0], 0x100, 0x100);\r\nram_mask(fuc, mr[0], 0x100, 0x000);\r\nif (vc == 0 && ram_have(fuc, gpio2E)) {\r\nu32 temp = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[0]);\r\nif (temp != ram_rd32(fuc, gpio2E)) {\r\nram_wr32(fuc, gpiotrig, 1);\r\nram_nsec(fuc, 20000);\r\n}\r\n}\r\nif (ram->mode != 2) {\r\nram_mask(fuc, 0x10f830, 0x01000000, 0x01000000);\r\nram_mask(fuc, 0x10f830, 0x01000000, 0x00000000);\r\n}\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\r\nram_wr32(fuc, 0x10f318, 0x00000001);\r\nram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\r\nram_nsec(fuc, 1000);\r\nram_unblock(fuc);\r\nram_wr32(fuc, 0x62c000, 0x0f0f0f00);\r\nif (next->bios.rammap_11_08_01)\r\ndata = 0x00000800;\r\nelse\r\ndata = 0x00000000;\r\nram_mask(fuc, 0x10f200, 0x00000800, data);\r\nreturn 0;\r\n}\r\nstatic int\r\ngk104_ram_calc_data(struct nvkm_fb *pfb, u32 khz, struct nvkm_ram_data *data)\r\n{\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct nvkm_ram_data *cfg;\r\nu32 mhz = khz / 1000;\r\nlist_for_each_entry(cfg, &ram->cfg, head) {\r\nif (mhz >= cfg->bios.rammap_min &&\r\nmhz <= cfg->bios.rammap_max) {\r\n*data = *cfg;\r\ndata->freq = khz;\r\nreturn 0;\r\n}\r\n}\r\nnv_error(ram, "ramcfg data for %dMHz not found\n", mhz);\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\ngk104_ram_calc_xits(struct nvkm_fb *pfb, struct nvkm_ram_data *next)\r\n{\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct gk104_ramfuc *fuc = &ram->fuc;\r\nint refclk, i;\r\nint ret;\r\nret = ram_init(fuc, pfb);\r\nif (ret)\r\nreturn ret;\r\nram->mode = (next->freq > fuc->refpll.vco1.max_freq) ? 2 : 1;\r\nram->from = ram_rd32(fuc, 0x1373f4) & 0x0000000f;\r\nrefclk = next->freq;\r\nif (ram->mode == 2)\r\nrefclk = fuc->mempll.refclk;\r\nret = gt215_pll_calc(nv_subdev(pfb), &fuc->refpll, refclk, &ram->N1,\r\n&ram->fN1, &ram->M1, &ram->P1);\r\nfuc->mempll.refclk = ret;\r\nif (ret <= 0) {\r\nnv_error(pfb, "unable to calc refpll\n");\r\nreturn -EINVAL;\r\n}\r\nif (ram->mode == 2) {\r\nfuc->mempll.min_p = 1;\r\nfuc->mempll.max_p = 2;\r\nret = gt215_pll_calc(nv_subdev(pfb), &fuc->mempll, next->freq,\r\n&ram->N2, NULL, &ram->M2, &ram->P2);\r\nif (ret <= 0) {\r\nnv_error(pfb, "unable to calc mempll\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(fuc->r_mr); i++) {\r\nif (ram_have(fuc, mr[i]))\r\nram->base.mr[i] = ram_rd32(fuc, mr[i]);\r\n}\r\nram->base.freq = next->freq;\r\nswitch (ram->base.type) {\r\ncase NV_MEM_TYPE_DDR3:\r\nret = nvkm_sddr3_calc(&ram->base);\r\nif (ret == 0)\r\nret = gk104_ram_calc_sddr3(pfb, next->freq);\r\nbreak;\r\ncase NV_MEM_TYPE_GDDR5:\r\nret = nvkm_gddr5_calc(&ram->base, ram->pnuts != 0);\r\nif (ret == 0)\r\nret = gk104_ram_calc_gddr5(pfb, next->freq);\r\nbreak;\r\ndefault:\r\nret = -ENOSYS;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\ngk104_ram_calc(struct nvkm_fb *pfb, u32 freq)\r\n{\r\nstruct nvkm_clk *clk = nvkm_clk(pfb);\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct nvkm_ram_data *xits = &ram->base.xition;\r\nstruct nvkm_ram_data *copy;\r\nint ret;\r\nif (ram->base.next == NULL) {\r\nret = gk104_ram_calc_data(pfb, clk->read(clk, nv_clk_src_mem),\r\n&ram->base.former);\r\nif (ret)\r\nreturn ret;\r\nret = gk104_ram_calc_data(pfb, freq, &ram->base.target);\r\nif (ret)\r\nreturn ret;\r\nif (ram->base.target.freq < ram->base.former.freq) {\r\n*xits = ram->base.target;\r\ncopy = &ram->base.former;\r\n} else {\r\n*xits = ram->base.former;\r\ncopy = &ram->base.target;\r\n}\r\nxits->bios.ramcfg_11_02_04 = copy->bios.ramcfg_11_02_04;\r\nxits->bios.ramcfg_11_02_03 = copy->bios.ramcfg_11_02_03;\r\nxits->bios.timing_20_30_07 = copy->bios.timing_20_30_07;\r\nram->base.next = &ram->base.target;\r\nif (memcmp(xits, &ram->base.former, sizeof(xits->bios)))\r\nram->base.next = &ram->base.xition;\r\n} else {\r\nBUG_ON(ram->base.next != &ram->base.xition);\r\nram->base.next = &ram->base.target;\r\n}\r\nreturn gk104_ram_calc_xits(pfb, ram->base.next);\r\n}\r\nstatic void\r\ngk104_ram_prog_0(struct nvkm_fb *pfb, u32 freq)\r\n{\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct nvkm_ram_data *cfg;\r\nu32 mhz = freq / 1000;\r\nu32 mask, data;\r\nlist_for_each_entry(cfg, &ram->cfg, head) {\r\nif (mhz >= cfg->bios.rammap_min &&\r\nmhz <= cfg->bios.rammap_max)\r\nbreak;\r\n}\r\nif (&cfg->head == &ram->cfg)\r\nreturn;\r\nif (mask = 0, data = 0, ram->diff.rammap_11_0a_03fe) {\r\ndata |= cfg->bios.rammap_11_0a_03fe << 12;\r\nmask |= 0x001ff000;\r\n}\r\nif (ram->diff.rammap_11_09_01ff) {\r\ndata |= cfg->bios.rammap_11_09_01ff;\r\nmask |= 0x000001ff;\r\n}\r\nnv_mask(pfb, 0x10f468, mask, data);\r\nif (mask = 0, data = 0, ram->diff.rammap_11_0a_0400) {\r\ndata |= cfg->bios.rammap_11_0a_0400;\r\nmask |= 0x00000001;\r\n}\r\nnv_mask(pfb, 0x10f420, mask, data);\r\nif (mask = 0, data = 0, ram->diff.rammap_11_0a_0800) {\r\ndata |= cfg->bios.rammap_11_0a_0800;\r\nmask |= 0x00000001;\r\n}\r\nnv_mask(pfb, 0x10f430, mask, data);\r\nif (mask = 0, data = 0, ram->diff.rammap_11_0b_01f0) {\r\ndata |= cfg->bios.rammap_11_0b_01f0;\r\nmask |= 0x0000001f;\r\n}\r\nnv_mask(pfb, 0x10f400, mask, data);\r\nif (mask = 0, data = 0, ram->diff.rammap_11_0b_0200) {\r\ndata |= cfg->bios.rammap_11_0b_0200 << 9;\r\nmask |= 0x00000200;\r\n}\r\nnv_mask(pfb, 0x10f410, mask, data);\r\nif (mask = 0, data = 0, ram->diff.rammap_11_0d) {\r\ndata |= cfg->bios.rammap_11_0d << 16;\r\nmask |= 0x00ff0000;\r\n}\r\nif (ram->diff.rammap_11_0f) {\r\ndata |= cfg->bios.rammap_11_0f << 8;\r\nmask |= 0x0000ff00;\r\n}\r\nnv_mask(pfb, 0x10f440, mask, data);\r\nif (mask = 0, data = 0, ram->diff.rammap_11_0e) {\r\ndata |= cfg->bios.rammap_11_0e << 8;\r\nmask |= 0x0000ff00;\r\n}\r\nif (ram->diff.rammap_11_0b_0800) {\r\ndata |= cfg->bios.rammap_11_0b_0800 << 7;\r\nmask |= 0x00000080;\r\n}\r\nif (ram->diff.rammap_11_0b_0400) {\r\ndata |= cfg->bios.rammap_11_0b_0400 << 5;\r\nmask |= 0x00000020;\r\n}\r\nnv_mask(pfb, 0x10f444, mask, data);\r\n}\r\nstatic int\r\ngk104_ram_prog(struct nvkm_fb *pfb)\r\n{\r\nstruct nvkm_device *device = nv_device(pfb);\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct gk104_ramfuc *fuc = &ram->fuc;\r\nstruct nvkm_ram_data *next = ram->base.next;\r\nif (!nvkm_boolopt(device->cfgopt, "NvMemExec", true)) {\r\nram_exec(fuc, false);\r\nreturn (ram->base.next == &ram->base.xition);\r\n}\r\ngk104_ram_prog_0(pfb, 1000);\r\nram_exec(fuc, true);\r\ngk104_ram_prog_0(pfb, next->freq);\r\nreturn (ram->base.next == &ram->base.xition);\r\n}\r\nstatic void\r\ngk104_ram_tidy(struct nvkm_fb *pfb)\r\n{\r\nstruct gk104_ram *ram = (void *)pfb->ram;\r\nstruct gk104_ramfuc *fuc = &ram->fuc;\r\nram->base.next = NULL;\r\nram_exec(fuc, false);\r\n}\r\nstatic int\r\ngk104_ram_train_type(struct nvkm_fb *pfb, int i, u8 ramcfg,\r\nstruct gk104_ram_train *train)\r\n{\r\nstruct nvkm_bios *bios = nvkm_bios(pfb);\r\nstruct nvbios_M0205E M0205E;\r\nstruct nvbios_M0205S M0205S;\r\nstruct nvbios_M0209E M0209E;\r\nstruct nvbios_M0209S *remap = &train->remap;\r\nstruct nvbios_M0209S *value;\r\nu8 ver, hdr, cnt, len;\r\nu32 data;\r\nif (!(data = nvbios_M0205Ep(bios, i, &ver, &hdr, &cnt, &len, &M0205E)))\r\nreturn -ENOENT;\r\nswitch (M0205E.type) {\r\ncase 0x00: value = &train->type00; break;\r\ncase 0x01: value = &train->type01; break;\r\ncase 0x04: value = &train->type04; break;\r\ncase 0x06: value = &train->type06; break;\r\ncase 0x07: value = &train->type07; break;\r\ncase 0x08: value = &train->type08; break;\r\ncase 0x09: value = &train->type09; break;\r\ndefault:\r\nreturn 0;\r\n}\r\nif (!(data = nvbios_M0205Sp(bios, i, ramcfg, &ver, &hdr, &M0205S)))\r\nreturn -EINVAL;\r\ni = M0205S.data;\r\nif (!(data = nvbios_M0209Ep(bios, i, &ver, &hdr, &cnt, &len, &M0209E)))\r\nreturn -EINVAL;\r\nif (!(data = nvbios_M0209Sp(bios, i, 0, &ver, &hdr, value)))\r\nreturn -EINVAL;\r\nif (M0209E.v02_07 == 2) {\r\nif (!(data = nvbios_M0209Sp(bios, M0209E.v03, 0, &ver, &hdr,\r\nremap)))\r\nreturn -EINVAL;\r\nfor (i = 0; i < ARRAY_SIZE(value->data); i++)\r\nvalue->data[i] = remap->data[value->data[i]];\r\n} else\r\nif (M0209E.v02_07 != 1)\r\nreturn -EINVAL;\r\ntrain->mask |= 1 << M0205E.type;\r\nreturn 0;\r\n}\r\nstatic int\r\ngk104_ram_train_init_0(struct nvkm_fb *pfb, struct gk104_ram_train *train)\r\n{\r\nint i, j;\r\nif ((train->mask & 0x03d3) != 0x03d3) {\r\nnv_warn(pfb, "missing link training data\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < 0x30; i++) {\r\nfor (j = 0; j < 8; j += 4) {\r\nnv_wr32(pfb, 0x10f968 + j, 0x00000000 | (i << 8));\r\nnv_wr32(pfb, 0x10f920 + j, 0x00000000 |\r\ntrain->type08.data[i] << 4 |\r\ntrain->type06.data[i]);\r\nnv_wr32(pfb, 0x10f918 + j, train->type00.data[i]);\r\nnv_wr32(pfb, 0x10f920 + j, 0x00000100 |\r\ntrain->type09.data[i] << 4 |\r\ntrain->type07.data[i]);\r\nnv_wr32(pfb, 0x10f918 + j, train->type01.data[i]);\r\n}\r\n}\r\nfor (j = 0; j < 8; j += 4) {\r\nfor (i = 0; i < 0x100; i++) {\r\nnv_wr32(pfb, 0x10f968 + j, i);\r\nnv_wr32(pfb, 0x10f900 + j, train->type04.data[i]);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\ngk104_ram_train_init(struct nvkm_fb *pfb)\r\n{\r\nu8 ramcfg = nvbios_ramcfg_index(nv_subdev(pfb));\r\nstruct gk104_ram_train *train;\r\nint ret = -ENOMEM, i;\r\nif ((train = kzalloc(sizeof(*train), GFP_KERNEL))) {\r\nfor (i = 0; i < 0x100; i++) {\r\nret = gk104_ram_train_type(pfb, i, ramcfg, train);\r\nif (ret && ret != -ENOENT)\r\nbreak;\r\n}\r\n}\r\nswitch (pfb->ram->type) {\r\ncase NV_MEM_TYPE_GDDR5:\r\nret = gk104_ram_train_init_0(pfb, train);\r\nbreak;\r\ndefault:\r\nret = 0;\r\nbreak;\r\n}\r\nkfree(train);\r\nreturn ret;\r\n}\r\nint\r\ngk104_ram_init(struct nvkm_object *object)\r\n{\r\nstruct nvkm_fb *pfb = (void *)object->parent;\r\nstruct gk104_ram *ram = (void *)object;\r\nstruct nvkm_bios *bios = nvkm_bios(pfb);\r\nu8 ver, hdr, cnt, len, snr, ssz;\r\nu32 data, save;\r\nint ret, i;\r\nret = nvkm_ram_init(&ram->base);\r\nif (ret)\r\nreturn ret;\r\ndata = nvbios_rammapTe(bios, &ver, &hdr, &cnt, &len, &snr, &ssz);\r\nif (!data || hdr < 0x15)\r\nreturn -EINVAL;\r\ncnt = nv_ro08(bios, data + 0x14);\r\ndata = nv_ro32(bios, data + 0x10);\r\nsave = nv_rd32(pfb, 0x10f65c) & 0x000000f0;\r\nfor (i = 0; i < cnt; i++, data += 4) {\r\nif (i != save >> 4) {\r\nnv_mask(pfb, 0x10f65c, 0x000000f0, i << 4);\r\nnvbios_exec(&(struct nvbios_init) {\r\n.subdev = nv_subdev(pfb),\r\n.bios = bios,\r\n.offset = nv_ro32(bios, data),\r\n.execute = 1,\r\n});\r\n}\r\n}\r\nnv_mask(pfb, 0x10f65c, 0x000000f0, save);\r\nnv_mask(pfb, 0x10f584, 0x11000000, 0x00000000);\r\nnv_wr32(pfb, 0x10ecc0, 0xffffffff);\r\nnv_mask(pfb, 0x10f160, 0x00000010, 0x00000010);\r\nreturn gk104_ram_train_init(pfb);\r\n}\r\nstatic int\r\ngk104_ram_ctor_data(struct gk104_ram *ram, u8 ramcfg, int i)\r\n{\r\nstruct nvkm_fb *pfb = (void *)nv_object(ram)->parent;\r\nstruct nvkm_bios *bios = nvkm_bios(pfb);\r\nstruct nvkm_ram_data *cfg;\r\nstruct nvbios_ramcfg *d = &ram->diff;\r\nstruct nvbios_ramcfg *p, *n;\r\nu8 ver, hdr, cnt, len;\r\nu32 data;\r\nint ret;\r\nif (!(cfg = kmalloc(sizeof(*cfg), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\np = &list_last_entry(&ram->cfg, typeof(*cfg), head)->bios;\r\nn = &cfg->bios;\r\ndata = nvbios_rammapEp(bios, i, &ver, &hdr, &cnt, &len, &cfg->bios);\r\nif (ret = -ENOENT, !data)\r\ngoto done;\r\nif (ret = -ENOSYS, ver != 0x11 || hdr < 0x12)\r\ngoto done;\r\ndata = nvbios_rammapSp(bios, data, ver, hdr, cnt, len, ramcfg,\r\n&ver, &hdr, &cfg->bios);\r\nif (ret = -EINVAL, !data)\r\ngoto done;\r\nif (ret = -ENOSYS, ver != 0x11 || hdr < 0x0a)\r\ngoto done;\r\nif (cfg->bios.ramcfg_timing != 0xff) {\r\ndata = nvbios_timingEp(bios, cfg->bios.ramcfg_timing,\r\n&ver, &hdr, &cnt, &len,\r\n&cfg->bios);\r\nif (ret = -EINVAL, !data)\r\ngoto done;\r\nif (ret = -ENOSYS, ver != 0x20 || hdr < 0x33)\r\ngoto done;\r\n}\r\nlist_add_tail(&cfg->head, &ram->cfg);\r\nif (ret = 0, i == 0)\r\ngoto done;\r\nd->rammap_11_0a_03fe |= p->rammap_11_0a_03fe != n->rammap_11_0a_03fe;\r\nd->rammap_11_09_01ff |= p->rammap_11_09_01ff != n->rammap_11_09_01ff;\r\nd->rammap_11_0a_0400 |= p->rammap_11_0a_0400 != n->rammap_11_0a_0400;\r\nd->rammap_11_0a_0800 |= p->rammap_11_0a_0800 != n->rammap_11_0a_0800;\r\nd->rammap_11_0b_01f0 |= p->rammap_11_0b_01f0 != n->rammap_11_0b_01f0;\r\nd->rammap_11_0b_0200 |= p->rammap_11_0b_0200 != n->rammap_11_0b_0200;\r\nd->rammap_11_0d |= p->rammap_11_0d != n->rammap_11_0d;\r\nd->rammap_11_0f |= p->rammap_11_0f != n->rammap_11_0f;\r\nd->rammap_11_0e |= p->rammap_11_0e != n->rammap_11_0e;\r\nd->rammap_11_0b_0800 |= p->rammap_11_0b_0800 != n->rammap_11_0b_0800;\r\nd->rammap_11_0b_0400 |= p->rammap_11_0b_0400 != n->rammap_11_0b_0400;\r\nd->ramcfg_11_01_01 |= p->ramcfg_11_01_01 != n->ramcfg_11_01_01;\r\nd->ramcfg_11_01_02 |= p->ramcfg_11_01_02 != n->ramcfg_11_01_02;\r\nd->ramcfg_11_01_10 |= p->ramcfg_11_01_10 != n->ramcfg_11_01_10;\r\nd->ramcfg_11_02_03 |= p->ramcfg_11_02_03 != n->ramcfg_11_02_03;\r\nd->ramcfg_11_08_20 |= p->ramcfg_11_08_20 != n->ramcfg_11_08_20;\r\nd->timing_20_30_07 |= p->timing_20_30_07 != n->timing_20_30_07;\r\ndone:\r\nif (ret)\r\nkfree(cfg);\r\nreturn ret;\r\n}\r\nstatic void\r\ngk104_ram_dtor(struct nvkm_object *object)\r\n{\r\nstruct gk104_ram *ram = (void *)object;\r\nstruct nvkm_ram_data *cfg, *tmp;\r\nlist_for_each_entry_safe(cfg, tmp, &ram->cfg, head) {\r\nkfree(cfg);\r\n}\r\nnvkm_ram_destroy(&ram->base);\r\n}\r\nstatic int\r\ngk104_ram_ctor(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nstruct nvkm_fb *pfb = nvkm_fb(parent);\r\nstruct nvkm_bios *bios = nvkm_bios(pfb);\r\nstruct nvkm_gpio *gpio = nvkm_gpio(pfb);\r\nstruct dcb_gpio_func func;\r\nstruct gk104_ram *ram;\r\nint ret, i;\r\nu8 ramcfg = nvbios_ramcfg_index(nv_subdev(pfb));\r\nu32 tmp;\r\nret = gf100_ram_create(parent, engine, oclass, 0x022554, &ram);\r\n*pobject = nv_object(ram);\r\nif (ret)\r\nreturn ret;\r\nINIT_LIST_HEAD(&ram->cfg);\r\nswitch (ram->base.type) {\r\ncase NV_MEM_TYPE_DDR3:\r\ncase NV_MEM_TYPE_GDDR5:\r\nram->base.calc = gk104_ram_calc;\r\nram->base.prog = gk104_ram_prog;\r\nram->base.tidy = gk104_ram_tidy;\r\nbreak;\r\ndefault:\r\nnv_warn(pfb, "reclocking of this RAM type is unsupported\n");\r\nbreak;\r\n}\r\nram->parts = nv_rd32(pfb, 0x022438);\r\nram->pmask = nv_rd32(pfb, 0x022554);\r\nram->pnuts = 0;\r\nfor (i = 0, tmp = 0; i < ram->parts; i++) {\r\nif (!(ram->pmask & (1 << i))) {\r\nu32 cfg1 = nv_rd32(pfb, 0x110204 + (i * 0x1000));\r\nif (tmp && tmp != cfg1) {\r\nram->pnuts |= (1 << i);\r\ncontinue;\r\n}\r\ntmp = cfg1;\r\n}\r\n}\r\nfor (i = 0; !ret; i++) {\r\nret = gk104_ram_ctor_data(ram, ramcfg, i);\r\nif (ret && ret != -ENOENT) {\r\nnv_error(pfb, "failed to parse ramcfg data\n");\r\nreturn ret;\r\n}\r\n}\r\nret = nvbios_pll_parse(bios, 0x0c, &ram->fuc.refpll);\r\nif (ret) {\r\nnv_error(pfb, "mclk refpll data not found\n");\r\nreturn ret;\r\n}\r\nret = nvbios_pll_parse(bios, 0x04, &ram->fuc.mempll);\r\nif (ret) {\r\nnv_error(pfb, "mclk pll data not found\n");\r\nreturn ret;\r\n}\r\nret = gpio->find(gpio, 0, 0x18, DCB_GPIO_UNUSED, &func);\r\nif (ret == 0) {\r\nram->fuc.r_gpioMV = ramfuc_reg(0x00d610 + (func.line * 0x04));\r\nram->fuc.r_funcMV[0] = (func.log[0] ^ 2) << 12;\r\nram->fuc.r_funcMV[1] = (func.log[1] ^ 2) << 12;\r\n}\r\nret = gpio->find(gpio, 0, 0x2e, DCB_GPIO_UNUSED, &func);\r\nif (ret == 0) {\r\nram->fuc.r_gpio2E = ramfuc_reg(0x00d610 + (func.line * 0x04));\r\nram->fuc.r_func2E[0] = (func.log[0] ^ 2) << 12;\r\nram->fuc.r_func2E[1] = (func.log[1] ^ 2) << 12;\r\n}\r\nram->fuc.r_gpiotrig = ramfuc_reg(0x00d604);\r\nram->fuc.r_0x132020 = ramfuc_reg(0x132020);\r\nram->fuc.r_0x132028 = ramfuc_reg(0x132028);\r\nram->fuc.r_0x132024 = ramfuc_reg(0x132024);\r\nram->fuc.r_0x132030 = ramfuc_reg(0x132030);\r\nram->fuc.r_0x132034 = ramfuc_reg(0x132034);\r\nram->fuc.r_0x132000 = ramfuc_reg(0x132000);\r\nram->fuc.r_0x132004 = ramfuc_reg(0x132004);\r\nram->fuc.r_0x132040 = ramfuc_reg(0x132040);\r\nram->fuc.r_0x10f248 = ramfuc_reg(0x10f248);\r\nram->fuc.r_0x10f290 = ramfuc_reg(0x10f290);\r\nram->fuc.r_0x10f294 = ramfuc_reg(0x10f294);\r\nram->fuc.r_0x10f298 = ramfuc_reg(0x10f298);\r\nram->fuc.r_0x10f29c = ramfuc_reg(0x10f29c);\r\nram->fuc.r_0x10f2a0 = ramfuc_reg(0x10f2a0);\r\nram->fuc.r_0x10f2a4 = ramfuc_reg(0x10f2a4);\r\nram->fuc.r_0x10f2a8 = ramfuc_reg(0x10f2a8);\r\nram->fuc.r_0x10f2ac = ramfuc_reg(0x10f2ac);\r\nram->fuc.r_0x10f2cc = ramfuc_reg(0x10f2cc);\r\nram->fuc.r_0x10f2e8 = ramfuc_reg(0x10f2e8);\r\nram->fuc.r_0x10f250 = ramfuc_reg(0x10f250);\r\nram->fuc.r_0x10f24c = ramfuc_reg(0x10f24c);\r\nram->fuc.r_0x10fec4 = ramfuc_reg(0x10fec4);\r\nram->fuc.r_0x10fec8 = ramfuc_reg(0x10fec8);\r\nram->fuc.r_0x10f604 = ramfuc_reg(0x10f604);\r\nram->fuc.r_0x10f614 = ramfuc_reg(0x10f614);\r\nram->fuc.r_0x10f610 = ramfuc_reg(0x10f610);\r\nram->fuc.r_0x100770 = ramfuc_reg(0x100770);\r\nram->fuc.r_0x100778 = ramfuc_reg(0x100778);\r\nram->fuc.r_0x10f224 = ramfuc_reg(0x10f224);\r\nram->fuc.r_0x10f870 = ramfuc_reg(0x10f870);\r\nram->fuc.r_0x10f698 = ramfuc_reg(0x10f698);\r\nram->fuc.r_0x10f694 = ramfuc_reg(0x10f694);\r\nram->fuc.r_0x10f6b8 = ramfuc_reg(0x10f6b8);\r\nram->fuc.r_0x10f808 = ramfuc_reg(0x10f808);\r\nram->fuc.r_0x10f670 = ramfuc_reg(0x10f670);\r\nram->fuc.r_0x10f60c = ramfuc_reg(0x10f60c);\r\nram->fuc.r_0x10f830 = ramfuc_reg(0x10f830);\r\nram->fuc.r_0x1373ec = ramfuc_reg(0x1373ec);\r\nram->fuc.r_0x10f800 = ramfuc_reg(0x10f800);\r\nram->fuc.r_0x10f82c = ramfuc_reg(0x10f82c);\r\nram->fuc.r_0x10f978 = ramfuc_reg(0x10f978);\r\nram->fuc.r_0x10f910 = ramfuc_reg(0x10f910);\r\nram->fuc.r_0x10f914 = ramfuc_reg(0x10f914);\r\nswitch (ram->base.type) {\r\ncase NV_MEM_TYPE_GDDR5:\r\nram->fuc.r_mr[0] = ramfuc_reg(0x10f300);\r\nram->fuc.r_mr[1] = ramfuc_reg(0x10f330);\r\nram->fuc.r_mr[2] = ramfuc_reg(0x10f334);\r\nram->fuc.r_mr[3] = ramfuc_reg(0x10f338);\r\nram->fuc.r_mr[4] = ramfuc_reg(0x10f33c);\r\nram->fuc.r_mr[5] = ramfuc_reg(0x10f340);\r\nram->fuc.r_mr[6] = ramfuc_reg(0x10f344);\r\nram->fuc.r_mr[7] = ramfuc_reg(0x10f348);\r\nram->fuc.r_mr[8] = ramfuc_reg(0x10f354);\r\nram->fuc.r_mr[15] = ramfuc_reg(0x10f34c);\r\nbreak;\r\ncase NV_MEM_TYPE_DDR3:\r\nram->fuc.r_mr[0] = ramfuc_reg(0x10f300);\r\nram->fuc.r_mr[2] = ramfuc_reg(0x10f320);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nram->fuc.r_0x62c000 = ramfuc_reg(0x62c000);\r\nram->fuc.r_0x10f200 = ramfuc_reg(0x10f200);\r\nram->fuc.r_0x10f210 = ramfuc_reg(0x10f210);\r\nram->fuc.r_0x10f310 = ramfuc_reg(0x10f310);\r\nram->fuc.r_0x10f314 = ramfuc_reg(0x10f314);\r\nram->fuc.r_0x10f318 = ramfuc_reg(0x10f318);\r\nram->fuc.r_0x10f090 = ramfuc_reg(0x10f090);\r\nram->fuc.r_0x10f69c = ramfuc_reg(0x10f69c);\r\nram->fuc.r_0x10f824 = ramfuc_reg(0x10f824);\r\nram->fuc.r_0x1373f0 = ramfuc_reg(0x1373f0);\r\nram->fuc.r_0x1373f4 = ramfuc_reg(0x1373f4);\r\nram->fuc.r_0x137320 = ramfuc_reg(0x137320);\r\nram->fuc.r_0x10f65c = ramfuc_reg(0x10f65c);\r\nram->fuc.r_0x10f6bc = ramfuc_reg(0x10f6bc);\r\nram->fuc.r_0x100710 = ramfuc_reg(0x100710);\r\nram->fuc.r_0x100750 = ramfuc_reg(0x100750);\r\nreturn 0;\r\n}

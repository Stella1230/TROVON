static int apci3501_config_insn_timer(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci3501_private *devpriv = dev->private;\r\nunsigned int ul_Command1 = 0;\r\ndevpriv->tsk_Current = current;\r\nif (data[0] == ADDIDATA_WATCHDOG) {\r\ndevpriv->b_TimerSelectMode = ADDIDATA_WATCHDOG;\r\noutl(0x0, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nif (data[1] == 1) {\r\noutl(0x02, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n} else {\r\noutl(0x0, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n}\r\noutl(data[2], dev->iobase + APCI3501_TIMER_TIMEBASE_REG);\r\noutl(data[3], dev->iobase + APCI3501_TIMER_RELOAD_REG);\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG) | 0xFFF819E0UL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n}\r\nelse if (data[0] == ADDIDATA_TIMER) {\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 = ul_Command1 & 0xFFFFF9FEUL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\ndevpriv->b_TimerSelectMode = ADDIDATA_TIMER;\r\nif (data[1] == 1) {\r\noutl(0x02, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n} else {\r\noutl(0x0, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n}\r\noutl(data[2], dev->iobase + APCI3501_TIMER_TIMEBASE_REG);\r\noutl(data[3], dev->iobase + APCI3501_TIMER_RELOAD_REG);\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 =\r\n(ul_Command1 & 0xFFF719E2UL) | 2UL << 13UL | 0x10UL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci3501_write_insn_timer(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci3501_private *devpriv = dev->private;\r\nunsigned int ul_Command1 = 0;\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_WATCHDOG) {\r\nif (data[1] == 1) {\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x1UL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n} else if (data[1] == 0) {\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 = ul_Command1 & 0xFFFFF9FEUL;\r\noutl(0x0, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n} else if (data[1] == 2) {\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x200UL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n}\r\n}\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_TIMER) {\r\nif (data[1] == 1) {\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x1UL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n} else if (data[1] == 0) {\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 = ul_Command1 & 0xFFFFF9FEUL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n}\r\nelse if (data[1] == 2) {\r\nul_Command1 = inl(dev->iobase + APCI3501_TIMER_CTRL_REG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x200UL;\r\noutl(ul_Command1, dev->iobase + APCI3501_TIMER_CTRL_REG);\r\n}\r\n}\r\ninl(dev->iobase + APCI3501_TIMER_STATUS_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci3501_read_insn_timer(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci3501_private *devpriv = dev->private;\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_WATCHDOG) {\r\ndata[0] = inl(dev->iobase + APCI3501_TIMER_STATUS_REG) & 0x1;\r\ndata[1] = inl(dev->iobase + APCI3501_TIMER_SYNC_REG);\r\n}\r\nelse if (devpriv->b_TimerSelectMode == ADDIDATA_TIMER) {\r\ndata[0] = inl(dev->iobase + APCI3501_TIMER_STATUS_REG) & 0x1;\r\ndata[1] = inl(dev->iobase + APCI3501_TIMER_SYNC_REG);\r\n}\r\nelse if ((devpriv->b_TimerSelectMode != ADDIDATA_TIMER)\r\n&& (devpriv->b_TimerSelectMode != ADDIDATA_WATCHDOG)) {\r\ndev_err(dev->class_dev, "Invalid subdevice.\n");\r\n}\r\nreturn insn->n;\r\n}

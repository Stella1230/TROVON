int adf_put_admin_msg_sync(struct adf_accel_dev *accel_dev,\r\nuint32_t ae, void *in, void *out)\r\n{\r\nstruct adf_admin_comms *admin = accel_dev->admin;\r\nint offset = ae * ADF_ADMINMSG_LEN * 2;\r\nvoid __iomem *mailbox = admin->mailbox_addr;\r\nint mb_offset = ae * ADF_DH895XCC_MAILBOX_STRIDE;\r\nint times, received;\r\nmutex_lock(&admin->lock);\r\nif (ADF_CSR_RD(mailbox, mb_offset) == 1) {\r\nmutex_unlock(&admin->lock);\r\nreturn -EAGAIN;\r\n}\r\nmemcpy(admin->virt_addr + offset, in, ADF_ADMINMSG_LEN);\r\nADF_CSR_WR(mailbox, mb_offset, 1);\r\nreceived = 0;\r\nfor (times = 0; times < 50; times++) {\r\nmsleep(20);\r\nif (ADF_CSR_RD(mailbox, mb_offset) == 0) {\r\nreceived = 1;\r\nbreak;\r\n}\r\n}\r\nif (received)\r\nmemcpy(out, admin->virt_addr + offset +\r\nADF_ADMINMSG_LEN, ADF_ADMINMSG_LEN);\r\nelse\r\ndev_err(&GET_DEV(accel_dev),\r\n"Failed to send admin msg to accelerator\n");\r\nmutex_unlock(&admin->lock);\r\nreturn received ? 0 : -EFAULT;\r\n}\r\nint adf_init_admin_comms(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_admin_comms *admin;\r\nstruct adf_bar *pmisc = &GET_BARS(accel_dev)[ADF_DH895XCC_PMISC_BAR];\r\nvoid __iomem *csr = pmisc->virt_addr;\r\nvoid __iomem *mailbox = csr + ADF_DH895XCC_MAILBOX_BASE_OFFSET;\r\nuint64_t reg_val;\r\nadmin = kzalloc_node(sizeof(*accel_dev->admin), GFP_KERNEL,\r\ndev_to_node(&GET_DEV(accel_dev)));\r\nif (!admin)\r\nreturn -ENOMEM;\r\nadmin->virt_addr = dma_zalloc_coherent(&GET_DEV(accel_dev), PAGE_SIZE,\r\n&admin->phy_addr, GFP_KERNEL);\r\nif (!admin->virt_addr) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to allocate dma buff\n");\r\nkfree(admin);\r\nreturn -ENOMEM;\r\n}\r\nreg_val = (uint64_t)admin->phy_addr;\r\nADF_CSR_WR(csr, ADF_DH895XCC_ADMINMSGUR_OFFSET, reg_val >> 32);\r\nADF_CSR_WR(csr, ADF_DH895XCC_ADMINMSGLR_OFFSET, reg_val);\r\nmutex_init(&admin->lock);\r\nadmin->mailbox_addr = mailbox;\r\naccel_dev->admin = admin;\r\nreturn 0;\r\n}\r\nvoid adf_exit_admin_comms(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_admin_comms *admin = accel_dev->admin;\r\nif (!admin)\r\nreturn;\r\nif (admin->virt_addr)\r\ndma_free_coherent(&GET_DEV(accel_dev), PAGE_SIZE,\r\nadmin->virt_addr, admin->phy_addr);\r\nmutex_destroy(&admin->lock);\r\nkfree(admin);\r\naccel_dev->admin = NULL;\r\n}

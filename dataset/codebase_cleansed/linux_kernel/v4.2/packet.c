int sndpkt(int devId, int channel, int ack, struct sk_buff *data)\r\n{\r\nLLData ReqLnkWrite;\r\nint status;\r\nint card;\r\nunsigned long len;\r\ncard = get_card_from_id(devId);\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\npr_debug("%s: sndpkt: frst = 0x%lx nxt = %d f = %d n = %d\n",\r\nsc_adapter[card]->devicename,\r\nsc_adapter[card]->channel[channel].first_sendbuf,\r\nsc_adapter[card]->channel[channel].next_sendbuf,\r\nsc_adapter[card]->channel[channel].free_sendbufs,\r\nsc_adapter[card]->channel[channel].num_sendbufs);\r\nif (!sc_adapter[card]->channel[channel].free_sendbufs) {\r\npr_debug("%s: out of TX buffers\n",\r\nsc_adapter[card]->devicename);\r\nreturn -EINVAL;\r\n}\r\nif (data->len > BUFFER_SIZE) {\r\npr_debug("%s: data overflows buffer size (data > buffer)\n",\r\nsc_adapter[card]->devicename);\r\nreturn -EINVAL;\r\n}\r\nReqLnkWrite.buff_offset = sc_adapter[card]->channel[channel].next_sendbuf *\r\nBUFFER_SIZE + sc_adapter[card]->channel[channel].first_sendbuf;\r\nReqLnkWrite.msg_len = data->len;\r\npr_debug("%s: writing %d bytes to buffer offset 0x%lx\n",\r\nsc_adapter[card]->devicename,\r\nReqLnkWrite.msg_len, ReqLnkWrite.buff_offset);\r\nmemcpy_toshmem(card, (char *)ReqLnkWrite.buff_offset, data->data, ReqLnkWrite.msg_len);\r\npr_debug("%s: sndpkt size=%d, buf_offset=0x%lx buf_indx=%d\n",\r\nsc_adapter[card]->devicename,\r\nReqLnkWrite.msg_len, ReqLnkWrite.buff_offset,\r\nsc_adapter[card]->channel[channel].next_sendbuf);\r\nstatus = sendmessage(card, CEPID, ceReqTypeLnk, ceReqClass1, ceReqLnkWrite,\r\nchannel + 1, sizeof(LLData), (unsigned int *)&ReqLnkWrite);\r\nlen = data->len;\r\nif (status) {\r\npr_debug("%s: failed to send packet, status = %d\n",\r\nsc_adapter[card]->devicename, status);\r\nreturn -1;\r\n}\r\nelse {\r\nsc_adapter[card]->channel[channel].free_sendbufs--;\r\nsc_adapter[card]->channel[channel].next_sendbuf =\r\n++sc_adapter[card]->channel[channel].next_sendbuf ==\r\nsc_adapter[card]->channel[channel].num_sendbufs ? 0 :\r\nsc_adapter[card]->channel[channel].next_sendbuf;\r\npr_debug("%s: packet sent successfully\n", sc_adapter[card]->devicename);\r\ndev_kfree_skb(data);\r\nindicate_status(card, ISDN_STAT_BSENT, channel, (char *)&len);\r\n}\r\nreturn len;\r\n}\r\nvoid rcvpkt(int card, RspMessage *rcvmsg)\r\n{\r\nLLData newll;\r\nstruct sk_buff *skb;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("invalid param: %d is not a valid card id\n", card);\r\nreturn;\r\n}\r\nswitch (rcvmsg->rsp_status) {\r\ncase 0x01:\r\ncase 0x02:\r\ncase 0x70:\r\npr_debug("%s: error status code: 0x%x\n",\r\nsc_adapter[card]->devicename, rcvmsg->rsp_status);\r\nreturn;\r\ncase 0x00:\r\nif (!(skb = dev_alloc_skb(rcvmsg->msg_data.response.msg_len))) {\r\nprintk(KERN_WARNING "%s: rcvpkt out of memory, dropping packet\n",\r\nsc_adapter[card]->devicename);\r\nreturn;\r\n}\r\nskb_put(skb, rcvmsg->msg_data.response.msg_len);\r\npr_debug("%s: getting data from offset: 0x%lx\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg->msg_data.response.buff_offset);\r\nmemcpy_fromshmem(card,\r\nskb_put(skb, rcvmsg->msg_data.response.msg_len),\r\n(char *)rcvmsg->msg_data.response.buff_offset,\r\nrcvmsg->msg_data.response.msg_len);\r\nsc_adapter[card]->card->rcvcallb_skb(sc_adapter[card]->driverId,\r\nrcvmsg->phy_link_no - 1, skb);\r\ncase 0x03:\r\npr_debug("%s: buffer size : %d\n",\r\nsc_adapter[card]->devicename, BUFFER_SIZE);\r\nnewll.buff_offset = rcvmsg->msg_data.response.buff_offset;\r\nnewll.msg_len = BUFFER_SIZE;\r\npr_debug("%s: recycled buffer at offset 0x%lx size %d\n",\r\nsc_adapter[card]->devicename,\r\nnewll.buff_offset, newll.msg_len);\r\nsendmessage(card, CEPID, ceReqTypeLnk, ceReqClass1, ceReqLnkRead,\r\nrcvmsg->phy_link_no, sizeof(LLData), (unsigned int *)&newll);\r\n}\r\n}\r\nint setup_buffers(int card, int c)\r\n{\r\nunsigned int nBuffers, i, cBase;\r\nunsigned int buffer_size;\r\nLLData RcvBuffOffset;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\npr_debug("%s: setting up channel buffer space in shared RAM\n",\r\nsc_adapter[card]->devicename);\r\nbuffer_size = BUFFER_SIZE;\r\nnBuffers = ((sc_adapter[card]->ramsize - BUFFER_BASE) / buffer_size) / 2;\r\nnBuffers = nBuffers > BUFFERS_MAX ? BUFFERS_MAX : nBuffers;\r\npr_debug("%s: calculating buffer space: %d buffers, %d big\n",\r\nsc_adapter[card]->devicename,\r\nnBuffers, buffer_size);\r\nif (nBuffers < 2) {\r\npr_debug("%s: not enough buffer space\n",\r\nsc_adapter[card]->devicename);\r\nreturn -1;\r\n}\r\ncBase = (nBuffers * buffer_size) * (c - 1);\r\npr_debug("%s: channel buffer offset from shared RAM: 0x%x\n",\r\nsc_adapter[card]->devicename, cBase);\r\nsc_adapter[card]->channel[c - 1].first_sendbuf = BUFFER_BASE + cBase;\r\nsc_adapter[card]->channel[c - 1].num_sendbufs = nBuffers / 2;\r\nsc_adapter[card]->channel[c - 1].free_sendbufs = nBuffers / 2;\r\nsc_adapter[card]->channel[c - 1].next_sendbuf = 0;\r\npr_debug("%s: send buffer setup complete: first=0x%lx n=%d f=%d, nxt=%d\n",\r\nsc_adapter[card]->devicename,\r\nsc_adapter[card]->channel[c - 1].first_sendbuf,\r\nsc_adapter[card]->channel[c - 1].num_sendbufs,\r\nsc_adapter[card]->channel[c - 1].free_sendbufs,\r\nsc_adapter[card]->channel[c - 1].next_sendbuf);\r\npr_debug("%s: adding %d RecvBuffers:\n",\r\nsc_adapter[card]->devicename, nBuffers / 2);\r\nfor (i = 0; i < nBuffers / 2; i++) {\r\nRcvBuffOffset.buff_offset =\r\n((sc_adapter[card]->channel[c - 1].first_sendbuf +\r\n(nBuffers / 2) * buffer_size) + (buffer_size * i));\r\nRcvBuffOffset.msg_len = buffer_size;\r\npr_debug("%s: adding RcvBuffer #%d offset=0x%lx sz=%d bufsz:%d\n",\r\nsc_adapter[card]->devicename,\r\ni + 1, RcvBuffOffset.buff_offset,\r\nRcvBuffOffset.msg_len, buffer_size);\r\nsendmessage(card, CEPID, ceReqTypeLnk, ceReqClass1, ceReqLnkRead,\r\nc, sizeof(LLData), (unsigned int *)&RcvBuffOffset);\r\n}\r\nreturn 0;\r\n}

static void xspi_write32(u32 val, void __iomem *addr)\r\n{\r\niowrite32(val, addr);\r\n}\r\nstatic unsigned int xspi_read32(void __iomem *addr)\r\n{\r\nreturn ioread32(addr);\r\n}\r\nstatic void xspi_write32_be(u32 val, void __iomem *addr)\r\n{\r\niowrite32be(val, addr);\r\n}\r\nstatic unsigned int xspi_read32_be(void __iomem *addr)\r\n{\r\nreturn ioread32be(addr);\r\n}\r\nstatic void xilinx_spi_tx(struct xilinx_spi *xspi)\r\n{\r\nu32 data = 0;\r\nif (!xspi->tx_ptr) {\r\nxspi->write_fn(0, xspi->regs + XSPI_TXD_OFFSET);\r\nreturn;\r\n}\r\nswitch (xspi->bytes_per_word) {\r\ncase 1:\r\ndata = *(u8 *)(xspi->tx_ptr);\r\nbreak;\r\ncase 2:\r\ndata = *(u16 *)(xspi->tx_ptr);\r\nbreak;\r\ncase 4:\r\ndata = *(u32 *)(xspi->tx_ptr);\r\nbreak;\r\n}\r\nxspi->write_fn(data, xspi->regs + XSPI_TXD_OFFSET);\r\nxspi->tx_ptr += xspi->bytes_per_word;\r\n}\r\nstatic void xilinx_spi_rx(struct xilinx_spi *xspi)\r\n{\r\nu32 data = xspi->read_fn(xspi->regs + XSPI_RXD_OFFSET);\r\nif (!xspi->rx_ptr)\r\nreturn;\r\nswitch (xspi->bytes_per_word) {\r\ncase 1:\r\n*(u8 *)(xspi->rx_ptr) = data;\r\nbreak;\r\ncase 2:\r\n*(u16 *)(xspi->rx_ptr) = data;\r\nbreak;\r\ncase 4:\r\n*(u32 *)(xspi->rx_ptr) = data;\r\nbreak;\r\n}\r\nxspi->rx_ptr += xspi->bytes_per_word;\r\n}\r\nstatic void xspi_init_hw(struct xilinx_spi *xspi)\r\n{\r\nvoid __iomem *regs_base = xspi->regs;\r\nxspi->write_fn(XIPIF_V123B_RESET_MASK,\r\nregs_base + XIPIF_V123B_RESETR_OFFSET);\r\nxspi->write_fn(XSPI_INTR_TX_EMPTY,\r\nregs_base + XIPIF_V123B_IIER_OFFSET);\r\nxspi->write_fn(0, regs_base + XIPIF_V123B_DGIER_OFFSET);\r\nxspi->write_fn(0xffff, regs_base + XSPI_SSR_OFFSET);\r\nxspi->write_fn(XSPI_CR_MANUAL_SSELECT | XSPI_CR_MASTER_MODE |\r\nXSPI_CR_ENABLE | XSPI_CR_TXFIFO_RESET | XSPI_CR_RXFIFO_RESET,\r\nregs_base + XSPI_CR_OFFSET);\r\n}\r\nstatic void xilinx_spi_chipselect(struct spi_device *spi, int is_on)\r\n{\r\nstruct xilinx_spi *xspi = spi_master_get_devdata(spi->master);\r\nu16 cr;\r\nu32 cs;\r\nif (is_on == BITBANG_CS_INACTIVE) {\r\nxspi->write_fn(xspi->cs_inactive, xspi->regs + XSPI_SSR_OFFSET);\r\nreturn;\r\n}\r\ncr = xspi->read_fn(xspi->regs + XSPI_CR_OFFSET) & ~XSPI_CR_MODE_MASK;\r\nif (spi->mode & SPI_CPHA)\r\ncr |= XSPI_CR_CPHA;\r\nif (spi->mode & SPI_CPOL)\r\ncr |= XSPI_CR_CPOL;\r\nif (spi->mode & SPI_LSB_FIRST)\r\ncr |= XSPI_CR_LSB_FIRST;\r\nif (spi->mode & SPI_LOOP)\r\ncr |= XSPI_CR_LOOP;\r\nxspi->write_fn(cr, xspi->regs + XSPI_CR_OFFSET);\r\ncs = xspi->cs_inactive;\r\ncs ^= BIT(spi->chip_select);\r\nxspi->write_fn(cs, xspi->regs + XSPI_SSR_OFFSET);\r\n}\r\nstatic int xilinx_spi_setup_transfer(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nstruct xilinx_spi *xspi = spi_master_get_devdata(spi->master);\r\nif (spi->mode & SPI_CS_HIGH)\r\nxspi->cs_inactive &= ~BIT(spi->chip_select);\r\nelse\r\nxspi->cs_inactive |= BIT(spi->chip_select);\r\nreturn 0;\r\n}\r\nstatic int xilinx_spi_txrx_bufs(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct xilinx_spi *xspi = spi_master_get_devdata(spi->master);\r\nint remaining_words;\r\nbool use_irq = false;\r\nu16 cr = 0;\r\nxspi->tx_ptr = t->tx_buf;\r\nxspi->rx_ptr = t->rx_buf;\r\nremaining_words = t->len / xspi->bytes_per_word;\r\nreinit_completion(&xspi->done);\r\nif (xspi->irq >= 0 && remaining_words > xspi->buffer_size) {\r\nuse_irq = true;\r\nxspi->write_fn(XSPI_INTR_TX_EMPTY,\r\nxspi->regs + XIPIF_V123B_IISR_OFFSET);\r\nxspi->write_fn(XIPIF_V123B_GINTR_ENABLE,\r\nxspi->regs + XIPIF_V123B_DGIER_OFFSET);\r\ncr = xspi->read_fn(xspi->regs + XSPI_CR_OFFSET);\r\nxspi->write_fn(cr | XSPI_CR_TRANS_INHIBIT,\r\nxspi->regs + XSPI_CR_OFFSET);\r\n}\r\nwhile (remaining_words) {\r\nint n_words, tx_words, rx_words;\r\nn_words = min(remaining_words, xspi->buffer_size);\r\ntx_words = n_words;\r\nwhile (tx_words--)\r\nxilinx_spi_tx(xspi);\r\nif (use_irq) {\r\nxspi->write_fn(cr, xspi->regs + XSPI_CR_OFFSET);\r\nwait_for_completion(&xspi->done);\r\n} else\r\nwhile (!(xspi->read_fn(xspi->regs + XSPI_SR_OFFSET) &\r\nXSPI_SR_TX_EMPTY_MASK))\r\n;\r\nif (use_irq)\r\nxspi->write_fn(cr | XSPI_CR_TRANS_INHIBIT,\r\nxspi->regs + XSPI_CR_OFFSET);\r\nrx_words = n_words;\r\nwhile (rx_words--)\r\nxilinx_spi_rx(xspi);\r\nremaining_words -= n_words;\r\n}\r\nif (use_irq)\r\nxspi->write_fn(0, xspi->regs + XIPIF_V123B_DGIER_OFFSET);\r\nreturn t->len;\r\n}\r\nstatic irqreturn_t xilinx_spi_irq(int irq, void *dev_id)\r\n{\r\nstruct xilinx_spi *xspi = dev_id;\r\nu32 ipif_isr;\r\nipif_isr = xspi->read_fn(xspi->regs + XIPIF_V123B_IISR_OFFSET);\r\nxspi->write_fn(ipif_isr, xspi->regs + XIPIF_V123B_IISR_OFFSET);\r\nif (ipif_isr & XSPI_INTR_TX_EMPTY) {\r\ncomplete(&xspi->done);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int xilinx_spi_find_buffer_size(struct xilinx_spi *xspi)\r\n{\r\nu8 sr;\r\nint n_words = 0;\r\nxspi->write_fn(XIPIF_V123B_RESET_MASK,\r\nxspi->regs + XIPIF_V123B_RESETR_OFFSET);\r\ndo {\r\nxspi->write_fn(0, xspi->regs + XSPI_TXD_OFFSET);\r\nsr = xspi->read_fn(xspi->regs + XSPI_SR_OFFSET);\r\nn_words++;\r\n} while (!(sr & XSPI_SR_TX_FULL_MASK));\r\nreturn n_words;\r\n}\r\nstatic int xilinx_spi_probe(struct platform_device *pdev)\r\n{\r\nstruct xilinx_spi *xspi;\r\nstruct xspi_platform_data *pdata;\r\nstruct resource *res;\r\nint ret, num_cs = 0, bits_per_word = 8;\r\nstruct spi_master *master;\r\nu32 tmp;\r\nu8 i;\r\npdata = dev_get_platdata(&pdev->dev);\r\nif (pdata) {\r\nnum_cs = pdata->num_chipselect;\r\nbits_per_word = pdata->bits_per_word;\r\n} else {\r\nof_property_read_u32(pdev->dev.of_node, "xlnx,num-ss-bits",\r\n&num_cs);\r\n}\r\nif (!num_cs) {\r\ndev_err(&pdev->dev,\r\n"Missing slave select configuration data\n");\r\nreturn -EINVAL;\r\n}\r\nif (num_cs > XILINX_SPI_MAX_CS) {\r\ndev_err(&pdev->dev, "Invalid number of spi slaves\n");\r\nreturn -EINVAL;\r\n}\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(struct xilinx_spi));\r\nif (!master)\r\nreturn -ENODEV;\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_LSB_FIRST | SPI_LOOP |\r\nSPI_CS_HIGH;\r\nxspi = spi_master_get_devdata(master);\r\nxspi->cs_inactive = 0xffffffff;\r\nxspi->bitbang.master = master;\r\nxspi->bitbang.chipselect = xilinx_spi_chipselect;\r\nxspi->bitbang.setup_transfer = xilinx_spi_setup_transfer;\r\nxspi->bitbang.txrx_bufs = xilinx_spi_txrx_bufs;\r\ninit_completion(&xspi->done);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nxspi->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(xspi->regs)) {\r\nret = PTR_ERR(xspi->regs);\r\ngoto put_master;\r\n}\r\nmaster->bus_num = pdev->id;\r\nmaster->num_chipselect = num_cs;\r\nmaster->dev.of_node = pdev->dev.of_node;\r\nxspi->read_fn = xspi_read32;\r\nxspi->write_fn = xspi_write32;\r\nxspi->write_fn(XSPI_CR_LOOP, xspi->regs + XSPI_CR_OFFSET);\r\ntmp = xspi->read_fn(xspi->regs + XSPI_CR_OFFSET);\r\ntmp &= XSPI_CR_LOOP;\r\nif (tmp != XSPI_CR_LOOP) {\r\nxspi->read_fn = xspi_read32_be;\r\nxspi->write_fn = xspi_write32_be;\r\n}\r\nmaster->bits_per_word_mask = SPI_BPW_MASK(bits_per_word);\r\nxspi->bytes_per_word = bits_per_word / 8;\r\nxspi->buffer_size = xilinx_spi_find_buffer_size(xspi);\r\nxspi->irq = platform_get_irq(pdev, 0);\r\nif (xspi->irq >= 0) {\r\nret = devm_request_irq(&pdev->dev, xspi->irq, xilinx_spi_irq, 0,\r\ndev_name(&pdev->dev), xspi);\r\nif (ret)\r\ngoto put_master;\r\n}\r\nxspi_init_hw(xspi);\r\nret = spi_bitbang_start(&xspi->bitbang);\r\nif (ret) {\r\ndev_err(&pdev->dev, "spi_bitbang_start FAILED\n");\r\ngoto put_master;\r\n}\r\ndev_info(&pdev->dev, "at 0x%08llX mapped to 0x%p, irq=%d\n",\r\n(unsigned long long)res->start, xspi->regs, xspi->irq);\r\nif (pdata) {\r\nfor (i = 0; i < pdata->num_devices; i++)\r\nspi_new_device(master, pdata->devices + i);\r\n}\r\nplatform_set_drvdata(pdev, master);\r\nreturn 0;\r\nput_master:\r\nspi_master_put(master);\r\nreturn ret;\r\n}\r\nstatic int xilinx_spi_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct xilinx_spi *xspi = spi_master_get_devdata(master);\r\nvoid __iomem *regs_base = xspi->regs;\r\nspi_bitbang_stop(&xspi->bitbang);\r\nxspi->write_fn(0, regs_base + XIPIF_V123B_IIER_OFFSET);\r\nxspi->write_fn(0, regs_base + XIPIF_V123B_DGIER_OFFSET);\r\nspi_master_put(xspi->bitbang.master);\r\nreturn 0;\r\n}

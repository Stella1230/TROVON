void fhci_dbg_isr(struct fhci_hcd *fhci, int usb_er)\r\n{\r\nint i;\r\nif (usb_er == -1) {\r\nfhci->usb_irq_stat[12]++;\r\nreturn;\r\n}\r\nfor (i = 0; i < 12; ++i) {\r\nif (usb_er & (1 << i))\r\nfhci->usb_irq_stat[i]++;\r\n}\r\n}\r\nstatic int fhci_dfs_regs_show(struct seq_file *s, void *v)\r\n{\r\nstruct fhci_hcd *fhci = s->private;\r\nstruct qe_usb_ctlr __iomem *regs = fhci->regs;\r\nseq_printf(s,\r\n"mode: 0x%x\n" "addr: 0x%x\n"\r\n"command: 0x%x\n" "ep0: 0x%x\n"\r\n"event: 0x%x\n" "mask: 0x%x\n"\r\n"status: 0x%x\n" "SOF timer: %d\n"\r\n"frame number: %d\n"\r\n"lines status: 0x%x\n",\r\nin_8(&regs->usb_usmod), in_8(&regs->usb_usadr),\r\nin_8(&regs->usb_uscom), in_be16(&regs->usb_usep[0]),\r\nin_be16(&regs->usb_usber), in_be16(&regs->usb_usbmr),\r\nin_8(&regs->usb_usbs), in_be16(&regs->usb_ussft),\r\nin_be16(&regs->usb_usfrn),\r\nfhci_ioports_check_bus_state(fhci));\r\nreturn 0;\r\n}\r\nstatic int fhci_dfs_irq_stat_show(struct seq_file *s, void *v)\r\n{\r\nstruct fhci_hcd *fhci = s->private;\r\nint *usb_irq_stat = fhci->usb_irq_stat;\r\nseq_printf(s,\r\n"RXB: %d\n" "TXB: %d\n" "BSY: %d\n"\r\n"SOF: %d\n" "TXE0: %d\n" "TXE1: %d\n"\r\n"TXE2: %d\n" "TXE3: %d\n" "IDLE: %d\n"\r\n"RESET: %d\n" "SFT: %d\n" "MSF: %d\n"\r\n"IDLE_ONLY: %d\n",\r\nusb_irq_stat[0], usb_irq_stat[1], usb_irq_stat[2],\r\nusb_irq_stat[3], usb_irq_stat[4], usb_irq_stat[5],\r\nusb_irq_stat[6], usb_irq_stat[7], usb_irq_stat[8],\r\nusb_irq_stat[9], usb_irq_stat[10], usb_irq_stat[11],\r\nusb_irq_stat[12]);\r\nreturn 0;\r\n}\r\nstatic int fhci_dfs_regs_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, fhci_dfs_regs_show, inode->i_private);\r\n}\r\nstatic int fhci_dfs_irq_stat_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, fhci_dfs_irq_stat_show, inode->i_private);\r\n}\r\nvoid fhci_dfs_create(struct fhci_hcd *fhci)\r\n{\r\nstruct device *dev = fhci_to_hcd(fhci)->self.controller;\r\nfhci->dfs_root = debugfs_create_dir(dev_name(dev), usb_debug_root);\r\nif (!fhci->dfs_root) {\r\nWARN_ON(1);\r\nreturn;\r\n}\r\nfhci->dfs_regs = debugfs_create_file("regs", S_IFREG | S_IRUGO,\r\nfhci->dfs_root, fhci, &fhci_dfs_regs_fops);\r\nfhci->dfs_irq_stat = debugfs_create_file("irq_stat",\r\nS_IFREG | S_IRUGO, fhci->dfs_root, fhci,\r\n&fhci_dfs_irq_stat_fops);\r\nWARN_ON(!fhci->dfs_regs || !fhci->dfs_irq_stat);\r\n}\r\nvoid fhci_dfs_destroy(struct fhci_hcd *fhci)\r\n{\r\nif (!fhci->dfs_root)\r\nreturn;\r\ndebugfs_remove(fhci->dfs_irq_stat);\r\ndebugfs_remove(fhci->dfs_regs);\r\ndebugfs_remove(fhci->dfs_root);\r\n}

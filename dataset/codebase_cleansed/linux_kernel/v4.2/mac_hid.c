static int mac_hid_create_emumouse(void)\r\n{\r\nstatic struct lock_class_key mac_hid_emumouse_dev_event_class;\r\nstatic struct lock_class_key mac_hid_emumouse_dev_mutex_class;\r\nint err;\r\nmac_hid_emumouse_dev = input_allocate_device();\r\nif (!mac_hid_emumouse_dev)\r\nreturn -ENOMEM;\r\nlockdep_set_class(&mac_hid_emumouse_dev->event_lock,\r\n&mac_hid_emumouse_dev_event_class);\r\nlockdep_set_class(&mac_hid_emumouse_dev->mutex,\r\n&mac_hid_emumouse_dev_mutex_class);\r\nmac_hid_emumouse_dev->name = "Macintosh mouse button emulation";\r\nmac_hid_emumouse_dev->id.bustype = BUS_ADB;\r\nmac_hid_emumouse_dev->id.vendor = 0x0001;\r\nmac_hid_emumouse_dev->id.product = 0x0001;\r\nmac_hid_emumouse_dev->id.version = 0x0100;\r\nmac_hid_emumouse_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\r\nmac_hid_emumouse_dev->keybit[BIT_WORD(BTN_MOUSE)] =\r\nBIT_MASK(BTN_LEFT) | BIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\r\nmac_hid_emumouse_dev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\r\nerr = input_register_device(mac_hid_emumouse_dev);\r\nif (err) {\r\ninput_free_device(mac_hid_emumouse_dev);\r\nmac_hid_emumouse_dev = NULL;\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mac_hid_destroy_emumouse(void)\r\n{\r\ninput_unregister_device(mac_hid_emumouse_dev);\r\nmac_hid_emumouse_dev = NULL;\r\n}\r\nstatic bool mac_hid_emumouse_filter(struct input_handle *handle,\r\nunsigned int type, unsigned int code,\r\nint value)\r\n{\r\nunsigned int btn;\r\nif (type != EV_KEY)\r\nreturn false;\r\nif (code == mouse_button2_keycode)\r\nbtn = BTN_MIDDLE;\r\nelse if (code == mouse_button3_keycode)\r\nbtn = BTN_RIGHT;\r\nelse\r\nreturn false;\r\ninput_report_key(mac_hid_emumouse_dev, btn, value);\r\ninput_sync(mac_hid_emumouse_dev);\r\nreturn true;\r\n}\r\nstatic int mac_hid_emumouse_connect(struct input_handler *handler,\r\nstruct input_dev *dev,\r\nconst struct input_device_id *id)\r\n{\r\nstruct input_handle *handle;\r\nint error;\r\nif (dev == mac_hid_emumouse_dev)\r\nreturn -ENODEV;\r\nhandle = kzalloc(sizeof(struct input_handle), GFP_KERNEL);\r\nif (!handle)\r\nreturn -ENOMEM;\r\nhandle->dev = dev;\r\nhandle->handler = handler;\r\nhandle->name = "mac-button-emul";\r\nerror = input_register_handle(handle);\r\nif (error) {\r\nprintk(KERN_ERR\r\n"mac_hid: Failed to register button emulation handle, "\r\n"error %d\n", error);\r\ngoto err_free;\r\n}\r\nerror = input_open_device(handle);\r\nif (error) {\r\nprintk(KERN_ERR\r\n"mac_hid: Failed to open input device, error %d\n",\r\nerror);\r\ngoto err_unregister;\r\n}\r\nreturn 0;\r\nerr_unregister:\r\ninput_unregister_handle(handle);\r\nerr_free:\r\nkfree(handle);\r\nreturn error;\r\n}\r\nstatic void mac_hid_emumouse_disconnect(struct input_handle *handle)\r\n{\r\ninput_close_device(handle);\r\ninput_unregister_handle(handle);\r\nkfree(handle);\r\n}\r\nstatic int mac_hid_start_emulation(void)\r\n{\r\nint err;\r\nerr = mac_hid_create_emumouse();\r\nif (err)\r\nreturn err;\r\nerr = input_register_handler(&mac_hid_emumouse_handler);\r\nif (err) {\r\nmac_hid_destroy_emumouse();\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mac_hid_stop_emulation(void)\r\n{\r\ninput_unregister_handler(&mac_hid_emumouse_handler);\r\nmac_hid_destroy_emumouse();\r\n}\r\nstatic int mac_hid_toggle_emumouse(struct ctl_table *table, int write,\r\nvoid __user *buffer, size_t *lenp,\r\nloff_t *ppos)\r\n{\r\nint *valp = table->data;\r\nint old_val = *valp;\r\nint rc;\r\nrc = mutex_lock_killable(&mac_hid_emumouse_mutex);\r\nif (rc)\r\nreturn rc;\r\nrc = proc_dointvec(table, write, buffer, lenp, ppos);\r\nif (rc == 0 && write && *valp != old_val) {\r\nif (*valp == 1)\r\nrc = mac_hid_start_emulation();\r\nelse if (*valp == 0)\r\nmac_hid_stop_emulation();\r\nelse\r\nrc = -EINVAL;\r\n}\r\nif (rc)\r\n*valp = old_val;\r\nmutex_unlock(&mac_hid_emumouse_mutex);\r\nreturn rc;\r\n}\r\nstatic int __init mac_hid_init(void)\r\n{\r\nmac_hid_sysctl_header = register_sysctl_table(mac_hid_root_dir);\r\nif (!mac_hid_sysctl_header)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void __exit mac_hid_exit(void)\r\n{\r\nunregister_sysctl_table(mac_hid_sysctl_header);\r\nif (mouse_emulate_buttons)\r\nmac_hid_stop_emulation();\r\n}

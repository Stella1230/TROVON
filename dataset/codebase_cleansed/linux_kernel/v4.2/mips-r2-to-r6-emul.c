static int __init mipsr2emu_enable(char *s)\r\n{\r\nmipsr2_emulation = 1;\r\npr_info("MIPS R2-to-R6 Emulator Enabled!");\r\nreturn 1;\r\n}\r\nstatic inline int mipsr6_emul(struct pt_regs *regs, u32 ir)\r\n{\r\nswitch (MIPSInst_OPCODE(ir)) {\r\ncase addiu_op:\r\nif (MIPSInst_RT(ir))\r\nregs->regs[MIPSInst_RT(ir)] =\r\n(s32)regs->regs[MIPSInst_RS(ir)] +\r\n(s32)MIPSInst_SIMM(ir);\r\nreturn 0;\r\ncase daddiu_op:\r\nif (config_enabled(CONFIG_32BIT))\r\nbreak;\r\nif (MIPSInst_RT(ir))\r\nregs->regs[MIPSInst_RT(ir)] =\r\n(s64)regs->regs[MIPSInst_RS(ir)] +\r\n(s64)MIPSInst_SIMM(ir);\r\nreturn 0;\r\ncase lwc1_op:\r\ncase swc1_op:\r\ncase cop1_op:\r\ncase cop1x_op:\r\nreturn -SIGFPE;\r\ncase spec_op:\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase or_op:\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\nregs->regs[MIPSInst_RS(ir)] |\r\nregs->regs[MIPSInst_RT(ir)];\r\nreturn 0;\r\ncase sll_op:\r\nif (MIPSInst_RS(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(s32)(((u32)regs->regs[MIPSInst_RT(ir)]) <<\r\nMIPSInst_FD(ir));\r\nreturn 0;\r\ncase srl_op:\r\nif (MIPSInst_RS(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(s32)(((u32)regs->regs[MIPSInst_RT(ir)]) >>\r\nMIPSInst_FD(ir));\r\nreturn 0;\r\ncase addu_op:\r\nif (MIPSInst_FD(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(s32)((u32)regs->regs[MIPSInst_RS(ir)] +\r\n(u32)regs->regs[MIPSInst_RT(ir)]);\r\nreturn 0;\r\ncase subu_op:\r\nif (MIPSInst_FD(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(s32)((u32)regs->regs[MIPSInst_RS(ir)] -\r\n(u32)regs->regs[MIPSInst_RT(ir)]);\r\nreturn 0;\r\ncase dsll_op:\r\nif (config_enabled(CONFIG_32BIT) || MIPSInst_RS(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(s64)(((u64)regs->regs[MIPSInst_RT(ir)]) <<\r\nMIPSInst_FD(ir));\r\nreturn 0;\r\ncase dsrl_op:\r\nif (config_enabled(CONFIG_32BIT) || MIPSInst_RS(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(s64)(((u64)regs->regs[MIPSInst_RT(ir)]) >>\r\nMIPSInst_FD(ir));\r\nreturn 0;\r\ncase daddu_op:\r\nif (config_enabled(CONFIG_32BIT) || MIPSInst_FD(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(u64)regs->regs[MIPSInst_RS(ir)] +\r\n(u64)regs->regs[MIPSInst_RT(ir)];\r\nreturn 0;\r\ncase dsubu_op:\r\nif (config_enabled(CONFIG_32BIT) || MIPSInst_FD(ir))\r\nbreak;\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] =\r\n(s64)((u64)regs->regs[MIPSInst_RS(ir)] -\r\n(u64)regs->regs[MIPSInst_RT(ir)]);\r\nreturn 0;\r\n}\r\nbreak;\r\ndefault:\r\npr_debug("No fastpath BD emulation for instruction 0x%08x (op: %02x)\n",\r\nir, MIPSInst_OPCODE(ir));\r\n}\r\nreturn SIGILL;\r\n}\r\nstatic int movf_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu32 csr;\r\nu32 cond;\r\ncsr = current->thread.fpu.fcr31;\r\ncond = fpucondbit[MIPSInst_RT(ir) >> 2];\r\nif (((csr & cond) == 0) && MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] = regs->regs[MIPSInst_RS(ir)];\r\nMIPS_R2_STATS(movs);\r\nreturn 0;\r\n}\r\nstatic int movt_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu32 csr;\r\nu32 cond;\r\ncsr = current->thread.fpu.fcr31;\r\ncond = fpucondbit[MIPSInst_RT(ir) >> 2];\r\nif (((csr & cond) != 0) && MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] = regs->regs[MIPSInst_RS(ir)];\r\nMIPS_R2_STATS(movs);\r\nreturn 0;\r\n}\r\nstatic int jr_func(struct pt_regs *regs, u32 ir)\r\n{\r\nint err;\r\nunsigned long cepc, epc, nepc;\r\nu32 nir;\r\nif (delay_slot(regs))\r\nreturn SIGILL;\r\nnepc = regs->cp0_epc;\r\nregs->cp0_epc -= 4;\r\nepc = regs->cp0_epc;\r\nerr = __compute_return_epc(regs);\r\nif (err < 0)\r\nreturn SIGEMT;\r\ncepc = regs->cp0_epc;\r\nerr = __get_user(nir, (u32 __user *)nepc);\r\nif (err)\r\nreturn SIGSEGV;\r\nMIPS_R2BR_STATS(jrs);\r\nif (nir) {\r\nerr = mipsr6_emul(regs, nir);\r\nif (err > 0) {\r\nregs->cp0_epc = nepc;\r\nerr = mips_dsemul(regs, nir, cepc);\r\nif (err == SIGILL)\r\nerr = SIGEMT;\r\nMIPS_R2_STATS(dsemul);\r\n}\r\n}\r\nreturn err;\r\n}\r\nstatic int movz_func(struct pt_regs *regs, u32 ir)\r\n{\r\nif (((regs->regs[MIPSInst_RT(ir)]) == 0) && MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] = regs->regs[MIPSInst_RS(ir)];\r\nMIPS_R2_STATS(movs);\r\nreturn 0;\r\n}\r\nstatic int movn_func(struct pt_regs *regs, u32 ir)\r\n{\r\nif (((regs->regs[MIPSInst_RT(ir)]) != 0) && MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] = regs->regs[MIPSInst_RS(ir)];\r\nMIPS_R2_STATS(movs);\r\nreturn 0;\r\n}\r\nstatic int mfhi_func(struct pt_regs *regs, u32 ir)\r\n{\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] = regs->hi;\r\nMIPS_R2_STATS(hilo);\r\nreturn 0;\r\n}\r\nstatic int mthi_func(struct pt_regs *regs, u32 ir)\r\n{\r\nregs->hi = regs->regs[MIPSInst_RS(ir)];\r\nMIPS_R2_STATS(hilo);\r\nreturn 0;\r\n}\r\nstatic int mflo_func(struct pt_regs *regs, u32 ir)\r\n{\r\nif (MIPSInst_RD(ir))\r\nregs->regs[MIPSInst_RD(ir)] = regs->lo;\r\nMIPS_R2_STATS(hilo);\r\nreturn 0;\r\n}\r\nstatic int mtlo_func(struct pt_regs *regs, u32 ir)\r\n{\r\nregs->lo = regs->regs[MIPSInst_RS(ir)];\r\nMIPS_R2_STATS(hilo);\r\nreturn 0;\r\n}\r\nstatic int mult_func(struct pt_regs *regs, u32 ir)\r\n{\r\ns64 res;\r\ns32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = (s64)rt * (s64)rs;\r\nrs = res;\r\nregs->lo = (s64)rs;\r\nrt = res >> 32;\r\nres = (s64)rt;\r\nregs->hi = res;\r\nMIPS_R2_STATS(muls);\r\nreturn 0;\r\n}\r\nstatic int multu_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu64 res;\r\nu32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = (u64)rt * (u64)rs;\r\nrt = res;\r\nregs->lo = (s64)rt;\r\nregs->hi = (s64)(res >> 32);\r\nMIPS_R2_STATS(muls);\r\nreturn 0;\r\n}\r\nstatic int div_func(struct pt_regs *regs, u32 ir)\r\n{\r\ns32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nregs->lo = (s64)(rs / rt);\r\nregs->hi = (s64)(rs % rt);\r\nMIPS_R2_STATS(divs);\r\nreturn 0;\r\n}\r\nstatic int divu_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nregs->lo = (s64)(rs / rt);\r\nregs->hi = (s64)(rs % rt);\r\nMIPS_R2_STATS(divs);\r\nreturn 0;\r\n}\r\nstatic int dmult_func(struct pt_regs *regs, u32 ir)\r\n{\r\ns64 res;\r\ns64 rt, rs;\r\nif (config_enabled(CONFIG_32BIT))\r\nreturn SIGILL;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = rt * rs;\r\nregs->lo = res;\r\n__asm__ __volatile__(\r\n"dmuh %0, %1, %2\t\n"\r\n: "=r"(res)\r\n: "r"(rt), "r"(rs));\r\nregs->hi = res;\r\nMIPS_R2_STATS(muls);\r\nreturn 0;\r\n}\r\nstatic int dmultu_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu64 res;\r\nu64 rt, rs;\r\nif (config_enabled(CONFIG_32BIT))\r\nreturn SIGILL;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = rt * rs;\r\nregs->lo = res;\r\n__asm__ __volatile__(\r\n"dmuhu %0, %1, %2\t\n"\r\n: "=r"(res)\r\n: "r"(rt), "r"(rs));\r\nregs->hi = res;\r\nMIPS_R2_STATS(muls);\r\nreturn 0;\r\n}\r\nstatic int ddiv_func(struct pt_regs *regs, u32 ir)\r\n{\r\ns64 rt, rs;\r\nif (config_enabled(CONFIG_32BIT))\r\nreturn SIGILL;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nregs->lo = rs / rt;\r\nregs->hi = rs % rt;\r\nMIPS_R2_STATS(divs);\r\nreturn 0;\r\n}\r\nstatic int ddivu_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu64 rt, rs;\r\nif (config_enabled(CONFIG_32BIT))\r\nreturn SIGILL;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nregs->lo = rs / rt;\r\nregs->hi = rs % rt;\r\nMIPS_R2_STATS(divs);\r\nreturn 0;\r\n}\r\nstatic int madd_func(struct pt_regs *regs, u32 ir)\r\n{\r\ns64 res;\r\ns32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = (s64)rt * (s64)rs;\r\nrt = regs->hi;\r\nrs = regs->lo;\r\nres += ((((s64)rt) << 32) | (u32)rs);\r\nrt = res;\r\nregs->lo = (s64)rt;\r\nrs = res >> 32;\r\nregs->hi = (s64)rs;\r\nMIPS_R2_STATS(dsps);\r\nreturn 0;\r\n}\r\nstatic int maddu_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu64 res;\r\nu32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = (u64)rt * (u64)rs;\r\nrt = regs->hi;\r\nrs = regs->lo;\r\nres += ((((s64)rt) << 32) | (u32)rs);\r\nrt = res;\r\nregs->lo = (s64)rt;\r\nrs = res >> 32;\r\nregs->hi = (s64)rs;\r\nMIPS_R2_STATS(dsps);\r\nreturn 0;\r\n}\r\nstatic int msub_func(struct pt_regs *regs, u32 ir)\r\n{\r\ns64 res;\r\ns32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = (s64)rt * (s64)rs;\r\nrt = regs->hi;\r\nrs = regs->lo;\r\nres = ((((s64)rt) << 32) | (u32)rs) - res;\r\nrt = res;\r\nregs->lo = (s64)rt;\r\nrs = res >> 32;\r\nregs->hi = (s64)rs;\r\nMIPS_R2_STATS(dsps);\r\nreturn 0;\r\n}\r\nstatic int msubu_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu64 res;\r\nu32 rt, rs;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = (u64)rt * (u64)rs;\r\nrt = regs->hi;\r\nrs = regs->lo;\r\nres = ((((s64)rt) << 32) | (u32)rs) - res;\r\nrt = res;\r\nregs->lo = (s64)rt;\r\nrs = res >> 32;\r\nregs->hi = (s64)rs;\r\nMIPS_R2_STATS(dsps);\r\nreturn 0;\r\n}\r\nstatic int mul_func(struct pt_regs *regs, u32 ir)\r\n{\r\ns64 res;\r\ns32 rt, rs;\r\nif (!MIPSInst_RD(ir))\r\nreturn 0;\r\nrt = regs->regs[MIPSInst_RT(ir)];\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\nres = (s64)rt * (s64)rs;\r\nrs = res;\r\nregs->regs[MIPSInst_RD(ir)] = (s64)rs;\r\nMIPS_R2_STATS(muls);\r\nreturn 0;\r\n}\r\nstatic int clz_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu32 res;\r\nu32 rs;\r\nif (!MIPSInst_RD(ir))\r\nreturn 0;\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\n__asm__ __volatile__("clz %0, %1" : "=r"(res) : "r"(rs));\r\nregs->regs[MIPSInst_RD(ir)] = res;\r\nMIPS_R2_STATS(bops);\r\nreturn 0;\r\n}\r\nstatic int clo_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu32 res;\r\nu32 rs;\r\nif (!MIPSInst_RD(ir))\r\nreturn 0;\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\n__asm__ __volatile__("clo %0, %1" : "=r"(res) : "r"(rs));\r\nregs->regs[MIPSInst_RD(ir)] = res;\r\nMIPS_R2_STATS(bops);\r\nreturn 0;\r\n}\r\nstatic int dclz_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu64 res;\r\nu64 rs;\r\nif (config_enabled(CONFIG_32BIT))\r\nreturn SIGILL;\r\nif (!MIPSInst_RD(ir))\r\nreturn 0;\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\n__asm__ __volatile__("dclz %0, %1" : "=r"(res) : "r"(rs));\r\nregs->regs[MIPSInst_RD(ir)] = res;\r\nMIPS_R2_STATS(bops);\r\nreturn 0;\r\n}\r\nstatic int dclo_func(struct pt_regs *regs, u32 ir)\r\n{\r\nu64 res;\r\nu64 rs;\r\nif (config_enabled(CONFIG_32BIT))\r\nreturn SIGILL;\r\nif (!MIPSInst_RD(ir))\r\nreturn 0;\r\nrs = regs->regs[MIPSInst_RS(ir)];\r\n__asm__ __volatile__("dclo %0, %1" : "=r"(res) : "r"(rs));\r\nregs->regs[MIPSInst_RD(ir)] = res;\r\nMIPS_R2_STATS(bops);\r\nreturn 0;\r\n}\r\nstatic inline int mipsr2_find_op_func(struct pt_regs *regs, u32 inst,\r\nstruct r2_decoder_table *table)\r\n{\r\nstruct r2_decoder_table *p;\r\nint err;\r\nfor (p = table; p->func; p++) {\r\nif ((inst & p->mask) == p->code) {\r\nerr = (p->func)(regs, inst);\r\nreturn err;\r\n}\r\n}\r\nreturn SIGILL;\r\n}\r\nint mipsr2_decoder(struct pt_regs *regs, u32 inst, unsigned long *fcr31)\r\n{\r\nint err = 0;\r\nunsigned long vaddr;\r\nu32 nir;\r\nunsigned long cpc, epc, nepc, r31, res, rs, rt;\r\nvoid __user *fault_addr = NULL;\r\nint pass = 0;\r\nrepeat:\r\nr31 = regs->regs[31];\r\nepc = regs->cp0_epc;\r\nerr = compute_return_epc(regs);\r\nif (err < 0) {\r\nBUG();\r\nreturn SIGEMT;\r\n}\r\npr_debug("Emulating the 0x%08x R2 instruction @ 0x%08lx (pass=%d))\n",\r\ninst, epc, pass);\r\nswitch (MIPSInst_OPCODE(inst)) {\r\ncase spec_op:\r\nerr = mipsr2_find_op_func(regs, inst, spec_op_table);\r\nif (err < 0) {\r\nregs->cp0_cause |= CAUSEF_BD;\r\ngoto fpu_emul;\r\n}\r\nbreak;\r\ncase spec2_op:\r\nerr = mipsr2_find_op_func(regs, inst, spec2_op_table);\r\nbreak;\r\ncase bcond_op:\r\nrt = MIPSInst_RT(inst);\r\nrs = MIPSInst_RS(inst);\r\nswitch (rt) {\r\ncase tgei_op:\r\nif ((long)regs->regs[rs] >= MIPSInst_SIMM(inst))\r\ndo_trap_or_bp(regs, 0, "TGEI");\r\nMIPS_R2_STATS(traps);\r\nbreak;\r\ncase tgeiu_op:\r\nif (regs->regs[rs] >= MIPSInst_UIMM(inst))\r\ndo_trap_or_bp(regs, 0, "TGEIU");\r\nMIPS_R2_STATS(traps);\r\nbreak;\r\ncase tlti_op:\r\nif ((long)regs->regs[rs] < MIPSInst_SIMM(inst))\r\ndo_trap_or_bp(regs, 0, "TLTI");\r\nMIPS_R2_STATS(traps);\r\nbreak;\r\ncase tltiu_op:\r\nif (regs->regs[rs] < MIPSInst_UIMM(inst))\r\ndo_trap_or_bp(regs, 0, "TLTIU");\r\nMIPS_R2_STATS(traps);\r\nbreak;\r\ncase teqi_op:\r\nif (regs->regs[rs] == MIPSInst_SIMM(inst))\r\ndo_trap_or_bp(regs, 0, "TEQI");\r\nMIPS_R2_STATS(traps);\r\nbreak;\r\ncase tnei_op:\r\nif (regs->regs[rs] != MIPSInst_SIMM(inst))\r\ndo_trap_or_bp(regs, 0, "TNEI");\r\nMIPS_R2_STATS(traps);\r\nbreak;\r\ncase bltzl_op:\r\ncase bgezl_op:\r\ncase bltzall_op:\r\ncase bgezall_op:\r\nif (delay_slot(regs)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nregs->regs[31] = r31;\r\nregs->cp0_epc = epc;\r\nerr = __compute_return_epc(regs);\r\nif (err < 0)\r\nreturn SIGEMT;\r\nif (err != BRANCH_LIKELY_TAKEN)\r\nbreak;\r\ncpc = regs->cp0_epc;\r\nnepc = epc + 4;\r\nerr = __get_user(nir, (u32 __user *)nepc);\r\nif (err) {\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\nswitch (rt) {\r\ncase bltzl_op:\r\nMIPS_R2BR_STATS(bltzl);\r\nbreak;\r\ncase bgezl_op:\r\nMIPS_R2BR_STATS(bgezl);\r\nbreak;\r\ncase bltzall_op:\r\nMIPS_R2BR_STATS(bltzall);\r\nbreak;\r\ncase bgezall_op:\r\nMIPS_R2BR_STATS(bgezall);\r\nbreak;\r\n}\r\nswitch (MIPSInst_OPCODE(nir)) {\r\ncase cop1_op:\r\ncase cop1x_op:\r\ncase lwc1_op:\r\ncase swc1_op:\r\nregs->cp0_cause |= CAUSEF_BD;\r\ngoto fpu_emul;\r\n}\r\nif (nir) {\r\nerr = mipsr6_emul(regs, nir);\r\nif (err > 0) {\r\nerr = mips_dsemul(regs, nir, cpc);\r\nif (err == SIGILL)\r\nerr = SIGEMT;\r\nMIPS_R2_STATS(dsemul);\r\n}\r\n}\r\nbreak;\r\ncase bltzal_op:\r\ncase bgezal_op:\r\nif (delay_slot(regs)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nregs->regs[31] = r31;\r\nregs->cp0_epc = epc;\r\nerr = __compute_return_epc(regs);\r\nif (err < 0)\r\nreturn SIGEMT;\r\ncpc = regs->cp0_epc;\r\nnepc = epc + 4;\r\nerr = __get_user(nir, (u32 __user *)nepc);\r\nif (err) {\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\nswitch (rt) {\r\ncase bltzal_op:\r\nMIPS_R2BR_STATS(bltzal);\r\nbreak;\r\ncase bgezal_op:\r\nMIPS_R2BR_STATS(bgezal);\r\nbreak;\r\n}\r\nswitch (MIPSInst_OPCODE(nir)) {\r\ncase cop1_op:\r\ncase cop1x_op:\r\ncase lwc1_op:\r\ncase swc1_op:\r\nregs->cp0_cause |= CAUSEF_BD;\r\ngoto fpu_emul;\r\n}\r\nif (nir) {\r\nerr = mipsr6_emul(regs, nir);\r\nif (err > 0) {\r\nerr = mips_dsemul(regs, nir, cpc);\r\nif (err == SIGILL)\r\nerr = SIGEMT;\r\nMIPS_R2_STATS(dsemul);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nregs->regs[31] = r31;\r\nregs->cp0_epc = epc;\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nbreak;\r\ncase beql_op:\r\ncase bnel_op:\r\ncase blezl_op:\r\ncase bgtzl_op:\r\nif (delay_slot(regs)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nregs->regs[31] = r31;\r\nregs->cp0_epc = epc;\r\nerr = __compute_return_epc(regs);\r\nif (err < 0)\r\nreturn SIGEMT;\r\nif (err != BRANCH_LIKELY_TAKEN)\r\nbreak;\r\ncpc = regs->cp0_epc;\r\nnepc = epc + 4;\r\nerr = __get_user(nir, (u32 __user *)nepc);\r\nif (err) {\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\nswitch (MIPSInst_OPCODE(inst)) {\r\ncase beql_op:\r\nMIPS_R2BR_STATS(beql);\r\nbreak;\r\ncase bnel_op:\r\nMIPS_R2BR_STATS(bnel);\r\nbreak;\r\ncase blezl_op:\r\nMIPS_R2BR_STATS(blezl);\r\nbreak;\r\ncase bgtzl_op:\r\nMIPS_R2BR_STATS(bgtzl);\r\nbreak;\r\n}\r\nswitch (MIPSInst_OPCODE(nir)) {\r\ncase cop1_op:\r\ncase cop1x_op:\r\ncase lwc1_op:\r\ncase swc1_op:\r\nregs->cp0_cause |= CAUSEF_BD;\r\ngoto fpu_emul;\r\n}\r\nif (nir) {\r\nerr = mipsr6_emul(regs, nir);\r\nif (err > 0) {\r\nerr = mips_dsemul(regs, nir, cpc);\r\nif (err == SIGILL)\r\nerr = SIGEMT;\r\nMIPS_R2_STATS(dsemul);\r\n}\r\n}\r\nbreak;\r\ncase lwc1_op:\r\ncase swc1_op:\r\ncase cop1_op:\r\ncase cop1x_op:\r\nfpu_emul:\r\nregs->regs[31] = r31;\r\nregs->cp0_epc = epc;\r\nif (!used_math()) {\r\nerr = init_fpu();\r\nset_used_math();\r\n}\r\nlose_fpu(1);\r\nerr = fpu_emulator_cop1Handler(regs, &current->thread.fpu, 0,\r\n&fault_addr);\r\n*fcr31 = current->thread.fpu.fcr31;\r\ncurrent->thread.fpu.fcr31 &= ~FPU_CSR_ALL_X;\r\nown_fpu(1);\r\nif (err)\r\ncurrent->thread.cp0_baduaddr = (unsigned long)fault_addr;\r\nMIPS_R2_STATS(fpus);\r\nbreak;\r\ncase lwl_op:\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_READ, vaddr, 4)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\n"1:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 24, 8\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\n"2:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 16, 8\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\n"3:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 8, 8\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\n"4:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 0, 8\n"\r\n#else\r\n"1:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 24, 8\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\n"2:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 16, 8\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\n"3:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 8, 8\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\n"4:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 0, 8\n"\r\n#endif\r\n"9: sll %0, %0, 0\n"\r\n"10:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 10b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV));\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = rt;\r\nMIPS_R2_STATS(loads);\r\nbreak;\r\ncase lwr_op:\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_READ, vaddr, 4)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\n"1:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 0, 8\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\n"2:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 8, 8\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\n"3:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 16, 8\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\n"4:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 24, 8\n"\r\n" sll %0, %0, 0\n"\r\n#else\r\n"1:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 0, 8\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\n"2:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 8, 8\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\n"3:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 16, 8\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\n"4:" LB "%1, 0(%2)\n"\r\nINS "%0, %1, 24, 8\n"\r\n" sll %0, %0, 0\n"\r\n#endif\r\n"9:\n"\r\n"10:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 10b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV));\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = rt;\r\nMIPS_R2_STATS(loads);\r\nbreak;\r\ncase swl_op:\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_WRITE, vaddr, 4)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\nEXT "%1, %0, 24, 8\n"\r\n"1:" SB "%1, 0(%2)\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\nEXT "%1, %0, 16, 8\n"\r\n"2:" SB "%1, 0(%2)\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\nEXT "%1, %0, 8, 8\n"\r\n"3:" SB "%1, 0(%2)\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\nEXT "%1, %0, 0, 8\n"\r\n"4:" SB "%1, 0(%2)\n"\r\n#else\r\nEXT "%1, %0, 24, 8\n"\r\n"1:" SB "%1, 0(%2)\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nEXT "%1, %0, 16, 8\n"\r\n"2:" SB "%1, 0(%2)\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nEXT "%1, %0, 8, 8\n"\r\n"3:" SB "%1, 0(%2)\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nEXT "%1, %0, 0, 8\n"\r\n"4:" SB "%1, 0(%2)\n"\r\n#endif\r\n"9:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 9b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV)\r\n: "memory");\r\nMIPS_R2_STATS(stores);\r\nbreak;\r\ncase swr_op:\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_WRITE, vaddr, 4)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\nEXT "%1, %0, 0, 8\n"\r\n"1:" SB "%1, 0(%2)\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nEXT "%1, %0, 8, 8\n"\r\n"2:" SB "%1, 0(%2)\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nEXT "%1, %0, 16, 8\n"\r\n"3:" SB "%1, 0(%2)\n"\r\nADDIU "%2, %2, 1\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nEXT "%1, %0, 24, 8\n"\r\n"4:" SB "%1, 0(%2)\n"\r\n#else\r\nEXT "%1, %0, 0, 8\n"\r\n"1:" SB "%1, 0(%2)\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\nEXT "%1, %0, 8, 8\n"\r\n"2:" SB "%1, 0(%2)\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\nEXT "%1, %0, 16, 8\n"\r\n"3:" SB "%1, 0(%2)\n"\r\n" andi %1, %2, 0x3\n"\r\n" beq $0, %1, 9f\n"\r\nADDIU "%2, %2, -1\n"\r\nEXT "%1, %0, 24, 8\n"\r\n"4:" SB "%1, 0(%2)\n"\r\n#endif\r\n"9:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 9b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV)\r\n: "memory");\r\nMIPS_R2_STATS(stores);\r\nbreak;\r\ncase ldl_op:\r\nif (config_enabled(CONFIG_32BIT)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_READ, vaddr, 8)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\n"1: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 56, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"2: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 48, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"3: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 40, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"4: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 32, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"5: lb %1, 0(%2)\n"\r\n" dins %0, %1, 24, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"6: lb %1, 0(%2)\n"\r\n" dins %0, %1, 16, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"7: lb %1, 0(%2)\n"\r\n" dins %0, %1, 8, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"0: lb %1, 0(%2)\n"\r\n" dins %0, %1, 0, 8\n"\r\n#else\r\n"1: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 56, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"2: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 48, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"3: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 40, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"4: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 32, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"5: lb %1, 0(%2)\n"\r\n" dins %0, %1, 24, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"6: lb %1, 0(%2)\n"\r\n" dins %0, %1, 16, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"7: lb %1, 0(%2)\n"\r\n" dins %0, %1, 8, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"0: lb %1, 0(%2)\n"\r\n" dins %0, %1, 0, 8\n"\r\n#endif\r\n"9:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 9b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .word 5b,8b\n"\r\n" .word 6b,8b\n"\r\n" .word 7b,8b\n"\r\n" .word 0b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV));\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = rt;\r\nMIPS_R2_STATS(loads);\r\nbreak;\r\ncase ldr_op:\r\nif (config_enabled(CONFIG_32BIT)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_READ, vaddr, 8)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\n"1: lb %1, 0(%2)\n"\r\n" dins %0, %1, 0, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"2: lb %1, 0(%2)\n"\r\n" dins %0, %1, 8, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"3: lb %1, 0(%2)\n"\r\n" dins %0, %1, 16, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"4: lb %1, 0(%2)\n"\r\n" dins %0, %1, 24, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"5: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 32, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"6: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 40, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"7: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 48, 8\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n"0: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 56, 8\n"\r\n#else\r\n"1: lb %1, 0(%2)\n"\r\n" dins %0, %1, 0, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"2: lb %1, 0(%2)\n"\r\n" dins %0, %1, 8, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"3: lb %1, 0(%2)\n"\r\n" dins %0, %1, 16, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"4: lb %1, 0(%2)\n"\r\n" dins %0, %1, 24, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"5: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 32, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"6: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 40, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"7: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 48, 8\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n"0: lb %1, 0(%2)\n"\r\n" dinsu %0, %1, 56, 8\n"\r\n#endif\r\n"9:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 9b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .word 5b,8b\n"\r\n" .word 6b,8b\n"\r\n" .word 7b,8b\n"\r\n" .word 0b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV));\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = rt;\r\nMIPS_R2_STATS(loads);\r\nbreak;\r\ncase sdl_op:\r\nif (config_enabled(CONFIG_32BIT)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_WRITE, vaddr, 8)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\n" dextu %1, %0, 56, 8\n"\r\n"1: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dextu %1, %0, 48, 8\n"\r\n"2: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dextu %1, %0, 40, 8\n"\r\n"3: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dextu %1, %0, 32, 8\n"\r\n"4: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dext %1, %0, 24, 8\n"\r\n"5: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dext %1, %0, 16, 8\n"\r\n"6: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dext %1, %0, 8, 8\n"\r\n"7: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dext %1, %0, 0, 8\n"\r\n"0: sb %1, 0(%2)\n"\r\n#else\r\n" dextu %1, %0, 56, 8\n"\r\n"1: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dextu %1, %0, 48, 8\n"\r\n"2: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dextu %1, %0, 40, 8\n"\r\n"3: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dextu %1, %0, 32, 8\n"\r\n"4: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dext %1, %0, 24, 8\n"\r\n"5: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dext %1, %0, 16, 8\n"\r\n"6: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dext %1, %0, 8, 8\n"\r\n"7: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dext %1, %0, 0, 8\n"\r\n"0: sb %1, 0(%2)\n"\r\n#endif\r\n"9:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 9b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .word 5b,8b\n"\r\n" .word 6b,8b\n"\r\n" .word 7b,8b\n"\r\n" .word 0b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV)\r\n: "memory");\r\nMIPS_R2_STATS(stores);\r\nbreak;\r\ncase sdr_op:\r\nif (config_enabled(CONFIG_32BIT)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nrt = regs->regs[MIPSInst_RT(inst)];\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (!access_ok(VERIFY_WRITE, vaddr, 8)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGSEGV;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n" .set push\n"\r\n" .set reorder\n"\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\n" dext %1, %0, 0, 8\n"\r\n"1: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dext %1, %0, 8, 8\n"\r\n"2: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dext %1, %0, 16, 8\n"\r\n"3: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dext %1, %0, 24, 8\n"\r\n"4: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dextu %1, %0, 32, 8\n"\r\n"5: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dextu %1, %0, 40, 8\n"\r\n"6: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dextu %1, %0, 48, 8\n"\r\n"7: sb %1, 0(%2)\n"\r\n" daddiu %2, %2, 1\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" dextu %1, %0, 56, 8\n"\r\n"0: sb %1, 0(%2)\n"\r\n#else\r\n" dext %1, %0, 0, 8\n"\r\n"1: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dext %1, %0, 8, 8\n"\r\n"2: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dext %1, %0, 16, 8\n"\r\n"3: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dext %1, %0, 24, 8\n"\r\n"4: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dextu %1, %0, 32, 8\n"\r\n"5: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dextu %1, %0, 40, 8\n"\r\n"6: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dextu %1, %0, 48, 8\n"\r\n"7: sb %1, 0(%2)\n"\r\n" andi %1, %2, 0x7\n"\r\n" beq $0, %1, 9f\n"\r\n" daddiu %2, %2, -1\n"\r\n" dextu %1, %0, 56, 8\n"\r\n"0: sb %1, 0(%2)\n"\r\n#endif\r\n"9:\n"\r\n" .insn\n"\r\n" .section .fixup,\"ax\"\n"\r\n"8: li %3,%4\n"\r\n" j 9b\n"\r\n" .previous\n"\r\n" .section __ex_table,\"a\"\n"\r\n" .word 1b,8b\n"\r\n" .word 2b,8b\n"\r\n" .word 3b,8b\n"\r\n" .word 4b,8b\n"\r\n" .word 5b,8b\n"\r\n" .word 6b,8b\n"\r\n" .word 7b,8b\n"\r\n" .word 0b,8b\n"\r\n" .previous\n"\r\n" .set pop\n"\r\n: "+&r"(rt), "=&r"(rs),\r\n"+&r"(vaddr), "+&r"(err)\r\n: "i"(SIGSEGV)\r\n: "memory");\r\nMIPS_R2_STATS(stores);\r\nbreak;\r\ncase ll_op:\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (vaddr & 0x3) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!access_ok(VERIFY_READ, vaddr, 4)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!cpu_has_rw_llb) {\r\npr_err("Can't emulate MIPSR2 LL/SC without Config5/LLB\n");\r\nerr = SIGKILL;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n"1:\n"\r\n"ll %0, 0(%2)\n"\r\n"2:\n"\r\n".insn\n"\r\n".section .fixup,\"ax\"\n"\r\n"3:\n"\r\n"li %1, %3\n"\r\n"j 2b\n"\r\n".previous\n"\r\n".section __ex_table,\"a\"\n"\r\n".word 1b, 3b\n"\r\n".previous\n"\r\n: "=&r"(res), "+&r"(err)\r\n: "r"(vaddr), "i"(SIGSEGV)\r\n: "memory");\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = res;\r\nMIPS_R2_STATS(llsc);\r\nbreak;\r\ncase sc_op:\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (vaddr & 0x3) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!access_ok(VERIFY_WRITE, vaddr, 4)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!cpu_has_rw_llb) {\r\npr_err("Can't emulate MIPSR2 LL/SC without Config5/LLB\n");\r\nerr = SIGKILL;\r\nbreak;\r\n}\r\nres = regs->regs[MIPSInst_RT(inst)];\r\n__asm__ __volatile__(\r\n"1:\n"\r\n"sc %0, 0(%2)\n"\r\n"2:\n"\r\n".insn\n"\r\n".section .fixup,\"ax\"\n"\r\n"3:\n"\r\n"li %1, %3\n"\r\n"j 2b\n"\r\n".previous\n"\r\n".section __ex_table,\"a\"\n"\r\n".word 1b, 3b\n"\r\n".previous\n"\r\n: "+&r"(res), "+&r"(err)\r\n: "r"(vaddr), "i"(SIGSEGV));\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = res;\r\nMIPS_R2_STATS(llsc);\r\nbreak;\r\ncase lld_op:\r\nif (config_enabled(CONFIG_32BIT)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (vaddr & 0x7) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!access_ok(VERIFY_READ, vaddr, 8)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!cpu_has_rw_llb) {\r\npr_err("Can't emulate MIPSR2 LL/SC without Config5/LLB\n");\r\nerr = SIGKILL;\r\nbreak;\r\n}\r\n__asm__ __volatile__(\r\n"1:\n"\r\n"lld %0, 0(%2)\n"\r\n"2:\n"\r\n".insn\n"\r\n".section .fixup,\"ax\"\n"\r\n"3:\n"\r\n"li %1, %3\n"\r\n"j 2b\n"\r\n".previous\n"\r\n".section __ex_table,\"a\"\n"\r\n".word 1b, 3b\n"\r\n".previous\n"\r\n: "=&r"(res), "+&r"(err)\r\n: "r"(vaddr), "i"(SIGSEGV)\r\n: "memory");\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = res;\r\nMIPS_R2_STATS(llsc);\r\nbreak;\r\ncase scd_op:\r\nif (config_enabled(CONFIG_32BIT)) {\r\nerr = SIGILL;\r\nbreak;\r\n}\r\nvaddr = regs->regs[MIPSInst_RS(inst)] + MIPSInst_SIMM(inst);\r\nif (vaddr & 0x7) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!access_ok(VERIFY_WRITE, vaddr, 8)) {\r\ncurrent->thread.cp0_baduaddr = vaddr;\r\nerr = SIGBUS;\r\nbreak;\r\n}\r\nif (!cpu_has_rw_llb) {\r\npr_err("Can't emulate MIPSR2 LL/SC without Config5/LLB\n");\r\nerr = SIGKILL;\r\nbreak;\r\n}\r\nres = regs->regs[MIPSInst_RT(inst)];\r\n__asm__ __volatile__(\r\n"1:\n"\r\n"scd %0, 0(%2)\n"\r\n"2:\n"\r\n".insn\n"\r\n".section .fixup,\"ax\"\n"\r\n"3:\n"\r\n"li %1, %3\n"\r\n"j 2b\n"\r\n".previous\n"\r\n".section __ex_table,\"a\"\n"\r\n".word 1b, 3b\n"\r\n".previous\n"\r\n: "+&r"(res), "+&r"(err)\r\n: "r"(vaddr), "i"(SIGSEGV));\r\nif (MIPSInst_RT(inst) && !err)\r\nregs->regs[MIPSInst_RT(inst)] = res;\r\nMIPS_R2_STATS(llsc);\r\nbreak;\r\ncase pref_op:\r\nbreak;\r\ndefault:\r\nerr = SIGILL;\r\n}\r\nif (!err && (pass++ < MIPS_R2_EMUL_TOTAL_PASS)) {\r\nregs->cp0_cause &= ~CAUSEF_BD;\r\nerr = get_user(inst, (u32 __user *)regs->cp0_epc);\r\nif (!err)\r\ngoto repeat;\r\nif (err < 0)\r\nerr = SIGSEGV;\r\n}\r\nif (err && (err != SIGEMT)) {\r\nregs->regs[31] = r31;\r\nregs->cp0_epc = epc;\r\n}\r\nif (pass && (err == SIGILL))\r\nerr = 0;\r\nreturn err;\r\n}\r\nstatic int mipsr2_stats_show(struct seq_file *s, void *unused)\r\n{\r\nseq_printf(s, "Instruction\tTotal\tBDslot\n------------------------------\n");\r\nseq_printf(s, "movs\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.movs),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.movs));\r\nseq_printf(s, "hilo\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.hilo),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.hilo));\r\nseq_printf(s, "muls\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.muls),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.muls));\r\nseq_printf(s, "divs\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.divs),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.divs));\r\nseq_printf(s, "dsps\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.dsps),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.dsps));\r\nseq_printf(s, "bops\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.bops),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.bops));\r\nseq_printf(s, "traps\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.traps),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.traps));\r\nseq_printf(s, "fpus\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.fpus),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.fpus));\r\nseq_printf(s, "loads\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.loads),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.loads));\r\nseq_printf(s, "stores\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.stores),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.stores));\r\nseq_printf(s, "llsc\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.llsc),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.llsc));\r\nseq_printf(s, "dsemul\t\t%ld\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2emustats.dsemul),\r\n(unsigned long)__this_cpu_read(mipsr2bdemustats.dsemul));\r\nseq_printf(s, "jr\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.jrs));\r\nseq_printf(s, "bltzl\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bltzl));\r\nseq_printf(s, "bgezl\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bgezl));\r\nseq_printf(s, "bltzll\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bltzll));\r\nseq_printf(s, "bgezll\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bgezll));\r\nseq_printf(s, "bltzal\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bltzal));\r\nseq_printf(s, "bgezal\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bgezal));\r\nseq_printf(s, "beql\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.beql));\r\nseq_printf(s, "bnel\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bnel));\r\nseq_printf(s, "blezl\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.blezl));\r\nseq_printf(s, "bgtzl\t\t%ld\n",\r\n(unsigned long)__this_cpu_read(mipsr2bremustats.bgtzl));\r\nreturn 0;\r\n}\r\nstatic int mipsr2_stats_clear_show(struct seq_file *s, void *unused)\r\n{\r\nmipsr2_stats_show(s, unused);\r\n__this_cpu_write((mipsr2emustats).movs, 0);\r\n__this_cpu_write((mipsr2bdemustats).movs, 0);\r\n__this_cpu_write((mipsr2emustats).hilo, 0);\r\n__this_cpu_write((mipsr2bdemustats).hilo, 0);\r\n__this_cpu_write((mipsr2emustats).muls, 0);\r\n__this_cpu_write((mipsr2bdemustats).muls, 0);\r\n__this_cpu_write((mipsr2emustats).divs, 0);\r\n__this_cpu_write((mipsr2bdemustats).divs, 0);\r\n__this_cpu_write((mipsr2emustats).dsps, 0);\r\n__this_cpu_write((mipsr2bdemustats).dsps, 0);\r\n__this_cpu_write((mipsr2emustats).bops, 0);\r\n__this_cpu_write((mipsr2bdemustats).bops, 0);\r\n__this_cpu_write((mipsr2emustats).traps, 0);\r\n__this_cpu_write((mipsr2bdemustats).traps, 0);\r\n__this_cpu_write((mipsr2emustats).fpus, 0);\r\n__this_cpu_write((mipsr2bdemustats).fpus, 0);\r\n__this_cpu_write((mipsr2emustats).loads, 0);\r\n__this_cpu_write((mipsr2bdemustats).loads, 0);\r\n__this_cpu_write((mipsr2emustats).stores, 0);\r\n__this_cpu_write((mipsr2bdemustats).stores, 0);\r\n__this_cpu_write((mipsr2emustats).llsc, 0);\r\n__this_cpu_write((mipsr2bdemustats).llsc, 0);\r\n__this_cpu_write((mipsr2emustats).dsemul, 0);\r\n__this_cpu_write((mipsr2bdemustats).dsemul, 0);\r\n__this_cpu_write((mipsr2bremustats).jrs, 0);\r\n__this_cpu_write((mipsr2bremustats).bltzl, 0);\r\n__this_cpu_write((mipsr2bremustats).bgezl, 0);\r\n__this_cpu_write((mipsr2bremustats).bltzll, 0);\r\n__this_cpu_write((mipsr2bremustats).bgezll, 0);\r\n__this_cpu_write((mipsr2bremustats).bltzal, 0);\r\n__this_cpu_write((mipsr2bremustats).bgezal, 0);\r\n__this_cpu_write((mipsr2bremustats).beql, 0);\r\n__this_cpu_write((mipsr2bremustats).bnel, 0);\r\n__this_cpu_write((mipsr2bremustats).blezl, 0);\r\n__this_cpu_write((mipsr2bremustats).bgtzl, 0);\r\nreturn 0;\r\n}\r\nstatic int mipsr2_stats_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, mipsr2_stats_show, inode->i_private);\r\n}\r\nstatic int mipsr2_stats_clear_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, mipsr2_stats_clear_show, inode->i_private);\r\n}\r\nstatic int __init mipsr2_init_debugfs(void)\r\n{\r\nextern struct dentry *mips_debugfs_dir;\r\nstruct dentry *mipsr2_emul;\r\nif (!mips_debugfs_dir)\r\nreturn -ENODEV;\r\nmipsr2_emul = debugfs_create_file("r2_emul_stats", S_IRUGO,\r\nmips_debugfs_dir, NULL,\r\n&mipsr2_emul_fops);\r\nif (!mipsr2_emul)\r\nreturn -ENOMEM;\r\nmipsr2_emul = debugfs_create_file("r2_emul_stats_clear", S_IRUGO,\r\nmips_debugfs_dir, NULL,\r\n&mipsr2_clear_fops);\r\nif (!mipsr2_emul)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}

static inline struct xfs_buf_log_item *BUF_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_buf_log_item, bli_item);\r\n}\r\nstatic inline int\r\nxfs_buf_log_format_size(\r\nstruct xfs_buf_log_format *blfp)\r\n{\r\nreturn offsetof(struct xfs_buf_log_format, blf_data_map) +\r\n(blfp->blf_map_size * sizeof(blfp->blf_data_map[0]));\r\n}\r\nSTATIC void\r\nxfs_buf_item_size_segment(\r\nstruct xfs_buf_log_item *bip,\r\nstruct xfs_buf_log_format *blfp,\r\nint *nvecs,\r\nint *nbytes)\r\n{\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nint next_bit;\r\nint last_bit;\r\nlast_bit = xfs_next_bit(blfp->blf_data_map, blfp->blf_map_size, 0);\r\nif (last_bit == -1)\r\nreturn;\r\n*nvecs += 2;\r\n*nbytes += xfs_buf_log_format_size(blfp) + XFS_BLF_CHUNK;\r\nwhile (last_bit != -1) {\r\nnext_bit = xfs_next_bit(blfp->blf_data_map, blfp->blf_map_size,\r\nlast_bit + 1);\r\nif (next_bit == -1) {\r\nbreak;\r\n} else if (next_bit != last_bit + 1) {\r\nlast_bit = next_bit;\r\n(*nvecs)++;\r\n} else if (xfs_buf_offset(bp, next_bit * XFS_BLF_CHUNK) !=\r\n(xfs_buf_offset(bp, last_bit * XFS_BLF_CHUNK) +\r\nXFS_BLF_CHUNK)) {\r\nlast_bit = next_bit;\r\n(*nvecs)++;\r\n} else {\r\nlast_bit++;\r\n}\r\n*nbytes += XFS_BLF_CHUNK;\r\n}\r\n}\r\nSTATIC void\r\nxfs_buf_item_size(\r\nstruct xfs_log_item *lip,\r\nint *nvecs,\r\nint *nbytes)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nint i;\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nif (bip->bli_flags & XFS_BLI_STALE) {\r\ntrace_xfs_buf_item_size_stale(bip);\r\nASSERT(bip->__bli_format.blf_flags & XFS_BLF_CANCEL);\r\n*nvecs += bip->bli_format_count;\r\nfor (i = 0; i < bip->bli_format_count; i++) {\r\n*nbytes += xfs_buf_log_format_size(&bip->bli_formats[i]);\r\n}\r\nreturn;\r\n}\r\nASSERT(bip->bli_flags & XFS_BLI_LOGGED);\r\nif (bip->bli_flags & XFS_BLI_ORDERED) {\r\ntrace_xfs_buf_item_size_ordered(bip);\r\n*nvecs = XFS_LOG_VEC_ORDERED;\r\nreturn;\r\n}\r\nfor (i = 0; i < bip->bli_format_count; i++) {\r\nxfs_buf_item_size_segment(bip, &bip->bli_formats[i],\r\nnvecs, nbytes);\r\n}\r\ntrace_xfs_buf_item_size(bip);\r\n}\r\nstatic inline void\r\nxfs_buf_item_copy_iovec(\r\nstruct xfs_log_vec *lv,\r\nstruct xfs_log_iovec **vecp,\r\nstruct xfs_buf *bp,\r\nuint offset,\r\nint first_bit,\r\nuint nbits)\r\n{\r\noffset += first_bit * XFS_BLF_CHUNK;\r\nxlog_copy_iovec(lv, vecp, XLOG_REG_TYPE_BCHUNK,\r\nxfs_buf_offset(bp, offset),\r\nnbits * XFS_BLF_CHUNK);\r\n}\r\nstatic inline bool\r\nxfs_buf_item_straddle(\r\nstruct xfs_buf *bp,\r\nuint offset,\r\nint next_bit,\r\nint last_bit)\r\n{\r\nreturn xfs_buf_offset(bp, offset + (next_bit << XFS_BLF_SHIFT)) !=\r\n(xfs_buf_offset(bp, offset + (last_bit << XFS_BLF_SHIFT)) +\r\nXFS_BLF_CHUNK);\r\n}\r\nstatic void\r\nxfs_buf_item_format_segment(\r\nstruct xfs_buf_log_item *bip,\r\nstruct xfs_log_vec *lv,\r\nstruct xfs_log_iovec **vecp,\r\nuint offset,\r\nstruct xfs_buf_log_format *blfp)\r\n{\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nuint base_size;\r\nint first_bit;\r\nint last_bit;\r\nint next_bit;\r\nuint nbits;\r\nblfp->blf_flags = bip->__bli_format.blf_flags;\r\nbase_size = xfs_buf_log_format_size(blfp);\r\nfirst_bit = xfs_next_bit(blfp->blf_data_map, blfp->blf_map_size, 0);\r\nif (!(bip->bli_flags & XFS_BLI_STALE) && first_bit == -1) {\r\nreturn;\r\n}\r\nblfp = xlog_copy_iovec(lv, vecp, XLOG_REG_TYPE_BFORMAT, blfp, base_size);\r\nblfp->blf_size = 1;\r\nif (bip->bli_flags & XFS_BLI_STALE) {\r\ntrace_xfs_buf_item_format_stale(bip);\r\nASSERT(blfp->blf_flags & XFS_BLF_CANCEL);\r\nreturn;\r\n}\r\nlast_bit = first_bit;\r\nnbits = 1;\r\nfor (;;) {\r\nnext_bit = xfs_next_bit(blfp->blf_data_map, blfp->blf_map_size,\r\n(uint)last_bit + 1);\r\nif (next_bit == -1) {\r\nxfs_buf_item_copy_iovec(lv, vecp, bp, offset,\r\nfirst_bit, nbits);\r\nblfp->blf_size++;\r\nbreak;\r\n} else if (next_bit != last_bit + 1 ||\r\nxfs_buf_item_straddle(bp, offset, next_bit, last_bit)) {\r\nxfs_buf_item_copy_iovec(lv, vecp, bp, offset,\r\nfirst_bit, nbits);\r\nblfp->blf_size++;\r\nfirst_bit = next_bit;\r\nlast_bit = next_bit;\r\nnbits = 1;\r\n} else {\r\nlast_bit++;\r\nnbits++;\r\n}\r\n}\r\n}\r\nSTATIC void\r\nxfs_buf_item_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_vec *lv)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nstruct xfs_log_iovec *vecp = NULL;\r\nuint offset = 0;\r\nint i;\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nASSERT((bip->bli_flags & XFS_BLI_LOGGED) ||\r\n(bip->bli_flags & XFS_BLI_STALE));\r\nASSERT((bip->bli_flags & XFS_BLI_STALE) ||\r\n(xfs_blft_from_flags(&bip->__bli_format) > XFS_BLFT_UNKNOWN_BUF\r\n&& xfs_blft_from_flags(&bip->__bli_format) < XFS_BLFT_MAX_BUF));\r\nif (bip->bli_flags & XFS_BLI_INODE_BUF) {\r\nif (xfs_sb_version_hascrc(&lip->li_mountp->m_sb) ||\r\n!((bip->bli_flags & XFS_BLI_INODE_ALLOC_BUF) &&\r\nxfs_log_item_in_current_chkpt(lip)))\r\nbip->__bli_format.blf_flags |= XFS_BLF_INODE_BUF;\r\nbip->bli_flags &= ~XFS_BLI_INODE_BUF;\r\n}\r\nif ((bip->bli_flags & (XFS_BLI_ORDERED|XFS_BLI_STALE)) ==\r\nXFS_BLI_ORDERED) {\r\ntrace_xfs_buf_item_format_ordered(bip);\r\nreturn;\r\n}\r\nfor (i = 0; i < bip->bli_format_count; i++) {\r\nxfs_buf_item_format_segment(bip, lv, &vecp, offset,\r\n&bip->bli_formats[i]);\r\noffset += bp->b_maps[i].bm_len;\r\n}\r\ntrace_xfs_buf_item_format(bip);\r\n}\r\nSTATIC void\r\nxfs_buf_item_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nASSERT((bip->bli_flags & XFS_BLI_LOGGED) ||\r\n(bip->bli_flags & XFS_BLI_ORDERED) ||\r\n(bip->bli_flags & XFS_BLI_STALE));\r\ntrace_xfs_buf_item_pin(bip);\r\natomic_inc(&bip->bli_refcount);\r\natomic_inc(&bip->bli_buf->b_pin_count);\r\n}\r\nSTATIC void\r\nxfs_buf_item_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nxfs_buf_t *bp = bip->bli_buf;\r\nstruct xfs_ail *ailp = lip->li_ailp;\r\nint stale = bip->bli_flags & XFS_BLI_STALE;\r\nint freed;\r\nASSERT(bp->b_fspriv == bip);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\ntrace_xfs_buf_item_unpin(bip);\r\nfreed = atomic_dec_and_test(&bip->bli_refcount);\r\nif (atomic_dec_and_test(&bp->b_pin_count))\r\nwake_up_all(&bp->b_waiters);\r\nif (freed && stale) {\r\nASSERT(bip->bli_flags & XFS_BLI_STALE);\r\nASSERT(xfs_buf_islocked(bp));\r\nASSERT(XFS_BUF_ISSTALE(bp));\r\nASSERT(bip->__bli_format.blf_flags & XFS_BLF_CANCEL);\r\ntrace_xfs_buf_item_unpin_stale(bip);\r\nif (remove) {\r\nif (lip->li_desc)\r\nxfs_trans_del_item(lip);\r\nbp->b_transp = NULL;\r\n}\r\nif (bip->bli_flags & XFS_BLI_STALE_INODE) {\r\nxfs_buf_do_callbacks(bp);\r\nbp->b_fspriv = NULL;\r\nbp->b_iodone = NULL;\r\n} else {\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_delete(ailp, lip, SHUTDOWN_LOG_IO_ERROR);\r\nxfs_buf_item_relse(bp);\r\nASSERT(bp->b_fspriv == NULL);\r\n}\r\nxfs_buf_relse(bp);\r\n} else if (freed && remove) {\r\nxfs_buf_lock(bp);\r\nxfs_buf_hold(bp);\r\nbp->b_flags |= XBF_ASYNC;\r\nxfs_buf_ioerror(bp, -EIO);\r\nXFS_BUF_UNDONE(bp);\r\nxfs_buf_stale(bp);\r\nxfs_buf_ioend(bp);\r\n}\r\n}\r\nSTATIC uint\r\nxfs_buf_item_push(\r\nstruct xfs_log_item *lip,\r\nstruct list_head *buffer_list)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nuint rval = XFS_ITEM_SUCCESS;\r\nif (xfs_buf_ispinned(bp))\r\nreturn XFS_ITEM_PINNED;\r\nif (!xfs_buf_trylock(bp)) {\r\nif (xfs_buf_ispinned(bp))\r\nreturn XFS_ITEM_PINNED;\r\nreturn XFS_ITEM_LOCKED;\r\n}\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\ntrace_xfs_buf_item_push(bip);\r\nif ((bp->b_flags & XBF_WRITE_FAIL) &&\r\n___ratelimit(&xfs_buf_write_fail_rl_state, "XFS: Failing async write")) {\r\nxfs_warn(bp->b_target->bt_mount,\r\n"Failing async write on buffer block 0x%llx. Retrying async write.",\r\n(long long)bp->b_bn);\r\n}\r\nif (!xfs_buf_delwri_queue(bp, buffer_list))\r\nrval = XFS_ITEM_FLUSHING;\r\nxfs_buf_unlock(bp);\r\nreturn rval;\r\n}\r\nSTATIC void\r\nxfs_buf_item_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nbool clean;\r\nbool aborted;\r\nint flags;\r\nbp->b_transp = NULL;\r\naborted = (lip->li_flags & XFS_LI_ABORTED) ? true : false;\r\nflags = bip->bli_flags;\r\nbip->bli_flags &= ~(XFS_BLI_LOGGED | XFS_BLI_HOLD | XFS_BLI_ORDERED);\r\nif (flags & XFS_BLI_STALE) {\r\ntrace_xfs_buf_item_unlock_stale(bip);\r\nASSERT(bip->__bli_format.blf_flags & XFS_BLF_CANCEL);\r\nif (!aborted) {\r\natomic_dec(&bip->bli_refcount);\r\nreturn;\r\n}\r\n}\r\ntrace_xfs_buf_item_unlock(bip);\r\nclean = (flags & XFS_BLI_DIRTY) ? false : true;\r\nif (clean) {\r\nint i;\r\nfor (i = 0; i < bip->bli_format_count; i++) {\r\nif (!xfs_bitmap_empty(bip->bli_formats[i].blf_data_map,\r\nbip->bli_formats[i].blf_map_size)) {\r\nclean = false;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (atomic_dec_and_test(&bip->bli_refcount)) {\r\nif (clean)\r\nxfs_buf_item_relse(bp);\r\nelse if (aborted) {\r\nASSERT(XFS_FORCED_SHUTDOWN(lip->li_mountp));\r\nif (lip->li_flags & XFS_LI_IN_AIL) {\r\nspin_lock(&lip->li_ailp->xa_lock);\r\nxfs_trans_ail_delete(lip->li_ailp, lip,\r\nSHUTDOWN_LOG_IO_ERROR);\r\n}\r\nxfs_buf_item_relse(bp);\r\n}\r\n}\r\nif (!(flags & XFS_BLI_HOLD))\r\nxfs_buf_relse(bp);\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_buf_item_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\ntrace_xfs_buf_item_committed(bip);\r\nif ((bip->bli_flags & XFS_BLI_INODE_ALLOC_BUF) && lip->li_lsn != 0)\r\nreturn lip->li_lsn;\r\nreturn lsn;\r\n}\r\nSTATIC void\r\nxfs_buf_item_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t commit_lsn)\r\n{\r\n}\r\nSTATIC int\r\nxfs_buf_item_get_format(\r\nstruct xfs_buf_log_item *bip,\r\nint count)\r\n{\r\nASSERT(bip->bli_formats == NULL);\r\nbip->bli_format_count = count;\r\nif (count == 1) {\r\nbip->bli_formats = &bip->__bli_format;\r\nreturn 0;\r\n}\r\nbip->bli_formats = kmem_zalloc(count * sizeof(struct xfs_buf_log_format),\r\nKM_SLEEP);\r\nif (!bip->bli_formats)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_buf_item_free_format(\r\nstruct xfs_buf_log_item *bip)\r\n{\r\nif (bip->bli_formats != &bip->__bli_format) {\r\nkmem_free(bip->bli_formats);\r\nbip->bli_formats = NULL;\r\n}\r\n}\r\nvoid\r\nxfs_buf_item_init(\r\nxfs_buf_t *bp,\r\nxfs_mount_t *mp)\r\n{\r\nxfs_log_item_t *lip = bp->b_fspriv;\r\nxfs_buf_log_item_t *bip;\r\nint chunks;\r\nint map_size;\r\nint error;\r\nint i;\r\nASSERT(bp->b_target->bt_mount == mp);\r\nif (lip != NULL && lip->li_type == XFS_LI_BUF)\r\nreturn;\r\nbip = kmem_zone_zalloc(xfs_buf_item_zone, KM_SLEEP);\r\nxfs_log_item_init(mp, &bip->bli_item, XFS_LI_BUF, &xfs_buf_item_ops);\r\nbip->bli_buf = bp;\r\nxfs_buf_hold(bp);\r\nerror = xfs_buf_item_get_format(bip, bp->b_map_count);\r\nASSERT(error == 0);\r\nfor (i = 0; i < bip->bli_format_count; i++) {\r\nchunks = DIV_ROUND_UP(BBTOB(bp->b_maps[i].bm_len),\r\nXFS_BLF_CHUNK);\r\nmap_size = DIV_ROUND_UP(chunks, NBWORD);\r\nbip->bli_formats[i].blf_type = XFS_LI_BUF;\r\nbip->bli_formats[i].blf_blkno = bp->b_maps[i].bm_bn;\r\nbip->bli_formats[i].blf_len = bp->b_maps[i].bm_len;\r\nbip->bli_formats[i].blf_map_size = map_size;\r\n}\r\nif (bp->b_fspriv)\r\nbip->bli_item.li_bio_list = bp->b_fspriv;\r\nbp->b_fspriv = bip;\r\n}\r\nstatic void\r\nxfs_buf_item_log_segment(\r\nuint first,\r\nuint last,\r\nuint *map)\r\n{\r\nuint first_bit;\r\nuint last_bit;\r\nuint bits_to_set;\r\nuint bits_set;\r\nuint word_num;\r\nuint *wordp;\r\nuint bit;\r\nuint end_bit;\r\nuint mask;\r\nfirst_bit = first >> XFS_BLF_SHIFT;\r\nlast_bit = last >> XFS_BLF_SHIFT;\r\nbits_to_set = last_bit - first_bit + 1;\r\nword_num = first_bit >> BIT_TO_WORD_SHIFT;\r\nwordp = &map[word_num];\r\nbit = first_bit & (uint)(NBWORD - 1);\r\nif (bit) {\r\nend_bit = MIN(bit + bits_to_set, (uint)NBWORD);\r\nmask = ((1 << (end_bit - bit)) - 1) << bit;\r\n*wordp |= mask;\r\nwordp++;\r\nbits_set = end_bit - bit;\r\n} else {\r\nbits_set = 0;\r\n}\r\nwhile ((bits_to_set - bits_set) >= NBWORD) {\r\n*wordp |= 0xffffffff;\r\nbits_set += NBWORD;\r\nwordp++;\r\n}\r\nend_bit = bits_to_set - bits_set;\r\nif (end_bit) {\r\nmask = (1 << end_bit) - 1;\r\n*wordp |= mask;\r\n}\r\n}\r\nvoid\r\nxfs_buf_item_log(\r\nxfs_buf_log_item_t *bip,\r\nuint first,\r\nuint last)\r\n{\r\nint i;\r\nuint start;\r\nuint end;\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nstart = 0;\r\nfor (i = 0; i < bip->bli_format_count; i++) {\r\nif (start > last)\r\nbreak;\r\nend = start + BBTOB(bp->b_maps[i].bm_len);\r\nif (first > end) {\r\nstart += BBTOB(bp->b_maps[i].bm_len);\r\ncontinue;\r\n}\r\nif (first < start)\r\nfirst = start;\r\nif (end > last)\r\nend = last;\r\nxfs_buf_item_log_segment(first, end,\r\n&bip->bli_formats[i].blf_data_map[0]);\r\nstart += bp->b_maps[i].bm_len;\r\n}\r\n}\r\nuint\r\nxfs_buf_item_dirty(\r\nxfs_buf_log_item_t *bip)\r\n{\r\nreturn (bip->bli_flags & XFS_BLI_DIRTY);\r\n}\r\nSTATIC void\r\nxfs_buf_item_free(\r\nxfs_buf_log_item_t *bip)\r\n{\r\nxfs_buf_item_free_format(bip);\r\nkmem_zone_free(xfs_buf_item_zone, bip);\r\n}\r\nvoid\r\nxfs_buf_item_relse(\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\ntrace_xfs_buf_item_relse(bp, _RET_IP_);\r\nASSERT(!(bip->bli_item.li_flags & XFS_LI_IN_AIL));\r\nbp->b_fspriv = bip->bli_item.li_bio_list;\r\nif (bp->b_fspriv == NULL)\r\nbp->b_iodone = NULL;\r\nxfs_buf_rele(bp);\r\nxfs_buf_item_free(bip);\r\n}\r\nvoid\r\nxfs_buf_attach_iodone(\r\nxfs_buf_t *bp,\r\nvoid (*cb)(xfs_buf_t *, xfs_log_item_t *),\r\nxfs_log_item_t *lip)\r\n{\r\nxfs_log_item_t *head_lip;\r\nASSERT(xfs_buf_islocked(bp));\r\nlip->li_cb = cb;\r\nhead_lip = bp->b_fspriv;\r\nif (head_lip) {\r\nlip->li_bio_list = head_lip->li_bio_list;\r\nhead_lip->li_bio_list = lip;\r\n} else {\r\nbp->b_fspriv = lip;\r\n}\r\nASSERT(bp->b_iodone == NULL ||\r\nbp->b_iodone == xfs_buf_iodone_callbacks);\r\nbp->b_iodone = xfs_buf_iodone_callbacks;\r\n}\r\nSTATIC void\r\nxfs_buf_do_callbacks(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_log_item *lip;\r\nwhile ((lip = bp->b_fspriv) != NULL) {\r\nbp->b_fspriv = lip->li_bio_list;\r\nASSERT(lip->li_cb != NULL);\r\nlip->li_bio_list = NULL;\r\nlip->li_cb(bp, lip);\r\n}\r\n}\r\nvoid\r\nxfs_buf_iodone_callbacks(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_log_item *lip = bp->b_fspriv;\r\nstruct xfs_mount *mp = lip->li_mountp;\r\nstatic ulong lasttime;\r\nstatic xfs_buftarg_t *lasttarg;\r\nif (likely(!bp->b_error))\r\ngoto do_callbacks;\r\nif (XFS_FORCED_SHUTDOWN(mp)) {\r\nxfs_buf_stale(bp);\r\nXFS_BUF_DONE(bp);\r\ntrace_xfs_buf_item_iodone(bp, _RET_IP_);\r\ngoto do_callbacks;\r\n}\r\nif (bp->b_target != lasttarg ||\r\ntime_after(jiffies, (lasttime + 5*HZ))) {\r\nlasttime = jiffies;\r\nxfs_buf_ioerror_alert(bp, __func__);\r\n}\r\nlasttarg = bp->b_target;\r\nif (XFS_BUF_ISASYNC(bp)) {\r\nASSERT(bp->b_iodone != NULL);\r\ntrace_xfs_buf_item_iodone_async(bp, _RET_IP_);\r\nxfs_buf_ioerror(bp, 0);\r\nif (!(bp->b_flags & (XBF_STALE|XBF_WRITE_FAIL))) {\r\nbp->b_flags |= XBF_WRITE | XBF_ASYNC |\r\nXBF_DONE | XBF_WRITE_FAIL;\r\nxfs_buf_submit(bp);\r\n} else {\r\nxfs_buf_relse(bp);\r\n}\r\nreturn;\r\n}\r\nxfs_buf_stale(bp);\r\nXFS_BUF_DONE(bp);\r\ntrace_xfs_buf_error_relse(bp, _RET_IP_);\r\ndo_callbacks:\r\nxfs_buf_do_callbacks(bp);\r\nbp->b_fspriv = NULL;\r\nbp->b_iodone = NULL;\r\nxfs_buf_ioend(bp);\r\n}\r\nvoid\r\nxfs_buf_iodone(\r\nstruct xfs_buf *bp,\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_ail *ailp = lip->li_ailp;\r\nASSERT(BUF_ITEM(lip)->bli_buf == bp);\r\nxfs_buf_rele(bp);\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_delete(ailp, lip, SHUTDOWN_CORRUPT_INCORE);\r\nxfs_buf_item_free(BUF_ITEM(lip));\r\n}

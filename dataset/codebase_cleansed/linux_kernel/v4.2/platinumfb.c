static int platinumfb_check_var (struct fb_var_screeninfo *var, struct fb_info *info)\r\n{\r\nreturn platinum_var_to_par(var, info->par, 1);\r\n}\r\nstatic int platinumfb_set_par (struct fb_info *info)\r\n{\r\nstruct fb_info_platinum *pinfo = info->par;\r\nstruct platinum_regvals *init;\r\nint err, offset = 0x20;\r\nif((err = platinum_var_to_par(&info->var, pinfo, 0))) {\r\nprintk (KERN_ERR "platinumfb_set_par: error calling"\r\n" platinum_var_to_par: %d.\n", err);\r\nreturn err;\r\n}\r\nplatinum_set_hardware(pinfo);\r\ninit = platinum_reg_init[pinfo->vmode-1];\r\nif ((pinfo->vmode == VMODE_832_624_75) && (pinfo->cmode > CMODE_8))\r\noffset = 0x10;\r\ninfo->screen_base = pinfo->frame_buffer + init->fb_offset + offset;\r\nmutex_lock(&info->mm_lock);\r\ninfo->fix.smem_start = (pinfo->frame_buffer_phys) + init->fb_offset + offset;\r\nmutex_unlock(&info->mm_lock);\r\ninfo->fix.visual = (pinfo->cmode == CMODE_8) ?\r\nFB_VISUAL_PSEUDOCOLOR : FB_VISUAL_DIRECTCOLOR;\r\ninfo->fix.line_length = vmode_attrs[pinfo->vmode-1].hres * (1<<pinfo->cmode)\r\n+ offset;\r\nprintk("line_length: %x\n", info->fix.line_length);\r\nreturn 0;\r\n}\r\nstatic int platinumfb_blank(int blank, struct fb_info *fb)\r\n{\r\nreturn 0;\r\n}\r\nstatic int platinumfb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\r\nu_int transp, struct fb_info *info)\r\n{\r\nstruct fb_info_platinum *pinfo = info->par;\r\nvolatile struct cmap_regs __iomem *cmap_regs = pinfo->cmap_regs;\r\nif (regno > 255)\r\nreturn 1;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\npinfo->palette[regno].red = red;\r\npinfo->palette[regno].green = green;\r\npinfo->palette[regno].blue = blue;\r\nout_8(&cmap_regs->addr, regno);\r\nout_8(&cmap_regs->lut, red);\r\nout_8(&cmap_regs->lut, green);\r\nout_8(&cmap_regs->lut, blue);\r\nif (regno < 16) {\r\nint i;\r\nu32 *pal = info->pseudo_palette;\r\nswitch (pinfo->cmode) {\r\ncase CMODE_16:\r\npal[regno] = (regno << 10) | (regno << 5) | regno;\r\nbreak;\r\ncase CMODE_32:\r\ni = (regno << 8) | regno;\r\npal[regno] = (i << 16) | i;\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int platinum_vram_reqd(int video_mode, int color_mode)\r\n{\r\nint baseval = vmode_attrs[video_mode-1].hres * (1<<color_mode);\r\nif ((video_mode == VMODE_832_624_75) && (color_mode > CMODE_8))\r\nbaseval += 0x10;\r\nelse\r\nbaseval += 0x20;\r\nreturn vmode_attrs[video_mode-1].vres * baseval + 0x1000;\r\n}\r\nstatic void set_platinum_clock(struct fb_info_platinum *pinfo)\r\n{\r\nvolatile struct cmap_regs __iomem *cmap_regs = pinfo->cmap_regs;\r\nstruct platinum_regvals *init;\r\ninit = platinum_reg_init[pinfo->vmode-1];\r\nSTORE_D2(6, 0xc6);\r\nout_8(&cmap_regs->addr,3+32);\r\nif (in_8(&cmap_regs->d2) == 2) {\r\nSTORE_D2(7, init->clock_params[pinfo->clktype][0]);\r\nSTORE_D2(8, init->clock_params[pinfo->clktype][1]);\r\nSTORE_D2(3, 3);\r\n} else {\r\nSTORE_D2(4, init->clock_params[pinfo->clktype][0]);\r\nSTORE_D2(5, init->clock_params[pinfo->clktype][1]);\r\nSTORE_D2(3, 2);\r\n}\r\n__delay(5000);\r\nSTORE_D2(9, 0xa6);\r\n}\r\nstatic void platinum_set_hardware(struct fb_info_platinum *pinfo)\r\n{\r\nvolatile struct platinum_regs __iomem *platinum_regs = pinfo->platinum_regs;\r\nvolatile struct cmap_regs __iomem *cmap_regs = pinfo->cmap_regs;\r\nstruct platinum_regvals *init;\r\nint i;\r\nint vmode, cmode;\r\nvmode = pinfo->vmode;\r\ncmode = pinfo->cmode;\r\ninit = platinum_reg_init[vmode - 1];\r\nout_be32(&platinum_regs->reg[24].r, 7);\r\nfor (i = 0; i < 26; ++i)\r\nout_be32(&platinum_regs->reg[i+32].r, init->regs[i]);\r\nout_be32(&platinum_regs->reg[26+32].r, (pinfo->total_vram == 0x100000 ?\r\ninit->offset[cmode] + 4 - cmode :\r\ninit->offset[cmode]));\r\nout_be32(&platinum_regs->reg[16].r, (unsigned) pinfo->frame_buffer_phys+init->fb_offset+0x10);\r\nout_be32(&platinum_regs->reg[18].r, init->pitch[cmode]);\r\nout_be32(&platinum_regs->reg[19].r, (pinfo->total_vram == 0x100000 ?\r\ninit->mode[cmode+1] :\r\ninit->mode[cmode]));\r\nout_be32(&platinum_regs->reg[20].r, (pinfo->total_vram == 0x100000 ? 0x11 : 0x1011));\r\nout_be32(&platinum_regs->reg[21].r, 0x100);\r\nout_be32(&platinum_regs->reg[22].r, 1);\r\nout_be32(&platinum_regs->reg[23].r, 1);\r\nout_be32(&platinum_regs->reg[26].r, 0xc00);\r\nout_be32(&platinum_regs->reg[27].r, 0x235);\r\nSTORE_D2(0, (pinfo->total_vram == 0x100000 ?\r\ninit->dacula_ctrl[cmode] & 0xf :\r\ninit->dacula_ctrl[cmode]));\r\nSTORE_D2(1, 4);\r\nSTORE_D2(2, 0);\r\nset_platinum_clock(pinfo);\r\nout_be32(&platinum_regs->reg[24].r, 0);\r\n}\r\nstatic void platinum_init_info(struct fb_info *info,\r\nstruct fb_info_platinum *pinfo)\r\n{\r\ninfo->fbops = &platinumfb_ops;\r\ninfo->pseudo_palette = pinfo->pseudo_palette;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->screen_base = pinfo->frame_buffer + 0x20;\r\nfb_alloc_cmap(&info->cmap, 256, 0);\r\nstrcpy(info->fix.id, "platinum");\r\ninfo->fix.mmio_start = pinfo->platinum_regs_phys;\r\ninfo->fix.mmio_len = 0x1000;\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\ninfo->fix.smem_start = pinfo->frame_buffer_phys + 0x20;\r\ninfo->fix.smem_len = pinfo->total_vram - 0x20;\r\ninfo->fix.ywrapstep = 0;\r\ninfo->fix.xpanstep = 0;\r\ninfo->fix.ypanstep = 0;\r\ninfo->fix.type_aux = 0;\r\ninfo->fix.accel = FB_ACCEL_NONE;\r\n}\r\nstatic int platinum_init_fb(struct fb_info *info)\r\n{\r\nstruct fb_info_platinum *pinfo = info->par;\r\nstruct fb_var_screeninfo var;\r\nint sense, rc;\r\nsense = read_platinum_sense(pinfo);\r\nprintk(KERN_INFO "platinumfb: Monitor sense value = 0x%x, ", sense);\r\nif (default_vmode == VMODE_NVRAM) {\r\n#ifdef CONFIG_NVRAM\r\ndefault_vmode = nvram_read_byte(NV_VMODE);\r\nif (default_vmode <= 0 || default_vmode > VMODE_MAX ||\r\n!platinum_reg_init[default_vmode-1])\r\n#endif\r\ndefault_vmode = VMODE_CHOOSE;\r\n}\r\nif (default_vmode == VMODE_CHOOSE) {\r\ndefault_vmode = mac_map_monitor_sense(sense);\r\n}\r\nif (default_vmode <= 0 || default_vmode > VMODE_MAX)\r\ndefault_vmode = VMODE_640_480_60;\r\n#ifdef CONFIG_NVRAM\r\nif (default_cmode == CMODE_NVRAM)\r\ndefault_cmode = nvram_read_byte(NV_CMODE);\r\n#endif\r\nif (default_cmode < CMODE_8 || default_cmode > CMODE_32)\r\ndefault_cmode = CMODE_8;\r\nwhile(default_cmode > CMODE_8 &&\r\nplatinum_vram_reqd(default_vmode, default_cmode) > pinfo->total_vram)\r\ndefault_cmode--;\r\nprintk("platinumfb: Using video mode %d and color mode %d.\n", default_vmode, default_cmode);\r\nif (mac_vmode_to_var(default_vmode, default_cmode, &var) < 0) {\r\nprintk("mac_vmode_to_var(%d, %d,) failed\n", default_vmode, default_cmode);\r\ntry_again:\r\ndefault_vmode = VMODE_640_480_60;\r\ndefault_cmode = CMODE_8;\r\nif (mac_vmode_to_var(default_vmode, default_cmode, &var) < 0) {\r\nprintk(KERN_ERR "platinumfb: mac_vmode_to_var() failed\n");\r\nreturn -ENXIO;\r\n}\r\n}\r\nplatinum_init_info(info, pinfo);\r\ninfo->var = var;\r\nvar.activate = FB_ACTIVATE_NOW;\r\nrc = fb_set_var(info, &var);\r\nif (rc && (default_vmode != VMODE_640_480_60 || default_cmode != CMODE_8))\r\ngoto try_again;\r\nrc = register_framebuffer(info);\r\nif (rc < 0)\r\nreturn rc;\r\nfb_info(info, "Apple Platinum frame buffer device\n");\r\nreturn 0;\r\n}\r\nstatic int read_platinum_sense(struct fb_info_platinum *info)\r\n{\r\nvolatile struct platinum_regs __iomem *platinum_regs = info->platinum_regs;\r\nint sense;\r\nout_be32(&platinum_regs->reg[23].r, 7);\r\n__delay(2000);\r\nsense = (~in_be32(&platinum_regs->reg[23].r) & 7) << 8;\r\nout_be32(&platinum_regs->reg[23].r, 3);\r\n__delay(2000);\r\nsense |= (~in_be32(&platinum_regs->reg[23].r) & 3) << 4;\r\nout_be32(&platinum_regs->reg[23].r, 5);\r\n__delay(2000);\r\nsense |= (~in_be32(&platinum_regs->reg[23].r) & 4) << 1;\r\nsense |= (~in_be32(&platinum_regs->reg[23].r) & 1) << 2;\r\nout_be32(&platinum_regs->reg[23].r, 6);\r\n__delay(2000);\r\nsense |= (~in_be32(&platinum_regs->reg[23].r) & 6) >> 1;\r\nout_be32(&platinum_regs->reg[23].r, 7);\r\nreturn sense;\r\n}\r\nstatic int platinum_var_to_par(struct fb_var_screeninfo *var,\r\nstruct fb_info_platinum *pinfo,\r\nint check_only)\r\n{\r\nint vmode, cmode;\r\nif (mac_var_to_vmode(var, &vmode, &cmode) != 0) {\r\nprintk(KERN_ERR "platinum_var_to_par: mac_var_to_vmode unsuccessful.\n");\r\nprintk(KERN_ERR "platinum_var_to_par: var->xres = %d\n", var->xres);\r\nprintk(KERN_ERR "platinum_var_to_par: var->yres = %d\n", var->yres);\r\nprintk(KERN_ERR "platinum_var_to_par: var->xres_virtual = %d\n", var->xres_virtual);\r\nprintk(KERN_ERR "platinum_var_to_par: var->yres_virtual = %d\n", var->yres_virtual);\r\nprintk(KERN_ERR "platinum_var_to_par: var->bits_per_pixel = %d\n", var->bits_per_pixel);\r\nprintk(KERN_ERR "platinum_var_to_par: var->pixclock = %d\n", var->pixclock);\r\nprintk(KERN_ERR "platinum_var_to_par: var->vmode = %d\n", var->vmode);\r\nreturn -EINVAL;\r\n}\r\nif (!platinum_reg_init[vmode-1]) {\r\nprintk(KERN_ERR "platinum_var_to_par, vmode %d not valid.\n", vmode);\r\nreturn -EINVAL;\r\n}\r\nif (platinum_vram_reqd(vmode, cmode) > pinfo->total_vram) {\r\nprintk(KERN_ERR "platinum_var_to_par, not enough ram for vmode %d, cmode %d.\n", vmode, cmode);\r\nreturn -EINVAL;\r\n}\r\nif (mac_vmode_to_var(vmode, cmode, var))\r\nreturn -EINVAL;\r\nif (check_only)\r\nreturn 0;\r\npinfo->vmode = vmode;\r\npinfo->cmode = cmode;\r\npinfo->xres = vmode_attrs[vmode-1].hres;\r\npinfo->yres = vmode_attrs[vmode-1].vres;\r\npinfo->xoffset = 0;\r\npinfo->yoffset = 0;\r\npinfo->vxres = pinfo->xres;\r\npinfo->vyres = pinfo->yres;\r\nreturn 0;\r\n}\r\nstatic int __init platinumfb_setup(char *options)\r\n{\r\nchar *this_opt;\r\nif (!options || !*options)\r\nreturn 0;\r\nwhile ((this_opt = strsep(&options, ",")) != NULL) {\r\nif (!strncmp(this_opt, "vmode:", 6)) {\r\nint vmode = simple_strtoul(this_opt+6, NULL, 0);\r\nif (vmode > 0 && vmode <= VMODE_MAX)\r\ndefault_vmode = vmode;\r\n} else if (!strncmp(this_opt, "cmode:", 6)) {\r\nint depth = simple_strtoul(this_opt+6, NULL, 0);\r\nswitch (depth) {\r\ncase 0:\r\ncase 8:\r\ndefault_cmode = CMODE_8;\r\nbreak;\r\ncase 15:\r\ncase 16:\r\ndefault_cmode = CMODE_16;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\ndefault_cmode = CMODE_32;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int platinumfb_probe(struct platform_device* odev)\r\n{\r\nstruct device_node *dp = odev->dev.of_node;\r\nstruct fb_info *info;\r\nstruct fb_info_platinum *pinfo;\r\nvolatile __u8 *fbuffer;\r\nint bank0, bank1, bank2, bank3, rc;\r\ndev_info(&odev->dev, "Found Apple Platinum video hardware\n");\r\ninfo = framebuffer_alloc(sizeof(*pinfo), &odev->dev);\r\nif (info == NULL) {\r\ndev_err(&odev->dev, "Failed to allocate fbdev !\n");\r\nreturn -ENOMEM;\r\n}\r\npinfo = info->par;\r\nif (of_address_to_resource(dp, 0, &pinfo->rsrc_reg) ||\r\nof_address_to_resource(dp, 1, &pinfo->rsrc_fb)) {\r\ndev_err(&odev->dev, "Can't get resources\n");\r\nframebuffer_release(info);\r\nreturn -ENXIO;\r\n}\r\ndev_dbg(&odev->dev, " registers : 0x%llx...0x%llx\n",\r\n(unsigned long long)pinfo->rsrc_reg.start,\r\n(unsigned long long)pinfo->rsrc_reg.end);\r\ndev_dbg(&odev->dev, " framebuffer: 0x%llx...0x%llx\n",\r\n(unsigned long long)pinfo->rsrc_fb.start,\r\n(unsigned long long)pinfo->rsrc_fb.end);\r\nif (!request_mem_region(pinfo->rsrc_fb.start,\r\nresource_size(&pinfo->rsrc_fb),\r\n"platinumfb framebuffer")) {\r\nprintk(KERN_ERR "platinumfb: Can't request framebuffer !\n");\r\nframebuffer_release(info);\r\nreturn -ENXIO;\r\n}\r\npinfo->frame_buffer_phys = pinfo->rsrc_fb.start;\r\npinfo->frame_buffer = __ioremap(pinfo->rsrc_fb.start, 0x400000,\r\n_PAGE_WRITETHRU);\r\npinfo->base_frame_buffer = pinfo->frame_buffer;\r\npinfo->platinum_regs_phys = pinfo->rsrc_reg.start;\r\npinfo->platinum_regs = ioremap(pinfo->rsrc_reg.start, 0x1000);\r\npinfo->cmap_regs_phys = 0xf301b000;\r\nrequest_mem_region(pinfo->cmap_regs_phys, 0x1000, "platinumfb cmap");\r\npinfo->cmap_regs = ioremap(pinfo->cmap_regs_phys, 0x1000);\r\nout_be32(&pinfo->platinum_regs->reg[16].r, (unsigned)pinfo->frame_buffer_phys);\r\nout_be32(&pinfo->platinum_regs->reg[20].r, 0x1011);\r\nout_be32(&pinfo->platinum_regs->reg[24].r, 0);\r\nfbuffer = pinfo->base_frame_buffer;\r\nfbuffer[0x100000] = 0x34;\r\nfbuffer[0x100008] = 0x0;\r\ninvalidate_cache(&fbuffer[0x100000]);\r\nfbuffer[0x200000] = 0x56;\r\nfbuffer[0x200008] = 0x0;\r\ninvalidate_cache(&fbuffer[0x200000]);\r\nfbuffer[0x300000] = 0x78;\r\nfbuffer[0x300008] = 0x0;\r\ninvalidate_cache(&fbuffer[0x300000]);\r\nbank0 = 1;\r\nbank1 = fbuffer[0x100000] == 0x34;\r\nbank2 = fbuffer[0x200000] == 0x56;\r\nbank3 = fbuffer[0x300000] == 0x78;\r\npinfo->total_vram = (bank0 + bank1 + bank2 + bank3) * 0x100000;\r\nprintk(KERN_INFO "platinumfb: Total VRAM = %dMB (%d%d%d%d)\n",\r\n(unsigned int) (pinfo->total_vram / 1024 / 1024),\r\nbank3, bank2, bank1, bank0);\r\nout_8(&pinfo->cmap_regs->addr, 0x40);\r\npinfo->dactype = in_8(&pinfo->cmap_regs->d2);\r\nswitch (pinfo->dactype) {\r\ncase 0x3c:\r\npinfo->clktype = 1;\r\nprintk(KERN_INFO "platinumfb: DACula type 0x3c\n");\r\nbreak;\r\ncase 0x84:\r\npinfo->clktype = 0;\r\nprintk(KERN_INFO "platinumfb: DACula type 0x84\n");\r\nbreak;\r\ndefault:\r\npinfo->clktype = 0;\r\nprintk(KERN_INFO "platinumfb: Unknown DACula type: %x\n", pinfo->dactype);\r\nbreak;\r\n}\r\ndev_set_drvdata(&odev->dev, info);\r\nrc = platinum_init_fb(info);\r\nif (rc != 0) {\r\niounmap(pinfo->frame_buffer);\r\niounmap(pinfo->platinum_regs);\r\niounmap(pinfo->cmap_regs);\r\nframebuffer_release(info);\r\n}\r\nreturn rc;\r\n}\r\nstatic int platinumfb_remove(struct platform_device* odev)\r\n{\r\nstruct fb_info *info = dev_get_drvdata(&odev->dev);\r\nstruct fb_info_platinum *pinfo = info->par;\r\nunregister_framebuffer (info);\r\niounmap(pinfo->frame_buffer);\r\niounmap(pinfo->platinum_regs);\r\niounmap(pinfo->cmap_regs);\r\nrelease_mem_region(pinfo->rsrc_fb.start,\r\nresource_size(&pinfo->rsrc_fb));\r\nrelease_mem_region(pinfo->cmap_regs_phys, 0x1000);\r\nframebuffer_release(info);\r\nreturn 0;\r\n}\r\nstatic int __init platinumfb_init(void)\r\n{\r\n#ifndef MODULE\r\nchar *option = NULL;\r\nif (fb_get_options("platinumfb", &option))\r\nreturn -ENODEV;\r\nplatinumfb_setup(option);\r\n#endif\r\nplatform_driver_register(&platinum_driver);\r\nreturn 0;\r\n}\r\nstatic void __exit platinumfb_exit(void)\r\n{\r\nplatform_driver_unregister(&platinum_driver);\r\n}

static unsigned int\r\nnouveau_vga_set_decode(void *priv, bool state)\r\n{\r\nstruct nvif_device *device = &nouveau_drm(priv)->device;\r\nif (device->info.family == NV_DEVICE_INFO_V0_CURIE &&\r\ndevice->info.chipset >= 0x4c)\r\nnvif_wr32(device, 0x088060, state);\r\nelse\r\nif (device->info.chipset >= 0x40)\r\nnvif_wr32(device, 0x088054, state);\r\nelse\r\nnvif_wr32(device, 0x001854, state);\r\nif (state)\r\nreturn VGA_RSRC_LEGACY_IO | VGA_RSRC_LEGACY_MEM |\r\nVGA_RSRC_NORMAL_IO | VGA_RSRC_NORMAL_MEM;\r\nelse\r\nreturn VGA_RSRC_NORMAL_IO | VGA_RSRC_NORMAL_MEM;\r\n}\r\nstatic void\r\nnouveau_switcheroo_set_state(struct pci_dev *pdev,\r\nenum vga_switcheroo_state state)\r\n{\r\nstruct drm_device *dev = pci_get_drvdata(pdev);\r\nif ((nouveau_is_optimus() || nouveau_is_v1_dsm()) && state == VGA_SWITCHEROO_OFF)\r\nreturn;\r\nif (state == VGA_SWITCHEROO_ON) {\r\nprintk(KERN_ERR "VGA switcheroo: switched nouveau on\n");\r\ndev->switch_power_state = DRM_SWITCH_POWER_CHANGING;\r\nnouveau_pmops_resume(&pdev->dev);\r\ndrm_kms_helper_poll_enable(dev);\r\ndev->switch_power_state = DRM_SWITCH_POWER_ON;\r\n} else {\r\nprintk(KERN_ERR "VGA switcheroo: switched nouveau off\n");\r\ndev->switch_power_state = DRM_SWITCH_POWER_CHANGING;\r\ndrm_kms_helper_poll_disable(dev);\r\nnouveau_switcheroo_optimus_dsm();\r\nnouveau_pmops_suspend(&pdev->dev);\r\ndev->switch_power_state = DRM_SWITCH_POWER_OFF;\r\n}\r\n}\r\nstatic void\r\nnouveau_switcheroo_reprobe(struct pci_dev *pdev)\r\n{\r\nstruct drm_device *dev = pci_get_drvdata(pdev);\r\nnouveau_fbcon_output_poll_changed(dev);\r\n}\r\nstatic bool\r\nnouveau_switcheroo_can_switch(struct pci_dev *pdev)\r\n{\r\nstruct drm_device *dev = pci_get_drvdata(pdev);\r\nreturn dev->open_count == 0;\r\n}\r\nvoid\r\nnouveau_vga_init(struct nouveau_drm *drm)\r\n{\r\nstruct drm_device *dev = drm->dev;\r\nbool runtime = false;\r\nif (!dev->pdev)\r\nreturn;\r\nvga_client_register(dev->pdev, dev, NULL, nouveau_vga_set_decode);\r\nif (nouveau_runtime_pm == 1)\r\nruntime = true;\r\nif ((nouveau_runtime_pm == -1) && (nouveau_is_optimus() || nouveau_is_v1_dsm()))\r\nruntime = true;\r\nvga_switcheroo_register_client(dev->pdev, &nouveau_switcheroo_ops, runtime);\r\nif (runtime && nouveau_is_v1_dsm() && !nouveau_is_optimus())\r\nvga_switcheroo_init_domain_pm_ops(drm->dev->dev, &drm->vga_pm_domain);\r\n}\r\nvoid\r\nnouveau_vga_fini(struct nouveau_drm *drm)\r\n{\r\nstruct drm_device *dev = drm->dev;\r\nbool runtime = false;\r\nif (nouveau_runtime_pm == 1)\r\nruntime = true;\r\nif ((nouveau_runtime_pm == -1) && (nouveau_is_optimus() || nouveau_is_v1_dsm()))\r\nruntime = true;\r\nvga_switcheroo_unregister_client(dev->pdev);\r\nif (runtime && nouveau_is_v1_dsm() && !nouveau_is_optimus())\r\nvga_switcheroo_fini_domain_pm_ops(drm->dev->dev);\r\nvga_client_register(dev->pdev, NULL, NULL, NULL);\r\n}\r\nvoid\r\nnouveau_vga_lastclose(struct drm_device *dev)\r\n{\r\nvga_switcheroo_process_delayed_switch();\r\n}

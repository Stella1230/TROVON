static struct igp_ps *rs780_get_ps(struct radeon_ps *rps)\r\n{\r\nstruct igp_ps *ps = rps->ps_priv;\r\nreturn ps;\r\n}\r\nstatic struct igp_power_info *rs780_get_pi(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rdev->pm.dpm.priv;\r\nreturn pi;\r\n}\r\nstatic void rs780_get_pm_mode_parameters(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nstruct radeon_mode_info *minfo = &rdev->mode_info;\r\nstruct drm_crtc *crtc;\r\nstruct radeon_crtc *radeon_crtc;\r\nint i;\r\npi->crtc_id = 0;\r\npi->refresh_rate = 60;\r\nfor (i = 0; i < rdev->num_crtc; i++) {\r\ncrtc = (struct drm_crtc *)minfo->crtcs[i];\r\nif (crtc && crtc->enabled) {\r\nradeon_crtc = to_radeon_crtc(crtc);\r\npi->crtc_id = radeon_crtc->crtc_id;\r\nif (crtc->mode.htotal && crtc->mode.vtotal)\r\npi->refresh_rate = drm_mode_vrefresh(&crtc->mode);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int rs780_initialize_dpm_power_state(struct radeon_device *rdev,\r\nstruct radeon_ps *boot_ps)\r\n{\r\nstruct atom_clock_dividers dividers;\r\nstruct igp_ps *default_state = rs780_get_ps(boot_ps);\r\nint i, ret;\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_ENGINE_PLL_PARAM,\r\ndefault_state->sclk_low, false, &dividers);\r\nif (ret)\r\nreturn ret;\r\nr600_engine_clock_entry_set_reference_divider(rdev, 0, dividers.ref_div);\r\nr600_engine_clock_entry_set_feedback_divider(rdev, 0, dividers.fb_div);\r\nr600_engine_clock_entry_set_post_divider(rdev, 0, dividers.post_div);\r\nif (dividers.enable_post_div)\r\nr600_engine_clock_entry_enable_post_divider(rdev, 0, true);\r\nelse\r\nr600_engine_clock_entry_enable_post_divider(rdev, 0, false);\r\nr600_engine_clock_entry_set_step_time(rdev, 0, R600_SST_DFLT);\r\nr600_engine_clock_entry_enable_pulse_skipping(rdev, 0, false);\r\nr600_engine_clock_entry_enable(rdev, 0, true);\r\nfor (i = 1; i < R600_PM_NUMBER_OF_SCLKS; i++)\r\nr600_engine_clock_entry_enable(rdev, i, false);\r\nr600_enable_mclk_control(rdev, false);\r\nr600_voltage_control_enable_pins(rdev, 0);\r\nreturn 0;\r\n}\r\nstatic int rs780_initialize_dpm_parameters(struct radeon_device *rdev,\r\nstruct radeon_ps *boot_ps)\r\n{\r\nint ret = 0;\r\nint i;\r\nr600_set_bsp(rdev, R600_BSU_DFLT, R600_BSP_DFLT);\r\nr600_set_at(rdev, 0, 0, 0, 0);\r\nr600_set_git(rdev, R600_GICST_DFLT);\r\nfor (i = 0; i < R600_PM_NUMBER_OF_TC; i++)\r\nr600_set_tc(rdev, i, 0, 0);\r\nr600_select_td(rdev, R600_TD_DFLT);\r\nr600_set_vrc(rdev, 0);\r\nr600_set_tpu(rdev, R600_TPU_DFLT);\r\nr600_set_tpc(rdev, R600_TPC_DFLT);\r\nr600_set_sstu(rdev, R600_SSTU_DFLT);\r\nr600_set_sst(rdev, R600_SST_DFLT);\r\nr600_set_fctu(rdev, R600_FCTU_DFLT);\r\nr600_set_fct(rdev, R600_FCT_DFLT);\r\nr600_set_vddc3d_oorsu(rdev, R600_VDDC3DOORSU_DFLT);\r\nr600_set_vddc3d_oorphc(rdev, R600_VDDC3DOORPHC_DFLT);\r\nr600_set_vddc3d_oorsdc(rdev, R600_VDDC3DOORSDC_DFLT);\r\nr600_set_ctxcgtt3d_rphc(rdev, R600_CTXCGTT3DRPHC_DFLT);\r\nr600_set_ctxcgtt3d_rsdc(rdev, R600_CTXCGTT3DRSDC_DFLT);\r\nr600_vid_rt_set_vru(rdev, R600_VRU_DFLT);\r\nr600_vid_rt_set_vrt(rdev, R600_VOLTAGERESPONSETIME_DFLT);\r\nr600_vid_rt_set_ssu(rdev, R600_SPLLSTEPUNIT_DFLT);\r\nret = rs780_initialize_dpm_power_state(rdev, boot_ps);\r\nr600_power_level_set_voltage_index(rdev, R600_POWER_LEVEL_LOW, 0);\r\nr600_power_level_set_voltage_index(rdev, R600_POWER_LEVEL_MEDIUM, 0);\r\nr600_power_level_set_voltage_index(rdev, R600_POWER_LEVEL_HIGH, 0);\r\nr600_power_level_set_mem_clock_index(rdev, R600_POWER_LEVEL_LOW, 0);\r\nr600_power_level_set_mem_clock_index(rdev, R600_POWER_LEVEL_MEDIUM, 0);\r\nr600_power_level_set_mem_clock_index(rdev, R600_POWER_LEVEL_HIGH, 0);\r\nr600_power_level_set_eng_clock_index(rdev, R600_POWER_LEVEL_LOW, 0);\r\nr600_power_level_set_eng_clock_index(rdev, R600_POWER_LEVEL_MEDIUM, 0);\r\nr600_power_level_set_eng_clock_index(rdev, R600_POWER_LEVEL_HIGH, 0);\r\nr600_power_level_set_watermark_id(rdev, R600_POWER_LEVEL_LOW, R600_DISPLAY_WATERMARK_HIGH);\r\nr600_power_level_set_watermark_id(rdev, R600_POWER_LEVEL_MEDIUM, R600_DISPLAY_WATERMARK_HIGH);\r\nr600_power_level_set_watermark_id(rdev, R600_POWER_LEVEL_HIGH, R600_DISPLAY_WATERMARK_HIGH);\r\nr600_power_level_enable(rdev, R600_POWER_LEVEL_CTXSW, false);\r\nr600_power_level_enable(rdev, R600_POWER_LEVEL_HIGH, false);\r\nr600_power_level_enable(rdev, R600_POWER_LEVEL_MEDIUM, false);\r\nr600_power_level_enable(rdev, R600_POWER_LEVEL_LOW, true);\r\nr600_power_level_set_enter_index(rdev, R600_POWER_LEVEL_LOW);\r\nr600_set_vrc(rdev, RS780_CGFTV_DFLT);\r\nreturn ret;\r\n}\r\nstatic void rs780_start_dpm(struct radeon_device *rdev)\r\n{\r\nr600_enable_sclk_control(rdev, false);\r\nr600_enable_mclk_control(rdev, false);\r\nr600_dynamicpm_enable(rdev, true);\r\nradeon_wait_for_vblank(rdev, 0);\r\nradeon_wait_for_vblank(rdev, 1);\r\nr600_enable_spll_bypass(rdev, true);\r\nr600_wait_for_spll_change(rdev);\r\nr600_enable_spll_bypass(rdev, false);\r\nr600_wait_for_spll_change(rdev);\r\nr600_enable_spll_bypass(rdev, true);\r\nr600_wait_for_spll_change(rdev);\r\nr600_enable_spll_bypass(rdev, false);\r\nr600_wait_for_spll_change(rdev);\r\nr600_enable_sclk_control(rdev, true);\r\n}\r\nstatic void rs780_preset_ranges_slow_clk_fbdiv_en(struct radeon_device *rdev)\r\n{\r\nWREG32_P(FVTHROT_SLOW_CLK_FEEDBACK_DIV_REG1, RANGE_SLOW_CLK_FEEDBACK_DIV_EN,\r\n~RANGE_SLOW_CLK_FEEDBACK_DIV_EN);\r\nWREG32_P(FVTHROT_SLOW_CLK_FEEDBACK_DIV_REG1,\r\nRANGE0_SLOW_CLK_FEEDBACK_DIV(RS780_SLOWCLKFEEDBACKDIV_DFLT),\r\n~RANGE0_SLOW_CLK_FEEDBACK_DIV_MASK);\r\n}\r\nstatic void rs780_preset_starting_fbdiv(struct radeon_device *rdev)\r\n{\r\nu32 fbdiv = (RREG32(CG_SPLL_FUNC_CNTL) & SPLL_FB_DIV_MASK) >> SPLL_FB_DIV_SHIFT;\r\nWREG32_P(FVTHROT_FBDIV_REG1, STARTING_FEEDBACK_DIV(fbdiv),\r\n~STARTING_FEEDBACK_DIV_MASK);\r\nWREG32_P(FVTHROT_FBDIV_REG2, FORCED_FEEDBACK_DIV(fbdiv),\r\n~FORCED_FEEDBACK_DIV_MASK);\r\nWREG32_P(FVTHROT_FBDIV_REG1, FORCE_FEEDBACK_DIV, ~FORCE_FEEDBACK_DIV);\r\n}\r\nstatic void rs780_voltage_scaling_init(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nstruct drm_device *dev = rdev->ddev;\r\nu32 fv_throt_pwm_fb_div_range[3];\r\nu32 fv_throt_pwm_range[4];\r\nif (dev->pdev->device == 0x9614) {\r\nfv_throt_pwm_fb_div_range[0] = RS780D_FVTHROTPWMFBDIVRANGEREG0_DFLT;\r\nfv_throt_pwm_fb_div_range[1] = RS780D_FVTHROTPWMFBDIVRANGEREG1_DFLT;\r\nfv_throt_pwm_fb_div_range[2] = RS780D_FVTHROTPWMFBDIVRANGEREG2_DFLT;\r\n} else if ((dev->pdev->device == 0x9714) ||\r\n(dev->pdev->device == 0x9715)) {\r\nfv_throt_pwm_fb_div_range[0] = RS880D_FVTHROTPWMFBDIVRANGEREG0_DFLT;\r\nfv_throt_pwm_fb_div_range[1] = RS880D_FVTHROTPWMFBDIVRANGEREG1_DFLT;\r\nfv_throt_pwm_fb_div_range[2] = RS880D_FVTHROTPWMFBDIVRANGEREG2_DFLT;\r\n} else {\r\nfv_throt_pwm_fb_div_range[0] = RS780_FVTHROTPWMFBDIVRANGEREG0_DFLT;\r\nfv_throt_pwm_fb_div_range[1] = RS780_FVTHROTPWMFBDIVRANGEREG1_DFLT;\r\nfv_throt_pwm_fb_div_range[2] = RS780_FVTHROTPWMFBDIVRANGEREG2_DFLT;\r\n}\r\nif (pi->pwm_voltage_control) {\r\nfv_throt_pwm_range[0] = pi->min_voltage;\r\nfv_throt_pwm_range[1] = pi->min_voltage;\r\nfv_throt_pwm_range[2] = pi->max_voltage;\r\nfv_throt_pwm_range[3] = pi->max_voltage;\r\n} else {\r\nfv_throt_pwm_range[0] = pi->invert_pwm_required ?\r\nRS780_FVTHROTPWMRANGE3_GPIO_DFLT : RS780_FVTHROTPWMRANGE0_GPIO_DFLT;\r\nfv_throt_pwm_range[1] = pi->invert_pwm_required ?\r\nRS780_FVTHROTPWMRANGE2_GPIO_DFLT : RS780_FVTHROTPWMRANGE1_GPIO_DFLT;\r\nfv_throt_pwm_range[2] = pi->invert_pwm_required ?\r\nRS780_FVTHROTPWMRANGE1_GPIO_DFLT : RS780_FVTHROTPWMRANGE2_GPIO_DFLT;\r\nfv_throt_pwm_range[3] = pi->invert_pwm_required ?\r\nRS780_FVTHROTPWMRANGE0_GPIO_DFLT : RS780_FVTHROTPWMRANGE3_GPIO_DFLT;\r\n}\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0,\r\nSTARTING_PWM_HIGHTIME(pi->max_voltage),\r\n~STARTING_PWM_HIGHTIME_MASK);\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0,\r\nNUMBER_OF_CYCLES_IN_PERIOD(pi->num_of_cycles_in_period),\r\n~NUMBER_OF_CYCLES_IN_PERIOD_MASK);\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0, FORCE_STARTING_PWM_HIGHTIME,\r\n~FORCE_STARTING_PWM_HIGHTIME);\r\nif (pi->invert_pwm_required)\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0, INVERT_PWM_WAVEFORM, ~INVERT_PWM_WAVEFORM);\r\nelse\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0, 0, ~INVERT_PWM_WAVEFORM);\r\nrs780_voltage_scaling_enable(rdev, true);\r\nWREG32(FVTHROT_PWM_CTRL_REG1,\r\n(MIN_PWM_HIGHTIME(pi->min_voltage) |\r\nMAX_PWM_HIGHTIME(pi->max_voltage)));\r\nWREG32(FVTHROT_PWM_US_REG0, RS780_FVTHROTPWMUSREG0_DFLT);\r\nWREG32(FVTHROT_PWM_US_REG1, RS780_FVTHROTPWMUSREG1_DFLT);\r\nWREG32(FVTHROT_PWM_DS_REG0, RS780_FVTHROTPWMDSREG0_DFLT);\r\nWREG32(FVTHROT_PWM_DS_REG1, RS780_FVTHROTPWMDSREG1_DFLT);\r\nWREG32_P(FVTHROT_PWM_FEEDBACK_DIV_REG1,\r\nRANGE0_PWM_FEEDBACK_DIV(fv_throt_pwm_fb_div_range[0]),\r\n~RANGE0_PWM_FEEDBACK_DIV_MASK);\r\nWREG32(FVTHROT_PWM_FEEDBACK_DIV_REG2,\r\n(RANGE1_PWM_FEEDBACK_DIV(fv_throt_pwm_fb_div_range[1]) |\r\nRANGE2_PWM_FEEDBACK_DIV(fv_throt_pwm_fb_div_range[2])));\r\nWREG32(FVTHROT_PWM_FEEDBACK_DIV_REG3,\r\n(RANGE0_PWM(fv_throt_pwm_range[1]) |\r\nRANGE1_PWM(fv_throt_pwm_range[2])));\r\nWREG32(FVTHROT_PWM_FEEDBACK_DIV_REG4,\r\n(RANGE2_PWM(fv_throt_pwm_range[1]) |\r\nRANGE3_PWM(fv_throt_pwm_range[2])));\r\n}\r\nstatic void rs780_clk_scaling_enable(struct radeon_device *rdev, bool enable)\r\n{\r\nif (enable)\r\nWREG32_P(FVTHROT_CNTRL_REG, ENABLE_FV_THROT | ENABLE_FV_UPDATE,\r\n~(ENABLE_FV_THROT | ENABLE_FV_UPDATE));\r\nelse\r\nWREG32_P(FVTHROT_CNTRL_REG, 0,\r\n~(ENABLE_FV_THROT | ENABLE_FV_UPDATE));\r\n}\r\nstatic void rs780_voltage_scaling_enable(struct radeon_device *rdev, bool enable)\r\n{\r\nif (enable)\r\nWREG32_P(FVTHROT_CNTRL_REG, ENABLE_FV_THROT_IO, ~ENABLE_FV_THROT_IO);\r\nelse\r\nWREG32_P(FVTHROT_CNTRL_REG, 0, ~ENABLE_FV_THROT_IO);\r\n}\r\nstatic void rs780_set_engine_clock_wfc(struct radeon_device *rdev)\r\n{\r\nWREG32(FVTHROT_UTC0, RS780_FVTHROTUTC0_DFLT);\r\nWREG32(FVTHROT_UTC1, RS780_FVTHROTUTC1_DFLT);\r\nWREG32(FVTHROT_UTC2, RS780_FVTHROTUTC2_DFLT);\r\nWREG32(FVTHROT_UTC3, RS780_FVTHROTUTC3_DFLT);\r\nWREG32(FVTHROT_UTC4, RS780_FVTHROTUTC4_DFLT);\r\nWREG32(FVTHROT_DTC0, RS780_FVTHROTDTC0_DFLT);\r\nWREG32(FVTHROT_DTC1, RS780_FVTHROTDTC1_DFLT);\r\nWREG32(FVTHROT_DTC2, RS780_FVTHROTDTC2_DFLT);\r\nWREG32(FVTHROT_DTC3, RS780_FVTHROTDTC3_DFLT);\r\nWREG32(FVTHROT_DTC4, RS780_FVTHROTDTC4_DFLT);\r\n}\r\nstatic void rs780_set_engine_clock_sc(struct radeon_device *rdev)\r\n{\r\nWREG32_P(FVTHROT_FBDIV_REG2,\r\nFB_DIV_TIMER_VAL(RS780_FBDIVTIMERVAL_DFLT),\r\n~FB_DIV_TIMER_VAL_MASK);\r\nWREG32_P(FVTHROT_CNTRL_REG,\r\nREFRESH_RATE_DIVISOR(0) | MINIMUM_CIP(0xf),\r\n~(REFRESH_RATE_DIVISOR_MASK | MINIMUM_CIP_MASK));\r\n}\r\nstatic void rs780_set_engine_clock_tdc(struct radeon_device *rdev)\r\n{\r\nWREG32_P(FVTHROT_CNTRL_REG, 0, ~(FORCE_TREND_SEL | TREND_SEL_MODE));\r\n}\r\nstatic void rs780_set_engine_clock_ssc(struct radeon_device *rdev)\r\n{\r\nWREG32(FVTHROT_FB_US_REG0, RS780_FVTHROTFBUSREG0_DFLT);\r\nWREG32(FVTHROT_FB_US_REG1, RS780_FVTHROTFBUSREG1_DFLT);\r\nWREG32(FVTHROT_FB_DS_REG0, RS780_FVTHROTFBDSREG0_DFLT);\r\nWREG32(FVTHROT_FB_DS_REG1, RS780_FVTHROTFBDSREG1_DFLT);\r\nWREG32_P(FVTHROT_FBDIV_REG1, MAX_FEEDBACK_STEP(1), ~MAX_FEEDBACK_STEP_MASK);\r\n}\r\nstatic void rs780_program_at(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nWREG32(FVTHROT_TARGET_REG, 30000000 / pi->refresh_rate);\r\nWREG32(FVTHROT_CB1, 1000000 * 5 / pi->refresh_rate);\r\nWREG32(FVTHROT_CB2, 1000000 * 10 / pi->refresh_rate);\r\nWREG32(FVTHROT_CB3, 1000000 * 30 / pi->refresh_rate);\r\nWREG32(FVTHROT_CB4, 1000000 * 50 / pi->refresh_rate);\r\n}\r\nstatic void rs780_disable_vbios_powersaving(struct radeon_device *rdev)\r\n{\r\nWREG32_P(CG_INTGFX_MISC, 0, ~0xFFF00000);\r\n}\r\nstatic void rs780_force_voltage(struct radeon_device *rdev, u16 voltage)\r\n{\r\nstruct igp_ps *current_state = rs780_get_ps(rdev->pm.dpm.current_ps);\r\nif ((current_state->max_voltage == RS780_VDDC_LEVEL_HIGH) &&\r\n(current_state->min_voltage == RS780_VDDC_LEVEL_HIGH))\r\nreturn;\r\nWREG32_P(GFX_MACRO_BYPASS_CNTL, SPLL_BYPASS_CNTL, ~SPLL_BYPASS_CNTL);\r\nudelay(1);\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0,\r\nSTARTING_PWM_HIGHTIME(voltage),\r\n~STARTING_PWM_HIGHTIME_MASK);\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0,\r\nFORCE_STARTING_PWM_HIGHTIME, ~FORCE_STARTING_PWM_HIGHTIME);\r\nWREG32_P(FVTHROT_PWM_FEEDBACK_DIV_REG1, 0,\r\n~RANGE_PWM_FEEDBACK_DIV_EN);\r\nudelay(1);\r\nWREG32_P(GFX_MACRO_BYPASS_CNTL, 0, ~SPLL_BYPASS_CNTL);\r\n}\r\nstatic void rs780_force_fbdiv(struct radeon_device *rdev, u32 fb_div)\r\n{\r\nstruct igp_ps *current_state = rs780_get_ps(rdev->pm.dpm.current_ps);\r\nif (current_state->sclk_low == current_state->sclk_high)\r\nreturn;\r\nWREG32_P(GFX_MACRO_BYPASS_CNTL, SPLL_BYPASS_CNTL, ~SPLL_BYPASS_CNTL);\r\nWREG32_P(FVTHROT_FBDIV_REG2, FORCED_FEEDBACK_DIV(fb_div),\r\n~FORCED_FEEDBACK_DIV_MASK);\r\nWREG32_P(FVTHROT_FBDIV_REG1, STARTING_FEEDBACK_DIV(fb_div),\r\n~STARTING_FEEDBACK_DIV_MASK);\r\nWREG32_P(FVTHROT_FBDIV_REG1, FORCE_FEEDBACK_DIV, ~FORCE_FEEDBACK_DIV);\r\nudelay(100);\r\nWREG32_P(GFX_MACRO_BYPASS_CNTL, 0, ~SPLL_BYPASS_CNTL);\r\n}\r\nstatic int rs780_set_engine_clock_scaling(struct radeon_device *rdev,\r\nstruct radeon_ps *new_ps,\r\nstruct radeon_ps *old_ps)\r\n{\r\nstruct atom_clock_dividers min_dividers, max_dividers, current_max_dividers;\r\nstruct igp_ps *new_state = rs780_get_ps(new_ps);\r\nstruct igp_ps *old_state = rs780_get_ps(old_ps);\r\nint ret;\r\nif ((new_state->sclk_high == old_state->sclk_high) &&\r\n(new_state->sclk_low == old_state->sclk_low))\r\nreturn 0;\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_ENGINE_PLL_PARAM,\r\nnew_state->sclk_low, false, &min_dividers);\r\nif (ret)\r\nreturn ret;\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_ENGINE_PLL_PARAM,\r\nnew_state->sclk_high, false, &max_dividers);\r\nif (ret)\r\nreturn ret;\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_ENGINE_PLL_PARAM,\r\nold_state->sclk_high, false, &current_max_dividers);\r\nif (ret)\r\nreturn ret;\r\nif ((min_dividers.ref_div != max_dividers.ref_div) ||\r\n(min_dividers.post_div != max_dividers.post_div) ||\r\n(max_dividers.ref_div != current_max_dividers.ref_div) ||\r\n(max_dividers.post_div != current_max_dividers.post_div))\r\nreturn -EINVAL;\r\nrs780_force_fbdiv(rdev, max_dividers.fb_div);\r\nif (max_dividers.fb_div > min_dividers.fb_div) {\r\nWREG32_P(FVTHROT_FBDIV_REG0,\r\nMIN_FEEDBACK_DIV(min_dividers.fb_div) |\r\nMAX_FEEDBACK_DIV(max_dividers.fb_div),\r\n~(MIN_FEEDBACK_DIV_MASK | MAX_FEEDBACK_DIV_MASK));\r\nWREG32_P(FVTHROT_FBDIV_REG1, 0, ~FORCE_FEEDBACK_DIV);\r\n}\r\nreturn 0;\r\n}\r\nstatic void rs780_set_engine_clock_spc(struct radeon_device *rdev,\r\nstruct radeon_ps *new_ps,\r\nstruct radeon_ps *old_ps)\r\n{\r\nstruct igp_ps *new_state = rs780_get_ps(new_ps);\r\nstruct igp_ps *old_state = rs780_get_ps(old_ps);\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nif ((new_state->sclk_high == old_state->sclk_high) &&\r\n(new_state->sclk_low == old_state->sclk_low))\r\nreturn;\r\nif (pi->crtc_id == 0)\r\nWREG32_P(CG_INTGFX_MISC, 0, ~FVTHROT_VBLANK_SEL);\r\nelse\r\nWREG32_P(CG_INTGFX_MISC, FVTHROT_VBLANK_SEL, ~FVTHROT_VBLANK_SEL);\r\n}\r\nstatic void rs780_activate_engine_clk_scaling(struct radeon_device *rdev,\r\nstruct radeon_ps *new_ps,\r\nstruct radeon_ps *old_ps)\r\n{\r\nstruct igp_ps *new_state = rs780_get_ps(new_ps);\r\nstruct igp_ps *old_state = rs780_get_ps(old_ps);\r\nif ((new_state->sclk_high == old_state->sclk_high) &&\r\n(new_state->sclk_low == old_state->sclk_low))\r\nreturn;\r\nif (new_state->sclk_high == new_state->sclk_low)\r\nreturn;\r\nrs780_clk_scaling_enable(rdev, true);\r\n}\r\nstatic u32 rs780_get_voltage_for_vddc_level(struct radeon_device *rdev,\r\nenum rs780_vddc_level vddc)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nif (vddc == RS780_VDDC_LEVEL_HIGH)\r\nreturn pi->max_voltage;\r\nelse if (vddc == RS780_VDDC_LEVEL_LOW)\r\nreturn pi->min_voltage;\r\nelse\r\nreturn pi->max_voltage;\r\n}\r\nstatic void rs780_enable_voltage_scaling(struct radeon_device *rdev,\r\nstruct radeon_ps *new_ps)\r\n{\r\nstruct igp_ps *new_state = rs780_get_ps(new_ps);\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nenum rs780_vddc_level vddc_high, vddc_low;\r\nudelay(100);\r\nif ((new_state->max_voltage == RS780_VDDC_LEVEL_HIGH) &&\r\n(new_state->min_voltage == RS780_VDDC_LEVEL_HIGH))\r\nreturn;\r\nvddc_high = rs780_get_voltage_for_vddc_level(rdev,\r\nnew_state->max_voltage);\r\nvddc_low = rs780_get_voltage_for_vddc_level(rdev,\r\nnew_state->min_voltage);\r\nWREG32_P(GFX_MACRO_BYPASS_CNTL, SPLL_BYPASS_CNTL, ~SPLL_BYPASS_CNTL);\r\nudelay(1);\r\nif (vddc_high > vddc_low) {\r\nWREG32_P(FVTHROT_PWM_FEEDBACK_DIV_REG1,\r\nRANGE_PWM_FEEDBACK_DIV_EN, ~RANGE_PWM_FEEDBACK_DIV_EN);\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0, 0, ~FORCE_STARTING_PWM_HIGHTIME);\r\n} else if (vddc_high == vddc_low) {\r\nif (pi->max_voltage != vddc_high) {\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0,\r\nSTARTING_PWM_HIGHTIME(vddc_high),\r\n~STARTING_PWM_HIGHTIME_MASK);\r\nWREG32_P(FVTHROT_PWM_CTRL_REG0,\r\nFORCE_STARTING_PWM_HIGHTIME,\r\n~FORCE_STARTING_PWM_HIGHTIME);\r\n}\r\n}\r\nWREG32_P(GFX_MACRO_BYPASS_CNTL, 0, ~SPLL_BYPASS_CNTL);\r\n}\r\nstatic void rs780_set_uvd_clock_before_set_eng_clock(struct radeon_device *rdev,\r\nstruct radeon_ps *new_ps,\r\nstruct radeon_ps *old_ps)\r\n{\r\nstruct igp_ps *new_state = rs780_get_ps(new_ps);\r\nstruct igp_ps *current_state = rs780_get_ps(old_ps);\r\nif ((new_ps->vclk == old_ps->vclk) &&\r\n(new_ps->dclk == old_ps->dclk))\r\nreturn;\r\nif (new_state->sclk_high >= current_state->sclk_high)\r\nreturn;\r\nradeon_set_uvd_clocks(rdev, new_ps->vclk, new_ps->dclk);\r\n}\r\nstatic void rs780_set_uvd_clock_after_set_eng_clock(struct radeon_device *rdev,\r\nstruct radeon_ps *new_ps,\r\nstruct radeon_ps *old_ps)\r\n{\r\nstruct igp_ps *new_state = rs780_get_ps(new_ps);\r\nstruct igp_ps *current_state = rs780_get_ps(old_ps);\r\nif ((new_ps->vclk == old_ps->vclk) &&\r\n(new_ps->dclk == old_ps->dclk))\r\nreturn;\r\nif (new_state->sclk_high < current_state->sclk_high)\r\nreturn;\r\nradeon_set_uvd_clocks(rdev, new_ps->vclk, new_ps->dclk);\r\n}\r\nint rs780_dpm_enable(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nstruct radeon_ps *boot_ps = rdev->pm.dpm.boot_ps;\r\nint ret;\r\nrs780_get_pm_mode_parameters(rdev);\r\nrs780_disable_vbios_powersaving(rdev);\r\nif (r600_dynamicpm_enabled(rdev))\r\nreturn -EINVAL;\r\nret = rs780_initialize_dpm_parameters(rdev, boot_ps);\r\nif (ret)\r\nreturn ret;\r\nrs780_start_dpm(rdev);\r\nrs780_preset_ranges_slow_clk_fbdiv_en(rdev);\r\nrs780_preset_starting_fbdiv(rdev);\r\nif (pi->voltage_control)\r\nrs780_voltage_scaling_init(rdev);\r\nrs780_clk_scaling_enable(rdev, true);\r\nrs780_set_engine_clock_sc(rdev);\r\nrs780_set_engine_clock_wfc(rdev);\r\nrs780_program_at(rdev);\r\nrs780_set_engine_clock_tdc(rdev);\r\nrs780_set_engine_clock_ssc(rdev);\r\nif (pi->gfx_clock_gating)\r\nr600_gfx_clockgating_enable(rdev, true);\r\nreturn 0;\r\n}\r\nvoid rs780_dpm_disable(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nr600_dynamicpm_enable(rdev, false);\r\nrs780_clk_scaling_enable(rdev, false);\r\nrs780_voltage_scaling_enable(rdev, false);\r\nif (pi->gfx_clock_gating)\r\nr600_gfx_clockgating_enable(rdev, false);\r\nif (rdev->irq.installed &&\r\n(rdev->pm.int_thermal_type == THERMAL_TYPE_RV6XX)) {\r\nrdev->irq.dpm_thermal = false;\r\nradeon_irq_set(rdev);\r\n}\r\n}\r\nint rs780_dpm_set_power_state(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nstruct radeon_ps *new_ps = rdev->pm.dpm.requested_ps;\r\nstruct radeon_ps *old_ps = rdev->pm.dpm.current_ps;\r\nint ret;\r\nrs780_get_pm_mode_parameters(rdev);\r\nrs780_set_uvd_clock_before_set_eng_clock(rdev, new_ps, old_ps);\r\nif (pi->voltage_control) {\r\nrs780_force_voltage(rdev, pi->max_voltage);\r\nmdelay(5);\r\n}\r\nret = rs780_set_engine_clock_scaling(rdev, new_ps, old_ps);\r\nif (ret)\r\nreturn ret;\r\nrs780_set_engine_clock_spc(rdev, new_ps, old_ps);\r\nrs780_activate_engine_clk_scaling(rdev, new_ps, old_ps);\r\nif (pi->voltage_control)\r\nrs780_enable_voltage_scaling(rdev, new_ps);\r\nrs780_set_uvd_clock_after_set_eng_clock(rdev, new_ps, old_ps);\r\nreturn 0;\r\n}\r\nvoid rs780_dpm_setup_asic(struct radeon_device *rdev)\r\n{\r\n}\r\nvoid rs780_dpm_display_configuration_changed(struct radeon_device *rdev)\r\n{\r\nrs780_get_pm_mode_parameters(rdev);\r\nrs780_program_at(rdev);\r\n}\r\nstatic void rs780_parse_pplib_non_clock_info(struct radeon_device *rdev,\r\nstruct radeon_ps *rps,\r\nstruct _ATOM_PPLIB_NONCLOCK_INFO *non_clock_info,\r\nu8 table_rev)\r\n{\r\nrps->caps = le32_to_cpu(non_clock_info->ulCapsAndSettings);\r\nrps->class = le16_to_cpu(non_clock_info->usClassification);\r\nrps->class2 = le16_to_cpu(non_clock_info->usClassification2);\r\nif (ATOM_PPLIB_NONCLOCKINFO_VER1 < table_rev) {\r\nrps->vclk = le32_to_cpu(non_clock_info->ulVCLK);\r\nrps->dclk = le32_to_cpu(non_clock_info->ulDCLK);\r\n} else {\r\nrps->vclk = 0;\r\nrps->dclk = 0;\r\n}\r\nif (r600_is_uvd_state(rps->class, rps->class2)) {\r\nif ((rps->vclk == 0) || (rps->dclk == 0)) {\r\nrps->vclk = RS780_DEFAULT_VCLK_FREQ;\r\nrps->dclk = RS780_DEFAULT_DCLK_FREQ;\r\n}\r\n}\r\nif (rps->class & ATOM_PPLIB_CLASSIFICATION_BOOT)\r\nrdev->pm.dpm.boot_ps = rps;\r\nif (rps->class & ATOM_PPLIB_CLASSIFICATION_UVDSTATE)\r\nrdev->pm.dpm.uvd_ps = rps;\r\n}\r\nstatic void rs780_parse_pplib_clock_info(struct radeon_device *rdev,\r\nstruct radeon_ps *rps,\r\nunion pplib_clock_info *clock_info)\r\n{\r\nstruct igp_ps *ps = rs780_get_ps(rps);\r\nu32 sclk;\r\nsclk = le16_to_cpu(clock_info->rs780.usLowEngineClockLow);\r\nsclk |= clock_info->rs780.ucLowEngineClockHigh << 16;\r\nps->sclk_low = sclk;\r\nsclk = le16_to_cpu(clock_info->rs780.usHighEngineClockLow);\r\nsclk |= clock_info->rs780.ucHighEngineClockHigh << 16;\r\nps->sclk_high = sclk;\r\nswitch (le16_to_cpu(clock_info->rs780.usVDDC)) {\r\ncase ATOM_PPLIB_RS780_VOLTAGE_NONE:\r\ndefault:\r\nps->min_voltage = RS780_VDDC_LEVEL_UNKNOWN;\r\nps->max_voltage = RS780_VDDC_LEVEL_UNKNOWN;\r\nbreak;\r\ncase ATOM_PPLIB_RS780_VOLTAGE_LOW:\r\nps->min_voltage = RS780_VDDC_LEVEL_LOW;\r\nps->max_voltage = RS780_VDDC_LEVEL_LOW;\r\nbreak;\r\ncase ATOM_PPLIB_RS780_VOLTAGE_HIGH:\r\nps->min_voltage = RS780_VDDC_LEVEL_HIGH;\r\nps->max_voltage = RS780_VDDC_LEVEL_HIGH;\r\nbreak;\r\ncase ATOM_PPLIB_RS780_VOLTAGE_VARIABLE:\r\nps->min_voltage = RS780_VDDC_LEVEL_LOW;\r\nps->max_voltage = RS780_VDDC_LEVEL_HIGH;\r\nbreak;\r\n}\r\nps->flags = le32_to_cpu(clock_info->rs780.ulFlags);\r\nif (rps->class & ATOM_PPLIB_CLASSIFICATION_BOOT) {\r\nps->sclk_low = rdev->clock.default_sclk;\r\nps->sclk_high = rdev->clock.default_sclk;\r\nps->min_voltage = RS780_VDDC_LEVEL_HIGH;\r\nps->max_voltage = RS780_VDDC_LEVEL_HIGH;\r\n}\r\n}\r\nstatic int rs780_parse_power_table(struct radeon_device *rdev)\r\n{\r\nstruct radeon_mode_info *mode_info = &rdev->mode_info;\r\nstruct _ATOM_PPLIB_NONCLOCK_INFO *non_clock_info;\r\nunion pplib_power_state *power_state;\r\nint i;\r\nunion pplib_clock_info *clock_info;\r\nunion power_info *power_info;\r\nint index = GetIndexIntoMasterTable(DATA, PowerPlayInfo);\r\nu16 data_offset;\r\nu8 frev, crev;\r\nstruct igp_ps *ps;\r\nif (!atom_parse_data_header(mode_info->atom_context, index, NULL,\r\n&frev, &crev, &data_offset))\r\nreturn -EINVAL;\r\npower_info = (union power_info *)(mode_info->atom_context->bios + data_offset);\r\nrdev->pm.dpm.ps = kzalloc(sizeof(struct radeon_ps) *\r\npower_info->pplib.ucNumStates, GFP_KERNEL);\r\nif (!rdev->pm.dpm.ps)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < power_info->pplib.ucNumStates; i++) {\r\npower_state = (union pplib_power_state *)\r\n(mode_info->atom_context->bios + data_offset +\r\nle16_to_cpu(power_info->pplib.usStateArrayOffset) +\r\ni * power_info->pplib.ucStateEntrySize);\r\nnon_clock_info = (struct _ATOM_PPLIB_NONCLOCK_INFO *)\r\n(mode_info->atom_context->bios + data_offset +\r\nle16_to_cpu(power_info->pplib.usNonClockInfoArrayOffset) +\r\n(power_state->v1.ucNonClockStateIndex *\r\npower_info->pplib.ucNonClockSize));\r\nif (power_info->pplib.ucStateEntrySize - 1) {\r\nclock_info = (union pplib_clock_info *)\r\n(mode_info->atom_context->bios + data_offset +\r\nle16_to_cpu(power_info->pplib.usClockInfoArrayOffset) +\r\n(power_state->v1.ucClockStateIndices[0] *\r\npower_info->pplib.ucClockInfoSize));\r\nps = kzalloc(sizeof(struct igp_ps), GFP_KERNEL);\r\nif (ps == NULL) {\r\nkfree(rdev->pm.dpm.ps);\r\nreturn -ENOMEM;\r\n}\r\nrdev->pm.dpm.ps[i].ps_priv = ps;\r\nrs780_parse_pplib_non_clock_info(rdev, &rdev->pm.dpm.ps[i],\r\nnon_clock_info,\r\npower_info->pplib.ucNonClockSize);\r\nrs780_parse_pplib_clock_info(rdev,\r\n&rdev->pm.dpm.ps[i],\r\nclock_info);\r\n}\r\n}\r\nrdev->pm.dpm.num_ps = power_info->pplib.ucNumStates;\r\nreturn 0;\r\n}\r\nint rs780_dpm_init(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi;\r\nint index = GetIndexIntoMasterTable(DATA, IntegratedSystemInfo);\r\nunion igp_info *info;\r\nu16 data_offset;\r\nu8 frev, crev;\r\nint ret;\r\npi = kzalloc(sizeof(struct igp_power_info), GFP_KERNEL);\r\nif (pi == NULL)\r\nreturn -ENOMEM;\r\nrdev->pm.dpm.priv = pi;\r\nret = r600_get_platform_caps(rdev);\r\nif (ret)\r\nreturn ret;\r\nret = rs780_parse_power_table(rdev);\r\nif (ret)\r\nreturn ret;\r\npi->voltage_control = false;\r\npi->gfx_clock_gating = true;\r\nif (atom_parse_data_header(rdev->mode_info.atom_context, index, NULL,\r\n&frev, &crev, &data_offset)) {\r\ninfo = (union igp_info *)(rdev->mode_info.atom_context->bios + data_offset);\r\nswitch (crev) {\r\ncase 1:\r\npi->num_of_cycles_in_period =\r\ninfo->info.ucNumberOfCyclesInPeriod;\r\npi->num_of_cycles_in_period |=\r\ninfo->info.ucNumberOfCyclesInPeriodHi << 8;\r\npi->invert_pwm_required =\r\n(pi->num_of_cycles_in_period & 0x8000) ? true : false;\r\npi->boot_voltage = info->info.ucStartingPWM_HighTime;\r\npi->max_voltage = info->info.ucMaxNBVoltage;\r\npi->max_voltage |= info->info.ucMaxNBVoltageHigh << 8;\r\npi->min_voltage = info->info.ucMinNBVoltage;\r\npi->min_voltage |= info->info.ucMinNBVoltageHigh << 8;\r\npi->inter_voltage_low =\r\nle16_to_cpu(info->info.usInterNBVoltageLow);\r\npi->inter_voltage_high =\r\nle16_to_cpu(info->info.usInterNBVoltageHigh);\r\npi->voltage_control = true;\r\npi->bootup_uma_clk = info->info.usK8MemoryClock * 100;\r\nbreak;\r\ncase 2:\r\npi->num_of_cycles_in_period =\r\nle16_to_cpu(info->info_2.usNumberOfCyclesInPeriod);\r\npi->invert_pwm_required =\r\n(pi->num_of_cycles_in_period & 0x8000) ? true : false;\r\npi->boot_voltage =\r\nle16_to_cpu(info->info_2.usBootUpNBVoltage);\r\npi->max_voltage =\r\nle16_to_cpu(info->info_2.usMaxNBVoltage);\r\npi->min_voltage =\r\nle16_to_cpu(info->info_2.usMinNBVoltage);\r\npi->system_config =\r\nle32_to_cpu(info->info_2.ulSystemConfig);\r\npi->pwm_voltage_control =\r\n(pi->system_config & 0x4) ? true : false;\r\npi->voltage_control = true;\r\npi->bootup_uma_clk = le32_to_cpu(info->info_2.ulBootUpUMAClock);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("No integrated system info for your GPU\n");\r\nreturn -EINVAL;\r\n}\r\nif (pi->min_voltage > pi->max_voltage)\r\npi->voltage_control = false;\r\nif (pi->pwm_voltage_control) {\r\nif ((pi->num_of_cycles_in_period == 0) ||\r\n(pi->max_voltage == 0) ||\r\n(pi->min_voltage == 0))\r\npi->voltage_control = false;\r\n} else {\r\nif ((pi->num_of_cycles_in_period == 0) ||\r\n(pi->max_voltage == 0))\r\npi->voltage_control = false;\r\n}\r\nreturn 0;\r\n}\r\nradeon_dpm_fini(rdev);\r\nreturn -EINVAL;\r\n}\r\nvoid rs780_dpm_print_power_state(struct radeon_device *rdev,\r\nstruct radeon_ps *rps)\r\n{\r\nstruct igp_ps *ps = rs780_get_ps(rps);\r\nr600_dpm_print_class_info(rps->class, rps->class2);\r\nr600_dpm_print_cap_info(rps->caps);\r\nprintk("\tuvd vclk: %d dclk: %d\n", rps->vclk, rps->dclk);\r\nprintk("\t\tpower level 0 sclk: %u vddc_index: %d\n",\r\nps->sclk_low, ps->min_voltage);\r\nprintk("\t\tpower level 1 sclk: %u vddc_index: %d\n",\r\nps->sclk_high, ps->max_voltage);\r\nr600_dpm_print_ps_status(rdev, rps);\r\n}\r\nvoid rs780_dpm_fini(struct radeon_device *rdev)\r\n{\r\nint i;\r\nfor (i = 0; i < rdev->pm.dpm.num_ps; i++) {\r\nkfree(rdev->pm.dpm.ps[i].ps_priv);\r\n}\r\nkfree(rdev->pm.dpm.ps);\r\nkfree(rdev->pm.dpm.priv);\r\n}\r\nu32 rs780_dpm_get_sclk(struct radeon_device *rdev, bool low)\r\n{\r\nstruct igp_ps *requested_state = rs780_get_ps(rdev->pm.dpm.requested_ps);\r\nif (low)\r\nreturn requested_state->sclk_low;\r\nelse\r\nreturn requested_state->sclk_high;\r\n}\r\nu32 rs780_dpm_get_mclk(struct radeon_device *rdev, bool low)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nreturn pi->bootup_uma_clk;\r\n}\r\nvoid rs780_dpm_debugfs_print_current_performance_level(struct radeon_device *rdev,\r\nstruct seq_file *m)\r\n{\r\nstruct radeon_ps *rps = rdev->pm.dpm.current_ps;\r\nstruct igp_ps *ps = rs780_get_ps(rps);\r\nu32 current_fb_div = RREG32(FVTHROT_STATUS_REG0) & CURRENT_FEEDBACK_DIV_MASK;\r\nu32 func_cntl = RREG32(CG_SPLL_FUNC_CNTL);\r\nu32 ref_div = ((func_cntl & SPLL_REF_DIV_MASK) >> SPLL_REF_DIV_SHIFT) + 1;\r\nu32 post_div = ((func_cntl & SPLL_SW_HILEN_MASK) >> SPLL_SW_HILEN_SHIFT) + 1 +\r\n((func_cntl & SPLL_SW_LOLEN_MASK) >> SPLL_SW_LOLEN_SHIFT) + 1;\r\nu32 sclk = (rdev->clock.spll.reference_freq * current_fb_div) /\r\n(post_div * ref_div);\r\nseq_printf(m, "uvd vclk: %d dclk: %d\n", rps->vclk, rps->dclk);\r\nif (sclk < (ps->sclk_low + 500))\r\nseq_printf(m, "power level 0 sclk: %u vddc_index: %d\n",\r\nps->sclk_low, ps->min_voltage);\r\nelse\r\nseq_printf(m, "power level 1 sclk: %u vddc_index: %d\n",\r\nps->sclk_high, ps->max_voltage);\r\n}\r\nu32 rs780_dpm_get_current_sclk(struct radeon_device *rdev)\r\n{\r\nu32 current_fb_div = RREG32(FVTHROT_STATUS_REG0) & CURRENT_FEEDBACK_DIV_MASK;\r\nu32 func_cntl = RREG32(CG_SPLL_FUNC_CNTL);\r\nu32 ref_div = ((func_cntl & SPLL_REF_DIV_MASK) >> SPLL_REF_DIV_SHIFT) + 1;\r\nu32 post_div = ((func_cntl & SPLL_SW_HILEN_MASK) >> SPLL_SW_HILEN_SHIFT) + 1 +\r\n((func_cntl & SPLL_SW_LOLEN_MASK) >> SPLL_SW_LOLEN_SHIFT) + 1;\r\nu32 sclk = (rdev->clock.spll.reference_freq * current_fb_div) /\r\n(post_div * ref_div);\r\nreturn sclk;\r\n}\r\nu32 rs780_dpm_get_current_mclk(struct radeon_device *rdev)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nreturn pi->bootup_uma_clk;\r\n}\r\nint rs780_dpm_force_performance_level(struct radeon_device *rdev,\r\nenum radeon_dpm_forced_level level)\r\n{\r\nstruct igp_power_info *pi = rs780_get_pi(rdev);\r\nstruct radeon_ps *rps = rdev->pm.dpm.current_ps;\r\nstruct igp_ps *ps = rs780_get_ps(rps);\r\nstruct atom_clock_dividers dividers;\r\nint ret;\r\nrs780_clk_scaling_enable(rdev, false);\r\nrs780_voltage_scaling_enable(rdev, false);\r\nif (level == RADEON_DPM_FORCED_LEVEL_HIGH) {\r\nif (pi->voltage_control)\r\nrs780_force_voltage(rdev, pi->max_voltage);\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_ENGINE_PLL_PARAM,\r\nps->sclk_high, false, &dividers);\r\nif (ret)\r\nreturn ret;\r\nrs780_force_fbdiv(rdev, dividers.fb_div);\r\n} else if (level == RADEON_DPM_FORCED_LEVEL_LOW) {\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_ENGINE_PLL_PARAM,\r\nps->sclk_low, false, &dividers);\r\nif (ret)\r\nreturn ret;\r\nrs780_force_fbdiv(rdev, dividers.fb_div);\r\nif (pi->voltage_control)\r\nrs780_force_voltage(rdev, pi->min_voltage);\r\n} else {\r\nif (pi->voltage_control)\r\nrs780_force_voltage(rdev, pi->max_voltage);\r\nif (ps->sclk_high != ps->sclk_low) {\r\nWREG32_P(FVTHROT_FBDIV_REG1, 0, ~FORCE_FEEDBACK_DIV);\r\nrs780_clk_scaling_enable(rdev, true);\r\n}\r\nif (pi->voltage_control) {\r\nrs780_voltage_scaling_enable(rdev, true);\r\nrs780_enable_voltage_scaling(rdev, rps);\r\n}\r\n}\r\nrdev->pm.dpm.forced_level = level;\r\nreturn 0;\r\n}

static int q40ide_default_irq(unsigned long base)\r\n{\r\nswitch (base) {\r\ncase 0x1f0: return 14;\r\ncase 0x170: return 15;\r\ncase 0x1e8: return 11;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic void q40_ide_setup_ports(struct ide_hw *hw, unsigned long base, int irq)\r\n{\r\nmemset(hw, 0, sizeof(*hw));\r\nhw->io_ports.data_addr = Q40_ISA_IO_W(base);\r\nhw->io_ports.error_addr = Q40_ISA_IO_B(base + 1);\r\nhw->io_ports.nsect_addr = Q40_ISA_IO_B(base + 2);\r\nhw->io_ports.lbal_addr = Q40_ISA_IO_B(base + 3);\r\nhw->io_ports.lbam_addr = Q40_ISA_IO_B(base + 4);\r\nhw->io_ports.lbah_addr = Q40_ISA_IO_B(base + 5);\r\nhw->io_ports.device_addr = Q40_ISA_IO_B(base + 6);\r\nhw->io_ports.status_addr = Q40_ISA_IO_B(base + 7);\r\nhw->io_ports.ctl_addr = Q40_ISA_IO_B(base + 0x206);\r\nhw->irq = irq;\r\n}\r\nstatic void q40ide_input_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long data_addr = drive->hwif->io_ports.data_addr;\r\nif (drive->media == ide_disk && cmd && (cmd->tf_flags & IDE_TFLAG_FS)) {\r\n__ide_mm_insw(data_addr, buf, (len + 1) / 2);\r\nreturn;\r\n}\r\nraw_insw_swapw((u16 *)data_addr, buf, (len + 1) / 2);\r\n}\r\nstatic void q40ide_output_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long data_addr = drive->hwif->io_ports.data_addr;\r\nif (drive->media == ide_disk && cmd && (cmd->tf_flags & IDE_TFLAG_FS)) {\r\n__ide_mm_outsw(data_addr, buf, (len + 1) / 2);\r\nreturn;\r\n}\r\nraw_outsw_swapw((u16 *)data_addr, buf, (len + 1) / 2);\r\n}\r\nstatic int __init q40ide_init(void)\r\n{\r\nint i;\r\nstruct ide_hw hw[Q40IDE_NUM_HWIFS], *hws[] = { NULL, NULL };\r\nif (!MACH_IS_Q40)\r\nreturn -ENODEV;\r\nprintk(KERN_INFO "ide: Q40 IDE controller\n");\r\nfor (i = 0; i < Q40IDE_NUM_HWIFS; i++) {\r\nconst char *name = q40_ide_names[i];\r\nif (!request_region(pcide_bases[i], 8, name)) {\r\nprintk("could not reserve ports %lx-%lx for %s\n",\r\npcide_bases[i],pcide_bases[i]+8,name);\r\ncontinue;\r\n}\r\nif (!request_region(pcide_bases[i]+0x206, 1, name)) {\r\nprintk("could not reserve port %lx for %s\n",\r\npcide_bases[i]+0x206,name);\r\nrelease_region(pcide_bases[i], 8);\r\ncontinue;\r\n}\r\nq40_ide_setup_ports(&hw[i], pcide_bases[i],\r\nq40ide_default_irq(pcide_bases[i]));\r\nhws[i] = &hw[i];\r\n}\r\nreturn ide_host_add(&q40ide_port_info, hws, Q40IDE_NUM_HWIFS, NULL);\r\n}

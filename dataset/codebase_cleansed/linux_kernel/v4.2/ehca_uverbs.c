struct ib_ucontext *ehca_alloc_ucontext(struct ib_device *device,\r\nstruct ib_udata *udata)\r\n{\r\nstruct ehca_ucontext *my_context;\r\nmy_context = kzalloc(sizeof *my_context, GFP_KERNEL);\r\nif (!my_context) {\r\nehca_err(device, "Out of memory device=%p", device);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nreturn &my_context->ib_ucontext;\r\n}\r\nint ehca_dealloc_ucontext(struct ib_ucontext *context)\r\n{\r\nkfree(container_of(context, struct ehca_ucontext, ib_ucontext));\r\nreturn 0;\r\n}\r\nstatic void ehca_mm_open(struct vm_area_struct *vma)\r\n{\r\nu32 *count = (u32 *)vma->vm_private_data;\r\nif (!count) {\r\nehca_gen_err("Invalid vma struct vm_start=%lx vm_end=%lx",\r\nvma->vm_start, vma->vm_end);\r\nreturn;\r\n}\r\n(*count)++;\r\nif (!(*count))\r\nehca_gen_err("Use count overflow vm_start=%lx vm_end=%lx",\r\nvma->vm_start, vma->vm_end);\r\nehca_gen_dbg("vm_start=%lx vm_end=%lx count=%x",\r\nvma->vm_start, vma->vm_end, *count);\r\n}\r\nstatic void ehca_mm_close(struct vm_area_struct *vma)\r\n{\r\nu32 *count = (u32 *)vma->vm_private_data;\r\nif (!count) {\r\nehca_gen_err("Invalid vma struct vm_start=%lx vm_end=%lx",\r\nvma->vm_start, vma->vm_end);\r\nreturn;\r\n}\r\n(*count)--;\r\nehca_gen_dbg("vm_start=%lx vm_end=%lx count=%x",\r\nvma->vm_start, vma->vm_end, *count);\r\n}\r\nstatic int ehca_mmap_fw(struct vm_area_struct *vma, struct h_galpas *galpas,\r\nu32 *mm_count)\r\n{\r\nint ret;\r\nu64 vsize, physical;\r\nvsize = vma->vm_end - vma->vm_start;\r\nif (vsize < EHCA_PAGESIZE) {\r\nehca_gen_err("invalid vsize=%lx", vma->vm_end - vma->vm_start);\r\nreturn -EINVAL;\r\n}\r\nphysical = galpas->user.fw_handle;\r\nvma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);\r\nehca_gen_dbg("vsize=%llx physical=%llx", vsize, physical);\r\nret = remap_4k_pfn(vma, vma->vm_start, physical >> EHCA_PAGESHIFT,\r\nvma->vm_page_prot);\r\nif (unlikely(ret)) {\r\nehca_gen_err("remap_pfn_range() failed ret=%i", ret);\r\nreturn -ENOMEM;\r\n}\r\nvma->vm_private_data = mm_count;\r\n(*mm_count)++;\r\nvma->vm_ops = &vm_ops;\r\nreturn 0;\r\n}\r\nstatic int ehca_mmap_queue(struct vm_area_struct *vma, struct ipz_queue *queue,\r\nu32 *mm_count)\r\n{\r\nint ret;\r\nu64 start, ofs;\r\nstruct page *page;\r\nvma->vm_flags |= VM_DONTEXPAND | VM_DONTDUMP;\r\nstart = vma->vm_start;\r\nfor (ofs = 0; ofs < queue->queue_length; ofs += PAGE_SIZE) {\r\nu64 virt_addr = (u64)ipz_qeit_calc(queue, ofs);\r\npage = virt_to_page(virt_addr);\r\nret = vm_insert_page(vma, start, page);\r\nif (unlikely(ret)) {\r\nehca_gen_err("vm_insert_page() failed rc=%i", ret);\r\nreturn ret;\r\n}\r\nstart += PAGE_SIZE;\r\n}\r\nvma->vm_private_data = mm_count;\r\n(*mm_count)++;\r\nvma->vm_ops = &vm_ops;\r\nreturn 0;\r\n}\r\nstatic int ehca_mmap_cq(struct vm_area_struct *vma, struct ehca_cq *cq,\r\nu32 rsrc_type)\r\n{\r\nint ret;\r\nswitch (rsrc_type) {\r\ncase 0:\r\nehca_dbg(cq->ib_cq.device, "cq_num=%x fw", cq->cq_number);\r\nret = ehca_mmap_fw(vma, &cq->galpas, &cq->mm_count_galpa);\r\nif (unlikely(ret)) {\r\nehca_err(cq->ib_cq.device,\r\n"ehca_mmap_fw() failed rc=%i cq_num=%x",\r\nret, cq->cq_number);\r\nreturn ret;\r\n}\r\nbreak;\r\ncase 1:\r\nehca_dbg(cq->ib_cq.device, "cq_num=%x queue", cq->cq_number);\r\nret = ehca_mmap_queue(vma, &cq->ipz_queue, &cq->mm_count_queue);\r\nif (unlikely(ret)) {\r\nehca_err(cq->ib_cq.device,\r\n"ehca_mmap_queue() failed rc=%i cq_num=%x",\r\nret, cq->cq_number);\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\nehca_err(cq->ib_cq.device, "bad resource type=%x cq_num=%x",\r\nrsrc_type, cq->cq_number);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ehca_mmap_qp(struct vm_area_struct *vma, struct ehca_qp *qp,\r\nu32 rsrc_type)\r\n{\r\nint ret;\r\nswitch (rsrc_type) {\r\ncase 0:\r\nehca_dbg(qp->ib_qp.device, "qp_num=%x fw", qp->ib_qp.qp_num);\r\nret = ehca_mmap_fw(vma, &qp->galpas, &qp->mm_count_galpa);\r\nif (unlikely(ret)) {\r\nehca_err(qp->ib_qp.device,\r\n"remap_pfn_range() failed ret=%i qp_num=%x",\r\nret, qp->ib_qp.qp_num);\r\nreturn -ENOMEM;\r\n}\r\nbreak;\r\ncase 1:\r\nehca_dbg(qp->ib_qp.device, "qp_num=%x rq", qp->ib_qp.qp_num);\r\nret = ehca_mmap_queue(vma, &qp->ipz_rqueue,\r\n&qp->mm_count_rqueue);\r\nif (unlikely(ret)) {\r\nehca_err(qp->ib_qp.device,\r\n"ehca_mmap_queue(rq) failed rc=%i qp_num=%x",\r\nret, qp->ib_qp.qp_num);\r\nreturn ret;\r\n}\r\nbreak;\r\ncase 2:\r\nehca_dbg(qp->ib_qp.device, "qp_num=%x sq", qp->ib_qp.qp_num);\r\nret = ehca_mmap_queue(vma, &qp->ipz_squeue,\r\n&qp->mm_count_squeue);\r\nif (unlikely(ret)) {\r\nehca_err(qp->ib_qp.device,\r\n"ehca_mmap_queue(sq) failed rc=%i qp_num=%x",\r\nret, qp->ib_qp.qp_num);\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\nehca_err(qp->ib_qp.device, "bad resource type=%x qp=num=%x",\r\nrsrc_type, qp->ib_qp.qp_num);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint ehca_mmap(struct ib_ucontext *context, struct vm_area_struct *vma)\r\n{\r\nu64 fileoffset = vma->vm_pgoff;\r\nu32 idr_handle = fileoffset & 0x1FFFFFF;\r\nu32 q_type = (fileoffset >> 27) & 0x1;\r\nu32 rsrc_type = (fileoffset >> 25) & 0x3;\r\nu32 ret;\r\nstruct ehca_cq *cq;\r\nstruct ehca_qp *qp;\r\nstruct ib_uobject *uobject;\r\nswitch (q_type) {\r\ncase 0:\r\nread_lock(&ehca_cq_idr_lock);\r\ncq = idr_find(&ehca_cq_idr, idr_handle);\r\nread_unlock(&ehca_cq_idr_lock);\r\nif (!cq)\r\nreturn -EINVAL;\r\nif (!cq->ib_cq.uobject || cq->ib_cq.uobject->context != context)\r\nreturn -EINVAL;\r\nret = ehca_mmap_cq(vma, cq, rsrc_type);\r\nif (unlikely(ret)) {\r\nehca_err(cq->ib_cq.device,\r\n"ehca_mmap_cq() failed rc=%i cq_num=%x",\r\nret, cq->cq_number);\r\nreturn ret;\r\n}\r\nbreak;\r\ncase 1:\r\nread_lock(&ehca_qp_idr_lock);\r\nqp = idr_find(&ehca_qp_idr, idr_handle);\r\nread_unlock(&ehca_qp_idr_lock);\r\nif (!qp)\r\nreturn -EINVAL;\r\nuobject = IS_SRQ(qp) ? qp->ib_srq.uobject : qp->ib_qp.uobject;\r\nif (!uobject || uobject->context != context)\r\nreturn -EINVAL;\r\nret = ehca_mmap_qp(vma, qp, rsrc_type);\r\nif (unlikely(ret)) {\r\nehca_err(qp->ib_qp.device,\r\n"ehca_mmap_qp() failed rc=%i qp_num=%x",\r\nret, qp->ib_qp.qp_num);\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\nehca_gen_err("bad queue type %x", q_type);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

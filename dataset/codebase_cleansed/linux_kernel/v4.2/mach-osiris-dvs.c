static void osiris_dvs_tps_setdvs(bool on)\r\n{\r\nunsigned vregs1 = 0, vdcdc2 = 0;\r\nif (!on) {\r\nvdcdc2 = TPS_VCORE_DISCH | TPS_LP_COREOFF;\r\nvregs1 = TPS_LDO1_OFF;\r\n}\r\ndvs_en = on;\r\nvdcdc2 |= TPS_VCORE_1_3V | TPS_VCORE_LP_1_0V;\r\nvregs1 |= TPS_LDO2_ENABLE | TPS_LDO1_ENABLE;\r\ntps65010_config_vregs1(vregs1);\r\ntps65010_config_vdcdc2(vdcdc2);\r\n}\r\nstatic bool is_dvs(struct s3c_freq *f)\r\n{\r\nreturn f->armclk == f->hclk;\r\n}\r\nstatic int osiris_dvs_notify(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nstruct cpufreq_freqs *cf = data;\r\nstruct s3c_cpufreq_freqs *freqs = to_s3c_cpufreq(cf);\r\nbool old_dvs = is_dvs(&freqs->old);\r\nbool new_dvs = is_dvs(&freqs->new);\r\nint ret = 0;\r\nif (!dvs_en)\r\nreturn 0;\r\nprintk(KERN_DEBUG "%s: old %ld,%ld new %ld,%ld\n", __func__,\r\nfreqs->old.armclk, freqs->old.hclk,\r\nfreqs->new.armclk, freqs->new.hclk);\r\nswitch (val) {\r\ncase CPUFREQ_PRECHANGE:\r\nif (old_dvs & !new_dvs ||\r\ncur_dvs & !new_dvs) {\r\npr_debug("%s: exiting dvs\n", __func__);\r\ncur_dvs = false;\r\ngpio_set_value(OSIRIS_GPIO_DVS, 1);\r\n}\r\nbreak;\r\ncase CPUFREQ_POSTCHANGE:\r\nif (!old_dvs & new_dvs ||\r\n!cur_dvs & new_dvs) {\r\npr_debug("entering dvs\n");\r\ncur_dvs = true;\r\ngpio_set_value(OSIRIS_GPIO_DVS, 0);\r\n}\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int osiris_dvs_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\ndev_info(&pdev->dev, "initialising\n");\r\nret = gpio_request(OSIRIS_GPIO_DVS, "osiris-dvs");\r\nif (ret) {\r\ndev_err(&pdev->dev, "cannot claim gpio\n");\r\ngoto err_nogpio;\r\n}\r\ngpio_direction_output(OSIRIS_GPIO_DVS, 1);\r\nret = cpufreq_register_notifier(&osiris_dvs_nb,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register with cpufreq\n");\r\ngoto err_nofreq;\r\n}\r\nosiris_dvs_tps_setdvs(true);\r\nreturn 0;\r\nerr_nofreq:\r\ngpio_free(OSIRIS_GPIO_DVS);\r\nerr_nogpio:\r\nreturn ret;\r\n}\r\nstatic int osiris_dvs_remove(struct platform_device *pdev)\r\n{\r\ndev_info(&pdev->dev, "exiting\n");\r\ngpio_set_value(OSIRIS_GPIO_DVS, 1);\r\nosiris_dvs_tps_setdvs(false);\r\ncpufreq_unregister_notifier(&osiris_dvs_nb,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\ngpio_free(OSIRIS_GPIO_DVS);\r\nreturn 0;\r\n}\r\nstatic int osiris_dvs_suspend(struct device *dev)\r\n{\r\ngpio_set_value(OSIRIS_GPIO_DVS, 1);\r\nosiris_dvs_tps_setdvs(false);\r\ncur_dvs = false;\r\nreturn 0;\r\n}\r\nstatic int osiris_dvs_resume(struct device *dev)\r\n{\r\nosiris_dvs_tps_setdvs(true);\r\nreturn 0;\r\n}

static u8 st21nfca_se_get_bwi(struct nfc_hci_dev *hdev)\r\n{\r\nint i;\r\nu8 td;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nfor (i = 1; i < ST21NFCA_ESE_MAX_LENGTH; i++) {\r\ntd = ST21NFCA_ATR_GET_Y_FROM_TD(info->se_info.atr[i]);\r\nif (ST21NFCA_ATR_TA_PRESENT(td))\r\ni++;\r\nif (ST21NFCA_ATR_TB_PRESENT(td)) {\r\ni++;\r\nreturn info->se_info.atr[i] >> 4;\r\n}\r\n}\r\nreturn ST21NFCA_ATR_DEFAULT_BWI;\r\n}\r\nstatic void st21nfca_se_get_atr(struct nfc_hci_dev *hdev)\r\n{\r\nint r;\r\nstruct sk_buff *skb;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nr = nfc_hci_get_param(hdev, ST21NFCA_APDU_READER_GATE,\r\nST21NFCA_PARAM_ATR, &skb);\r\nif (r < 0)\r\nreturn;\r\nif (skb->len <= ST21NFCA_ESE_MAX_LENGTH) {\r\nmemcpy(info->se_info.atr, skb->data, skb->len);\r\ninfo->se_info.wt_timeout =\r\nST21NFCA_BWI_TO_TIMEOUT(st21nfca_se_get_bwi(hdev));\r\n}\r\nkfree_skb(skb);\r\n}\r\nstatic int st21nfca_hci_control_se(struct nfc_hci_dev *hdev, u32 se_idx,\r\nu8 state)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nint r;\r\nstruct sk_buff *sk_host_list;\r\nu8 se_event, host_id;\r\nswitch (se_idx) {\r\ncase NFC_HCI_UICC_HOST_ID:\r\nse_event = (state == ST21NFCA_SE_MODE_ON ?\r\nST21NFCA_EVT_UICC_ACTIVATE :\r\nST21NFCA_EVT_UICC_DEACTIVATE);\r\ninfo->se_info.count_pipes = 0;\r\ninfo->se_info.expected_pipes = ST21NFCA_SE_COUNT_PIPE_UICC;\r\nbreak;\r\ncase ST21NFCA_ESE_HOST_ID:\r\nse_event = (state == ST21NFCA_SE_MODE_ON ?\r\nST21NFCA_EVT_SE_ACTIVATE :\r\nST21NFCA_EVT_SE_DEACTIVATE);\r\ninfo->se_info.count_pipes = 0;\r\ninfo->se_info.expected_pipes = ST21NFCA_SE_COUNT_PIPE_EMBEDDED;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreinit_completion(&info->se_info.req_completion);\r\nr = nfc_hci_send_event(hdev, ST21NFCA_DEVICE_MGNT_GATE, se_event,\r\nNULL, 0);\r\nif (r < 0)\r\nreturn r;\r\nmod_timer(&info->se_info.se_active_timer, jiffies +\r\nmsecs_to_jiffies(ST21NFCA_SE_TO_HOT_PLUG));\r\ninfo->se_info.se_active = true;\r\nwait_for_completion_interruptible(&info->se_info.req_completion);\r\nr = nfc_hci_get_param(hdev, NFC_HCI_ADMIN_GATE,\r\nNFC_HCI_ADMIN_HOST_LIST,\r\n&sk_host_list);\r\nif (r < 0)\r\nreturn r;\r\nhost_id = sk_host_list->data[sk_host_list->len - 1];\r\nkfree_skb(sk_host_list);\r\nif (state == ST21NFCA_SE_MODE_ON && host_id == se_idx)\r\nreturn se_idx;\r\nelse if (state == ST21NFCA_SE_MODE_OFF && host_id != se_idx)\r\nreturn se_idx;\r\nreturn -1;\r\n}\r\nint st21nfca_hci_discover_se(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nint se_count = 0;\r\nif (info->se_status->is_uicc_present) {\r\nnfc_add_se(hdev->ndev, NFC_HCI_UICC_HOST_ID, NFC_SE_UICC);\r\nse_count++;\r\n}\r\nif (info->se_status->is_ese_present) {\r\nnfc_add_se(hdev->ndev, ST21NFCA_ESE_HOST_ID, NFC_SE_EMBEDDED);\r\nse_count++;\r\n}\r\nreturn !se_count;\r\n}\r\nint st21nfca_hci_enable_se(struct nfc_hci_dev *hdev, u32 se_idx)\r\n{\r\nint r;\r\nr = st21nfca_hci_control_se(hdev, se_idx, ST21NFCA_SE_MODE_ON);\r\nif (r == ST21NFCA_ESE_HOST_ID) {\r\nst21nfca_se_get_atr(hdev);\r\nr = nfc_hci_send_event(hdev, ST21NFCA_APDU_READER_GATE,\r\nST21NFCA_EVT_SE_SOFT_RESET, NULL, 0);\r\nif (r < 0)\r\nreturn r;\r\n} else if (r < 0) {\r\nnfc_remove_se(hdev->ndev, se_idx);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nint st21nfca_hci_disable_se(struct nfc_hci_dev *hdev, u32 se_idx)\r\n{\r\nint r;\r\nr = st21nfca_hci_control_se(hdev, se_idx, ST21NFCA_SE_MODE_OFF);\r\nif (r < 0)\r\nreturn r;\r\nreturn 0;\r\n}\r\nint st21nfca_hci_se_io(struct nfc_hci_dev *hdev, u32 se_idx,\r\nu8 *apdu, size_t apdu_length,\r\nse_io_cb_t cb, void *cb_context)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\npr_debug("se_io %x\n", se_idx);\r\nswitch (se_idx) {\r\ncase ST21NFCA_ESE_HOST_ID:\r\ninfo->se_info.cb = cb;\r\ninfo->se_info.cb_context = cb_context;\r\nmod_timer(&info->se_info.bwi_timer, jiffies +\r\nmsecs_to_jiffies(info->se_info.wt_timeout));\r\ninfo->se_info.bwi_active = true;\r\nreturn nfc_hci_send_event(hdev, ST21NFCA_APDU_READER_GATE,\r\nST21NFCA_EVT_TRANSMIT_DATA,\r\napdu, apdu_length);\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\n}\r\nstatic void st21nfca_se_wt_timeout(unsigned long data)\r\n{\r\nu8 param = 0x01;\r\nstruct st21nfca_hci_info *info = (struct st21nfca_hci_info *) data;\r\npr_debug("\n");\r\ninfo->se_info.bwi_active = false;\r\nif (!info->se_info.xch_error) {\r\ninfo->se_info.xch_error = true;\r\nnfc_hci_send_event(info->hdev, ST21NFCA_APDU_READER_GATE,\r\nST21NFCA_EVT_SE_SOFT_RESET, NULL, 0);\r\n} else {\r\ninfo->se_info.xch_error = false;\r\nnfc_hci_send_event(info->hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_EVT_SE_HARD_RESET, &param, 1);\r\n}\r\ninfo->se_info.cb(info->se_info.cb_context, NULL, 0, -ETIME);\r\n}\r\nstatic void st21nfca_se_activation_timeout(unsigned long data)\r\n{\r\nstruct st21nfca_hci_info *info = (struct st21nfca_hci_info *) data;\r\npr_debug("\n");\r\ninfo->se_info.se_active = false;\r\ncomplete(&info->se_info.req_completion);\r\n}\r\nint st21nfca_connectivity_event_received(struct nfc_hci_dev *hdev, u8 host,\r\nu8 event, struct sk_buff *skb)\r\n{\r\nint r = 0;\r\nstruct device *dev = &hdev->ndev->dev;\r\nstruct nfc_evt_transaction *transaction;\r\npr_debug("connectivity gate event: %x\n", event);\r\nswitch (event) {\r\ncase ST21NFCA_EVT_CONNECTIVITY:\r\nbreak;\r\ncase ST21NFCA_EVT_TRANSACTION:\r\nif (skb->len < NFC_MIN_AID_LENGTH + 2 &&\r\nskb->data[0] != NFC_EVT_TRANSACTION_AID_TAG)\r\nreturn -EPROTO;\r\ntransaction = (struct nfc_evt_transaction *)devm_kzalloc(dev,\r\nskb->len - 2, GFP_KERNEL);\r\ntransaction->aid_len = skb->data[1];\r\nmemcpy(transaction->aid, &skb->data[2],\r\ntransaction->aid_len);\r\nif (skb->data[transaction->aid_len + 2] !=\r\nNFC_EVT_TRANSACTION_PARAMS_TAG)\r\nreturn -EPROTO;\r\ntransaction->params_len = skb->data[transaction->aid_len + 3];\r\nmemcpy(transaction->params, skb->data +\r\ntransaction->aid_len + 4, transaction->params_len);\r\nr = nfc_se_transaction(hdev->ndev, host, transaction);\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\nkfree_skb(skb);\r\nreturn r;\r\n}\r\nint st21nfca_apdu_reader_event_received(struct nfc_hci_dev *hdev,\r\nu8 event, struct sk_buff *skb)\r\n{\r\nint r = 0;\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\npr_debug("apdu reader gate event: %x\n", event);\r\nswitch (event) {\r\ncase ST21NFCA_EVT_TRANSMIT_DATA:\r\ndel_timer_sync(&info->se_info.bwi_timer);\r\ninfo->se_info.bwi_active = false;\r\nr = nfc_hci_send_event(hdev, ST21NFCA_DEVICE_MGNT_GATE,\r\nST21NFCA_EVT_SE_END_OF_APDU_TRANSFER, NULL, 0);\r\nif (r < 0)\r\ngoto exit;\r\ninfo->se_info.cb(info->se_info.cb_context,\r\nskb->data, skb->len, 0);\r\nbreak;\r\ncase ST21NFCA_EVT_WTX_REQUEST:\r\nmod_timer(&info->se_info.bwi_timer, jiffies +\r\nmsecs_to_jiffies(info->se_info.wt_timeout));\r\nbreak;\r\n}\r\nexit:\r\nkfree_skb(skb);\r\nreturn r;\r\n}\r\nvoid st21nfca_se_init(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\ninit_completion(&info->se_info.req_completion);\r\ninit_timer(&info->se_info.bwi_timer);\r\ninfo->se_info.bwi_timer.data = (unsigned long)info;\r\ninfo->se_info.bwi_timer.function = st21nfca_se_wt_timeout;\r\ninfo->se_info.bwi_active = false;\r\ninit_timer(&info->se_info.se_active_timer);\r\ninfo->se_info.se_active_timer.data = (unsigned long)info;\r\ninfo->se_info.se_active_timer.function = st21nfca_se_activation_timeout;\r\ninfo->se_info.se_active = false;\r\ninfo->se_info.count_pipes = 0;\r\ninfo->se_info.expected_pipes = 0;\r\ninfo->se_info.xch_error = false;\r\ninfo->se_info.wt_timeout =\r\nST21NFCA_BWI_TO_TIMEOUT(ST21NFCA_ATR_DEFAULT_BWI);\r\n}\r\nvoid st21nfca_se_deinit(struct nfc_hci_dev *hdev)\r\n{\r\nstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\r\nif (info->se_info.bwi_active)\r\ndel_timer_sync(&info->se_info.bwi_timer);\r\nif (info->se_info.se_active)\r\ndel_timer_sync(&info->se_info.se_active_timer);\r\ninfo->se_info.bwi_active = false;\r\ninfo->se_info.se_active = false;\r\n}

static inline struct tegra_hdmi *\r\nhost1x_client_to_hdmi(struct host1x_client *client)\r\n{\r\nreturn container_of(client, struct tegra_hdmi, client);\r\n}\r\nstatic inline struct tegra_hdmi *to_hdmi(struct tegra_output *output)\r\n{\r\nreturn container_of(output, struct tegra_hdmi, output);\r\n}\r\nstatic inline u32 tegra_hdmi_readl(struct tegra_hdmi *hdmi,\r\nunsigned long offset)\r\n{\r\nreturn readl(hdmi->regs + (offset << 2));\r\n}\r\nstatic inline void tegra_hdmi_writel(struct tegra_hdmi *hdmi, u32 value,\r\nunsigned long offset)\r\n{\r\nwritel(value, hdmi->regs + (offset << 2));\r\n}\r\nstatic const struct tegra_hdmi_audio_config *\r\ntegra_hdmi_get_audio_config(unsigned int audio_freq, unsigned int pclk)\r\n{\r\nconst struct tegra_hdmi_audio_config *table;\r\nswitch (audio_freq) {\r\ncase 32000:\r\ntable = tegra_hdmi_audio_32k;\r\nbreak;\r\ncase 44100:\r\ntable = tegra_hdmi_audio_44_1k;\r\nbreak;\r\ncase 48000:\r\ntable = tegra_hdmi_audio_48k;\r\nbreak;\r\ncase 88200:\r\ntable = tegra_hdmi_audio_88_2k;\r\nbreak;\r\ncase 96000:\r\ntable = tegra_hdmi_audio_96k;\r\nbreak;\r\ncase 176400:\r\ntable = tegra_hdmi_audio_176_4k;\r\nbreak;\r\ncase 192000:\r\ntable = tegra_hdmi_audio_192k;\r\nbreak;\r\ndefault:\r\nreturn NULL;\r\n}\r\nwhile (table->pclk) {\r\nif (table->pclk == pclk)\r\nreturn table;\r\ntable++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void tegra_hdmi_setup_audio_fs_tables(struct tegra_hdmi *hdmi)\r\n{\r\nconst unsigned int freqs[] = {\r\n32000, 44100, 48000, 88200, 96000, 176400, 192000\r\n};\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(freqs); i++) {\r\nunsigned int f = freqs[i];\r\nunsigned int eight_half;\r\nunsigned int delta;\r\nu32 value;\r\nif (f > 96000)\r\ndelta = 2;\r\nelse if (f > 48000)\r\ndelta = 6;\r\nelse\r\ndelta = 9;\r\neight_half = (8 * HDMI_AUDIOCLK_FREQ) / (f * 128);\r\nvalue = AUDIO_FS_LOW(eight_half - delta) |\r\nAUDIO_FS_HIGH(eight_half + delta);\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_AUDIO_FS(i));\r\n}\r\n}\r\nstatic int tegra_hdmi_setup_audio(struct tegra_hdmi *hdmi, unsigned int pclk)\r\n{\r\nstruct device_node *node = hdmi->dev->of_node;\r\nconst struct tegra_hdmi_audio_config *config;\r\nunsigned int offset = 0;\r\nu32 value;\r\nswitch (hdmi->audio_source) {\r\ncase HDA:\r\nvalue = AUDIO_CNTRL0_SOURCE_SELECT_HDAL;\r\nbreak;\r\ncase SPDIF:\r\nvalue = AUDIO_CNTRL0_SOURCE_SELECT_SPDIF;\r\nbreak;\r\ndefault:\r\nvalue = AUDIO_CNTRL0_SOURCE_SELECT_AUTO;\r\nbreak;\r\n}\r\nif (of_device_is_compatible(node, "nvidia,tegra30-hdmi")) {\r\nvalue |= AUDIO_CNTRL0_ERROR_TOLERANCE(6) |\r\nAUDIO_CNTRL0_FRAMES_PER_BLOCK(0xc0);\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_AUDIO_CNTRL0);\r\n} else {\r\nvalue |= AUDIO_CNTRL0_INJECT_NULLSMPL;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_AUDIO_CNTRL0);\r\nvalue = AUDIO_CNTRL0_ERROR_TOLERANCE(6) |\r\nAUDIO_CNTRL0_FRAMES_PER_BLOCK(0xc0);\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_AUDIO_CNTRL0);\r\n}\r\nconfig = tegra_hdmi_get_audio_config(hdmi->audio_freq, pclk);\r\nif (!config) {\r\ndev_err(hdmi->dev, "cannot set audio to %u at %u pclk\n",\r\nhdmi->audio_freq, pclk);\r\nreturn -EINVAL;\r\n}\r\ntegra_hdmi_writel(hdmi, 0, HDMI_NV_PDISP_HDMI_ACR_CTRL);\r\nvalue = AUDIO_N_RESETF | AUDIO_N_GENERATE_ALTERNATE |\r\nAUDIO_N_VALUE(config->n - 1);\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_AUDIO_N);\r\ntegra_hdmi_writel(hdmi, ACR_SUBPACK_N(config->n) | ACR_ENABLE,\r\nHDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_HIGH);\r\nvalue = ACR_SUBPACK_CTS(config->cts);\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_LOW);\r\nvalue = SPARE_HW_CTS | SPARE_FORCE_SW_CTS | SPARE_CTS_RESET_VAL(1);\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_HDMI_SPARE);\r\nvalue = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_AUDIO_N);\r\nvalue &= ~AUDIO_N_RESETF;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_AUDIO_N);\r\nif (of_device_is_compatible(node, "nvidia,tegra30-hdmi")) {\r\nswitch (hdmi->audio_freq) {\r\ncase 32000:\r\noffset = HDMI_NV_PDISP_SOR_AUDIO_AVAL_0320;\r\nbreak;\r\ncase 44100:\r\noffset = HDMI_NV_PDISP_SOR_AUDIO_AVAL_0441;\r\nbreak;\r\ncase 48000:\r\noffset = HDMI_NV_PDISP_SOR_AUDIO_AVAL_0480;\r\nbreak;\r\ncase 88200:\r\noffset = HDMI_NV_PDISP_SOR_AUDIO_AVAL_0882;\r\nbreak;\r\ncase 96000:\r\noffset = HDMI_NV_PDISP_SOR_AUDIO_AVAL_0960;\r\nbreak;\r\ncase 176400:\r\noffset = HDMI_NV_PDISP_SOR_AUDIO_AVAL_1764;\r\nbreak;\r\ncase 192000:\r\noffset = HDMI_NV_PDISP_SOR_AUDIO_AVAL_1920;\r\nbreak;\r\n}\r\ntegra_hdmi_writel(hdmi, config->aval, offset);\r\n}\r\ntegra_hdmi_setup_audio_fs_tables(hdmi);\r\nreturn 0;\r\n}\r\nstatic inline u32 tegra_hdmi_subpack(const u8 *ptr, size_t size)\r\n{\r\nu32 value = 0;\r\nsize_t i;\r\nfor (i = size; i > 0; i--)\r\nvalue = (value << 8) | ptr[i - 1];\r\nreturn value;\r\n}\r\nstatic void tegra_hdmi_write_infopack(struct tegra_hdmi *hdmi, const void *data,\r\nsize_t size)\r\n{\r\nconst u8 *ptr = data;\r\nunsigned long offset;\r\nsize_t i, j;\r\nu32 value;\r\nswitch (ptr[0]) {\r\ncase HDMI_INFOFRAME_TYPE_AVI:\r\noffset = HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_HEADER;\r\nbreak;\r\ncase HDMI_INFOFRAME_TYPE_AUDIO:\r\noffset = HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_HEADER;\r\nbreak;\r\ncase HDMI_INFOFRAME_TYPE_VENDOR:\r\noffset = HDMI_NV_PDISP_HDMI_GENERIC_HEADER;\r\nbreak;\r\ndefault:\r\ndev_err(hdmi->dev, "unsupported infoframe type: %02x\n",\r\nptr[0]);\r\nreturn;\r\n}\r\nvalue = INFOFRAME_HEADER_TYPE(ptr[0]) |\r\nINFOFRAME_HEADER_VERSION(ptr[1]) |\r\nINFOFRAME_HEADER_LEN(ptr[2]);\r\ntegra_hdmi_writel(hdmi, value, offset);\r\noffset++;\r\nfor (i = 3, j = 0; i < size; i += 7, j += 8) {\r\nsize_t rem = size - i, num = min_t(size_t, rem, 4);\r\nvalue = tegra_hdmi_subpack(&ptr[i], num);\r\ntegra_hdmi_writel(hdmi, value, offset++);\r\nnum = min_t(size_t, rem - num, 3);\r\nvalue = tegra_hdmi_subpack(&ptr[i + 4], num);\r\ntegra_hdmi_writel(hdmi, value, offset++);\r\n}\r\n}\r\nstatic void tegra_hdmi_setup_avi_infoframe(struct tegra_hdmi *hdmi,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct hdmi_avi_infoframe frame;\r\nu8 buffer[17];\r\nssize_t err;\r\nif (hdmi->dvi) {\r\ntegra_hdmi_writel(hdmi, 0,\r\nHDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL);\r\nreturn;\r\n}\r\nerr = drm_hdmi_avi_infoframe_from_display_mode(&frame, mode);\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to setup AVI infoframe: %zd\n", err);\r\nreturn;\r\n}\r\nerr = hdmi_avi_infoframe_pack(&frame, buffer, sizeof(buffer));\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to pack AVI infoframe: %zd\n", err);\r\nreturn;\r\n}\r\ntegra_hdmi_write_infopack(hdmi, buffer, err);\r\ntegra_hdmi_writel(hdmi, INFOFRAME_CTRL_ENABLE,\r\nHDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL);\r\n}\r\nstatic void tegra_hdmi_setup_audio_infoframe(struct tegra_hdmi *hdmi)\r\n{\r\nstruct hdmi_audio_infoframe frame;\r\nu8 buffer[14];\r\nssize_t err;\r\nif (hdmi->dvi) {\r\ntegra_hdmi_writel(hdmi, 0,\r\nHDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL);\r\nreturn;\r\n}\r\nerr = hdmi_audio_infoframe_init(&frame);\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to setup audio infoframe: %zd\n",\r\nerr);\r\nreturn;\r\n}\r\nframe.channels = 2;\r\nerr = hdmi_audio_infoframe_pack(&frame, buffer, sizeof(buffer));\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to pack audio infoframe: %zd\n",\r\nerr);\r\nreturn;\r\n}\r\ntegra_hdmi_write_infopack(hdmi, buffer, min_t(size_t, 10, err));\r\ntegra_hdmi_writel(hdmi, INFOFRAME_CTRL_ENABLE,\r\nHDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL);\r\n}\r\nstatic void tegra_hdmi_setup_stereo_infoframe(struct tegra_hdmi *hdmi)\r\n{\r\nstruct hdmi_vendor_infoframe frame;\r\nu8 buffer[10];\r\nssize_t err;\r\nu32 value;\r\nif (!hdmi->stereo) {\r\nvalue = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_HDMI_GENERIC_CTRL);\r\nvalue &= ~GENERIC_CTRL_ENABLE;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_HDMI_GENERIC_CTRL);\r\nreturn;\r\n}\r\nhdmi_vendor_infoframe_init(&frame);\r\nframe.s3d_struct = HDMI_3D_STRUCTURE_FRAME_PACKING;\r\nerr = hdmi_vendor_infoframe_pack(&frame, buffer, sizeof(buffer));\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to pack vendor infoframe: %zd\n",\r\nerr);\r\nreturn;\r\n}\r\ntegra_hdmi_write_infopack(hdmi, buffer, err);\r\nvalue = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_HDMI_GENERIC_CTRL);\r\nvalue |= GENERIC_CTRL_ENABLE;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_HDMI_GENERIC_CTRL);\r\n}\r\nstatic void tegra_hdmi_setup_tmds(struct tegra_hdmi *hdmi,\r\nconst struct tmds_config *tmds)\r\n{\r\nu32 value;\r\ntegra_hdmi_writel(hdmi, tmds->pll0, HDMI_NV_PDISP_SOR_PLL0);\r\ntegra_hdmi_writel(hdmi, tmds->pll1, HDMI_NV_PDISP_SOR_PLL1);\r\ntegra_hdmi_writel(hdmi, tmds->pe_current, HDMI_NV_PDISP_PE_CURRENT);\r\ntegra_hdmi_writel(hdmi, tmds->drive_current,\r\nHDMI_NV_PDISP_SOR_LANE_DRIVE_CURRENT);\r\nvalue = tegra_hdmi_readl(hdmi, hdmi->config->fuse_override_offset);\r\nvalue |= hdmi->config->fuse_override_value;\r\ntegra_hdmi_writel(hdmi, value, hdmi->config->fuse_override_offset);\r\nif (hdmi->config->has_sor_io_peak_current)\r\ntegra_hdmi_writel(hdmi, tmds->peak_current,\r\nHDMI_NV_PDISP_SOR_IO_PEAK_CURRENT);\r\n}\r\nstatic bool tegra_output_is_hdmi(struct tegra_output *output)\r\n{\r\nstruct edid *edid;\r\nif (!output->connector.edid_blob_ptr)\r\nreturn false;\r\nedid = (struct edid *)output->connector.edid_blob_ptr->data;\r\nreturn drm_detect_hdmi_monitor(edid);\r\n}\r\nstatic void tegra_hdmi_connector_dpms(struct drm_connector *connector,\r\nint mode)\r\n{\r\n}\r\nstatic enum drm_mode_status\r\ntegra_hdmi_connector_mode_valid(struct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct tegra_output *output = connector_to_output(connector);\r\nstruct tegra_hdmi *hdmi = to_hdmi(output);\r\nunsigned long pclk = mode->clock * 1000;\r\nenum drm_mode_status status = MODE_OK;\r\nstruct clk *parent;\r\nlong err;\r\nparent = clk_get_parent(hdmi->clk_parent);\r\nerr = clk_round_rate(parent, pclk * 4);\r\nif (err <= 0)\r\nstatus = MODE_NOCLOCK;\r\nreturn status;\r\n}\r\nstatic void tegra_hdmi_encoder_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\n}\r\nstatic void tegra_hdmi_encoder_prepare(struct drm_encoder *encoder)\r\n{\r\n}\r\nstatic void tegra_hdmi_encoder_commit(struct drm_encoder *encoder)\r\n{\r\n}\r\nstatic void tegra_hdmi_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted)\r\n{\r\nunsigned int h_sync_width, h_front_porch, h_back_porch, i, rekey;\r\nstruct tegra_output *output = encoder_to_output(encoder);\r\nstruct tegra_dc *dc = to_tegra_dc(encoder->crtc);\r\nstruct device_node *node = output->dev->of_node;\r\nstruct tegra_hdmi *hdmi = to_hdmi(output);\r\nunsigned int pulse_start, div82, pclk;\r\nint retries = 1000;\r\nu32 value;\r\nint err;\r\nhdmi->dvi = !tegra_output_is_hdmi(output);\r\npclk = mode->clock * 1000;\r\nh_sync_width = mode->hsync_end - mode->hsync_start;\r\nh_back_porch = mode->htotal - mode->hsync_end;\r\nh_front_porch = mode->hsync_start - mode->hdisplay;\r\nerr = clk_set_rate(hdmi->clk, pclk);\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to set HDMI clock frequency: %d\n",\r\nerr);\r\n}\r\nDRM_DEBUG_KMS("HDMI clock rate: %lu Hz\n", clk_get_rate(hdmi->clk));\r\nvalue = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_SOR_PLL0);\r\nvalue &= ~SOR_PLL_PDBG;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_PLL0);\r\nusleep_range(10, 20);\r\nvalue = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_SOR_PLL0);\r\nvalue &= ~SOR_PLL_PWR;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_PLL0);\r\ntegra_dc_writel(dc, VSYNC_H_POSITION(1),\r\nDC_DISP_DISP_TIMING_OPTIONS);\r\ntegra_dc_writel(dc, DITHER_CONTROL_DISABLE | BASE_COLOR_SIZE888,\r\nDC_DISP_DISP_COLOR_CONTROL);\r\npulse_start = 1 + h_sync_width + h_back_porch - 10;\r\ntegra_dc_writel(dc, H_PULSE_2_ENABLE, DC_DISP_DISP_SIGNAL_OPTIONS0);\r\nvalue = PULSE_MODE_NORMAL | PULSE_POLARITY_HIGH | PULSE_QUAL_VACTIVE |\r\nPULSE_LAST_END_A;\r\ntegra_dc_writel(dc, value, DC_DISP_H_PULSE2_CONTROL);\r\nvalue = PULSE_START(pulse_start) | PULSE_END(pulse_start + 8);\r\ntegra_dc_writel(dc, value, DC_DISP_H_PULSE2_POSITION_A);\r\nvalue = VSYNC_WINDOW_END(0x210) | VSYNC_WINDOW_START(0x200) |\r\nVSYNC_WINDOW_ENABLE;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_HDMI_VSYNC_WINDOW);\r\nif (dc->pipe)\r\nvalue = HDMI_SRC_DISPLAYB;\r\nelse\r\nvalue = HDMI_SRC_DISPLAYA;\r\nif ((mode->hdisplay == 720) && ((mode->vdisplay == 480) ||\r\n(mode->vdisplay == 576)))\r\ntegra_hdmi_writel(hdmi,\r\nvalue | ARM_VIDEO_RANGE_FULL,\r\nHDMI_NV_PDISP_INPUT_CONTROL);\r\nelse\r\ntegra_hdmi_writel(hdmi,\r\nvalue | ARM_VIDEO_RANGE_LIMITED,\r\nHDMI_NV_PDISP_INPUT_CONTROL);\r\ndiv82 = clk_get_rate(hdmi->clk) / 1000000 * 4;\r\nvalue = SOR_REFCLK_DIV_INT(div82 >> 2) | SOR_REFCLK_DIV_FRAC(div82);\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_REFCLK);\r\nif (!hdmi->dvi) {\r\nerr = tegra_hdmi_setup_audio(hdmi, pclk);\r\nif (err < 0)\r\nhdmi->dvi = true;\r\n}\r\nif (of_device_is_compatible(node, "nvidia,tegra20-hdmi")) {\r\n}\r\nrekey = HDMI_REKEY_DEFAULT;\r\nvalue = HDMI_CTRL_REKEY(rekey);\r\nvalue |= HDMI_CTRL_MAX_AC_PACKET((h_sync_width + h_back_porch +\r\nh_front_porch - rekey - 18) / 32);\r\nif (!hdmi->dvi)\r\nvalue |= HDMI_CTRL_ENABLE;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_HDMI_CTRL);\r\nif (hdmi->dvi)\r\ntegra_hdmi_writel(hdmi, 0x0,\r\nHDMI_NV_PDISP_HDMI_GENERIC_CTRL);\r\nelse\r\ntegra_hdmi_writel(hdmi, GENERIC_CTRL_AUDIO,\r\nHDMI_NV_PDISP_HDMI_GENERIC_CTRL);\r\ntegra_hdmi_setup_avi_infoframe(hdmi, mode);\r\ntegra_hdmi_setup_audio_infoframe(hdmi);\r\ntegra_hdmi_setup_stereo_infoframe(hdmi);\r\nfor (i = 0; i < hdmi->config->num_tmds; i++) {\r\nif (pclk <= hdmi->config->tmds[i].pclk) {\r\ntegra_hdmi_setup_tmds(hdmi, &hdmi->config->tmds[i]);\r\nbreak;\r\n}\r\n}\r\ntegra_hdmi_writel(hdmi,\r\nSOR_SEQ_PU_PC(0) |\r\nSOR_SEQ_PU_PC_ALT(0) |\r\nSOR_SEQ_PD_PC(8) |\r\nSOR_SEQ_PD_PC_ALT(8),\r\nHDMI_NV_PDISP_SOR_SEQ_CTL);\r\nvalue = SOR_SEQ_INST_WAIT_TIME(1) |\r\nSOR_SEQ_INST_WAIT_UNITS_VSYNC |\r\nSOR_SEQ_INST_HALT |\r\nSOR_SEQ_INST_PIN_A_LOW |\r\nSOR_SEQ_INST_PIN_B_LOW |\r\nSOR_SEQ_INST_DRIVE_PWM_OUT_LO;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_SEQ_INST(0));\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_SEQ_INST(8));\r\nvalue = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_SOR_CSTM);\r\nvalue &= ~SOR_CSTM_ROTCLK(~0);\r\nvalue |= SOR_CSTM_ROTCLK(2);\r\nvalue |= SOR_CSTM_PLLDIV;\r\nvalue &= ~SOR_CSTM_LVDS_ENABLE;\r\nvalue &= ~SOR_CSTM_MODE_MASK;\r\nvalue |= SOR_CSTM_MODE_TMDS;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_CSTM);\r\ntegra_hdmi_writel(hdmi,\r\nSOR_PWR_NORMAL_STATE_PU |\r\nSOR_PWR_NORMAL_START_NORMAL |\r\nSOR_PWR_SAFE_STATE_PD |\r\nSOR_PWR_SETTING_NEW_TRIGGER,\r\nHDMI_NV_PDISP_SOR_PWR);\r\ntegra_hdmi_writel(hdmi,\r\nSOR_PWR_NORMAL_STATE_PU |\r\nSOR_PWR_NORMAL_START_NORMAL |\r\nSOR_PWR_SAFE_STATE_PD |\r\nSOR_PWR_SETTING_NEW_DONE,\r\nHDMI_NV_PDISP_SOR_PWR);\r\ndo {\r\nBUG_ON(--retries < 0);\r\nvalue = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_SOR_PWR);\r\n} while (value & SOR_PWR_SETTING_NEW_PENDING);\r\nvalue = SOR_STATE_ASY_CRCMODE_COMPLETE |\r\nSOR_STATE_ASY_OWNER_HEAD0 |\r\nSOR_STATE_ASY_SUBOWNER_BOTH |\r\nSOR_STATE_ASY_PROTOCOL_SINGLE_TMDS_A |\r\nSOR_STATE_ASY_DEPOL_POS;\r\nif (mode->flags & DRM_MODE_FLAG_PHSYNC)\r\nvalue |= SOR_STATE_ASY_HSYNCPOL_POS;\r\nif (mode->flags & DRM_MODE_FLAG_NHSYNC)\r\nvalue |= SOR_STATE_ASY_HSYNCPOL_NEG;\r\nif (mode->flags & DRM_MODE_FLAG_PVSYNC)\r\nvalue |= SOR_STATE_ASY_VSYNCPOL_POS;\r\nif (mode->flags & DRM_MODE_FLAG_NVSYNC)\r\nvalue |= SOR_STATE_ASY_VSYNCPOL_NEG;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_STATE2);\r\nvalue = SOR_STATE_ASY_HEAD_OPMODE_AWAKE | SOR_STATE_ASY_ORMODE_NORMAL;\r\ntegra_hdmi_writel(hdmi, value, HDMI_NV_PDISP_SOR_STATE1);\r\ntegra_hdmi_writel(hdmi, 0, HDMI_NV_PDISP_SOR_STATE0);\r\ntegra_hdmi_writel(hdmi, SOR_STATE_UPDATE, HDMI_NV_PDISP_SOR_STATE0);\r\ntegra_hdmi_writel(hdmi, value | SOR_STATE_ATTACHED,\r\nHDMI_NV_PDISP_SOR_STATE1);\r\ntegra_hdmi_writel(hdmi, 0, HDMI_NV_PDISP_SOR_STATE0);\r\nvalue = tegra_dc_readl(dc, DC_DISP_DISP_WIN_OPTIONS);\r\nvalue |= HDMI_ENABLE;\r\ntegra_dc_writel(dc, value, DC_DISP_DISP_WIN_OPTIONS);\r\ntegra_dc_commit(dc);\r\n}\r\nstatic void tegra_hdmi_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct tegra_dc *dc = to_tegra_dc(encoder->crtc);\r\nu32 value;\r\nif (dc) {\r\nvalue = tegra_dc_readl(dc, DC_DISP_DISP_WIN_OPTIONS);\r\nvalue &= ~HDMI_ENABLE;\r\ntegra_dc_writel(dc, value, DC_DISP_DISP_WIN_OPTIONS);\r\ntegra_dc_commit(dc);\r\n}\r\n}\r\nstatic int\r\ntegra_hdmi_encoder_atomic_check(struct drm_encoder *encoder,\r\nstruct drm_crtc_state *crtc_state,\r\nstruct drm_connector_state *conn_state)\r\n{\r\nstruct tegra_output *output = encoder_to_output(encoder);\r\nstruct tegra_dc *dc = to_tegra_dc(conn_state->crtc);\r\nunsigned long pclk = crtc_state->mode.clock * 1000;\r\nstruct tegra_hdmi *hdmi = to_hdmi(output);\r\nint err;\r\nerr = tegra_dc_state_setup_clock(dc, crtc_state, hdmi->clk_parent,\r\npclk, 0);\r\nif (err < 0) {\r\ndev_err(output->dev, "failed to setup CRTC state: %d\n", err);\r\nreturn err;\r\n}\r\nreturn err;\r\n}\r\nstatic int tegra_hdmi_show_regs(struct seq_file *s, void *data)\r\n{\r\nstruct drm_info_node *node = s->private;\r\nstruct tegra_hdmi *hdmi = node->info_ent->data;\r\nint err;\r\nerr = clk_prepare_enable(hdmi->clk);\r\nif (err)\r\nreturn err;\r\n#define DUMP_REG(name) \\r\nseq_printf(s, "%-56s %#05x %08x\n", #name, name, \\r\ntegra_hdmi_readl(hdmi, name))\r\nDUMP_REG(HDMI_CTXSW);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_STATE0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_STATE1);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_STATE2);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AN_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AN_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CN_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CN_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AKSV_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AKSV_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_BKSV_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_BKSV_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CKSV_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CKSV_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_DKSV_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_DKSV_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CMODE);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_MPRIME_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_MPRIME_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_SPRIME_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_SPRIME_LSB2);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_SPRIME_LSB1);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_RI);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CS_MSB);\r\nDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CS_LSB);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU0);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU_RDATA0);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU1);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU2);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_STATUS);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_HEADER);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_STATUS);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_HEADER);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_STATUS);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_HEADER);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK0_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK0_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK1_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK1_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK2_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK2_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK3_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK3_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0320_SUBPACK_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0320_SUBPACK_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0882_SUBPACK_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0882_SUBPACK_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1764_SUBPACK_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1764_SUBPACK_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0480_SUBPACK_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0480_SUBPACK_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0960_SUBPACK_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0960_SUBPACK_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1920_SUBPACK_LOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1920_SUBPACK_HIGH);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_VSYNC_KEEPOUT);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_VSYNC_WINDOW);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GCP_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GCP_STATUS);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_GCP_SUBPACK);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_CHANNEL_STATUS1);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_CHANNEL_STATUS2);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_EMU0);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_EMU1);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_EMU1_RDATA);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_SPARE);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_SPDIF_CHN_STATUS1);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_SPDIF_CHN_STATUS2);\r\nDUMP_REG(HDMI_NV_PDISP_HDMI_HDCPRIF_ROM_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_CAP);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_PWR);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_TEST);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_PLL0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_PLL1);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_PLL2);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_CSTM);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_LVDS);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_CRCA);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_CRCB);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_BLANK);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_CTL);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(0));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(1));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(2));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(3));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(4));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(5));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(6));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(7));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(8));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(9));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(10));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(11));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(12));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(13));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(14));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST(15));\r\nDUMP_REG(HDMI_NV_PDISP_SOR_VCRCA0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_VCRCA1);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_CCRCA0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_CCRCA1);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_EDATAA0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_EDATAA1);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_COUNTA0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_COUNTA1);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_DEBUGA0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_DEBUGA1);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_TRIG);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_MSCHECK);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_LANE_DRIVE_CURRENT);\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_DEBUG0);\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_DEBUG1);\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_DEBUG2);\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_FS(0));\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_FS(1));\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_FS(2));\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_FS(3));\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_FS(4));\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_FS(5));\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_FS(6));\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_PULSE_WIDTH);\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_THRESHOLD);\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_CNTRL0);\r\nDUMP_REG(HDMI_NV_PDISP_AUDIO_N);\r\nDUMP_REG(HDMI_NV_PDISP_HDCPRIF_ROM_TIMING);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_REFCLK);\r\nDUMP_REG(HDMI_NV_PDISP_CRC_CONTROL);\r\nDUMP_REG(HDMI_NV_PDISP_INPUT_CONTROL);\r\nDUMP_REG(HDMI_NV_PDISP_SCRATCH);\r\nDUMP_REG(HDMI_NV_PDISP_PE_CURRENT);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_CTRL);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_DEBUG0);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_DEBUG1);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_DEBUG2);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_0);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_1);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_2);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_3);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_TRIG);\r\nDUMP_REG(HDMI_NV_PDISP_KEY_SKEY_INDEX);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_AUDIO_CNTRL0);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_AUDIO_HDA_ELD_BUFWR);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_AUDIO_HDA_PRESENSE);\r\nDUMP_REG(HDMI_NV_PDISP_SOR_IO_PEAK_CURRENT);\r\n#undef DUMP_REG\r\nclk_disable_unprepare(hdmi->clk);\r\nreturn 0;\r\n}\r\nstatic int tegra_hdmi_debugfs_init(struct tegra_hdmi *hdmi,\r\nstruct drm_minor *minor)\r\n{\r\nunsigned int i;\r\nint err;\r\nhdmi->debugfs = debugfs_create_dir("hdmi", minor->debugfs_root);\r\nif (!hdmi->debugfs)\r\nreturn -ENOMEM;\r\nhdmi->debugfs_files = kmemdup(debugfs_files, sizeof(debugfs_files),\r\nGFP_KERNEL);\r\nif (!hdmi->debugfs_files) {\r\nerr = -ENOMEM;\r\ngoto remove;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(debugfs_files); i++)\r\nhdmi->debugfs_files[i].data = hdmi;\r\nerr = drm_debugfs_create_files(hdmi->debugfs_files,\r\nARRAY_SIZE(debugfs_files),\r\nhdmi->debugfs, minor);\r\nif (err < 0)\r\ngoto free;\r\nhdmi->minor = minor;\r\nreturn 0;\r\nfree:\r\nkfree(hdmi->debugfs_files);\r\nhdmi->debugfs_files = NULL;\r\nremove:\r\ndebugfs_remove(hdmi->debugfs);\r\nhdmi->debugfs = NULL;\r\nreturn err;\r\n}\r\nstatic void tegra_hdmi_debugfs_exit(struct tegra_hdmi *hdmi)\r\n{\r\ndrm_debugfs_remove_files(hdmi->debugfs_files, ARRAY_SIZE(debugfs_files),\r\nhdmi->minor);\r\nhdmi->minor = NULL;\r\nkfree(hdmi->debugfs_files);\r\nhdmi->debugfs_files = NULL;\r\ndebugfs_remove(hdmi->debugfs);\r\nhdmi->debugfs = NULL;\r\n}\r\nstatic int tegra_hdmi_init(struct host1x_client *client)\r\n{\r\nstruct drm_device *drm = dev_get_drvdata(client->parent);\r\nstruct tegra_hdmi *hdmi = host1x_client_to_hdmi(client);\r\nint err;\r\nhdmi->output.dev = client->dev;\r\ndrm_connector_init(drm, &hdmi->output.connector,\r\n&tegra_hdmi_connector_funcs,\r\nDRM_MODE_CONNECTOR_HDMIA);\r\ndrm_connector_helper_add(&hdmi->output.connector,\r\n&tegra_hdmi_connector_helper_funcs);\r\nhdmi->output.connector.dpms = DRM_MODE_DPMS_OFF;\r\ndrm_encoder_init(drm, &hdmi->output.encoder, &tegra_hdmi_encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS);\r\ndrm_encoder_helper_add(&hdmi->output.encoder,\r\n&tegra_hdmi_encoder_helper_funcs);\r\ndrm_mode_connector_attach_encoder(&hdmi->output.connector,\r\n&hdmi->output.encoder);\r\ndrm_connector_register(&hdmi->output.connector);\r\nerr = tegra_output_init(drm, &hdmi->output);\r\nif (err < 0) {\r\ndev_err(client->dev, "failed to initialize output: %d\n", err);\r\nreturn err;\r\n}\r\nhdmi->output.encoder.possible_crtcs = 0x3;\r\nif (IS_ENABLED(CONFIG_DEBUG_FS)) {\r\nerr = tegra_hdmi_debugfs_init(hdmi, drm->primary);\r\nif (err < 0)\r\ndev_err(client->dev, "debugfs setup failed: %d\n", err);\r\n}\r\nerr = regulator_enable(hdmi->hdmi);\r\nif (err < 0) {\r\ndev_err(client->dev, "failed to enable HDMI regulator: %d\n",\r\nerr);\r\nreturn err;\r\n}\r\nerr = regulator_enable(hdmi->pll);\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to enable PLL regulator: %d\n", err);\r\nreturn err;\r\n}\r\nerr = regulator_enable(hdmi->vdd);\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to enable VDD regulator: %d\n", err);\r\nreturn err;\r\n}\r\nerr = clk_prepare_enable(hdmi->clk);\r\nif (err < 0) {\r\ndev_err(hdmi->dev, "failed to enable clock: %d\n", err);\r\nreturn err;\r\n}\r\nreset_control_deassert(hdmi->rst);\r\nreturn 0;\r\n}\r\nstatic int tegra_hdmi_exit(struct host1x_client *client)\r\n{\r\nstruct tegra_hdmi *hdmi = host1x_client_to_hdmi(client);\r\ntegra_output_exit(&hdmi->output);\r\nreset_control_assert(hdmi->rst);\r\nclk_disable_unprepare(hdmi->clk);\r\nregulator_disable(hdmi->vdd);\r\nregulator_disable(hdmi->pll);\r\nregulator_disable(hdmi->hdmi);\r\nif (IS_ENABLED(CONFIG_DEBUG_FS))\r\ntegra_hdmi_debugfs_exit(hdmi);\r\nreturn 0;\r\n}\r\nstatic int tegra_hdmi_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *match;\r\nstruct tegra_hdmi *hdmi;\r\nstruct resource *regs;\r\nint err;\r\nmatch = of_match_node(tegra_hdmi_of_match, pdev->dev.of_node);\r\nif (!match)\r\nreturn -ENODEV;\r\nhdmi = devm_kzalloc(&pdev->dev, sizeof(*hdmi), GFP_KERNEL);\r\nif (!hdmi)\r\nreturn -ENOMEM;\r\nhdmi->config = match->data;\r\nhdmi->dev = &pdev->dev;\r\nhdmi->audio_source = AUTO;\r\nhdmi->audio_freq = 44100;\r\nhdmi->stereo = false;\r\nhdmi->dvi = false;\r\nhdmi->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(hdmi->clk)) {\r\ndev_err(&pdev->dev, "failed to get clock\n");\r\nreturn PTR_ERR(hdmi->clk);\r\n}\r\nhdmi->rst = devm_reset_control_get(&pdev->dev, "hdmi");\r\nif (IS_ERR(hdmi->rst)) {\r\ndev_err(&pdev->dev, "failed to get reset\n");\r\nreturn PTR_ERR(hdmi->rst);\r\n}\r\nhdmi->clk_parent = devm_clk_get(&pdev->dev, "parent");\r\nif (IS_ERR(hdmi->clk_parent))\r\nreturn PTR_ERR(hdmi->clk_parent);\r\nerr = clk_set_parent(hdmi->clk, hdmi->clk_parent);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "failed to setup clocks: %d\n", err);\r\nreturn err;\r\n}\r\nhdmi->hdmi = devm_regulator_get(&pdev->dev, "hdmi");\r\nif (IS_ERR(hdmi->hdmi)) {\r\ndev_err(&pdev->dev, "failed to get HDMI regulator\n");\r\nreturn PTR_ERR(hdmi->hdmi);\r\n}\r\nhdmi->pll = devm_regulator_get(&pdev->dev, "pll");\r\nif (IS_ERR(hdmi->pll)) {\r\ndev_err(&pdev->dev, "failed to get PLL regulator\n");\r\nreturn PTR_ERR(hdmi->pll);\r\n}\r\nhdmi->vdd = devm_regulator_get(&pdev->dev, "vdd");\r\nif (IS_ERR(hdmi->vdd)) {\r\ndev_err(&pdev->dev, "failed to get VDD regulator\n");\r\nreturn PTR_ERR(hdmi->vdd);\r\n}\r\nhdmi->output.dev = &pdev->dev;\r\nerr = tegra_output_probe(&hdmi->output);\r\nif (err < 0)\r\nreturn err;\r\nregs = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhdmi->regs = devm_ioremap_resource(&pdev->dev, regs);\r\nif (IS_ERR(hdmi->regs))\r\nreturn PTR_ERR(hdmi->regs);\r\nerr = platform_get_irq(pdev, 0);\r\nif (err < 0)\r\nreturn err;\r\nhdmi->irq = err;\r\nINIT_LIST_HEAD(&hdmi->client.list);\r\nhdmi->client.ops = &hdmi_client_ops;\r\nhdmi->client.dev = &pdev->dev;\r\nerr = host1x_client_register(&hdmi->client);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "failed to register host1x client: %d\n",\r\nerr);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(pdev, hdmi);\r\nreturn 0;\r\n}\r\nstatic int tegra_hdmi_remove(struct platform_device *pdev)\r\n{\r\nstruct tegra_hdmi *hdmi = platform_get_drvdata(pdev);\r\nint err;\r\nerr = host1x_client_unregister(&hdmi->client);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "failed to unregister host1x client: %d\n",\r\nerr);\r\nreturn err;\r\n}\r\ntegra_output_remove(&hdmi->output);\r\nclk_disable_unprepare(hdmi->clk_parent);\r\nclk_disable_unprepare(hdmi->clk);\r\nreturn 0;\r\n}

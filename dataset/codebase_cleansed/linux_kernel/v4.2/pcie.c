static int __init dove_pcie_setup(int nr, struct pci_sys_data *sys)\r\n{\r\nstruct pcie_port *pp;\r\nif (nr >= num_pcie_ports)\r\nreturn 0;\r\npp = &pcie_port[nr];\r\nsys->private_data = pp;\r\npp->root_bus_nr = sys->busnr;\r\norion_pcie_set_local_bus_nr(pp->base, sys->busnr);\r\norion_pcie_setup(pp->base);\r\nif (pp->index == 0)\r\npci_ioremap_io(sys->busnr * SZ_64K, DOVE_PCIE0_IO_PHYS_BASE);\r\nelse\r\npci_ioremap_io(sys->busnr * SZ_64K, DOVE_PCIE1_IO_PHYS_BASE);\r\nsnprintf(pp->mem_space_name, sizeof(pp->mem_space_name),\r\n"PCIe %d MEM", pp->index);\r\npp->mem_space_name[sizeof(pp->mem_space_name) - 1] = 0;\r\npp->res.name = pp->mem_space_name;\r\nif (pp->index == 0) {\r\npp->res.start = DOVE_PCIE0_MEM_PHYS_BASE;\r\npp->res.end = pp->res.start + DOVE_PCIE0_MEM_SIZE - 1;\r\n} else {\r\npp->res.start = DOVE_PCIE1_MEM_PHYS_BASE;\r\npp->res.end = pp->res.start + DOVE_PCIE1_MEM_SIZE - 1;\r\n}\r\npp->res.flags = IORESOURCE_MEM;\r\nif (request_resource(&iomem_resource, &pp->res))\r\npanic("Request PCIe Memory resource failed\n");\r\npci_add_resource_offset(&sys->resources, &pp->res, sys->mem_offset);\r\nreturn 1;\r\n}\r\nstatic int pcie_valid_config(struct pcie_port *pp, int bus, int dev)\r\n{\r\nif (bus == pp->root_bus_nr && dev > 1)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int pcie_rd_conf(struct pci_bus *bus, u32 devfn, int where,\r\nint size, u32 *val)\r\n{\r\nstruct pci_sys_data *sys = bus->sysdata;\r\nstruct pcie_port *pp = sys->private_data;\r\nunsigned long flags;\r\nint ret;\r\nif (pcie_valid_config(pp, bus->number, PCI_SLOT(devfn)) == 0) {\r\n*val = 0xffffffff;\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\nspin_lock_irqsave(&pp->conf_lock, flags);\r\nret = orion_pcie_rd_conf(pp->base, bus, devfn, where, size, val);\r\nspin_unlock_irqrestore(&pp->conf_lock, flags);\r\nreturn ret;\r\n}\r\nstatic int pcie_wr_conf(struct pci_bus *bus, u32 devfn,\r\nint where, int size, u32 val)\r\n{\r\nstruct pci_sys_data *sys = bus->sysdata;\r\nstruct pcie_port *pp = sys->private_data;\r\nunsigned long flags;\r\nint ret;\r\nif (pcie_valid_config(pp, bus->number, PCI_SLOT(devfn)) == 0)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nspin_lock_irqsave(&pp->conf_lock, flags);\r\nret = orion_pcie_wr_conf(pp->base, bus, devfn, where, size, val);\r\nspin_unlock_irqrestore(&pp->conf_lock, flags);\r\nreturn ret;\r\n}\r\nstatic void rc_pci_fixup(struct pci_dev *dev)\r\n{\r\nif (dev->bus->parent == NULL && dev->devfn == 0) {\r\nint i;\r\nfor (i = 0; i < DEVICE_COUNT_RESOURCE; i++) {\r\ndev->resource[i].start = 0;\r\ndev->resource[i].end = 0;\r\ndev->resource[i].flags = 0;\r\n}\r\n}\r\n}\r\nstatic struct pci_bus __init *\r\ndove_pcie_scan_bus(int nr, struct pci_sys_data *sys)\r\n{\r\nif (nr >= num_pcie_ports) {\r\nBUG();\r\nreturn NULL;\r\n}\r\nreturn pci_scan_root_bus(NULL, sys->busnr, &pcie_ops, sys,\r\n&sys->resources);\r\n}\r\nstatic int __init dove_pcie_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstruct pci_sys_data *sys = dev->sysdata;\r\nstruct pcie_port *pp = sys->private_data;\r\nreturn pp->index ? IRQ_DOVE_PCIE1 : IRQ_DOVE_PCIE0;\r\n}\r\nstatic void __init add_pcie_port(int index, void __iomem *base)\r\n{\r\nprintk(KERN_INFO "Dove PCIe port %d: ", index);\r\nif (orion_pcie_link_up(base)) {\r\nstruct pcie_port *pp = &pcie_port[num_pcie_ports++];\r\nstruct clk *clk = clk_get_sys("pcie", (index ? "1" : "0"));\r\nif (!IS_ERR(clk))\r\nclk_prepare_enable(clk);\r\nprintk(KERN_INFO "link up\n");\r\npp->index = index;\r\npp->root_bus_nr = -1;\r\npp->base = base;\r\nspin_lock_init(&pp->conf_lock);\r\nmemset(&pp->res, 0, sizeof(pp->res));\r\n} else {\r\nprintk(KERN_INFO "link down, ignoring\n");\r\n}\r\n}\r\nvoid __init dove_pcie_init(int init_port0, int init_port1)\r\n{\r\nvga_base = DOVE_PCIE0_MEM_PHYS_BASE;\r\nif (init_port0)\r\nadd_pcie_port(0, DOVE_PCIE0_VIRT_BASE);\r\nif (init_port1)\r\nadd_pcie_port(1, DOVE_PCIE1_VIRT_BASE);\r\npci_common_init(&dove_pci);\r\n}

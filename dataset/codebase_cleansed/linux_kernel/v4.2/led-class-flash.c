static ssize_t flash_brightness_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nunsigned long state;\r\nssize_t ret;\r\nmutex_lock(&led_cdev->led_access);\r\nif (led_sysfs_is_disabled(led_cdev)) {\r\nret = -EBUSY;\r\ngoto unlock;\r\n}\r\nret = kstrtoul(buf, 10, &state);\r\nif (ret)\r\ngoto unlock;\r\nret = led_set_flash_brightness(fled_cdev, state);\r\nif (ret < 0)\r\ngoto unlock;\r\nret = size;\r\nunlock:\r\nmutex_unlock(&led_cdev->led_access);\r\nreturn ret;\r\n}\r\nstatic ssize_t flash_brightness_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nled_update_flash_brightness(fled_cdev);\r\nreturn sprintf(buf, "%u\n", fled_cdev->brightness.val);\r\n}\r\nstatic ssize_t max_flash_brightness_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nreturn sprintf(buf, "%u\n", fled_cdev->brightness.max);\r\n}\r\nstatic ssize_t flash_strobe_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nunsigned long state;\r\nssize_t ret = -EINVAL;\r\nmutex_lock(&led_cdev->led_access);\r\nif (led_sysfs_is_disabled(led_cdev)) {\r\nret = -EBUSY;\r\ngoto unlock;\r\n}\r\nret = kstrtoul(buf, 10, &state);\r\nif (ret)\r\ngoto unlock;\r\nif (state < 0 || state > 1) {\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\nret = led_set_flash_strobe(fled_cdev, state);\r\nif (ret < 0)\r\ngoto unlock;\r\nret = size;\r\nunlock:\r\nmutex_unlock(&led_cdev->led_access);\r\nreturn ret;\r\n}\r\nstatic ssize_t flash_strobe_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nbool state;\r\nint ret;\r\nret = led_get_flash_strobe(fled_cdev, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", state);\r\n}\r\nstatic ssize_t flash_timeout_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nunsigned long flash_timeout;\r\nssize_t ret;\r\nmutex_lock(&led_cdev->led_access);\r\nif (led_sysfs_is_disabled(led_cdev)) {\r\nret = -EBUSY;\r\ngoto unlock;\r\n}\r\nret = kstrtoul(buf, 10, &flash_timeout);\r\nif (ret)\r\ngoto unlock;\r\nret = led_set_flash_timeout(fled_cdev, flash_timeout);\r\nif (ret < 0)\r\ngoto unlock;\r\nret = size;\r\nunlock:\r\nmutex_unlock(&led_cdev->led_access);\r\nreturn ret;\r\n}\r\nstatic ssize_t flash_timeout_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nreturn sprintf(buf, "%u\n", fled_cdev->timeout.val);\r\n}\r\nstatic ssize_t max_flash_timeout_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nreturn sprintf(buf, "%u\n", fled_cdev->timeout.max);\r\n}\r\nstatic ssize_t flash_fault_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\nu32 fault, mask = 0x1;\r\nchar *pbuf = buf;\r\nint i, ret, buf_len;\r\nret = led_get_flash_fault(fled_cdev, &fault);\r\nif (ret < 0)\r\nreturn -EINVAL;\r\n*buf = '\0';\r\nfor (i = 0; i < LED_NUM_FLASH_FAULTS; ++i) {\r\nif (fault & mask) {\r\nbuf_len = sprintf(pbuf, "%s ",\r\nled_flash_fault_names[i]);\r\npbuf += buf_len;\r\n}\r\nmask <<= 1;\r\n}\r\nreturn sprintf(buf, "%s\n", buf);\r\n}\r\nstatic void led_flash_resume(struct led_classdev *led_cdev)\r\n{\r\nstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\r\ncall_flash_op(fled_cdev, flash_brightness_set,\r\nfled_cdev->brightness.val);\r\ncall_flash_op(fled_cdev, timeout_set, fled_cdev->timeout.val);\r\n}\r\nstatic void led_flash_init_sysfs_groups(struct led_classdev_flash *fled_cdev)\r\n{\r\nstruct led_classdev *led_cdev = &fled_cdev->led_cdev;\r\nconst struct led_flash_ops *ops = fled_cdev->ops;\r\nconst struct attribute_group **flash_groups = fled_cdev->sysfs_groups;\r\nint num_sysfs_groups = 0;\r\nflash_groups[num_sysfs_groups++] = &led_flash_strobe_group;\r\nif (ops->flash_brightness_set)\r\nflash_groups[num_sysfs_groups++] = &led_flash_brightness_group;\r\nif (ops->timeout_set)\r\nflash_groups[num_sysfs_groups++] = &led_flash_timeout_group;\r\nif (ops->fault_get)\r\nflash_groups[num_sysfs_groups++] = &led_flash_fault_group;\r\nled_cdev->groups = flash_groups;\r\n}\r\nint led_classdev_flash_register(struct device *parent,\r\nstruct led_classdev_flash *fled_cdev)\r\n{\r\nstruct led_classdev *led_cdev;\r\nconst struct led_flash_ops *ops;\r\nint ret;\r\nif (!fled_cdev)\r\nreturn -EINVAL;\r\nled_cdev = &fled_cdev->led_cdev;\r\nif (led_cdev->flags & LED_DEV_CAP_FLASH) {\r\nif (!led_cdev->brightness_set_sync)\r\nreturn -EINVAL;\r\nops = fled_cdev->ops;\r\nif (!ops || !ops->strobe_set)\r\nreturn -EINVAL;\r\nled_cdev->flash_resume = led_flash_resume;\r\nled_flash_init_sysfs_groups(fled_cdev);\r\n}\r\nret = led_classdev_register(parent, led_cdev);\r\nif (ret < 0)\r\nreturn ret;\r\nled_cdev->flags &= ~SET_BRIGHTNESS_ASYNC;\r\nled_cdev->flags |= SET_BRIGHTNESS_SYNC;\r\nreturn 0;\r\n}\r\nvoid led_classdev_flash_unregister(struct led_classdev_flash *fled_cdev)\r\n{\r\nif (!fled_cdev)\r\nreturn;\r\nled_classdev_unregister(&fled_cdev->led_cdev);\r\n}\r\nstatic void led_clamp_align(struct led_flash_setting *s)\r\n{\r\nu32 v, offset;\r\nv = s->val + s->step / 2;\r\nv = clamp(v, s->min, s->max);\r\noffset = v - s->min;\r\noffset = s->step * (offset / s->step);\r\ns->val = s->min + offset;\r\n}\r\nint led_set_flash_timeout(struct led_classdev_flash *fled_cdev, u32 timeout)\r\n{\r\nstruct led_classdev *led_cdev = &fled_cdev->led_cdev;\r\nstruct led_flash_setting *s = &fled_cdev->timeout;\r\ns->val = timeout;\r\nled_clamp_align(s);\r\nif (!(led_cdev->flags & LED_SUSPENDED))\r\nreturn call_flash_op(fled_cdev, timeout_set, s->val);\r\nreturn 0;\r\n}\r\nint led_get_flash_fault(struct led_classdev_flash *fled_cdev, u32 *fault)\r\n{\r\nreturn call_flash_op(fled_cdev, fault_get, fault);\r\n}\r\nint led_set_flash_brightness(struct led_classdev_flash *fled_cdev,\r\nu32 brightness)\r\n{\r\nstruct led_classdev *led_cdev = &fled_cdev->led_cdev;\r\nstruct led_flash_setting *s = &fled_cdev->brightness;\r\ns->val = brightness;\r\nled_clamp_align(s);\r\nif (!(led_cdev->flags & LED_SUSPENDED))\r\nreturn call_flash_op(fled_cdev, flash_brightness_set, s->val);\r\nreturn 0;\r\n}\r\nint led_update_flash_brightness(struct led_classdev_flash *fled_cdev)\r\n{\r\nstruct led_flash_setting *s = &fled_cdev->brightness;\r\nu32 brightness;\r\nif (has_flash_op(fled_cdev, flash_brightness_get)) {\r\nint ret = call_flash_op(fled_cdev, flash_brightness_get,\r\n&brightness);\r\nif (ret < 0)\r\nreturn ret;\r\ns->val = brightness;\r\n}\r\nreturn 0;\r\n}

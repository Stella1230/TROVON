static void up_clk(struct _adapter *padapter, u16 *x)\r\n{\r\n*x = *x | _EESK;\r\nr8712_write8(padapter, EE_9346CR, (u8)*x);\r\nudelay(CLOCK_RATE);\r\n}\r\nstatic void down_clk(struct _adapter *padapter, u16 *x)\r\n{\r\n*x = *x & ~_EESK;\r\nr8712_write8(padapter, EE_9346CR, (u8)*x);\r\nudelay(CLOCK_RATE);\r\n}\r\nstatic void shift_out_bits(struct _adapter *padapter, u16 data, u16 count)\r\n{\r\nu16 x, mask;\r\nif (padapter->bSurpriseRemoved == true)\r\ngoto out;\r\nmask = 0x01 << (count - 1);\r\nx = r8712_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDO | _EEDI);\r\ndo {\r\nx &= ~_EEDI;\r\nif (data & mask)\r\nx |= _EEDI;\r\nif (padapter->bSurpriseRemoved == true)\r\ngoto out;\r\nr8712_write8(padapter, EE_9346CR, (u8)x);\r\nudelay(CLOCK_RATE);\r\nup_clk(padapter, &x);\r\ndown_clk(padapter, &x);\r\nmask >>= 1;\r\n} while (mask);\r\nif (padapter->bSurpriseRemoved == true)\r\ngoto out;\r\nx &= ~_EEDI;\r\nr8712_write8(padapter, EE_9346CR, (u8)x);\r\nout:;\r\n}\r\nstatic u16 shift_in_bits(struct _adapter *padapter)\r\n{\r\nu16 x, d = 0, i;\r\nif (padapter->bSurpriseRemoved == true)\r\ngoto out;\r\nx = r8712_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDO | _EEDI);\r\nd = 0;\r\nfor (i = 0; i < 16; i++) {\r\nd <<= 1;\r\nup_clk(padapter, &x);\r\nif (padapter->bSurpriseRemoved == true)\r\ngoto out;\r\nx = r8712_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDI);\r\nif (x & _EEDO)\r\nd |= 1;\r\ndown_clk(padapter, &x);\r\n}\r\nout:\r\nreturn d;\r\n}\r\nstatic void standby(struct _adapter *padapter)\r\n{\r\nu8 x;\r\nx = r8712_read8(padapter, EE_9346CR);\r\nx &= ~(_EECS | _EESK);\r\nr8712_write8(padapter, EE_9346CR, x);\r\nudelay(CLOCK_RATE);\r\nx |= _EECS;\r\nr8712_write8(padapter, EE_9346CR, x);\r\nudelay(CLOCK_RATE);\r\n}\r\nstatic u16 wait_eeprom_cmd_done(struct _adapter *padapter)\r\n{\r\nu8 x;\r\nu16 i;\r\nstandby(padapter);\r\nfor (i = 0; i < 200; i++) {\r\nx = r8712_read8(padapter, EE_9346CR);\r\nif (x & _EEDO)\r\nreturn true;\r\nudelay(CLOCK_RATE);\r\n}\r\nreturn false;\r\n}\r\nstatic void eeprom_clean(struct _adapter *padapter)\r\n{\r\nu16 x;\r\nif (padapter->bSurpriseRemoved == true)\r\nreturn;\r\nx = r8712_read8(padapter, EE_9346CR);\r\nif (padapter->bSurpriseRemoved == true)\r\nreturn;\r\nx &= ~(_EECS | _EEDI);\r\nr8712_write8(padapter, EE_9346CR, (u8)x);\r\nif (padapter->bSurpriseRemoved == true)\r\nreturn;\r\nup_clk(padapter, &x);\r\nif (padapter->bSurpriseRemoved == true)\r\nreturn;\r\ndown_clk(padapter, &x);\r\n}\r\nvoid r8712_eeprom_write16(struct _adapter *padapter, u16 reg, u16 data)\r\n{\r\nu8 x;\r\nu8 tmp8_ori, tmp8_new, tmp8_clk_ori, tmp8_clk_new;\r\ntmp8_ori = r8712_read8(padapter, 0x102502f1);\r\ntmp8_new = tmp8_ori & 0xf7;\r\nif (tmp8_ori != tmp8_new)\r\nr8712_write8(padapter, 0x102502f1, tmp8_new);\r\ntmp8_clk_ori = r8712_read8(padapter, 0x10250003);\r\ntmp8_clk_new = tmp8_clk_ori | 0x20;\r\nif (tmp8_clk_new != tmp8_clk_ori)\r\nr8712_write8(padapter, 0x10250003, tmp8_clk_new);\r\nx = r8712_read8(padapter, EE_9346CR);\r\nx &= ~(_EEDI | _EEDO | _EESK | _EEM0);\r\nx |= _EEM1 | _EECS;\r\nr8712_write8(padapter, EE_9346CR, x);\r\nshift_out_bits(padapter, EEPROM_EWEN_OPCODE, 5);\r\nif (padapter->EepromAddressSize == 8)\r\nshift_out_bits(padapter, 0, 6);\r\nelse\r\nshift_out_bits(padapter, 0, 4);\r\nstandby(padapter);\r\nstandby(padapter);\r\nshift_out_bits(padapter, EEPROM_WRITE_OPCODE, 3);\r\nshift_out_bits(padapter, reg, padapter->EepromAddressSize);\r\nshift_out_bits(padapter, data, 16);\r\nif (wait_eeprom_cmd_done(padapter)) {\r\nstandby(padapter);\r\nshift_out_bits(padapter, EEPROM_EWDS_OPCODE, 5);\r\nshift_out_bits(padapter, reg, 4);\r\neeprom_clean(padapter);\r\n}\r\nif (tmp8_clk_new != tmp8_clk_ori)\r\nr8712_write8(padapter, 0x10250003, tmp8_clk_ori);\r\nif (tmp8_new != tmp8_ori)\r\nr8712_write8(padapter, 0x102502f1, tmp8_ori);\r\n}\r\nu16 r8712_eeprom_read16(struct _adapter *padapter, u16 reg)\r\n{\r\nu16 x;\r\nu16 data = 0;\r\nu8 tmp8_ori, tmp8_new, tmp8_clk_ori, tmp8_clk_new;\r\ntmp8_ori = r8712_read8(padapter, 0x102502f1);\r\ntmp8_new = tmp8_ori & 0xf7;\r\nif (tmp8_ori != tmp8_new)\r\nr8712_write8(padapter, 0x102502f1, tmp8_new);\r\ntmp8_clk_ori = r8712_read8(padapter, 0x10250003);\r\ntmp8_clk_new = tmp8_clk_ori | 0x20;\r\nif (tmp8_clk_new != tmp8_clk_ori)\r\nr8712_write8(padapter, 0x10250003, tmp8_clk_new);\r\nif (padapter->bSurpriseRemoved == true)\r\ngoto out;\r\nx = r8712_read8(padapter, EE_9346CR);\r\nif (padapter->bSurpriseRemoved == true)\r\ngoto out;\r\nx &= ~(_EEDI | _EEDO | _EESK | _EEM0);\r\nx |= _EEM1 | _EECS;\r\nr8712_write8(padapter, EE_9346CR, (unsigned char)x);\r\nshift_out_bits(padapter, EEPROM_READ_OPCODE, 3);\r\nshift_out_bits(padapter, reg, padapter->EepromAddressSize);\r\ndata = shift_in_bits(padapter);\r\neeprom_clean(padapter);\r\nout:\r\nif (tmp8_clk_new != tmp8_clk_ori)\r\nr8712_write8(padapter, 0x10250003, tmp8_clk_ori);\r\nif (tmp8_new != tmp8_ori)\r\nr8712_write8(padapter, 0x102502f1, tmp8_ori);\r\nreturn data;\r\n}

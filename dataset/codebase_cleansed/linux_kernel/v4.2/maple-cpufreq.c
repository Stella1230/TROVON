static int maple_scom_switch_freq(int speed_mode)\r\n{\r\nunsigned long flags;\r\nint to;\r\nlocal_irq_save(flags);\r\nscom970_write(SCOM_PCR, 0);\r\nscom970_write(SCOM_PCR, PCR_HILO_SELECT | 0);\r\nscom970_write(SCOM_PCR, PCR_HILO_SELECT |\r\nmaple_pmode_data[speed_mode]);\r\nfor (to = 0; to < 10; to++) {\r\nunsigned long psr = scom970_read(SCOM_PSR);\r\nif ((psr & PSR_CMD_RECEIVED) == 0 &&\r\n(((psr >> PSR_CUR_SPEED_SHIFT) ^\r\n(maple_pmode_data[speed_mode] >> PCR_SPEED_SHIFT)) & 0x3)\r\n== 0)\r\nbreak;\r\nif (psr & PSR_CMD_COMPLETED)\r\nbreak;\r\nudelay(100);\r\n}\r\nlocal_irq_restore(flags);\r\nmaple_pmode_cur = speed_mode;\r\nppc_proc_freq = maple_cpu_freqs[speed_mode].frequency * 1000ul;\r\nreturn 0;\r\n}\r\nstatic int maple_scom_query_freq(void)\r\n{\r\nunsigned long psr = scom970_read(SCOM_PSR);\r\nint i;\r\nfor (i = 0; i <= maple_pmode_max; i++)\r\nif ((((psr >> PSR_CUR_SPEED_SHIFT) ^\r\n(maple_pmode_data[i] >> PCR_SPEED_SHIFT)) & 0x3) == 0)\r\nbreak;\r\nreturn i;\r\n}\r\nstatic int maple_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int index)\r\n{\r\nreturn maple_scom_switch_freq(index);\r\n}\r\nstatic unsigned int maple_cpufreq_get_speed(unsigned int cpu)\r\n{\r\nreturn maple_cpu_freqs[maple_pmode_cur].frequency;\r\n}\r\nstatic int maple_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_generic_init(policy, maple_cpu_freqs, 12000);\r\n}\r\nstatic int __init maple_cpufreq_init(void)\r\n{\r\nstruct device_node *cpunode;\r\nunsigned int psize;\r\nunsigned long max_freq;\r\nconst u32 *valp;\r\nu32 pvr_hi;\r\nint rc = -ENODEV;\r\nif (!of_machine_is_compatible("Momentum,Maple") &&\r\n!of_machine_is_compatible("Momentum,Apache"))\r\nreturn 0;\r\ncpunode = of_cpu_device_node_get(0);\r\nif (cpunode == NULL) {\r\nprintk(KERN_ERR "cpufreq: Can't find any CPU 0 node\n");\r\ngoto bail_noprops;\r\n}\r\npvr_hi = PVR_VER(mfspr(SPRN_PVR));\r\nif (pvr_hi != 0x3c && pvr_hi != 0x44) {\r\nprintk(KERN_ERR "cpufreq: Unsupported CPU version (%x)\n",\r\npvr_hi);\r\ngoto bail_noprops;\r\n}\r\nmaple_pmode_data = of_get_property(cpunode, "power-mode-data", &psize);\r\nif (!maple_pmode_data) {\r\nDBG("No power-mode-data !\n");\r\ngoto bail_noprops;\r\n}\r\nmaple_pmode_max = psize / sizeof(u32) - 1;\r\nvalp = of_get_property(cpunode, "clock-frequency", NULL);\r\nif (!valp)\r\nreturn -ENODEV;\r\nmax_freq = (*valp)/1000;\r\nmaple_cpu_freqs[0].frequency = max_freq;\r\nmaple_cpu_freqs[1].frequency = max_freq/2;\r\nmsleep(10);\r\nmaple_pmode_cur = -1;\r\nmaple_scom_switch_freq(maple_scom_query_freq());\r\nprintk(KERN_INFO "Registering Maple CPU frequency driver\n");\r\nprintk(KERN_INFO "Low: %d Mhz, High: %d Mhz, Cur: %d MHz\n",\r\nmaple_cpu_freqs[1].frequency/1000,\r\nmaple_cpu_freqs[0].frequency/1000,\r\nmaple_cpu_freqs[maple_pmode_cur].frequency/1000);\r\nrc = cpufreq_register_driver(&maple_cpufreq_driver);\r\nof_node_put(cpunode);\r\nreturn rc;\r\nbail_noprops:\r\nof_node_put(cpunode);\r\nreturn rc;\r\n}

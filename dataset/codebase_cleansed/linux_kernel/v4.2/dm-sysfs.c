static ssize_t dm_attr_show(struct kobject *kobj, struct attribute *attr,\r\nchar *page)\r\n{\r\nstruct dm_sysfs_attr *dm_attr;\r\nstruct mapped_device *md;\r\nssize_t ret;\r\ndm_attr = container_of(attr, struct dm_sysfs_attr, attr);\r\nif (!dm_attr->show)\r\nreturn -EIO;\r\nmd = dm_get_from_kobject(kobj);\r\nif (!md)\r\nreturn -EINVAL;\r\nret = dm_attr->show(md, page);\r\ndm_put(md);\r\nreturn ret;\r\n}\r\nstatic ssize_t dm_attr_store(struct kobject *kobj, struct attribute *attr,\r\nconst char *page, size_t count)\r\n{\r\nstruct dm_sysfs_attr *dm_attr;\r\nstruct mapped_device *md;\r\nssize_t ret;\r\ndm_attr = container_of(attr, struct dm_sysfs_attr, attr);\r\nif (!dm_attr->store)\r\nreturn -EIO;\r\nmd = dm_get_from_kobject(kobj);\r\nif (!md)\r\nreturn -EINVAL;\r\nret = dm_attr->store(md, page, count);\r\ndm_put(md);\r\nreturn ret;\r\n}\r\nstatic ssize_t dm_attr_name_show(struct mapped_device *md, char *buf)\r\n{\r\nif (dm_copy_name_and_uuid(md, buf, NULL))\r\nreturn -EIO;\r\nstrcat(buf, "\n");\r\nreturn strlen(buf);\r\n}\r\nstatic ssize_t dm_attr_uuid_show(struct mapped_device *md, char *buf)\r\n{\r\nif (dm_copy_name_and_uuid(md, NULL, buf))\r\nreturn -EIO;\r\nstrcat(buf, "\n");\r\nreturn strlen(buf);\r\n}\r\nstatic ssize_t dm_attr_suspended_show(struct mapped_device *md, char *buf)\r\n{\r\nsprintf(buf, "%d\n", dm_suspended_md(md));\r\nreturn strlen(buf);\r\n}\r\nstatic ssize_t dm_attr_use_blk_mq_show(struct mapped_device *md, char *buf)\r\n{\r\nsprintf(buf, "%d\n", dm_use_blk_mq(md));\r\nreturn strlen(buf);\r\n}\r\nint dm_sysfs_init(struct mapped_device *md)\r\n{\r\nreturn kobject_init_and_add(dm_kobject(md), &dm_ktype,\r\n&disk_to_dev(dm_disk(md))->kobj,\r\n"%s", "dm");\r\n}\r\nvoid dm_sysfs_exit(struct mapped_device *md)\r\n{\r\nstruct kobject *kobj = dm_kobject(md);\r\nkobject_put(kobj);\r\nwait_for_completion(dm_get_completion_from_kobject(kobj));\r\n}

void\r\nlocks_start_grace(struct net *net, struct lock_manager *lm)\r\n{\r\nstruct list_head *grace_list = net_generic(net, grace_net_id);\r\nspin_lock(&grace_lock);\r\nlist_add(&lm->list, grace_list);\r\nspin_unlock(&grace_lock);\r\n}\r\nvoid\r\nlocks_end_grace(struct lock_manager *lm)\r\n{\r\nspin_lock(&grace_lock);\r\nlist_del_init(&lm->list);\r\nspin_unlock(&grace_lock);\r\n}\r\nint\r\nlocks_in_grace(struct net *net)\r\n{\r\nstruct list_head *grace_list = net_generic(net, grace_net_id);\r\nreturn !list_empty(grace_list);\r\n}\r\nstatic int __net_init\r\ngrace_init_net(struct net *net)\r\n{\r\nstruct list_head *grace_list = net_generic(net, grace_net_id);\r\nINIT_LIST_HEAD(grace_list);\r\nreturn 0;\r\n}\r\nstatic void __net_exit\r\ngrace_exit_net(struct net *net)\r\n{\r\nstruct list_head *grace_list = net_generic(net, grace_net_id);\r\nBUG_ON(!list_empty(grace_list));\r\n}\r\nstatic int __init\r\ninit_grace(void)\r\n{\r\nreturn register_pernet_subsys(&grace_net_ops);\r\n}\r\nstatic void __exit\r\nexit_grace(void)\r\n{\r\nunregister_pernet_subsys(&grace_net_ops);\r\n}

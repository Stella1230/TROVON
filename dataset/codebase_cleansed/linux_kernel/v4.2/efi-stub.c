efi_status_t __init handle_kernel_image(efi_system_table_t *sys_table,\r\nunsigned long *image_addr,\r\nunsigned long *image_size,\r\nunsigned long *reserve_addr,\r\nunsigned long *reserve_size,\r\nunsigned long dram_base,\r\nefi_loaded_image_t *image)\r\n{\r\nefi_status_t status;\r\nunsigned long kernel_size, kernel_memsize = 0;\r\nkernel_size = _edata - _text;\r\nif (*image_addr != (dram_base + TEXT_OFFSET)) {\r\nkernel_memsize = kernel_size + (_end - _edata);\r\nstatus = efi_low_alloc(sys_table, kernel_memsize + TEXT_OFFSET,\r\nSZ_2M, reserve_addr);\r\nif (status != EFI_SUCCESS) {\r\npr_efi_err(sys_table, "Failed to relocate kernel\n");\r\nreturn status;\r\n}\r\nmemcpy((void *)*reserve_addr + TEXT_OFFSET, (void *)*image_addr,\r\nkernel_size);\r\n*image_addr = *reserve_addr + TEXT_OFFSET;\r\n*reserve_size = kernel_memsize + TEXT_OFFSET;\r\n}\r\nreturn EFI_SUCCESS;\r\n}

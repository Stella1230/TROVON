void __init wbflush_setup(void)\r\n{\r\nswitch (mips_machtype) {\r\ncase MACH_DS23100:\r\ncase MACH_DS5000_200:\r\n__wbflush = wbflush_kn01;\r\nbreak;\r\ncase MACH_DS5100:\r\n__wbflush = wbflush_kn210;\r\nbreak;\r\ncase MACH_DS5000_1XX:\r\ncase MACH_DS5000_XX:\r\ncase MACH_DS5000_2X0:\r\ncase MACH_DS5900:\r\ndefault:\r\n__wbflush = wbflush_mips;\r\nbreak;\r\n}\r\n}\r\nstatic void wbflush_kn01(void)\r\n{\r\nasm(".set\tpush\n\t"\r\n".set\tnoreorder\n\t"\r\n"1:\tbc0f\t1b\n\t"\r\n"nop\n\t"\r\n".set\tpop");\r\n}\r\nstatic void wbflush_kn210(void)\r\n{\r\nasm(".set\tpush\n\t"\r\n".set\tnoreorder\n\t"\r\n"mfc0\t$2,$12\n\t"\r\n"lui\t$3,0x8000\n\t"\r\n"or\t$3,$2,$3\n\t"\r\n"mtc0\t$3,$12\n\t"\r\n"nop\n"\r\n"1:\tbc3f\t1b\n\t"\r\n"nop\n\t"\r\n"mtc0\t$2,$12\n\t"\r\n"nop\n\t"\r\n".set\tpop"\r\n: : : "$2", "$3");\r\n}\r\nstatic void wbflush_mips(void)\r\n{\r\n__fast_iob();\r\n}

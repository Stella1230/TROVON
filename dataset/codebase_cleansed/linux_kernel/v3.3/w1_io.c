static void w1_delay(unsigned long tm)\r\n{\r\nudelay(tm * w1_delay_parm);\r\n}\r\nstatic u8 w1_touch_bit(struct w1_master *dev, int bit)\r\n{\r\nif (dev->bus_master->touch_bit)\r\nreturn dev->bus_master->touch_bit(dev->bus_master->data, bit);\r\nelse if (bit)\r\nreturn w1_read_bit(dev);\r\nelse {\r\nw1_write_bit(dev, 0);\r\nreturn 0;\r\n}\r\n}\r\nstatic void w1_write_bit(struct w1_master *dev, int bit)\r\n{\r\nif (bit) {\r\ndev->bus_master->write_bit(dev->bus_master->data, 0);\r\nw1_delay(6);\r\ndev->bus_master->write_bit(dev->bus_master->data, 1);\r\nw1_delay(64);\r\n} else {\r\ndev->bus_master->write_bit(dev->bus_master->data, 0);\r\nw1_delay(60);\r\ndev->bus_master->write_bit(dev->bus_master->data, 1);\r\nw1_delay(10);\r\n}\r\n}\r\nstatic void w1_pre_write(struct w1_master *dev)\r\n{\r\nif (dev->pullup_duration &&\r\ndev->enable_pullup && dev->bus_master->set_pullup) {\r\ndev->bus_master->set_pullup(dev->bus_master->data,\r\ndev->pullup_duration);\r\n}\r\n}\r\nstatic void w1_post_write(struct w1_master *dev)\r\n{\r\nif (dev->pullup_duration) {\r\nif (dev->enable_pullup && dev->bus_master->set_pullup)\r\ndev->bus_master->set_pullup(dev->bus_master->data, 0);\r\nelse\r\nmsleep(dev->pullup_duration);\r\ndev->pullup_duration = 0;\r\n}\r\n}\r\nvoid w1_write_8(struct w1_master *dev, u8 byte)\r\n{\r\nint i;\r\nif (dev->bus_master->write_byte) {\r\nw1_pre_write(dev);\r\ndev->bus_master->write_byte(dev->bus_master->data, byte);\r\n}\r\nelse\r\nfor (i = 0; i < 8; ++i) {\r\nif (i == 7)\r\nw1_pre_write(dev);\r\nw1_touch_bit(dev, (byte >> i) & 0x1);\r\n}\r\nw1_post_write(dev);\r\n}\r\nstatic u8 w1_read_bit(struct w1_master *dev)\r\n{\r\nint result;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\ndev->bus_master->write_bit(dev->bus_master->data, 0);\r\nw1_delay(6);\r\ndev->bus_master->write_bit(dev->bus_master->data, 1);\r\nw1_delay(9);\r\nresult = dev->bus_master->read_bit(dev->bus_master->data);\r\nlocal_irq_restore(flags);\r\nw1_delay(55);\r\nreturn result & 0x1;\r\n}\r\nu8 w1_triplet(struct w1_master *dev, int bdir)\r\n{\r\nif (dev->bus_master->triplet)\r\nreturn dev->bus_master->triplet(dev->bus_master->data, bdir);\r\nelse {\r\nu8 id_bit = w1_touch_bit(dev, 1);\r\nu8 comp_bit = w1_touch_bit(dev, 1);\r\nu8 retval;\r\nif (id_bit && comp_bit)\r\nreturn 0x03;\r\nif (!id_bit && !comp_bit) {\r\nretval = bdir ? 0x04 : 0;\r\n} else {\r\nbdir = id_bit;\r\nretval = id_bit ? 0x05 : 0x02;\r\n}\r\nif (dev->bus_master->touch_bit)\r\nw1_touch_bit(dev, bdir);\r\nelse\r\nw1_write_bit(dev, bdir);\r\nreturn retval;\r\n}\r\n}\r\nu8 w1_read_8(struct w1_master *dev)\r\n{\r\nint i;\r\nu8 res = 0;\r\nif (dev->bus_master->read_byte)\r\nres = dev->bus_master->read_byte(dev->bus_master->data);\r\nelse\r\nfor (i = 0; i < 8; ++i)\r\nres |= (w1_touch_bit(dev,1) << i);\r\nreturn res;\r\n}\r\nvoid w1_write_block(struct w1_master *dev, const u8 *buf, int len)\r\n{\r\nint i;\r\nif (dev->bus_master->write_block) {\r\nw1_pre_write(dev);\r\ndev->bus_master->write_block(dev->bus_master->data, buf, len);\r\n}\r\nelse\r\nfor (i = 0; i < len; ++i)\r\nw1_write_8(dev, buf[i]);\r\nw1_post_write(dev);\r\n}\r\nvoid w1_touch_block(struct w1_master *dev, u8 *buf, int len)\r\n{\r\nint i, j;\r\nu8 tmp;\r\nfor (i = 0; i < len; ++i) {\r\ntmp = 0;\r\nfor (j = 0; j < 8; ++j) {\r\nif (j == 7)\r\nw1_pre_write(dev);\r\ntmp |= w1_touch_bit(dev, (buf[i] >> j) & 0x1) << j;\r\n}\r\nbuf[i] = tmp;\r\n}\r\n}\r\nu8 w1_read_block(struct w1_master *dev, u8 *buf, int len)\r\n{\r\nint i;\r\nu8 ret;\r\nif (dev->bus_master->read_block)\r\nret = dev->bus_master->read_block(dev->bus_master->data, buf, len);\r\nelse {\r\nfor (i = 0; i < len; ++i)\r\nbuf[i] = w1_read_8(dev);\r\nret = len;\r\n}\r\nreturn ret;\r\n}\r\nint w1_reset_bus(struct w1_master *dev)\r\n{\r\nint result;\r\nif (dev->bus_master->reset_bus)\r\nresult = dev->bus_master->reset_bus(dev->bus_master->data) & 0x1;\r\nelse {\r\ndev->bus_master->write_bit(dev->bus_master->data, 0);\r\nw1_delay(480);\r\ndev->bus_master->write_bit(dev->bus_master->data, 1);\r\nw1_delay(70);\r\nresult = dev->bus_master->read_bit(dev->bus_master->data) & 0x1;\r\nmsleep(1);\r\n}\r\nreturn result;\r\n}\r\nu8 w1_calc_crc8(u8 * data, int len)\r\n{\r\nu8 crc = 0;\r\nwhile (len--)\r\ncrc = w1_crc8_table[crc ^ *data++];\r\nreturn crc;\r\n}\r\nvoid w1_search_devices(struct w1_master *dev, u8 search_type, w1_slave_found_callback cb)\r\n{\r\ndev->attempts++;\r\nif (dev->bus_master->search)\r\ndev->bus_master->search(dev->bus_master->data, dev,\r\nsearch_type, cb);\r\nelse\r\nw1_search(dev, search_type, cb);\r\n}\r\nint w1_reset_select_slave(struct w1_slave *sl)\r\n{\r\nif (w1_reset_bus(sl->master))\r\nreturn -1;\r\nif (sl->master->slave_count == 1)\r\nw1_write_8(sl->master, W1_SKIP_ROM);\r\nelse {\r\nu8 match[9] = {W1_MATCH_ROM, };\r\nu64 rn = le64_to_cpu(*((u64*)&sl->reg_num));\r\nmemcpy(&match[1], &rn, 8);\r\nw1_write_block(sl->master, match, 9);\r\n}\r\nreturn 0;\r\n}\r\nint w1_reset_resume_command(struct w1_master *dev)\r\n{\r\nif (w1_reset_bus(dev))\r\nreturn -1;\r\nw1_write_8(dev, W1_RESUME_CMD);\r\nreturn 0;\r\n}\r\nvoid w1_next_pullup(struct w1_master *dev, int delay)\r\n{\r\ndev->pullup_duration = delay;\r\n}

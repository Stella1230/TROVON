static int ram_erase(struct mtd_info *mtd, struct erase_info *instr)\r\n{\r\nif (instr->addr + instr->len > mtd->size)\r\nreturn -EINVAL;\r\nmemset((char *)mtd->priv + instr->addr, 0xff, instr->len);\r\ninstr->state = MTD_ERASE_DONE;\r\nmtd_erase_callback(instr);\r\nreturn 0;\r\n}\r\nstatic int ram_point(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, void **virt, resource_size_t *phys)\r\n{\r\nif (from + len > mtd->size)\r\nreturn -EINVAL;\r\nif (phys)\r\nreturn -EINVAL;\r\n*virt = mtd->priv + from;\r\n*retlen = len;\r\nreturn 0;\r\n}\r\nstatic void ram_unpoint(struct mtd_info *mtd, loff_t from, size_t len)\r\n{\r\n}\r\nstatic unsigned long ram_get_unmapped_area(struct mtd_info *mtd,\r\nunsigned long len,\r\nunsigned long offset,\r\nunsigned long flags)\r\n{\r\nreturn (unsigned long) mtd->priv + offset;\r\n}\r\nstatic int ram_read(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, u_char *buf)\r\n{\r\nif (from + len > mtd->size)\r\nreturn -EINVAL;\r\nmemcpy(buf, mtd->priv + from, len);\r\n*retlen = len;\r\nreturn 0;\r\n}\r\nstatic int ram_write(struct mtd_info *mtd, loff_t to, size_t len,\r\nsize_t *retlen, const u_char *buf)\r\n{\r\nif (to + len > mtd->size)\r\nreturn -EINVAL;\r\nmemcpy((char *)mtd->priv + to, buf, len);\r\n*retlen = len;\r\nreturn 0;\r\n}\r\nstatic void __exit cleanup_mtdram(void)\r\n{\r\nif (mtd_info) {\r\nmtd_device_unregister(mtd_info);\r\nvfree(mtd_info->priv);\r\nkfree(mtd_info);\r\n}\r\n}\r\nint mtdram_init_device(struct mtd_info *mtd, void *mapped_address,\r\nunsigned long size, char *name)\r\n{\r\nmemset(mtd, 0, sizeof(*mtd));\r\nmtd->name = name;\r\nmtd->type = MTD_RAM;\r\nmtd->flags = MTD_CAP_RAM;\r\nmtd->size = size;\r\nmtd->writesize = 1;\r\nmtd->writebufsize = 64;\r\nmtd->erasesize = MTDRAM_ERASE_SIZE;\r\nmtd->priv = mapped_address;\r\nmtd->owner = THIS_MODULE;\r\nmtd->erase = ram_erase;\r\nmtd->point = ram_point;\r\nmtd->unpoint = ram_unpoint;\r\nmtd->get_unmapped_area = ram_get_unmapped_area;\r\nmtd->read = ram_read;\r\nmtd->write = ram_write;\r\nif (mtd_device_register(mtd, NULL, 0))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int __init init_mtdram(void)\r\n{\r\nvoid *addr;\r\nint err;\r\nif (!total_size)\r\nreturn -EINVAL;\r\nmtd_info = kmalloc(sizeof(struct mtd_info), GFP_KERNEL);\r\nif (!mtd_info)\r\nreturn -ENOMEM;\r\naddr = vmalloc(MTDRAM_TOTAL_SIZE);\r\nif (!addr) {\r\nkfree(mtd_info);\r\nmtd_info = NULL;\r\nreturn -ENOMEM;\r\n}\r\nerr = mtdram_init_device(mtd_info, addr, MTDRAM_TOTAL_SIZE, "mtdram test device");\r\nif (err) {\r\nvfree(addr);\r\nkfree(mtd_info);\r\nmtd_info = NULL;\r\nreturn err;\r\n}\r\nmemset(mtd_info->priv, 0xff, MTDRAM_TOTAL_SIZE);\r\nreturn err;\r\n}

static void media5200_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&media5200_irq.lock, flags);\r\nval = in_be32(media5200_irq.regs + MEDIA5200_IRQ_ENABLE);\r\nval |= 1 << (MEDIA5200_IRQ_SHIFT + irqd_to_hwirq(d));\r\nout_be32(media5200_irq.regs + MEDIA5200_IRQ_ENABLE, val);\r\nspin_unlock_irqrestore(&media5200_irq.lock, flags);\r\n}\r\nstatic void media5200_irq_mask(struct irq_data *d)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&media5200_irq.lock, flags);\r\nval = in_be32(media5200_irq.regs + MEDIA5200_IRQ_ENABLE);\r\nval &= ~(1 << (MEDIA5200_IRQ_SHIFT + irqd_to_hwirq(d)));\r\nout_be32(media5200_irq.regs + MEDIA5200_IRQ_ENABLE, val);\r\nspin_unlock_irqrestore(&media5200_irq.lock, flags);\r\n}\r\nvoid media5200_irq_cascade(unsigned int virq, struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nint sub_virq, val;\r\nu32 status, enable;\r\nraw_spin_lock(&desc->lock);\r\nchip->irq_mask(&desc->irq_data);\r\nraw_spin_unlock(&desc->lock);\r\nstatus = in_be32(media5200_irq.regs + MEDIA5200_IRQ_ENABLE);\r\nenable = in_be32(media5200_irq.regs + MEDIA5200_IRQ_STATUS);\r\nval = ffs((status & enable) >> MEDIA5200_IRQ_SHIFT);\r\nif (val) {\r\nsub_virq = irq_linear_revmap(media5200_irq.irqhost, val - 1);\r\ngeneric_handle_irq(sub_virq);\r\n}\r\nraw_spin_lock(&desc->lock);\r\nchip->irq_ack(&desc->irq_data);\r\nif (!irqd_irq_disabled(&desc->irq_data))\r\nchip->irq_unmask(&desc->irq_data);\r\nraw_spin_unlock(&desc->lock);\r\n}\r\nstatic int media5200_irq_map(struct irq_host *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\npr_debug("%s: h=%p, virq=%i, hwirq=%i\n", __func__, h, virq, (int)hw);\r\nirq_set_chip_data(virq, &media5200_irq);\r\nirq_set_chip_and_handler(virq, &media5200_irq_chip, handle_level_irq);\r\nirq_set_status_flags(virq, IRQ_LEVEL);\r\nreturn 0;\r\n}\r\nstatic int media5200_irq_xlate(struct irq_host *h, struct device_node *ct,\r\nconst u32 *intspec, unsigned int intsize,\r\nirq_hw_number_t *out_hwirq,\r\nunsigned int *out_flags)\r\n{\r\nif (intsize != 2)\r\nreturn -1;\r\npr_debug("%s: bank=%i, number=%i\n", __func__, intspec[0], intspec[1]);\r\n*out_hwirq = intspec[1];\r\n*out_flags = IRQ_TYPE_NONE;\r\nreturn 0;\r\n}\r\nstatic void __init media5200_init_irq(void)\r\n{\r\nstruct device_node *fpga_np;\r\nint cascade_virq;\r\nmpc52xx_init_irq();\r\nfpga_np = of_find_compatible_node(NULL, NULL, "fsl,media5200-fpga");\r\nif (!fpga_np)\r\ngoto out;\r\npr_debug("%s: found fpga node: %s\n", __func__, fpga_np->full_name);\r\nmedia5200_irq.regs = of_iomap(fpga_np, 0);\r\nif (!media5200_irq.regs)\r\ngoto out;\r\npr_debug("%s: mapped to %p\n", __func__, media5200_irq.regs);\r\ncascade_virq = irq_of_parse_and_map(fpga_np, 0);\r\nif (!cascade_virq)\r\ngoto out;\r\npr_debug("%s: cascaded on virq=%i\n", __func__, cascade_virq);\r\nout_be32(media5200_irq.regs + MEDIA5200_IRQ_ENABLE, 0);\r\nspin_lock_init(&media5200_irq.lock);\r\nmedia5200_irq.irqhost = irq_alloc_host(fpga_np, IRQ_HOST_MAP_LINEAR,\r\nMEDIA5200_NUM_IRQS,\r\n&media5200_irq_ops, -1);\r\nif (!media5200_irq.irqhost)\r\ngoto out;\r\npr_debug("%s: allocated irqhost\n", __func__);\r\nmedia5200_irq.irqhost->host_data = &media5200_irq;\r\nirq_set_handler_data(cascade_virq, &media5200_irq);\r\nirq_set_chained_handler(cascade_virq, media5200_irq_cascade);\r\nreturn;\r\nout:\r\npr_err("Could not find Media5200 FPGA; PCI interrupts will not work\n");\r\n}\r\nstatic void __init media5200_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\nstruct mpc52xx_gpio __iomem *gpio;\r\nu32 port_config;\r\nif (ppc_md.progress)\r\nppc_md.progress("media5200_setup_arch()", 0);\r\nmpc52xx_map_common_devices();\r\nmpc5200_setup_xlb_arbiter();\r\nmpc52xx_setup_pci();\r\nnp = of_find_matching_node(NULL, mpc5200_gpio_ids);\r\ngpio = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!gpio) {\r\nprintk(KERN_ERR "%s() failed. expect abnormal behavior\n",\r\n__func__);\r\nreturn;\r\n}\r\nport_config = in_be32(&gpio->port_config);\r\nport_config &= ~0x03000000;\r\nport_config |= 0x01000000;\r\nout_be32(&gpio->port_config, port_config);\r\niounmap(gpio);\r\n}\r\nstatic int __init media5200_probe(void)\r\n{\r\nreturn of_flat_dt_match(of_get_flat_dt_root(), board);\r\n}

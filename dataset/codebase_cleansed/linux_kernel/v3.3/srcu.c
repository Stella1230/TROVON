static int init_srcu_struct_fields(struct srcu_struct *sp)\r\n{\r\nsp->completed = 0;\r\nmutex_init(&sp->mutex);\r\nsp->per_cpu_ref = alloc_percpu(struct srcu_struct_array);\r\nreturn sp->per_cpu_ref ? 0 : -ENOMEM;\r\n}\r\nint __init_srcu_struct(struct srcu_struct *sp, const char *name,\r\nstruct lock_class_key *key)\r\n{\r\ndebug_check_no_locks_freed((void *)sp, sizeof(*sp));\r\nlockdep_init_map(&sp->dep_map, name, key, 0);\r\nreturn init_srcu_struct_fields(sp);\r\n}\r\nint init_srcu_struct(struct srcu_struct *sp)\r\n{\r\nreturn init_srcu_struct_fields(sp);\r\n}\r\nstatic int srcu_readers_active_idx(struct srcu_struct *sp, int idx)\r\n{\r\nint cpu;\r\nint sum;\r\nsum = 0;\r\nfor_each_possible_cpu(cpu)\r\nsum += per_cpu_ptr(sp->per_cpu_ref, cpu)->c[idx];\r\nreturn sum;\r\n}\r\nstatic int srcu_readers_active(struct srcu_struct *sp)\r\n{\r\nreturn srcu_readers_active_idx(sp, 0) + srcu_readers_active_idx(sp, 1);\r\n}\r\nvoid cleanup_srcu_struct(struct srcu_struct *sp)\r\n{\r\nint sum;\r\nsum = srcu_readers_active(sp);\r\nWARN_ON(sum);\r\nif (sum != 0)\r\nreturn;\r\nfree_percpu(sp->per_cpu_ref);\r\nsp->per_cpu_ref = NULL;\r\n}\r\nint __srcu_read_lock(struct srcu_struct *sp)\r\n{\r\nint idx;\r\npreempt_disable();\r\nidx = sp->completed & 0x1;\r\nbarrier();\r\nper_cpu_ptr(sp->per_cpu_ref, smp_processor_id())->c[idx]++;\r\nsrcu_barrier();\r\npreempt_enable();\r\nreturn idx;\r\n}\r\nvoid __srcu_read_unlock(struct srcu_struct *sp, int idx)\r\n{\r\npreempt_disable();\r\nsrcu_barrier();\r\nper_cpu_ptr(sp->per_cpu_ref, smp_processor_id())->c[idx]--;\r\npreempt_enable();\r\n}\r\nstatic void __synchronize_srcu(struct srcu_struct *sp, void (*sync_func)(void))\r\n{\r\nint idx;\r\nidx = sp->completed;\r\nmutex_lock(&sp->mutex);\r\nif ((sp->completed - idx) >= 2) {\r\nmutex_unlock(&sp->mutex);\r\nreturn;\r\n}\r\nsync_func();\r\nidx = sp->completed & 0x1;\r\nsp->completed++;\r\nsync_func();\r\nif (srcu_readers_active_idx(sp, idx))\r\nudelay(SYNCHRONIZE_SRCU_READER_DELAY);\r\nwhile (srcu_readers_active_idx(sp, idx))\r\nschedule_timeout_interruptible(1);\r\nsync_func();\r\nmutex_unlock(&sp->mutex);\r\n}\r\nvoid synchronize_srcu(struct srcu_struct *sp)\r\n{\r\n__synchronize_srcu(sp, synchronize_sched);\r\n}\r\nvoid synchronize_srcu_expedited(struct srcu_struct *sp)\r\n{\r\n__synchronize_srcu(sp, synchronize_sched_expedited);\r\n}\r\nlong srcu_batches_completed(struct srcu_struct *sp)\r\n{\r\nreturn sp->completed;\r\n}

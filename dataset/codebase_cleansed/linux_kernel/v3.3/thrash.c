static struct mem_cgroup *swap_token_memcg_from_mm(struct mm_struct *mm)\r\n{\r\nstruct mem_cgroup *memcg;\r\nmemcg = try_get_mem_cgroup_from_mm(mm);\r\nif (memcg)\r\ncss_put(mem_cgroup_css(memcg));\r\nreturn memcg;\r\n}\r\nstatic struct mem_cgroup *swap_token_memcg_from_mm(struct mm_struct *mm)\r\n{\r\nreturn NULL;\r\n}\r\nvoid grab_swap_token(struct mm_struct *mm)\r\n{\r\nint current_interval;\r\nunsigned int old_prio = mm->token_priority;\r\nstatic unsigned int global_faults;\r\nstatic unsigned int last_aging;\r\nglobal_faults++;\r\ncurrent_interval = global_faults - mm->faultstamp;\r\nif (!spin_trylock(&swap_token_lock))\r\nreturn;\r\nif (!swap_token_mm)\r\ngoto replace_token;\r\nif ((global_faults - last_aging) > TOKEN_AGING_INTERVAL) {\r\nswap_token_mm->token_priority /= 2;\r\nlast_aging = global_faults;\r\n}\r\nif (mm == swap_token_mm) {\r\nmm->token_priority += 2;\r\ngoto update_priority;\r\n}\r\nif (current_interval < mm->last_interval)\r\nmm->token_priority++;\r\nelse {\r\nif (likely(mm->token_priority > 0))\r\nmm->token_priority--;\r\n}\r\nif (mm->token_priority > swap_token_mm->token_priority)\r\ngoto replace_token;\r\nupdate_priority:\r\ntrace_update_swap_token_priority(mm, old_prio, swap_token_mm);\r\nout:\r\nmm->faultstamp = global_faults;\r\nmm->last_interval = current_interval;\r\nspin_unlock(&swap_token_lock);\r\nreturn;\r\nreplace_token:\r\nmm->token_priority += 2;\r\ntrace_replace_swap_token(swap_token_mm, mm);\r\nswap_token_mm = mm;\r\nswap_token_memcg = swap_token_memcg_from_mm(mm);\r\nlast_aging = global_faults;\r\ngoto out;\r\n}\r\nvoid __put_swap_token(struct mm_struct *mm)\r\n{\r\nspin_lock(&swap_token_lock);\r\nif (likely(mm == swap_token_mm)) {\r\ntrace_put_swap_token(swap_token_mm);\r\nswap_token_mm = NULL;\r\nswap_token_memcg = NULL;\r\n}\r\nspin_unlock(&swap_token_lock);\r\n}\r\nstatic bool match_memcg(struct mem_cgroup *a, struct mem_cgroup *b)\r\n{\r\nif (!a)\r\nreturn true;\r\nif (!b)\r\nreturn true;\r\nif (a == b)\r\nreturn true;\r\nreturn false;\r\n}\r\nvoid disable_swap_token(struct mem_cgroup *memcg)\r\n{\r\nif (match_memcg(memcg, swap_token_memcg)) {\r\nspin_lock(&swap_token_lock);\r\nif (match_memcg(memcg, swap_token_memcg)) {\r\ntrace_disable_swap_token(swap_token_mm);\r\nswap_token_mm = NULL;\r\nswap_token_memcg = NULL;\r\n}\r\nspin_unlock(&swap_token_lock);\r\n}\r\n}

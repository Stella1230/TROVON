static int __devinit spi_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct dw_spi_pci *dwpci;\r\nstruct dw_spi *dws;\r\nint pci_bar = 0;\r\nint ret;\r\nprintk(KERN_INFO "DW: found PCI SPI controller(ID: %04x:%04x)\n",\r\npdev->vendor, pdev->device);\r\nret = pci_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\ndwpci = kzalloc(sizeof(struct dw_spi_pci), GFP_KERNEL);\r\nif (!dwpci) {\r\nret = -ENOMEM;\r\ngoto err_disable;\r\n}\r\ndwpci->pdev = pdev;\r\ndws = &dwpci->dws;\r\ndws->paddr = pci_resource_start(pdev, pci_bar);\r\ndws->iolen = pci_resource_len(pdev, pci_bar);\r\nret = pci_request_region(pdev, pci_bar, dev_name(&pdev->dev));\r\nif (ret)\r\ngoto err_kfree;\r\ndws->regs = ioremap_nocache((unsigned long)dws->paddr,\r\npci_resource_len(pdev, pci_bar));\r\nif (!dws->regs) {\r\nret = -ENOMEM;\r\ngoto err_release_reg;\r\n}\r\ndws->parent_dev = &pdev->dev;\r\ndws->bus_num = 0;\r\ndws->num_cs = 4;\r\ndws->irq = pdev->irq;\r\nif (pdev->device == 0x0800) {\r\nret = dw_spi_mid_init(dws);\r\nif (ret)\r\ngoto err_unmap;\r\n}\r\nret = dw_spi_add_host(dws);\r\nif (ret)\r\ngoto err_unmap;\r\npci_set_drvdata(pdev, dwpci);\r\nreturn 0;\r\nerr_unmap:\r\niounmap(dws->regs);\r\nerr_release_reg:\r\npci_release_region(pdev, pci_bar);\r\nerr_kfree:\r\nkfree(dwpci);\r\nerr_disable:\r\npci_disable_device(pdev);\r\nreturn ret;\r\n}\r\nstatic void __devexit spi_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\npci_set_drvdata(pdev, NULL);\r\ndw_spi_remove_host(&dwpci->dws);\r\niounmap(dwpci->dws.regs);\r\npci_release_region(pdev, 0);\r\nkfree(dwpci);\r\npci_disable_device(pdev);\r\n}\r\nstatic int spi_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\nint ret;\r\nret = dw_spi_suspend_host(&dwpci->dws);\r\nif (ret)\r\nreturn ret;\r\npci_save_state(pdev);\r\npci_disable_device(pdev);\r\npci_set_power_state(pdev, pci_choose_state(pdev, state));\r\nreturn ret;\r\n}\r\nstatic int spi_resume(struct pci_dev *pdev)\r\n{\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\nint ret;\r\npci_set_power_state(pdev, PCI_D0);\r\npci_restore_state(pdev);\r\nret = pci_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\nreturn dw_spi_resume_host(&dwpci->dws);\r\n}\r\nstatic int __init mrst_spi_init(void)\r\n{\r\nreturn pci_register_driver(&dw_spi_driver);\r\n}\r\nstatic void __exit mrst_spi_exit(void)\r\n{\r\npci_unregister_driver(&dw_spi_driver);\r\n}

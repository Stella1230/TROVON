static void txx9wdt_ping(void)\r\n{\r\nspin_lock(&txx9_lock);\r\n__raw_writel(TXx9_TMWTMR_TWIE | TXx9_TMWTMR_TWC, &txx9wdt_reg->wtmr);\r\nspin_unlock(&txx9_lock);\r\n}\r\nstatic void txx9wdt_start(void)\r\n{\r\nspin_lock(&txx9_lock);\r\n__raw_writel(WD_TIMER_CLK * timeout, &txx9wdt_reg->cpra);\r\n__raw_writel(WD_TIMER_CCD, &txx9wdt_reg->ccdr);\r\n__raw_writel(0, &txx9wdt_reg->tisr);\r\n__raw_writel(TXx9_TMTCR_TCE | TXx9_TMTCR_CCDE | TXx9_TMTCR_TMODE_WDOG,\r\n&txx9wdt_reg->tcr);\r\n__raw_writel(TXx9_TMWTMR_TWIE | TXx9_TMWTMR_TWC, &txx9wdt_reg->wtmr);\r\nspin_unlock(&txx9_lock);\r\n}\r\nstatic void txx9wdt_stop(void)\r\n{\r\nspin_lock(&txx9_lock);\r\n__raw_writel(TXx9_TMWTMR_WDIS, &txx9wdt_reg->wtmr);\r\n__raw_writel(__raw_readl(&txx9wdt_reg->tcr) & ~TXx9_TMTCR_TCE,\r\n&txx9wdt_reg->tcr);\r\nspin_unlock(&txx9_lock);\r\n}\r\nstatic int txx9wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &txx9wdt_alive))\r\nreturn -EBUSY;\r\nif (__raw_readl(&txx9wdt_reg->tcr) & TXx9_TMTCR_TCE) {\r\nclear_bit(0, &txx9wdt_alive);\r\nreturn -EBUSY;\r\n}\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\ntxx9wdt_start();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int txx9wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close)\r\ntxx9wdt_stop();\r\nelse {\r\nprintk(KERN_CRIT "txx9wdt: "\r\n"Unexpected close, not stopping watchdog!\n");\r\ntxx9wdt_ping();\r\n}\r\nclear_bit(0, &txx9wdt_alive);\r\nexpect_close = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t txx9wdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 1;\r\n}\r\n}\r\ntxx9wdt_ping();\r\n}\r\nreturn len;\r\n}\r\nstatic long txx9wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nint new_timeout;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_SETTIMEOUT |\r\nWDIOF_KEEPALIVEPING |\r\nWDIOF_MAGICCLOSE,\r\n.firmware_version = 0,\r\n.identity = "Hardware Watchdog for TXx9",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_KEEPALIVE:\r\ntxx9wdt_ping();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_timeout, p))\r\nreturn -EFAULT;\r\nif (new_timeout < 1 || new_timeout > WD_MAX_TIMEOUT)\r\nreturn -EINVAL;\r\ntimeout = new_timeout;\r\ntxx9wdt_stop();\r\ntxx9wdt_start();\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(timeout, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int __init txx9wdt_probe(struct platform_device *dev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\ntxx9_imclk = clk_get(NULL, "imbus_clk");\r\nif (IS_ERR(txx9_imclk)) {\r\nret = PTR_ERR(txx9_imclk);\r\ntxx9_imclk = NULL;\r\ngoto exit;\r\n}\r\nret = clk_enable(txx9_imclk);\r\nif (ret) {\r\nclk_put(txx9_imclk);\r\ntxx9_imclk = NULL;\r\ngoto exit;\r\n}\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\ngoto exit_busy;\r\nif (!devm_request_mem_region(&dev->dev, res->start, resource_size(res),\r\n"txx9wdt"))\r\ngoto exit_busy;\r\ntxx9wdt_reg = devm_ioremap(&dev->dev, res->start, resource_size(res));\r\nif (!txx9wdt_reg)\r\ngoto exit_busy;\r\nret = misc_register(&txx9wdt_miscdev);\r\nif (ret) {\r\ngoto exit;\r\n}\r\nprintk(KERN_INFO "Hardware Watchdog Timer for TXx9: "\r\n"timeout=%d sec (max %ld) (nowayout= %d)\n",\r\ntimeout, WD_MAX_TIMEOUT, nowayout);\r\nreturn 0;\r\nexit_busy:\r\nret = -EBUSY;\r\nexit:\r\nif (txx9_imclk) {\r\nclk_disable(txx9_imclk);\r\nclk_put(txx9_imclk);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __exit txx9wdt_remove(struct platform_device *dev)\r\n{\r\nmisc_deregister(&txx9wdt_miscdev);\r\nclk_disable(txx9_imclk);\r\nclk_put(txx9_imclk);\r\nreturn 0;\r\n}\r\nstatic void txx9wdt_shutdown(struct platform_device *dev)\r\n{\r\ntxx9wdt_stop();\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nreturn platform_driver_probe(&txx9wdt_driver, txx9wdt_probe);\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nplatform_driver_unregister(&txx9wdt_driver);\r\n}

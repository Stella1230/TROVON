char *ax2asc(char *buf, const ax25_address *a)\r\n{\r\nchar c, *s;\r\nint n;\r\nfor (n = 0, s = buf; n < 6; n++) {\r\nc = (a->ax25_call[n] >> 1) & 0x7F;\r\nif (c != ' ') *s++ = c;\r\n}\r\n*s++ = '-';\r\nif ((n = ((a->ax25_call[6] >> 1) & 0x0F)) > 9) {\r\n*s++ = '1';\r\nn -= 10;\r\n}\r\n*s++ = n + '0';\r\n*s++ = '\0';\r\nif (*buf == '\0' || *buf == '-')\r\nreturn "*";\r\nreturn buf;\r\n}\r\nvoid asc2ax(ax25_address *addr, const char *callsign)\r\n{\r\nconst char *s;\r\nint n;\r\nfor (s = callsign, n = 0; n < 6; n++) {\r\nif (*s != '\0' && *s != '-')\r\naddr->ax25_call[n] = *s++;\r\nelse\r\naddr->ax25_call[n] = ' ';\r\naddr->ax25_call[n] <<= 1;\r\naddr->ax25_call[n] &= 0xFE;\r\n}\r\nif (*s++ == '\0') {\r\naddr->ax25_call[6] = 0x00;\r\nreturn;\r\n}\r\naddr->ax25_call[6] = *s++ - '0';\r\nif (*s != '\0') {\r\naddr->ax25_call[6] *= 10;\r\naddr->ax25_call[6] += *s++ - '0';\r\n}\r\naddr->ax25_call[6] <<= 1;\r\naddr->ax25_call[6] &= 0x1E;\r\n}\r\nint ax25cmp(const ax25_address *a, const ax25_address *b)\r\n{\r\nint ct = 0;\r\nwhile (ct < 6) {\r\nif ((a->ax25_call[ct] & 0xFE) != (b->ax25_call[ct] & 0xFE))\r\nreturn 1;\r\nct++;\r\n}\r\nif ((a->ax25_call[ct] & 0x1E) == (b->ax25_call[ct] & 0x1E))\r\nreturn 0;\r\nreturn 2;\r\n}\r\nint ax25digicmp(const ax25_digi *digi1, const ax25_digi *digi2)\r\n{\r\nint i;\r\nif (digi1->ndigi != digi2->ndigi)\r\nreturn 1;\r\nif (digi1->lastrepeat != digi2->lastrepeat)\r\nreturn 1;\r\nfor (i = 0; i < digi1->ndigi; i++)\r\nif (ax25cmp(&digi1->calls[i], &digi2->calls[i]) != 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nconst unsigned char *ax25_addr_parse(const unsigned char *buf, int len,\r\nax25_address *src, ax25_address *dest, ax25_digi *digi, int *flags,\r\nint *dama)\r\n{\r\nint d = 0;\r\nif (len < 14) return NULL;\r\nif (flags != NULL) {\r\n*flags = 0;\r\nif (buf[6] & AX25_CBIT)\r\n*flags = AX25_COMMAND;\r\nif (buf[13] & AX25_CBIT)\r\n*flags = AX25_RESPONSE;\r\n}\r\nif (dama != NULL)\r\n*dama = ~buf[13] & AX25_DAMA_FLAG;\r\nif (dest != NULL)\r\nmemcpy(dest, buf + 0, AX25_ADDR_LEN);\r\nif (src != NULL)\r\nmemcpy(src, buf + 7, AX25_ADDR_LEN);\r\nbuf += 2 * AX25_ADDR_LEN;\r\nlen -= 2 * AX25_ADDR_LEN;\r\ndigi->lastrepeat = -1;\r\ndigi->ndigi = 0;\r\nwhile (!(buf[-1] & AX25_EBIT)) {\r\nif (d >= AX25_MAX_DIGIS) return NULL;\r\nif (len < 7) return NULL;\r\nmemcpy(&digi->calls[d], buf, AX25_ADDR_LEN);\r\ndigi->ndigi = d + 1;\r\nif (buf[6] & AX25_HBIT) {\r\ndigi->repeated[d] = 1;\r\ndigi->lastrepeat = d;\r\n} else {\r\ndigi->repeated[d] = 0;\r\n}\r\nbuf += AX25_ADDR_LEN;\r\nlen -= AX25_ADDR_LEN;\r\nd++;\r\n}\r\nreturn buf;\r\n}\r\nint ax25_addr_build(unsigned char *buf, const ax25_address *src,\r\nconst ax25_address *dest, const ax25_digi *d, int flag, int modulus)\r\n{\r\nint len = 0;\r\nint ct = 0;\r\nmemcpy(buf, dest, AX25_ADDR_LEN);\r\nbuf[6] &= ~(AX25_EBIT | AX25_CBIT);\r\nbuf[6] |= AX25_SSSID_SPARE;\r\nif (flag == AX25_COMMAND) buf[6] |= AX25_CBIT;\r\nbuf += AX25_ADDR_LEN;\r\nlen += AX25_ADDR_LEN;\r\nmemcpy(buf, src, AX25_ADDR_LEN);\r\nbuf[6] &= ~(AX25_EBIT | AX25_CBIT);\r\nbuf[6] &= ~AX25_SSSID_SPARE;\r\nif (modulus == AX25_MODULUS)\r\nbuf[6] |= AX25_SSSID_SPARE;\r\nelse\r\nbuf[6] |= AX25_ESSID_SPARE;\r\nif (flag == AX25_RESPONSE) buf[6] |= AX25_CBIT;\r\nif (d == NULL || d->ndigi == 0) {\r\nbuf[6] |= AX25_EBIT;\r\nreturn 2 * AX25_ADDR_LEN;\r\n}\r\nbuf += AX25_ADDR_LEN;\r\nlen += AX25_ADDR_LEN;\r\nwhile (ct < d->ndigi) {\r\nmemcpy(buf, &d->calls[ct], AX25_ADDR_LEN);\r\nif (d->repeated[ct])\r\nbuf[6] |= AX25_HBIT;\r\nelse\r\nbuf[6] &= ~AX25_HBIT;\r\nbuf[6] &= ~AX25_EBIT;\r\nbuf[6] |= AX25_SSSID_SPARE;\r\nbuf += AX25_ADDR_LEN;\r\nlen += AX25_ADDR_LEN;\r\nct++;\r\n}\r\nbuf[-1] |= AX25_EBIT;\r\nreturn len;\r\n}\r\nint ax25_addr_size(const ax25_digi *dp)\r\n{\r\nif (dp == NULL)\r\nreturn 2 * AX25_ADDR_LEN;\r\nreturn AX25_ADDR_LEN * (2 + dp->ndigi);\r\n}\r\nvoid ax25_digi_invert(const ax25_digi *in, ax25_digi *out)\r\n{\r\nint ct;\r\nout->ndigi = in->ndigi;\r\nout->lastrepeat = in->ndigi - in->lastrepeat - 2;\r\nfor (ct = 0; ct < in->ndigi; ct++) {\r\nout->calls[ct] = in->calls[in->ndigi - ct - 1];\r\nif (ct <= out->lastrepeat) {\r\nout->calls[ct].ax25_call[6] |= AX25_HBIT;\r\nout->repeated[ct] = 1;\r\n} else {\r\nout->calls[ct].ax25_call[6] &= ~AX25_HBIT;\r\nout->repeated[ct] = 0;\r\n}\r\n}\r\n}

static int r8180_wx_get_freq(struct net_device *dev,\r\nstruct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nreturn ieee80211_wx_get_freq(priv->ieee80211, a, wrqu, b);\r\n}\r\nint r8180_wx_set_key(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *key)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nstruct iw_point *erq = &(wrqu->encoding);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\nif (erq->flags & IW_ENCODE_DISABLED)\r\nif (erq->length > 0) {\r\nu32* tkey = (u32*) key;\r\npriv->key0[0] = tkey[0];\r\npriv->key0[1] = tkey[1];\r\npriv->key0[2] = tkey[2];\r\npriv->key0[3] = tkey[3] & 0xff;\r\nDMESG("Setting wep key to %x %x %x %x",\r\ntkey[0], tkey[1], tkey[2], tkey[3]);\r\nrtl8180_set_hw_wep(dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_beaconinterval(struct net_device *dev, struct iw_request_info *aa,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nint *parms = (int *)b;\r\nint bi = parms[0];\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nDMESG("setting beacon interval to %x", bi);\r\npriv->ieee80211->current_network.beacon_interval = bi;\r\nrtl8180_commit(dev);\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_get_mode(struct net_device *dev, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nreturn ieee80211_wx_get_mode(priv->ieee80211, a, wrqu, b);\r\n}\r\nstatic int r8180_wx_get_rate(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nreturn ieee80211_wx_get_rate(priv->ieee80211, info, wrqu, extra);\r\n}\r\nstatic int r8180_wx_set_rate(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_set_rate(priv->ieee80211, info, wrqu, extra);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_crcmon(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint *parms = (int *)extra;\r\nint enable = (parms[0] > 0);\r\nshort prev = priv->crcmon;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (enable)\r\npriv->crcmon = 1;\r\nelse\r\npriv->crcmon = 0;\r\nDMESG("bad CRC in monitor mode are %s",\r\npriv->crcmon ? "accepted" : "rejected");\r\nif (prev != priv->crcmon && priv->up) {\r\nrtl8180_down(dev);\r\nrtl8180_up(dev);\r\n}\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_mode(struct net_device *dev, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (priv->bInactivePs) {\r\nif (wrqu->mode == IW_MODE_ADHOC)\r\nIPSLeave(dev);\r\n}\r\nret = ieee80211_wx_set_mode(priv->ieee80211, a, wrqu, b);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int rtl8180_wx_get_range(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct iw_range *range = (struct iw_range *)extra;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nu16 val;\r\nint i;\r\nwrqu->data.length = sizeof(*range);\r\nmemset(range, 0, sizeof(*range));\r\nrange->throughput = 5 * 1000 * 1000;\r\nif (priv->rf_set_sens != NULL)\r\nrange->sensitivity = priv->max_sens;\r\nrange->max_qual.qual = 100;\r\nrange->max_qual.level = 0;\r\nrange->max_qual.noise = -98;\r\nrange->max_qual.updated = 7;\r\nrange->avg_qual.qual = 92;\r\nrange->avg_qual.level = 20 + -98;\r\nrange->avg_qual.noise = 0;\r\nrange->avg_qual.updated = 7;\r\nrange->num_bitrates = RATE_COUNT;\r\nfor (i = 0; i < RATE_COUNT && i < IW_MAX_BITRATES; i++)\r\nrange->bitrate[i] = rtl8180_rates[i];\r\nrange->min_frag = MIN_FRAG_THRESHOLD;\r\nrange->max_frag = MAX_FRAG_THRESHOLD;\r\nrange->pm_capa = 0;\r\nrange->we_version_compiled = WIRELESS_EXT;\r\nrange->we_version_source = 16;\r\nrange->num_channels = 14;\r\nfor (i = 0, val = 0; i < 14; i++) {\r\nif ((GET_DOT11D_INFO(priv->ieee80211)->channel_map)[i+1]) {\r\nrange->freq[val].i = i + 1;\r\nrange->freq[val].m = ieee80211_wlan_frequencies[i] * 100000;\r\nrange->freq[val].e = 1;\r\nval++;\r\n} else {\r\n}\r\nif (val == IW_MAX_FREQUENCIES)\r\nbreak;\r\n}\r\nrange->num_frequency = val;\r\nrange->enc_capa = IW_ENC_CAPA_WPA | IW_ENC_CAPA_WPA2 |\r\nIW_ENC_CAPA_CIPHER_TKIP | IW_ENC_CAPA_CIPHER_CCMP;\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_scan(struct net_device *dev, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret;\r\nstruct ieee80211_device* ieee = priv->ieee80211;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\nif (wrqu->data.flags & IW_SCAN_THIS_ESSID) {\r\nstruct iw_scan_req* req = (struct iw_scan_req*)b;\r\nif (req->essid_len) {\r\nieee->current_network.ssid_len = req->essid_len;\r\nmemcpy(ieee->current_network.ssid, req->essid, req->essid_len);\r\n}\r\n}\r\ndown(&priv->wx_sem);\r\nif (priv->up) {\r\npriv->ieee80211->actscanning = true;\r\nif (priv->bInactivePs && (priv->ieee80211->state != IEEE80211_LINKED)) {\r\nIPSLeave(dev);\r\nieee80211_softmac_ips_scan_syncro(priv->ieee80211);\r\nret = 0;\r\n} else {\r\nif ((priv->link_detect.bBusyTraffic) && (true)) {\r\nret = 0;\r\nprintk("Now traffic is busy, please try later!\n");\r\n} else\r\nret = ieee80211_wx_set_scan(priv->ieee80211, a, wrqu, b);\r\n}\r\n} else\r\nret = -1;\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_scan(struct net_device *dev, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nint ret;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\ndown(&priv->wx_sem);\r\nif (priv->up)\r\nret = ieee80211_wx_get_scan(priv->ieee80211, a, wrqu, b);\r\nelse\r\nret = -1;\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_essid(struct net_device *dev,\r\nstruct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (priv->bInactivePs)\r\nIPSLeave(dev);\r\nret = ieee80211_wx_set_essid(priv->ieee80211, a, wrqu, b);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_essid(struct net_device *dev,\r\nstruct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nint ret;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_get_essid(priv->ieee80211, a, wrqu, b);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_freq(struct net_device *dev, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nint ret;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_set_freq(priv->ieee80211, a, wrqu, b);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_name(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nreturn ieee80211_wx_get_name(priv->ieee80211, info, wrqu, extra);\r\n}\r\nstatic int r8180_wx_set_frag(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\nif (wrqu->frag.disabled)\r\npriv->ieee80211->fts = DEFAULT_FRAG_THRESHOLD;\r\nelse {\r\nif (wrqu->frag.value < MIN_FRAG_THRESHOLD ||\r\nwrqu->frag.value > MAX_FRAG_THRESHOLD)\r\nreturn -EINVAL;\r\npriv->ieee80211->fts = wrqu->frag.value & ~0x1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_get_frag(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nwrqu->frag.value = priv->ieee80211->fts;\r\nwrqu->frag.fixed = 0;\r\nwrqu->frag.disabled = (wrqu->frag.value == DEFAULT_FRAG_THRESHOLD);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_wap(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *awrq,\r\nchar *extra)\r\n{\r\nint ret;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_set_wap(priv->ieee80211, info, awrq, extra);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_wap(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nreturn ieee80211_wx_get_wap(priv->ieee80211, info, wrqu, extra);\r\n}\r\nstatic int r8180_wx_set_enc(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *key)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (priv->hw_wep) ret = r8180_wx_set_key(dev, info, wrqu, key);\r\nelse {\r\nDMESG("Setting SW wep key");\r\nret = ieee80211_wx_set_encode(priv->ieee80211, info, wrqu, key);\r\n}\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_enc(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *key)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nreturn ieee80211_wx_get_encode(priv->ieee80211, info, wrqu, key);\r\n}\r\nstatic int r8180_wx_set_scan_type(struct net_device *dev, struct iw_request_info *aa, union\r\niwreq_data *wrqu, char *p) {\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint *parms = (int*)p;\r\nint mode = parms[0];\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\npriv->ieee80211->active_scan = mode;\r\nreturn 1;\r\n}\r\nstatic int r8180_wx_set_retry(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint err = 0;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (wrqu->retry.flags & IW_RETRY_LIFETIME ||\r\nwrqu->retry.disabled) {\r\nerr = -EINVAL;\r\ngoto exit;\r\n}\r\nif (!(wrqu->retry.flags & IW_RETRY_LIMIT)) {\r\nerr = -EINVAL;\r\ngoto exit;\r\n}\r\nif (wrqu->retry.value > R8180_MAX_RETRY) {\r\nerr = -EINVAL;\r\ngoto exit;\r\n}\r\nif (wrqu->retry.flags & IW_RETRY_MAX) {\r\npriv->retry_rts = wrqu->retry.value;\r\nDMESG("Setting retry for RTS/CTS data to %d", wrqu->retry.value);\r\n} else {\r\npriv->retry_data = wrqu->retry.value;\r\nDMESG("Setting retry for non RTS/CTS data to %d", wrqu->retry.value);\r\n}\r\nrtl8180_commit(dev);\r\nexit:\r\nup(&priv->wx_sem);\r\nreturn err;\r\n}\r\nstatic int r8180_wx_get_retry(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nwrqu->retry.disabled = 0;\r\nif ((wrqu->retry.flags & IW_RETRY_TYPE) ==\r\nIW_RETRY_LIFETIME)\r\nreturn -EINVAL;\r\nif (wrqu->retry.flags & IW_RETRY_MAX) {\r\nwrqu->retry.flags = IW_RETRY_LIMIT & IW_RETRY_MAX;\r\nwrqu->retry.value = priv->retry_rts;\r\n} else {\r\nwrqu->retry.flags = IW_RETRY_LIMIT & IW_RETRY_MIN;\r\nwrqu->retry.value = priv->retry_data;\r\n}\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_get_sens(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->rf_set_sens == NULL)\r\nreturn -1;\r\nwrqu->sens.value = priv->sens;\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_sens(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nshort err = 0;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (priv->rf_set_sens == NULL) {\r\nerr = -1;\r\ngoto exit;\r\n}\r\nif (priv->rf_set_sens(dev, wrqu->sens.value) == 0)\r\npriv->sens = wrqu->sens.value;\r\nelse\r\nerr = -EINVAL;\r\nexit:\r\nup(&priv->wx_sem);\r\nreturn err;\r\n}\r\nstatic int r8180_wx_set_rawtx(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_set_rawtx(priv->ieee80211, info, wrqu, extra);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_power(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_get_power(priv->ieee80211, info, wrqu, extra);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_power(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nprintk("=>>>>>>>>>>=============================>set power:%d, %d!\n", wrqu->power.disabled, wrqu->power.flags);\r\nif (wrqu->power.disabled == 0) {\r\nwrqu->power.flags |= IW_POWER_ALL_R;\r\nwrqu->power.flags |= IW_POWER_TIMEOUT;\r\nwrqu->power.value = 1000;\r\n}\r\nret = ieee80211_wx_set_power(priv->ieee80211, info, wrqu, extra);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_rts(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\nif (wrqu->rts.disabled)\r\npriv->rts = DEFAULT_RTS_THRESHOLD;\r\nelse {\r\nif (wrqu->rts.value < MIN_RTS_THRESHOLD ||\r\nwrqu->rts.value > MAX_RTS_THRESHOLD)\r\nreturn -EINVAL;\r\npriv->rts = wrqu->rts.value;\r\n}\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_get_rts(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nwrqu->rts.value = priv->rts;\r\nwrqu->rts.fixed = 0;\r\nwrqu->rts.disabled = (wrqu->rts.value == 0);\r\nreturn 0;\r\n}\r\nstatic int dummy(struct net_device *dev, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nreturn -1;\r\n}\r\nstatic int r8180_wx_get_iwmode(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nstruct ieee80211_device *ieee;\r\nint ret = 0;\r\ndown(&priv->wx_sem);\r\nieee = priv->ieee80211;\r\nstrcpy(extra, "802.11");\r\nif (ieee->modulation & IEEE80211_CCK_MODULATION) {\r\nstrcat(extra, "b");\r\nif (ieee->modulation & IEEE80211_OFDM_MODULATION)\r\nstrcat(extra, "/g");\r\n} else if (ieee->modulation & IEEE80211_OFDM_MODULATION)\r\nstrcat(extra, "g");\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_iwmode(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nstruct ieee80211_device *ieee = priv->ieee80211;\r\nint *param = (int *)extra;\r\nint ret = 0;\r\nint modulation = 0, mode = 0;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (*param == 1) {\r\nmodulation |= IEEE80211_CCK_MODULATION;\r\nmode = IEEE_B;\r\nprintk(KERN_INFO "B mode!\n");\r\n} else if (*param == 2) {\r\nmodulation |= IEEE80211_OFDM_MODULATION;\r\nmode = IEEE_G;\r\nprintk(KERN_INFO "G mode!\n");\r\n} else if (*param == 3) {\r\nmodulation |= IEEE80211_CCK_MODULATION;\r\nmodulation |= IEEE80211_OFDM_MODULATION;\r\nmode = IEEE_B|IEEE_G;\r\nprintk(KERN_INFO "B/G mode!\n");\r\n}\r\nif (ieee->proto_started) {\r\nieee80211_stop_protocol(ieee);\r\nieee->mode = mode;\r\nieee->modulation = modulation;\r\nieee80211_start_protocol(ieee);\r\n} else {\r\nieee->mode = mode;\r\nieee->modulation = modulation;\r\n}\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_preamble(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\ndown(&priv->wx_sem);\r\n*extra = (char) priv->plcp_preamble_mode;\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_preamble(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret = 0;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (*extra < 0 || *extra > 2)\r\nret = -1;\r\nelse\r\npriv->plcp_preamble_mode = *((short *)extra) ;\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_siglevel(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret = 0;\r\ndown(&priv->wx_sem);\r\n*((int *)extra) = priv->wstats.qual.level;\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_get_sigqual(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret = 0;\r\ndown(&priv->wx_sem);\r\n*((int *)extra) = priv->wstats.qual.qual;\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_reset_stats(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\ndown(&priv->wx_sem);\r\npriv->stats.txrdu = 0;\r\npriv->stats.rxrdu = 0;\r\npriv->stats.rxnolast = 0;\r\npriv->stats.rxnodata = 0;\r\npriv->stats.rxnopointer = 0;\r\npriv->stats.txnperr = 0;\r\npriv->stats.txresumed = 0;\r\npriv->stats.rxerr = 0;\r\npriv->stats.rxoverflow = 0;\r\npriv->stats.rxint = 0;\r\npriv->stats.txnpokint = 0;\r\npriv->stats.txhpokint = 0;\r\npriv->stats.txhperr = 0;\r\npriv->stats.ints = 0;\r\npriv->stats.shints = 0;\r\npriv->stats.txoverflow = 0;\r\npriv->stats.rxdmafail = 0;\r\npriv->stats.txbeacon = 0;\r\npriv->stats.txbeaconerr = 0;\r\npriv->stats.txlpokint = 0;\r\npriv->stats.txlperr = 0;\r\npriv->stats.txretry = 0;\r\npriv->stats.rxcrcerrmin = 0 ;\r\npriv->stats.rxcrcerrmid = 0;\r\npriv->stats.rxcrcerrmax = 0;\r\npriv->stats.rxicverr = 0;\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_radio_on(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\npriv->rf_wakeup(dev);\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_radio_off(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\npriv->rf_sleep(dev);\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_get_channelplan(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\ndown(&priv->wx_sem);\r\n*extra = priv->channel_plan;\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_channelplan(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint *val = (int *)extra;\r\nint i;\r\nprintk("-----in fun %s\n", __func__);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nif (DefaultChannelPlan[*val].Len != 0) {\r\npriv->channel_plan = *val;\r\nfor (i = 1; i <= MAX_CHANNEL_NUMBER; i++)\r\nGET_DOT11D_INFO(priv->ieee80211)->channel_map[i] = 0;\r\nfor (i = 1; i <= DefaultChannelPlan[*val].Len; i++)\r\nGET_DOT11D_INFO(priv->ieee80211)->channel_map[DefaultChannelPlan[*val].Channel[i-1]] = 1;\r\n}\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_get_version(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\ndown(&priv->wx_sem);\r\nstrcpy(extra, "1020.0808");\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_forcerate(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nu8 forcerate = *extra;\r\ndown(&priv->wx_sem);\r\nprintk("==============>%s(): forcerate is %d\n", __func__, forcerate);\r\nif ((forcerate == 2) || (forcerate == 4) || (forcerate == 11) || (forcerate == 22) || (forcerate == 12) ||\r\n(forcerate == 18) || (forcerate == 24) || (forcerate == 36) || (forcerate == 48) || (forcerate == 72) ||\r\n(forcerate == 96) || (forcerate == 108))\r\n{\r\npriv->ForcedDataRate = 1;\r\npriv->ieee80211->rate = forcerate * 5;\r\n} else if (forcerate == 0) {\r\npriv->ForcedDataRate = 0;\r\nprintk("OK! return rate adaptive\n");\r\n} else\r\nprintk("ERR: wrong rate\n");\r\nup(&priv->wx_sem);\r\nreturn 0;\r\n}\r\nstatic int r8180_wx_set_enc_ext(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret = 0;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_set_encode_ext(priv->ieee80211, info, wrqu, extra);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_auth(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint ret = 0;\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\nret = ieee80211_wx_set_auth(priv->ieee80211, info, &wrqu->param, extra);\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_mlme(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret = 0;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\n#if 1\r\nret = ieee80211_wx_set_mlme(priv->ieee80211, info, wrqu, extra);\r\n#endif\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic int r8180_wx_set_gen_ie(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret = 0;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->bHwRadioOff)\r\nreturn 0;\r\ndown(&priv->wx_sem);\r\n#if 1\r\nret = ieee80211_wx_set_gen_ie(priv->ieee80211, extra, wrqu->data.length);\r\n#endif\r\nup(&priv->wx_sem);\r\nreturn ret;\r\n}\r\nstatic inline int is_same_network(struct ieee80211_network *src,\r\nstruct ieee80211_network *dst,\r\nstruct ieee80211_device *ieee)\r\n{\r\nreturn (((src->ssid_len == dst->ssid_len) || (ieee->iw_mode == IW_MODE_INFRA)) &&\r\n(src->channel == dst->channel) &&\r\n!memcmp(src->bssid, dst->bssid, ETH_ALEN) &&\r\n(!memcmp(src->ssid, dst->ssid, src->ssid_len) || (ieee->iw_mode == IW_MODE_INFRA)) &&\r\n((src->capability & WLAN_CAPABILITY_IBSS) ==\r\n(dst->capability & WLAN_CAPABILITY_IBSS)) &&\r\n((src->capability & WLAN_CAPABILITY_BSS) ==\r\n(dst->capability & WLAN_CAPABILITY_BSS)));\r\n}\r\nstatic struct iw_statistics *r8180_get_wireless_stats(struct net_device *dev)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nstruct ieee80211_device* ieee = priv->ieee80211;\r\nstruct iw_statistics* wstats = &priv->wstats;\r\nint tmp_level = 0;\r\nint tmp_qual = 0;\r\nint tmp_noise = 0;\r\nif (ieee->state < IEEE80211_LINKED) {\r\nwstats->qual.qual = 0;\r\nwstats->qual.level = 0;\r\nwstats->qual.noise = 0;\r\nwstats->qual.updated = IW_QUAL_ALL_UPDATED | IW_QUAL_DBM;\r\nreturn wstats;\r\n}\r\ntmp_level = (&ieee->current_network)->stats.signal;\r\ntmp_qual = (&ieee->current_network)->stats.signalstrength;\r\ntmp_noise = (&ieee->current_network)->stats.noise;\r\nwstats->qual.level = tmp_level;\r\nwstats->qual.qual = tmp_qual;\r\nwstats->qual.noise = tmp_noise;\r\nwstats->qual.updated = IW_QUAL_ALL_UPDATED | IW_QUAL_DBM;\r\nreturn wstats;\r\n}

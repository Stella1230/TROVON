static int __init driver_atao_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_atao);\r\n}\r\nstatic void __exit driver_atao_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_atao);\r\n}\r\nstatic int atao_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nunsigned long iobase;\r\nint ao_unipolar;\r\niobase = it->options[0];\r\nif (iobase == 0)\r\niobase = 0x1c0;\r\nao_unipolar = it->options[3];\r\nprintk(KERN_INFO "comedi%d: ni_at_ao: 0x%04lx", dev->minor, iobase);\r\nif (!request_region(iobase, ATAO_SIZE, "ni_at_ao")) {\r\nprintk(" I/O port conflict\n");\r\nreturn -EIO;\r\n}\r\ndev->iobase = iobase;\r\ndev->board_name = thisboard->name;\r\nif (alloc_private(dev, sizeof(struct atao_private)) < 0)\r\nreturn -ENOMEM;\r\nif (alloc_subdevices(dev, 4) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = thisboard->n_ao_chans;\r\ns->maxdata = (1 << 12) - 1;\r\nif (ao_unipolar)\r\ns->range_table = &range_unipolar10;\r\nelse\r\ns->range_table = &range_bipolar10;\r\ns->insn_write = &atao_ao_winsn;\r\ns->insn_read = &atao_ao_rinsn;\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = atao_dio_insn_bits;\r\ns->insn_config = atao_dio_insn_config;\r\ns = dev->subdevices + 2;\r\ns->type = COMEDI_SUBD_CALIB;\r\ns->subdev_flags = SDF_WRITABLE | SDF_INTERNAL;\r\ns->n_chan = 21;\r\ns->maxdata = 0xff;\r\ns->insn_read = atao_calib_insn_read;\r\ns->insn_write = atao_calib_insn_write;\r\ns = dev->subdevices + 3;\r\ns->type = COMEDI_SUBD_UNUSED;\r\natao_reset(dev);\r\nprintk(KERN_INFO "\n");\r\nreturn 0;\r\n}\r\nstatic int atao_detach(struct comedi_device *dev)\r\n{\r\nprintk(KERN_INFO "comedi%d: atao: remove\n", dev->minor);\r\nif (dev->iobase)\r\nrelease_region(dev->iobase, ATAO_SIZE);\r\nreturn 0;\r\n}\r\nstatic void atao_reset(struct comedi_device *dev)\r\n{\r\ndevpriv->cfg1 = 0;\r\noutw(devpriv->cfg1, dev->iobase + ATAO_CFG1);\r\noutb(RWSEL0 | MODESEL2, dev->iobase + ATAO_82C53_CNTRCMD);\r\noutb(0x03, dev->iobase + ATAO_82C53_CNTR1);\r\noutb(CNTRSEL0 | RWSEL0 | MODESEL2, dev->iobase + ATAO_82C53_CNTRCMD);\r\ndevpriv->cfg2 = 0;\r\noutw(devpriv->cfg2, dev->iobase + ATAO_CFG2);\r\ndevpriv->cfg3 = 0;\r\noutw(devpriv->cfg3, dev->iobase + ATAO_CFG3);\r\ninw(dev->iobase + ATAO_FIFO_CLEAR);\r\ndevpriv->cfg1 |= GRP2WR;\r\noutw(devpriv->cfg1, dev->iobase + ATAO_CFG1);\r\noutw(0, dev->iobase + ATAO_2_INT1CLR);\r\noutw(0, dev->iobase + ATAO_2_INT2CLR);\r\noutw(0, dev->iobase + ATAO_2_DMATCCLR);\r\ndevpriv->cfg1 &= ~GRP2WR;\r\noutw(devpriv->cfg1, dev->iobase + ATAO_CFG1);\r\n}\r\nstatic int atao_ao_winsn(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nshort bits;\r\nfor (i = 0; i < insn->n; i++) {\r\nbits = data[i] - 0x800;\r\nif (chan == 0) {\r\ndevpriv->cfg1 |= GRP2WR;\r\noutw(devpriv->cfg1, dev->iobase + ATAO_CFG1);\r\n}\r\noutw(bits, dev->iobase + ATAO_DACn(chan));\r\nif (chan == 0) {\r\ndevpriv->cfg1 &= ~GRP2WR;\r\noutw(devpriv->cfg1, dev->iobase + ATAO_CFG1);\r\n}\r\ndevpriv->ao_readback[chan] = data[i];\r\n}\r\nreturn i;\r\n}\r\nstatic int atao_ao_rinsn(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn i;\r\n}\r\nstatic int atao_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (insn->n != 2)\r\nreturn -EINVAL;\r\nif (data[0]) {\r\ns->state &= ~data[0];\r\ns->state |= data[0] & data[1];\r\noutw(s->state, dev->iobase + ATAO_DOUT);\r\n}\r\ndata[1] = inw(dev->iobase + ATAO_DIN);\r\nreturn 2;\r\n}\r\nstatic int atao_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint chan = CR_CHAN(insn->chanspec);\r\nunsigned int mask, bit;\r\nmask = (chan < 4) ? 0x0f : 0xf0;\r\nbit = (chan < 4) ? DOUTEN1 : DOUTEN2;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ns->io_bits |= mask;\r\ndevpriv->cfg3 |= bit;\r\nbreak;\r\ncase INSN_CONFIG_DIO_INPUT:\r\ns->io_bits &= ~mask;\r\ndevpriv->cfg3 &= ~bit;\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] =\r\n(s->io_bits & (1 << chan)) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\noutw(devpriv->cfg3, dev->iobase + ATAO_CFG3);\r\nreturn 1;\r\n}\r\nstatic int atao_calib_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = 0;\r\nreturn insn->n;\r\n}\r\nstatic int atao_calib_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int bitstring, bit;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nbitstring = ((chan & 0x7) << 8) | (data[insn->n - 1] & 0xff);\r\nfor (bit = 1 << (11 - 1); bit; bit >>= 1) {\r\noutw(devpriv->cfg2 | ((bit & bitstring) ? SDATA : 0),\r\ndev->iobase + ATAO_CFG2);\r\noutw(devpriv->cfg2 | SCLK | ((bit & bitstring) ? SDATA : 0),\r\ndev->iobase + ATAO_CFG2);\r\n}\r\noutw(devpriv->cfg2 | (((chan >> 3) + 1) << 14),\r\ndev->iobase + ATAO_CFG2);\r\noutw(devpriv->cfg2, dev->iobase + ATAO_CFG2);\r\nreturn insn->n;\r\n}

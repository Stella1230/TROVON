void omapfb_set_platform_data(struct omapfb_platform_data *data)\r\n{\r\n}\r\nstatic inline int ranges_overlap(unsigned long start1, unsigned long size1,\r\nunsigned long start2, unsigned long size2)\r\n{\r\nreturn (start1 >= start2 && start1 < start2 + size2) ||\r\n(start2 >= start1 && start2 < start1 + size1);\r\n}\r\nstatic inline int range_included(unsigned long start1, unsigned long size1,\r\nunsigned long start2, unsigned long size2)\r\n{\r\nreturn start1 >= start2 && start1 + size1 <= start2 + size2;\r\n}\r\nstatic int fbmem_region_reserved(unsigned long start, size_t size)\r\n{\r\nstruct omapfb_mem_region *rg;\r\nint i;\r\nrg = &omapfb_config.mem_desc.region[0];\r\nfor (i = 0; i < OMAPFB_PLANE_NUM; i++, rg++) {\r\nif (!rg->paddr)\r\ncontinue;\r\nif (ranges_overlap(start, size, rg->paddr, rg->size))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init get_fbmem_region(int region_idx, struct omapfb_mem_region *rg)\r\n{\r\nconst struct omap_fbmem_config *conf;\r\nu32 paddr;\r\nconf = omap_get_nr_config(OMAP_TAG_FBMEM,\r\nstruct omap_fbmem_config, region_idx);\r\nif (conf == NULL)\r\nreturn -ENOENT;\r\npaddr = conf->start;\r\nmemset(rg, 0, sizeof(*rg));\r\nrg->type = paddr & ~PAGE_MASK;\r\nrg->paddr = paddr & PAGE_MASK;\r\nrg->size = PAGE_ALIGN(conf->size);\r\nreturn 0;\r\n}\r\nstatic int set_fbmem_region_type(struct omapfb_mem_region *rg, int mem_type,\r\nunsigned long mem_start,\r\nunsigned long mem_size)\r\n{\r\nif (rg->type || !rg->paddr)\r\nreturn 0;\r\nif (ranges_overlap(rg->paddr, rg->size, mem_start, mem_size)) {\r\nrg->type = mem_type;\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}\r\nstatic int check_fbmem_region(int region_idx, struct omapfb_mem_region *rg,\r\nunsigned long start_avail, unsigned size_avail)\r\n{\r\nunsigned long paddr = rg->paddr;\r\nsize_t size = rg->size;\r\nif (rg->type > OMAPFB_MEMTYPE_MAX) {\r\nprintk(KERN_ERR\r\n"Invalid start address for FB region %d\n", region_idx);\r\nreturn -EINVAL;\r\n}\r\nif (!rg->size) {\r\nprintk(KERN_ERR "Zero size for FB region %d\n", region_idx);\r\nreturn -EINVAL;\r\n}\r\nif (!paddr)\r\nreturn 0;\r\nif (fbmem_region_reserved(paddr, size) ||\r\n!range_included(paddr, size, start_avail, size_avail)) {\r\nprintk(KERN_ERR "Trying to use reserved memory "\r\n"for FB region %d\n", region_idx);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int valid_sdram(unsigned long addr, unsigned long size)\r\n{\r\nreturn memblock_is_region_memory(addr, size);\r\n}\r\nstatic int reserve_sdram(unsigned long addr, unsigned long size)\r\n{\r\nif (memblock_is_region_reserved(addr, size))\r\nreturn -EBUSY;\r\nif (memblock_reserve(addr, size))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid __init omapfb_reserve_sdram_memblock(void)\r\n{\r\nunsigned long reserved = 0;\r\nint i;\r\nif (config_invalid)\r\nreturn;\r\nfor (i = 0; ; i++) {\r\nstruct omapfb_mem_region rg;\r\nif (get_fbmem_region(i, &rg) < 0)\r\nbreak;\r\nif (i == OMAPFB_PLANE_NUM) {\r\npr_err("Extraneous FB mem configuration entries\n");\r\nconfig_invalid = 1;\r\nreturn;\r\n}\r\nif (rg.type != OMAPFB_MEMTYPE_SDRAM)\r\ncontinue;\r\nif (rg.paddr && !valid_sdram(rg.paddr, rg.size))\r\ncontinue;\r\nif (rg.size == 0) {\r\npr_err("Zero size for FB region %d\n", i);\r\nconfig_invalid = 1;\r\nreturn;\r\n}\r\nif (rg.paddr) {\r\nif (reserve_sdram(rg.paddr, rg.size)) {\r\npr_err("Trying to use reserved memory for FB region %d\n",\r\ni);\r\nconfig_invalid = 1;\r\nreturn;\r\n}\r\nreserved += rg.size;\r\n}\r\nif (omapfb_config.mem_desc.region[i].size) {\r\npr_err("FB region %d already set\n", i);\r\nconfig_invalid = 1;\r\nreturn;\r\n}\r\nomapfb_config.mem_desc.region[i] = rg;\r\nconfigured_regions++;\r\n}\r\nomapfb_config.mem_desc.region_cnt = i;\r\nif (reserved)\r\npr_info("Reserving %lu bytes SDRAM for frame buffer\n",\r\nreserved);\r\n}\r\nunsigned long __init omapfb_reserve_sram(unsigned long sram_pstart,\r\nunsigned long sram_vstart,\r\nunsigned long sram_size,\r\nunsigned long pstart_avail,\r\nunsigned long size_avail)\r\n{\r\nstruct omapfb_mem_region rg;\r\nunsigned long pend_avail;\r\nunsigned long reserved;\r\nint i;\r\nif (config_invalid)\r\nreturn 0;\r\nreserved = 0;\r\npend_avail = pstart_avail + size_avail;\r\nfor (i = 0; ; i++) {\r\nif (get_fbmem_region(i, &rg) < 0)\r\nbreak;\r\nif (i == OMAPFB_PLANE_NUM) {\r\nprintk(KERN_ERR\r\n"Extraneous FB mem configuration entries\n");\r\nconfig_invalid = 1;\r\nreturn 0;\r\n}\r\nif (set_fbmem_region_type(&rg, OMAPFB_MEMTYPE_SRAM,\r\nsram_pstart, sram_size) < 0 ||\r\n(rg.type != OMAPFB_MEMTYPE_SRAM))\r\ncontinue;\r\nBUG_ON(omapfb_config.mem_desc.region[i].size);\r\nif (check_fbmem_region(i, &rg, pstart_avail, size_avail) < 0) {\r\nconfig_invalid = 1;\r\nreturn 0;\r\n}\r\nif (!rg.paddr) {\r\nif ((size_avail & PAGE_MASK) < rg.size) {\r\nprintk("Not enough SRAM for FB region %d\n",\r\ni);\r\nconfig_invalid = 1;\r\nreturn 0;\r\n}\r\nsize_avail = (size_avail - rg.size) & PAGE_MASK;\r\nrg.paddr = pstart_avail + size_avail;\r\n}\r\nif (pend_avail - rg.paddr > reserved)\r\nreserved = pend_avail - rg.paddr;\r\nsize_avail = pend_avail - reserved - pstart_avail;\r\nrg.vaddr = (void *)(sram_vstart + rg.paddr - sram_pstart);\r\nomapfb_config.mem_desc.region[i] = rg;\r\nconfigured_regions++;\r\n}\r\nomapfb_config.mem_desc.region_cnt = i;\r\nif (reserved)\r\npr_info("Reserving %lu bytes SRAM for frame buffer\n",\r\nreserved);\r\nreturn reserved;\r\n}\r\nvoid omapfb_set_ctrl_platform_data(void *data)\r\n{\r\nomapfb_config.ctrl_platform_data = data;\r\n}\r\nstatic int __init omap_init_fb(void)\r\n{\r\nconst struct omap_lcd_config *conf;\r\nif (config_invalid)\r\nreturn 0;\r\nif (configured_regions != omapfb_config.mem_desc.region_cnt) {\r\nprintk(KERN_ERR "Invalid FB mem configuration entries\n");\r\nreturn 0;\r\n}\r\nconf = omap_get_config(OMAP_TAG_LCD, struct omap_lcd_config);\r\nif (conf == NULL) {\r\nif (configured_regions)\r\nprintk(KERN_ERR "Missing LCD configuration\n");\r\nreturn 0;\r\n}\r\nomapfb_config.lcd = *conf;\r\nreturn platform_device_register(&omap_fb_device);\r\n}\r\nvoid omapfb_set_platform_data(struct omapfb_platform_data *data)\r\n{\r\nomapfb_config = *data;\r\n}\r\nstatic int __init omap_init_fb(void)\r\n{\r\nreturn platform_device_register(&omap_fb_device);\r\n}\r\nvoid omapfb_reserve_sdram_memblock(void)\r\n{\r\n}\r\nunsigned long __init omapfb_reserve_sram(unsigned long sram_pstart,\r\nunsigned long sram_vstart,\r\nunsigned long sram_size,\r\nunsigned long start_avail,\r\nunsigned long size_avail)\r\n{\r\nreturn 0;\r\n}\r\nvoid omapfb_set_platform_data(struct omapfb_platform_data *data)\r\n{\r\n}\r\nvoid omapfb_reserve_sdram_memblock(void)\r\n{\r\n}\r\nunsigned long __init omapfb_reserve_sram(unsigned long sram_pstart,\r\nunsigned long sram_vstart,\r\nunsigned long sram_size,\r\nunsigned long start_avail,\r\nunsigned long size_avail)\r\n{\r\nreturn 0;\r\n}

static int __init tomoyo_loader_setup(char *str)\r\n{\r\ntomoyo_loader = str;\r\nreturn 0;\r\n}\r\nstatic bool tomoyo_policy_loader_exists(void)\r\n{\r\nstruct path path;\r\nif (!tomoyo_loader)\r\ntomoyo_loader = CONFIG_SECURITY_TOMOYO_POLICY_LOADER;\r\nif (kern_path(tomoyo_loader, LOOKUP_FOLLOW, &path)) {\r\nprintk(KERN_INFO "Not activating Mandatory Access Control "\r\n"as %s does not exist.\n", tomoyo_loader);\r\nreturn false;\r\n}\r\npath_put(&path);\r\nreturn true;\r\n}\r\nstatic int __init tomoyo_trigger_setup(char *str)\r\n{\r\ntomoyo_trigger = str;\r\nreturn 0;\r\n}\r\nvoid tomoyo_load_policy(const char *filename)\r\n{\r\nstatic bool done;\r\nchar *argv[2];\r\nchar *envp[3];\r\nif (tomoyo_policy_loaded || done)\r\nreturn;\r\nif (!tomoyo_trigger)\r\ntomoyo_trigger = CONFIG_SECURITY_TOMOYO_ACTIVATION_TRIGGER;\r\nif (strcmp(filename, tomoyo_trigger))\r\nreturn;\r\nif (!tomoyo_policy_loader_exists())\r\nreturn;\r\ndone = true;\r\nprintk(KERN_INFO "Calling %s to load policy. Please wait.\n",\r\ntomoyo_loader);\r\nargv[0] = (char *) tomoyo_loader;\r\nargv[1] = NULL;\r\nenvp[0] = "HOME=/";\r\nenvp[1] = "PATH=/sbin:/bin:/usr/sbin:/usr/bin";\r\nenvp[2] = NULL;\r\ncall_usermodehelper(argv[0], argv, envp, 1);\r\ntomoyo_check_profile();\r\n}

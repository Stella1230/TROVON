static inline struct ab8500_gpio *to_ab8500_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct ab8500_gpio, chip);\r\n}\r\nstatic int ab8500_gpio_set_bits(struct gpio_chip *chip, u8 reg,\r\nunsigned offset, int val)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = to_ab8500_gpio(chip);\r\nu8 pos = offset % 8;\r\nint ret;\r\nreg = reg + (offset / 8);\r\nret = abx500_mask_and_set_register_interruptible(ab8500_gpio->dev,\r\nAB8500_MISC, reg, 1 << pos, val << pos);\r\nif (ret < 0)\r\ndev_err(ab8500_gpio->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nstatic int ab8500_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = to_ab8500_gpio(chip);\r\nu8 mask = 1 << (offset % 8);\r\nu8 reg = AB8500_GPIO_OUT1_REG + (offset / 8);\r\nint ret;\r\nu8 data;\r\nret = abx500_get_register_interruptible(ab8500_gpio->dev, AB8500_MISC,\r\nreg, &data);\r\nif (ret < 0) {\r\ndev_err(ab8500_gpio->dev, "%s read failed\n", __func__);\r\nreturn ret;\r\n}\r\nreturn (data & mask) >> (offset % 8);\r\n}\r\nstatic void ab8500_gpio_set(struct gpio_chip *chip, unsigned offset, int val)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = to_ab8500_gpio(chip);\r\nint ret;\r\nret = ab8500_gpio_set_bits(chip, AB8500_GPIO_OUT1_REG, offset, 1);\r\nif (ret < 0)\r\ndev_err(ab8500_gpio->dev, "%s write failed\n", __func__);\r\n}\r\nstatic int ab8500_gpio_direction_output(struct gpio_chip *chip, unsigned offset,\r\nint val)\r\n{\r\nint ret;\r\nret = ab8500_gpio_set_bits(chip, AB8500_GPIO_DIR1_REG, offset, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ab8500_gpio_set_bits(chip, AB8500_GPIO_PUD1_REG, offset, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn ab8500_gpio_set_bits(chip, AB8500_GPIO_OUT1_REG, offset, val);\r\n}\r\nstatic int ab8500_gpio_direction_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nreturn ab8500_gpio_set_bits(chip, AB8500_GPIO_DIR1_REG, offset, 0);\r\n}\r\nstatic int ab8500_gpio_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstatic struct ab8500_gpio_irq_cluster {\r\nint start;\r\nint end;\r\n} clusters[] = {\r\n{.start = 6, .end = 13},\r\n{.start = 24, .end = 25},\r\n{.start = 36, .end = 41},\r\n};\r\nstruct ab8500_gpio *ab8500_gpio = to_ab8500_gpio(chip);\r\nint base = ab8500_gpio->irq_base;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(clusters); i++) {\r\nstruct ab8500_gpio_irq_cluster *cluster = &clusters[i];\r\nif (offset >= cluster->start && offset <= cluster->end)\r\nreturn base + offset - cluster->start;\r\nbase += cluster->end - cluster->start + 1;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic unsigned int irq_to_rising(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nint offset = irq - ab8500_gpio->irq_base;\r\nint new_irq = offset + AB8500_INT_GPIO6R\r\n+ ab8500_gpio->parent->irq_base;\r\nreturn new_irq;\r\n}\r\nstatic unsigned int irq_to_falling(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nint offset = irq - ab8500_gpio->irq_base;\r\nint new_irq = offset + AB8500_INT_GPIO6F\r\n+ ab8500_gpio->parent->irq_base;\r\nreturn new_irq;\r\n}\r\nstatic unsigned int rising_to_irq(unsigned int irq, void *dev)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = dev;\r\nint offset = irq - AB8500_INT_GPIO6R\r\n- ab8500_gpio->parent->irq_base ;\r\nint new_irq = offset + ab8500_gpio->irq_base;\r\nreturn new_irq;\r\n}\r\nstatic unsigned int falling_to_irq(unsigned int irq, void *dev)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = dev;\r\nint offset = irq - AB8500_INT_GPIO6F\r\n- ab8500_gpio->parent->irq_base ;\r\nint new_irq = offset + ab8500_gpio->irq_base;\r\nreturn new_irq;\r\n}\r\nstatic irqreturn_t handle_rising(int irq, void *dev)\r\n{\r\nhandle_nested_irq(rising_to_irq(irq , dev));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t handle_falling(int irq, void *dev)\r\n{\r\nhandle_nested_irq(falling_to_irq(irq, dev));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ab8500_gpio_irq_lock(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nmutex_lock(&ab8500_gpio->lock);\r\n}\r\nstatic void ab8500_gpio_irq_sync_unlock(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nint offset = irq - ab8500_gpio->irq_base;\r\nbool rising = ab8500_gpio->rising & BIT(offset);\r\nbool falling = ab8500_gpio->falling & BIT(offset);\r\nint ret;\r\nswitch (ab8500_gpio->irq_action) {\r\ncase STARTUP:\r\nif (rising)\r\nret = request_threaded_irq(irq_to_rising(irq),\r\nNULL, handle_rising,\r\nIRQF_TRIGGER_RISING,\r\n"ab8500-gpio-r", ab8500_gpio);\r\nif (falling)\r\nret = request_threaded_irq(irq_to_falling(irq),\r\nNULL, handle_falling,\r\nIRQF_TRIGGER_FALLING,\r\n"ab8500-gpio-f", ab8500_gpio);\r\nbreak;\r\ncase SHUTDOWN:\r\nif (rising)\r\nfree_irq(irq_to_rising(irq), ab8500_gpio);\r\nif (falling)\r\nfree_irq(irq_to_falling(irq), ab8500_gpio);\r\nbreak;\r\ncase MASK:\r\nif (rising)\r\ndisable_irq(irq_to_rising(irq));\r\nif (falling)\r\ndisable_irq(irq_to_falling(irq));\r\nbreak;\r\ncase UNMASK:\r\nif (rising)\r\nenable_irq(irq_to_rising(irq));\r\nif (falling)\r\nenable_irq(irq_to_falling(irq));\r\nbreak;\r\ncase NONE:\r\nbreak;\r\n}\r\nab8500_gpio->irq_action = NONE;\r\nab8500_gpio->rising &= ~(BIT(offset));\r\nab8500_gpio->falling &= ~(BIT(offset));\r\nmutex_unlock(&ab8500_gpio->lock);\r\n}\r\nstatic void ab8500_gpio_irq_mask(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nab8500_gpio->irq_action = MASK;\r\n}\r\nstatic void ab8500_gpio_irq_unmask(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nab8500_gpio->irq_action = UNMASK;\r\n}\r\nstatic int ab8500_gpio_irq_set_type(unsigned int irq, unsigned int type)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nint offset = irq - ab8500_gpio->irq_base;\r\nif (type == IRQ_TYPE_EDGE_BOTH) {\r\nab8500_gpio->rising = BIT(offset);\r\nab8500_gpio->falling = BIT(offset);\r\n} else if (type == IRQ_TYPE_EDGE_RISING) {\r\nab8500_gpio->rising = BIT(offset);\r\n} else {\r\nab8500_gpio->falling = BIT(offset);\r\n}\r\nreturn 0;\r\n}\r\nunsigned int ab8500_gpio_irq_startup(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nab8500_gpio->irq_action = STARTUP;\r\nreturn 0;\r\n}\r\nvoid ab8500_gpio_irq_shutdown(unsigned int irq)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = get_irq_chip_data(irq);\r\nab8500_gpio->irq_action = SHUTDOWN;\r\n}\r\nstatic int ab8500_gpio_irq_init(struct ab8500_gpio *ab8500_gpio)\r\n{\r\nu32 base = ab8500_gpio->irq_base;\r\nint irq;\r\nfor (irq = base; irq < base + AB8500_NUM_VIR_GPIO_IRQ ; irq++) {\r\nset_irq_chip_data(irq, ab8500_gpio);\r\nset_irq_chip_and_handler(irq, &ab8500_gpio_irq_chip,\r\nhandle_simple_irq);\r\nset_irq_nested_thread(irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, IRQF_VALID);\r\n#else\r\nset_irq_noprobe(irq);\r\n#endif\r\n}\r\nreturn 0;\r\n}\r\nstatic void ab8500_gpio_irq_remove(struct ab8500_gpio *ab8500_gpio)\r\n{\r\nint base = ab8500_gpio->irq_base;\r\nint irq;\r\nfor (irq = base; irq < base + AB8500_NUM_VIR_GPIO_IRQ; irq++) {\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, 0);\r\n#endif\r\nset_irq_chip_and_handler(irq, NULL, NULL);\r\nset_irq_chip_data(irq, NULL);\r\n}\r\n}\r\nstatic int __devinit ab8500_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500_platform_data *ab8500_pdata =\r\ndev_get_platdata(pdev->dev.parent);\r\nstruct ab8500_gpio_platform_data *pdata;\r\nstruct ab8500_gpio *ab8500_gpio;\r\nint ret;\r\nint i;\r\npdata = ab8500_pdata->gpio;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "gpio platform data missing\n");\r\nreturn -ENODEV;\r\n}\r\nab8500_gpio = kzalloc(sizeof(struct ab8500_gpio), GFP_KERNEL);\r\nif (ab8500_gpio == NULL) {\r\ndev_err(&pdev->dev, "failed to allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\nab8500_gpio->dev = &pdev->dev;\r\nab8500_gpio->parent = dev_get_drvdata(pdev->dev.parent);\r\nab8500_gpio->chip = ab8500gpio_chip;\r\nab8500_gpio->chip.ngpio = AB8500_NUM_GPIO;\r\nab8500_gpio->chip.dev = &pdev->dev;\r\nab8500_gpio->chip.base = pdata->gpio_base;\r\nab8500_gpio->irq_base = pdata->irq_base;\r\nmutex_init(&ab8500_gpio->lock);\r\nfor (i = AB8500_GPIO_SEL1_REG; i <= AB8500_GPIO_SEL6_REG; i++) {\r\nret = abx500_set_register_interruptible(ab8500_gpio->dev,\r\nAB8500_MISC, i,\r\npdata->config_reg[i]);\r\nif (ret < 0)\r\ngoto out_free;\r\n}\r\nret = abx500_set_register_interruptible(ab8500_gpio->dev, AB8500_MISC,\r\nAB8500_GPIO_ALTFUN_REG,\r\npdata->config_reg[ALTFUN_REG_INDEX]);\r\nif (ret < 0)\r\ngoto out_free;\r\nret = ab8500_gpio_irq_init(ab8500_gpio);\r\nif (ret)\r\ngoto out_free;\r\nret = gpiochip_add(&ab8500_gpio->chip);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to add gpiochip: %d\n",\r\nret);\r\ngoto out_rem_irq;\r\n}\r\nplatform_set_drvdata(pdev, ab8500_gpio);\r\nreturn 0;\r\nout_rem_irq:\r\nab8500_gpio_irq_remove(ab8500_gpio);\r\nout_free:\r\nmutex_destroy(&ab8500_gpio->lock);\r\nkfree(ab8500_gpio);\r\nreturn ret;\r\n}\r\nstatic int __devexit ab8500_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct ab8500_gpio *ab8500_gpio = platform_get_drvdata(pdev);\r\nint ret;\r\nret = gpiochip_remove(&ab8500_gpio->chip);\r\nif (ret < 0) {\r\ndev_err(ab8500_gpio->dev, "unable to remove gpiochip: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, NULL);\r\nmutex_destroy(&ab8500_gpio->lock);\r\nkfree(ab8500_gpio);\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_gpio_driver);\r\n}\r\nstatic void __exit ab8500_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_gpio_driver);\r\n}

static void sa1111_start_hc(struct sa1111_dev *dev)\r\n{\r\nunsigned int usb_rst = 0;\r\nprintk(KERN_DEBUG "%s: starting SA-1111 OHCI USB Controller\n",\r\n__FILE__);\r\n#ifdef CONFIG_SA1100_BADGE4\r\nif (machine_is_badge4()) {\r\nbadge4_set_5V(BADGE4_5V_USB, 1);\r\n}\r\n#endif\r\nif (machine_is_xp860() ||\r\nmachine_has_neponset() ||\r\nmachine_is_pfs168() ||\r\nmachine_is_badge4())\r\nusb_rst = USB_RESET_PWRSENSELOW | USB_RESET_PWRCTRLLOW;\r\nsa1111_writel(usb_rst | USB_RESET_FORCEIFRESET | USB_RESET_FORCEHCRESET,\r\ndev->mapbase + SA1111_USB_RESET);\r\nsa1111_enable_device(dev);\r\nudelay(11);\r\nsa1111_writel(usb_rst, dev->mapbase + SA1111_USB_RESET);\r\n}\r\nstatic void sa1111_stop_hc(struct sa1111_dev *dev)\r\n{\r\nunsigned int usb_rst;\r\nprintk(KERN_DEBUG "%s: stopping SA-1111 OHCI USB Controller\n",\r\n__FILE__);\r\nusb_rst = sa1111_readl(dev->mapbase + SA1111_USB_RESET);\r\nsa1111_writel(usb_rst | USB_RESET_FORCEIFRESET | USB_RESET_FORCEHCRESET,\r\ndev->mapbase + SA1111_USB_RESET);\r\nsa1111_disable_device(dev);\r\n#ifdef CONFIG_SA1100_BADGE4\r\nif (machine_is_badge4()) {\r\nbadge4_set_5V(BADGE4_5V_USB, 0);\r\n}\r\n#endif\r\n}\r\nint usb_hcd_sa1111_probe (const struct hc_driver *driver,\r\nstruct sa1111_dev *dev)\r\n{\r\nstruct usb_hcd *hcd;\r\nint retval;\r\nhcd = usb_create_hcd (driver, &dev->dev, "sa1111");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = dev->res.start;\r\nhcd->rsrc_len = resource_size(&dev->res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\ndbg("request_mem_region failed");\r\nretval = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = dev->mapbase;\r\nsa1111_start_hc(dev);\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nretval = usb_add_hcd(hcd, dev->irq[1], 0);\r\nif (retval == 0)\r\nreturn retval;\r\nsa1111_stop_hc(dev);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn retval;\r\n}\r\nvoid usb_hcd_sa1111_remove (struct usb_hcd *hcd, struct sa1111_dev *dev)\r\n{\r\nusb_remove_hcd(hcd);\r\nsa1111_stop_hc(dev);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\n}\r\nstatic int __devinit\r\nohci_sa1111_start (struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci (hcd);\r\nint ret;\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nif ((ret = ohci_run (ohci)) < 0) {\r\nerr ("can't start %s", hcd->self.bus_name);\r\nohci_stop (hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_sa1111_drv_probe(struct sa1111_dev *dev)\r\n{\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nret = usb_hcd_sa1111_probe(&ohci_sa1111_hc_driver, dev);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_sa1111_drv_remove(struct sa1111_dev *dev)\r\n{\r\nstruct usb_hcd *hcd = sa1111_get_drvdata(dev);\r\nusb_hcd_sa1111_remove(hcd, dev);\r\nreturn 0;\r\n}

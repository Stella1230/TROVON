static void coh901327_enable(u16 timeout)\r\n{\r\nu16 val;\r\nunsigned long freq;\r\nunsigned long delay_ns;\r\nclk_enable(clk);\r\nval = readw(virtbase + U300_WDOG_D2R);\r\nif (val == U300_WDOG_D2R_DISABLE_STATUS_DISABLED)\r\nwritew(U300_WDOG_RR_RESTART_VALUE_RESUME,\r\nvirtbase + U300_WDOG_RR);\r\nwritew(U300_WDOG_IER_WILL_BARK_IRQ_ACK_ENABLE,\r\nvirtbase + U300_WDOG_IER);\r\nfreq = clk_get_rate(clk);\r\ndelay_ns = DIV_ROUND_UP(1000000000, freq);\r\ndelay_ns = 3 * delay_ns;\r\nndelay(delay_ns);\r\nwritew(U300_WDOG_IMR_WILL_BARK_IRQ_ENABLE, virtbase + U300_WDOG_IMR);\r\nwritew(timeout, virtbase + U300_WDOG_TR);\r\nwritew(U300_WDOG_FR_FEED_RESTART_TIMER, virtbase + U300_WDOG_FR);\r\n(void) readw(virtbase + U300_WDOG_CR);\r\nval = readw(virtbase + U300_WDOG_D2R);\r\nclk_disable(clk);\r\nif (val != U300_WDOG_D2R_DISABLE_STATUS_ENABLED)\r\ndev_err(parent,\r\n"%s(): watchdog not enabled! D2R value %04x\n",\r\n__func__, val);\r\n}\r\nstatic void coh901327_disable(void)\r\n{\r\nu16 val;\r\nclk_enable(clk);\r\nwritew(0x0000U, virtbase + U300_WDOG_IMR);\r\nval = readw(virtbase + U300_WDOG_D2R);\r\nif (val != U300_WDOG_D2R_DISABLE_STATUS_DISABLED) {\r\nwritew(U300_WDOG_D1R_DISABLE1_DISABLE_TIMER,\r\nvirtbase + U300_WDOG_D1R);\r\nwritew(U300_WDOG_D2R_DISABLE2_DISABLE_TIMER,\r\nvirtbase + U300_WDOG_D2R);\r\nwritew(U300_WDOG_D2R_DISABLE2_DISABLE_TIMER,\r\nvirtbase + U300_WDOG_D2R);\r\n}\r\nval = readw(virtbase + U300_WDOG_D2R);\r\nclk_disable(clk);\r\nif (val != U300_WDOG_D2R_DISABLE_STATUS_DISABLED)\r\ndev_err(parent,\r\n"%s(): watchdog not disabled! D2R value %04x\n",\r\n__func__, val);\r\n}\r\nstatic void coh901327_start(void)\r\n{\r\ncoh901327_enable(margin * 100);\r\n}\r\nstatic void coh901327_keepalive(void)\r\n{\r\nclk_enable(clk);\r\nwritew(U300_WDOG_FR_FEED_RESTART_TIMER,\r\nvirtbase + U300_WDOG_FR);\r\nclk_disable(clk);\r\n}\r\nstatic int coh901327_settimeout(int time)\r\n{\r\nif (time <= 0 || time > 327)\r\nreturn -EINVAL;\r\nmargin = time;\r\nclk_enable(clk);\r\nwritew(margin * 100, virtbase + U300_WDOG_TR);\r\nwritew(U300_WDOG_FR_FEED_RESTART_TIMER,\r\nvirtbase + U300_WDOG_FR);\r\nclk_disable(clk);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t coh901327_interrupt(int irq, void *data)\r\n{\r\nu16 val;\r\nclk_enable(clk);\r\nval = readw(virtbase + U300_WDOG_IER);\r\nif (val == U300_WDOG_IER_WILL_BARK_IRQ_EVENT_IND)\r\nwritew(U300_WDOG_IER_WILL_BARK_IRQ_ACK_ENABLE,\r\nvirtbase + U300_WDOG_IER);\r\nwritew(0x0000U, virtbase + U300_WDOG_IMR);\r\nclk_disable(clk);\r\ndev_crit(parent, "watchdog is barking!\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int coh901327_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(1, &coh901327_users))\r\nreturn -EBUSY;\r\ncoh901327_start();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int coh901327_release(struct inode *inode, struct file *file)\r\n{\r\nclear_bit(1, &coh901327_users);\r\ncoh901327_disable();\r\nreturn 0;\r\n}\r\nstatic ssize_t coh901327_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len)\r\ncoh901327_keepalive();\r\nreturn len;\r\n}\r\nstatic long coh901327_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nu16 val;\r\nint time;\r\nint new_options;\r\nunion {\r\nstruct watchdog_info __user *ident;\r\nint __user *i;\r\n} uarg;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_CARDRESET |\r\nWDIOF_SETTIMEOUT |\r\nWDIOF_KEEPALIVEPING,\r\n.identity = "COH 901 327 Watchdog",\r\n.firmware_version = 1,\r\n};\r\nuarg.i = (int __user *)arg;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user(uarg.ident, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\nret = put_user(0, uarg.i);\r\nbreak;\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(boot_status, uarg.i);\r\nbreak;\r\ncase WDIOC_SETOPTIONS:\r\nret = get_user(new_options, uarg.i);\r\nif (ret)\r\nbreak;\r\nif (new_options & WDIOS_DISABLECARD)\r\ncoh901327_disable();\r\nif (new_options & WDIOS_ENABLECARD)\r\ncoh901327_start();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\ncoh901327_keepalive();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, uarg.i);\r\nif (ret)\r\nbreak;\r\nret = coh901327_settimeout(time);\r\nif (ret)\r\nbreak;\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(margin, uarg.i);\r\nbreak;\r\ncase WDIOC_GETTIMELEFT:\r\nclk_enable(clk);\r\nval = readw(virtbase + U300_WDOG_CR);\r\nwhile (val & U300_WDOG_CR_VALID_IND)\r\nval = readw(virtbase + U300_WDOG_CR);\r\nval &= U300_WDOG_CR_COUNT_VALUE_MASK;\r\nclk_disable(clk);\r\nif (val != 0)\r\nval /= 100;\r\nret = put_user(val, uarg.i);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __exit coh901327_remove(struct platform_device *pdev)\r\n{\r\nmisc_deregister(&coh901327_miscdev);\r\ncoh901327_disable();\r\nfree_irq(irq, pdev);\r\nclk_put(clk);\r\niounmap(virtbase);\r\nrelease_mem_region(phybase, physize);\r\nreturn 0;\r\n}\r\nstatic int __init coh901327_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nu16 val;\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENOENT;\r\nparent = &pdev->dev;\r\nphysize = resource_size(res);\r\nphybase = res->start;\r\nif (request_mem_region(phybase, physize, DRV_NAME) == NULL) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nvirtbase = ioremap(phybase, physize);\r\nif (!virtbase) {\r\nret = -ENOMEM;\r\ngoto out_no_remap;\r\n}\r\nclk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\nret = PTR_ERR(clk);\r\ndev_err(&pdev->dev, "could not get clock\n");\r\ngoto out_no_clk;\r\n}\r\nret = clk_enable(clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "could not enable clock\n");\r\ngoto out_no_clk_enable;\r\n}\r\nval = readw(virtbase + U300_WDOG_SR);\r\nswitch (val) {\r\ncase U300_WDOG_SR_STATUS_TIMED_OUT:\r\ndev_info(&pdev->dev,\r\n"watchdog timed out since last chip reset!\n");\r\nboot_status = WDIOF_CARDRESET;\r\nbreak;\r\ncase U300_WDOG_SR_STATUS_NORMAL:\r\ndev_info(&pdev->dev,\r\n"in normal status, no timeouts have occurred.\n");\r\nbreak;\r\ndefault:\r\ndev_info(&pdev->dev,\r\n"contains an illegal status code (%08x)\n", val);\r\nbreak;\r\n}\r\nval = readw(virtbase + U300_WDOG_D2R);\r\nswitch (val) {\r\ncase U300_WDOG_D2R_DISABLE_STATUS_DISABLED:\r\ndev_info(&pdev->dev, "currently disabled.\n");\r\nbreak;\r\ncase U300_WDOG_D2R_DISABLE_STATUS_ENABLED:\r\ndev_info(&pdev->dev,\r\n"currently enabled! (disabling it now)\n");\r\ncoh901327_disable();\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev,\r\n"contains an illegal enable/disable code (%08x)\n",\r\nval);\r\nbreak;\r\n}\r\nwritew(U300_WDOG_SR_RESET_STATUS_RESET, virtbase + U300_WDOG_SR);\r\nirq = platform_get_irq(pdev, 0);\r\nif (request_irq(irq, coh901327_interrupt, 0,\r\nDRV_NAME " Bark", pdev)) {\r\nret = -EIO;\r\ngoto out_no_irq;\r\n}\r\nclk_disable(clk);\r\nret = misc_register(&coh901327_miscdev);\r\nif (ret == 0)\r\ndev_info(&pdev->dev,\r\n"initialized. timer margin=%d sec\n", margin);\r\nelse\r\ngoto out_no_wdog;\r\nreturn 0;\r\nout_no_wdog:\r\nfree_irq(irq, pdev);\r\nout_no_irq:\r\nclk_disable(clk);\r\nout_no_clk_enable:\r\nclk_put(clk);\r\nout_no_clk:\r\niounmap(virtbase);\r\nout_no_remap:\r\nrelease_mem_region(phybase, SZ_4K);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int coh901327_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nirqmaskstore = readw(virtbase + U300_WDOG_IMR) & 0x0001U;\r\nwdogenablestore = readw(virtbase + U300_WDOG_D2R);\r\nif (wdogenablestore == U300_WDOG_D2R_DISABLE_STATUS_ENABLED)\r\ncoh901327_disable();\r\nreturn 0;\r\n}\r\nstatic int coh901327_resume(struct platform_device *pdev)\r\n{\r\nwritew(irqmaskstore, virtbase + U300_WDOG_IMR);\r\nif (wdogenablestore == U300_WDOG_D2R_DISABLE_STATUS_ENABLED) {\r\nwritew(U300_WDOG_RR_RESTART_VALUE_RESUME,\r\nvirtbase + U300_WDOG_RR);\r\nwritew(U300_WDOG_FR_FEED_RESTART_TIMER,\r\nvirtbase + U300_WDOG_FR);\r\n}\r\nreturn 0;\r\n}\r\nvoid coh901327_watchdog_reset(void)\r\n{\r\nwritew(U300_WDOG_JOR_JTAG_WATCHDOG_ENABLE,\r\nvirtbase + U300_WDOG_JOR);\r\ncoh901327_enable(500);\r\n}\r\nstatic int __init coh901327_init(void)\r\n{\r\nreturn platform_driver_probe(&coh901327_driver, coh901327_probe);\r\n}\r\nstatic void __exit coh901327_exit(void)\r\n{\r\nplatform_driver_unregister(&coh901327_driver);\r\n}

static int imx_sata_init(struct device *dev, void __iomem *addr)\r\n{\r\nu32 tmpdata;\r\nint ret = 0;\r\nstruct clk *clk;\r\nsata_clk = clk_get(dev, "ahci");\r\nif (IS_ERR(sata_clk)) {\r\ndev_err(dev, "no sata clock.\n");\r\nreturn PTR_ERR(sata_clk);\r\n}\r\nret = clk_enable(sata_clk);\r\nif (ret) {\r\ndev_err(dev, "can't enable sata clock.\n");\r\ngoto put_sata_clk;\r\n}\r\nsata_ref_clk = clk_get(dev, "ahci_phy");\r\nif (IS_ERR(sata_ref_clk)) {\r\ndev_err(dev, "no sata ref clock.\n");\r\nret = PTR_ERR(sata_ref_clk);\r\ngoto release_sata_clk;\r\n}\r\nret = clk_enable(sata_ref_clk);\r\nif (ret) {\r\ndev_err(dev, "can't enable sata ref clock.\n");\r\ngoto put_sata_ref_clk;\r\n}\r\nclk = clk_get(dev, "ahci_dma");\r\nif (IS_ERR(clk)) {\r\ndev_err(dev, "no dma clock.\n");\r\nret = PTR_ERR(clk);\r\ngoto release_sata_ref_clk;\r\n}\r\ntmpdata = clk_get_rate(clk) / 1000;\r\nclk_put(clk);\r\nwritel(tmpdata, addr + HOST_TIMER1MS);\r\ntmpdata = readl(addr + HOST_CAP);\r\nif (!(tmpdata & HOST_CAP_SSS)) {\r\ntmpdata |= HOST_CAP_SSS;\r\nwritel(tmpdata, addr + HOST_CAP);\r\n}\r\nif (!(readl(addr + HOST_PORTS_IMPL) & 0x1))\r\nwritel((readl(addr + HOST_PORTS_IMPL) | 0x1),\r\naddr + HOST_PORTS_IMPL);\r\nreturn 0;\r\nrelease_sata_ref_clk:\r\nclk_disable(sata_ref_clk);\r\nput_sata_ref_clk:\r\nclk_put(sata_ref_clk);\r\nrelease_sata_clk:\r\nclk_disable(sata_clk);\r\nput_sata_clk:\r\nclk_put(sata_clk);\r\nreturn ret;\r\n}\r\nstatic void imx_sata_exit(struct device *dev)\r\n{\r\nclk_disable(sata_ref_clk);\r\nclk_put(sata_ref_clk);\r\nclk_disable(sata_clk);\r\nclk_put(sata_clk);\r\n}\r\nstruct platform_device *__init imx_add_ahci_imx(\r\nconst struct imx_ahci_imx_data *data,\r\nconst struct ahci_platform_data *pdata)\r\n{\r\nstruct resource res[] = {\r\n{\r\n.start = data->iobase,\r\n.end = data->iobase + SZ_4K - 1,\r\n.flags = IORESOURCE_MEM,\r\n}, {\r\n.start = data->irq,\r\n.end = data->irq,\r\n.flags = IORESOURCE_IRQ,\r\n},\r\n};\r\nreturn imx_add_platform_device_dmamask(data->devid, 0,\r\nres, ARRAY_SIZE(res),\r\npdata, sizeof(*pdata), DMA_BIT_MASK(32));\r\n}\r\nstruct platform_device *__init imx53_add_ahci_imx(void)\r\n{\r\nstruct ahci_platform_data pdata = {\r\n.init = imx_sata_init,\r\n.exit = imx_sata_exit,\r\n};\r\nreturn imx_add_ahci_imx(&imx53_ahci_imx_data, &pdata);\r\n}

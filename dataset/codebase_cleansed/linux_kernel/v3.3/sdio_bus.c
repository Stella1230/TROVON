static ssize_t modalias_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct sdio_func *func = dev_to_sdio_func (dev);\r\nreturn sprintf(buf, "sdio:c%02Xv%04Xd%04X\n",\r\nfunc->class, func->vendor, func->device);\r\n}\r\nstatic const struct sdio_device_id *sdio_match_one(struct sdio_func *func,\r\nconst struct sdio_device_id *id)\r\n{\r\nif (id->class != (__u8)SDIO_ANY_ID && id->class != func->class)\r\nreturn NULL;\r\nif (id->vendor != (__u16)SDIO_ANY_ID && id->vendor != func->vendor)\r\nreturn NULL;\r\nif (id->device != (__u16)SDIO_ANY_ID && id->device != func->device)\r\nreturn NULL;\r\nreturn id;\r\n}\r\nstatic const struct sdio_device_id *sdio_match_device(struct sdio_func *func,\r\nstruct sdio_driver *sdrv)\r\n{\r\nconst struct sdio_device_id *ids;\r\nids = sdrv->id_table;\r\nif (ids) {\r\nwhile (ids->class || ids->vendor || ids->device) {\r\nif (sdio_match_one(func, ids))\r\nreturn ids;\r\nids++;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic int sdio_bus_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct sdio_func *func = dev_to_sdio_func(dev);\r\nstruct sdio_driver *sdrv = to_sdio_driver(drv);\r\nif (sdio_match_device(func, sdrv))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nsdio_bus_uevent(struct device *dev, struct kobj_uevent_env *env)\r\n{\r\nstruct sdio_func *func = dev_to_sdio_func(dev);\r\nif (add_uevent_var(env,\r\n"SDIO_CLASS=%02X", func->class))\r\nreturn -ENOMEM;\r\nif (add_uevent_var(env,\r\n"SDIO_ID=%04X:%04X", func->vendor, func->device))\r\nreturn -ENOMEM;\r\nif (add_uevent_var(env,\r\n"MODALIAS=sdio:c%02Xv%04Xd%04X",\r\nfunc->class, func->vendor, func->device))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic int sdio_bus_probe(struct device *dev)\r\n{\r\nstruct sdio_driver *drv = to_sdio_driver(dev->driver);\r\nstruct sdio_func *func = dev_to_sdio_func(dev);\r\nconst struct sdio_device_id *id;\r\nint ret;\r\nid = sdio_match_device(func, drv);\r\nif (!id)\r\nreturn -ENODEV;\r\nif (func->card->host->caps & MMC_CAP_POWER_OFF_CARD) {\r\nret = pm_runtime_get_sync(dev);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nsdio_claim_host(func);\r\nret = sdio_set_block_size(func, 0);\r\nsdio_release_host(func);\r\nif (ret)\r\ngoto disable_runtimepm;\r\nret = drv->probe(func, id);\r\nif (ret)\r\ngoto disable_runtimepm;\r\nreturn 0;\r\ndisable_runtimepm:\r\nif (func->card->host->caps & MMC_CAP_POWER_OFF_CARD)\r\npm_runtime_put_noidle(dev);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int sdio_bus_remove(struct device *dev)\r\n{\r\nstruct sdio_driver *drv = to_sdio_driver(dev->driver);\r\nstruct sdio_func *func = dev_to_sdio_func(dev);\r\nint ret = 0;\r\nif (func->card->host->caps & MMC_CAP_POWER_OFF_CARD)\r\npm_runtime_get_sync(dev);\r\ndrv->remove(func);\r\nif (func->irq_handler) {\r\npr_warning("WARNING: driver %s did not remove "\r\n"its interrupt handler!\n", drv->name);\r\nsdio_claim_host(func);\r\nsdio_release_irq(func);\r\nsdio_release_host(func);\r\n}\r\nif (func->card->host->caps & MMC_CAP_POWER_OFF_CARD)\r\npm_runtime_put_noidle(dev);\r\nif (func->card->host->caps & MMC_CAP_POWER_OFF_CARD)\r\npm_runtime_put_sync(dev);\r\nreturn ret;\r\n}\r\nint sdio_register_bus(void)\r\n{\r\nreturn bus_register(&sdio_bus_type);\r\n}\r\nvoid sdio_unregister_bus(void)\r\n{\r\nbus_unregister(&sdio_bus_type);\r\n}\r\nint sdio_register_driver(struct sdio_driver *drv)\r\n{\r\ndrv->drv.name = drv->name;\r\ndrv->drv.bus = &sdio_bus_type;\r\nreturn driver_register(&drv->drv);\r\n}\r\nvoid sdio_unregister_driver(struct sdio_driver *drv)\r\n{\r\ndrv->drv.bus = &sdio_bus_type;\r\ndriver_unregister(&drv->drv);\r\n}\r\nstatic void sdio_release_func(struct device *dev)\r\n{\r\nstruct sdio_func *func = dev_to_sdio_func(dev);\r\nsdio_free_func_cis(func);\r\nif (func->info)\r\nkfree(func->info);\r\nkfree(func);\r\n}\r\nstruct sdio_func *sdio_alloc_func(struct mmc_card *card)\r\n{\r\nstruct sdio_func *func;\r\nfunc = kzalloc(sizeof(struct sdio_func), GFP_KERNEL);\r\nif (!func)\r\nreturn ERR_PTR(-ENOMEM);\r\nfunc->card = card;\r\ndevice_initialize(&func->dev);\r\nfunc->dev.parent = &card->dev;\r\nfunc->dev.bus = &sdio_bus_type;\r\nfunc->dev.release = sdio_release_func;\r\nreturn func;\r\n}\r\nint sdio_add_func(struct sdio_func *func)\r\n{\r\nint ret;\r\ndev_set_name(&func->dev, "%s:%d", mmc_card_id(func->card), func->num);\r\nret = device_add(&func->dev);\r\nif (ret == 0)\r\nsdio_func_set_present(func);\r\nreturn ret;\r\n}\r\nvoid sdio_remove_func(struct sdio_func *func)\r\n{\r\nif (!sdio_func_present(func))\r\nreturn;\r\ndevice_del(&func->dev);\r\nput_device(&func->dev);\r\n}

static void via_set_speed(ide_hwif_t *hwif, u8 dn, struct ide_timing *timing)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nstruct via82cxxx_dev *vdev = host->host_priv;\r\nu8 t;\r\nif (~vdev->via_config->flags & VIA_BAD_AST) {\r\npci_read_config_byte(dev, VIA_ADDRESS_SETUP, &t);\r\nt = (t & ~(3 << ((3 - dn) << 1))) | ((clamp_val(timing->setup, 1, 4) - 1) << ((3 - dn) << 1));\r\npci_write_config_byte(dev, VIA_ADDRESS_SETUP, t);\r\n}\r\npci_write_config_byte(dev, VIA_8BIT_TIMING + (1 - (dn >> 1)),\r\n((clamp_val(timing->act8b, 1, 16) - 1) << 4) | (clamp_val(timing->rec8b, 1, 16) - 1));\r\npci_write_config_byte(dev, VIA_DRIVE_TIMING + (3 - dn),\r\n((clamp_val(timing->active, 1, 16) - 1) << 4) | (clamp_val(timing->recover, 1, 16) - 1));\r\nswitch (vdev->via_config->udma_mask) {\r\ncase ATA_UDMA2: t = timing->udma ? (0xe0 | (clamp_val(timing->udma, 2, 5) - 2)) : 0x03; break;\r\ncase ATA_UDMA4: t = timing->udma ? (0xe8 | (clamp_val(timing->udma, 2, 9) - 2)) : 0x0f; break;\r\ncase ATA_UDMA5: t = timing->udma ? (0xe0 | (clamp_val(timing->udma, 2, 9) - 2)) : 0x07; break;\r\ncase ATA_UDMA6: t = timing->udma ? (0xe0 | (clamp_val(timing->udma, 2, 9) - 2)) : 0x07; break;\r\n}\r\nif (vdev->via_config->udma_mask) {\r\nu8 udma_etc;\r\npci_read_config_byte(dev, VIA_UDMA_TIMING + 3 - dn, &udma_etc);\r\nudma_etc &= ~0x20;\r\nif (timing->udma) {\r\nudma_etc &= 0x10;\r\nudma_etc |= t;\r\n}\r\npci_write_config_byte(dev, VIA_UDMA_TIMING + 3 - dn, udma_etc);\r\n}\r\n}\r\nstatic void via_set_drive(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nide_drive_t *peer = ide_get_pair_dev(drive);\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nstruct via82cxxx_dev *vdev = host->host_priv;\r\nstruct ide_timing t, p;\r\nunsigned int T, UT;\r\nconst u8 speed = drive->dma_mode;\r\nT = 1000000000 / via_clock;\r\nswitch (vdev->via_config->udma_mask) {\r\ncase ATA_UDMA2: UT = T; break;\r\ncase ATA_UDMA4: UT = T/2; break;\r\ncase ATA_UDMA5: UT = T/3; break;\r\ncase ATA_UDMA6: UT = T/4; break;\r\ndefault: UT = T;\r\n}\r\nide_timing_compute(drive, speed, &t, T, UT);\r\nif (peer) {\r\nide_timing_compute(peer, peer->pio_mode, &p, T, UT);\r\nide_timing_merge(&p, &t, &t, IDE_TIMING_8BIT);\r\n}\r\nvia_set_speed(hwif, drive->dn, &t);\r\n}\r\nstatic void via_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\ndrive->dma_mode = drive->pio_mode;\r\nvia_set_drive(hwif, drive);\r\n}\r\nstatic struct via_isa_bridge *via_config_find(struct pci_dev **isa)\r\n{\r\nstruct via_isa_bridge *via_config;\r\nfor (via_config = via_isa_bridges;\r\nvia_config->id != PCI_DEVICE_ID_VIA_ANON; via_config++)\r\nif ((*isa = pci_get_device(PCI_VENDOR_ID_VIA +\r\n!!(via_config->flags & VIA_BAD_ID),\r\nvia_config->id, NULL))) {\r\nif ((*isa)->revision >= via_config->rev_min &&\r\n(*isa)->revision <= via_config->rev_max)\r\nbreak;\r\npci_dev_put(*isa);\r\n}\r\nreturn via_config;\r\n}\r\nstatic void via_cable_detect(struct via82cxxx_dev *vdev, u32 u)\r\n{\r\nint i;\r\nswitch (vdev->via_config->udma_mask) {\r\ncase ATA_UDMA4:\r\nfor (i = 24; i >= 0; i -= 8)\r\nif (((u >> (i & 16)) & 8) &&\r\n((u >> i) & 0x20) &&\r\n(((u >> i) & 7) < 2)) {\r\nvdev->via_80w |= (1 << (1 - (i >> 4)));\r\n}\r\nbreak;\r\ncase ATA_UDMA5:\r\nfor (i = 24; i >= 0; i -= 8)\r\nif (((u >> i) & 0x10) ||\r\n(((u >> i) & 0x20) &&\r\n(((u >> i) & 7) < 4))) {\r\nvdev->via_80w |= (1 << (1 - (i >> 4)));\r\n}\r\nbreak;\r\ncase ATA_UDMA6:\r\nfor (i = 24; i >= 0; i -= 8)\r\nif (((u >> i) & 0x10) ||\r\n(((u >> i) & 0x20) &&\r\n(((u >> i) & 7) < 6))) {\r\nvdev->via_80w |= (1 << (1 - (i >> 4)));\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int init_chipset_via82cxxx(struct pci_dev *dev)\r\n{\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nstruct via82cxxx_dev *vdev = host->host_priv;\r\nstruct via_isa_bridge *via_config = vdev->via_config;\r\nu8 t, v;\r\nu32 u;\r\npci_read_config_dword(dev, VIA_UDMA_TIMING, &u);\r\nvia_cable_detect(vdev, u);\r\nif (via_config->udma_mask == ATA_UDMA4) {\r\npci_write_config_dword(dev, VIA_UDMA_TIMING, u|0x80008);\r\n} else if (via_config->flags & VIA_BAD_CLK66) {\r\npci_write_config_dword(dev, VIA_UDMA_TIMING, u & ~0x80008);\r\n}\r\npci_read_config_byte(dev, VIA_IDE_ENABLE, &v);\r\npci_read_config_byte(dev, VIA_FIFO_CONFIG, &t);\r\nif (via_config->flags & VIA_BAD_PREQ) {\r\nt &= 0x7f;\r\n}\r\nif (via_config->flags & VIA_SET_FIFO) {\r\nt &= (t & 0x9f);\r\nswitch (v & 3) {\r\ncase 2: t |= 0x00; break;\r\ncase 1: t |= 0x60; break;\r\ncase 3: t |= 0x20; break;\r\n}\r\n}\r\npci_write_config_byte(dev, VIA_FIFO_CONFIG, t);\r\nreturn 0;\r\n}\r\nstatic int via_cable_override(struct pci_dev *pdev)\r\n{\r\nif (dmi_check_system(cable_dmi_table))\r\nreturn 1;\r\nif (pdev->subsystem_vendor == 0x161F &&\r\npdev->subsystem_device == 0x2032)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic u8 via82cxxx_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nstruct ide_host *host = pci_get_drvdata(pdev);\r\nstruct via82cxxx_dev *vdev = host->host_priv;\r\nif (via_cable_override(pdev))\r\nreturn ATA_CBL_PATA40_SHORT;\r\nif ((vdev->via_config->flags & VIA_SATA_PATA) && hwif->channel == 0)\r\nreturn ATA_CBL_SATA;\r\nif ((vdev->via_80w >> hwif->channel) & 1)\r\nreturn ATA_CBL_PATA80;\r\nelse\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic int __devinit via_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct pci_dev *isa = NULL;\r\nstruct via_isa_bridge *via_config;\r\nstruct via82cxxx_dev *vdev;\r\nint rc;\r\nu8 idx = id->driver_data;\r\nstruct ide_port_info d;\r\nd = via82cxxx_chipset;\r\nvia_config = via_config_find(&isa);\r\nprintk(KERN_INFO DRV_NAME " %s: VIA %s (rev %02x) IDE %sDMA%s\n",\r\npci_name(dev), via_config->name, isa->revision,\r\nvia_config->udma_mask ? "U" : "MW",\r\nvia_dma[via_config->udma_mask ?\r\n(fls(via_config->udma_mask) - 1) : 0]);\r\npci_dev_put(isa);\r\nvia_clock = (ide_pci_clk ? ide_pci_clk : 33) * 1000;\r\nswitch (via_clock) {\r\ncase 33000: via_clock = 33333; break;\r\ncase 37000: via_clock = 37500; break;\r\ncase 41000: via_clock = 41666; break;\r\n}\r\nif (via_clock < 20000 || via_clock > 50000) {\r\nprintk(KERN_WARNING DRV_NAME ": User given PCI clock speed "\r\n"impossible (%d), using 33 MHz instead.\n", via_clock);\r\nvia_clock = 33333;\r\n}\r\nif (idx == 1)\r\nd.enablebits[1].reg = d.enablebits[0].reg = 0;\r\nelse\r\nd.host_flags |= IDE_HFLAG_NO_AUTODMA;\r\nif (idx == VIA_IDFLAG_SINGLE)\r\nd.host_flags |= IDE_HFLAG_SINGLE;\r\nif ((via_config->flags & VIA_NO_UNMASK) == 0)\r\nd.host_flags |= IDE_HFLAG_UNMASK_IRQS;\r\nd.udma_mask = via_config->udma_mask;\r\nvdev = kzalloc(sizeof(*vdev), GFP_KERNEL);\r\nif (!vdev) {\r\nprintk(KERN_ERR DRV_NAME " %s: out of memory :(\n",\r\npci_name(dev));\r\nreturn -ENOMEM;\r\n}\r\nvdev->via_config = via_config;\r\nrc = ide_pci_init_one(dev, &d, vdev);\r\nif (rc)\r\nkfree(vdev);\r\nreturn rc;\r\n}\r\nstatic void __devexit via_remove(struct pci_dev *dev)\r\n{\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nstruct via82cxxx_dev *vdev = host->host_priv;\r\nide_pci_remove(dev);\r\nkfree(vdev);\r\n}\r\nstatic int __init via_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&via_pci_driver);\r\n}\r\nstatic void __exit via_ide_exit(void)\r\n{\r\npci_unregister_driver(&via_pci_driver);\r\n}

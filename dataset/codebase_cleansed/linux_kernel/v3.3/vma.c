static void __init patch_vdso(void *vdso, size_t len)\r\n{\r\nElf64_Ehdr *hdr = vdso;\r\nElf64_Shdr *sechdrs, *alt_sec = 0;\r\nchar *secstrings;\r\nvoid *alt_data;\r\nint i;\r\nBUG_ON(len < sizeof(Elf64_Ehdr));\r\nBUG_ON(memcmp(hdr->e_ident, ELFMAG, SELFMAG) != 0);\r\nsechdrs = (void *)hdr + hdr->e_shoff;\r\nsecstrings = (void *)hdr + sechdrs[hdr->e_shstrndx].sh_offset;\r\nfor (i = 1; i < hdr->e_shnum; i++) {\r\nElf64_Shdr *shdr = &sechdrs[i];\r\nif (!strcmp(secstrings + shdr->sh_name, ".altinstructions")) {\r\nalt_sec = shdr;\r\ngoto found;\r\n}\r\n}\r\npr_warning("patch_vdso: .altinstructions not found\n");\r\nreturn;\r\nfound:\r\nalt_data = (void *)hdr + alt_sec->sh_offset;\r\napply_alternatives(alt_data, alt_data + alt_sec->sh_size);\r\n}\r\nstatic int __init init_vdso(void)\r\n{\r\nint npages = (vdso_end - vdso_start + PAGE_SIZE - 1) / PAGE_SIZE;\r\nint i;\r\npatch_vdso(vdso_start, vdso_end - vdso_start);\r\nvdso_size = npages << PAGE_SHIFT;\r\nfor (i = 0; i < npages; i++)\r\nvdso_pages[i] = virt_to_page(vdso_start + i*PAGE_SIZE);\r\nreturn 0;\r\n}\r\nstatic unsigned long vdso_addr(unsigned long start, unsigned len)\r\n{\r\nunsigned long addr, end;\r\nunsigned offset;\r\nend = (start + PMD_SIZE - 1) & PMD_MASK;\r\nif (end >= TASK_SIZE_MAX)\r\nend = TASK_SIZE_MAX;\r\nend -= len;\r\noffset = get_random_int() & (PTRS_PER_PTE - 1);\r\naddr = start + (offset << PAGE_SHIFT);\r\nif (addr >= end)\r\naddr = end;\r\naddr = PAGE_ALIGN(addr);\r\naddr = align_addr(addr, NULL, ALIGN_VDSO);\r\nreturn addr;\r\n}\r\nint arch_setup_additional_pages(struct linux_binprm *bprm, int uses_interp)\r\n{\r\nstruct mm_struct *mm = current->mm;\r\nunsigned long addr;\r\nint ret;\r\nif (!vdso_enabled)\r\nreturn 0;\r\ndown_write(&mm->mmap_sem);\r\naddr = vdso_addr(mm->start_stack, vdso_size);\r\naddr = get_unmapped_area(NULL, addr, vdso_size, 0, 0);\r\nif (IS_ERR_VALUE(addr)) {\r\nret = addr;\r\ngoto up_fail;\r\n}\r\ncurrent->mm->context.vdso = (void *)addr;\r\nret = install_special_mapping(mm, addr, vdso_size,\r\nVM_READ|VM_EXEC|\r\nVM_MAYREAD|VM_MAYWRITE|VM_MAYEXEC|\r\nVM_ALWAYSDUMP,\r\nvdso_pages);\r\nif (ret) {\r\ncurrent->mm->context.vdso = NULL;\r\ngoto up_fail;\r\n}\r\nup_fail:\r\nup_write(&mm->mmap_sem);\r\nreturn ret;\r\n}\r\nstatic __init int vdso_setup(char *s)\r\n{\r\nvdso_enabled = simple_strtoul(s, NULL, 0);\r\nreturn 0;\r\n}

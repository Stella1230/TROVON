uint32_t radeon_legacy_get_engine_clock(struct radeon_device *rdev)\r\n{\r\nstruct radeon_pll *spll = &rdev->clock.spll;\r\nuint32_t fb_div, ref_div, post_div, sclk;\r\nfb_div = RREG32_PLL(RADEON_M_SPLL_REF_FB_DIV);\r\nfb_div = (fb_div >> RADEON_SPLL_FB_DIV_SHIFT) & RADEON_SPLL_FB_DIV_MASK;\r\nfb_div <<= 1;\r\nfb_div *= spll->reference_freq;\r\nref_div =\r\nRREG32_PLL(RADEON_M_SPLL_REF_FB_DIV) & RADEON_M_SPLL_REF_DIV_MASK;\r\nif (ref_div == 0)\r\nreturn 0;\r\nsclk = fb_div / ref_div;\r\npost_div = RREG32_PLL(RADEON_SCLK_CNTL) & RADEON_SCLK_SRC_SEL_MASK;\r\nif (post_div == 2)\r\nsclk >>= 1;\r\nelse if (post_div == 3)\r\nsclk >>= 2;\r\nelse if (post_div == 4)\r\nsclk >>= 3;\r\nreturn sclk;\r\n}\r\nuint32_t radeon_legacy_get_memory_clock(struct radeon_device *rdev)\r\n{\r\nstruct radeon_pll *mpll = &rdev->clock.mpll;\r\nuint32_t fb_div, ref_div, post_div, mclk;\r\nfb_div = RREG32_PLL(RADEON_M_SPLL_REF_FB_DIV);\r\nfb_div = (fb_div >> RADEON_MPLL_FB_DIV_SHIFT) & RADEON_MPLL_FB_DIV_MASK;\r\nfb_div <<= 1;\r\nfb_div *= mpll->reference_freq;\r\nref_div =\r\nRREG32_PLL(RADEON_M_SPLL_REF_FB_DIV) & RADEON_M_SPLL_REF_DIV_MASK;\r\nif (ref_div == 0)\r\nreturn 0;\r\nmclk = fb_div / ref_div;\r\npost_div = RREG32_PLL(RADEON_MCLK_CNTL) & 0x7;\r\nif (post_div == 2)\r\nmclk >>= 1;\r\nelse if (post_div == 3)\r\nmclk >>= 2;\r\nelse if (post_div == 4)\r\nmclk >>= 3;\r\nreturn mclk;\r\n}\r\nstatic bool radeon_read_clocks_OF(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct device_node *dp = rdev->pdev->dev.of_node;\r\nconst u32 *val;\r\nstruct radeon_pll *p1pll = &rdev->clock.p1pll;\r\nstruct radeon_pll *p2pll = &rdev->clock.p2pll;\r\nstruct radeon_pll *spll = &rdev->clock.spll;\r\nstruct radeon_pll *mpll = &rdev->clock.mpll;\r\nif (dp == NULL)\r\nreturn false;\r\nval = of_get_property(dp, "ATY,RefCLK", NULL);\r\nif (!val || !*val) {\r\nprintk(KERN_WARNING "radeonfb: No ATY,RefCLK property !\n");\r\nreturn false;\r\n}\r\np1pll->reference_freq = p2pll->reference_freq = (*val) / 10;\r\np1pll->reference_div = RREG32_PLL(RADEON_PPLL_REF_DIV) & 0x3ff;\r\nif (p1pll->reference_div < 2)\r\np1pll->reference_div = 12;\r\np2pll->reference_div = p1pll->reference_div;\r\nif (rdev->family >= CHIP_R420) {\r\np1pll->pll_in_min = 100;\r\np1pll->pll_in_max = 1350;\r\np1pll->pll_out_min = 20000;\r\np1pll->pll_out_max = 50000;\r\np2pll->pll_in_min = 100;\r\np2pll->pll_in_max = 1350;\r\np2pll->pll_out_min = 20000;\r\np2pll->pll_out_max = 50000;\r\n} else {\r\np1pll->pll_in_min = 40;\r\np1pll->pll_in_max = 500;\r\np1pll->pll_out_min = 12500;\r\np1pll->pll_out_max = 35000;\r\np2pll->pll_in_min = 40;\r\np2pll->pll_in_max = 500;\r\np2pll->pll_out_min = 12500;\r\np2pll->pll_out_max = 35000;\r\n}\r\nrdev->clock.max_pixel_clock = 35000;\r\nspll->reference_freq = mpll->reference_freq = p1pll->reference_freq;\r\nspll->reference_div = mpll->reference_div =\r\nRREG32_PLL(RADEON_M_SPLL_REF_FB_DIV) &\r\nRADEON_M_SPLL_REF_DIV_MASK;\r\nval = of_get_property(dp, "ATY,SCLK", NULL);\r\nif (val && *val)\r\nrdev->clock.default_sclk = (*val) / 10;\r\nelse\r\nrdev->clock.default_sclk =\r\nradeon_legacy_get_engine_clock(rdev);\r\nval = of_get_property(dp, "ATY,MCLK", NULL);\r\nif (val && *val)\r\nrdev->clock.default_mclk = (*val) / 10;\r\nelse\r\nrdev->clock.default_mclk =\r\nradeon_legacy_get_memory_clock(rdev);\r\nDRM_INFO("Using device-tree clock info\n");\r\nreturn true;\r\n}\r\nstatic bool radeon_read_clocks_OF(struct drm_device *dev)\r\n{\r\nreturn false;\r\n}\r\nvoid radeon_get_clock_info(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_pll *p1pll = &rdev->clock.p1pll;\r\nstruct radeon_pll *p2pll = &rdev->clock.p2pll;\r\nstruct radeon_pll *dcpll = &rdev->clock.dcpll;\r\nstruct radeon_pll *spll = &rdev->clock.spll;\r\nstruct radeon_pll *mpll = &rdev->clock.mpll;\r\nint ret;\r\nif (rdev->is_atom_bios)\r\nret = radeon_atom_get_clock_info(dev);\r\nelse\r\nret = radeon_combios_get_clock_info(dev);\r\nif (!ret)\r\nret = radeon_read_clocks_OF(dev);\r\nif (ret) {\r\nif (p1pll->reference_div < 2) {\r\nif (!ASIC_IS_AVIVO(rdev)) {\r\nu32 tmp = RREG32_PLL(RADEON_PPLL_REF_DIV);\r\nif (ASIC_IS_R300(rdev))\r\np1pll->reference_div =\r\n(tmp & R300_PPLL_REF_DIV_ACC_MASK) >> R300_PPLL_REF_DIV_ACC_SHIFT;\r\nelse\r\np1pll->reference_div = tmp & RADEON_PPLL_REF_DIV_MASK;\r\nif (p1pll->reference_div < 2)\r\np1pll->reference_div = 12;\r\n} else\r\np1pll->reference_div = 12;\r\n}\r\nif (p2pll->reference_div < 2)\r\np2pll->reference_div = 12;\r\nif (rdev->family < CHIP_RS600) {\r\nif (spll->reference_div < 2)\r\nspll->reference_div =\r\nRREG32_PLL(RADEON_M_SPLL_REF_FB_DIV) &\r\nRADEON_M_SPLL_REF_DIV_MASK;\r\n}\r\nif (mpll->reference_div < 2)\r\nmpll->reference_div = spll->reference_div;\r\n} else {\r\nif (ASIC_IS_AVIVO(rdev)) {\r\n} else {\r\nDRM_INFO("Using generic clock info\n");\r\nrdev->clock.max_pixel_clock = 35000;\r\nif (rdev->flags & RADEON_IS_IGP) {\r\np1pll->reference_freq = 1432;\r\np2pll->reference_freq = 1432;\r\nspll->reference_freq = 1432;\r\nmpll->reference_freq = 1432;\r\n} else {\r\np1pll->reference_freq = 2700;\r\np2pll->reference_freq = 2700;\r\nspll->reference_freq = 2700;\r\nmpll->reference_freq = 2700;\r\n}\r\np1pll->reference_div =\r\nRREG32_PLL(RADEON_PPLL_REF_DIV) & 0x3ff;\r\nif (p1pll->reference_div < 2)\r\np1pll->reference_div = 12;\r\np2pll->reference_div = p1pll->reference_div;\r\nif (rdev->family >= CHIP_R420) {\r\np1pll->pll_in_min = 100;\r\np1pll->pll_in_max = 1350;\r\np1pll->pll_out_min = 20000;\r\np1pll->pll_out_max = 50000;\r\np2pll->pll_in_min = 100;\r\np2pll->pll_in_max = 1350;\r\np2pll->pll_out_min = 20000;\r\np2pll->pll_out_max = 50000;\r\n} else {\r\np1pll->pll_in_min = 40;\r\np1pll->pll_in_max = 500;\r\np1pll->pll_out_min = 12500;\r\np1pll->pll_out_max = 35000;\r\np2pll->pll_in_min = 40;\r\np2pll->pll_in_max = 500;\r\np2pll->pll_out_min = 12500;\r\np2pll->pll_out_max = 35000;\r\n}\r\nspll->reference_div =\r\nRREG32_PLL(RADEON_M_SPLL_REF_FB_DIV) &\r\nRADEON_M_SPLL_REF_DIV_MASK;\r\nmpll->reference_div = spll->reference_div;\r\nrdev->clock.default_sclk =\r\nradeon_legacy_get_engine_clock(rdev);\r\nrdev->clock.default_mclk =\r\nradeon_legacy_get_memory_clock(rdev);\r\n}\r\n}\r\nif (ASIC_IS_AVIVO(rdev)) {\r\np1pll->min_post_div = 2;\r\np1pll->max_post_div = 0x7f;\r\np1pll->min_frac_feedback_div = 0;\r\np1pll->max_frac_feedback_div = 9;\r\np2pll->min_post_div = 2;\r\np2pll->max_post_div = 0x7f;\r\np2pll->min_frac_feedback_div = 0;\r\np2pll->max_frac_feedback_div = 9;\r\n} else {\r\np1pll->min_post_div = 1;\r\np1pll->max_post_div = 16;\r\np1pll->min_frac_feedback_div = 0;\r\np1pll->max_frac_feedback_div = 0;\r\np2pll->min_post_div = 1;\r\np2pll->max_post_div = 12;\r\np2pll->min_frac_feedback_div = 0;\r\np2pll->max_frac_feedback_div = 0;\r\n}\r\ndcpll->min_post_div = 2;\r\ndcpll->max_post_div = 0x7f;\r\ndcpll->min_frac_feedback_div = 0;\r\ndcpll->max_frac_feedback_div = 9;\r\ndcpll->min_ref_div = 2;\r\ndcpll->max_ref_div = 0x3ff;\r\ndcpll->min_feedback_div = 4;\r\ndcpll->max_feedback_div = 0xfff;\r\ndcpll->best_vco = 0;\r\np1pll->min_ref_div = 2;\r\np1pll->max_ref_div = 0x3ff;\r\np1pll->min_feedback_div = 4;\r\np1pll->max_feedback_div = 0x7ff;\r\np1pll->best_vco = 0;\r\np2pll->min_ref_div = 2;\r\np2pll->max_ref_div = 0x3ff;\r\np2pll->min_feedback_div = 4;\r\np2pll->max_feedback_div = 0x7ff;\r\np2pll->best_vco = 0;\r\nspll->min_post_div = 1;\r\nspll->max_post_div = 1;\r\nspll->min_ref_div = 2;\r\nspll->max_ref_div = 0xff;\r\nspll->min_feedback_div = 4;\r\nspll->max_feedback_div = 0xff;\r\nspll->best_vco = 0;\r\nmpll->min_post_div = 1;\r\nmpll->max_post_div = 1;\r\nmpll->min_ref_div = 2;\r\nmpll->max_ref_div = 0xff;\r\nmpll->min_feedback_div = 4;\r\nmpll->max_feedback_div = 0xff;\r\nmpll->best_vco = 0;\r\nif (!rdev->clock.default_sclk)\r\nrdev->clock.default_sclk = radeon_get_engine_clock(rdev);\r\nif ((!rdev->clock.default_mclk) && rdev->asic->get_memory_clock)\r\nrdev->clock.default_mclk = radeon_get_memory_clock(rdev);\r\nrdev->pm.current_sclk = rdev->clock.default_sclk;\r\nrdev->pm.current_mclk = rdev->clock.default_mclk;\r\n}\r\nstatic uint32_t calc_eng_mem_clock(struct radeon_device *rdev,\r\nuint32_t req_clock,\r\nint *fb_div, int *post_div)\r\n{\r\nstruct radeon_pll *spll = &rdev->clock.spll;\r\nint ref_div = spll->reference_div;\r\nif (!ref_div)\r\nref_div =\r\nRREG32_PLL(RADEON_M_SPLL_REF_FB_DIV) &\r\nRADEON_M_SPLL_REF_DIV_MASK;\r\nif (req_clock < 15000) {\r\n*post_div = 8;\r\nreq_clock *= 8;\r\n} else if (req_clock < 30000) {\r\n*post_div = 4;\r\nreq_clock *= 4;\r\n} else if (req_clock < 60000) {\r\n*post_div = 2;\r\nreq_clock *= 2;\r\n} else\r\n*post_div = 1;\r\nreq_clock *= ref_div;\r\nreq_clock += spll->reference_freq;\r\nreq_clock /= (2 * spll->reference_freq);\r\n*fb_div = req_clock & 0xff;\r\nreq_clock = (req_clock & 0xffff) << 1;\r\nreq_clock *= spll->reference_freq;\r\nreq_clock /= ref_div;\r\nreq_clock /= *post_div;\r\nreturn req_clock;\r\n}\r\nvoid radeon_legacy_set_engine_clock(struct radeon_device *rdev,\r\nuint32_t eng_clock)\r\n{\r\nuint32_t tmp;\r\nint fb_div, post_div;\r\neng_clock = calc_eng_mem_clock(rdev, eng_clock, &fb_div, &post_div);\r\ntmp = RREG32_PLL(RADEON_CLK_PIN_CNTL);\r\ntmp &= ~RADEON_DONT_USE_XTALIN;\r\nWREG32_PLL(RADEON_CLK_PIN_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp &= ~RADEON_SCLK_SRC_SEL_MASK;\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\nudelay(10);\r\ntmp = RREG32_PLL(RADEON_SPLL_CNTL);\r\ntmp |= RADEON_SPLL_SLEEP;\r\nWREG32_PLL(RADEON_SPLL_CNTL, tmp);\r\nudelay(2);\r\ntmp = RREG32_PLL(RADEON_SPLL_CNTL);\r\ntmp |= RADEON_SPLL_RESET;\r\nWREG32_PLL(RADEON_SPLL_CNTL, tmp);\r\nudelay(200);\r\ntmp = RREG32_PLL(RADEON_M_SPLL_REF_FB_DIV);\r\ntmp &= ~(RADEON_SPLL_FB_DIV_MASK << RADEON_SPLL_FB_DIV_SHIFT);\r\ntmp |= (fb_div & RADEON_SPLL_FB_DIV_MASK) << RADEON_SPLL_FB_DIV_SHIFT;\r\nWREG32_PLL(RADEON_M_SPLL_REF_FB_DIV, tmp);\r\ntmp = RREG32_PLL(RADEON_SPLL_CNTL);\r\ntmp &= ~RADEON_SPLL_PVG_MASK;\r\nif ((eng_clock * post_div) >= 90000)\r\ntmp |= (0x7 << RADEON_SPLL_PVG_SHIFT);\r\nelse\r\ntmp |= (0x4 << RADEON_SPLL_PVG_SHIFT);\r\nWREG32_PLL(RADEON_SPLL_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_SPLL_CNTL);\r\ntmp &= ~RADEON_SPLL_SLEEP;\r\nWREG32_PLL(RADEON_SPLL_CNTL, tmp);\r\nudelay(2);\r\ntmp = RREG32_PLL(RADEON_SPLL_CNTL);\r\ntmp &= ~RADEON_SPLL_RESET;\r\nWREG32_PLL(RADEON_SPLL_CNTL, tmp);\r\nudelay(200);\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp &= ~RADEON_SCLK_SRC_SEL_MASK;\r\nswitch (post_div) {\r\ncase 1:\r\ndefault:\r\ntmp |= 1;\r\nbreak;\r\ncase 2:\r\ntmp |= 2;\r\nbreak;\r\ncase 4:\r\ntmp |= 3;\r\nbreak;\r\ncase 8:\r\ntmp |= 4;\r\nbreak;\r\n}\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\nudelay(20);\r\ntmp = RREG32_PLL(RADEON_CLK_PIN_CNTL);\r\ntmp |= RADEON_DONT_USE_XTALIN;\r\nWREG32_PLL(RADEON_CLK_PIN_CNTL, tmp);\r\nudelay(10);\r\n}\r\nvoid radeon_legacy_set_clock_gating(struct radeon_device *rdev, int enable)\r\n{\r\nuint32_t tmp;\r\nif (enable) {\r\nif (rdev->flags & RADEON_SINGLE_CRTC) {\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\nif ((RREG32(RADEON_CONFIG_CNTL) &\r\nRADEON_CFG_ATI_REV_ID_MASK) >\r\nRADEON_CFG_ATI_REV_A13) {\r\ntmp &=\r\n~(RADEON_SCLK_FORCE_CP |\r\nRADEON_SCLK_FORCE_RB);\r\n}\r\ntmp &=\r\n~(RADEON_SCLK_FORCE_HDP | RADEON_SCLK_FORCE_DISP1 |\r\nRADEON_SCLK_FORCE_TOP | RADEON_SCLK_FORCE_SE |\r\nRADEON_SCLK_FORCE_IDCT | RADEON_SCLK_FORCE_RE |\r\nRADEON_SCLK_FORCE_PB | RADEON_SCLK_FORCE_TAM |\r\nRADEON_SCLK_FORCE_TDM);\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\n} else if (ASIC_IS_R300(rdev)) {\r\nif ((rdev->family == CHIP_RS400) ||\r\n(rdev->family == CHIP_RS480)) {\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp &=\r\n~(RADEON_SCLK_FORCE_DISP2 |\r\nRADEON_SCLK_FORCE_CP |\r\nRADEON_SCLK_FORCE_HDP |\r\nRADEON_SCLK_FORCE_DISP1 |\r\nRADEON_SCLK_FORCE_TOP |\r\nRADEON_SCLK_FORCE_E2 | R300_SCLK_FORCE_VAP\r\n| RADEON_SCLK_FORCE_IDCT |\r\nRADEON_SCLK_FORCE_VIP | R300_SCLK_FORCE_SR\r\n| R300_SCLK_FORCE_PX | R300_SCLK_FORCE_TX\r\n| R300_SCLK_FORCE_US |\r\nRADEON_SCLK_FORCE_TV_SCLK |\r\nR300_SCLK_FORCE_SU |\r\nRADEON_SCLK_FORCE_OV0);\r\ntmp |= RADEON_DYN_STOP_LAT_MASK;\r\ntmp |=\r\nRADEON_SCLK_FORCE_TOP |\r\nRADEON_SCLK_FORCE_VIP;\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_SCLK_MORE_CNTL);\r\ntmp &= ~RADEON_SCLK_MORE_FORCEON;\r\ntmp |= RADEON_SCLK_MORE_MAX_DYN_STOP_LAT;\r\nWREG32_PLL(RADEON_SCLK_MORE_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\r\ntmp |= (RADEON_PIXCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\ntmp |= (RADEON_PIX2CLK_ALWAYS_ONb |\r\nRADEON_PIX2CLK_DAC_ALWAYS_ONb |\r\nRADEON_DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb |\r\nR300_DVOCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_BLEND_ALWAYS_ONb |\r\nRADEON_PIXCLK_GV_ALWAYS_ONb |\r\nR300_PIXCLK_DVO_ALWAYS_ONb |\r\nRADEON_PIXCLK_LVDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_TMDS_ALWAYS_ONb |\r\nR300_PIXCLK_TRANS_ALWAYS_ONb |\r\nR300_PIXCLK_TVO_ALWAYS_ONb |\r\nR300_P2G2CLK_ALWAYS_ONb |\r\nR300_P2G2CLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\r\n} else if (rdev->family >= CHIP_RV350) {\r\ntmp = RREG32_PLL(R300_SCLK_CNTL2);\r\ntmp &= ~(R300_SCLK_FORCE_TCL |\r\nR300_SCLK_FORCE_GA |\r\nR300_SCLK_FORCE_CBA);\r\ntmp |= (R300_SCLK_TCL_MAX_DYN_STOP_LAT |\r\nR300_SCLK_GA_MAX_DYN_STOP_LAT |\r\nR300_SCLK_CBA_MAX_DYN_STOP_LAT);\r\nWREG32_PLL(R300_SCLK_CNTL2, tmp);\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp &=\r\n~(RADEON_SCLK_FORCE_DISP2 |\r\nRADEON_SCLK_FORCE_CP |\r\nRADEON_SCLK_FORCE_HDP |\r\nRADEON_SCLK_FORCE_DISP1 |\r\nRADEON_SCLK_FORCE_TOP |\r\nRADEON_SCLK_FORCE_E2 | R300_SCLK_FORCE_VAP\r\n| RADEON_SCLK_FORCE_IDCT |\r\nRADEON_SCLK_FORCE_VIP | R300_SCLK_FORCE_SR\r\n| R300_SCLK_FORCE_PX | R300_SCLK_FORCE_TX\r\n| R300_SCLK_FORCE_US |\r\nRADEON_SCLK_FORCE_TV_SCLK |\r\nR300_SCLK_FORCE_SU |\r\nRADEON_SCLK_FORCE_OV0);\r\ntmp |= RADEON_DYN_STOP_LAT_MASK;\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_SCLK_MORE_CNTL);\r\ntmp &= ~RADEON_SCLK_MORE_FORCEON;\r\ntmp |= RADEON_SCLK_MORE_MAX_DYN_STOP_LAT;\r\nWREG32_PLL(RADEON_SCLK_MORE_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\r\ntmp |= (RADEON_PIXCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\ntmp |= (RADEON_PIX2CLK_ALWAYS_ONb |\r\nRADEON_PIX2CLK_DAC_ALWAYS_ONb |\r\nRADEON_DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb |\r\nR300_DVOCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_BLEND_ALWAYS_ONb |\r\nRADEON_PIXCLK_GV_ALWAYS_ONb |\r\nR300_PIXCLK_DVO_ALWAYS_ONb |\r\nRADEON_PIXCLK_LVDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_TMDS_ALWAYS_ONb |\r\nR300_PIXCLK_TRANS_ALWAYS_ONb |\r\nR300_PIXCLK_TVO_ALWAYS_ONb |\r\nR300_P2G2CLK_ALWAYS_ONb |\r\nR300_P2G2CLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_MCLK_MISC);\r\ntmp |= (RADEON_MC_MCLK_DYN_ENABLE |\r\nRADEON_IO_MCLK_DYN_ENABLE);\r\nWREG32_PLL(RADEON_MCLK_MISC, tmp);\r\ntmp = RREG32_PLL(RADEON_MCLK_CNTL);\r\ntmp |= (RADEON_FORCEON_MCLKA |\r\nRADEON_FORCEON_MCLKB);\r\ntmp &= ~(RADEON_FORCEON_YCLKA |\r\nRADEON_FORCEON_YCLKB |\r\nRADEON_FORCEON_MC);\r\nif ((tmp & R300_DISABLE_MC_MCLKA) &&\r\n(tmp & R300_DISABLE_MC_MCLKB)) {\r\ntmp = RREG32_PLL(RADEON_MCLK_CNTL);\r\nif (rdev->mc.vram_width == 64) {\r\nif (RREG32(RADEON_MEM_CNTL) &\r\nR300_MEM_USE_CD_CH_ONLY)\r\ntmp &=\r\n~R300_DISABLE_MC_MCLKB;\r\nelse\r\ntmp &=\r\n~R300_DISABLE_MC_MCLKA;\r\n} else {\r\ntmp &= ~(R300_DISABLE_MC_MCLKA |\r\nR300_DISABLE_MC_MCLKB);\r\n}\r\n}\r\nWREG32_PLL(RADEON_MCLK_CNTL, tmp);\r\n} else {\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp &= ~(R300_SCLK_FORCE_VAP);\r\ntmp |= RADEON_SCLK_FORCE_CP;\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\nudelay(15000);\r\ntmp = RREG32_PLL(R300_SCLK_CNTL2);\r\ntmp &= ~(R300_SCLK_FORCE_TCL |\r\nR300_SCLK_FORCE_GA |\r\nR300_SCLK_FORCE_CBA);\r\nWREG32_PLL(R300_SCLK_CNTL2, tmp);\r\n}\r\n} else {\r\ntmp = RREG32_PLL(RADEON_CLK_PWRMGT_CNTL);\r\ntmp &= ~(RADEON_ACTIVE_HILO_LAT_MASK |\r\nRADEON_DISP_DYN_STOP_LAT_MASK |\r\nRADEON_DYN_STOP_MODE_MASK);\r\ntmp |= (RADEON_ENGIN_DYNCLK_MODE |\r\n(0x01 << RADEON_ACTIVE_HILO_LAT_SHIFT));\r\nWREG32_PLL(RADEON_CLK_PWRMGT_CNTL, tmp);\r\nudelay(15000);\r\ntmp = RREG32_PLL(RADEON_CLK_PIN_CNTL);\r\ntmp |= RADEON_SCLK_DYN_START_CNTL;\r\nWREG32_PLL(RADEON_CLK_PIN_CNTL, tmp);\r\nudelay(15000);\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp &= ~RADEON_SCLK_FORCEON_MASK;\r\nif (((rdev->family == CHIP_RV250) &&\r\n((RREG32(RADEON_CONFIG_CNTL) &\r\nRADEON_CFG_ATI_REV_ID_MASK) <\r\nRADEON_CFG_ATI_REV_A13))\r\n|| ((rdev->family == CHIP_RV100)\r\n&&\r\n((RREG32(RADEON_CONFIG_CNTL) &\r\nRADEON_CFG_ATI_REV_ID_MASK) <=\r\nRADEON_CFG_ATI_REV_A13))) {\r\ntmp |= RADEON_SCLK_FORCE_CP;\r\ntmp |= RADEON_SCLK_FORCE_VIP;\r\n}\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\nif ((rdev->family == CHIP_RV200) ||\r\n(rdev->family == CHIP_RV250) ||\r\n(rdev->family == CHIP_RV280)) {\r\ntmp = RREG32_PLL(RADEON_SCLK_MORE_CNTL);\r\ntmp &= ~RADEON_SCLK_MORE_FORCEON;\r\nif (((rdev->family == CHIP_RV200) ||\r\n(rdev->family == CHIP_RV250)) &&\r\n((RREG32(RADEON_CONFIG_CNTL) &\r\nRADEON_CFG_ATI_REV_ID_MASK) <\r\nRADEON_CFG_ATI_REV_A13)) {\r\ntmp |= RADEON_SCLK_MORE_FORCEON;\r\n}\r\nWREG32_PLL(RADEON_SCLK_MORE_CNTL, tmp);\r\nudelay(15000);\r\n}\r\nif (((rdev->family == CHIP_RV200) ||\r\n(rdev->family == CHIP_RV250)) &&\r\n((RREG32(RADEON_CONFIG_CNTL) &\r\nRADEON_CFG_ATI_REV_ID_MASK) <\r\nRADEON_CFG_ATI_REV_A13)) {\r\ntmp = RREG32_PLL(RADEON_PLL_PWRMGT_CNTL);\r\ntmp |= RADEON_TCL_BYPASS_DISABLE;\r\nWREG32_PLL(RADEON_PLL_PWRMGT_CNTL, tmp);\r\n}\r\nudelay(15000);\r\ntmp = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\ntmp |= (RADEON_PIX2CLK_ALWAYS_ONb |\r\nRADEON_PIX2CLK_DAC_ALWAYS_ONb |\r\nRADEON_PIXCLK_BLEND_ALWAYS_ONb |\r\nRADEON_PIXCLK_GV_ALWAYS_ONb |\r\nRADEON_PIXCLK_DIG_TMDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_LVDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_TMDS_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\r\nudelay(15000);\r\ntmp = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\r\ntmp |= (RADEON_PIXCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\r\nudelay(15000);\r\n}\r\n} else {\r\nif (rdev->flags & RADEON_SINGLE_CRTC) {\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp |= (RADEON_SCLK_FORCE_CP | RADEON_SCLK_FORCE_HDP |\r\nRADEON_SCLK_FORCE_DISP1 | RADEON_SCLK_FORCE_TOP\r\n| RADEON_SCLK_FORCE_E2 | RADEON_SCLK_FORCE_SE |\r\nRADEON_SCLK_FORCE_IDCT | RADEON_SCLK_FORCE_VIP |\r\nRADEON_SCLK_FORCE_RE | RADEON_SCLK_FORCE_PB |\r\nRADEON_SCLK_FORCE_TAM | RADEON_SCLK_FORCE_TDM |\r\nRADEON_SCLK_FORCE_RB);\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\n} else if ((rdev->family == CHIP_RS400) ||\r\n(rdev->family == CHIP_RS480)) {\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp |= (RADEON_SCLK_FORCE_DISP2 | RADEON_SCLK_FORCE_CP |\r\nRADEON_SCLK_FORCE_HDP | RADEON_SCLK_FORCE_DISP1\r\n| RADEON_SCLK_FORCE_TOP | RADEON_SCLK_FORCE_E2 |\r\nR300_SCLK_FORCE_VAP | RADEON_SCLK_FORCE_IDCT |\r\nRADEON_SCLK_FORCE_VIP | R300_SCLK_FORCE_SR |\r\nR300_SCLK_FORCE_PX | R300_SCLK_FORCE_TX |\r\nR300_SCLK_FORCE_US | RADEON_SCLK_FORCE_TV_SCLK |\r\nR300_SCLK_FORCE_SU | RADEON_SCLK_FORCE_OV0);\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_SCLK_MORE_CNTL);\r\ntmp |= RADEON_SCLK_MORE_FORCEON;\r\nWREG32_PLL(RADEON_SCLK_MORE_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\r\ntmp &= ~(RADEON_PIXCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_DAC_ALWAYS_ONb |\r\nR300_DISP_DAC_PIXCLK_DAC_BLANK_OFF);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\ntmp &= ~(RADEON_PIX2CLK_ALWAYS_ONb |\r\nRADEON_PIX2CLK_DAC_ALWAYS_ONb |\r\nRADEON_DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb |\r\nR300_DVOCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_BLEND_ALWAYS_ONb |\r\nRADEON_PIXCLK_GV_ALWAYS_ONb |\r\nR300_PIXCLK_DVO_ALWAYS_ONb |\r\nRADEON_PIXCLK_LVDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_TMDS_ALWAYS_ONb |\r\nR300_PIXCLK_TRANS_ALWAYS_ONb |\r\nR300_PIXCLK_TVO_ALWAYS_ONb |\r\nR300_P2G2CLK_ALWAYS_ONb |\r\nR300_P2G2CLK_DAC_ALWAYS_ONb |\r\nR300_DISP_DAC_PIXCLK_DAC2_BLANK_OFF);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\r\n} else if (rdev->family >= CHIP_RV350) {\r\ntmp = RREG32_PLL(R300_SCLK_CNTL2);\r\ntmp |= (R300_SCLK_FORCE_TCL |\r\nR300_SCLK_FORCE_GA | R300_SCLK_FORCE_CBA);\r\nWREG32_PLL(R300_SCLK_CNTL2, tmp);\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp |= (RADEON_SCLK_FORCE_DISP2 | RADEON_SCLK_FORCE_CP |\r\nRADEON_SCLK_FORCE_HDP | RADEON_SCLK_FORCE_DISP1\r\n| RADEON_SCLK_FORCE_TOP | RADEON_SCLK_FORCE_E2 |\r\nR300_SCLK_FORCE_VAP | RADEON_SCLK_FORCE_IDCT |\r\nRADEON_SCLK_FORCE_VIP | R300_SCLK_FORCE_SR |\r\nR300_SCLK_FORCE_PX | R300_SCLK_FORCE_TX |\r\nR300_SCLK_FORCE_US | RADEON_SCLK_FORCE_TV_SCLK |\r\nR300_SCLK_FORCE_SU | RADEON_SCLK_FORCE_OV0);\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_SCLK_MORE_CNTL);\r\ntmp |= RADEON_SCLK_MORE_FORCEON;\r\nWREG32_PLL(RADEON_SCLK_MORE_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_MCLK_CNTL);\r\ntmp |= (RADEON_FORCEON_MCLKA |\r\nRADEON_FORCEON_MCLKB |\r\nRADEON_FORCEON_YCLKA |\r\nRADEON_FORCEON_YCLKB | RADEON_FORCEON_MC);\r\nWREG32_PLL(RADEON_MCLK_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\r\ntmp &= ~(RADEON_PIXCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_DAC_ALWAYS_ONb |\r\nR300_DISP_DAC_PIXCLK_DAC_BLANK_OFF);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\r\ntmp = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\ntmp &= ~(RADEON_PIX2CLK_ALWAYS_ONb |\r\nRADEON_PIX2CLK_DAC_ALWAYS_ONb |\r\nRADEON_DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb |\r\nR300_DVOCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_BLEND_ALWAYS_ONb |\r\nRADEON_PIXCLK_GV_ALWAYS_ONb |\r\nR300_PIXCLK_DVO_ALWAYS_ONb |\r\nRADEON_PIXCLK_LVDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_TMDS_ALWAYS_ONb |\r\nR300_PIXCLK_TRANS_ALWAYS_ONb |\r\nR300_PIXCLK_TVO_ALWAYS_ONb |\r\nR300_P2G2CLK_ALWAYS_ONb |\r\nR300_P2G2CLK_DAC_ALWAYS_ONb |\r\nR300_DISP_DAC_PIXCLK_DAC2_BLANK_OFF);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\r\n} else {\r\ntmp = RREG32_PLL(RADEON_SCLK_CNTL);\r\ntmp |= (RADEON_SCLK_FORCE_CP | RADEON_SCLK_FORCE_E2);\r\ntmp |= RADEON_SCLK_FORCE_SE;\r\nif (rdev->flags & RADEON_SINGLE_CRTC) {\r\ntmp |= (RADEON_SCLK_FORCE_RB |\r\nRADEON_SCLK_FORCE_TDM |\r\nRADEON_SCLK_FORCE_TAM |\r\nRADEON_SCLK_FORCE_PB |\r\nRADEON_SCLK_FORCE_RE |\r\nRADEON_SCLK_FORCE_VIP |\r\nRADEON_SCLK_FORCE_IDCT |\r\nRADEON_SCLK_FORCE_TOP |\r\nRADEON_SCLK_FORCE_DISP1 |\r\nRADEON_SCLK_FORCE_DISP2 |\r\nRADEON_SCLK_FORCE_HDP);\r\n} else if ((rdev->family == CHIP_R300) ||\r\n(rdev->family == CHIP_R350)) {\r\ntmp |= (RADEON_SCLK_FORCE_HDP |\r\nRADEON_SCLK_FORCE_DISP1 |\r\nRADEON_SCLK_FORCE_DISP2 |\r\nRADEON_SCLK_FORCE_TOP |\r\nRADEON_SCLK_FORCE_IDCT |\r\nRADEON_SCLK_FORCE_VIP);\r\n}\r\nWREG32_PLL(RADEON_SCLK_CNTL, tmp);\r\nudelay(16000);\r\nif ((rdev->family == CHIP_R300) ||\r\n(rdev->family == CHIP_R350)) {\r\ntmp = RREG32_PLL(R300_SCLK_CNTL2);\r\ntmp |= (R300_SCLK_FORCE_TCL |\r\nR300_SCLK_FORCE_GA |\r\nR300_SCLK_FORCE_CBA);\r\nWREG32_PLL(R300_SCLK_CNTL2, tmp);\r\nudelay(16000);\r\n}\r\nif (rdev->flags & RADEON_IS_IGP) {\r\ntmp = RREG32_PLL(RADEON_MCLK_CNTL);\r\ntmp &= ~(RADEON_FORCEON_MCLKA |\r\nRADEON_FORCEON_YCLKA);\r\nWREG32_PLL(RADEON_MCLK_CNTL, tmp);\r\nudelay(16000);\r\n}\r\nif ((rdev->family == CHIP_RV200) ||\r\n(rdev->family == CHIP_RV250) ||\r\n(rdev->family == CHIP_RV280)) {\r\ntmp = RREG32_PLL(RADEON_SCLK_MORE_CNTL);\r\ntmp |= RADEON_SCLK_MORE_FORCEON;\r\nWREG32_PLL(RADEON_SCLK_MORE_CNTL, tmp);\r\nudelay(16000);\r\n}\r\ntmp = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\ntmp &= ~(RADEON_PIX2CLK_ALWAYS_ONb |\r\nRADEON_PIX2CLK_DAC_ALWAYS_ONb |\r\nRADEON_PIXCLK_BLEND_ALWAYS_ONb |\r\nRADEON_PIXCLK_GV_ALWAYS_ONb |\r\nRADEON_PIXCLK_DIG_TMDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_LVDS_ALWAYS_ONb |\r\nRADEON_PIXCLK_TMDS_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\r\nudelay(16000);\r\ntmp = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\r\ntmp &= ~(RADEON_PIXCLK_ALWAYS_ONb |\r\nRADEON_PIXCLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\r\n}\r\n}\r\n}

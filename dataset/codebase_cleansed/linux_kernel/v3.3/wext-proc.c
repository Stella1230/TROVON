static void wireless_seq_printf_stats(struct seq_file *seq,\r\nstruct net_device *dev)\r\n{\r\nstruct iw_statistics *stats = get_wireless_stats(dev);\r\nstatic struct iw_statistics nullstats = {};\r\nif (!stats) {\r\n#ifdef CONFIG_WIRELESS_EXT\r\nif (dev->wireless_handlers)\r\nstats = &nullstats;\r\n#endif\r\n#ifdef CONFIG_CFG80211\r\nif (dev->ieee80211_ptr)\r\nstats = &nullstats;\r\n#endif\r\n}\r\nif (stats) {\r\nseq_printf(seq, "%6s: %04x %3d%c %3d%c %3d%c %6d %6d %6d "\r\n"%6d %6d %6d\n",\r\ndev->name, stats->status, stats->qual.qual,\r\nstats->qual.updated & IW_QUAL_QUAL_UPDATED\r\n? '.' : ' ',\r\n((__s32) stats->qual.level) -\r\n((stats->qual.updated & IW_QUAL_DBM) ? 0x100 : 0),\r\nstats->qual.updated & IW_QUAL_LEVEL_UPDATED\r\n? '.' : ' ',\r\n((__s32) stats->qual.noise) -\r\n((stats->qual.updated & IW_QUAL_DBM) ? 0x100 : 0),\r\nstats->qual.updated & IW_QUAL_NOISE_UPDATED\r\n? '.' : ' ',\r\nstats->discard.nwid, stats->discard.code,\r\nstats->discard.fragment, stats->discard.retries,\r\nstats->discard.misc, stats->miss.beacon);\r\nif (stats != &nullstats)\r\nstats->qual.updated &= ~IW_QUAL_ALL_UPDATED;\r\n}\r\n}\r\nstatic int wireless_dev_seq_show(struct seq_file *seq, void *v)\r\n{\r\nmight_sleep();\r\nif (v == SEQ_START_TOKEN)\r\nseq_printf(seq, "Inter-| sta-| Quality | Discarded "\r\n"packets | Missed | WE\n"\r\n" face | tus | link level noise | nwid "\r\n"crypt frag retry misc | beacon | %d\n",\r\nWIRELESS_EXT);\r\nelse\r\nwireless_seq_printf_stats(seq, v);\r\nreturn 0;\r\n}\r\nstatic void *wireless_dev_seq_start(struct seq_file *seq, loff_t *pos)\r\n{\r\nstruct net *net = seq_file_net(seq);\r\nloff_t off;\r\nstruct net_device *dev;\r\nrtnl_lock();\r\nif (!*pos)\r\nreturn SEQ_START_TOKEN;\r\noff = 1;\r\nfor_each_netdev(net, dev)\r\nif (off++ == *pos)\r\nreturn dev;\r\nreturn NULL;\r\n}\r\nstatic void *wireless_dev_seq_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct net *net = seq_file_net(seq);\r\n++*pos;\r\nreturn v == SEQ_START_TOKEN ?\r\nfirst_net_device(net) : next_net_device(v);\r\n}\r\nstatic void wireless_dev_seq_stop(struct seq_file *seq, void *v)\r\n{\r\nrtnl_unlock();\r\n}\r\nstatic int seq_open_wireless(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open_net(inode, file, &wireless_seq_ops,\r\nsizeof(struct seq_net_private));\r\n}\r\nint __net_init wext_proc_init(struct net *net)\r\n{\r\nif (!proc_net_fops_create(net, "wireless", S_IRUGO, &wireless_seq_fops))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid __net_exit wext_proc_exit(struct net *net)\r\n{\r\nproc_net_remove(net, "wireless");\r\n}

unsigned char ec_read(unsigned short addr)\r\n{\r\nunsigned char value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&index_access_lock, flags);\r\noutb((addr & 0xff00) >> 8, EC_IO_PORT_HIGH);\r\noutb((addr & 0x00ff), EC_IO_PORT_LOW);\r\nvalue = inb(EC_IO_PORT_DATA);\r\nspin_unlock_irqrestore(&index_access_lock, flags);\r\nreturn value;\r\n}\r\nvoid ec_write(unsigned short addr, unsigned char val)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&index_access_lock, flags);\r\noutb((addr & 0xff00) >> 8, EC_IO_PORT_HIGH);\r\noutb((addr & 0x00ff), EC_IO_PORT_LOW);\r\noutb(val, EC_IO_PORT_DATA);\r\ninb(EC_IO_PORT_DATA);\r\nspin_unlock_irqrestore(&index_access_lock, flags);\r\n}\r\nint ec_query_seq(unsigned char cmd)\r\n{\r\nint timeout;\r\nunsigned char status;\r\nunsigned long flags;\r\nint ret = 0;\r\nspin_lock_irqsave(&port_access_lock, flags);\r\nudelay(EC_REG_DELAY);\r\noutb(cmd, EC_CMD_PORT);\r\nudelay(EC_REG_DELAY);\r\ntimeout = EC_CMD_TIMEOUT;\r\nstatus = inb(EC_STS_PORT);\r\nwhile (timeout-- && (status & (1 << 1))) {\r\nstatus = inb(EC_STS_PORT);\r\nudelay(EC_REG_DELAY);\r\n}\r\nspin_unlock_irqrestore(&port_access_lock, flags);\r\nif (timeout <= 0) {\r\nprintk(KERN_ERR "%s: deadable error : timeout...\n", __func__);\r\nret = -EINVAL;\r\n} else\r\nprintk(KERN_INFO\r\n"(%x/%d)ec issued command %d status : 0x%x\n",\r\ntimeout, EC_CMD_TIMEOUT - timeout, cmd, status);\r\nreturn ret;\r\n}\r\nint ec_query_event_num(void)\r\n{\r\nreturn ec_query_seq(CMD_GET_EVENT_NUM);\r\n}\r\nint ec_get_event_num(void)\r\n{\r\nint timeout = 100;\r\nunsigned char value;\r\nunsigned char status;\r\nudelay(EC_REG_DELAY);\r\nstatus = inb(EC_STS_PORT);\r\nudelay(EC_REG_DELAY);\r\nwhile (timeout-- && !(status & (1 << 0))) {\r\nstatus = inb(EC_STS_PORT);\r\nudelay(EC_REG_DELAY);\r\n}\r\nif (timeout <= 0) {\r\npr_info("%s: get event number timeout.\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nvalue = inb(EC_DAT_PORT);\r\nudelay(EC_REG_DELAY);\r\nreturn value;\r\n}

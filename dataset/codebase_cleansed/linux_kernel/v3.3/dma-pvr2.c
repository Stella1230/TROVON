static irqreturn_t pvr2_dma_interrupt(int irq, void *dev_id)\r\n{\r\nif (get_dma_residue(PVR2_CASCADE_CHAN)) {\r\nprintk(KERN_WARNING "DMA: SH DMAC did not complete transfer "\r\n"on channel %d, waiting..\n", PVR2_CASCADE_CHAN);\r\ndma_wait_for_completion(PVR2_CASCADE_CHAN);\r\n}\r\nif (count++ < 10)\r\npr_debug("Got a pvr2 dma interrupt for channel %d\n",\r\nirq - HW_EVENT_PVR2_DMA);\r\nxfer_complete = 1;\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pvr2_request_dma(struct dma_channel *chan)\r\n{\r\nif (__raw_readl(PVR2_DMA_MODE) != 0)\r\nreturn -EBUSY;\r\n__raw_writel(0, PVR2_DMA_LMMODE0);\r\nreturn 0;\r\n}\r\nstatic int pvr2_get_dma_residue(struct dma_channel *chan)\r\n{\r\nreturn xfer_complete == 0;\r\n}\r\nstatic int pvr2_xfer_dma(struct dma_channel *chan)\r\n{\r\nif (chan->sar || !chan->dar)\r\nreturn -EINVAL;\r\nxfer_complete = 0;\r\n__raw_writel(chan->dar, PVR2_DMA_ADDR);\r\n__raw_writel(chan->count, PVR2_DMA_COUNT);\r\n__raw_writel(chan->mode & DMA_MODE_MASK, PVR2_DMA_MODE);\r\nreturn 0;\r\n}\r\nstatic int __init pvr2_dma_init(void)\r\n{\r\nsetup_irq(HW_EVENT_PVR2_DMA, &pvr2_dma_irq);\r\nrequest_dma(PVR2_CASCADE_CHAN, "pvr2 cascade");\r\nreturn register_dmac(&pvr2_dma_info);\r\n}\r\nstatic void __exit pvr2_dma_exit(void)\r\n{\r\nfree_dma(PVR2_CASCADE_CHAN);\r\nfree_irq(HW_EVENT_PVR2_DMA, 0);\r\nunregister_dmac(&pvr2_dma_info);\r\n}

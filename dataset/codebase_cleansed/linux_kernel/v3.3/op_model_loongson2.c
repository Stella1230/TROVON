static void reset_counters(void *arg)\r\n{\r\nwrite_c0_perfctrl(0);\r\nwrite_c0_perfcnt(0);\r\n}\r\nstatic void loongson2_reg_setup(struct op_counter_config *cfg)\r\n{\r\nunsigned int ctrl = 0;\r\nreg.reset_counter1 = 0;\r\nreg.reset_counter2 = 0;\r\nif (cfg[0].enabled) {\r\nctrl |= LOONGSON2_PERFCTRL_EVENT(0, cfg[0].event);\r\nreg.reset_counter1 = 0x80000000ULL - cfg[0].count;\r\n}\r\nif (cfg[1].enabled) {\r\nctrl |= LOONGSON2_PERFCTRL_EVENT(1, cfg[1].event);\r\nreg.reset_counter2 = 0x80000000ULL - cfg[1].count;\r\n}\r\nif (cfg[0].enabled || cfg[1].enabled) {\r\nctrl |= LOONGSON2_PERFCTRL_EXL | LOONGSON2_PERFCTRL_ENABLE;\r\nif (cfg[0].kernel || cfg[1].kernel)\r\nctrl |= LOONGSON2_PERFCTRL_KERNEL;\r\nif (cfg[0].user || cfg[1].user)\r\nctrl |= LOONGSON2_PERFCTRL_USER;\r\n}\r\nreg.ctrl = ctrl;\r\nreg.cnt1_enabled = cfg[0].enabled;\r\nreg.cnt2_enabled = cfg[1].enabled;\r\n}\r\nstatic void loongson2_cpu_setup(void *args)\r\n{\r\nwrite_c0_perfcnt((reg.reset_counter2 << 32) | reg.reset_counter1);\r\n}\r\nstatic void loongson2_cpu_start(void *args)\r\n{\r\nif (reg.cnt1_enabled || reg.cnt2_enabled)\r\nwrite_c0_perfctrl(reg.ctrl);\r\n}\r\nstatic void loongson2_cpu_stop(void *args)\r\n{\r\nwrite_c0_perfctrl(0);\r\nmemset(&reg, 0, sizeof(reg));\r\n}\r\nstatic irqreturn_t loongson2_perfcount_handler(int irq, void *dev_id)\r\n{\r\nuint64_t counter, counter1, counter2;\r\nstruct pt_regs *regs = get_irq_regs();\r\nint enabled;\r\nenabled = read_c0_perfctrl() & LOONGSON2_PERFCTRL_ENABLE;\r\nif (!enabled)\r\nreturn IRQ_NONE;\r\nenabled = reg.cnt1_enabled | reg.cnt2_enabled;\r\nif (!enabled)\r\nreturn IRQ_NONE;\r\ncounter = read_c0_perfcnt();\r\ncounter1 = counter & 0xffffffff;\r\ncounter2 = counter >> 32;\r\nif (counter1 & LOONGSON2_PERFCNT_OVERFLOW) {\r\nif (reg.cnt1_enabled)\r\noprofile_add_sample(regs, 0);\r\ncounter1 = reg.reset_counter1;\r\n}\r\nif (counter2 & LOONGSON2_PERFCNT_OVERFLOW) {\r\nif (reg.cnt2_enabled)\r\noprofile_add_sample(regs, 1);\r\ncounter2 = reg.reset_counter2;\r\n}\r\nwrite_c0_perfcnt((counter2 << 32) | counter1);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init loongson2_init(void)\r\n{\r\nreturn request_irq(LOONGSON2_PERFCNT_IRQ, loongson2_perfcount_handler,\r\nIRQF_SHARED, "Perfcounter", oprofid);\r\n}\r\nstatic void loongson2_exit(void)\r\n{\r\nreset_counters(NULL);\r\nfree_irq(LOONGSON2_PERFCNT_IRQ, oprofid);\r\n}

int\r\nnouveau_ttm_mmap(struct file *filp, struct vm_area_struct *vma)\r\n{\r\nstruct drm_file *file_priv = filp->private_data;\r\nstruct drm_nouveau_private *dev_priv =\r\nfile_priv->minor->dev->dev_private;\r\nif (unlikely(vma->vm_pgoff < DRM_FILE_PAGE_OFFSET))\r\nreturn drm_mmap(filp, vma);\r\nreturn ttm_bo_mmap(filp, vma, &dev_priv->ttm.bdev);\r\n}\r\nstatic int\r\nnouveau_ttm_mem_global_init(struct drm_global_reference *ref)\r\n{\r\nreturn ttm_mem_global_init(ref->object);\r\n}\r\nstatic void\r\nnouveau_ttm_mem_global_release(struct drm_global_reference *ref)\r\n{\r\nttm_mem_global_release(ref->object);\r\n}\r\nint\r\nnouveau_ttm_global_init(struct drm_nouveau_private *dev_priv)\r\n{\r\nstruct drm_global_reference *global_ref;\r\nint ret;\r\nglobal_ref = &dev_priv->ttm.mem_global_ref;\r\nglobal_ref->global_type = DRM_GLOBAL_TTM_MEM;\r\nglobal_ref->size = sizeof(struct ttm_mem_global);\r\nglobal_ref->init = &nouveau_ttm_mem_global_init;\r\nglobal_ref->release = &nouveau_ttm_mem_global_release;\r\nret = drm_global_item_ref(global_ref);\r\nif (unlikely(ret != 0)) {\r\nDRM_ERROR("Failed setting up TTM memory accounting\n");\r\ndev_priv->ttm.mem_global_ref.release = NULL;\r\nreturn ret;\r\n}\r\ndev_priv->ttm.bo_global_ref.mem_glob = global_ref->object;\r\nglobal_ref = &dev_priv->ttm.bo_global_ref.ref;\r\nglobal_ref->global_type = DRM_GLOBAL_TTM_BO;\r\nglobal_ref->size = sizeof(struct ttm_bo_global);\r\nglobal_ref->init = &ttm_bo_global_init;\r\nglobal_ref->release = &ttm_bo_global_release;\r\nret = drm_global_item_ref(global_ref);\r\nif (unlikely(ret != 0)) {\r\nDRM_ERROR("Failed setting up TTM BO subsystem\n");\r\ndrm_global_item_unref(&dev_priv->ttm.mem_global_ref);\r\ndev_priv->ttm.mem_global_ref.release = NULL;\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nnouveau_ttm_global_release(struct drm_nouveau_private *dev_priv)\r\n{\r\nif (dev_priv->ttm.mem_global_ref.release == NULL)\r\nreturn;\r\ndrm_global_item_unref(&dev_priv->ttm.bo_global_ref.ref);\r\ndrm_global_item_unref(&dev_priv->ttm.mem_global_ref);\r\ndev_priv->ttm.mem_global_ref.release = NULL;\r\n}

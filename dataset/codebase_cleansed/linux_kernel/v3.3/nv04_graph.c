static struct nouveau_channel *\r\nnv04_graph_channel(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nint chid = dev_priv->engine.fifo.channels;\r\nif (nv_rd32(dev, NV04_PGRAPH_CTX_CONTROL) & 0x00010000)\r\nchid = nv_rd32(dev, NV04_PGRAPH_CTX_USER) >> 24;\r\nif (chid >= dev_priv->engine.fifo.channels)\r\nreturn NULL;\r\nreturn dev_priv->channels.ptr[chid];\r\n}\r\nstatic uint32_t *ctx_reg(struct graph_state *ctx, uint32_t reg)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(nv04_graph_ctx_regs); i++) {\r\nif (nv04_graph_ctx_regs[i] == reg)\r\nreturn &ctx->nv04[i];\r\n}\r\nreturn NULL;\r\n}\r\nstatic int\r\nnv04_graph_load_context(struct nouveau_channel *chan)\r\n{\r\nstruct graph_state *pgraph_ctx = chan->engctx[NVOBJ_ENGINE_GR];\r\nstruct drm_device *dev = chan->dev;\r\nuint32_t tmp;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(nv04_graph_ctx_regs); i++)\r\nnv_wr32(dev, nv04_graph_ctx_regs[i], pgraph_ctx->nv04[i]);\r\nnv_wr32(dev, NV04_PGRAPH_CTX_CONTROL, 0x10010100);\r\ntmp = nv_rd32(dev, NV04_PGRAPH_CTX_USER) & 0x00ffffff;\r\nnv_wr32(dev, NV04_PGRAPH_CTX_USER, tmp | chan->id << 24);\r\ntmp = nv_rd32(dev, NV04_PGRAPH_FFINTFC_ST2);\r\nnv_wr32(dev, NV04_PGRAPH_FFINTFC_ST2, tmp & 0x000fffff);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_graph_unload_context(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *chan = NULL;\r\nstruct graph_state *ctx;\r\nuint32_t tmp;\r\nint i;\r\nchan = nv04_graph_channel(dev);\r\nif (!chan)\r\nreturn 0;\r\nctx = chan->engctx[NVOBJ_ENGINE_GR];\r\nfor (i = 0; i < ARRAY_SIZE(nv04_graph_ctx_regs); i++)\r\nctx->nv04[i] = nv_rd32(dev, nv04_graph_ctx_regs[i]);\r\nnv_wr32(dev, NV04_PGRAPH_CTX_CONTROL, 0x10000000);\r\ntmp = nv_rd32(dev, NV04_PGRAPH_CTX_USER) & 0x00ffffff;\r\ntmp |= (dev_priv->engine.fifo.channels - 1) << 24;\r\nnv_wr32(dev, NV04_PGRAPH_CTX_USER, tmp);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_graph_context_new(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct graph_state *pgraph_ctx;\r\nNV_DEBUG(chan->dev, "nv04_graph_context_create %d\n", chan->id);\r\npgraph_ctx = kzalloc(sizeof(*pgraph_ctx), GFP_KERNEL);\r\nif (pgraph_ctx == NULL)\r\nreturn -ENOMEM;\r\n*ctx_reg(pgraph_ctx, NV04_PGRAPH_DEBUG_3) = 0xfad4ff31;\r\nchan->engctx[engine] = pgraph_ctx;\r\nreturn 0;\r\n}\r\nstatic void\r\nnv04_graph_context_del(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct graph_state *pgraph_ctx = chan->engctx[engine];\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000000);\r\nif (nv04_graph_channel(dev) == chan)\r\nnv04_graph_unload_context(dev);\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000001);\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\nkfree(pgraph_ctx);\r\nchan->engctx[engine] = NULL;\r\n}\r\nint\r\nnv04_graph_object_new(struct nouveau_channel *chan, int engine,\r\nu32 handle, u16 class)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct nouveau_gpuobj *obj = NULL;\r\nint ret;\r\nret = nouveau_gpuobj_new(dev, chan, 16, 16, NVOBJ_FLAG_ZERO_FREE, &obj);\r\nif (ret)\r\nreturn ret;\r\nobj->engine = 1;\r\nobj->class = class;\r\n#ifdef __BIG_ENDIAN\r\nnv_wo32(obj, 0x00, 0x00080000 | class);\r\n#else\r\nnv_wo32(obj, 0x00, class);\r\n#endif\r\nnv_wo32(obj, 0x04, 0x00000000);\r\nnv_wo32(obj, 0x08, 0x00000000);\r\nnv_wo32(obj, 0x0c, 0x00000000);\r\nret = nouveau_ramht_insert(chan, handle, obj);\r\nnouveau_gpuobj_ref(NULL, &obj);\r\nreturn ret;\r\n}\r\nstatic int\r\nnv04_graph_init(struct drm_device *dev, int engine)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nuint32_t tmp;\r\nnv_wr32(dev, NV03_PMC_ENABLE, nv_rd32(dev, NV03_PMC_ENABLE) &\r\n~NV_PMC_ENABLE_PGRAPH);\r\nnv_wr32(dev, NV03_PMC_ENABLE, nv_rd32(dev, NV03_PMC_ENABLE) |\r\nNV_PMC_ENABLE_PGRAPH);\r\nnv_wr32(dev, NV03_PGRAPH_INTR, 0xFFFFFFFF);\r\nnv_wr32(dev, NV03_PGRAPH_INTR_EN, 0xFFFFFFFF);\r\nnv_wr32(dev, NV04_PGRAPH_VALID1, 0);\r\nnv_wr32(dev, NV04_PGRAPH_VALID2, 0);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_0, 0x1231c000);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_1, 0x72111100);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_2, 0x11d5f071);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_3, 0xf0d4ff31);\r\nnv_wr32(dev, NV04_PGRAPH_STATE , 0xFFFFFFFF);\r\nnv_wr32(dev, NV04_PGRAPH_CTX_CONTROL , 0x10000100);\r\ntmp = nv_rd32(dev, NV04_PGRAPH_CTX_USER) & 0x00ffffff;\r\ntmp |= (dev_priv->engine.fifo.channels - 1) << 24;\r\nnv_wr32(dev, NV04_PGRAPH_CTX_USER, tmp);\r\nnv_wr32(dev, NV04_PGRAPH_PATTERN_SHAPE, 0x00000000);\r\nnv_wr32(dev, NV04_PGRAPH_BETA_AND , 0xFFFFFFFF);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_graph_fini(struct drm_device *dev, int engine, bool suspend)\r\n{\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000000);\r\nif (!nv_wait(dev, NV04_PGRAPH_STATUS, ~0, 0) && suspend) {\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000001);\r\nreturn -EBUSY;\r\n}\r\nnv04_graph_unload_context(dev);\r\nnv_wr32(dev, NV03_PGRAPH_INTR_EN, 0x00000000);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_graph_mthd_set_ref(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\natomic_set(&chan->fence.last_sequence_irq, data);\r\nreturn 0;\r\n}\r\nint\r\nnv04_graph_mthd_page_flip(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct nouveau_page_flip_state s;\r\nif (!nouveau_finish_page_flip(chan, &s))\r\nnv_set_crtc_base(dev, s.crtc,\r\ns.offset + s.y * s.pitch + s.x * s.bpp / 8);\r\nreturn 0;\r\n}\r\nstatic void\r\nnv04_graph_set_ctx1(struct nouveau_channel *chan, u32 mask, u32 value)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nu32 instance = (nv_rd32(dev, NV04_PGRAPH_CTX_SWITCH4) & 0xffff) << 4;\r\nint subc = (nv_rd32(dev, NV04_PGRAPH_TRAPPED_ADDR) >> 13) & 0x7;\r\nu32 tmp;\r\ntmp = nv_ri32(dev, instance);\r\ntmp &= ~mask;\r\ntmp |= value;\r\nnv_wi32(dev, instance, tmp);\r\nnv_wr32(dev, NV04_PGRAPH_CTX_SWITCH1, tmp);\r\nnv_wr32(dev, NV04_PGRAPH_CTX_CACHE1 + (subc<<2), tmp);\r\n}\r\nstatic void\r\nnv04_graph_set_ctx_val(struct nouveau_channel *chan, u32 mask, u32 value)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nu32 instance = (nv_rd32(dev, NV04_PGRAPH_CTX_SWITCH4) & 0xffff) << 4;\r\nu32 tmp, ctx1;\r\nint class, op, valid = 1;\r\nctx1 = nv_ri32(dev, instance);\r\nclass = ctx1 & 0xff;\r\nop = (ctx1 >> 15) & 7;\r\ntmp = nv_ri32(dev, instance + 0xc);\r\ntmp &= ~mask;\r\ntmp |= value;\r\nnv_wi32(dev, instance + 0xc, tmp);\r\nif (!(tmp & 0x02000000))\r\nvalid = 0;\r\nif ((class == 0x1f || class == 0x48) && !(tmp & 0x04000000))\r\nvalid = 0;\r\nswitch (op) {\r\ncase 0:\r\ncase 3:\r\nbreak;\r\ncase 1:\r\nif (!(tmp & 0x18000000))\r\nvalid = 0;\r\nbreak;\r\ncase 2:\r\nif (!(tmp & 0x20000000))\r\nvalid = 0;\r\nbreak;\r\ncase 4:\r\ncase 5:\r\nif (!(tmp & 0x40000000))\r\nvalid = 0;\r\nbreak;\r\n}\r\nnv04_graph_set_ctx1(chan, 0x01000000, valid << 24);\r\n}\r\nstatic int\r\nnv04_graph_mthd_set_operation(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nif (data > 5)\r\nreturn 1;\r\nif (data > 2 && class < 0x40)\r\nreturn 1;\r\nnv04_graph_set_ctx1(chan, 0x00038000, data << 15);\r\nnv04_graph_set_ctx_val(chan, 0, 0);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_graph_mthd_surf3d_clip_h(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nuint32_t min = data & 0xffff, max;\r\nuint32_t w = data >> 16;\r\nif (min & 0x8000)\r\nreturn 1;\r\nif (w & 0x8000)\r\nw |= 0xffff0000;\r\nmax = min + w;\r\nmax &= 0x3ffff;\r\nnv_wr32(chan->dev, 0x40053c, min);\r\nnv_wr32(chan->dev, 0x400544, max);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_graph_mthd_surf3d_clip_v(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nuint32_t min = data & 0xffff, max;\r\nuint32_t w = data >> 16;\r\nif (min & 0x8000)\r\nreturn 1;\r\nif (w & 0x8000)\r\nw |= 0xffff0000;\r\nmax = min + w;\r\nmax &= 0x3ffff;\r\nnv_wr32(chan->dev, 0x400540, min);\r\nnv_wr32(chan->dev, 0x400548, max);\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_surf2d(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx1(chan, 0x00004000, 0);\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0);\r\nreturn 0;\r\ncase 0x42:\r\nnv04_graph_set_ctx1(chan, 0x00004000, 0);\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0x02000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_surf2d_swzsurf(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx1(chan, 0x00004000, 0);\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0);\r\nreturn 0;\r\ncase 0x42:\r\nnv04_graph_set_ctx1(chan, 0x00004000, 0);\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0x02000000);\r\nreturn 0;\r\ncase 0x52:\r\nnv04_graph_set_ctx1(chan, 0x00004000, 0x00004000);\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0x02000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_nv01_patt(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x08000000, 0);\r\nreturn 0;\r\ncase 0x18:\r\nnv04_graph_set_ctx_val(chan, 0x08000000, 0x08000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_nv04_patt(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x08000000, 0);\r\nreturn 0;\r\ncase 0x44:\r\nnv04_graph_set_ctx_val(chan, 0x08000000, 0x08000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_rop(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x10000000, 0);\r\nreturn 0;\r\ncase 0x43:\r\nnv04_graph_set_ctx_val(chan, 0x10000000, 0x10000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_beta1(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x20000000, 0);\r\nreturn 0;\r\ncase 0x12:\r\nnv04_graph_set_ctx_val(chan, 0x20000000, 0x20000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_beta4(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x40000000, 0);\r\nreturn 0;\r\ncase 0x72:\r\nnv04_graph_set_ctx_val(chan, 0x40000000, 0x40000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_surf_dst(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0);\r\nreturn 0;\r\ncase 0x58:\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0x02000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_surf_src(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x04000000, 0);\r\nreturn 0;\r\ncase 0x59:\r\nnv04_graph_set_ctx_val(chan, 0x04000000, 0x04000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_surf_color(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0);\r\nreturn 0;\r\ncase 0x5a:\r\nnv04_graph_set_ctx_val(chan, 0x02000000, 0x02000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_surf_zeta(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx_val(chan, 0x04000000, 0);\r\nreturn 0;\r\ncase 0x5b:\r\nnv04_graph_set_ctx_val(chan, 0x04000000, 0x04000000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_clip(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx1(chan, 0x2000, 0);\r\nreturn 0;\r\ncase 0x19:\r\nnv04_graph_set_ctx1(chan, 0x2000, 0x2000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nnv04_graph_mthd_bind_chroma(struct nouveau_channel *chan,\r\nu32 class, u32 mthd, u32 data)\r\n{\r\nswitch (nv_ri32(chan->dev, data << 4) & 0xff) {\r\ncase 0x30:\r\nnv04_graph_set_ctx1(chan, 0x1000, 0);\r\nreturn 0;\r\ncase 0x57:\r\nnv04_graph_set_ctx1(chan, 0x1000, 0x1000);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\nnv04_graph_context_switch(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *chan = NULL;\r\nint chid;\r\nnouveau_wait_for_idle(dev);\r\nnv04_graph_unload_context(dev);\r\nchid = dev_priv->engine.fifo.channel_id(dev);\r\nchan = dev_priv->channels.ptr[chid];\r\nif (chan)\r\nnv04_graph_load_context(chan);\r\n}\r\nstatic void\r\nnv04_graph_isr(struct drm_device *dev)\r\n{\r\nu32 stat;\r\nwhile ((stat = nv_rd32(dev, NV03_PGRAPH_INTR))) {\r\nu32 nsource = nv_rd32(dev, NV03_PGRAPH_NSOURCE);\r\nu32 nstatus = nv_rd32(dev, NV03_PGRAPH_NSTATUS);\r\nu32 addr = nv_rd32(dev, NV04_PGRAPH_TRAPPED_ADDR);\r\nu32 chid = (addr & 0x0f000000) >> 24;\r\nu32 subc = (addr & 0x0000e000) >> 13;\r\nu32 mthd = (addr & 0x00001ffc);\r\nu32 data = nv_rd32(dev, NV04_PGRAPH_TRAPPED_DATA);\r\nu32 class = nv_rd32(dev, 0x400180 + subc * 4) & 0xff;\r\nu32 show = stat;\r\nif (stat & NV_PGRAPH_INTR_NOTIFY) {\r\nif (nsource & NV03_PGRAPH_NSOURCE_ILLEGAL_MTHD) {\r\nif (!nouveau_gpuobj_mthd_call2(dev, chid, class, mthd, data))\r\nshow &= ~NV_PGRAPH_INTR_NOTIFY;\r\n}\r\n}\r\nif (stat & NV_PGRAPH_INTR_CONTEXT_SWITCH) {\r\nnv_wr32(dev, NV03_PGRAPH_INTR, NV_PGRAPH_INTR_CONTEXT_SWITCH);\r\nstat &= ~NV_PGRAPH_INTR_CONTEXT_SWITCH;\r\nshow &= ~NV_PGRAPH_INTR_CONTEXT_SWITCH;\r\nnv04_graph_context_switch(dev);\r\n}\r\nnv_wr32(dev, NV03_PGRAPH_INTR, stat);\r\nnv_wr32(dev, NV04_PGRAPH_FIFO, 0x00000001);\r\nif (show && nouveau_ratelimit()) {\r\nNV_INFO(dev, "PGRAPH -");\r\nnouveau_bitfield_print(nv04_graph_intr, show);\r\nprintk(" nsource:");\r\nnouveau_bitfield_print(nv04_graph_nsource, nsource);\r\nprintk(" nstatus:");\r\nnouveau_bitfield_print(nv04_graph_nstatus, nstatus);\r\nprintk("\n");\r\nNV_INFO(dev, "PGRAPH - ch %d/%d class 0x%04x "\r\n"mthd 0x%04x data 0x%08x\n",\r\nchid, subc, class, mthd, data);\r\n}\r\n}\r\n}\r\nstatic void\r\nnv04_graph_destroy(struct drm_device *dev, int engine)\r\n{\r\nstruct nv04_graph_engine *pgraph = nv_engine(dev, engine);\r\nnouveau_irq_unregister(dev, 12);\r\nNVOBJ_ENGINE_DEL(dev, GR);\r\nkfree(pgraph);\r\n}\r\nint\r\nnv04_graph_create(struct drm_device *dev)\r\n{\r\nstruct nv04_graph_engine *pgraph;\r\npgraph = kzalloc(sizeof(*pgraph), GFP_KERNEL);\r\nif (!pgraph)\r\nreturn -ENOMEM;\r\npgraph->base.destroy = nv04_graph_destroy;\r\npgraph->base.init = nv04_graph_init;\r\npgraph->base.fini = nv04_graph_fini;\r\npgraph->base.context_new = nv04_graph_context_new;\r\npgraph->base.context_del = nv04_graph_context_del;\r\npgraph->base.object_new = nv04_graph_object_new;\r\nNVOBJ_ENGINE_ADD(dev, GR, &pgraph->base);\r\nnouveau_irq_register(dev, 12, nv04_graph_isr);\r\nNVOBJ_CLASS(dev, 0x0038, GR);\r\nNVOBJ_CLASS(dev, 0x0039, GR);\r\nNVOBJ_CLASS(dev, 0x004b, GR);\r\nNVOBJ_MTHD (dev, 0x004b, 0x0184, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x004b, 0x0188, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x004b, 0x018c, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x004b, 0x0190, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x004b, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x004a, GR);\r\nNVOBJ_MTHD (dev, 0x004a, 0x0188, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x004a, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x004a, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x004a, 0x0194, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x004a, 0x0198, nv04_graph_mthd_bind_surf2d);\r\nNVOBJ_MTHD (dev, 0x004a, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x001f, GR);\r\nNVOBJ_MTHD (dev, 0x001f, 0x0184, nv04_graph_mthd_bind_chroma);\r\nNVOBJ_MTHD (dev, 0x001f, 0x0188, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x001f, 0x018c, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x001f, 0x0190, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x001f, 0x0194, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x001f, 0x0198, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x001f, 0x019c, nv04_graph_mthd_bind_surf_src);\r\nNVOBJ_MTHD (dev, 0x001f, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x005f, GR);\r\nNVOBJ_MTHD (dev, 0x005f, 0x0184, nv04_graph_mthd_bind_chroma);\r\nNVOBJ_MTHD (dev, 0x005f, 0x0188, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x005f, 0x018c, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x005f, 0x0190, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x005f, 0x0194, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x005f, 0x0198, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x005f, 0x019c, nv04_graph_mthd_bind_surf2d);\r\nNVOBJ_MTHD (dev, 0x005f, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0060, GR);\r\nNVOBJ_MTHD (dev, 0x0060, 0x0188, nv04_graph_mthd_bind_chroma);\r\nNVOBJ_MTHD (dev, 0x0060, 0x018c, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x0060, 0x0190, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x0060, 0x0194, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x0060, 0x0198, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x0060, 0x019c, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x0060, 0x01a0, nv04_graph_mthd_bind_surf2d_swzsurf);\r\nNVOBJ_MTHD (dev, 0x0060, 0x03e4, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0064, GR);\r\nNVOBJ_CLASS(dev, 0x0021, GR);\r\nNVOBJ_MTHD (dev, 0x0021, 0x0184, nv04_graph_mthd_bind_chroma);\r\nNVOBJ_MTHD (dev, 0x0021, 0x0188, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x0021, 0x018c, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x0021, 0x0190, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x0021, 0x0194, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x0021, 0x0198, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x0021, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0061, GR);\r\nNVOBJ_MTHD (dev, 0x0061, 0x0184, nv04_graph_mthd_bind_chroma);\r\nNVOBJ_MTHD (dev, 0x0061, 0x0188, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x0061, 0x018c, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x0061, 0x0190, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x0061, 0x0194, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x0061, 0x0198, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x0061, 0x019c, nv04_graph_mthd_bind_surf2d);\r\nNVOBJ_MTHD (dev, 0x0061, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0065, GR);\r\nNVOBJ_CLASS(dev, 0x0036, GR);\r\nNVOBJ_MTHD (dev, 0x0036, 0x0184, nv04_graph_mthd_bind_chroma);\r\nNVOBJ_MTHD (dev, 0x0036, 0x0188, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x0036, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x0036, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x0036, 0x0194, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x0036, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0076, GR);\r\nNVOBJ_MTHD (dev, 0x0076, 0x0184, nv04_graph_mthd_bind_chroma);\r\nNVOBJ_MTHD (dev, 0x0076, 0x0188, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x0076, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x0076, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x0076, 0x0194, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x0076, 0x0198, nv04_graph_mthd_bind_surf2d);\r\nNVOBJ_MTHD (dev, 0x0076, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0066, GR);\r\nNVOBJ_CLASS(dev, 0x0037, GR);\r\nNVOBJ_MTHD (dev, 0x0037, 0x0188, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x0037, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x0037, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x0037, 0x0194, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x0037, 0x0304, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0077, GR);\r\nNVOBJ_MTHD (dev, 0x0077, 0x0188, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x0077, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x0077, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x0077, 0x0194, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x0077, 0x0198, nv04_graph_mthd_bind_surf2d_swzsurf);\r\nNVOBJ_MTHD (dev, 0x0077, 0x0304, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x0030, GR);\r\nNVOBJ_CLASS(dev, 0x0042, GR);\r\nNVOBJ_CLASS(dev, 0x0043, GR);\r\nNVOBJ_CLASS(dev, 0x0012, GR);\r\nNVOBJ_CLASS(dev, 0x0072, GR);\r\nNVOBJ_CLASS(dev, 0x0019, GR);\r\nNVOBJ_CLASS(dev, 0x0018, GR);\r\nNVOBJ_CLASS(dev, 0x0044, GR);\r\nNVOBJ_CLASS(dev, 0x0052, GR);\r\nNVOBJ_CLASS(dev, 0x0053, GR);\r\nNVOBJ_MTHD (dev, 0x0053, 0x02f8, nv04_graph_mthd_surf3d_clip_h);\r\nNVOBJ_MTHD (dev, 0x0053, 0x02fc, nv04_graph_mthd_surf3d_clip_v);\r\nNVOBJ_CLASS(dev, 0x0048, GR);\r\nNVOBJ_MTHD (dev, 0x0048, 0x0188, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x0048, 0x018c, nv04_graph_mthd_bind_surf_color);\r\nNVOBJ_MTHD (dev, 0x0048, 0x0190, nv04_graph_mthd_bind_surf_zeta);\r\nNVOBJ_CLASS(dev, 0x0054, GR);\r\nNVOBJ_CLASS(dev, 0x0055, GR);\r\nNVOBJ_CLASS(dev, 0x0017, GR);\r\nNVOBJ_CLASS(dev, 0x0057, GR);\r\nNVOBJ_CLASS(dev, 0x0058, GR);\r\nNVOBJ_CLASS(dev, 0x0059, GR);\r\nNVOBJ_CLASS(dev, 0x005a, GR);\r\nNVOBJ_CLASS(dev, 0x005b, GR);\r\nNVOBJ_CLASS(dev, 0x001c, GR);\r\nNVOBJ_MTHD (dev, 0x001c, 0x0184, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x001c, 0x0188, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x001c, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x001c, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x001c, 0x0194, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x001c, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x005c, GR);\r\nNVOBJ_MTHD (dev, 0x005c, 0x0184, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x005c, 0x0188, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x005c, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x005c, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x005c, 0x0194, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x005c, 0x0198, nv04_graph_mthd_bind_surf2d);\r\nNVOBJ_MTHD (dev, 0x005c, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x001d, GR);\r\nNVOBJ_MTHD (dev, 0x001d, 0x0184, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x001d, 0x0188, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x001d, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x001d, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x001d, 0x0194, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x001d, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x005d, GR);\r\nNVOBJ_MTHD (dev, 0x005d, 0x0184, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x005d, 0x0188, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x005d, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x005d, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x005d, 0x0194, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x005d, 0x0198, nv04_graph_mthd_bind_surf2d);\r\nNVOBJ_MTHD (dev, 0x005d, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x001e, GR);\r\nNVOBJ_MTHD (dev, 0x001e, 0x0184, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x001e, 0x0188, nv04_graph_mthd_bind_nv01_patt);\r\nNVOBJ_MTHD (dev, 0x001e, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x001e, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x001e, 0x0194, nv04_graph_mthd_bind_surf_dst);\r\nNVOBJ_MTHD (dev, 0x001e, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x005e, GR);\r\nNVOBJ_MTHD (dev, 0x005e, 0x0184, nv04_graph_mthd_bind_clip);\r\nNVOBJ_MTHD (dev, 0x005e, 0x0188, nv04_graph_mthd_bind_nv04_patt);\r\nNVOBJ_MTHD (dev, 0x005e, 0x018c, nv04_graph_mthd_bind_rop);\r\nNVOBJ_MTHD (dev, 0x005e, 0x0190, nv04_graph_mthd_bind_beta1);\r\nNVOBJ_MTHD (dev, 0x005e, 0x0194, nv04_graph_mthd_bind_beta4);\r\nNVOBJ_MTHD (dev, 0x005e, 0x0198, nv04_graph_mthd_bind_surf2d);\r\nNVOBJ_MTHD (dev, 0x005e, 0x02fc, nv04_graph_mthd_set_operation);\r\nNVOBJ_CLASS(dev, 0x506e, SW);\r\nNVOBJ_MTHD (dev, 0x506e, 0x0150, nv04_graph_mthd_set_ref);\r\nNVOBJ_MTHD (dev, 0x506e, 0x0500, nv04_graph_mthd_page_flip);\r\nreturn 0;\r\n}

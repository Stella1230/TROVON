static int artop62x0_pre_reset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstatic const struct pci_bits artop_enable_bits[] = {\r\n{ 0x4AU, 1U, 0x02UL, 0x02UL },\r\n{ 0x4AU, 1U, 0x04UL, 0x04UL },\r\n};\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nif ((pdev->device & 1) &&\r\n!pci_test_config_bits(pdev, &artop_enable_bits[ap->port_no]))\r\nreturn -ENOENT;\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic int artop6260_cable_detect(struct ata_port *ap)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu8 tmp;\r\npci_read_config_byte(pdev, 0x49, &tmp);\r\nif (tmp & (1 << ap->port_no))\r\nreturn ATA_CBL_PATA40;\r\nreturn ATA_CBL_PATA80;\r\n}\r\nstatic void artop6210_load_piomode(struct ata_port *ap, struct ata_device *adev, unsigned int pio)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dn = adev->devno + 2 * ap->port_no;\r\nconst u16 timing[2][5] = {\r\n{ 0x0000, 0x000A, 0x0008, 0x0303, 0x0301 },\r\n{ 0x0700, 0x070A, 0x0708, 0x0403, 0x0401 }\r\n};\r\npci_write_config_word(pdev, 0x40 + 2 * dn, timing[clock][pio]);\r\n}\r\nstatic void artop6210_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dn = adev->devno + 2 * ap->port_no;\r\nu8 ultra;\r\nartop6210_load_piomode(ap, adev, adev->pio_mode - XFER_PIO_0);\r\npci_read_config_byte(pdev, 0x54, &ultra);\r\nultra &= ~(3 << (2 * dn));\r\npci_write_config_byte(pdev, 0x54, ultra);\r\n}\r\nstatic void artop6260_load_piomode (struct ata_port *ap, struct ata_device *adev, unsigned int pio)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dn = adev->devno + 2 * ap->port_no;\r\nconst u8 timing[2][5] = {\r\n{ 0x00, 0x0A, 0x08, 0x33, 0x31 },\r\n{ 0x70, 0x7A, 0x78, 0x43, 0x41 }\r\n};\r\npci_write_config_byte(pdev, 0x40 + dn, timing[clock][pio]);\r\n}\r\nstatic void artop6260_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu8 ultra;\r\nartop6260_load_piomode(ap, adev, adev->pio_mode - XFER_PIO_0);\r\npci_read_config_byte(pdev, 0x44 + ap->port_no, &ultra);\r\nultra &= ~(7 << (4 * adev->devno));\r\npci_write_config_byte(pdev, 0x44 + ap->port_no, ultra);\r\n}\r\nstatic void artop6210_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nunsigned int pio;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dn = adev->devno + 2 * ap->port_no;\r\nu8 ultra;\r\nif (adev->dma_mode == XFER_MW_DMA_0)\r\npio = 1;\r\nelse\r\npio = 4;\r\nartop6210_load_piomode(ap, adev, pio);\r\npci_read_config_byte(pdev, 0x54, &ultra);\r\nultra &= ~(3 << (2 * dn));\r\nif (adev->dma_mode >= XFER_UDMA_0) {\r\nu8 mode = (adev->dma_mode - XFER_UDMA_0) + 1 - clock;\r\nif (mode == 0)\r\nmode = 1;\r\nultra |= (mode << (2 * dn));\r\n}\r\npci_write_config_byte(pdev, 0x54, ultra);\r\n}\r\nstatic void artop6260_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nunsigned int pio = adev->pio_mode - XFER_PIO_0;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu8 ultra;\r\nif (adev->dma_mode == XFER_MW_DMA_0)\r\npio = 1;\r\nelse\r\npio = 4;\r\nartop6260_load_piomode(ap, adev, pio);\r\npci_read_config_byte(pdev, 0x44 + ap->port_no, &ultra);\r\nultra &= ~(7 << (4 * adev->devno));\r\nif (adev->dma_mode >= XFER_UDMA_0) {\r\nu8 mode = adev->dma_mode - XFER_UDMA_0 + 1 - clock;\r\nif (mode == 0)\r\nmode = 1;\r\nultra |= (mode << (4 * adev->devno));\r\n}\r\npci_write_config_byte(pdev, 0x44 + ap->port_no, ultra);\r\n}\r\nstatic int artop6210_qc_defer(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_host *host = qc->ap->host;\r\nstruct ata_port *alt = host->ports[1 ^ qc->ap->port_no];\r\nint rc;\r\nrc = ata_std_qc_defer(qc);\r\nif (rc != 0)\r\nreturn rc;\r\nif (alt && alt->qc_active)\r\nreturn ATA_DEFER_PORT;\r\nreturn 0;\r\n}\r\nstatic void atp8xx_fixup(struct pci_dev *pdev)\r\n{\r\nif (pdev->device == 0x0005)\r\npci_write_config_byte(pdev, 0x54, 0);\r\nelse if (pdev->device == 0x0008 || pdev->device == 0x0009) {\r\nu8 reg;\r\npci_read_config_byte(pdev, 0x49, &reg);\r\npci_write_config_byte(pdev, 0x49, reg & ~0x30);\r\npci_read_config_byte(pdev, PCI_LATENCY_TIMER, &reg);\r\nif (reg <= 0x80)\r\npci_write_config_byte(pdev, PCI_LATENCY_TIMER, 0x90);\r\npci_read_config_byte(pdev, 0x4a, &reg);\r\npci_write_config_byte(pdev, 0x4a, (reg & ~0x01) | 0x80);\r\n}\r\n}\r\nstatic int artop_init_one (struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info_6210 = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA2,\r\n.port_ops = &artop6210_ops,\r\n};\r\nstatic const struct ata_port_info info_626x = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA4,\r\n.port_ops = &artop6260_ops,\r\n};\r\nstatic const struct ata_port_info info_628x = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA5,\r\n.port_ops = &artop6260_ops,\r\n};\r\nstatic const struct ata_port_info info_628x_fast = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA6,\r\n.port_ops = &artop6260_ops,\r\n};\r\nconst struct ata_port_info *ppi[] = { NULL, NULL };\r\nint rc;\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nif (id->driver_data == 0)\r\nppi[0] = &info_6210;\r\nelse if (id->driver_data == 1)\r\nppi[0] = &info_626x;\r\nelse if (id->driver_data == 2) {\r\nunsigned long io = pci_resource_start(pdev, 4);\r\nppi[0] = &info_628x;\r\nif (inb(io) & 0x10)\r\nppi[0] = &info_628x_fast;\r\n}\r\nBUG_ON(ppi[0] == NULL);\r\natp8xx_fixup(pdev);\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &artop_sht, NULL, 0);\r\n}\r\nstatic int atp8xx_reinit_one(struct pci_dev *pdev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&pdev->dev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(pdev);\r\nif (rc)\r\nreturn rc;\r\natp8xx_fixup(pdev);\r\nata_host_resume(host);\r\nreturn 0;\r\n}\r\nstatic int __init artop_init(void)\r\n{\r\nreturn pci_register_driver(&artop_pci_driver);\r\n}\r\nstatic void __exit artop_exit(void)\r\n{\r\npci_unregister_driver(&artop_pci_driver);\r\n}

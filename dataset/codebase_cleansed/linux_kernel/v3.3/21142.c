void t21142_media_task(struct work_struct *work)\r\n{\r\nstruct tulip_private *tp =\r\ncontainer_of(work, struct tulip_private, media_work);\r\nstruct net_device *dev = tp->dev;\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint csr12 = ioread32(ioaddr + CSR12);\r\nint next_tick = 60*HZ;\r\nint new_csr6 = 0;\r\nint csr14 = ioread32(ioaddr + CSR14);\r\nif ((csr14 & 0x80) && (csr12 & 0x7000) != 0x5000)\r\ncsr12 |= 6;\r\nif (tulip_debug > 2)\r\ndev_info(&dev->dev, "21143 negotiation status %08x, %s\n",\r\ncsr12, medianame[dev->if_port]);\r\nif (tulip_media_cap[dev->if_port] & MediaIsMII) {\r\nif (tulip_check_duplex(dev) < 0) {\r\nnetif_carrier_off(dev);\r\nnext_tick = 3*HZ;\r\n} else {\r\nnetif_carrier_on(dev);\r\nnext_tick = 60*HZ;\r\n}\r\n} else if (tp->nwayset) {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev,\r\n"Using NWay-set %s media, csr12 %08x\n",\r\nmedianame[dev->if_port], csr12);\r\n} else if (tp->medialock) {\r\n;\r\n} else if (dev->if_port == 3) {\r\nif (csr12 & 2) {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev,\r\n"No 21143 100baseTx link beat, %08x, trying NWay\n",\r\ncsr12);\r\nt21142_start_nway(dev);\r\nnext_tick = 3*HZ;\r\n}\r\n} else if ((csr12 & 0x7000) != 0x5000) {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev,\r\n"21143 negotiation failed, status %08x\n",\r\ncsr12);\r\nif (!(csr12 & 4)) {\r\nnew_csr6 = 0x82420000;\r\ndev->if_port = 0;\r\niowrite32(0, ioaddr + CSR13);\r\niowrite32(0x0003FFFF, ioaddr + CSR14);\r\niowrite16(t21142_csr15[dev->if_port], ioaddr + CSR15);\r\niowrite32(t21142_csr13[dev->if_port], ioaddr + CSR13);\r\n} else {\r\nnew_csr6 = 0x83860000;\r\ndev->if_port = 3;\r\niowrite32(0, ioaddr + CSR13);\r\niowrite32(0x0003FFFF, ioaddr + CSR14);\r\niowrite16(8, ioaddr + CSR15);\r\niowrite32(1, ioaddr + CSR13);\r\n}\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev, "Testing new 21143 media %s\n",\r\nmedianame[dev->if_port]);\r\nif (new_csr6 != (tp->csr6 & ~0x00D5)) {\r\ntp->csr6 &= 0x00D5;\r\ntp->csr6 |= new_csr6;\r\niowrite32(0x0301, ioaddr + CSR12);\r\ntulip_restart_rxtx(tp);\r\n}\r\nnext_tick = 3*HZ;\r\n}\r\nmod_timer(&tp->timer, RUN_AT(next_tick));\r\n}\r\nvoid t21142_start_nway(struct net_device *dev)\r\n{\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint csr14 = ((tp->sym_advertise & 0x0780) << 9) |\r\n((tp->sym_advertise & 0x0020) << 1) | 0xffbf;\r\ndev->if_port = 0;\r\ntp->nway = tp->mediasense = 1;\r\ntp->nwayset = tp->lpar = 0;\r\nif (tulip_debug > 1)\r\nnetdev_dbg(dev, "Restarting 21143 autonegotiation, csr14=%08x\n",\r\ncsr14);\r\niowrite32(0x0001, ioaddr + CSR13);\r\nudelay(100);\r\niowrite32(csr14, ioaddr + CSR14);\r\ntp->csr6 = 0x82420000 | (tp->sym_advertise & 0x0040 ? FullDuplex : 0);\r\niowrite32(tp->csr6, ioaddr + CSR6);\r\nif (tp->mtable && tp->mtable->csr15dir) {\r\niowrite32(tp->mtable->csr15dir, ioaddr + CSR15);\r\niowrite32(tp->mtable->csr15val, ioaddr + CSR15);\r\n} else\r\niowrite16(0x0008, ioaddr + CSR15);\r\niowrite32(0x1301, ioaddr + CSR12);\r\n}\r\nvoid t21142_lnk_change(struct net_device *dev, int csr5)\r\n{\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint csr12 = ioread32(ioaddr + CSR12);\r\nint csr14 = ioread32(ioaddr + CSR14);\r\nif ((csr14 & 0x80) && (csr12 & 0x7000) != 0x5000)\r\ncsr12 |= 6;\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev,\r\n"21143 link status interrupt %08x, CSR5 %x, %08x\n",\r\ncsr12, csr5, csr14);\r\nif (tp->nway && !tp->nwayset && (csr12 & 0x7000) == 0x5000) {\r\nint setup_done = 0;\r\nint negotiated = tp->sym_advertise & (csr12 >> 16);\r\ntp->lpar = csr12 >> 16;\r\ntp->nwayset = 1;\r\nif (!(csr12 & 0x8000)) dev->if_port = 0;\r\nelse if (negotiated & 0x0100) dev->if_port = 5;\r\nelse if (negotiated & 0x0080) dev->if_port = 3;\r\nelse if (negotiated & 0x0040) dev->if_port = 4;\r\nelse if (negotiated & 0x0020) dev->if_port = 0;\r\nelse {\r\ntp->nwayset = 0;\r\nif ((csr12 & 2) == 0 && (tp->sym_advertise & 0x0180))\r\ndev->if_port = 3;\r\n}\r\ntp->full_duplex = (tulip_media_cap[dev->if_port] & MediaAlwaysFD) ? 1:0;\r\nif (tulip_debug > 1) {\r\nif (tp->nwayset)\r\ndev_info(&dev->dev,\r\n"Switching to %s based on link negotiation %04x & %04x = %04x\n",\r\nmedianame[dev->if_port],\r\ntp->sym_advertise, tp->lpar,\r\nnegotiated);\r\nelse\r\ndev_info(&dev->dev,\r\n"Autonegotiation failed, using %s, link beat status %04x\n",\r\nmedianame[dev->if_port], csr12);\r\n}\r\nif (tp->mtable) {\r\nint i;\r\nfor (i = 0; i < tp->mtable->leafcount; i++)\r\nif (tp->mtable->mleaf[i].media == dev->if_port) {\r\nint startup = ! ((tp->chip_id == DC21143 && (tp->revision == 48 || tp->revision == 65)));\r\ntp->cur_index = i;\r\ntulip_select_media(dev, startup);\r\nsetup_done = 1;\r\nbreak;\r\n}\r\n}\r\nif ( ! setup_done) {\r\ntp->csr6 = (dev->if_port & 1 ? 0x838E0000 : 0x82420000) | (tp->csr6 & 0x20ff);\r\nif (tp->full_duplex)\r\ntp->csr6 |= 0x0200;\r\niowrite32(1, ioaddr + CSR13);\r\n}\r\n#if 0\r\niowrite32(tp->csr6 | RxOn, ioaddr + CSR6);\r\nif (tulip_debug > 2)\r\nnetdev_dbg(dev, " Restarting Tx and Rx, CSR5 is %08x\n",\r\nioread32(ioaddr + CSR5));\r\n#endif\r\ntulip_start_rxtx(tp);\r\nif (tulip_debug > 2)\r\nnetdev_dbg(dev, " Setting CSR6 %08x/%x CSR12 %08x\n",\r\ntp->csr6, ioread32(ioaddr + CSR6),\r\nioread32(ioaddr + CSR12));\r\n} else if ((tp->nwayset && (csr5 & 0x08000000) &&\r\n(dev->if_port == 3 || dev->if_port == 5) &&\r\n(csr12 & 2) == 2) ||\r\n(tp->nway && (csr5 & (TPLnkFail)))) {\r\ndel_timer_sync(&tp->timer);\r\nt21142_start_nway(dev);\r\ntp->timer.expires = RUN_AT(3*HZ);\r\nadd_timer(&tp->timer);\r\n} else if (dev->if_port == 3 || dev->if_port == 5) {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev, "21143 %s link beat %s\n",\r\nmedianame[dev->if_port],\r\n(csr12 & 2) ? "failed" : "good");\r\nif ((csr12 & 2) && ! tp->medialock) {\r\ndel_timer_sync(&tp->timer);\r\nt21142_start_nway(dev);\r\ntp->timer.expires = RUN_AT(3*HZ);\r\nadd_timer(&tp->timer);\r\n} else if (dev->if_port == 5)\r\niowrite32(csr14 & ~0x080, ioaddr + CSR14);\r\n} else if (dev->if_port == 0 || dev->if_port == 4) {\r\nif ((csr12 & 4) == 0)\r\ndev_info(&dev->dev, "21143 10baseT link beat good\n");\r\n} else if (!(csr12 & 4)) {\r\nif (tulip_debug)\r\ndev_info(&dev->dev, "21143 10mbps sensed media\n");\r\ndev->if_port = 0;\r\n} else if (tp->nwayset) {\r\nif (tulip_debug)\r\ndev_info(&dev->dev, "21143 using NWay-set %s, csr6 %08x\n",\r\nmedianame[dev->if_port], tp->csr6);\r\n} else {\r\nif (tulip_debug)\r\ndev_info(&dev->dev, "21143 100baseTx sensed media\n");\r\ndev->if_port = 3;\r\ntp->csr6 = 0x838E0000 | (tp->csr6 & 0x20ff);\r\niowrite32(0x0003FF7F, ioaddr + CSR14);\r\niowrite32(0x0301, ioaddr + CSR12);\r\ntulip_restart_rxtx(tp);\r\n}\r\n}

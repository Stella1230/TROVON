static ssize_t iio_bfin_tmr_frequency_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct iio_trigger *trig = dev_get_drvdata(dev);\r\nstruct bfin_tmr_state *st = trig->private_data;\r\nlong val;\r\nint ret;\r\nret = strict_strtoul(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nif (val > 100000) {\r\nret = -EINVAL;\r\ngoto error_ret;\r\n}\r\ndisable_gptimers(st->t->bit);\r\nif (!val)\r\ngoto error_ret;\r\nval = get_sclk() / val;\r\nif (val <= 4) {\r\nret = -EINVAL;\r\ngoto error_ret;\r\n}\r\nset_gptimer_period(st->t->id, val);\r\nset_gptimer_pwidth(st->t->id, 1);\r\nenable_gptimers(st->t->bit);\r\nerror_ret:\r\nreturn ret ? ret : count;\r\n}\r\nstatic ssize_t iio_bfin_tmr_frequency_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_trigger *trig = dev_get_drvdata(dev);\r\nstruct bfin_tmr_state *st = trig->private_data;\r\nreturn sprintf(buf, "%lu\n",\r\nget_sclk() / get_gptimer_period(st->t->id));\r\n}\r\nstatic irqreturn_t iio_bfin_tmr_trigger_isr(int irq, void *devid)\r\n{\r\nstruct bfin_tmr_state *st = devid;\r\nclear_gptimer_intr(st->t->id);\r\niio_trigger_poll(st->trig, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int iio_bfin_tmr_get_number(int irq)\r\n{\r\nint i;\r\nfor (i = 0; i < MAX_BLACKFIN_GPTIMERS; i++)\r\nif (iio_bfin_timer_code[i].irq == irq)\r\nreturn i;\r\nreturn -ENODEV;\r\n}\r\nstatic int __devinit iio_bfin_tmr_trigger_probe(struct platform_device *pdev)\r\n{\r\nstruct bfin_tmr_state *st;\r\nint ret;\r\nst = kzalloc(sizeof(*st), GFP_KERNEL);\r\nif (st == NULL) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nst->irq = platform_get_irq(pdev, 0);\r\nif (!st->irq) {\r\ndev_err(&pdev->dev, "No IRQs specified");\r\nret = -ENODEV;\r\ngoto out1;\r\n}\r\nret = iio_bfin_tmr_get_number(st->irq);\r\nif (ret < 0)\r\ngoto out1;\r\nst->timer_num = ret;\r\nst->t = &iio_bfin_timer_code[st->timer_num];\r\nst->trig = iio_allocate_trigger("bfintmr%d", st->timer_num);\r\nif (!st->trig) {\r\nret = -ENOMEM;\r\ngoto out1;\r\n}\r\nst->trig->private_data = st;\r\nst->trig->ops = &iio_bfin_tmr_trigger_ops;\r\nst->trig->dev.groups = iio_bfin_tmr_trigger_attr_groups;\r\nret = iio_trigger_register(st->trig);\r\nif (ret)\r\ngoto out2;\r\nret = request_irq(st->irq, iio_bfin_tmr_trigger_isr,\r\n0, st->trig->name, st);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"request IRQ-%d failed", st->irq);\r\ngoto out4;\r\n}\r\nset_gptimer_config(st->t->id, OUT_DIS | PWM_OUT | PERIOD_CNT | IRQ_ENA);\r\ndev_info(&pdev->dev, "iio trigger Blackfin TMR%d, IRQ-%d",\r\nst->timer_num, st->irq);\r\nplatform_set_drvdata(pdev, st);\r\nreturn 0;\r\nout4:\r\niio_trigger_unregister(st->trig);\r\nout2:\r\niio_put_trigger(st->trig);\r\nout1:\r\nkfree(st);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __devexit iio_bfin_tmr_trigger_remove(struct platform_device *pdev)\r\n{\r\nstruct bfin_tmr_state *st = platform_get_drvdata(pdev);\r\ndisable_gptimers(st->t->bit);\r\nfree_irq(st->irq, st);\r\niio_trigger_unregister(st->trig);\r\niio_put_trigger(st->trig);\r\nkfree(st);\r\nreturn 0;\r\n}\r\nstatic int __init iio_bfin_tmr_trig_init(void)\r\n{\r\nreturn platform_driver_register(&iio_bfin_tmr_trigger_driver);\r\n}\r\nstatic void __exit iio_bfin_tmr_trig_exit(void)\r\n{\r\nplatform_driver_unregister(&iio_bfin_tmr_trigger_driver);\r\n}

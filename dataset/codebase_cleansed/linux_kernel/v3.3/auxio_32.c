void __init auxio_probe(void)\r\n{\r\nphandle node, auxio_nd;\r\nstruct linux_prom_registers auxregs[1];\r\nstruct resource r;\r\nswitch (sparc_cpu_model) {\r\ncase sparc_leon:\r\ncase sun4d:\r\ncase sun4:\r\nreturn;\r\ndefault:\r\nbreak;\r\n}\r\nnode = prom_getchild(prom_root_node);\r\nauxio_nd = prom_searchsiblings(node, "auxiliary-io");\r\nif(!auxio_nd) {\r\nnode = prom_searchsiblings(node, "obio");\r\nnode = prom_getchild(node);\r\nauxio_nd = prom_searchsiblings(node, "auxio");\r\nif(!auxio_nd) {\r\n#ifdef CONFIG_PCI\r\nreturn;\r\n#else\r\nif(prom_searchsiblings(node, "leds")) {\r\nreturn;\r\n}\r\nprom_printf("Cannot find auxio node, cannot continue...\n");\r\nprom_halt();\r\n#endif\r\n}\r\n}\r\nif(prom_getproperty(auxio_nd, "reg", (char *) auxregs, sizeof(auxregs)) <= 0)\r\nreturn;\r\nprom_apply_obio_ranges(auxregs, 0x1);\r\nr.flags = auxregs[0].which_io & 0xF;\r\nr.start = auxregs[0].phys_addr;\r\nr.end = auxregs[0].phys_addr + auxregs[0].reg_size - 1;\r\nauxio_register = of_ioremap(&r, 0, auxregs[0].reg_size, "auxio");\r\nif((((unsigned long) auxregs[0].phys_addr) & 3) == 3 ||\r\nsparc_cpu_model == sun4c)\r\nauxio_register += (3 - ((unsigned long)auxio_register & 3));\r\nset_auxio(AUXIO_LED, 0);\r\n}\r\nunsigned char get_auxio(void)\r\n{\r\nif(auxio_register)\r\nreturn sbus_readb(auxio_register);\r\nreturn 0;\r\n}\r\nvoid set_auxio(unsigned char bits_on, unsigned char bits_off)\r\n{\r\nunsigned char regval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&auxio_lock, flags);\r\nswitch(sparc_cpu_model) {\r\ncase sun4c:\r\nregval = sbus_readb(auxio_register);\r\nsbus_writeb(((regval | bits_on) & ~bits_off) | AUXIO_ORMEIN,\r\nauxio_register);\r\nbreak;\r\ncase sun4m:\r\nif(!auxio_register)\r\nbreak;\r\nregval = sbus_readb(auxio_register);\r\nsbus_writeb(((regval | bits_on) & ~bits_off) | AUXIO_ORMEIN4M,\r\nauxio_register);\r\nbreak;\r\ncase sun4d:\r\nbreak;\r\ndefault:\r\npanic("Can't set AUXIO register on this machine.");\r\n}\r\nspin_unlock_irqrestore(&auxio_lock, flags);\r\n}\r\nvoid __init auxio_power_probe(void)\r\n{\r\nstruct linux_prom_registers regs;\r\nphandle node;\r\nstruct resource r;\r\nnode = prom_getchild(prom_root_node);\r\nnode = prom_searchsiblings(node, "obio");\r\nnode = prom_getchild(node);\r\nnode = prom_searchsiblings(node, "power");\r\nif (node == 0 || (s32)node == -1)\r\nreturn;\r\nif (prom_getproperty(node, "reg", (char *)&regs, sizeof(regs)) <= 0)\r\nreturn;\r\nprom_apply_obio_ranges(&regs, 1);\r\nmemset(&r, 0, sizeof(r));\r\nr.flags = regs.which_io & 0xF;\r\nr.start = regs.phys_addr;\r\nr.end = regs.phys_addr + regs.reg_size - 1;\r\nauxio_power_register = (unsigned char *) of_ioremap(&r, 0,\r\nregs.reg_size, "auxpower");\r\nif (auxio_power_register)\r\nprintk(KERN_INFO "Power off control detected.\n");\r\n}

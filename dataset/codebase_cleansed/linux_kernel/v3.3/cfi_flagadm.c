static int __init init_flagadm(void)\r\n{\r\nprintk(KERN_NOTICE "FlagaDM flash device: %x at %x\n",\r\nFLASH_SIZE, FLASH_PHYS_ADDR);\r\nflagadm_map.phys = FLASH_PHYS_ADDR;\r\nflagadm_map.virt = ioremap(FLASH_PHYS_ADDR,\r\nFLASH_SIZE);\r\nif (!flagadm_map.virt) {\r\nprintk("Failed to ioremap\n");\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&flagadm_map);\r\nmymtd = do_map_probe("cfi_probe", &flagadm_map);\r\nif (mymtd) {\r\nmymtd->owner = THIS_MODULE;\r\nmtd_device_register(mymtd, flagadm_parts, PARTITION_COUNT);\r\nprintk(KERN_NOTICE "FlagaDM flash device initialized\n");\r\nreturn 0;\r\n}\r\niounmap((void *)flagadm_map.virt);\r\nreturn -ENXIO;\r\n}\r\nstatic void __exit cleanup_flagadm(void)\r\n{\r\nif (mymtd) {\r\nmtd_device_unregister(mymtd);\r\nmap_destroy(mymtd);\r\n}\r\nif (flagadm_map.virt) {\r\niounmap((void *)flagadm_map.virt);\r\nflagadm_map.virt = 0;\r\n}\r\n}

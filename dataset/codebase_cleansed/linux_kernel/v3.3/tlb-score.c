void local_flush_tlb_all(void)\r\n{\r\nunsigned long flags;\r\nunsigned long old_ASID;\r\nint entry;\r\nlocal_irq_save(flags);\r\nold_ASID = pevn_get() & ASID_MASK;\r\npectx_set(0);\r\nentry = tlblock_get();\r\nfor (; entry < TLBSIZE; entry++) {\r\ntlbpt_set(entry);\r\npevn_set(KSEG1);\r\nbarrier();\r\ntlb_write_indexed();\r\n}\r\npevn_set(old_ASID);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline void\r\ndrop_mmu_context(struct mm_struct *mm)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nget_new_mmu_context(mm);\r\npevn_set(mm->context & ASID_MASK);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_mm(struct mm_struct *mm)\r\n{\r\nif (mm->context != 0)\r\ndrop_mmu_context(mm);\r\n}\r\nvoid local_flush_tlb_range(struct vm_area_struct *vma, unsigned long start,\r\nunsigned long end)\r\n{\r\nstruct mm_struct *mm = vma->vm_mm;\r\nunsigned long vma_mm_context = mm->context;\r\nif (mm->context != 0) {\r\nunsigned long flags;\r\nint size;\r\nlocal_irq_save(flags);\r\nsize = (end - start + (PAGE_SIZE - 1)) >> PAGE_SHIFT;\r\nif (size <= TLBSIZE) {\r\nint oldpid = pevn_get() & ASID_MASK;\r\nint newpid = vma_mm_context & ASID_MASK;\r\nstart &= PAGE_MASK;\r\nend += (PAGE_SIZE - 1);\r\nend &= PAGE_MASK;\r\nwhile (start < end) {\r\nint idx;\r\npevn_set(start | newpid);\r\nstart += PAGE_SIZE;\r\nbarrier();\r\ntlb_probe();\r\nidx = tlbpt_get();\r\npectx_set(0);\r\npevn_set(KSEG1);\r\nif (idx < 0)\r\ncontinue;\r\ntlb_write_indexed();\r\n}\r\npevn_set(oldpid);\r\n} else {\r\nget_new_mmu_context(mm);\r\nif (mm == current->active_mm)\r\npevn_set(vma_mm_context & ASID_MASK);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nvoid local_flush_tlb_kernel_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long flags;\r\nint size;\r\nlocal_irq_save(flags);\r\nsize = (end - start + (PAGE_SIZE - 1)) >> PAGE_SHIFT;\r\nif (size <= TLBSIZE) {\r\nint pid = pevn_get();\r\nstart &= PAGE_MASK;\r\nend += PAGE_SIZE - 1;\r\nend &= PAGE_MASK;\r\nwhile (start < end) {\r\nlong idx;\r\npevn_set(start);\r\nstart += PAGE_SIZE;\r\ntlb_probe();\r\nidx = tlbpt_get();\r\nif (idx < 0)\r\ncontinue;\r\npectx_set(0);\r\npevn_set(KSEG1);\r\nbarrier();\r\ntlb_write_indexed();\r\n}\r\npevn_set(pid);\r\n} else {\r\nlocal_flush_tlb_all();\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_page(struct vm_area_struct *vma, unsigned long page)\r\n{\r\nif (vma && vma->vm_mm->context != 0) {\r\nunsigned long flags;\r\nint oldpid, newpid, idx;\r\nunsigned long vma_ASID = vma->vm_mm->context;\r\nnewpid = vma_ASID & ASID_MASK;\r\npage &= PAGE_MASK;\r\nlocal_irq_save(flags);\r\noldpid = pevn_get() & ASID_MASK;\r\npevn_set(page | newpid);\r\nbarrier();\r\ntlb_probe();\r\nidx = tlbpt_get();\r\npectx_set(0);\r\npevn_set(KSEG1);\r\nif (idx < 0)\r\ngoto finish;\r\nbarrier();\r\ntlb_write_indexed();\r\nfinish:\r\npevn_set(oldpid);\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nvoid local_flush_tlb_one(unsigned long page)\r\n{\r\nunsigned long flags;\r\nint oldpid, idx;\r\nlocal_irq_save(flags);\r\noldpid = pevn_get();\r\npage &= (PAGE_MASK << 1);\r\npevn_set(page);\r\nbarrier();\r\ntlb_probe();\r\nidx = tlbpt_get();\r\npectx_set(0);\r\nif (idx >= 0) {\r\npevn_set(KSEG1);\r\nbarrier();\r\ntlb_write_indexed();\r\n}\r\npevn_set(oldpid);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid __update_tlb(struct vm_area_struct *vma, unsigned long address, pte_t pte)\r\n{\r\nunsigned long flags;\r\nint idx, pid;\r\nif (current->active_mm != vma->vm_mm)\r\nreturn;\r\npid = pevn_get() & ASID_MASK;\r\nlocal_irq_save(flags);\r\naddress &= PAGE_MASK;\r\npevn_set(address | pid);\r\nbarrier();\r\ntlb_probe();\r\nidx = tlbpt_get();\r\npectx_set(pte_val(pte));\r\npevn_set(address | pid);\r\nif (idx < 0)\r\ntlb_write_random();\r\nelse\r\ntlb_write_indexed();\r\npevn_set(pid);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid __cpuinit tlb_init(void)\r\n{\r\ntlblock_set(0);\r\nlocal_flush_tlb_all();\r\nmemcpy((void *)(EXCEPTION_VECTOR_BASE_ADDR + 0x100),\r\n&score7_FTLB_refill_Handler, 0xFC);\r\nflush_icache_range(EXCEPTION_VECTOR_BASE_ADDR + 0x100,\r\nEXCEPTION_VECTOR_BASE_ADDR + 0x1FC);\r\n}

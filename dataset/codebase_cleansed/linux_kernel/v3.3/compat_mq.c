static inline int get_compat_mq_attr(struct mq_attr *attr,\r\nconst struct compat_mq_attr __user *uattr)\r\n{\r\nif (!access_ok(VERIFY_READ, uattr, sizeof *uattr))\r\nreturn -EFAULT;\r\nreturn __get_user(attr->mq_flags, &uattr->mq_flags)\r\n| __get_user(attr->mq_maxmsg, &uattr->mq_maxmsg)\r\n| __get_user(attr->mq_msgsize, &uattr->mq_msgsize)\r\n| __get_user(attr->mq_curmsgs, &uattr->mq_curmsgs);\r\n}\r\nstatic inline int put_compat_mq_attr(const struct mq_attr *attr,\r\nstruct compat_mq_attr __user *uattr)\r\n{\r\nif (clear_user(uattr, sizeof *uattr))\r\nreturn -EFAULT;\r\nreturn __put_user(attr->mq_flags, &uattr->mq_flags)\r\n| __put_user(attr->mq_maxmsg, &uattr->mq_maxmsg)\r\n| __put_user(attr->mq_msgsize, &uattr->mq_msgsize)\r\n| __put_user(attr->mq_curmsgs, &uattr->mq_curmsgs);\r\n}\r\nasmlinkage long compat_sys_mq_open(const char __user *u_name,\r\nint oflag, compat_mode_t mode,\r\nstruct compat_mq_attr __user *u_attr)\r\n{\r\nvoid __user *p = NULL;\r\nif (u_attr && oflag & O_CREAT) {\r\nstruct mq_attr attr;\r\nmemset(&attr, 0, sizeof(attr));\r\np = compat_alloc_user_space(sizeof(attr));\r\nif (get_compat_mq_attr(&attr, u_attr) ||\r\ncopy_to_user(p, &attr, sizeof(attr)))\r\nreturn -EFAULT;\r\n}\r\nreturn sys_mq_open(u_name, oflag, mode, p);\r\n}\r\nstatic int compat_prepare_timeout(struct timespec __user * *p,\r\nconst struct compat_timespec __user *u)\r\n{\r\nstruct timespec ts;\r\nif (!u) {\r\n*p = NULL;\r\nreturn 0;\r\n}\r\n*p = compat_alloc_user_space(sizeof(ts));\r\nif (get_compat_timespec(&ts, u) || copy_to_user(*p, &ts, sizeof(ts)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nasmlinkage long compat_sys_mq_timedsend(mqd_t mqdes,\r\nconst char __user *u_msg_ptr,\r\nsize_t msg_len, unsigned int msg_prio,\r\nconst struct compat_timespec __user *u_abs_timeout)\r\n{\r\nstruct timespec __user *u_ts;\r\nif (compat_prepare_timeout(&u_ts, u_abs_timeout))\r\nreturn -EFAULT;\r\nreturn sys_mq_timedsend(mqdes, u_msg_ptr, msg_len,\r\nmsg_prio, u_ts);\r\n}\r\nasmlinkage ssize_t compat_sys_mq_timedreceive(mqd_t mqdes,\r\nchar __user *u_msg_ptr,\r\nsize_t msg_len, unsigned int __user *u_msg_prio,\r\nconst struct compat_timespec __user *u_abs_timeout)\r\n{\r\nstruct timespec __user *u_ts;\r\nif (compat_prepare_timeout(&u_ts, u_abs_timeout))\r\nreturn -EFAULT;\r\nreturn sys_mq_timedreceive(mqdes, u_msg_ptr, msg_len,\r\nu_msg_prio, u_ts);\r\n}\r\nasmlinkage long compat_sys_mq_notify(mqd_t mqdes,\r\nconst struct compat_sigevent __user *u_notification)\r\n{\r\nstruct sigevent __user *p = NULL;\r\nif (u_notification) {\r\nstruct sigevent n;\r\np = compat_alloc_user_space(sizeof(*p));\r\nif (get_compat_sigevent(&n, u_notification))\r\nreturn -EFAULT;\r\nif (n.sigev_notify == SIGEV_THREAD)\r\nn.sigev_value.sival_ptr = compat_ptr(n.sigev_value.sival_int);\r\nif (copy_to_user(p, &n, sizeof(*p)))\r\nreturn -EFAULT;\r\n}\r\nreturn sys_mq_notify(mqdes, p);\r\n}\r\nasmlinkage long compat_sys_mq_getsetattr(mqd_t mqdes,\r\nconst struct compat_mq_attr __user *u_mqstat,\r\nstruct compat_mq_attr __user *u_omqstat)\r\n{\r\nstruct mq_attr mqstat;\r\nstruct mq_attr __user *p = compat_alloc_user_space(2 * sizeof(*p));\r\nlong ret;\r\nmemset(&mqstat, 0, sizeof(mqstat));\r\nif (u_mqstat) {\r\nif (get_compat_mq_attr(&mqstat, u_mqstat) ||\r\ncopy_to_user(p, &mqstat, sizeof(mqstat)))\r\nreturn -EFAULT;\r\n}\r\nret = sys_mq_getsetattr(mqdes,\r\nu_mqstat ? p : NULL,\r\nu_omqstat ? p + 1 : NULL);\r\nif (ret)\r\nreturn ret;\r\nif (u_omqstat) {\r\nif (copy_from_user(&mqstat, p + 1, sizeof(mqstat)) ||\r\nput_compat_mq_attr(&mqstat, u_omqstat))\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}

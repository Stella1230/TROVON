void __irq_entry deferred_pcr_work_irq(int irq, struct pt_regs *regs)\r\n{\r\nstruct pt_regs *old_regs;\r\nclear_softint(1 << PIL_DEFERRED_PCR_WORK);\r\nold_regs = set_irq_regs(regs);\r\nirq_enter();\r\n#ifdef CONFIG_IRQ_WORK\r\nirq_work_run();\r\n#endif\r\nirq_exit();\r\nset_irq_regs(old_regs);\r\n}\r\nvoid arch_irq_work_raise(void)\r\n{\r\nset_softint(1 << PIL_DEFERRED_PCR_WORK);\r\n}\r\nstatic u64 direct_pcr_read(void)\r\n{\r\nu64 val;\r\nread_pcr(val);\r\nreturn val;\r\n}\r\nstatic void direct_pcr_write(u64 val)\r\n{\r\nwrite_pcr(val);\r\n}\r\nstatic void n2_pcr_write(u64 val)\r\n{\r\nunsigned long ret;\r\nif (val & PCR_N2_HTRACE) {\r\nret = sun4v_niagara2_setperf(HV_N2_PERF_SPARC_CTL, val);\r\nif (ret != HV_EOK)\r\nwrite_pcr(val);\r\n} else\r\nwrite_pcr(val);\r\n}\r\nstatic int __init register_perf_hsvc(void)\r\n{\r\nif (tlb_type == hypervisor) {\r\nswitch (sun4v_chip_type) {\r\ncase SUN4V_CHIP_NIAGARA1:\r\nperf_hsvc_group = HV_GRP_NIAG_PERF;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA2:\r\nperf_hsvc_group = HV_GRP_N2_CPU;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA3:\r\nperf_hsvc_group = HV_GRP_KT_CPU;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nperf_hsvc_major = 1;\r\nperf_hsvc_minor = 0;\r\nif (sun4v_hvapi_register(perf_hsvc_group,\r\nperf_hsvc_major,\r\n&perf_hsvc_minor)) {\r\nprintk("perfmon: Could not register hvapi.\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init unregister_perf_hsvc(void)\r\n{\r\nif (tlb_type != hypervisor)\r\nreturn;\r\nsun4v_hvapi_unregister(perf_hsvc_group);\r\n}\r\nint __init pcr_arch_init(void)\r\n{\r\nint err = register_perf_hsvc();\r\nif (err)\r\nreturn err;\r\nswitch (tlb_type) {\r\ncase hypervisor:\r\npcr_ops = &n2_pcr_ops;\r\npcr_enable = PCR_N2_ENABLE;\r\npicl_shift = 2;\r\nbreak;\r\ncase cheetah:\r\ncase cheetah_plus:\r\npcr_ops = &direct_pcr_ops;\r\npcr_enable = PCR_SUN4U_ENABLE;\r\nbreak;\r\ncase spitfire:\r\ndefault:\r\nerr = -ENODEV;\r\ngoto out_unregister;\r\n}\r\nreturn nmi_init();\r\nout_unregister:\r\nunregister_perf_hsvc();\r\nreturn err;\r\n}

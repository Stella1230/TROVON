static bool rtl8187_is_radio_enabled(struct rtl8187_priv *priv)\r\n{\r\nu8 gpio;\r\ngpio = rtl818x_ioread8(priv, &priv->map->GPIO0);\r\nrtl818x_iowrite8(priv, &priv->map->GPIO0, gpio & ~priv->rfkill_mask);\r\ngpio = rtl818x_ioread8(priv, &priv->map->GPIO1);\r\nreturn gpio & priv->rfkill_mask;\r\n}\r\nvoid rtl8187_rfkill_init(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl8187_priv *priv = hw->priv;\r\npriv->rfkill_off = rtl8187_is_radio_enabled(priv);\r\nprintk(KERN_INFO "rtl8187: wireless switch is %s\n",\r\npriv->rfkill_off ? "on" : "off");\r\nwiphy_rfkill_set_hw_state(hw->wiphy, !priv->rfkill_off);\r\nwiphy_rfkill_start_polling(hw->wiphy);\r\n}\r\nvoid rtl8187_rfkill_poll(struct ieee80211_hw *hw)\r\n{\r\nbool enabled;\r\nstruct rtl8187_priv *priv = hw->priv;\r\nmutex_lock(&priv->conf_mutex);\r\nenabled = rtl8187_is_radio_enabled(priv);\r\nif (unlikely(enabled != priv->rfkill_off)) {\r\npriv->rfkill_off = enabled;\r\nprintk(KERN_INFO "rtl8187: wireless radio switch turned %s\n",\r\nenabled ? "on" : "off");\r\nwiphy_rfkill_set_hw_state(hw->wiphy, !enabled);\r\n}\r\nmutex_unlock(&priv->conf_mutex);\r\n}\r\nvoid rtl8187_rfkill_exit(struct ieee80211_hw *hw)\r\n{\r\nwiphy_rfkill_stop_polling(hw->wiphy);\r\n}

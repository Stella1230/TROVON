static int __init driver_8255_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_8255);\r\n}\r\nstatic void __exit driver_8255_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_8255);\r\n}\r\nvoid subdev_8255_interrupt(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nshort d;\r\nd = CALLBACK_FUNC(0, _8255_DATA, 0, CALLBACK_ARG);\r\nd |= (CALLBACK_FUNC(0, _8255_DATA + 1, 0, CALLBACK_ARG) << 8);\r\ncomedi_buf_put(s->async, d);\r\ns->async->events |= COMEDI_CB_EOS;\r\ncomedi_event(dev, s);\r\n}\r\nstatic int subdev_8255_cb(int dir, int port, int data, unsigned long arg)\r\n{\r\nunsigned long iobase = arg;\r\nif (dir) {\r\noutb(data, iobase + port);\r\nreturn 0;\r\n} else {\r\nreturn inb(iobase + port);\r\n}\r\n}\r\nstatic int subdev_8255_insn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (data[0]) {\r\ns->state &= ~data[0];\r\ns->state |= (data[0] & data[1]);\r\nif (data[0] & 0xff)\r\nCALLBACK_FUNC(1, _8255_DATA, s->state & 0xff,\r\nCALLBACK_ARG);\r\nif (data[0] & 0xff00)\r\nCALLBACK_FUNC(1, _8255_DATA + 1, (s->state >> 8) & 0xff,\r\nCALLBACK_ARG);\r\nif (data[0] & 0xff0000)\r\nCALLBACK_FUNC(1, _8255_DATA + 2,\r\n(s->state >> 16) & 0xff, CALLBACK_ARG);\r\n}\r\ndata[1] = CALLBACK_FUNC(0, _8255_DATA, 0, CALLBACK_ARG);\r\ndata[1] |= (CALLBACK_FUNC(0, _8255_DATA + 1, 0, CALLBACK_ARG) << 8);\r\ndata[1] |= (CALLBACK_FUNC(0, _8255_DATA + 2, 0, CALLBACK_ARG) << 16);\r\nreturn 2;\r\n}\r\nstatic int subdev_8255_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int mask;\r\nunsigned int bits;\r\nmask = 1 << CR_CHAN(insn->chanspec);\r\nif (mask & 0x0000ff)\r\nbits = 0x0000ff;\r\nelse if (mask & 0x00ff00)\r\nbits = 0x00ff00;\r\nelse if (mask & 0x0f0000)\r\nbits = 0x0f0000;\r\nelse\r\nbits = 0xf00000;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_INPUT:\r\ns->io_bits &= ~bits;\r\nbreak;\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ns->io_bits |= bits;\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] = (s->io_bits & bits) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndo_config(dev, s);\r\nreturn 1;\r\n}\r\nstatic void do_config(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nint config;\r\nconfig = CR_CW;\r\nif (!(s->io_bits & 0x0000ff))\r\nconfig |= CR_A_IO;\r\nif (!(s->io_bits & 0x00ff00))\r\nconfig |= CR_B_IO;\r\nif (!(s->io_bits & 0x0f0000))\r\nconfig |= CR_C_LO_IO;\r\nif (!(s->io_bits & 0xf00000))\r\nconfig |= CR_C_HI_IO;\r\nCALLBACK_FUNC(1, _8255_CR, config, CALLBACK_ARG);\r\n}\r\nstatic int subdev_8255_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nunsigned int tmp;\r\ntmp = cmd->start_src;\r\ncmd->start_src &= TRIG_NOW;\r\nif (!cmd->start_src || tmp != cmd->start_src)\r\nerr++;\r\ntmp = cmd->scan_begin_src;\r\ncmd->scan_begin_src &= TRIG_EXT;\r\nif (!cmd->scan_begin_src || tmp != cmd->scan_begin_src)\r\nerr++;\r\ntmp = cmd->convert_src;\r\ncmd->convert_src &= TRIG_FOLLOW;\r\nif (!cmd->convert_src || tmp != cmd->convert_src)\r\nerr++;\r\ntmp = cmd->scan_end_src;\r\ncmd->scan_end_src &= TRIG_COUNT;\r\nif (!cmd->scan_end_src || tmp != cmd->scan_end_src)\r\nerr++;\r\ntmp = cmd->stop_src;\r\ncmd->stop_src &= TRIG_NONE;\r\nif (!cmd->stop_src || tmp != cmd->stop_src)\r\nerr++;\r\nif (err)\r\nreturn 1;\r\nif (err)\r\nreturn 2;\r\nif (cmd->start_arg != 0) {\r\ncmd->start_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->scan_begin_arg != 0) {\r\ncmd->scan_begin_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->convert_arg != 0) {\r\ncmd->convert_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->scan_end_arg != 1) {\r\ncmd->scan_end_arg = 1;\r\nerr++;\r\n}\r\nif (cmd->stop_arg != 0) {\r\ncmd->stop_arg = 0;\r\nerr++;\r\n}\r\nif (err)\r\nreturn 3;\r\nif (err)\r\nreturn 4;\r\nreturn 0;\r\n}\r\nstatic int subdev_8255_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nreturn 0;\r\n}\r\nstatic int subdev_8255_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nreturn 0;\r\n}\r\nint subdev_8255_init(struct comedi_device *dev, struct comedi_subdevice *s,\r\nint (*cb) (int, int, int, unsigned long),\r\nunsigned long arg)\r\n{\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 24;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->private = kmalloc(sizeof(struct subdev_8255_struct), GFP_KERNEL);\r\nif (!s->private)\r\nreturn -ENOMEM;\r\nCALLBACK_ARG = arg;\r\nif (cb == NULL)\r\nCALLBACK_FUNC = subdev_8255_cb;\r\nelse\r\nCALLBACK_FUNC = cb;\r\ns->insn_bits = subdev_8255_insn;\r\ns->insn_config = subdev_8255_insn_config;\r\ns->state = 0;\r\ns->io_bits = 0;\r\ndo_config(dev, s);\r\nreturn 0;\r\n}\r\nint subdev_8255_init_irq(struct comedi_device *dev, struct comedi_subdevice *s,\r\nint (*cb) (int, int, int, unsigned long),\r\nunsigned long arg)\r\n{\r\nint ret;\r\nret = subdev_8255_init(dev, s, cb, arg);\r\nif (ret < 0)\r\nreturn ret;\r\ns->do_cmdtest = subdev_8255_cmdtest;\r\ns->do_cmd = subdev_8255_cmd;\r\ns->cancel = subdev_8255_cancel;\r\nsubdevpriv->have_irq = 1;\r\nreturn 0;\r\n}\r\nvoid subdev_8255_cleanup(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nkfree(s->private);\r\n}\r\nstatic int dev_8255_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nint ret;\r\nunsigned long iobase;\r\nint i;\r\ndev->board_name = "8255";\r\nfor (i = 0; i < COMEDI_NDEVCONFOPTS; i++) {\r\niobase = it->options[i];\r\nif (!iobase)\r\nbreak;\r\n}\r\nif (i == 0) {\r\nprintk(KERN_WARNING\r\n"comedi%d: 8255: no devices specified\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nret = alloc_subdevices(dev, i);\r\nif (ret < 0) {\r\nprintk("comedi%d: 8255:", dev->minor);\r\nreturn ret;\r\n}\r\nprintk(KERN_INFO "comedi%d: 8255:", dev->minor);\r\nfor (i = 0; i < dev->n_subdevices; i++) {\r\niobase = it->options[i];\r\nprintk(" 0x%04lx", iobase);\r\nif (!request_region(iobase, _8255_SIZE, "8255")) {\r\nprintk(" (I/O port conflict)");\r\ndev->subdevices[i].type = COMEDI_SUBD_UNUSED;\r\n} else {\r\nsubdev_8255_init(dev, dev->subdevices + i, NULL,\r\niobase);\r\n}\r\n}\r\nprintk("\n");\r\nreturn 0;\r\n}\r\nstatic int dev_8255_detach(struct comedi_device *dev)\r\n{\r\nint i;\r\nunsigned long iobase;\r\nstruct comedi_subdevice *s;\r\nprintk(KERN_INFO "comedi%d: 8255: remove\n", dev->minor);\r\nfor (i = 0; i < dev->n_subdevices; i++) {\r\ns = dev->subdevices + i;\r\nif (s->type != COMEDI_SUBD_UNUSED) {\r\niobase = CALLBACK_ARG;\r\nrelease_region(iobase, _8255_SIZE);\r\n}\r\nsubdev_8255_cleanup(dev, s);\r\n}\r\nreturn 0;\r\n}

static struct Scsi_Host *__qlogicfas_detect(struct scsi_host_template *host,\r\nint qbase,\r\nint qlirq)\r\n{\r\nint qltyp;\r\nint qinitid;\r\nstruct Scsi_Host *hreg;\r\nstruct qlogicfas408_priv *priv;\r\nif (!qbase || qlirq == -1)\r\ngoto err;\r\nif (!request_region(qbase, 0x10, qlogicfas_name)) {\r\nprintk(KERN_INFO "%s: address %#x is busy\n", qlogicfas_name,\r\nqbase);\r\ngoto err;\r\n}\r\nif (!qlogicfas408_detect(qbase, INT_TYPE)) {\r\nprintk(KERN_WARNING "%s: probe failed for %#x\n",\r\nqlogicfas_name,\r\nqbase);\r\ngoto err_release_mem;\r\n}\r\nprintk(KERN_INFO "%s: Using preset base address of %03x,"\r\n" IRQ %d\n", qlogicfas_name, qbase, qlirq);\r\nqltyp = qlogicfas408_get_chip_type(qbase, INT_TYPE);\r\nqinitid = host->this_id;\r\nif (qinitid < 0)\r\nqinitid = 7;\r\nqlogicfas408_setup(qbase, qinitid, INT_TYPE);\r\nhreg = scsi_host_alloc(host, sizeof(struct qlogicfas408_priv));\r\nif (!hreg)\r\ngoto err_release_mem;\r\npriv = get_priv_by_host(hreg);\r\nhreg->io_port = qbase;\r\nhreg->n_io_port = 16;\r\nhreg->dma_channel = -1;\r\nif (qlirq != -1)\r\nhreg->irq = qlirq;\r\npriv->qbase = qbase;\r\npriv->qlirq = qlirq;\r\npriv->qinitid = qinitid;\r\npriv->shost = hreg;\r\npriv->int_type = INT_TYPE;\r\nsprintf(priv->qinfo,\r\n"Qlogicfas Driver version 0.46, chip %02X at %03X, IRQ %d, TPdma:%d",\r\nqltyp, qbase, qlirq, QL_TURBO_PDMA);\r\nhost->name = qlogicfas_name;\r\nif (request_irq(qlirq, qlogicfas408_ihandl, 0, qlogicfas_name, hreg))\r\ngoto free_scsi_host;\r\nif (scsi_add_host(hreg, NULL))\r\ngoto free_interrupt;\r\nscsi_scan_host(hreg);\r\nreturn hreg;\r\nfree_interrupt:\r\nfree_irq(qlirq, hreg);\r\nfree_scsi_host:\r\nscsi_host_put(hreg);\r\nerr_release_mem:\r\nrelease_region(qbase, 0x10);\r\nerr:\r\nreturn NULL;\r\n}\r\nstatic int __devinit qlogicfas_detect(struct scsi_host_template *sht)\r\n{\r\nstruct Scsi_Host *shost;\r\nstruct qlogicfas408_priv *priv;\r\nint num;\r\nfor (num = 0; num < MAX_QLOGICFAS; num++) {\r\nshost = __qlogicfas_detect(sht, iobase[num], irq[num]);\r\nif (shost == NULL) {\r\nbreak;\r\n}\r\npriv = get_priv_by_host(shost);\r\npriv->next = cards;\r\ncards = priv;\r\n}\r\nreturn num;\r\n}\r\nstatic int qlogicfas_release(struct Scsi_Host *shost)\r\n{\r\nstruct qlogicfas408_priv *priv = get_priv_by_host(shost);\r\nscsi_remove_host(shost);\r\nif (shost->irq) {\r\nqlogicfas408_disable_ints(priv);\r\nfree_irq(shost->irq, shost);\r\n}\r\nif (shost->dma_channel != 0xff)\r\nfree_dma(shost->dma_channel);\r\nif (shost->io_port && shost->n_io_port)\r\nrelease_region(shost->io_port, shost->n_io_port);\r\nscsi_host_put(shost);\r\nreturn 0;\r\n}\r\nstatic __init int qlogicfas_init(void)\r\n{\r\nif (!qlogicfas_detect(&qlogicfas_driver_template)) {\r\nprintk(KERN_INFO "%s: no cards were found, please specify "\r\n"I/O address and IRQ using iobase= and irq= "\r\n"options", qlogicfas_name);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic __exit void qlogicfas_exit(void)\r\n{\r\nstruct qlogicfas408_priv *priv;\r\nfor (priv = cards; priv != NULL; priv = priv->next)\r\nqlogicfas_release(priv->shost);\r\n}

void *kmap(struct page *page)\r\n{\r\nmight_sleep();\r\nif (!PageHighMem(page))\r\nreturn page_address(page);\r\nreturn kmap_high(page);\r\n}\r\nvoid kunmap(struct page *page)\r\n{\r\nif (in_interrupt())\r\nBUG();\r\nif (!PageHighMem(page))\r\nreturn;\r\nkunmap_high(page);\r\n}\r\nvoid *kmap_atomic_prot(struct page *page, pgprot_t prot)\r\n{\r\nunsigned long vaddr;\r\nint idx, type;\r\npagefault_disable();\r\nif (!PageHighMem(page))\r\nreturn page_address(page);\r\ntype = kmap_atomic_idx_push();\r\nidx = type + KM_TYPE_NR*smp_processor_id();\r\nvaddr = __fix_to_virt(FIX_KMAP_BEGIN + idx);\r\nBUG_ON(!pte_none(*(kmap_pte-idx)));\r\nset_pte(kmap_pte-idx, mk_pte(page, prot));\r\narch_flush_lazy_mmu_mode();\r\nreturn (void *)vaddr;\r\n}\r\nvoid *__kmap_atomic(struct page *page)\r\n{\r\nreturn kmap_atomic_prot(page, kmap_prot);\r\n}\r\nvoid *kmap_atomic_pfn(unsigned long pfn)\r\n{\r\nreturn kmap_atomic_prot_pfn(pfn, kmap_prot);\r\n}\r\nvoid __kunmap_atomic(void *kvaddr)\r\n{\r\nunsigned long vaddr = (unsigned long) kvaddr & PAGE_MASK;\r\nif (vaddr >= __fix_to_virt(FIX_KMAP_END) &&\r\nvaddr <= __fix_to_virt(FIX_KMAP_BEGIN)) {\r\nint idx, type;\r\ntype = kmap_atomic_idx();\r\nidx = type + KM_TYPE_NR * smp_processor_id();\r\n#ifdef CONFIG_DEBUG_HIGHMEM\r\nWARN_ON_ONCE(vaddr != __fix_to_virt(FIX_KMAP_BEGIN + idx));\r\n#endif\r\nkpte_clear_flush(kmap_pte-idx, vaddr);\r\nkmap_atomic_idx_pop();\r\narch_flush_lazy_mmu_mode();\r\n}\r\n#ifdef CONFIG_DEBUG_HIGHMEM\r\nelse {\r\nBUG_ON(vaddr < PAGE_OFFSET);\r\nBUG_ON(vaddr >= (unsigned long)high_memory);\r\n}\r\n#endif\r\npagefault_enable();\r\n}\r\nstruct page *kmap_atomic_to_page(void *ptr)\r\n{\r\nunsigned long idx, vaddr = (unsigned long)ptr;\r\npte_t *pte;\r\nif (vaddr < FIXADDR_START)\r\nreturn virt_to_page(ptr);\r\nidx = virt_to_fix(vaddr);\r\npte = kmap_pte - (idx - FIX_KMAP_BEGIN);\r\nreturn pte_page(*pte);\r\n}\r\nvoid __init set_highmem_pages_init(void)\r\n{\r\nstruct zone *zone;\r\nint nid;\r\nfor_each_zone(zone) {\r\nunsigned long zone_start_pfn, zone_end_pfn;\r\nif (!is_highmem(zone))\r\ncontinue;\r\nzone_start_pfn = zone->zone_start_pfn;\r\nzone_end_pfn = zone_start_pfn + zone->spanned_pages;\r\nnid = zone_to_nid(zone);\r\nprintk(KERN_INFO "Initializing %s for node %d (%08lx:%08lx)\n",\r\nzone->name, nid, zone_start_pfn, zone_end_pfn);\r\nadd_highpages_with_active_regions(nid, zone_start_pfn,\r\nzone_end_pfn);\r\n}\r\ntotalram_pages += totalhigh_pages;\r\n}

static void __init set_tx4927_pcicptr(struct pci_controller *channel,\r\nstruct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pcicptrs); i++) {\r\nif (pcicptrs[i].channel == channel) {\r\npcicptrs[i].pcicptr = pcicptr;\r\nreturn;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(pcicptrs); i++) {\r\nif (!pcicptrs[i].channel) {\r\npcicptrs[i].channel = channel;\r\npcicptrs[i].pcicptr = pcicptr;\r\nreturn;\r\n}\r\n}\r\nBUG();\r\n}\r\nstruct tx4927_pcic_reg __iomem *get_tx4927_pcicptr(\r\nstruct pci_controller *channel)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pcicptrs); i++) {\r\nif (pcicptrs[i].channel == channel)\r\nreturn pcicptrs[i].pcicptr;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int mkaddr(struct pci_bus *bus, unsigned int devfn, int where,\r\nstruct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\nif (bus->parent == NULL &&\r\ndevfn >= PCI_DEVFN(TX4927_PCIC_MAX_DEVNU, 0))\r\nreturn -1;\r\n__raw_writel(((bus->number & 0xff) << 0x10)\r\n| ((devfn & 0xff) << 0x08) | (where & 0xfc)\r\n| (bus->parent ? 1 : 0),\r\n&pcicptr->g2pcfgadrs);\r\n__raw_writel((__raw_readl(&pcicptr->pcistatus) & 0x0000ffff)\r\n| (PCI_STATUS_REC_MASTER_ABORT << 16),\r\n&pcicptr->pcistatus);\r\nreturn 0;\r\n}\r\nstatic int check_abort(struct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\nint code = PCIBIOS_SUCCESSFUL;\r\nwhile (__raw_readl(&pcicptr->pcicstatus) & TX4927_PCIC_PCICSTATUS_IWB)\r\n;\r\nif (__raw_readl(&pcicptr->pcistatus)\r\n& (PCI_STATUS_REC_MASTER_ABORT << 16)) {\r\n__raw_writel((__raw_readl(&pcicptr->pcistatus) & 0x0000ffff)\r\n| (PCI_STATUS_REC_MASTER_ABORT << 16),\r\n&pcicptr->pcistatus);\r\niob();\r\ncode = PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\nreturn code;\r\n}\r\nstatic u8 icd_readb(int offset, struct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\n#ifdef __BIG_ENDIAN\r\noffset ^= 3;\r\n#endif\r\nreturn __raw_readb((void __iomem *)&pcicptr->g2pcfgdata + offset);\r\n}\r\nstatic u16 icd_readw(int offset, struct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\n#ifdef __BIG_ENDIAN\r\noffset ^= 2;\r\n#endif\r\nreturn __raw_readw((void __iomem *)&pcicptr->g2pcfgdata + offset);\r\n}\r\nstatic u32 icd_readl(struct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\nreturn __raw_readl(&pcicptr->g2pcfgdata);\r\n}\r\nstatic void icd_writeb(u8 val, int offset,\r\nstruct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\n#ifdef __BIG_ENDIAN\r\noffset ^= 3;\r\n#endif\r\n__raw_writeb(val, (void __iomem *)&pcicptr->g2pcfgdata + offset);\r\n}\r\nstatic void icd_writew(u16 val, int offset,\r\nstruct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\n#ifdef __BIG_ENDIAN\r\noffset ^= 2;\r\n#endif\r\n__raw_writew(val, (void __iomem *)&pcicptr->g2pcfgdata + offset);\r\n}\r\nstatic void icd_writel(u32 val, struct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\n__raw_writel(val, &pcicptr->g2pcfgdata);\r\n}\r\nstatic struct tx4927_pcic_reg __iomem *pci_bus_to_pcicptr(struct pci_bus *bus)\r\n{\r\nstruct pci_controller *channel = bus->sysdata;\r\nreturn get_tx4927_pcicptr(channel);\r\n}\r\nstatic int tx4927_pci_config_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nstruct tx4927_pcic_reg __iomem *pcicptr = pci_bus_to_pcicptr(bus);\r\nif (mkaddr(bus, devfn, where, pcicptr)) {\r\n*val = 0xffffffff;\r\nreturn -1;\r\n}\r\nswitch (size) {\r\ncase 1:\r\n*val = icd_readb(where & 3, pcicptr);\r\nbreak;\r\ncase 2:\r\n*val = icd_readw(where & 3, pcicptr);\r\nbreak;\r\ndefault:\r\n*val = icd_readl(pcicptr);\r\n}\r\nreturn check_abort(pcicptr);\r\n}\r\nstatic int tx4927_pci_config_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nstruct tx4927_pcic_reg __iomem *pcicptr = pci_bus_to_pcicptr(bus);\r\nif (mkaddr(bus, devfn, where, pcicptr))\r\nreturn -1;\r\nswitch (size) {\r\ncase 1:\r\nicd_writeb(val, where & 3, pcicptr);\r\nbreak;\r\ncase 2:\r\nicd_writew(val, where & 3, pcicptr);\r\nbreak;\r\ndefault:\r\nicd_writel(val, pcicptr);\r\n}\r\nreturn check_abort(pcicptr);\r\n}\r\nchar *__devinit tx4927_pcibios_setup(char *str)\r\n{\r\nunsigned long val;\r\nif (!strncmp(str, "trdyto=", 7)) {\r\nif (strict_strtoul(str + 7, 0, &val) == 0)\r\ntx4927_pci_opts.trdyto = val;\r\nreturn NULL;\r\n}\r\nif (!strncmp(str, "retryto=", 8)) {\r\nif (strict_strtoul(str + 8, 0, &val) == 0)\r\ntx4927_pci_opts.retryto = val;\r\nreturn NULL;\r\n}\r\nif (!strncmp(str, "gbwc=", 5)) {\r\nif (strict_strtoul(str + 5, 0, &val) == 0)\r\ntx4927_pci_opts.gbwc = val;\r\nreturn NULL;\r\n}\r\nreturn str;\r\n}\r\nvoid __init tx4927_pcic_setup(struct tx4927_pcic_reg __iomem *pcicptr,\r\nstruct pci_controller *channel, int extarb)\r\n{\r\nint i;\r\nunsigned long flags;\r\nset_tx4927_pcicptr(channel, pcicptr);\r\nif (!channel->pci_ops)\r\nprintk(KERN_INFO\r\n"PCIC -- DID:%04x VID:%04x RID:%02x Arbiter:%s\n",\r\n__raw_readl(&pcicptr->pciid) >> 16,\r\n__raw_readl(&pcicptr->pciid) & 0xffff,\r\n__raw_readl(&pcicptr->pciccrev) & 0xff,\r\nextarb ? "External" : "Internal");\r\nchannel->pci_ops = &tx4927_pci_ops;\r\nlocal_irq_save(flags);\r\n__raw_writel(__raw_readl(&pcicptr->pciccfg)\r\n& ~(TX4927_PCIC_PCICCFG_G2PMEN(0)\r\n| TX4927_PCIC_PCICCFG_G2PMEN(1)\r\n| TX4927_PCIC_PCICCFG_G2PMEN(2)\r\n| TX4927_PCIC_PCICCFG_G2PIOEN),\r\n&pcicptr->pciccfg);\r\n__raw_writel((channel->io_resource->end - channel->io_resource->start)\r\n>> 4,\r\n&pcicptr->g2piomask);\r\n____raw_writeq((channel->io_resource->start +\r\nchannel->io_map_base - IO_BASE) |\r\n#ifdef __BIG_ENDIAN\r\nTX4927_PCIC_G2PIOGBASE_ECHG\r\n#else\r\nTX4927_PCIC_G2PIOGBASE_BSDIS\r\n#endif\r\n, &pcicptr->g2piogbase);\r\n____raw_writeq(channel->io_resource->start - channel->io_offset,\r\n&pcicptr->g2piopbase);\r\nfor (i = 0; i < 3; i++) {\r\n__raw_writel(0, &pcicptr->g2pmmask[i]);\r\n____raw_writeq(0, &pcicptr->g2pmgbase[i]);\r\n____raw_writeq(0, &pcicptr->g2pmpbase[i]);\r\n}\r\nif (channel->mem_resource->end) {\r\n__raw_writel((channel->mem_resource->end\r\n- channel->mem_resource->start) >> 4,\r\n&pcicptr->g2pmmask[0]);\r\n____raw_writeq(channel->mem_resource->start |\r\n#ifdef __BIG_ENDIAN\r\nTX4927_PCIC_G2PMnGBASE_ECHG\r\n#else\r\nTX4927_PCIC_G2PMnGBASE_BSDIS\r\n#endif\r\n, &pcicptr->g2pmgbase[0]);\r\n____raw_writeq(channel->mem_resource->start -\r\nchannel->mem_offset,\r\n&pcicptr->g2pmpbase[0]);\r\n}\r\n__raw_writel(0, &pcicptr->p2giopbase);\r\n____raw_writeq(0, &pcicptr->p2giogbase);\r\n__raw_writel(0, &pcicptr->p2gm0plbase);\r\n__raw_writel(0, &pcicptr->p2gm0pubase);\r\n____raw_writeq(TX4927_PCIC_P2GMnGBASE_TMEMEN |\r\n#ifdef __BIG_ENDIAN\r\nTX4927_PCIC_P2GMnGBASE_TECHG\r\n#else\r\nTX4927_PCIC_P2GMnGBASE_TBSDIS\r\n#endif\r\n, &pcicptr->p2gmgbase[0]);\r\n__raw_writel(0xffffffff, &pcicptr->p2gm1plbase);\r\n__raw_writel(0xffffffff, &pcicptr->p2gm1pubase);\r\n____raw_writeq(0, &pcicptr->p2gmgbase[1]);\r\n__raw_writel(0xffffffff, &pcicptr->p2gm2pbase);\r\n____raw_writeq(0, &pcicptr->p2gmgbase[2]);\r\n__raw_writel((tx4927_pci_opts.gbwc << 16)\r\n& TX4927_PCIC_PCICCFG_GBWC_MASK,\r\n&pcicptr->pciccfg);\r\nif (channel->mem_resource->end)\r\n__raw_writel(__raw_readl(&pcicptr->pciccfg)\r\n| TX4927_PCIC_PCICCFG_G2PMEN(0),\r\n&pcicptr->pciccfg);\r\nif (channel->io_resource->end)\r\n__raw_writel(__raw_readl(&pcicptr->pciccfg)\r\n| TX4927_PCIC_PCICCFG_G2PIOEN,\r\n&pcicptr->pciccfg);\r\n__raw_writel(__raw_readl(&pcicptr->pciccfg)\r\n| TX4927_PCIC_PCICCFG_ICAEN | TX4927_PCIC_PCICCFG_TCAR,\r\n&pcicptr->pciccfg);\r\n__raw_writel(0, &pcicptr->pcicfg1);\r\n__raw_writel((__raw_readl(&pcicptr->g2ptocnt) & ~0xffff)\r\n| (tx4927_pci_opts.trdyto & 0xff)\r\n| ((tx4927_pci_opts.retryto & 0xff) << 8),\r\n&pcicptr->g2ptocnt);\r\n__raw_writel(TX4927_PCIC_PCICSTATUS_ALL, &pcicptr->pcicstatus);\r\n__raw_writel(TX4927_PCIC_PCICSTATUS_ALL, &pcicptr->pcicmask);\r\n__raw_writel(TX4927_PCIC_G2PSTATUS_ALL, &pcicptr->g2pstatus);\r\n__raw_writel(TX4927_PCIC_G2PSTATUS_ALL, &pcicptr->g2pmask);\r\n__raw_writel((__raw_readl(&pcicptr->pcistatus) & 0x0000ffff)\r\n| (TX4927_PCIC_PCISTATUS_ALL << 16),\r\n&pcicptr->pcistatus);\r\n__raw_writel(TX4927_PCIC_PCISTATUS_ALL, &pcicptr->pcimask);\r\nif (!extarb) {\r\n__raw_writel(TX4927_PCIC_PBACFG_RPBA, &pcicptr->pbacfg);\r\n__raw_writel(0, &pcicptr->pbabm);\r\n__raw_writel(TX4927_PCIC_PBACFG_PBAEN, &pcicptr->pbacfg);\r\n}\r\n__raw_writel(PCI_COMMAND_MASTER | PCI_COMMAND_MEMORY\r\n| PCI_COMMAND_PARITY | PCI_COMMAND_SERR,\r\n&pcicptr->pcistatus);\r\nlocal_irq_restore(flags);\r\nprintk(KERN_DEBUG\r\n"PCI: COMMAND=%04x,PCIMASK=%04x,"\r\n"TRDYTO=%02x,RETRYTO=%02x,GBWC=%03x\n",\r\n__raw_readl(&pcicptr->pcistatus) & 0xffff,\r\n__raw_readl(&pcicptr->pcimask) & 0xffff,\r\n__raw_readl(&pcicptr->g2ptocnt) & 0xff,\r\n(__raw_readl(&pcicptr->g2ptocnt) & 0xff00) >> 8,\r\n(__raw_readl(&pcicptr->pciccfg) >> 16) & 0xfff);\r\n}\r\nstatic void tx4927_report_pcic_status1(struct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\n__u16 pcistatus = (__u16)(__raw_readl(&pcicptr->pcistatus) >> 16);\r\n__u32 g2pstatus = __raw_readl(&pcicptr->g2pstatus);\r\n__u32 pcicstatus = __raw_readl(&pcicptr->pcicstatus);\r\nstatic struct {\r\n__u32 flag;\r\nconst char *str;\r\n} pcistat_tbl[] = {\r\n{ PCI_STATUS_DETECTED_PARITY, "DetectedParityError" },\r\n{ PCI_STATUS_SIG_SYSTEM_ERROR, "SignaledSystemError" },\r\n{ PCI_STATUS_REC_MASTER_ABORT, "ReceivedMasterAbort" },\r\n{ PCI_STATUS_REC_TARGET_ABORT, "ReceivedTargetAbort" },\r\n{ PCI_STATUS_SIG_TARGET_ABORT, "SignaledTargetAbort" },\r\n{ PCI_STATUS_PARITY, "MasterParityError" },\r\n}, g2pstat_tbl[] = {\r\n{ TX4927_PCIC_G2PSTATUS_TTOE, "TIOE" },\r\n{ TX4927_PCIC_G2PSTATUS_RTOE, "RTOE" },\r\n}, pcicstat_tbl[] = {\r\n{ TX4927_PCIC_PCICSTATUS_PME, "PME" },\r\n{ TX4927_PCIC_PCICSTATUS_TLB, "TLB" },\r\n{ TX4927_PCIC_PCICSTATUS_NIB, "NIB" },\r\n{ TX4927_PCIC_PCICSTATUS_ZIB, "ZIB" },\r\n{ TX4927_PCIC_PCICSTATUS_PERR, "PERR" },\r\n{ TX4927_PCIC_PCICSTATUS_SERR, "SERR" },\r\n{ TX4927_PCIC_PCICSTATUS_GBE, "GBE" },\r\n{ TX4927_PCIC_PCICSTATUS_IWB, "IWB" },\r\n};\r\nint i, cont;\r\nprintk(KERN_ERR "");\r\nif (pcistatus & TX4927_PCIC_PCISTATUS_ALL) {\r\nprintk(KERN_CONT "pcistat:%04x(", pcistatus);\r\nfor (i = 0, cont = 0; i < ARRAY_SIZE(pcistat_tbl); i++)\r\nif (pcistatus & pcistat_tbl[i].flag)\r\nprintk(KERN_CONT "%s%s",\r\ncont++ ? " " : "", pcistat_tbl[i].str);\r\nprintk(KERN_CONT ") ");\r\n}\r\nif (g2pstatus & TX4927_PCIC_G2PSTATUS_ALL) {\r\nprintk(KERN_CONT "g2pstatus:%08x(", g2pstatus);\r\nfor (i = 0, cont = 0; i < ARRAY_SIZE(g2pstat_tbl); i++)\r\nif (g2pstatus & g2pstat_tbl[i].flag)\r\nprintk(KERN_CONT "%s%s",\r\ncont++ ? " " : "", g2pstat_tbl[i].str);\r\nprintk(KERN_CONT ") ");\r\n}\r\nif (pcicstatus & TX4927_PCIC_PCICSTATUS_ALL) {\r\nprintk(KERN_CONT "pcicstatus:%08x(", pcicstatus);\r\nfor (i = 0, cont = 0; i < ARRAY_SIZE(pcicstat_tbl); i++)\r\nif (pcicstatus & pcicstat_tbl[i].flag)\r\nprintk(KERN_CONT "%s%s",\r\ncont++ ? " " : "", pcicstat_tbl[i].str);\r\nprintk(KERN_CONT ")");\r\n}\r\nprintk(KERN_CONT "\n");\r\n}\r\nvoid tx4927_report_pcic_status(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pcicptrs); i++) {\r\nif (pcicptrs[i].pcicptr)\r\ntx4927_report_pcic_status1(pcicptrs[i].pcicptr);\r\n}\r\n}\r\nstatic void tx4927_dump_pcic_settings1(struct tx4927_pcic_reg __iomem *pcicptr)\r\n{\r\nint i;\r\n__u32 __iomem *preg = (__u32 __iomem *)pcicptr;\r\nprintk(KERN_INFO "tx4927 pcic (0x%p) settings:", pcicptr);\r\nfor (i = 0; i < sizeof(struct tx4927_pcic_reg); i += 4, preg++) {\r\nif (i % 32 == 0) {\r\nprintk(KERN_CONT "\n");\r\nprintk(KERN_INFO "%04x:", i);\r\n}\r\nif (i == offsetof(struct tx4927_pcic_reg, g2pintack)\r\n|| i == offsetof(struct tx4927_pcic_reg, g2pspc)\r\n|| i == offsetof(struct tx4927_pcic_reg, g2pcfgadrs)\r\n|| i == offsetof(struct tx4927_pcic_reg, g2pcfgdata)) {\r\nprintk(KERN_CONT " XXXXXXXX");\r\ncontinue;\r\n}\r\nprintk(KERN_CONT " %08x", __raw_readl(preg));\r\n}\r\nprintk(KERN_CONT "\n");\r\n}\r\nvoid tx4927_dump_pcic_settings(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pcicptrs); i++) {\r\nif (pcicptrs[i].pcicptr)\r\ntx4927_dump_pcic_settings1(pcicptrs[i].pcicptr);\r\n}\r\n}\r\nirqreturn_t tx4927_pcierr_interrupt(int irq, void *dev_id)\r\n{\r\nstruct pt_regs *regs = get_irq_regs();\r\nstruct tx4927_pcic_reg __iomem *pcicptr =\r\n(struct tx4927_pcic_reg __iomem *)(unsigned long)dev_id;\r\nif (txx9_pci_err_action != TXX9_PCI_ERR_IGNORE) {\r\nprintk(KERN_WARNING "PCIERR interrupt at 0x%0*lx\n",\r\n(int)(2 * sizeof(unsigned long)), regs->cp0_epc);\r\ntx4927_report_pcic_status1(pcicptr);\r\n}\r\nif (txx9_pci_err_action != TXX9_PCI_ERR_PANIC) {\r\n__raw_writel((__raw_readl(&pcicptr->pcistatus) & 0x0000ffff)\r\n| (TX4927_PCIC_PCISTATUS_ALL << 16),\r\n&pcicptr->pcistatus);\r\n__raw_writel(TX4927_PCIC_G2PSTATUS_ALL, &pcicptr->g2pstatus);\r\n__raw_writel(TX4927_PCIC_PBASTATUS_ALL, &pcicptr->pbastatus);\r\n__raw_writel(TX4927_PCIC_PCICSTATUS_ALL, &pcicptr->pcicstatus);\r\nreturn IRQ_HANDLED;\r\n}\r\nconsole_verbose();\r\ntx4927_dump_pcic_settings1(pcicptr);\r\npanic("PCI error.");\r\n}\r\nstatic void __init tx4927_quirk_slc90e66_bridge(struct pci_dev *dev)\r\n{\r\nstruct tx4927_pcic_reg __iomem *pcicptr = pci_bus_to_pcicptr(dev->bus);\r\nif (!pcicptr)\r\nreturn;\r\nif (__raw_readl(&pcicptr->pbacfg) & TX4927_PCIC_PBACFG_PBAEN) {\r\n__raw_writel(TX4927_PCIC_PBACFG_RPBA, &pcicptr->pbacfg);\r\n__raw_writel(0x72543610, &pcicptr->pbareqport);\r\n__raw_writel(0, &pcicptr->pbabm);\r\n__raw_writel(TX4927_PCIC_PBACFG_FIXPA, &pcicptr->pbacfg);\r\n__raw_writel(TX4927_PCIC_PBACFG_FIXPA |\r\nTX4927_PCIC_PBACFG_PBAEN,\r\n&pcicptr->pbacfg);\r\nprintk(KERN_INFO "PCI: Use Fixed Park Master (REQPORT %08x)\n",\r\n__raw_readl(&pcicptr->pbareqport));\r\n}\r\n}

static void snd_tea575x_write(struct snd_tea575x *tea, unsigned int val)\r\n{\r\nu16 l;\r\nu8 data;\r\ntea->ops->set_direction(tea, 1);\r\nudelay(16);\r\nfor (l = 25; l > 0; l--) {\r\ndata = (val >> 24) & TEA575X_DATA;\r\nval <<= 1;\r\ntea->ops->set_pins(tea, data | TEA575X_WREN);\r\nudelay(2);\r\ntea->ops->set_pins(tea, data | TEA575X_WREN | TEA575X_CLK);\r\nudelay(2);\r\ntea->ops->set_pins(tea, data | TEA575X_WREN);\r\nudelay(2);\r\n}\r\nif (!tea->mute)\r\ntea->ops->set_pins(tea, 0);\r\n}\r\nstatic unsigned int snd_tea575x_read(struct snd_tea575x *tea)\r\n{\r\nu16 l, rdata;\r\nu32 data = 0;\r\ntea->ops->set_direction(tea, 0);\r\ntea->ops->set_pins(tea, 0);\r\nudelay(16);\r\nfor (l = 24; l--;) {\r\ntea->ops->set_pins(tea, TEA575X_CLK);\r\nudelay(2);\r\nif (!l)\r\ntea->tuned = tea->ops->get_pins(tea) & TEA575X_MOST ? 0 : 1;\r\ntea->ops->set_pins(tea, 0);\r\nudelay(2);\r\ndata <<= 1;\r\nrdata = tea->ops->get_pins(tea);\r\nif (!l)\r\ntea->stereo = (rdata & TEA575X_MOST) ? 0 : 1;\r\nif (rdata & TEA575X_DATA)\r\ndata++;\r\nudelay(2);\r\n}\r\nif (tea->mute)\r\ntea->ops->set_pins(tea, TEA575X_WREN);\r\nreturn data;\r\n}\r\nstatic void snd_tea575x_get_freq(struct snd_tea575x *tea)\r\n{\r\nunsigned long freq;\r\nfreq = snd_tea575x_read(tea) & TEA575X_BIT_FREQ_MASK;\r\nfreq *= 125;\r\nfreq /= 10;\r\nif (tea->tea5759)\r\nfreq += TEA575X_FMIF;\r\nelse\r\nfreq -= TEA575X_FMIF;\r\ntea->freq = freq * 16;\r\n}\r\nstatic void snd_tea575x_set_freq(struct snd_tea575x *tea)\r\n{\r\nunsigned long freq;\r\nfreq = clamp(tea->freq, FREQ_LO, FREQ_HI);\r\nfreq /= 16;\r\nif (tea->tea5759)\r\nfreq -= TEA575X_FMIF;\r\nelse\r\nfreq += TEA575X_FMIF;\r\nfreq *= 10;\r\nfreq /= 125;\r\ntea->val &= ~TEA575X_BIT_FREQ_MASK;\r\ntea->val |= freq & TEA575X_BIT_FREQ_MASK;\r\nsnd_tea575x_write(tea, tea->val);\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstruct snd_tea575x *tea = video_drvdata(file);\r\nstrlcpy(v->driver, "tea575x-tuner", sizeof(v->driver));\r\nstrlcpy(v->card, tea->card, sizeof(v->card));\r\nstrlcat(v->card, tea->tea5759 ? " TEA5759" : " TEA5757", sizeof(v->card));\r\nstrlcpy(v->bus_info, tea->bus_info, sizeof(v->bus_info));\r\nv->version = RADIO_VERSION;\r\nv->capabilities = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct snd_tea575x *tea = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nsnd_tea575x_read(tea);\r\nstrcpy(v->name, "FM");\r\nv->type = V4L2_TUNER_RADIO;\r\nv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO;\r\nv->rangelow = FREQ_LO;\r\nv->rangehigh = FREQ_HI;\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\r\nv->audmode = tea->stereo ? V4L2_TUNER_MODE_STEREO : V4L2_TUNER_MODE_MONO;\r\nv->signal = tea->tuned ? 0xffff : 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct snd_tea575x *tea = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nsnd_tea575x_get_freq(tea);\r\nf->frequency = tea->freq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct snd_tea575x *tea = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\nif (f->frequency < FREQ_LO || f->frequency > FREQ_HI)\r\nreturn -EINVAL;\r\ntea->freq = f->frequency;\r\nsnd_tea575x_set_freq(tea);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nif (a->index > 1)\r\nreturn -EINVAL;\r\nstrcpy(a->name, "Radio");\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nif (a->index != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int tea575x_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct snd_tea575x *tea = container_of(ctrl->handler, struct snd_tea575x, ctrl_handler);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\ntea->mute = ctrl->val;\r\nsnd_tea575x_set_freq(tea);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint snd_tea575x_init(struct snd_tea575x *tea)\r\n{\r\nint retval;\r\ntea->mute = 1;\r\nsnd_tea575x_write(tea, 0x55AA);\r\nif (snd_tea575x_read(tea) != 0x55AA)\r\nreturn -ENODEV;\r\ntea->val = TEA575X_BIT_BAND_FM | TEA575X_BIT_SEARCH_10_40;\r\ntea->freq = 90500 * 16;\r\nsnd_tea575x_set_freq(tea);\r\ntea->vd = tea575x_radio;\r\nvideo_set_drvdata(&tea->vd, tea);\r\nmutex_init(&tea->mutex);\r\ntea->vd.lock = &tea->mutex;\r\nv4l2_ctrl_handler_init(&tea->ctrl_handler, 1);\r\ntea->vd.ctrl_handler = &tea->ctrl_handler;\r\nv4l2_ctrl_new_std(&tea->ctrl_handler, &tea575x_ctrl_ops, V4L2_CID_AUDIO_MUTE, 0, 1, 1, 1);\r\nretval = tea->ctrl_handler.error;\r\nif (retval) {\r\nprintk(KERN_ERR "tea575x-tuner: can't initialize controls\n");\r\nv4l2_ctrl_handler_free(&tea->ctrl_handler);\r\nreturn retval;\r\n}\r\nif (tea->ext_init) {\r\nretval = tea->ext_init(tea);\r\nif (retval) {\r\nv4l2_ctrl_handler_free(&tea->ctrl_handler);\r\nreturn retval;\r\n}\r\n}\r\nv4l2_ctrl_handler_setup(&tea->ctrl_handler);\r\nretval = video_register_device(&tea->vd, VFL_TYPE_RADIO, radio_nr);\r\nif (retval) {\r\nprintk(KERN_ERR "tea575x-tuner: can't register video device!\n");\r\nv4l2_ctrl_handler_free(&tea->ctrl_handler);\r\nreturn retval;\r\n}\r\nreturn 0;\r\n}\r\nvoid snd_tea575x_exit(struct snd_tea575x *tea)\r\n{\r\nvideo_unregister_device(&tea->vd);\r\nv4l2_ctrl_handler_free(&tea->ctrl_handler);\r\n}\r\nstatic int __init alsa_tea575x_module_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit alsa_tea575x_module_exit(void)\r\n{\r\n}

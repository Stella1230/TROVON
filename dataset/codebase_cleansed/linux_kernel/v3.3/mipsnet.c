static int ioiocpy_frommipsnet(struct net_device *dev, unsigned char *kdata,\r\nint len)\r\n{\r\nfor (; len > 0; len--, kdata++)\r\n*kdata = inb(regaddr(dev, rxDataBuffer));\r\nreturn inl(regaddr(dev, rxDataCount));\r\n}\r\nstatic inline void mipsnet_put_todevice(struct net_device *dev,\r\nstruct sk_buff *skb)\r\n{\r\nint count_to_go = skb->len;\r\nchar *buf_ptr = skb->data;\r\noutl(skb->len, regaddr(dev, txDataCount));\r\nfor (; count_to_go; buf_ptr++, count_to_go--)\r\noutb(*buf_ptr, regaddr(dev, txDataBuffer));\r\ndev->stats.tx_packets++;\r\ndev->stats.tx_bytes += skb->len;\r\ndev_kfree_skb(skb);\r\n}\r\nstatic int mipsnet_xmit(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nnetif_stop_queue(dev);\r\nmipsnet_put_todevice(dev, skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic inline ssize_t mipsnet_get_fromdev(struct net_device *dev, size_t len)\r\n{\r\nstruct sk_buff *skb;\r\nif (!len)\r\nreturn len;\r\nskb = dev_alloc_skb(len + NET_IP_ALIGN);\r\nif (!skb) {\r\ndev->stats.rx_dropped++;\r\nreturn -ENOMEM;\r\n}\r\nskb_reserve(skb, NET_IP_ALIGN);\r\nif (ioiocpy_frommipsnet(dev, skb_put(skb, len), len))\r\nreturn -EFAULT;\r\nskb->protocol = eth_type_trans(skb, dev);\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\nnetif_rx(skb);\r\ndev->stats.rx_packets++;\r\ndev->stats.rx_bytes += len;\r\nreturn len;\r\n}\r\nstatic irqreturn_t mipsnet_interrupt(int irq, void *dev_id)\r\n{\r\nstruct net_device *dev = dev_id;\r\nu32 int_flags;\r\nirqreturn_t ret = IRQ_NONE;\r\nif (irq != dev->irq)\r\ngoto out_badirq;\r\nint_flags = inl(regaddr(dev, interruptControl));\r\nif (int_flags & MIPSNET_INTCTL_TESTBIT) {\r\noutl(0, regaddr(dev, interruptControl));\r\nret = IRQ_HANDLED;\r\n} else if (int_flags & MIPSNET_INTCTL_TXDONE) {\r\ndev->stats.tx_packets++;\r\nnetif_wake_queue(dev);\r\noutl(MIPSNET_INTCTL_TXDONE,\r\nregaddr(dev, interruptControl));\r\nret = IRQ_HANDLED;\r\n} else if (int_flags & MIPSNET_INTCTL_RXDONE) {\r\nmipsnet_get_fromdev(dev, inl(regaddr(dev, rxDataCount)));\r\noutl(MIPSNET_INTCTL_RXDONE, regaddr(dev, interruptControl));\r\nret = IRQ_HANDLED;\r\n}\r\nreturn ret;\r\nout_badirq:\r\nprintk(KERN_INFO "%s: %s(): irq %d for unknown device\n",\r\ndev->name, __func__, irq);\r\nreturn ret;\r\n}\r\nstatic int mipsnet_open(struct net_device *dev)\r\n{\r\nint err;\r\nerr = request_irq(dev->irq, mipsnet_interrupt,\r\nIRQF_SHARED, dev->name, (void *) dev);\r\nif (err) {\r\nrelease_region(dev->base_addr, sizeof(struct mipsnet_regs));\r\nreturn err;\r\n}\r\nnetif_start_queue(dev);\r\noutl(MIPSNET_INTCTL_TESTBIT, regaddr(dev, interruptControl));\r\nreturn 0;\r\n}\r\nstatic int mipsnet_close(struct net_device *dev)\r\n{\r\nnetif_stop_queue(dev);\r\nfree_irq(dev->irq, dev);\r\nreturn 0;\r\n}\r\nstatic void mipsnet_set_mclist(struct net_device *dev)\r\n{\r\n}\r\nstatic int __devinit mipsnet_probe(struct platform_device *dev)\r\n{\r\nstruct net_device *netdev;\r\nint err;\r\nnetdev = alloc_etherdev(0);\r\nif (!netdev) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nplatform_set_drvdata(dev, netdev);\r\nnetdev->netdev_ops = &mipsnet_netdev_ops;\r\nnetdev->base_addr = 0x4200;\r\nnetdev->irq = MIPS_CPU_IRQ_BASE + MIPSCPU_INT_MB0 +\r\ninl(regaddr(netdev, interruptInfo));\r\nif (!request_region(netdev->base_addr, sizeof(struct mipsnet_regs),\r\n"mipsnet")) {\r\nerr = -EBUSY;\r\ngoto out_free_netdev;\r\n}\r\nrandom_ether_addr(netdev->dev_addr);\r\nerr = register_netdev(netdev);\r\nif (err) {\r\nprintk(KERN_ERR "MIPSNet: failed to register netdev.\n");\r\ngoto out_free_region;\r\n}\r\nreturn 0;\r\nout_free_region:\r\nrelease_region(netdev->base_addr, sizeof(struct mipsnet_regs));\r\nout_free_netdev:\r\nfree_netdev(netdev);\r\nout:\r\nreturn err;\r\n}\r\nstatic int __devexit mipsnet_device_remove(struct platform_device *device)\r\n{\r\nstruct net_device *dev = platform_get_drvdata(device);\r\nunregister_netdev(dev);\r\nrelease_region(dev->base_addr, sizeof(struct mipsnet_regs));\r\nfree_netdev(dev);\r\nplatform_set_drvdata(device, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init mipsnet_init_module(void)\r\n{\r\nint err;\r\nprintk(KERN_INFO "MIPSNet Ethernet driver. Version: %s. "\r\n"(c)2005 MIPS Technologies, Inc.\n", MIPSNET_VERSION);\r\nerr = platform_driver_register(&mipsnet_driver);\r\nif (err)\r\nprintk(KERN_ERR "Driver registration failed\n");\r\nreturn err;\r\n}\r\nstatic void __exit mipsnet_exit_module(void)\r\n{\r\nplatform_driver_unregister(&mipsnet_driver);\r\n}

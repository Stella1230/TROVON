static inline void save_event_mask(void)\r\n{\r\nunsigned int offset;\r\noffset = LSCSA_QW_OFFSET(event_mask);\r\nregs_spill[offset].slot[0] = spu_readch(SPU_RdEventMask);\r\n}\r\nstatic inline void save_tag_mask(void)\r\n{\r\nunsigned int offset;\r\noffset = LSCSA_QW_OFFSET(tag_mask);\r\nregs_spill[offset].slot[0] = spu_readch(MFC_RdTagMask);\r\n}\r\nstatic inline void save_upper_240kb(addr64 lscsa_ea)\r\n{\r\nunsigned int ls = 16384;\r\nunsigned int list = (unsigned int)&dma_list[0];\r\nunsigned int size = sizeof(dma_list);\r\nunsigned int tag_id = 0;\r\nunsigned int cmd = 0x24;\r\nspu_writech(MFC_LSA, ls);\r\nspu_writech(MFC_EAH, lscsa_ea.ui[0]);\r\nspu_writech(MFC_EAL, list);\r\nspu_writech(MFC_Size, size);\r\nspu_writech(MFC_TagID, tag_id);\r\nspu_writech(MFC_Cmd, cmd);\r\n}\r\nstatic inline void save_fpcr(void)\r\n{\r\nunsigned int offset;\r\noffset = LSCSA_QW_OFFSET(fpcr);\r\nregs_spill[offset].v = spu_mffpscr();\r\n}\r\nstatic inline void save_decr(void)\r\n{\r\nunsigned int offset;\r\noffset = LSCSA_QW_OFFSET(decr);\r\nregs_spill[offset].slot[0] = spu_readch(SPU_RdDec);\r\n}\r\nstatic inline void save_srr0(void)\r\n{\r\nunsigned int offset;\r\noffset = LSCSA_QW_OFFSET(srr0);\r\nregs_spill[offset].slot[0] = spu_readch(SPU_RdSRR0);\r\n}\r\nstatic inline void spill_regs_to_mem(addr64 lscsa_ea)\r\n{\r\nunsigned int ls = (unsigned int)&regs_spill[0];\r\nunsigned int size = sizeof(regs_spill);\r\nunsigned int tag_id = 0;\r\nunsigned int cmd = 0x20;\r\nspu_writech(MFC_LSA, ls);\r\nspu_writech(MFC_EAH, lscsa_ea.ui[0]);\r\nspu_writech(MFC_EAL, lscsa_ea.ui[1]);\r\nspu_writech(MFC_Size, size);\r\nspu_writech(MFC_TagID, tag_id);\r\nspu_writech(MFC_Cmd, cmd);\r\n}\r\nstatic inline void enqueue_sync(addr64 lscsa_ea)\r\n{\r\nunsigned int tag_id = 0;\r\nunsigned int cmd = 0xCC;\r\nspu_writech(MFC_TagID, tag_id);\r\nspu_writech(MFC_Cmd, cmd);\r\n}\r\nstatic inline void save_complete(void)\r\n{\r\nspu_stop(SPU_SAVE_COMPLETE);\r\n}\r\nint main()\r\n{\r\naddr64 lscsa_ea;\r\nlscsa_ea.ui[0] = spu_readch(SPU_RdSigNotify1);\r\nlscsa_ea.ui[1] = spu_readch(SPU_RdSigNotify2);\r\nsave_event_mask();\r\nsave_tag_mask();\r\nset_event_mask();\r\nset_tag_mask();\r\nbuild_dma_list(lscsa_ea);\r\nsave_upper_240kb(lscsa_ea);\r\nsave_fpcr();\r\nsave_decr();\r\nsave_srr0();\r\nenqueue_putllc(lscsa_ea);\r\nspill_regs_to_mem(lscsa_ea);\r\nenqueue_sync(lscsa_ea);\r\nset_tag_update();\r\nread_tag_status();\r\nread_llar_status();\r\nsave_complete();\r\nreturn 0;\r\n}

void octeon2_usb_clocks_start(void)\r\n{\r\nu64 div;\r\nunion cvmx_uctlx_if_ena if_ena;\r\nunion cvmx_uctlx_clk_rst_ctl clk_rst_ctl;\r\nunion cvmx_uctlx_uphy_ctl_status uphy_ctl_status;\r\nunion cvmx_uctlx_uphy_portx_ctl_status port_ctl_status;\r\nint i;\r\nunsigned long io_clk_64_to_ns;\r\nmutex_lock(&octeon2_usb_clocks_mutex);\r\nocteon2_usb_clock_start_cnt++;\r\nif (octeon2_usb_clock_start_cnt != 1)\r\ngoto exit;\r\nio_clk_64_to_ns = 64000000000ull / octeon_get_io_clock_rate();\r\nif_ena.u64 = 0;\r\nif_ena.s.en = 1;\r\ncvmx_write_csr(CVMX_UCTLX_IF_ENA(0), if_ena.u64);\r\nclk_rst_ctl.u64 = cvmx_read_csr(CVMX_UCTLX_CLK_RST_CTL(0));\r\nif (clk_rst_ctl.s.hrst)\r\ngoto end_clock;\r\nclk_rst_ctl.s.p_por = 1;\r\nclk_rst_ctl.s.hrst = 0;\r\nclk_rst_ctl.s.p_prst = 0;\r\nclk_rst_ctl.s.h_clkdiv_rst = 0;\r\nclk_rst_ctl.s.o_clkdiv_rst = 0;\r\nclk_rst_ctl.s.h_clkdiv_en = 0;\r\nclk_rst_ctl.s.o_clkdiv_en = 0;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nclk_rst_ctl.s.p_refclk_sel = 0;\r\nclk_rst_ctl.s.p_refclk_div = 0;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\ndiv = octeon_get_io_clock_rate() / 130000000ull;\r\nswitch (div) {\r\ncase 0:\r\ndiv = 1;\r\nbreak;\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\nbreak;\r\ncase 5:\r\ndiv = 4;\r\nbreak;\r\ncase 6:\r\ncase 7:\r\ndiv = 6;\r\nbreak;\r\ncase 8:\r\ncase 9:\r\ncase 10:\r\ncase 11:\r\ndiv = 8;\r\nbreak;\r\ndefault:\r\ndiv = 12;\r\nbreak;\r\n}\r\nclk_rst_ctl.s.h_div = div;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nclk_rst_ctl.u64 = cvmx_read_csr(CVMX_UCTLX_CLK_RST_CTL(0));\r\nclk_rst_ctl.s.h_clkdiv_en = 1;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nclk_rst_ctl.s.h_clkdiv_rst = 1;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nndelay(io_clk_64_to_ns);\r\nclk_rst_ctl.s.p_por = 0;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nmdelay(1);\r\nuphy_ctl_status.u64 = cvmx_read_csr(CVMX_UCTLX_UPHY_CTL_STATUS(0));\r\nuphy_ctl_status.s.ate_reset = 1;\r\ncvmx_write_csr(CVMX_UCTLX_UPHY_CTL_STATUS(0), uphy_ctl_status.u64);\r\nndelay(10);\r\nuphy_ctl_status.s.ate_reset = 0;\r\ncvmx_write_csr(CVMX_UCTLX_UPHY_CTL_STATUS(0), uphy_ctl_status.u64);\r\nndelay(20);\r\nclk_rst_ctl.s.o_clkdiv_rst = 1;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nclk_rst_ctl.s.o_clkdiv_en = 1;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nndelay(io_clk_64_to_ns);\r\nclk_rst_ctl.s.p_prst = 1;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nudelay(1);\r\nclk_rst_ctl.s.hrst = 1;\r\ncvmx_write_csr(CVMX_UCTLX_CLK_RST_CTL(0), clk_rst_ctl.u64);\r\nend_clock:\r\nfor (i = 0; i <= 1; i++) {\r\nport_ctl_status.u64 =\r\ncvmx_read_csr(CVMX_UCTLX_UPHY_PORTX_CTL_STATUS(i, 0));\r\nport_ctl_status.s.txvreftune = 15;\r\nport_ctl_status.s.txrisetune = 1;\r\nport_ctl_status.s.txpreemphasistune = 1;\r\ncvmx_write_csr(CVMX_UCTLX_UPHY_PORTX_CTL_STATUS(i, 0),\r\nport_ctl_status.u64);\r\n}\r\ncvmx_write_csr(CVMX_UCTLX_EHCI_FLA(0), 0x20ull);\r\nexit:\r\nmutex_unlock(&octeon2_usb_clocks_mutex);\r\n}\r\nvoid octeon2_usb_clocks_stop(void)\r\n{\r\nmutex_lock(&octeon2_usb_clocks_mutex);\r\nocteon2_usb_clock_start_cnt--;\r\nmutex_unlock(&octeon2_usb_clocks_mutex);\r\n}

static int error_context(struct mce *m)\r\n{\r\nif (m->mcgstatus & MCG_STATUS_EIPV)\r\nreturn (m->ip && (m->cs & 3) == 3) ? IN_USER : IN_KERNEL;\r\nreturn IN_KERNEL;\r\n}\r\nint mce_severity(struct mce *m, int tolerant, char **msg)\r\n{\r\nenum context ctx = error_context(m);\r\nstruct severity *s;\r\nfor (s = severities;; s++) {\r\nif ((m->status & s->mask) != s->result)\r\ncontinue;\r\nif ((m->mcgstatus & s->mcgmask) != s->mcgres)\r\ncontinue;\r\nif (s->ser == SER_REQUIRED && !mce_ser)\r\ncontinue;\r\nif (s->ser == NO_SER && mce_ser)\r\ncontinue;\r\nif (s->context && ctx != s->context)\r\ncontinue;\r\nif (msg)\r\n*msg = s->msg;\r\ns->covered = 1;\r\nif (s->sev >= MCE_UC_SEVERITY && ctx == IN_KERNEL) {\r\nif (panic_on_oops || tolerant < 1)\r\nreturn MCE_PANIC_SEVERITY;\r\n}\r\nreturn s->sev;\r\n}\r\n}\r\nstatic void *s_start(struct seq_file *f, loff_t *pos)\r\n{\r\nif (*pos >= ARRAY_SIZE(severities))\r\nreturn NULL;\r\nreturn &severities[*pos];\r\n}\r\nstatic void *s_next(struct seq_file *f, void *data, loff_t *pos)\r\n{\r\nif (++(*pos) >= ARRAY_SIZE(severities))\r\nreturn NULL;\r\nreturn &severities[*pos];\r\n}\r\nstatic void s_stop(struct seq_file *f, void *data)\r\n{\r\n}\r\nstatic int s_show(struct seq_file *f, void *data)\r\n{\r\nstruct severity *ser = data;\r\nseq_printf(f, "%d\t%s\n", ser->covered, ser->msg);\r\nreturn 0;\r\n}\r\nstatic int severities_coverage_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &severities_seq_ops);\r\n}\r\nstatic ssize_t severities_coverage_write(struct file *file,\r\nconst char __user *ubuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(severities); i++)\r\nseverities[i].covered = 0;\r\nreturn count;\r\n}\r\nstatic int __init severities_debugfs_init(void)\r\n{\r\nstruct dentry *dmce, *fsev;\r\ndmce = mce_get_debugfs_dir();\r\nif (!dmce)\r\ngoto err_out;\r\nfsev = debugfs_create_file("severities-coverage", 0444, dmce, NULL,\r\n&severities_coverage_fops);\r\nif (!fsev)\r\ngoto err_out;\r\nreturn 0;\r\nerr_out:\r\nreturn -ENOMEM;\r\n}

static int aio_aio12_8_ai_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n;\r\nunsigned char control =\r\nADC_MODE_NORMAL |\r\n(CR_RANGE(insn->chanspec) << 3) | CR_CHAN(insn->chanspec);\r\ninb(dev->iobase + AIO12_8_STATUS);\r\nfor (n = 0; n < insn->n; n++) {\r\nint timeout = 5;\r\noutb(control, dev->iobase + AIO12_8_ADC);\r\nwhile (timeout &&\r\n!(inb(dev->iobase + AIO12_8_STATUS) & STATUS_ADC_EOC)) {\r\ntimeout--;\r\nprintk(KERN_ERR "timeout %d\n", timeout);\r\nudelay(1);\r\n}\r\nif (timeout == 0) {\r\ncomedi_error(dev, "ADC timeout");\r\nreturn -EIO;\r\n}\r\ndata[n] = inw(dev->iobase + AIO12_8_ADC) & 0x0FFF;\r\n}\r\nreturn n;\r\n}\r\nstatic int aio_aio12_8_ao_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint val = devpriv->ao_readback[CR_CHAN(insn->chanspec)];\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = val;\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_ao_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nunsigned long port = dev->iobase + AIO12_8_DAC_0 + (2 * chan);\r\noutb(0x01, dev->iobase + DAC_ENABLE);\r\nfor (i = 0; i < insn->n; i++) {\r\noutb(data[i] & 0xFF, port);\r\noutb((data[i] >> 8) & 0x0F, port + 1);\r\ndevpriv->ao_readback[chan] = data[i];\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nint iobase;\r\nstruct comedi_subdevice *s;\r\niobase = it->options[0];\r\nif (!request_region(iobase, 24, "aio_aio12_8")) {\r\nprintk(KERN_ERR "I/O port conflict");\r\nreturn -EIO;\r\n}\r\ndev->board_name = thisboard->name;\r\ndev->iobase = iobase;\r\nif (alloc_private(dev, sizeof(struct aio12_8_private)) < 0)\r\nreturn -ENOMEM;\r\nif (alloc_subdevices(dev, 3) < 0)\r\nreturn -ENOMEM;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND | SDF_DIFF;\r\ns->n_chan = 8;\r\ns->maxdata = (1 << 12) - 1;\r\ns->range_table = &range_aio_aio12_8;\r\ns->insn_read = aio_aio12_8_ai_read;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE | SDF_GROUND | SDF_DIFF;\r\ns->n_chan = 4;\r\ns->maxdata = (1 << 12) - 1;\r\ns->range_table = &range_aio_aio12_8;\r\ns->insn_read = aio_aio12_8_ao_read;\r\ns->insn_write = aio_aio12_8_ao_write;\r\ns = &dev->subdevices[2];\r\nsubdev_8255_init(dev, s, NULL, dev->iobase + AIO12_8_DIO_0);\r\nreturn 0;\r\n}\r\nstatic int aio_aio12_8_detach(struct comedi_device *dev)\r\n{\r\nsubdev_8255_cleanup(dev, &dev->subdevices[2]);\r\nif (dev->iobase)\r\nrelease_region(dev->iobase, 24);\r\nreturn 0;\r\n}\r\nstatic int __init driver_aio_aio12_8_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_aio_aio12_8);\r\n}\r\nstatic void __exit driver_aio_aio12_8_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_aio_aio12_8);\r\n}

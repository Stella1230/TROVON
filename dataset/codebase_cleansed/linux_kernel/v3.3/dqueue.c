int\r\ndiva_data_q_init(diva_um_idi_data_queue_t * q,\r\nint max_length, int max_segments)\r\n{\r\nint i;\r\nq->max_length = max_length;\r\nq->segments = max_segments;\r\nfor (i = 0; i < q->segments; i++) {\r\nq->data[i] = NULL;\r\nq->length[i] = 0;\r\n}\r\nq->read = q->write = q->count = q->segment_pending = 0;\r\nfor (i = 0; i < q->segments; i++) {\r\nif (!(q->data[i] = diva_os_malloc(0, q->max_length))) {\r\ndiva_data_q_finit(q);\r\nreturn (-1);\r\n}\r\n}\r\nreturn (0);\r\n}\r\nint diva_data_q_finit(diva_um_idi_data_queue_t * q)\r\n{\r\nint i;\r\nfor (i = 0; i < q->segments; i++) {\r\nif (q->data[i]) {\r\ndiva_os_free(0, q->data[i]);\r\n}\r\nq->data[i] = NULL;\r\nq->length[i] = 0;\r\n}\r\nq->read = q->write = q->count = q->segment_pending = 0;\r\nreturn (0);\r\n}\r\nint diva_data_q_get_max_length(const diva_um_idi_data_queue_t * q)\r\n{\r\nreturn (q->max_length);\r\n}\r\nvoid *diva_data_q_get_segment4write(diva_um_idi_data_queue_t * q)\r\n{\r\nif ((!q->segment_pending) && (q->count < q->segments)) {\r\nq->segment_pending = 1;\r\nreturn (q->data[q->write]);\r\n}\r\nreturn NULL;\r\n}\r\nvoid\r\ndiva_data_q_ack_segment4write(diva_um_idi_data_queue_t * q, int length)\r\n{\r\nif (q->segment_pending) {\r\nq->length[q->write] = length;\r\nq->count++;\r\nq->write++;\r\nif (q->write >= q->segments) {\r\nq->write = 0;\r\n}\r\nq->segment_pending = 0;\r\n}\r\n}\r\nconst void *diva_data_q_get_segment4read(const diva_um_idi_data_queue_t *\r\nq)\r\n{\r\nif (q->count) {\r\nreturn (q->data[q->read]);\r\n}\r\nreturn NULL;\r\n}\r\nint diva_data_q_get_segment_length(const diva_um_idi_data_queue_t * q)\r\n{\r\nreturn (q->length[q->read]);\r\n}\r\nvoid diva_data_q_ack_segment4read(diva_um_idi_data_queue_t * q)\r\n{\r\nif (q->count) {\r\nq->length[q->read] = 0;\r\nq->count--;\r\nq->read++;\r\nif (q->read >= q->segments) {\r\nq->read = 0;\r\n}\r\n}\r\n}

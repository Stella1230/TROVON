static char *b1pci_procinfo(struct capi_ctr *ctrl)\r\n{\r\navmctrl_info *cinfo = (avmctrl_info *)(ctrl->driverdata);\r\nif (!cinfo)\r\nreturn "";\r\nsprintf(cinfo->infobuf, "%s %s 0x%x %d r%d",\r\ncinfo->cardname[0] ? cinfo->cardname : "-",\r\ncinfo->version[VER_DRIVER] ? cinfo->version[VER_DRIVER] : "-",\r\ncinfo->card ? cinfo->card->port : 0x0,\r\ncinfo->card ? cinfo->card->irq : 0,\r\ncinfo->card ? cinfo->card->revision : 0\r\n);\r\nreturn cinfo->infobuf;\r\n}\r\nstatic int b1pci_probe(struct capicardparams *p, struct pci_dev *pdev)\r\n{\r\navmcard *card;\r\navmctrl_info *cinfo;\r\nint retval;\r\ncard = b1_alloc_card(1);\r\nif (!card) {\r\nprintk(KERN_WARNING "b1pci: no memory.\n");\r\nretval = -ENOMEM;\r\ngoto err;\r\n}\r\ncinfo = card->ctrlinfo;\r\nsprintf(card->name, "b1pci-%x", p->port);\r\ncard->port = p->port;\r\ncard->irq = p->irq;\r\ncard->cardtype = avm_b1pci;\r\nif (!request_region(card->port, AVMB1_PORTLEN, card->name)) {\r\nprintk(KERN_WARNING "b1pci: ports 0x%03x-0x%03x in use.\n",\r\ncard->port, card->port + AVMB1_PORTLEN);\r\nretval = -EBUSY;\r\ngoto err_free;\r\n}\r\nb1_reset(card->port);\r\nretval = b1_detect(card->port, card->cardtype);\r\nif (retval) {\r\nprintk(KERN_NOTICE "b1pci: NO card at 0x%x (%d)\n",\r\ncard->port, retval);\r\nretval = -ENODEV;\r\ngoto err_release_region;\r\n}\r\nb1_reset(card->port);\r\nb1_getrevision(card);\r\nretval = request_irq(card->irq, b1_interrupt, IRQF_SHARED, card->name, card);\r\nif (retval) {\r\nprintk(KERN_ERR "b1pci: unable to get IRQ %d.\n", card->irq);\r\nretval = -EBUSY;\r\ngoto err_release_region;\r\n}\r\ncinfo->capi_ctrl.driver_name = "b1pci";\r\ncinfo->capi_ctrl.driverdata = cinfo;\r\ncinfo->capi_ctrl.register_appl = b1_register_appl;\r\ncinfo->capi_ctrl.release_appl = b1_release_appl;\r\ncinfo->capi_ctrl.send_message = b1_send_message;\r\ncinfo->capi_ctrl.load_firmware = b1_load_firmware;\r\ncinfo->capi_ctrl.reset_ctr = b1_reset_ctr;\r\ncinfo->capi_ctrl.procinfo = b1pci_procinfo;\r\ncinfo->capi_ctrl.proc_fops = &b1ctl_proc_fops;\r\nstrcpy(cinfo->capi_ctrl.name, card->name);\r\ncinfo->capi_ctrl.owner = THIS_MODULE;\r\nretval = attach_capi_ctr(&cinfo->capi_ctrl);\r\nif (retval) {\r\nprintk(KERN_ERR "b1pci: attach controller failed.\n");\r\ngoto err_free_irq;\r\n}\r\nif (card->revision >= 4) {\r\nprintk(KERN_INFO "b1pci: AVM B1 PCI V4 at i/o %#x, irq %d, revision %d (no dma)\n",\r\ncard->port, card->irq, card->revision);\r\n} else {\r\nprintk(KERN_INFO "b1pci: AVM B1 PCI at i/o %#x, irq %d, revision %d\n",\r\ncard->port, card->irq, card->revision);\r\n}\r\npci_set_drvdata(pdev, card);\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(card->irq, card);\r\nerr_release_region:\r\nrelease_region(card->port, AVMB1_PORTLEN);\r\nerr_free:\r\nb1_free_card(card);\r\nerr:\r\nreturn retval;\r\n}\r\nstatic void b1pci_remove(struct pci_dev *pdev)\r\n{\r\navmcard *card = pci_get_drvdata(pdev);\r\navmctrl_info *cinfo = card->ctrlinfo;\r\nunsigned int port = card->port;\r\nb1_reset(port);\r\nb1_reset(port);\r\ndetach_capi_ctr(&cinfo->capi_ctrl);\r\nfree_irq(card->irq, card);\r\nrelease_region(card->port, AVMB1_PORTLEN);\r\nb1_free_card(card);\r\n}\r\nstatic char *b1pciv4_procinfo(struct capi_ctr *ctrl)\r\n{\r\navmctrl_info *cinfo = (avmctrl_info *)(ctrl->driverdata);\r\nif (!cinfo)\r\nreturn "";\r\nsprintf(cinfo->infobuf, "%s %s 0x%x %d 0x%lx r%d",\r\ncinfo->cardname[0] ? cinfo->cardname : "-",\r\ncinfo->version[VER_DRIVER] ? cinfo->version[VER_DRIVER] : "-",\r\ncinfo->card ? cinfo->card->port : 0x0,\r\ncinfo->card ? cinfo->card->irq : 0,\r\ncinfo->card ? cinfo->card->membase : 0,\r\ncinfo->card ? cinfo->card->revision : 0\r\n);\r\nreturn cinfo->infobuf;\r\n}\r\nstatic int b1pciv4_probe(struct capicardparams *p, struct pci_dev *pdev)\r\n{\r\navmcard *card;\r\navmctrl_info *cinfo;\r\nint retval;\r\ncard = b1_alloc_card(1);\r\nif (!card) {\r\nprintk(KERN_WARNING "b1pci: no memory.\n");\r\nretval = -ENOMEM;\r\ngoto err;\r\n}\r\ncard->dma = avmcard_dma_alloc("b1pci", pdev, 2048+128, 2048+128);\r\nif (!card->dma) {\r\nprintk(KERN_WARNING "b1pci: dma alloc.\n");\r\nretval = -ENOMEM;\r\ngoto err_free;\r\n}\r\ncinfo = card->ctrlinfo;\r\nsprintf(card->name, "b1pciv4-%x", p->port);\r\ncard->port = p->port;\r\ncard->irq = p->irq;\r\ncard->membase = p->membase;\r\ncard->cardtype = avm_b1pci;\r\nif (!request_region(card->port, AVMB1_PORTLEN, card->name)) {\r\nprintk(KERN_WARNING "b1pci: ports 0x%03x-0x%03x in use.\n",\r\ncard->port, card->port + AVMB1_PORTLEN);\r\nretval = -EBUSY;\r\ngoto err_free_dma;\r\n}\r\ncard->mbase = ioremap(card->membase, 64);\r\nif (!card->mbase) {\r\nprintk(KERN_NOTICE "b1pci: can't remap memory at 0x%lx\n",\r\ncard->membase);\r\nretval = -ENOMEM;\r\ngoto err_release_region;\r\n}\r\nb1dma_reset(card);\r\nretval = b1pciv4_detect(card);\r\nif (retval) {\r\nprintk(KERN_NOTICE "b1pci: NO card at 0x%x (%d)\n",\r\ncard->port, retval);\r\nretval = -ENODEV;\r\ngoto err_unmap;\r\n}\r\nb1dma_reset(card);\r\nb1_getrevision(card);\r\nretval = request_irq(card->irq, b1dma_interrupt, IRQF_SHARED, card->name, card);\r\nif (retval) {\r\nprintk(KERN_ERR "b1pci: unable to get IRQ %d.\n",\r\ncard->irq);\r\nretval = -EBUSY;\r\ngoto err_unmap;\r\n}\r\ncinfo->capi_ctrl.owner = THIS_MODULE;\r\ncinfo->capi_ctrl.driver_name = "b1pciv4";\r\ncinfo->capi_ctrl.driverdata = cinfo;\r\ncinfo->capi_ctrl.register_appl = b1dma_register_appl;\r\ncinfo->capi_ctrl.release_appl = b1dma_release_appl;\r\ncinfo->capi_ctrl.send_message = b1dma_send_message;\r\ncinfo->capi_ctrl.load_firmware = b1dma_load_firmware;\r\ncinfo->capi_ctrl.reset_ctr = b1dma_reset_ctr;\r\ncinfo->capi_ctrl.procinfo = b1pciv4_procinfo;\r\ncinfo->capi_ctrl.proc_fops = &b1dmactl_proc_fops;\r\nstrcpy(cinfo->capi_ctrl.name, card->name);\r\nretval = attach_capi_ctr(&cinfo->capi_ctrl);\r\nif (retval) {\r\nprintk(KERN_ERR "b1pci: attach controller failed.\n");\r\ngoto err_free_irq;\r\n}\r\ncard->cardnr = cinfo->capi_ctrl.cnr;\r\nprintk(KERN_INFO "b1pci: AVM B1 PCI V4 at i/o %#x, irq %d, mem %#lx, revision %d (dma)\n",\r\ncard->port, card->irq, card->membase, card->revision);\r\npci_set_drvdata(pdev, card);\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(card->irq, card);\r\nerr_unmap:\r\niounmap(card->mbase);\r\nerr_release_region:\r\nrelease_region(card->port, AVMB1_PORTLEN);\r\nerr_free_dma:\r\navmcard_dma_free(card->dma);\r\nerr_free:\r\nb1_free_card(card);\r\nerr:\r\nreturn retval;\r\n}\r\nstatic void b1pciv4_remove(struct pci_dev *pdev)\r\n{\r\navmcard *card = pci_get_drvdata(pdev);\r\navmctrl_info *cinfo = card->ctrlinfo;\r\nb1dma_reset(card);\r\ndetach_capi_ctr(&cinfo->capi_ctrl);\r\nfree_irq(card->irq, card);\r\niounmap(card->mbase);\r\nrelease_region(card->port, AVMB1_PORTLEN);\r\navmcard_dma_free(card->dma);\r\nb1_free_card(card);\r\n}\r\nstatic int __devinit b1pci_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct capicardparams param;\r\nint retval;\r\nif (pci_enable_device(pdev) < 0) {\r\nprintk(KERN_ERR "b1pci: failed to enable AVM-B1\n");\r\nreturn -ENODEV;\r\n}\r\nparam.irq = pdev->irq;\r\nif (pci_resource_start(pdev, 2)) {\r\n#ifdef CONFIG_ISDN_DRV_AVMB1_B1PCIV4\r\npci_set_master(pdev);\r\n#endif\r\nparam.membase = pci_resource_start(pdev, 0);\r\nparam.port = pci_resource_start(pdev, 2);\r\nprintk(KERN_INFO "b1pci: PCI BIOS reports AVM-B1 V4 at i/o %#x, irq %d, mem %#x\n",\r\nparam.port, param.irq, param.membase);\r\n#ifdef CONFIG_ISDN_DRV_AVMB1_B1PCIV4\r\nretval = b1pciv4_probe(&param, pdev);\r\n#else\r\nretval = b1pci_probe(&param, pdev);\r\n#endif\r\nif (retval != 0) {\r\nprintk(KERN_ERR "b1pci: no AVM-B1 V4 at i/o %#x, irq %d, mem %#x detected\n",\r\nparam.port, param.irq, param.membase);\r\n}\r\n} else {\r\nparam.membase = 0;\r\nparam.port = pci_resource_start(pdev, 1);\r\nprintk(KERN_INFO "b1pci: PCI BIOS reports AVM-B1 at i/o %#x, irq %d\n",\r\nparam.port, param.irq);\r\nretval = b1pci_probe(&param, pdev);\r\nif (retval != 0) {\r\nprintk(KERN_ERR "b1pci: no AVM-B1 at i/o %#x, irq %d detected\n",\r\nparam.port, param.irq);\r\n}\r\n}\r\nreturn retval;\r\n}\r\nstatic void __devexit b1pci_pci_remove(struct pci_dev *pdev)\r\n{\r\n#ifdef CONFIG_ISDN_DRV_AVMB1_B1PCIV4\r\navmcard *card = pci_get_drvdata(pdev);\r\nif (card->dma)\r\nb1pciv4_remove(pdev);\r\nelse\r\nb1pci_remove(pdev);\r\n#else\r\nb1pci_remove(pdev);\r\n#endif\r\n}\r\nstatic int __init b1pci_init(void)\r\n{\r\nchar *p;\r\nchar rev[32];\r\nint err;\r\nif ((p = strchr(revision, ':')) != NULL && p[1]) {\r\nstrlcpy(rev, p + 2, 32);\r\nif ((p = strchr(rev, '$')) != NULL && p > rev)\r\n*(p-1) = 0;\r\n} else\r\nstrcpy(rev, "1.0");\r\nerr = pci_register_driver(&b1pci_pci_driver);\r\nif (!err) {\r\nstrlcpy(capi_driver_b1pci.revision, rev, 32);\r\nregister_capi_driver(&capi_driver_b1pci);\r\n#ifdef CONFIG_ISDN_DRV_AVMB1_B1PCIV4\r\nstrlcpy(capi_driver_b1pciv4.revision, rev, 32);\r\nregister_capi_driver(&capi_driver_b1pciv4);\r\n#endif\r\nprintk(KERN_INFO "b1pci: revision %s\n", rev);\r\n}\r\nreturn err;\r\n}\r\nstatic void __exit b1pci_exit(void)\r\n{\r\nunregister_capi_driver(&capi_driver_b1pci);\r\n#ifdef CONFIG_ISDN_DRV_AVMB1_B1PCIV4\r\nunregister_capi_driver(&capi_driver_b1pciv4);\r\n#endif\r\npci_unregister_driver(&b1pci_pci_driver);\r\n}

void kvmppc_core_load_host_debugstate(struct kvm_vcpu *vcpu)\r\n{\r\n}\r\nvoid kvmppc_core_load_guest_debugstate(struct kvm_vcpu *vcpu)\r\n{\r\n}\r\nvoid kvmppc_core_vcpu_load(struct kvm_vcpu *vcpu, int cpu)\r\n{\r\nkvmppc_e500_tlb_load(vcpu, cpu);\r\n}\r\nvoid kvmppc_core_vcpu_put(struct kvm_vcpu *vcpu)\r\n{\r\nkvmppc_e500_tlb_put(vcpu);\r\n#ifdef CONFIG_SPE\r\nif (vcpu->arch.shadow_msr & MSR_SPE)\r\nkvmppc_vcpu_disable_spe(vcpu);\r\n#endif\r\n}\r\nint kvmppc_core_check_processor_compat(void)\r\n{\r\nint r;\r\nif (strcmp(cur_cpu_spec->cpu_name, "e500v2") == 0)\r\nr = 0;\r\nelse\r\nr = -ENOTSUPP;\r\nreturn r;\r\n}\r\nint kvmppc_core_vcpu_setup(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nkvmppc_e500_tlb_setup(vcpu_e500);\r\nvcpu->arch.pvr = mfspr(SPRN_PVR);\r\nvcpu_e500->svr = mfspr(SPRN_SVR);\r\nvcpu->vcpu_id = 0;\r\nvcpu->arch.cpu_type = KVM_CPU_E500V2;\r\nreturn 0;\r\n}\r\nint kvmppc_core_vcpu_translate(struct kvm_vcpu *vcpu,\r\nstruct kvm_translation *tr)\r\n{\r\nint index;\r\ngva_t eaddr;\r\nu8 pid;\r\nu8 as;\r\neaddr = tr->linear_address;\r\npid = (tr->linear_address >> 32) & 0xff;\r\nas = (tr->linear_address >> 40) & 0x1;\r\nindex = kvmppc_e500_tlb_search(vcpu, eaddr, pid, as);\r\nif (index < 0) {\r\ntr->valid = 0;\r\nreturn 0;\r\n}\r\ntr->physical_address = kvmppc_mmu_xlate(vcpu, index, eaddr);\r\ntr->valid = 1;\r\nreturn 0;\r\n}\r\nvoid kvmppc_core_get_sregs(struct kvm_vcpu *vcpu, struct kvm_sregs *sregs)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nsregs->u.e.features |= KVM_SREGS_E_ARCH206_MMU | KVM_SREGS_E_SPE |\r\nKVM_SREGS_E_PM;\r\nsregs->u.e.impl_id = KVM_SREGS_E_IMPL_FSL;\r\nsregs->u.e.impl.fsl.features = 0;\r\nsregs->u.e.impl.fsl.svr = vcpu_e500->svr;\r\nsregs->u.e.impl.fsl.hid0 = vcpu_e500->hid0;\r\nsregs->u.e.impl.fsl.mcar = vcpu_e500->mcar;\r\nsregs->u.e.mas0 = vcpu_e500->mas0;\r\nsregs->u.e.mas1 = vcpu_e500->mas1;\r\nsregs->u.e.mas2 = vcpu_e500->mas2;\r\nsregs->u.e.mas7_3 = ((u64)vcpu_e500->mas7 << 32) | vcpu_e500->mas3;\r\nsregs->u.e.mas4 = vcpu_e500->mas4;\r\nsregs->u.e.mas6 = vcpu_e500->mas6;\r\nsregs->u.e.mmucfg = mfspr(SPRN_MMUCFG);\r\nsregs->u.e.tlbcfg[0] = vcpu_e500->tlb0cfg;\r\nsregs->u.e.tlbcfg[1] = vcpu_e500->tlb1cfg;\r\nsregs->u.e.tlbcfg[2] = 0;\r\nsregs->u.e.tlbcfg[3] = 0;\r\nsregs->u.e.ivor_high[0] = vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_UNAVAIL];\r\nsregs->u.e.ivor_high[1] = vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_DATA];\r\nsregs->u.e.ivor_high[2] = vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_ROUND];\r\nsregs->u.e.ivor_high[3] =\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR];\r\nkvmppc_get_sregs_ivor(vcpu, sregs);\r\n}\r\nint kvmppc_core_set_sregs(struct kvm_vcpu *vcpu, struct kvm_sregs *sregs)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nif (sregs->u.e.impl_id == KVM_SREGS_E_IMPL_FSL) {\r\nvcpu_e500->svr = sregs->u.e.impl.fsl.svr;\r\nvcpu_e500->hid0 = sregs->u.e.impl.fsl.hid0;\r\nvcpu_e500->mcar = sregs->u.e.impl.fsl.mcar;\r\n}\r\nif (sregs->u.e.features & KVM_SREGS_E_ARCH206_MMU) {\r\nvcpu_e500->mas0 = sregs->u.e.mas0;\r\nvcpu_e500->mas1 = sregs->u.e.mas1;\r\nvcpu_e500->mas2 = sregs->u.e.mas2;\r\nvcpu_e500->mas7 = sregs->u.e.mas7_3 >> 32;\r\nvcpu_e500->mas3 = (u32)sregs->u.e.mas7_3;\r\nvcpu_e500->mas4 = sregs->u.e.mas4;\r\nvcpu_e500->mas6 = sregs->u.e.mas6;\r\n}\r\nif (!(sregs->u.e.features & KVM_SREGS_E_IVOR))\r\nreturn 0;\r\nif (sregs->u.e.features & KVM_SREGS_E_SPE) {\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_UNAVAIL] =\r\nsregs->u.e.ivor_high[0];\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_DATA] =\r\nsregs->u.e.ivor_high[1];\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_ROUND] =\r\nsregs->u.e.ivor_high[2];\r\n}\r\nif (sregs->u.e.features & KVM_SREGS_E_PM) {\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR] =\r\nsregs->u.e.ivor_high[3];\r\n}\r\nreturn kvmppc_set_sregs_ivor(vcpu, sregs);\r\n}\r\nstruct kvm_vcpu *kvmppc_core_vcpu_create(struct kvm *kvm, unsigned int id)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500;\r\nstruct kvm_vcpu *vcpu;\r\nint err;\r\nvcpu_e500 = kmem_cache_zalloc(kvm_vcpu_cache, GFP_KERNEL);\r\nif (!vcpu_e500) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nvcpu = &vcpu_e500->vcpu;\r\nerr = kvm_vcpu_init(vcpu, kvm, id);\r\nif (err)\r\ngoto free_vcpu;\r\nerr = kvmppc_e500_tlb_init(vcpu_e500);\r\nif (err)\r\ngoto uninit_vcpu;\r\nvcpu->arch.shared = (void*)__get_free_page(GFP_KERNEL|__GFP_ZERO);\r\nif (!vcpu->arch.shared)\r\ngoto uninit_tlb;\r\nreturn vcpu;\r\nuninit_tlb:\r\nkvmppc_e500_tlb_uninit(vcpu_e500);\r\nuninit_vcpu:\r\nkvm_vcpu_uninit(vcpu);\r\nfree_vcpu:\r\nkmem_cache_free(kvm_vcpu_cache, vcpu_e500);\r\nout:\r\nreturn ERR_PTR(err);\r\n}\r\nvoid kvmppc_core_vcpu_free(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nfree_page((unsigned long)vcpu->arch.shared);\r\nkvm_vcpu_uninit(vcpu);\r\nkvmppc_e500_tlb_uninit(vcpu_e500);\r\nkmem_cache_free(kvm_vcpu_cache, vcpu_e500);\r\n}\r\nstatic int __init kvmppc_e500_init(void)\r\n{\r\nint r, i;\r\nunsigned long ivor[3];\r\nunsigned long max_ivor = 0;\r\nr = kvmppc_booke_init();\r\nif (r)\r\nreturn r;\r\nivor[0] = mfspr(SPRN_IVOR32);\r\nivor[1] = mfspr(SPRN_IVOR33);\r\nivor[2] = mfspr(SPRN_IVOR34);\r\nfor (i = 0; i < 3; i++) {\r\nif (ivor[i] > max_ivor)\r\nmax_ivor = ivor[i];\r\nmemcpy((void *)kvmppc_booke_handlers + ivor[i],\r\nkvmppc_handlers_start + (i + 16) * kvmppc_handler_len,\r\nkvmppc_handler_len);\r\n}\r\nflush_icache_range(kvmppc_booke_handlers,\r\nkvmppc_booke_handlers + max_ivor + kvmppc_handler_len);\r\nreturn kvm_init(NULL, sizeof(struct kvmppc_vcpu_e500), 0, THIS_MODULE);\r\n}\r\nstatic void __exit kvmppc_e500_exit(void)\r\n{\r\nkvmppc_booke_exit();\r\n}

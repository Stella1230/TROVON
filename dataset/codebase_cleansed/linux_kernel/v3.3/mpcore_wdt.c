static irqreturn_t mpcore_wdt_fire(int irq, void *arg)\r\n{\r\nstruct mpcore_wdt *wdt = arg;\r\nif (readl(wdt->base + TWD_WDOG_INTSTAT)) {\r\ndev_printk(KERN_CRIT, wdt->dev,\r\n"Triggered - Reboot ignored.\n");\r\nwritel(1, wdt->base + TWD_WDOG_INTSTAT);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic void mpcore_wdt_keepalive(struct mpcore_wdt *wdt)\r\n{\r\nunsigned long count;\r\nspin_lock(&wdt_lock);\r\ncount = __raw_readl(wdt->base + TWD_WDOG_COUNTER);\r\ncount = (0xFFFFFFFFU - count) * (HZ / 5);\r\ncount = (count / 256) * mpcore_margin;\r\nwritel(count + wdt->perturb, wdt->base + TWD_WDOG_LOAD);\r\nwdt->perturb = wdt->perturb ? 0 : 1;\r\nspin_unlock(&wdt_lock);\r\n}\r\nstatic void mpcore_wdt_stop(struct mpcore_wdt *wdt)\r\n{\r\nspin_lock(&wdt_lock);\r\nwritel(0x12345678, wdt->base + TWD_WDOG_DISABLE);\r\nwritel(0x87654321, wdt->base + TWD_WDOG_DISABLE);\r\nwritel(0x0, wdt->base + TWD_WDOG_CONTROL);\r\nspin_unlock(&wdt_lock);\r\n}\r\nstatic void mpcore_wdt_start(struct mpcore_wdt *wdt)\r\n{\r\ndev_printk(KERN_INFO, wdt->dev, "enabling watchdog.\n");\r\nmpcore_wdt_keepalive(wdt);\r\nif (mpcore_noboot) {\r\nwritel(0x0000FF01, wdt->base + TWD_WDOG_CONTROL);\r\n} else {\r\nwritel(0x0000FF09, wdt->base + TWD_WDOG_CONTROL);\r\n}\r\n}\r\nstatic int mpcore_wdt_set_heartbeat(int t)\r\n{\r\nif (t < 0x0001 || t > 0xFFFF)\r\nreturn -EINVAL;\r\nmpcore_margin = t;\r\nreturn 0;\r\n}\r\nstatic int mpcore_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nstruct mpcore_wdt *wdt = platform_get_drvdata(mpcore_wdt_dev);\r\nif (test_and_set_bit(0, &wdt->timer_alive))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nfile->private_data = wdt;\r\nmpcore_wdt_start(wdt);\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int mpcore_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nstruct mpcore_wdt *wdt = file->private_data;\r\nif (wdt->expect_close == 42)\r\nmpcore_wdt_stop(wdt);\r\nelse {\r\ndev_printk(KERN_CRIT, wdt->dev,\r\n"unexpected close, not stopping watchdog!\n");\r\nmpcore_wdt_keepalive(wdt);\r\n}\r\nclear_bit(0, &wdt->timer_alive);\r\nwdt->expect_close = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t mpcore_wdt_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nstruct mpcore_wdt *wdt = file->private_data;\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nwdt->expect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nwdt->expect_close = 42;\r\n}\r\n}\r\nmpcore_wdt_keepalive(wdt);\r\n}\r\nreturn len;\r\n}\r\nstatic long mpcore_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nstruct mpcore_wdt *wdt = file->private_data;\r\nint ret;\r\nunion {\r\nstruct watchdog_info ident;\r\nint i;\r\n} uarg;\r\nif (_IOC_DIR(cmd) && _IOC_SIZE(cmd) > sizeof(uarg))\r\nreturn -ENOTTY;\r\nif (_IOC_DIR(cmd) & _IOC_WRITE) {\r\nret = copy_from_user(&uarg, (void __user *)arg, _IOC_SIZE(cmd));\r\nif (ret)\r\nreturn -EFAULT;\r\n}\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nuarg.ident = ident;\r\nret = 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nuarg.i = 0;\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETOPTIONS:\r\nret = -EINVAL;\r\nif (uarg.i & WDIOS_DISABLECARD) {\r\nmpcore_wdt_stop(wdt);\r\nret = 0;\r\n}\r\nif (uarg.i & WDIOS_ENABLECARD) {\r\nmpcore_wdt_start(wdt);\r\nret = 0;\r\n}\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nmpcore_wdt_keepalive(wdt);\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = mpcore_wdt_set_heartbeat(uarg.i);\r\nif (ret)\r\nbreak;\r\nmpcore_wdt_keepalive(wdt);\r\ncase WDIOC_GETTIMEOUT:\r\nuarg.i = mpcore_margin;\r\nret = 0;\r\nbreak;\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nif (ret == 0 && _IOC_DIR(cmd) & _IOC_READ) {\r\nret = copy_to_user((void __user *)arg, &uarg, _IOC_SIZE(cmd));\r\nif (ret)\r\nret = -EFAULT;\r\n}\r\nreturn ret;\r\n}\r\nstatic void mpcore_wdt_shutdown(struct platform_device *dev)\r\n{\r\nstruct mpcore_wdt *wdt = platform_get_drvdata(dev);\r\nif (system_state == SYSTEM_RESTART || system_state == SYSTEM_HALT)\r\nmpcore_wdt_stop(wdt);\r\n}\r\nstatic int __devinit mpcore_wdt_probe(struct platform_device *dev)\r\n{\r\nstruct mpcore_wdt *wdt;\r\nstruct resource *res;\r\nint ret;\r\nif (dev->id != -1)\r\nreturn -ENODEV;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nret = -ENODEV;\r\ngoto err_out;\r\n}\r\nwdt = kzalloc(sizeof(struct mpcore_wdt), GFP_KERNEL);\r\nif (!wdt) {\r\nret = -ENOMEM;\r\ngoto err_out;\r\n}\r\nwdt->dev = &dev->dev;\r\nwdt->irq = platform_get_irq(dev, 0);\r\nif (wdt->irq < 0) {\r\nret = -ENXIO;\r\ngoto err_free;\r\n}\r\nwdt->base = ioremap(res->start, resource_size(res));\r\nif (!wdt->base) {\r\nret = -ENOMEM;\r\ngoto err_free;\r\n}\r\nmpcore_wdt_miscdev.parent = &dev->dev;\r\nret = misc_register(&mpcore_wdt_miscdev);\r\nif (ret) {\r\ndev_printk(KERN_ERR, wdt->dev,\r\n"cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, ret);\r\ngoto err_misc;\r\n}\r\nret = request_irq(wdt->irq, mpcore_wdt_fire, 0, "mpcore_wdt", wdt);\r\nif (ret) {\r\ndev_printk(KERN_ERR, wdt->dev,\r\n"cannot register IRQ%d for watchdog\n", wdt->irq);\r\ngoto err_irq;\r\n}\r\nmpcore_wdt_stop(wdt);\r\nplatform_set_drvdata(dev, wdt);\r\nmpcore_wdt_dev = dev;\r\nreturn 0;\r\nerr_irq:\r\nmisc_deregister(&mpcore_wdt_miscdev);\r\nerr_misc:\r\niounmap(wdt->base);\r\nerr_free:\r\nkfree(wdt);\r\nerr_out:\r\nreturn ret;\r\n}\r\nstatic int __devexit mpcore_wdt_remove(struct platform_device *dev)\r\n{\r\nstruct mpcore_wdt *wdt = platform_get_drvdata(dev);\r\nplatform_set_drvdata(dev, NULL);\r\nmisc_deregister(&mpcore_wdt_miscdev);\r\nmpcore_wdt_dev = NULL;\r\nfree_irq(wdt->irq, wdt);\r\niounmap(wdt->base);\r\nkfree(wdt);\r\nreturn 0;\r\n}\r\nstatic int mpcore_wdt_suspend(struct platform_device *dev, pm_message_t msg)\r\n{\r\nstruct mpcore_wdt *wdt = platform_get_drvdata(dev);\r\nmpcore_wdt_stop(wdt);\r\nreturn 0;\r\n}\r\nstatic int mpcore_wdt_resume(struct platform_device *dev)\r\n{\r\nstruct mpcore_wdt *wdt = platform_get_drvdata(dev);\r\nif (test_bit(0, &wdt->timer_alive))\r\nmpcore_wdt_start(wdt);\r\nreturn 0;\r\n}\r\nstatic int __init mpcore_wdt_init(void)\r\n{\r\nif (mpcore_wdt_set_heartbeat(mpcore_margin)) {\r\nmpcore_wdt_set_heartbeat(TIMER_MARGIN);\r\nprintk(KERN_INFO "mpcore_margin value must be 0 < mpcore_margin < 65536, using %d\n",\r\nTIMER_MARGIN);\r\n}\r\nprintk(banner, mpcore_noboot, mpcore_margin, nowayout);\r\nreturn platform_driver_register(&mpcore_wdt_driver);\r\n}\r\nstatic void __exit mpcore_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&mpcore_wdt_driver);\r\n}

static inline struct iw_spy_data *get_spydata(struct net_device *dev)\r\n{\r\nif (dev->wireless_data)\r\nreturn dev->wireless_data->spy_data;\r\nreturn NULL;\r\n}\r\nint iw_handler_set_spy(struct net_device * dev,\r\nstruct iw_request_info * info,\r\nunion iwreq_data * wrqu,\r\nchar * extra)\r\n{\r\nstruct iw_spy_data * spydata = get_spydata(dev);\r\nstruct sockaddr * address = (struct sockaddr *) extra;\r\nif (!spydata)\r\nreturn -EOPNOTSUPP;\r\nspydata->spy_number = 0;\r\nsmp_wmb();\r\nif (wrqu->data.length > 0) {\r\nint i;\r\nfor (i = 0; i < wrqu->data.length; i++)\r\nmemcpy(spydata->spy_address[i], address[i].sa_data,\r\nETH_ALEN);\r\nmemset(spydata->spy_stat, 0,\r\nsizeof(struct iw_quality) * IW_MAX_SPY);\r\n}\r\nsmp_wmb();\r\nspydata->spy_number = wrqu->data.length;\r\nreturn 0;\r\n}\r\nint iw_handler_get_spy(struct net_device * dev,\r\nstruct iw_request_info * info,\r\nunion iwreq_data * wrqu,\r\nchar * extra)\r\n{\r\nstruct iw_spy_data * spydata = get_spydata(dev);\r\nstruct sockaddr * address = (struct sockaddr *) extra;\r\nint i;\r\nif (!spydata)\r\nreturn -EOPNOTSUPP;\r\nwrqu->data.length = spydata->spy_number;\r\nfor (i = 0; i < spydata->spy_number; i++) {\r\nmemcpy(address[i].sa_data, spydata->spy_address[i], ETH_ALEN);\r\naddress[i].sa_family = AF_UNIX;\r\n}\r\nif (spydata->spy_number > 0)\r\nmemcpy(extra + (sizeof(struct sockaddr) *spydata->spy_number),\r\nspydata->spy_stat,\r\nsizeof(struct iw_quality) * spydata->spy_number);\r\nfor (i = 0; i < spydata->spy_number; i++)\r\nspydata->spy_stat[i].updated &= ~IW_QUAL_ALL_UPDATED;\r\nreturn 0;\r\n}\r\nint iw_handler_set_thrspy(struct net_device * dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data * wrqu,\r\nchar * extra)\r\n{\r\nstruct iw_spy_data * spydata = get_spydata(dev);\r\nstruct iw_thrspy * threshold = (struct iw_thrspy *) extra;\r\nif (!spydata)\r\nreturn -EOPNOTSUPP;\r\nmemcpy(&(spydata->spy_thr_low), &(threshold->low),\r\n2 * sizeof(struct iw_quality));\r\nmemset(spydata->spy_thr_under, '\0', sizeof(spydata->spy_thr_under));\r\nreturn 0;\r\n}\r\nint iw_handler_get_thrspy(struct net_device * dev,\r\nstruct iw_request_info *info,\r\nunion iwreq_data * wrqu,\r\nchar * extra)\r\n{\r\nstruct iw_spy_data * spydata = get_spydata(dev);\r\nstruct iw_thrspy * threshold = (struct iw_thrspy *) extra;\r\nif (!spydata)\r\nreturn -EOPNOTSUPP;\r\nmemcpy(&(threshold->low), &(spydata->spy_thr_low),\r\n2 * sizeof(struct iw_quality));\r\nreturn 0;\r\n}\r\nstatic void iw_send_thrspy_event(struct net_device * dev,\r\nstruct iw_spy_data * spydata,\r\nunsigned char * address,\r\nstruct iw_quality * wstats)\r\n{\r\nunion iwreq_data wrqu;\r\nstruct iw_thrspy threshold;\r\nwrqu.data.length = 1;\r\nwrqu.data.flags = 0;\r\nmemcpy(threshold.addr.sa_data, address, ETH_ALEN);\r\nthreshold.addr.sa_family = ARPHRD_ETHER;\r\nmemcpy(&(threshold.qual), wstats, sizeof(struct iw_quality));\r\nmemcpy(&(threshold.low), &(spydata->spy_thr_low),\r\n2 * sizeof(struct iw_quality));\r\nwireless_send_event(dev, SIOCGIWTHRSPY, &wrqu, (char *) &threshold);\r\n}\r\nvoid wireless_spy_update(struct net_device * dev,\r\nunsigned char * address,\r\nstruct iw_quality * wstats)\r\n{\r\nstruct iw_spy_data * spydata = get_spydata(dev);\r\nint i;\r\nint match = -1;\r\nif (!spydata)\r\nreturn;\r\nfor (i = 0; i < spydata->spy_number; i++)\r\nif (!compare_ether_addr(address, spydata->spy_address[i])) {\r\nmemcpy(&(spydata->spy_stat[i]), wstats,\r\nsizeof(struct iw_quality));\r\nmatch = i;\r\n}\r\nif (match >= 0) {\r\nif (spydata->spy_thr_under[match]) {\r\nif (wstats->level > spydata->spy_thr_high.level) {\r\nspydata->spy_thr_under[match] = 0;\r\niw_send_thrspy_event(dev, spydata,\r\naddress, wstats);\r\n}\r\n} else {\r\nif (wstats->level < spydata->spy_thr_low.level) {\r\nspydata->spy_thr_under[match] = 1;\r\niw_send_thrspy_event(dev, spydata,\r\naddress, wstats);\r\n}\r\n}\r\n}\r\n}

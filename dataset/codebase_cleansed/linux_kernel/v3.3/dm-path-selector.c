static struct ps_internal *__find_path_selector_type(const char *name)\r\n{\r\nstruct ps_internal *psi;\r\nlist_for_each_entry(psi, &_path_selectors, list) {\r\nif (!strcmp(name, psi->pst.name))\r\nreturn psi;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct ps_internal *get_path_selector(const char *name)\r\n{\r\nstruct ps_internal *psi;\r\ndown_read(&_ps_lock);\r\npsi = __find_path_selector_type(name);\r\nif (psi && !try_module_get(psi->pst.module))\r\npsi = NULL;\r\nup_read(&_ps_lock);\r\nreturn psi;\r\n}\r\nstruct path_selector_type *dm_get_path_selector(const char *name)\r\n{\r\nstruct ps_internal *psi;\r\nif (!name)\r\nreturn NULL;\r\npsi = get_path_selector(name);\r\nif (!psi) {\r\nrequest_module("dm-%s", name);\r\npsi = get_path_selector(name);\r\n}\r\nreturn psi ? &psi->pst : NULL;\r\n}\r\nvoid dm_put_path_selector(struct path_selector_type *pst)\r\n{\r\nstruct ps_internal *psi;\r\nif (!pst)\r\nreturn;\r\ndown_read(&_ps_lock);\r\npsi = __find_path_selector_type(pst->name);\r\nif (!psi)\r\ngoto out;\r\nmodule_put(psi->pst.module);\r\nout:\r\nup_read(&_ps_lock);\r\n}\r\nstatic struct ps_internal *_alloc_path_selector(struct path_selector_type *pst)\r\n{\r\nstruct ps_internal *psi = kzalloc(sizeof(*psi), GFP_KERNEL);\r\nif (psi)\r\npsi->pst = *pst;\r\nreturn psi;\r\n}\r\nint dm_register_path_selector(struct path_selector_type *pst)\r\n{\r\nint r = 0;\r\nstruct ps_internal *psi = _alloc_path_selector(pst);\r\nif (!psi)\r\nreturn -ENOMEM;\r\ndown_write(&_ps_lock);\r\nif (__find_path_selector_type(pst->name)) {\r\nkfree(psi);\r\nr = -EEXIST;\r\n} else\r\nlist_add(&psi->list, &_path_selectors);\r\nup_write(&_ps_lock);\r\nreturn r;\r\n}\r\nint dm_unregister_path_selector(struct path_selector_type *pst)\r\n{\r\nstruct ps_internal *psi;\r\ndown_write(&_ps_lock);\r\npsi = __find_path_selector_type(pst->name);\r\nif (!psi) {\r\nup_write(&_ps_lock);\r\nreturn -EINVAL;\r\n}\r\nlist_del(&psi->list);\r\nup_write(&_ps_lock);\r\nkfree(psi);\r\nreturn 0;\r\n}

static int atiixp_cable_detect(struct ata_port *ap)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu8 udma;\r\npci_read_config_byte(pdev, ATIIXP_IDE_UDMA_MODE + ap->port_no, &udma);\r\nif ((udma & 0x07) >= 0x04 || (udma & 0x70) >= 0x40)\r\nreturn ATA_CBL_PATA80;\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic int atiixp_prereset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstatic const struct pci_bits atiixp_enable_bits[] = {\r\n{ 0x48, 1, 0x01, 0x00 },\r\n{ 0x48, 1, 0x08, 0x00 }\r\n};\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nif (!pci_test_config_bits(pdev, &atiixp_enable_bits[ap->port_no]))\r\nreturn -ENOENT;\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic void atiixp_set_pio_timing(struct ata_port *ap, struct ata_device *adev, int pio)\r\n{\r\nstatic u8 pio_timings[5] = { 0x5D, 0x47, 0x34, 0x22, 0x20 };\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dn = 2 * ap->port_no + adev->devno;\r\nint timing_shift = (16 * ap->port_no) + 8 * (adev->devno ^ 1);\r\nu32 pio_timing_data;\r\nu16 pio_mode_data;\r\npci_read_config_word(pdev, ATIIXP_IDE_PIO_MODE, &pio_mode_data);\r\npio_mode_data &= ~(0x7 << (4 * dn));\r\npio_mode_data |= pio << (4 * dn);\r\npci_write_config_word(pdev, ATIIXP_IDE_PIO_MODE, pio_mode_data);\r\npci_read_config_dword(pdev, ATIIXP_IDE_PIO_TIMING, &pio_timing_data);\r\npio_timing_data &= ~(0xFF << timing_shift);\r\npio_timing_data |= (pio_timings[pio] << timing_shift);\r\npci_write_config_dword(pdev, ATIIXP_IDE_PIO_TIMING, pio_timing_data);\r\n}\r\nstatic void atiixp_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&atiixp_lock, flags);\r\natiixp_set_pio_timing(ap, adev, adev->pio_mode - XFER_PIO_0);\r\nspin_unlock_irqrestore(&atiixp_lock, flags);\r\n}\r\nstatic void atiixp_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic u8 mwdma_timings[5] = { 0x77, 0x21, 0x20 };\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dma = adev->dma_mode;\r\nint dn = 2 * ap->port_no + adev->devno;\r\nint wanted_pio;\r\nunsigned long flags;\r\nspin_lock_irqsave(&atiixp_lock, flags);\r\nif (adev->dma_mode >= XFER_UDMA_0) {\r\nu16 udma_mode_data;\r\ndma -= XFER_UDMA_0;\r\npci_read_config_word(pdev, ATIIXP_IDE_UDMA_MODE, &udma_mode_data);\r\nudma_mode_data &= ~(0x7 << (4 * dn));\r\nudma_mode_data |= dma << (4 * dn);\r\npci_write_config_word(pdev, ATIIXP_IDE_UDMA_MODE, udma_mode_data);\r\n} else {\r\nint timing_shift = (16 * ap->port_no) + 8 * (adev->devno ^ 1);\r\nu32 mwdma_timing_data;\r\ndma -= XFER_MW_DMA_0;\r\npci_read_config_dword(pdev, ATIIXP_IDE_MWDMA_TIMING,\r\n&mwdma_timing_data);\r\nmwdma_timing_data &= ~(0xFF << timing_shift);\r\nmwdma_timing_data |= (mwdma_timings[dma] << timing_shift);\r\npci_write_config_dword(pdev, ATIIXP_IDE_MWDMA_TIMING,\r\nmwdma_timing_data);\r\n}\r\nif (adev->dma_mode >= XFER_MW_DMA_2)\r\nwanted_pio = 4;\r\nelse if (adev->dma_mode == XFER_MW_DMA_1)\r\nwanted_pio = 3;\r\nelse if (adev->dma_mode == XFER_MW_DMA_0)\r\nwanted_pio = 0;\r\nelse BUG();\r\nif (adev->pio_mode != wanted_pio)\r\natiixp_set_pio_timing(ap, adev, wanted_pio);\r\nspin_unlock_irqrestore(&atiixp_lock, flags);\r\n}\r\nstatic void atiixp_bmdma_start(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct ata_device *adev = qc->dev;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dn = (2 * ap->port_no) + adev->devno;\r\nu16 tmp16;\r\npci_read_config_word(pdev, ATIIXP_IDE_UDMA_CONTROL, &tmp16);\r\nif (ata_using_udma(adev))\r\ntmp16 |= (1 << dn);\r\nelse\r\ntmp16 &= ~(1 << dn);\r\npci_write_config_word(pdev, ATIIXP_IDE_UDMA_CONTROL, tmp16);\r\nata_bmdma_start(qc);\r\n}\r\nstatic void atiixp_bmdma_stop(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint dn = (2 * ap->port_no) + qc->dev->devno;\r\nu16 tmp16;\r\npci_read_config_word(pdev, ATIIXP_IDE_UDMA_CONTROL, &tmp16);\r\ntmp16 &= ~(1 << dn);\r\npci_write_config_word(pdev, ATIIXP_IDE_UDMA_CONTROL, tmp16);\r\nata_bmdma_stop(qc);\r\n}\r\nstatic int atiixp_init_one(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA12_ONLY,\r\n.udma_mask = ATA_UDMA5,\r\n.port_ops = &atiixp_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, &info };\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &atiixp_sht, NULL,\r\nATA_HOST_PARALLEL_SCAN);\r\n}\r\nstatic int __init atiixp_init(void)\r\n{\r\nreturn pci_register_driver(&atiixp_pci_driver);\r\n}\r\nstatic void __exit atiixp_exit(void)\r\n{\r\npci_unregister_driver(&atiixp_pci_driver);\r\n}

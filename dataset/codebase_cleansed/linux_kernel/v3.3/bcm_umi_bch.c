static int bcm_umi_bch_read_page_hwecc(struct mtd_info *mtd,\r\nstruct nand_chip *chip, uint8_t * buf,\r\nint page)\r\n{\r\nint sectorIdx = 0;\r\nint eccsize = chip->ecc.size;\r\nint eccsteps = chip->ecc.steps;\r\nuint8_t *datap = buf;\r\nuint8_t eccCalc[NAND_ECC_NUM_BYTES];\r\nint sectorOobSize = mtd->oobsize / eccsteps;\r\nint stat;\r\nfor (sectorIdx = 0; sectorIdx < eccsteps;\r\nsectorIdx++, datap += eccsize) {\r\nif (sectorIdx > 0) {\r\nchip->cmdfunc(mtd, NAND_CMD_RNDOUT, sectorIdx * eccsize,\r\n-1);\r\n}\r\nnand_bcm_umi_bch_enable_read_hwecc();\r\nbcm_umi_nand_read_buf(mtd, datap, eccsize);\r\nnand_bcm_umi_bch_pause_read_ecc_calc();\r\nchip->cmdfunc(mtd, NAND_CMD_RNDOUT,\r\nmtd->writesize + sectorIdx * sectorOobSize, -1);\r\nnand_bcm_umi_bch_read_oobEcc(mtd->writesize, eccCalc,\r\nNAND_ECC_NUM_BYTES,\r\nchip->oob_poi +\r\nsectorIdx * sectorOobSize);\r\nstat =\r\nnand_bcm_umi_bch_correct_page(datap, eccCalc,\r\nNAND_ECC_NUM_BYTES);\r\nif (stat < 0) {\r\n#if defined(NAND_BCM_UMI_DEBUG)\r\nprintk(KERN_WARNING "%s uncorr_err sectorIdx=%d\n",\r\n__func__, sectorIdx);\r\nprintk(KERN_WARNING\r\n"%s data %02x %02x %02x %02x "\r\n"%02x %02x %02x %02x\n",\r\n__func__, datap[0], datap[1], datap[2], datap[3],\r\ndatap[4], datap[5], datap[6], datap[7]);\r\nprintk(KERN_WARNING\r\n"%s ecc %02x %02x %02x %02x "\r\n"%02x %02x %02x %02x %02x %02x "\r\n"%02x %02x %02x\n",\r\n__func__, eccCalc[0], eccCalc[1], eccCalc[2],\r\neccCalc[3], eccCalc[4], eccCalc[5], eccCalc[6],\r\neccCalc[7], eccCalc[8], eccCalc[9], eccCalc[10],\r\neccCalc[11], eccCalc[12]);\r\nBUG();\r\n#endif\r\nmtd->ecc_stats.failed++;\r\n} else {\r\n#if defined(NAND_BCM_UMI_DEBUG)\r\nif (stat > 0) {\r\nprintk(KERN_INFO\r\n"%s %d correctable_errors detected\n",\r\n__func__, stat);\r\n}\r\n#endif\r\nmtd->ecc_stats.corrected += stat;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void bcm_umi_bch_write_page_hwecc(struct mtd_info *mtd,\r\nstruct nand_chip *chip, const uint8_t *buf)\r\n{\r\nint sectorIdx = 0;\r\nint eccsize = chip->ecc.size;\r\nint eccsteps = chip->ecc.steps;\r\nconst uint8_t *datap = buf;\r\nuint8_t *oobp = chip->oob_poi;\r\nint sectorOobSize = mtd->oobsize / eccsteps;\r\nfor (sectorIdx = 0; sectorIdx < eccsteps;\r\nsectorIdx++, datap += eccsize, oobp += sectorOobSize) {\r\nnand_bcm_umi_bch_enable_write_hwecc();\r\nbcm_umi_nand_write_buf(mtd, datap, eccsize);\r\nnand_bcm_umi_bch_write_oobEcc(mtd->writesize, oobp,\r\nNAND_ECC_NUM_BYTES);\r\n}\r\nbcm_umi_nand_write_buf(mtd, chip->oob_poi, mtd->oobsize);\r\n}

void __init mips_pcibios_init(void)\r\n{\r\nstruct pci_controller *controller;\r\nresource_size_t start, end, map, start1, end1, map1, map2, map3, mask;\r\nswitch (mips_revision_sconid) {\r\ncase MIPS_REVISION_SCON_GT64120:\r\nGT_WRITE(GT_PCI0_CFGADDR_OFS,\r\n(0 << GT_PCI0_CFGADDR_BUSNUM_SHF) |\r\n(0 << GT_PCI0_CFGADDR_DEVNUM_SHF) |\r\n(0 << GT_PCI0_CFGADDR_FUNCTNUM_SHF) |\r\n((0x20/4) << GT_PCI0_CFGADDR_REGNUM_SHF) |\r\nGT_PCI0_CFGADDR_CONFIGEN_BIT);\r\nGT_WRITE(GT_PCI0_CFGDATA_OFS, CPHYSADDR(MIPS_GT_BASE));\r\nstart = GT_READ(GT_PCI0M0LD_OFS);\r\nend = GT_READ(GT_PCI0M0HD_OFS);\r\nmap = GT_READ(GT_PCI0M0REMAP_OFS);\r\nend = (end & GT_PCI_HD_MSK) | (start & ~GT_PCI_HD_MSK);\r\nstart1 = GT_READ(GT_PCI0M1LD_OFS);\r\nend1 = GT_READ(GT_PCI0M1HD_OFS);\r\nmap1 = GT_READ(GT_PCI0M1REMAP_OFS);\r\nend1 = (end1 & GT_PCI_HD_MSK) | (start1 & ~GT_PCI_HD_MSK);\r\nif (end1 - start1 > end - start) {\r\nstart = start1;\r\nend = end1;\r\nmap = map1;\r\n}\r\nmask = ~(start ^ end);\r\nBUG_ON((start & GT_PCI_HD_MSK) != (map & GT_PCI_HD_MSK) &&\r\nmask != ~((mask & -mask) - 1));\r\ngt64120_mem_resource.start = start;\r\ngt64120_mem_resource.end = end;\r\ngt64120_controller.mem_offset = (start & mask) - (map & mask);\r\ngt64120_mem_resource.start <<= GT_PCI_DCRM_SHF;\r\ngt64120_mem_resource.end <<= GT_PCI_DCRM_SHF;\r\ngt64120_mem_resource.end |= (1 << GT_PCI_DCRM_SHF) - 1;\r\ngt64120_controller.mem_offset <<= GT_PCI_DCRM_SHF;\r\nstart = GT_READ(GT_PCI0IOLD_OFS);\r\nend = GT_READ(GT_PCI0IOHD_OFS);\r\nmap = GT_READ(GT_PCI0IOREMAP_OFS);\r\nend = (end & GT_PCI_HD_MSK) | (start & ~GT_PCI_HD_MSK);\r\nmask = ~(start ^ end);\r\nBUG_ON((start & GT_PCI_HD_MSK) != (map & GT_PCI_HD_MSK) &&\r\nmask != ~((mask & -mask) - 1));\r\ngt64120_io_resource.start = map & mask;\r\ngt64120_io_resource.end = (map & mask) | ~mask;\r\ngt64120_controller.io_offset = 0;\r\ngt64120_io_resource.start <<= GT_PCI_DCRM_SHF;\r\ngt64120_io_resource.end <<= GT_PCI_DCRM_SHF;\r\ngt64120_io_resource.end |= (1 << GT_PCI_DCRM_SHF) - 1;\r\ncontroller = &gt64120_controller;\r\nbreak;\r\ncase MIPS_REVISION_SCON_BONITO:\r\nmap = BONITO_PCIMAP;\r\nmap1 = (BONITO_PCIMAP & BONITO_PCIMAP_PCIMAP_LO0) >>\r\nBONITO_PCIMAP_PCIMAP_LO0_SHIFT;\r\nmap2 = (BONITO_PCIMAP & BONITO_PCIMAP_PCIMAP_LO1) >>\r\nBONITO_PCIMAP_PCIMAP_LO1_SHIFT;\r\nmap3 = (BONITO_PCIMAP & BONITO_PCIMAP_PCIMAP_LO2) >>\r\nBONITO_PCIMAP_PCIMAP_LO2_SHIFT;\r\nmap = map1;\r\nstart = BONITO_PCILO0_BASE;\r\nend = 1;\r\nif (map3 == map2 + 1) {\r\nmap = map2;\r\nstart = BONITO_PCILO1_BASE;\r\nend++;\r\n}\r\nif (map2 == map1 + 1) {\r\nmap = map1;\r\nstart = BONITO_PCILO0_BASE;\r\nend++;\r\n}\r\nbonito64_mem_resource.start = start;\r\nbonito64_mem_resource.end = start +\r\nBONITO_PCIMAP_WINBASE(end) - 1;\r\nbonito64_controller.mem_offset = start -\r\nBONITO_PCIMAP_WINBASE(map);\r\ncontroller = &bonito64_controller;\r\nbreak;\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\nMSC_READ(MSC01_PCI_SC2PMBASL, start);\r\nMSC_READ(MSC01_PCI_SC2PMMSKL, mask);\r\nMSC_READ(MSC01_PCI_SC2PMMAPL, map);\r\nmsc_mem_resource.start = start & mask;\r\nmsc_mem_resource.end = (start & mask) | ~mask;\r\nmsc_controller.mem_offset = (start & mask) - (map & mask);\r\n#ifdef CONFIG_MIPS_CMP\r\nif (gcmp_niocu())\r\ngcmp_setregion(0, start, mask,\r\nGCMP_GCB_GCMPB_CMDEFTGT_IOCU1);\r\n#endif\r\nMSC_READ(MSC01_PCI_SC2PIOBASL, start);\r\nMSC_READ(MSC01_PCI_SC2PIOMSKL, mask);\r\nMSC_READ(MSC01_PCI_SC2PIOMAPL, map);\r\nmsc_io_resource.start = map & mask;\r\nmsc_io_resource.end = (map & mask) | ~mask;\r\nmsc_controller.io_offset = 0;\r\nioport_resource.end = ~mask;\r\n#ifdef CONFIG_MIPS_CMP\r\nif (gcmp_niocu())\r\ngcmp_setregion(1, start, mask,\r\nGCMP_GCB_GCMPB_CMDEFTGT_IOCU1);\r\n#endif\r\nstart = start & mask;\r\nend = start | ~mask;\r\nif ((start >= msc_mem_resource.start &&\r\nstart <= msc_mem_resource.end) ||\r\n(end >= msc_mem_resource.start &&\r\nend <= msc_mem_resource.end)) {\r\nstart = max(start, msc_mem_resource.start);\r\nend = min(end, msc_mem_resource.end);\r\nif (start - msc_mem_resource.start >=\r\nmsc_mem_resource.end - end)\r\nmsc_mem_resource.end = start - 1;\r\nelse\r\nmsc_mem_resource.start = end + 1;\r\n}\r\ncontroller = &msc_controller;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nif (controller->io_resource->start < 0x00001000UL)\r\ncontroller->io_resource->start = 0x00001000UL;\r\niomem_resource.end &= 0xfffffffffULL;\r\nioport_resource.end = controller->io_resource->end;\r\ncontroller->io_map_base = mips_io_port_base;\r\nregister_pci_controller(controller);\r\n}\r\nstatic void __init quirk_dlcsetup(struct pci_dev *dev)\r\n{\r\nu8 odlc, ndlc;\r\n(void) pci_read_config_byte(dev, 0x82, &odlc);\r\nndlc = odlc | 7;\r\n(void) pci_write_config_byte(dev, 0x82, ndlc);\r\n}

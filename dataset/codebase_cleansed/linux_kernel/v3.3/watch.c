void mips_install_watch_registers(void)\r\n{\r\nstruct mips3264_watch_reg_state *watches =\r\n&current->thread.watch.mips3264;\r\nswitch (current_cpu_data.watch_reg_use_cnt) {\r\ndefault:\r\nBUG();\r\ncase 4:\r\nwrite_c0_watchlo3(watches->watchlo[3]);\r\nwrite_c0_watchhi3(0x40000007 | watches->watchhi[3]);\r\ncase 3:\r\nwrite_c0_watchlo2(watches->watchlo[2]);\r\nwrite_c0_watchhi2(0x40000007 | watches->watchhi[2]);\r\ncase 2:\r\nwrite_c0_watchlo1(watches->watchlo[1]);\r\nwrite_c0_watchhi1(0x40000007 | watches->watchhi[1]);\r\ncase 1:\r\nwrite_c0_watchlo0(watches->watchlo[0]);\r\nwrite_c0_watchhi0(0x40000007 | watches->watchhi[0]);\r\n}\r\n}\r\nvoid mips_read_watch_registers(void)\r\n{\r\nstruct mips3264_watch_reg_state *watches =\r\n&current->thread.watch.mips3264;\r\nswitch (current_cpu_data.watch_reg_use_cnt) {\r\ndefault:\r\nBUG();\r\ncase 4:\r\nwatches->watchhi[3] = (read_c0_watchhi3() & 0x0fff);\r\ncase 3:\r\nwatches->watchhi[2] = (read_c0_watchhi2() & 0x0fff);\r\ncase 2:\r\nwatches->watchhi[1] = (read_c0_watchhi1() & 0x0fff);\r\ncase 1:\r\nwatches->watchhi[0] = (read_c0_watchhi0() & 0x0fff);\r\n}\r\nif (current_cpu_data.watch_reg_use_cnt == 1 &&\r\n(watches->watchhi[0] & 7) == 0) {\r\nwatches->watchhi[0] |= (watches->watchlo[0] & 7);\r\n}\r\n}\r\nvoid mips_clear_watch_registers(void)\r\n{\r\nswitch (current_cpu_data.watch_reg_count) {\r\ndefault:\r\nBUG();\r\ncase 8:\r\nwrite_c0_watchlo7(0);\r\ncase 7:\r\nwrite_c0_watchlo6(0);\r\ncase 6:\r\nwrite_c0_watchlo5(0);\r\ncase 5:\r\nwrite_c0_watchlo4(0);\r\ncase 4:\r\nwrite_c0_watchlo3(0);\r\ncase 3:\r\nwrite_c0_watchlo2(0);\r\ncase 2:\r\nwrite_c0_watchlo1(0);\r\ncase 1:\r\nwrite_c0_watchlo0(0);\r\n}\r\n}\r\n__cpuinit void mips_probe_watch_registers(struct cpuinfo_mips *c)\r\n{\r\nunsigned int t;\r\nif ((c->options & MIPS_CPU_WATCH) == 0)\r\nreturn;\r\nwrite_c0_watchlo0(7);\r\nt = read_c0_watchlo0();\r\nwrite_c0_watchlo0(0);\r\nc->watch_reg_masks[0] = t & 7;\r\nc->watch_reg_count = 1;\r\nc->watch_reg_use_cnt = 1;\r\nt = read_c0_watchhi0();\r\nwrite_c0_watchhi0(t | 0xff8);\r\nt = read_c0_watchhi0();\r\nc->watch_reg_masks[0] |= (t & 0xff8);\r\nif ((t & 0x80000000) == 0)\r\nreturn;\r\nwrite_c0_watchlo1(7);\r\nt = read_c0_watchlo1();\r\nwrite_c0_watchlo1(0);\r\nc->watch_reg_masks[1] = t & 7;\r\nc->watch_reg_count = 2;\r\nc->watch_reg_use_cnt = 2;\r\nt = read_c0_watchhi1();\r\nwrite_c0_watchhi1(t | 0xff8);\r\nt = read_c0_watchhi1();\r\nc->watch_reg_masks[1] |= (t & 0xff8);\r\nif ((t & 0x80000000) == 0)\r\nreturn;\r\nwrite_c0_watchlo2(7);\r\nt = read_c0_watchlo2();\r\nwrite_c0_watchlo2(0);\r\nc->watch_reg_masks[2] = t & 7;\r\nc->watch_reg_count = 3;\r\nc->watch_reg_use_cnt = 3;\r\nt = read_c0_watchhi2();\r\nwrite_c0_watchhi2(t | 0xff8);\r\nt = read_c0_watchhi2();\r\nc->watch_reg_masks[2] |= (t & 0xff8);\r\nif ((t & 0x80000000) == 0)\r\nreturn;\r\nwrite_c0_watchlo3(7);\r\nt = read_c0_watchlo3();\r\nwrite_c0_watchlo3(0);\r\nc->watch_reg_masks[3] = t & 7;\r\nc->watch_reg_count = 4;\r\nc->watch_reg_use_cnt = 4;\r\nt = read_c0_watchhi3();\r\nwrite_c0_watchhi3(t | 0xff8);\r\nt = read_c0_watchhi3();\r\nc->watch_reg_masks[3] |= (t & 0xff8);\r\nif ((t & 0x80000000) == 0)\r\nreturn;\r\nc->watch_reg_count = 5;\r\nt = read_c0_watchhi4();\r\nif ((t & 0x80000000) == 0)\r\nreturn;\r\nc->watch_reg_count = 6;\r\nt = read_c0_watchhi5();\r\nif ((t & 0x80000000) == 0)\r\nreturn;\r\nc->watch_reg_count = 7;\r\nt = read_c0_watchhi6();\r\nif ((t & 0x80000000) == 0)\r\nreturn;\r\nc->watch_reg_count = 8;\r\n}

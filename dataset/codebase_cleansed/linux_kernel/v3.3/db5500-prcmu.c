int db5500_prcmu_abb_read(u8 slave, u8 reg, u8 *value, u8 size)\r\n{\r\nint r;\r\nif ((size < 1) || (4 < size))\r\nreturn -EINVAL;\r\nmutex_lock(&mb5_transfer.lock);\r\nwhile (readl(PRCM_MBOX_CPU_VAL) & MBOX_BIT(5))\r\ncpu_relax();\r\nwriteb(slave, PRCM_REQ_MB5_I2C_SLAVE);\r\nwriteb(reg, PRCM_REQ_MB5_I2C_REG);\r\nwriteb(size, PRCM_REQ_MB5_I2C_SIZE);\r\nwriteb(MB5H_I2C_READ, PRCM_REQ_MB5_HEADER);\r\nwritel(MBOX_BIT(5), PRCM_MBOX_CPU_SET);\r\nwait_for_completion(&mb5_transfer.work);\r\nr = 0;\r\nif ((mb5_transfer.ack.header == MB5H_I2C_READ) &&\r\n(mb5_transfer.ack.status == RC_SUCCESS))\r\nmemcpy(value, mb5_transfer.ack.value, (size_t)size);\r\nelse\r\nr = -EIO;\r\nmutex_unlock(&mb5_transfer.lock);\r\nreturn r;\r\n}\r\nint db5500_prcmu_abb_write(u8 slave, u8 reg, u8 *value, u8 size)\r\n{\r\nint r;\r\nif ((size < 1) || (4 < size))\r\nreturn -EINVAL;\r\nmutex_lock(&mb5_transfer.lock);\r\nwhile (readl(PRCM_MBOX_CPU_VAL) & MBOX_BIT(5))\r\ncpu_relax();\r\nwriteb(slave, PRCM_REQ_MB5_I2C_SLAVE);\r\nwriteb(reg, PRCM_REQ_MB5_I2C_REG);\r\nwriteb(size, PRCM_REQ_MB5_I2C_SIZE);\r\nmemcpy_toio(PRCM_REQ_MB5_I2C_DATA, value, size);\r\nwriteb(MB5H_I2C_WRITE, PRCM_REQ_MB5_HEADER);\r\nwritel(MBOX_BIT(5), PRCM_MBOX_CPU_SET);\r\nwait_for_completion(&mb5_transfer.work);\r\nif ((mb5_transfer.ack.header == MB5H_I2C_WRITE) &&\r\n(mb5_transfer.ack.status == RC_SUCCESS))\r\nr = 0;\r\nelse\r\nr = -EIO;\r\nmutex_unlock(&mb5_transfer.lock);\r\nreturn r;\r\n}\r\nint db5500_prcmu_enable_dsipll(void)\r\n{\r\nint i;\r\nwritel(PRCMU_RESET_DSIPLL, PRCM_APE_RESETN_CLR);\r\nwritel(PRCMU_UNCLAMP_DSIPLL, PRCM_MMIP_LS_CLAMP_CLR);\r\nwritel(PRCMU_PLLDSI_FREQ_SETTING, PRCM_PLLDSI_FREQ);\r\nwritel(PRCMU_DSI_PLLOUT_SEL_SETTING,\r\nPRCM_DSI_PLLOUT_SEL);\r\nwritel(PRCMU_ENABLE_ESCAPE_CLOCK_DIV, PRCM_DSITVCLK_DIV);\r\nwritel(PRCMU_ENABLE_PLLDSI, PRCM_PLLDSI_ENABLE);\r\nwritel(PRCMU_DSI_RESET_SW, PRCM_DSI_SW_RESET);\r\nfor (i = 0; i < 10; i++) {\r\nif ((readl(PRCM_PLLDSI_LOCKP) &\r\nPRCMU_PLLDSI_LOCKP_LOCKED) == PRCMU_PLLDSI_LOCKP_LOCKED)\r\nbreak;\r\nudelay(100);\r\n}\r\nwritel(PRCMU_RESET_DSIPLL, PRCM_APE_RESETN_SET);\r\nreturn 0;\r\n}\r\nint db5500_prcmu_disable_dsipll(void)\r\n{\r\nwritel(PRCMU_DISABLE_PLLDSI, PRCM_PLLDSI_ENABLE);\r\nwritel(PRCMU_DISABLE_ESCAPE_CLOCK_DIV, PRCM_DSITVCLK_DIV);\r\nreturn 0;\r\n}\r\nint db5500_prcmu_set_display_clocks(void)\r\n{\r\nwritel(PRCMU_DSI_CLOCK_SETTING, PRCM_HDMICLK_MGT);\r\nwritel(PRCMU_DSI_LP_CLOCK_SETTING, PRCM_TVCLK_MGT);\r\nreturn 0;\r\n}\r\nstatic void ack_dbb_wakeup(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&mb0_transfer.lock, flags);\r\nwhile (readl(PRCM_MBOX_CPU_VAL) & MBOX_BIT(0))\r\ncpu_relax();\r\nwriteb(RMB0H_RD_WAKE_UP_ACK, PRCM_REQ_MB0_HEADER);\r\nwritel(MBOX_BIT(0), PRCM_MBOX_CPU_SET);\r\nspin_unlock_irqrestore(&mb0_transfer.lock, flags);\r\n}\r\nstatic inline void print_unknown_header_warning(u8 n, u8 header)\r\n{\r\npr_warning("prcmu: Unknown message header (%d) in mailbox %d.\n",\r\nheader, n);\r\n}\r\nstatic bool read_mailbox_0(void)\r\n{\r\nbool r;\r\nu8 header;\r\nheader = readb(PRCM_ACK_MB0_HEADER);\r\nswitch (header) {\r\ncase AMB0H_WAKE_UP:\r\nr = true;\r\nbreak;\r\ndefault:\r\nprint_unknown_header_warning(0, header);\r\nr = false;\r\nbreak;\r\n}\r\nwritel(MBOX_BIT(0), PRCM_ARM_IT1_CLR);\r\nreturn r;\r\n}\r\nstatic bool read_mailbox_1(void)\r\n{\r\nwritel(MBOX_BIT(1), PRCM_ARM_IT1_CLR);\r\nreturn false;\r\n}\r\nstatic bool read_mailbox_2(void)\r\n{\r\nwritel(MBOX_BIT(2), PRCM_ARM_IT1_CLR);\r\nreturn false;\r\n}\r\nstatic bool read_mailbox_3(void)\r\n{\r\nwritel(MBOX_BIT(3), PRCM_ARM_IT1_CLR);\r\nreturn false;\r\n}\r\nstatic bool read_mailbox_4(void)\r\n{\r\nwritel(MBOX_BIT(4), PRCM_ARM_IT1_CLR);\r\nreturn false;\r\n}\r\nstatic bool read_mailbox_5(void)\r\n{\r\nu8 header;\r\nheader = readb(PRCM_ACK_MB5_HEADER);\r\nswitch (header) {\r\ncase MB5H_I2C_READ:\r\nmemcpy_fromio(mb5_transfer.ack.value, PRCM_ACK_MB5_I2C_DATA, 4);\r\ncase MB5H_I2C_WRITE:\r\nmb5_transfer.ack.header = header;\r\nmb5_transfer.ack.status = readb(PRCM_ACK_MB5_RETURN_CODE);\r\ncomplete(&mb5_transfer.work);\r\nbreak;\r\ndefault:\r\nprint_unknown_header_warning(5, header);\r\nbreak;\r\n}\r\nwritel(MBOX_BIT(5), PRCM_ARM_IT1_CLR);\r\nreturn false;\r\n}\r\nstatic bool read_mailbox_6(void)\r\n{\r\nwritel(MBOX_BIT(6), PRCM_ARM_IT1_CLR);\r\nreturn false;\r\n}\r\nstatic bool read_mailbox_7(void)\r\n{\r\nwritel(MBOX_BIT(7), PRCM_ARM_IT1_CLR);\r\nreturn false;\r\n}\r\nstatic irqreturn_t prcmu_irq_handler(int irq, void *data)\r\n{\r\nu32 bits;\r\nu8 n;\r\nirqreturn_t r;\r\nbits = (readl(PRCM_ARM_IT1_VAL) & ALL_MBOX_BITS);\r\nif (unlikely(!bits))\r\nreturn IRQ_NONE;\r\nr = IRQ_HANDLED;\r\nfor (n = 0; bits; n++) {\r\nif (bits & MBOX_BIT(n)) {\r\nbits -= MBOX_BIT(n);\r\nif (read_mailbox[n]())\r\nr = IRQ_WAKE_THREAD;\r\n}\r\n}\r\nreturn r;\r\n}\r\nstatic irqreturn_t prcmu_irq_thread_fn(int irq, void *data)\r\n{\r\nack_dbb_wakeup();\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init db5500_prcmu_early_init(void)\r\n{\r\ntcdm_base = __io_address(U5500_PRCMU_TCDM_BASE);\r\nspin_lock_init(&mb0_transfer.lock);\r\nmutex_init(&mb5_transfer.lock);\r\ninit_completion(&mb5_transfer.work);\r\n}\r\nint __init db5500_prcmu_init(void)\r\n{\r\nint r = 0;\r\nif (ux500_is_svp() || !cpu_is_u5500())\r\nreturn -ENODEV;\r\nwritel(ALL_MBOX_BITS, PRCM_ARM_IT1_CLR);\r\nr = request_threaded_irq(IRQ_DB5500_PRCMU1, prcmu_irq_handler,\r\nprcmu_irq_thread_fn, 0, "prcmu", NULL);\r\nif (r < 0) {\r\npr_err("prcmu: Failed to allocate IRQ_DB5500_PRCMU1.\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}

static unsigned int\r\nebt_redirect_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ebt_redirect_info *info = par->targinfo;\r\nif (!skb_make_writable(skb, 0))\r\nreturn EBT_DROP;\r\nif (par->hooknum != NF_BR_BROUTING)\r\nmemcpy(eth_hdr(skb)->h_dest,\r\nbr_port_get_rcu(par->in)->br->dev->dev_addr, ETH_ALEN);\r\nelse\r\nmemcpy(eth_hdr(skb)->h_dest, par->in->dev_addr, ETH_ALEN);\r\nskb->pkt_type = PACKET_HOST;\r\nreturn info->target;\r\n}\r\nstatic int ebt_redirect_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct ebt_redirect_info *info = par->targinfo;\r\nunsigned int hook_mask;\r\nif (BASE_CHAIN && info->target == EBT_RETURN)\r\nreturn -EINVAL;\r\nhook_mask = par->hook_mask & ~(1 << NF_BR_NUMHOOKS);\r\nif ((strcmp(par->table, "nat") != 0 ||\r\nhook_mask & ~(1 << NF_BR_PRE_ROUTING)) &&\r\n(strcmp(par->table, "broute") != 0 ||\r\nhook_mask & ~(1 << NF_BR_BROUTING)))\r\nreturn -EINVAL;\r\nif (INVALID_TARGET)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init ebt_redirect_init(void)\r\n{\r\nreturn xt_register_target(&ebt_redirect_tg_reg);\r\n}\r\nstatic void __exit ebt_redirect_fini(void)\r\n{\r\nxt_unregister_target(&ebt_redirect_tg_reg);\r\n}

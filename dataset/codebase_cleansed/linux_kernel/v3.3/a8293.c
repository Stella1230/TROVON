static int a8293_i2c(struct a8293_priv *priv, u8 *val, int len, bool rd)\r\n{\r\nint ret;\r\nstruct i2c_msg msg[1] = {\r\n{\r\n.addr = priv->cfg->i2c_addr,\r\n.len = len,\r\n.buf = val,\r\n}\r\n};\r\nif (rd)\r\nmsg[0].flags = I2C_M_RD;\r\nelse\r\nmsg[0].flags = 0;\r\nret = i2c_transfer(priv->i2c, msg, 1);\r\nif (ret == 1) {\r\nret = 0;\r\n} else {\r\nwarn("i2c failed=%d rd=%d", ret, rd);\r\nret = -EREMOTEIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int a8293_wr(struct a8293_priv *priv, u8 *val, int len)\r\n{\r\nreturn a8293_i2c(priv, val, len, 0);\r\n}\r\nstatic int a8293_rd(struct a8293_priv *priv, u8 *val, int len)\r\n{\r\nreturn a8293_i2c(priv, val, len, 1);\r\n}\r\nstatic int a8293_set_voltage(struct dvb_frontend *fe,\r\nfe_sec_voltage_t fe_sec_voltage)\r\n{\r\nstruct a8293_priv *priv = fe->sec_priv;\r\nint ret;\r\ndbg("%s: fe_sec_voltage=%d", __func__, fe_sec_voltage);\r\nswitch (fe_sec_voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\npriv->reg[0] = 0x10;\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\npriv->reg[0] = 0x31;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\npriv->reg[0] = 0x38;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto err;\r\n};\r\nret = a8293_wr(priv, &priv->reg[0], 1);\r\nif (ret)\r\ngoto err;\r\nreturn ret;\r\nerr:\r\ndbg("%s: failed=%d", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic void a8293_release_sec(struct dvb_frontend *fe)\r\n{\r\ndbg("%s:", __func__);\r\na8293_set_voltage(fe, SEC_VOLTAGE_OFF);\r\nkfree(fe->sec_priv);\r\nfe->sec_priv = NULL;\r\n}\r\nstruct dvb_frontend *a8293_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c, const struct a8293_config *cfg)\r\n{\r\nint ret;\r\nstruct a8293_priv *priv = NULL;\r\nu8 buf[2];\r\npriv = kzalloc(sizeof(struct a8293_priv), GFP_KERNEL);\r\nif (priv == NULL) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\npriv->i2c = i2c;\r\npriv->cfg = cfg;\r\nfe->sec_priv = priv;\r\nret = a8293_rd(priv, buf, 2);\r\nif (ret)\r\ngoto err;\r\npriv->reg[0] = 0x10;\r\nret = a8293_wr(priv, &priv->reg[1], 1);\r\nif (ret)\r\ngoto err;\r\npriv->reg[1] = 0x82;\r\nret = a8293_wr(priv, &priv->reg[1], 1);\r\nif (ret)\r\ngoto err;\r\ninfo("Allegro A8293 SEC attached.");\r\nfe->ops.release_sec = a8293_release_sec;\r\nfe->ops.set_voltage = a8293_set_voltage;\r\nreturn fe;\r\nerr:\r\ndbg("%s: failed=%d", __func__, ret);\r\nkfree(priv);\r\nreturn NULL;\r\n}

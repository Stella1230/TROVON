static int __devinit ohci_ath79_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nret = ohci_init(ohci);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ohci_run(ohci);\r\nif (ret < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nstatic int ohci_ath79_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct resource *res;\r\nint irq;\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!res) {\r\ndev_dbg(&pdev->dev, "no IRQ specified\n");\r\nreturn -ENODEV;\r\n}\r\nirq = res->start;\r\nhcd = usb_create_hcd(&ohci_ath79_hc_driver, &pdev->dev,\r\ndev_name(&pdev->dev));\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_dbg(&pdev->dev, "no base address specified\n");\r\nret = -ENODEV;\r\ngoto err_put_hcd;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\ndev_dbg(&pdev->dev, "controller already in use\n");\r\nret = -EBUSY;\r\ngoto err_put_hcd;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\ndev_dbg(&pdev->dev, "error mapping memory\n");\r\nret = -EFAULT;\r\ngoto err_release_region;\r\n}\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nret = usb_add_hcd(hcd, irq, 0);\r\nif (ret)\r\ngoto err_stop_hcd;\r\nreturn 0;\r\nerr_stop_hcd:\r\niounmap(hcd->regs);\r\nerr_release_region:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr_put_hcd:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int ohci_ath79_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}

void\r\nmchk_dump_mem(void *data, size_t length, char **annotation)\r\n{\r\nunsigned long *ldata = data;\r\nsize_t i;\r\nfor (i = 0; (i * sizeof(*ldata)) < length; i++) {\r\nif (annotation && !annotation[i])\r\nannotation = NULL;\r\nprintk("%s %08x: %016lx %s\n",\r\nerr_print_prefix,\r\n(unsigned)(i * sizeof(*ldata)), ldata[i],\r\nannotation ? annotation[i] : "");\r\n}\r\n}\r\nvoid\r\nmchk_dump_logout_frame(struct el_common *mchk_header)\r\n{\r\nprintk("%s -- Frame Header --\n"\r\n" Frame Size: %d (0x%x) bytes\n"\r\n" Flags: %s%s\n"\r\n" MCHK Code: 0x%x\n"\r\n" Frame Rev: %d\n"\r\n" Proc Offset: 0x%08x\n"\r\n" Sys Offset: 0x%08x\n"\r\n" -- Processor Region --\n",\r\nerr_print_prefix,\r\nmchk_header->size, mchk_header->size,\r\nmchk_header->retry ? "RETRY " : "",\r\nmchk_header->err2 ? "SECOND_ERR " : "",\r\nmchk_header->code,\r\nmchk_header->frame_rev,\r\nmchk_header->proc_offset,\r\nmchk_header->sys_offset);\r\nmchk_dump_mem((void *)\r\n((unsigned long)mchk_header + mchk_header->proc_offset),\r\nmchk_header->sys_offset - mchk_header->proc_offset,\r\nNULL);\r\nprintk("%s -- System Region --\n", err_print_prefix);\r\nmchk_dump_mem((void *)\r\n((unsigned long)mchk_header + mchk_header->sys_offset),\r\nmchk_header->size - mchk_header->sys_offset,\r\nNULL);\r\nprintk("%s -- End of Frame --\n", err_print_prefix);\r\n}\r\nstatic struct el_subpacket *\r\nel_process_header_subpacket(struct el_subpacket *header)\r\n{\r\nunion el_timestamp timestamp;\r\nchar *name = "UNKNOWN EVENT";\r\nint packet_count = 0;\r\nint length = 0;\r\nif (header->class != EL_CLASS__HEADER) {\r\nprintk("%s** Unexpected header CLASS %d TYPE %d, aborting\n",\r\nerr_print_prefix,\r\nheader->class, header->type);\r\nreturn NULL;\r\n}\r\nswitch(header->type) {\r\ncase EL_TYPE__HEADER__SYSTEM_ERROR_FRAME:\r\nname = "SYSTEM ERROR";\r\nlength = header->by_type.sys_err.frame_length;\r\npacket_count =\r\nheader->by_type.sys_err.frame_packet_count;\r\ntimestamp.as_int = 0;\r\nbreak;\r\ncase EL_TYPE__HEADER__SYSTEM_EVENT_FRAME:\r\nname = "SYSTEM EVENT";\r\nlength = header->by_type.sys_event.frame_length;\r\npacket_count =\r\nheader->by_type.sys_event.frame_packet_count;\r\ntimestamp = header->by_type.sys_event.timestamp;\r\nbreak;\r\ncase EL_TYPE__HEADER__HALT_FRAME:\r\nname = "ERROR HALT";\r\nlength = header->by_type.err_halt.frame_length;\r\npacket_count =\r\nheader->by_type.err_halt.frame_packet_count;\r\ntimestamp = header->by_type.err_halt.timestamp;\r\nbreak;\r\ncase EL_TYPE__HEADER__LOGOUT_FRAME:\r\nname = "LOGOUT FRAME";\r\nlength = header->by_type.logout_header.frame_length;\r\npacket_count = 1;\r\ntimestamp.as_int = 0;\r\nbreak;\r\ndefault:\r\nprintk("%s** Unknown header - CLASS %d TYPE %d, aborting\n",\r\nerr_print_prefix,\r\nheader->class, header->type);\r\nreturn NULL;\r\n}\r\nprintk("%s*** %s:\n"\r\n" CLASS %d, TYPE %d\n",\r\nerr_print_prefix,\r\nname,\r\nheader->class, header->type);\r\nel_print_timestamp(&timestamp);\r\nel_process_subpackets(header, packet_count);\r\nheader = (struct el_subpacket *)\r\n((unsigned long)header + header->length + length);\r\nreturn header;\r\n}\r\nstatic struct el_subpacket *\r\nel_process_subpacket_reg(struct el_subpacket *header)\r\n{\r\nstruct el_subpacket *next = NULL;\r\nstruct el_subpacket_handler *h = subpacket_handler_list;\r\nfor (; h && h->class != header->class; h = h->next);\r\nif (h) next = h->handler(header);\r\nreturn next;\r\n}\r\nvoid\r\nel_print_timestamp(union el_timestamp *timestamp)\r\n{\r\nif (timestamp->as_int)\r\nprintk("%s TIMESTAMP: %d/%d/%02d %d:%02d:%0d\n",\r\nerr_print_prefix,\r\ntimestamp->b.month, timestamp->b.day,\r\ntimestamp->b.year, timestamp->b.hour,\r\ntimestamp->b.minute, timestamp->b.second);\r\n}\r\nvoid\r\nel_process_subpackets(struct el_subpacket *header, int packet_count)\r\n{\r\nstruct el_subpacket *subpacket;\r\nint i;\r\nsubpacket = (struct el_subpacket *)\r\n((unsigned long)header + header->length);\r\nfor (i = 0; subpacket && i < packet_count; i++) {\r\nprintk("%sPROCESSING SUBPACKET %d\n", err_print_prefix, i);\r\nsubpacket = el_process_subpacket(subpacket);\r\n}\r\n}\r\nstruct el_subpacket *\r\nel_process_subpacket(struct el_subpacket *header)\r\n{\r\nstruct el_subpacket *next = NULL;\r\nswitch(header->class) {\r\ncase EL_CLASS__TERMINATION:\r\nbreak;\r\ncase EL_CLASS__HEADER:\r\nnext = el_process_header_subpacket(header);\r\nbreak;\r\ndefault:\r\nif (NULL == (next = el_process_subpacket_reg(header))) {\r\nprintk("%s** Unexpected header CLASS %d TYPE %d"\r\n" -- aborting.\n",\r\nerr_print_prefix,\r\nheader->class, header->type);\r\n}\r\nbreak;\r\n}\r\nreturn next;\r\n}\r\nvoid\r\nel_annotate_subpacket(struct el_subpacket *header)\r\n{\r\nstruct el_subpacket_annotation *a;\r\nchar **annotation = NULL;\r\nfor (a = subpacket_annotation_list; a; a = a->next) {\r\nif (a->class == header->class &&\r\na->type == header->type &&\r\na->revision == header->revision) {\r\nannotation = a->annotation;\r\nprintk("%s %s\n", err_print_prefix, a->description);\r\nbreak;\r\n}\r\n}\r\nmchk_dump_mem(header, header->length, annotation);\r\n}\r\nstatic void __init\r\ncdl_process_console_data_log(int cpu, struct percpu_struct *pcpu)\r\n{\r\nstruct el_subpacket *header = (struct el_subpacket *)\r\n(IDENT_ADDR | pcpu->console_data_log_pa);\r\nint err;\r\nprintk("%s******* CONSOLE DATA LOG FOR CPU %d. *******\n"\r\n"*** Error(s) were logged on a previous boot\n",\r\nerr_print_prefix, cpu);\r\nfor (err = 0; header && (header->class != EL_CLASS__TERMINATION); err++)\r\nheader = el_process_subpacket(header);\r\npcpu->console_data_log_pa = 0;\r\nprintk("%s*** %d total error(s) logged\n"\r\n"**** END OF CONSOLE DATA LOG FOR CPU %d ****\n",\r\nerr_print_prefix, err, cpu);\r\n}\r\nvoid __init\r\ncdl_check_console_data_log(void)\r\n{\r\nstruct percpu_struct *pcpu;\r\nunsigned long cpu;\r\nfor (cpu = 0; cpu < hwrpb->nr_processors; cpu++) {\r\npcpu = (struct percpu_struct *)\r\n((unsigned long)hwrpb + hwrpb->processor_offset\r\n+ cpu * hwrpb->processor_size);\r\nif (pcpu->console_data_log_pa)\r\ncdl_process_console_data_log(cpu, pcpu);\r\n}\r\n}\r\nint __init\r\ncdl_register_subpacket_annotation(struct el_subpacket_annotation *new)\r\n{\r\nstruct el_subpacket_annotation *a = subpacket_annotation_list;\r\nif (a == NULL) subpacket_annotation_list = new;\r\nelse {\r\nfor (; a->next != NULL; a = a->next) {\r\nif ((a->class == new->class && a->type == new->type) ||\r\na == new) {\r\nprintk("Attempted to re-register "\r\n"subpacket annotation\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\na->next = new;\r\n}\r\nnew->next = NULL;\r\nreturn 0;\r\n}\r\nint __init\r\ncdl_register_subpacket_handler(struct el_subpacket_handler *new)\r\n{\r\nstruct el_subpacket_handler *h = subpacket_handler_list;\r\nif (h == NULL) subpacket_handler_list = new;\r\nelse {\r\nfor (; h->next != NULL; h = h->next) {\r\nif (h->class == new->class || h == new) {\r\nprintk("Attempted to re-register "\r\n"subpacket handler\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nh->next = new;\r\n}\r\nnew->next = NULL;\r\nreturn 0;\r\n}

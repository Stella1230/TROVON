static unsigned long get_rate_mpll(void)\r\n{\r\nulong mpctl = __raw_readl(CRM_BASE + CCM_MPCTL);\r\nreturn mxc_decode_pll(mpctl, 24000000);\r\n}\r\nstatic unsigned long get_rate_upll(void)\r\n{\r\nulong mpctl = __raw_readl(CRM_BASE + CCM_UPCTL);\r\nreturn mxc_decode_pll(mpctl, 24000000);\r\n}\r\nunsigned long get_rate_arm(struct clk *clk)\r\n{\r\nunsigned long cctl = readl(CRM_BASE + CCM_CCTL);\r\nunsigned long rate = get_rate_mpll();\r\nif (cctl & (1 << 14))\r\nrate = (rate * 3) >> 2;\r\nreturn rate / ((cctl >> 30) + 1);\r\n}\r\nstatic unsigned long get_rate_ahb(struct clk *clk)\r\n{\r\nunsigned long cctl = readl(CRM_BASE + CCM_CCTL);\r\nreturn get_rate_arm(NULL) / (((cctl >> 28) & 0x3) + 1);\r\n}\r\nstatic unsigned long get_rate_ipg(struct clk *clk)\r\n{\r\nreturn get_rate_ahb(NULL) >> 1;\r\n}\r\nstatic unsigned long get_rate_per(int per)\r\n{\r\nunsigned long ofs = (per & 0x3) * 8;\r\nunsigned long reg = per & ~0x3;\r\nunsigned long val = (readl(CRM_BASE + CCM_PCDR0 + reg) >> ofs) & 0x3f;\r\nunsigned long fref;\r\nif (readl(CRM_BASE + 0x64) & (1 << per))\r\nfref = get_rate_upll();\r\nelse\r\nfref = get_rate_ahb(NULL);\r\nreturn fref / (val + 1);\r\n}\r\nstatic unsigned long get_rate_uart(struct clk *clk)\r\n{\r\nreturn get_rate_per(15);\r\n}\r\nstatic unsigned long get_rate_ssi2(struct clk *clk)\r\n{\r\nreturn get_rate_per(14);\r\n}\r\nstatic unsigned long get_rate_ssi1(struct clk *clk)\r\n{\r\nreturn get_rate_per(13);\r\n}\r\nstatic unsigned long get_rate_i2c(struct clk *clk)\r\n{\r\nreturn get_rate_per(6);\r\n}\r\nstatic unsigned long get_rate_nfc(struct clk *clk)\r\n{\r\nreturn get_rate_per(8);\r\n}\r\nstatic unsigned long get_rate_gpt(struct clk *clk)\r\n{\r\nreturn get_rate_per(5);\r\n}\r\nstatic unsigned long get_rate_lcdc(struct clk *clk)\r\n{\r\nreturn get_rate_per(7);\r\n}\r\nstatic unsigned long get_rate_esdhc1(struct clk *clk)\r\n{\r\nreturn get_rate_per(3);\r\n}\r\nstatic unsigned long get_rate_esdhc2(struct clk *clk)\r\n{\r\nreturn get_rate_per(4);\r\n}\r\nstatic unsigned long get_rate_csi(struct clk *clk)\r\n{\r\nreturn get_rate_per(0);\r\n}\r\nstatic unsigned long get_rate_otg(struct clk *clk)\r\n{\r\nunsigned long cctl = readl(CRM_BASE + CCM_CCTL);\r\nunsigned long rate = get_rate_upll();\r\nreturn (cctl & (1 << 23)) ? 0 : rate / ((0x3F & (cctl >> 16)) + 1);\r\n}\r\nstatic int clk_cgcr_enable(struct clk *clk)\r\n{\r\nu32 reg;\r\nreg = __raw_readl(clk->enable_reg);\r\nreg |= 1 << clk->enable_shift;\r\n__raw_writel(reg, clk->enable_reg);\r\nreturn 0;\r\n}\r\nstatic void clk_cgcr_disable(struct clk *clk)\r\n{\r\nu32 reg;\r\nreg = __raw_readl(clk->enable_reg);\r\nreg &= ~(1 << clk->enable_shift);\r\n__raw_writel(reg, clk->enable_reg);\r\n}\r\nint __init mx25_clocks_init(void)\r\n{\r\nclkdev_add_table(lookups, ARRAY_SIZE(lookups));\r\n__raw_writel((1 << 19), CRM_BASE + CCM_CGCR0);\r\n__raw_writel((0xf << 16) | (3 << 26), CRM_BASE + CCM_CGCR1);\r\n__raw_writel((1 << 5), CRM_BASE + CCM_CGCR2);\r\n#if defined(CONFIG_DEBUG_LL) && !defined(CONFIG_DEBUG_ICEDCC)\r\nclk_enable(&uart1_clk);\r\n#endif\r\n__raw_writel(__raw_readl(CRM_BASE+0x64) | (1 << 7) | (1 << 0),\r\nCRM_BASE + 0x64);\r\n__raw_writel(__raw_readl(CRM_BASE+0x64) & ~(1 << 5), CRM_BASE + 0x64);\r\nclk_enable(&iim_clk);\r\nimx_print_silicon_rev("i.MX25", mx25_revision());\r\nclk_disable(&iim_clk);\r\nmxc_timer_init(&gpt_clk, MX25_IO_ADDRESS(MX25_GPT1_BASE_ADDR), 54);\r\nreturn 0;\r\n}

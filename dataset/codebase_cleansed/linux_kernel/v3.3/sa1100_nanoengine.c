static int nanoengine_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nunsigned i = skt->nr;\r\nif (i >= num_nano_pcmcia_sockets)\r\nreturn -ENXIO;\r\nGPDR &= ~nano_skts[i].input_pins;\r\nGPDR |= nano_skts[i].output_pins;\r\nGPCR = nano_skts[i].clear_outputs;\r\nirq_set_irq_type(nano_skts[i].transition_pins, IRQ_TYPE_EDGE_BOTH);\r\nskt->socket.pci_irq = nano_skts[i].pci_irq;\r\nreturn soc_pcmcia_request_irqs(skt,\r\nnano_skts[i].pcmcia_irqs, nano_skts[i].pcmcia_irqs_size);\r\n}\r\nstatic void nanoengine_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\nunsigned i = skt->nr;\r\nif (i >= num_nano_pcmcia_sockets)\r\nreturn;\r\nsoc_pcmcia_free_irqs(skt,\r\nnano_skts[i].pcmcia_irqs, nano_skts[i].pcmcia_irqs_size);\r\n}\r\nstatic int nanoengine_pcmcia_configure_socket(\r\nstruct soc_pcmcia_socket *skt, const socket_state_t *state)\r\n{\r\nunsigned reset;\r\nunsigned i = skt->nr;\r\nif (i >= num_nano_pcmcia_sockets)\r\nreturn -ENXIO;\r\nswitch (i) {\r\ncase 0:\r\nreset = GPIO_PC_RESET0;\r\nbreak;\r\ncase 1:\r\nreset = GPIO_PC_RESET1;\r\nbreak;\r\ndefault:\r\nreturn -ENXIO;\r\n}\r\nif (state->flags & SS_RESET)\r\nGPSR = reset;\r\nelse\r\nGPCR = reset;\r\nreturn 0;\r\n}\r\nstatic void nanoengine_pcmcia_socket_state(\r\nstruct soc_pcmcia_socket *skt, struct pcmcia_state *state)\r\n{\r\nunsigned long levels = GPLR;\r\nunsigned i = skt->nr;\r\nif (i >= num_nano_pcmcia_sockets)\r\nreturn;\r\nmemset(state, 0, sizeof(struct pcmcia_state));\r\nswitch (i) {\r\ncase 0:\r\nstate->ready = (levels & GPIO_PC_READY0) ? 1 : 0;\r\nstate->detect = !(levels & GPIO_PC_CD0) ? 1 : 0;\r\nbreak;\r\ncase 1:\r\nstate->ready = (levels & GPIO_PC_READY1) ? 1 : 0;\r\nstate->detect = !(levels & GPIO_PC_CD1) ? 1 : 0;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nstate->bvd1 = 1;\r\nstate->bvd2 = 1;\r\nstate->wrprot = 0;\r\nstate->vs_3v = 1;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic void nanoengine_pcmcia_socket_init(struct soc_pcmcia_socket *skt)\r\n{\r\nunsigned i = skt->nr;\r\nif (i >= num_nano_pcmcia_sockets)\r\nreturn;\r\nsoc_pcmcia_enable_irqs(skt,\r\nnano_skts[i].pcmcia_irqs, nano_skts[i].pcmcia_irqs_size);\r\n}\r\nstatic void nanoengine_pcmcia_socket_suspend(struct soc_pcmcia_socket *skt)\r\n{\r\nunsigned i = skt->nr;\r\nif (i >= num_nano_pcmcia_sockets)\r\nreturn;\r\nsoc_pcmcia_disable_irqs(skt,\r\nnano_skts[i].pcmcia_irqs, nano_skts[i].pcmcia_irqs_size);\r\n}\r\nint pcmcia_nanoengine_init(struct device *dev)\r\n{\r\nint ret = -ENODEV;\r\nif (machine_is_nanoengine())\r\nret = sa11xx_drv_pcmcia_probe(\r\ndev, &nanoengine_pcmcia_ops, 0, 2);\r\nreturn ret;\r\n}

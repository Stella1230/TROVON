void __init amiga_chip_init(void)\r\n{\r\nif (!AMIGAHW_PRESENT(CHIP_RAM))\r\nreturn;\r\nchipram_res.end = CHIP_PHYSADDR + amiga_chip_size - 1;\r\nrequest_resource(&iomem_resource, &chipram_res);\r\natomic_set(&chipavail, amiga_chip_size);\r\n}\r\nvoid *amiga_chip_alloc(unsigned long size, const char *name)\r\n{\r\nstruct resource *res;\r\nvoid *p;\r\nres = kzalloc(sizeof(struct resource), GFP_KERNEL);\r\nif (!res)\r\nreturn NULL;\r\nres->name = name;\r\np = amiga_chip_alloc_res(size, res);\r\nif (!p) {\r\nkfree(res);\r\nreturn NULL;\r\n}\r\nreturn p;\r\n}\r\nvoid *amiga_chip_alloc_res(unsigned long size, struct resource *res)\r\n{\r\nint error;\r\nsize = PAGE_ALIGN(size);\r\npr_debug("amiga_chip_alloc_res: allocate %lu bytes\n", size);\r\nerror = allocate_resource(&chipram_res, res, size, 0, UINT_MAX,\r\nPAGE_SIZE, NULL, NULL);\r\nif (error < 0) {\r\npr_err("amiga_chip_alloc_res: allocate_resource() failed %d!\n",\r\nerror);\r\nreturn NULL;\r\n}\r\natomic_sub(size, &chipavail);\r\npr_debug("amiga_chip_alloc_res: returning %pR\n", res);\r\nreturn (void *)ZTWO_VADDR(res->start);\r\n}\r\nvoid amiga_chip_free(void *ptr)\r\n{\r\nunsigned long start = ZTWO_PADDR(ptr);\r\nstruct resource *res;\r\nunsigned long size;\r\nres = lookup_resource(&chipram_res, start);\r\nif (!res) {\r\npr_err("amiga_chip_free: trying to free nonexistent region at "\r\n"%p\n", ptr);\r\nreturn;\r\n}\r\nsize = resource_size(res);\r\npr_debug("amiga_chip_free: free %lu bytes at %p\n", size, ptr);\r\natomic_add(size, &chipavail);\r\nrelease_resource(res);\r\nkfree(res);\r\n}\r\nunsigned long amiga_chip_avail(void)\r\n{\r\nunsigned long n = atomic_read(&chipavail);\r\npr_debug("amiga_chip_avail : %lu bytes\n", n);\r\nreturn n;\r\n}

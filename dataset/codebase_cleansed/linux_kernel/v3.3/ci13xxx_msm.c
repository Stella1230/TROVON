static irqreturn_t msm_udc_irq(int irq, void *data)\r\n{\r\nreturn udc_irq();\r\n}\r\nstatic void ci13xxx_msm_notify_event(struct ci13xxx *udc, unsigned event)\r\n{\r\nstruct device *dev = udc->gadget.dev.parent;\r\nint val;\r\nswitch (event) {\r\ncase CI13XXX_CONTROLLER_RESET_EVENT:\r\ndev_dbg(dev, "CI13XXX_CONTROLLER_RESET_EVENT received\n");\r\nwritel(0, USB_AHBBURST);\r\nwritel(0, USB_AHBMODE);\r\nbreak;\r\ncase CI13XXX_CONTROLLER_STOPPED_EVENT:\r\ndev_dbg(dev, "CI13XXX_CONTROLLER_STOPPED_EVENT received\n");\r\nval = otg_io_read(udc->transceiver, ULPI_FUNC_CTRL);\r\nval &= ~ULPI_FUNC_CTRL_OPMODE_MASK;\r\nval |= ULPI_FUNC_CTRL_OPMODE_NONDRIVING;\r\notg_io_write(udc->transceiver, val, ULPI_FUNC_CTRL);\r\nbreak;\r\ndefault:\r\ndev_dbg(dev, "unknown ci13xxx_udc event\n");\r\nbreak;\r\n}\r\n}\r\nstatic int ci13xxx_msm_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nvoid __iomem *regs;\r\nint irq;\r\nint ret;\r\ndev_dbg(&pdev->dev, "ci13xxx_msm_probe\n");\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "failed to get platform resource mem\n");\r\nreturn -ENXIO;\r\n}\r\nregs = ioremap(res->start, resource_size(res));\r\nif (!regs) {\r\ndev_err(&pdev->dev, "ioremap failed\n");\r\nreturn -ENOMEM;\r\n}\r\nret = udc_probe(&ci13xxx_msm_udc_driver, &pdev->dev, regs);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "udc_probe failed\n");\r\ngoto iounmap;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "IRQ not found\n");\r\nret = -ENXIO;\r\ngoto udc_remove;\r\n}\r\nret = request_irq(irq, msm_udc_irq, IRQF_SHARED, pdev->name, pdev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "request_irq failed\n");\r\ngoto udc_remove;\r\n}\r\npm_runtime_no_callbacks(&pdev->dev);\r\npm_runtime_enable(&pdev->dev);\r\nreturn 0;\r\nudc_remove:\r\nudc_remove();\r\niounmap:\r\niounmap(regs);\r\nreturn ret;\r\n}\r\nstatic int __init ci13xxx_msm_init(void)\r\n{\r\nreturn platform_driver_register(&ci13xxx_msm_driver);\r\n}

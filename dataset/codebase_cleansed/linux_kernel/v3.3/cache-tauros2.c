static inline void tauros2_clean_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c7, c11, 3" : : "r" (addr));\r\n}\r\nstatic inline void tauros2_clean_inv_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c7, c15, 3" : : "r" (addr));\r\n}\r\nstatic inline void tauros2_inv_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c7, c7, 3" : : "r" (addr));\r\n}\r\nstatic void tauros2_inv_range(unsigned long start, unsigned long end)\r\n{\r\nif (start & (CACHE_LINE_SIZE - 1)) {\r\ntauros2_clean_inv_pa(start & ~(CACHE_LINE_SIZE - 1));\r\nstart = (start | (CACHE_LINE_SIZE - 1)) + 1;\r\n}\r\nif (end & (CACHE_LINE_SIZE - 1)) {\r\ntauros2_clean_inv_pa(end & ~(CACHE_LINE_SIZE - 1));\r\nend &= ~(CACHE_LINE_SIZE - 1);\r\n}\r\nwhile (start < end) {\r\ntauros2_inv_pa(start);\r\nstart += CACHE_LINE_SIZE;\r\n}\r\ndsb();\r\n}\r\nstatic void tauros2_clean_range(unsigned long start, unsigned long end)\r\n{\r\nstart &= ~(CACHE_LINE_SIZE - 1);\r\nwhile (start < end) {\r\ntauros2_clean_pa(start);\r\nstart += CACHE_LINE_SIZE;\r\n}\r\ndsb();\r\n}\r\nstatic void tauros2_flush_range(unsigned long start, unsigned long end)\r\n{\r\nstart &= ~(CACHE_LINE_SIZE - 1);\r\nwhile (start < end) {\r\ntauros2_clean_inv_pa(start);\r\nstart += CACHE_LINE_SIZE;\r\n}\r\ndsb();\r\n}\r\nstatic inline u32 __init read_extra_features(void)\r\n{\r\nu32 u;\r\n__asm__("mrc p15, 1, %0, c15, c1, 0" : "=r" (u));\r\nreturn u;\r\n}\r\nstatic inline void __init write_extra_features(u32 u)\r\n{\r\n__asm__("mcr p15, 1, %0, c15, c1, 0" : : "r" (u));\r\n}\r\nstatic void __init disable_l2_prefetch(void)\r\n{\r\nu32 u;\r\nu = read_extra_features();\r\nif (!(u & 0x01000000)) {\r\nprintk(KERN_INFO "Tauros2: Disabling L2 prefetch.\n");\r\nwrite_extra_features(u | 0x01000000);\r\n}\r\n}\r\nstatic inline int __init cpuid_scheme(void)\r\n{\r\nextern int processor_id;\r\nreturn !!((processor_id & 0x000f0000) == 0x000f0000);\r\n}\r\nstatic inline u32 __init read_mmfr3(void)\r\n{\r\nu32 mmfr3;\r\n__asm__("mrc p15, 0, %0, c0, c1, 7\n" : "=r" (mmfr3));\r\nreturn mmfr3;\r\n}\r\nstatic inline u32 __init read_actlr(void)\r\n{\r\nu32 actlr;\r\n__asm__("mrc p15, 0, %0, c1, c0, 1\n" : "=r" (actlr));\r\nreturn actlr;\r\n}\r\nstatic inline void __init write_actlr(u32 actlr)\r\n{\r\n__asm__("mcr p15, 0, %0, c1, c0, 1\n" : : "r" (actlr));\r\n}\r\nvoid __init tauros2_init(void)\r\n{\r\nextern int processor_id;\r\nchar *mode;\r\ndisable_l2_prefetch();\r\n#ifdef CONFIG_CPU_32v5\r\nif ((processor_id & 0xff0f0000) == 0x56050000) {\r\nu32 feat;\r\nfeat = read_extra_features();\r\nif (!(feat & 0x00400000)) {\r\nprintk(KERN_INFO "Tauros2: Enabling L2 cache.\n");\r\nwrite_extra_features(feat | 0x00400000);\r\n}\r\nmode = "ARMv5";\r\nouter_cache.inv_range = tauros2_inv_range;\r\nouter_cache.clean_range = tauros2_clean_range;\r\nouter_cache.flush_range = tauros2_flush_range;\r\n}\r\n#endif\r\n#ifdef CONFIG_CPU_32v6\r\nif (cpuid_scheme() && (read_mmfr3() & 0xf) == 0) {\r\nif (!(get_cr() & 0x04000000)) {\r\nprintk(KERN_INFO "Tauros2: Enabling L2 cache.\n");\r\nadjust_cr(0x04000000, 0x04000000);\r\n}\r\nmode = "ARMv6";\r\nouter_cache.inv_range = tauros2_inv_range;\r\nouter_cache.clean_range = tauros2_clean_range;\r\nouter_cache.flush_range = tauros2_flush_range;\r\n}\r\n#endif\r\n#ifdef CONFIG_CPU_32v7\r\nif (cpuid_scheme() && (read_mmfr3() & 0xf) == 1) {\r\nu32 actlr;\r\nactlr = read_actlr();\r\nif (!(actlr & 0x00000002)) {\r\nprintk(KERN_INFO "Tauros2: Enabling L2 cache.\n");\r\nwrite_actlr(actlr | 0x00000002);\r\n}\r\nmode = "ARMv7";\r\n}\r\n#endif\r\nif (mode == NULL) {\r\nprintk(KERN_CRIT "Tauros2: Unable to detect CPU mode.\n");\r\nreturn;\r\n}\r\nprintk(KERN_INFO "Tauros2: L2 cache support initialised "\r\n"in %s mode.\n", mode);\r\n}

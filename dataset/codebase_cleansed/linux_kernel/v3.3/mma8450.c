static int mma8450_read(struct mma8450 *m, unsigned off)\r\n{\r\nstruct i2c_client *c = m->client;\r\nint ret;\r\nret = i2c_smbus_read_byte_data(c, off);\r\nif (ret < 0)\r\ndev_err(&c->dev,\r\n"failed to read register 0x%02x, error %d\n",\r\noff, ret);\r\nreturn ret;\r\n}\r\nstatic int mma8450_write(struct mma8450 *m, unsigned off, u8 v)\r\n{\r\nstruct i2c_client *c = m->client;\r\nint error;\r\nerror = i2c_smbus_write_byte_data(c, off, v);\r\nif (error < 0) {\r\ndev_err(&c->dev,\r\n"failed to write to register 0x%02x, error %d\n",\r\noff, error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mma8450_read_block(struct mma8450 *m, unsigned off,\r\nu8 *buf, size_t size)\r\n{\r\nstruct i2c_client *c = m->client;\r\nint err;\r\nerr = i2c_smbus_read_i2c_block_data(c, off, size, buf);\r\nif (err < 0) {\r\ndev_err(&c->dev,\r\n"failed to read block data at 0x%02x, error %d\n",\r\nMMA8450_OUT_X_LSB, err);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mma8450_poll(struct input_polled_dev *dev)\r\n{\r\nstruct mma8450 *m = dev->private;\r\nint x, y, z;\r\nint ret;\r\nu8 buf[6];\r\nret = mma8450_read(m, MMA8450_STATUS);\r\nif (ret < 0)\r\nreturn;\r\nif (!(ret & MMA8450_STATUS_ZXYDR))\r\nreturn;\r\nret = mma8450_read_block(m, MMA8450_OUT_X_LSB, buf, sizeof(buf));\r\nif (ret < 0)\r\nreturn;\r\nx = ((buf[1] << 4) & 0xff0) | (buf[0] & 0xf);\r\ny = ((buf[3] << 4) & 0xff0) | (buf[2] & 0xf);\r\nz = ((buf[5] << 4) & 0xff0) | (buf[4] & 0xf);\r\ninput_report_abs(dev->input, ABS_X, x);\r\ninput_report_abs(dev->input, ABS_Y, y);\r\ninput_report_abs(dev->input, ABS_Z, z);\r\ninput_sync(dev->input);\r\n}\r\nstatic void mma8450_open(struct input_polled_dev *dev)\r\n{\r\nstruct mma8450 *m = dev->private;\r\nint err;\r\nerr = mma8450_write(m, MMA8450_XYZ_DATA_CFG, 0x07);\r\nif (err)\r\nreturn;\r\nerr = mma8450_write(m, MMA8450_CTRL_REG1, 0x01);\r\nif (err < 0)\r\nreturn;\r\nmsleep(MODE_CHANGE_DELAY_MS);\r\n}\r\nstatic void mma8450_close(struct input_polled_dev *dev)\r\n{\r\nstruct mma8450 *m = dev->private;\r\nmma8450_write(m, MMA8450_CTRL_REG1, 0x00);\r\nmma8450_write(m, MMA8450_CTRL_REG2, 0x01);\r\n}\r\nstatic int __devinit mma8450_probe(struct i2c_client *c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct input_polled_dev *idev;\r\nstruct mma8450 *m;\r\nint err;\r\nm = kzalloc(sizeof(struct mma8450), GFP_KERNEL);\r\nidev = input_allocate_polled_device();\r\nif (!m || !idev) {\r\nerr = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\nm->client = c;\r\nm->idev = idev;\r\nidev->private = m;\r\nidev->input->name = MMA8450_DRV_NAME;\r\nidev->input->id.bustype = BUS_I2C;\r\nidev->poll = mma8450_poll;\r\nidev->poll_interval = POLL_INTERVAL;\r\nidev->poll_interval_max = POLL_INTERVAL_MAX;\r\nidev->open = mma8450_open;\r\nidev->close = mma8450_close;\r\n__set_bit(EV_ABS, idev->input->evbit);\r\ninput_set_abs_params(idev->input, ABS_X, -2048, 2047, 32, 32);\r\ninput_set_abs_params(idev->input, ABS_Y, -2048, 2047, 32, 32);\r\ninput_set_abs_params(idev->input, ABS_Z, -2048, 2047, 32, 32);\r\nerr = input_register_polled_device(idev);\r\nif (err) {\r\ndev_err(&c->dev, "failed to register polled input device\n");\r\ngoto err_free_mem;\r\n}\r\nreturn 0;\r\nerr_free_mem:\r\ninput_free_polled_device(idev);\r\nkfree(m);\r\nreturn err;\r\n}\r\nstatic int __devexit mma8450_remove(struct i2c_client *c)\r\n{\r\nstruct mma8450 *m = i2c_get_clientdata(c);\r\nstruct input_polled_dev *idev = m->idev;\r\ninput_unregister_polled_device(idev);\r\ninput_free_polled_device(idev);\r\nkfree(m);\r\nreturn 0;\r\n}\r\nstatic int __init mma8450_init(void)\r\n{\r\nreturn i2c_add_driver(&mma8450_driver);\r\n}\r\nstatic void __exit mma8450_exit(void)\r\n{\r\ni2c_del_driver(&mma8450_driver);\r\n}

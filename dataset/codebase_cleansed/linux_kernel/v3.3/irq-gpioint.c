static int s5p_gpioint_set_type(struct irq_data *d, unsigned int type)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(d);\r\nstruct irq_chip_type *ct = gc->chip_types;\r\nunsigned int shift = (d->irq - gc->irq_base) << 2;\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\ntype = S5P_IRQ_TYPE_EDGE_RISING;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\ntype = S5P_IRQ_TYPE_EDGE_FALLING;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_BOTH:\r\ntype = S5P_IRQ_TYPE_EDGE_BOTH;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\ntype = S5P_IRQ_TYPE_LEVEL_HIGH;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\ntype = S5P_IRQ_TYPE_LEVEL_LOW;\r\nbreak;\r\ncase IRQ_TYPE_NONE:\r\ndefault:\r\nprintk(KERN_WARNING "No irq type\n");\r\nreturn -EINVAL;\r\n}\r\ngc->type_cache &= ~(0x7 << shift);\r\ngc->type_cache |= type << shift;\r\nwritel(gc->type_cache, gc->reg_base + ct->regs.type);\r\nreturn 0;\r\n}\r\nstatic void s5p_gpioint_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct s5p_gpioint_bank *bank = irq_get_handler_data(irq);\r\nint group, pend_offset, mask_offset;\r\nunsigned int pend, mask;\r\nstruct irq_chip *chip = irq_get_chip(irq);\r\nchained_irq_enter(chip, desc);\r\nfor (group = 0; group < bank->nr_groups; group++) {\r\nstruct samsung_gpio_chip *chip = bank->chips[group];\r\nif (!chip)\r\ncontinue;\r\npend_offset = REG_OFFSET(group);\r\npend = __raw_readl(GPIO_BASE(chip) + PEND_OFFSET + pend_offset);\r\nif (!pend)\r\ncontinue;\r\nmask_offset = REG_OFFSET(group);\r\nmask = __raw_readl(GPIO_BASE(chip) + MASK_OFFSET + mask_offset);\r\npend &= ~mask;\r\nwhile (pend) {\r\nint offset = fls(pend) - 1;\r\nint real_irq = chip->irq_base + offset;\r\ngeneric_handle_irq(real_irq);\r\npend &= ~BIT(offset);\r\n}\r\n}\r\nchained_irq_exit(chip, desc);\r\n}\r\nstatic __init int s5p_gpioint_add(struct samsung_gpio_chip *chip)\r\n{\r\nstatic int used_gpioint_groups = 0;\r\nint group = chip->group;\r\nstruct s5p_gpioint_bank *b, *bank = NULL;\r\nstruct irq_chip_generic *gc;\r\nstruct irq_chip_type *ct;\r\nif (used_gpioint_groups >= S5P_GPIOINT_GROUP_COUNT)\r\nreturn -ENOMEM;\r\nlist_for_each_entry(b, &banks, list) {\r\nif (group >= b->start && group < b->start + b->nr_groups) {\r\nbank = b;\r\nbreak;\r\n}\r\n}\r\nif (!bank)\r\nreturn -EINVAL;\r\nif (!bank->handler) {\r\nbank->chips = kzalloc(sizeof(struct samsung_gpio_chip *) *\r\nbank->nr_groups, GFP_KERNEL);\r\nif (!bank->chips)\r\nreturn -ENOMEM;\r\nirq_set_chained_handler(bank->irq, s5p_gpioint_handler);\r\nirq_set_handler_data(bank->irq, bank);\r\nbank->handler = s5p_gpioint_handler;\r\nprintk(KERN_INFO "Registered chained gpio int handler for interrupt %d.\n",\r\nbank->irq);\r\n}\r\nchip->irq_base = S5P_GPIOINT_BASE +\r\nused_gpioint_groups * S5P_GPIOINT_GROUP_SIZE;\r\nused_gpioint_groups++;\r\nbank->chips[group - bank->start] = chip;\r\ngc = irq_alloc_generic_chip("s5p_gpioint", 1, chip->irq_base,\r\n(void __iomem *)GPIO_BASE(chip),\r\nhandle_level_irq);\r\nif (!gc)\r\nreturn -ENOMEM;\r\nct = gc->chip_types;\r\nct->chip.irq_ack = irq_gc_ack_set_bit;\r\nct->chip.irq_mask = irq_gc_mask_set_bit;\r\nct->chip.irq_unmask = irq_gc_mask_clr_bit;\r\nct->chip.irq_set_type = s5p_gpioint_set_type,\r\nct->regs.ack = PEND_OFFSET + REG_OFFSET(group - bank->start);\r\nct->regs.mask = MASK_OFFSET + REG_OFFSET(group - bank->start);\r\nct->regs.type = CON_OFFSET + REG_OFFSET(group - bank->start);\r\nirq_setup_generic_chip(gc, IRQ_MSK(chip->chip.ngpio),\r\nIRQ_GC_INIT_MASK_CACHE,\r\nIRQ_NOREQUEST | IRQ_NOPROBE, 0);\r\nreturn 0;\r\n}\r\nint __init s5p_register_gpio_interrupt(int pin)\r\n{\r\nstruct samsung_gpio_chip *my_chip = samsung_gpiolib_getchip(pin);\r\nint offset, group;\r\nint ret;\r\nif (!my_chip)\r\nreturn -EINVAL;\r\noffset = pin - my_chip->chip.base;\r\ngroup = my_chip->group;\r\nif (my_chip->irq_base)\r\nreturn my_chip->irq_base + offset;\r\nret = s5p_gpioint_add(my_chip);\r\nif (ret == 0) {\r\nmy_chip->chip.to_irq = samsung_gpiolib_to_irq;\r\nprintk(KERN_INFO "Registered interrupt support for gpio group %d.\n",\r\ngroup);\r\nreturn my_chip->irq_base + offset;\r\n}\r\nreturn ret;\r\n}\r\nint __init s5p_register_gpioint_bank(int chain_irq, int start, int nr_groups)\r\n{\r\nstruct s5p_gpioint_bank *bank;\r\nbank = kzalloc(sizeof(*bank), GFP_KERNEL);\r\nif (!bank)\r\nreturn -ENOMEM;\r\nbank->start = start;\r\nbank->nr_groups = nr_groups;\r\nbank->irq = chain_irq;\r\nlist_add_tail(&bank->list, &banks);\r\nreturn 0;\r\n}

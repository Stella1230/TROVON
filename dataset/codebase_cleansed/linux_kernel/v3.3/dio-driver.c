const struct dio_device_id *\r\ndio_match_device(const struct dio_device_id *ids,\r\nconst struct dio_dev *d)\r\n{\r\nwhile (ids->id) {\r\nif (ids->id == DIO_WILDCARD)\r\nreturn ids;\r\nif (DIO_NEEDSSECID(ids->id & 0xff)) {\r\nif (ids->id == d->id)\r\nreturn ids;\r\n} else {\r\nif ((ids->id & 0xff) == (d->id & 0xff))\r\nreturn ids;\r\n}\r\nids++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int dio_device_probe(struct device *dev)\r\n{\r\nint error = 0;\r\nstruct dio_driver *drv = to_dio_driver(dev->driver);\r\nstruct dio_dev *d = to_dio_dev(dev);\r\nif (!d->driver && drv->probe) {\r\nconst struct dio_device_id *id;\r\nid = dio_match_device(drv->id_table, d);\r\nif (id)\r\nerror = drv->probe(d, id);\r\nif (error >= 0) {\r\nd->driver = drv;\r\nerror = 0;\r\n}\r\n}\r\nreturn error;\r\n}\r\nint dio_register_driver(struct dio_driver *drv)\r\n{\r\ndrv->driver.name = drv->name;\r\ndrv->driver.bus = &dio_bus_type;\r\nreturn driver_register(&drv->driver);\r\n}\r\nvoid dio_unregister_driver(struct dio_driver *drv)\r\n{\r\ndriver_unregister(&drv->driver);\r\n}\r\nstatic int dio_bus_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct dio_dev *d = to_dio_dev(dev);\r\nstruct dio_driver *dio_drv = to_dio_driver(drv);\r\nconst struct dio_device_id *ids = dio_drv->id_table;\r\nif (!ids)\r\nreturn 0;\r\nreturn dio_match_device(ids, d) ? 1 : 0;\r\n}\r\nstatic int __init dio_driver_init(void)\r\n{\r\nreturn bus_register(&dio_bus_type);\r\n}

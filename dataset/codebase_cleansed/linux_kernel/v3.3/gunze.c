static void gunze_process_packet(struct gunze* gunze)\r\n{\r\nstruct input_dev *dev = gunze->dev;\r\nif (gunze->idx != GUNZE_MAX_LENGTH || gunze->data[5] != ',' ||\r\n(gunze->data[0] != 'T' && gunze->data[0] != 'R')) {\r\nprintk(KERN_WARNING "gunze.c: bad packet: >%.*s<\n", GUNZE_MAX_LENGTH, gunze->data);\r\nreturn;\r\n}\r\ninput_report_abs(dev, ABS_X, simple_strtoul(gunze->data + 1, NULL, 10));\r\ninput_report_abs(dev, ABS_Y, 1024 - simple_strtoul(gunze->data + 6, NULL, 10));\r\ninput_report_key(dev, BTN_TOUCH, gunze->data[0] == 'T');\r\ninput_sync(dev);\r\n}\r\nstatic irqreturn_t gunze_interrupt(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct gunze* gunze = serio_get_drvdata(serio);\r\nif (data == '\r') {\r\ngunze_process_packet(gunze);\r\ngunze->idx = 0;\r\n} else {\r\nif (gunze->idx < GUNZE_MAX_LENGTH)\r\ngunze->data[gunze->idx++] = data;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void gunze_disconnect(struct serio *serio)\r\n{\r\nstruct gunze *gunze = serio_get_drvdata(serio);\r\ninput_get_device(gunze->dev);\r\ninput_unregister_device(gunze->dev);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_put_device(gunze->dev);\r\nkfree(gunze);\r\n}\r\nstatic int gunze_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct gunze *gunze;\r\nstruct input_dev *input_dev;\r\nint err;\r\ngunze = kzalloc(sizeof(struct gunze), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!gunze || !input_dev) {\r\nerr = -ENOMEM;\r\ngoto fail1;\r\n}\r\ngunze->serio = serio;\r\ngunze->dev = input_dev;\r\nsnprintf(gunze->phys, sizeof(serio->phys), "%s/input0", serio->phys);\r\ninput_dev->name = "Gunze AHL-51S TouchScreen";\r\ninput_dev->phys = gunze->phys;\r\ninput_dev->id.bustype = BUS_RS232;\r\ninput_dev->id.vendor = SERIO_GUNZE;\r\ninput_dev->id.product = 0x0051;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &serio->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(input_dev, ABS_X, 24, 1000, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 24, 1000, 0, 0);\r\nserio_set_drvdata(serio, gunze);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(gunze->dev);\r\nif (err)\r\ngoto fail3;\r\nreturn 0;\r\nfail3: serio_close(serio);\r\nfail2: serio_set_drvdata(serio, NULL);\r\nfail1: input_free_device(input_dev);\r\nkfree(gunze);\r\nreturn err;\r\n}\r\nstatic int __init gunze_init(void)\r\n{\r\nreturn serio_register_driver(&gunze_drv);\r\n}\r\nstatic void __exit gunze_exit(void)\r\n{\r\nserio_unregister_driver(&gunze_drv);\r\n}

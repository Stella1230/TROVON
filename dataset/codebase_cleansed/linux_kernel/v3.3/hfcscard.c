static irqreturn_t\r\nhfcs_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val, stat;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nif ((HFCD_ANYINT | HFCD_BUSY_NBUSY) &\r\n(stat = cs->BC_Read_Reg(cs, HFCD_DATA, HFCD_STAT))) {\r\nval = cs->BC_Read_Reg(cs, HFCD_DATA, HFCD_INT_S1);\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "HFCS: stat(%02x) s1(%02x)", stat, val);\r\nhfc2bds0_interrupt(cs, val);\r\n} else {\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "HFCS: irq_no_irq stat(%02x)", stat);\r\n}\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nhfcs_Timer(struct IsdnCardState *cs)\r\n{\r\ncs->hw.hfcD.timer.expires = jiffies + 75;\r\n}\r\nstatic void\r\nrelease_io_hfcs(struct IsdnCardState *cs)\r\n{\r\nrelease2bds0(cs);\r\ndel_timer(&cs->hw.hfcD.timer);\r\nif (cs->hw.hfcD.addr)\r\nrelease_region(cs->hw.hfcD.addr, 2);\r\n}\r\nstatic void\r\nreset_hfcs(struct IsdnCardState *cs)\r\n{\r\nprintk(KERN_INFO "HFCS: resetting card\n");\r\ncs->hw.hfcD.cirm = HFCD_RESET;\r\nif (cs->typ == ISDN_CTYPE_TELES3C)\r\ncs->hw.hfcD.cirm |= HFCD_MEM8K;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_CIRM, cs->hw.hfcD.cirm);\r\nmdelay(10);\r\ncs->hw.hfcD.cirm = 0;\r\nif (cs->typ == ISDN_CTYPE_TELES3C)\r\ncs->hw.hfcD.cirm |= HFCD_MEM8K;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_CIRM, cs->hw.hfcD.cirm);\r\nmdelay(10);\r\nif (cs->typ == ISDN_CTYPE_TELES3C)\r\ncs->hw.hfcD.cirm |= HFCD_INTB;\r\nelse if (cs->typ == ISDN_CTYPE_ACERP10)\r\ncs->hw.hfcD.cirm |= HFCD_INTA;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_CIRM, cs->hw.hfcD.cirm);\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_CLKDEL, 0x0e);\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_TEST, HFCD_AUTO_AWAKE);\r\ncs->hw.hfcD.ctmt = HFCD_TIM25 | HFCD_AUTO_TIMER;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_CTMT, cs->hw.hfcD.ctmt);\r\ncs->hw.hfcD.int_m2 = HFCD_IRQ_ENABLE;\r\ncs->hw.hfcD.int_m1 = HFCD_INTS_B1TRANS | HFCD_INTS_B2TRANS |\r\nHFCD_INTS_DTRANS | HFCD_INTS_B1REC | HFCD_INTS_B2REC |\r\nHFCD_INTS_DREC | HFCD_INTS_L1STATE;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_INT_M1, cs->hw.hfcD.int_m1);\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_INT_M2, cs->hw.hfcD.int_m2);\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_STATES, HFCD_LOAD_STATE | 2);\r\nudelay(10);\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_STATES, 2);\r\ncs->hw.hfcD.mst_m = HFCD_MASTER;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_MST_MODE, cs->hw.hfcD.mst_m);\r\ncs->hw.hfcD.sctrl = 0;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_SCTRL, cs->hw.hfcD.sctrl);\r\n}\r\nstatic int\r\nhfcs_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nint delay;\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "HFCS: card_msg %x", mt);\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_hfcs(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_RELEASE:\r\nrelease_io_hfcs(cs);\r\nreturn(0);\r\ncase CARD_INIT:\r\ndelay = (75*HZ)/100 +1;\r\nmod_timer(&cs->hw.hfcD.timer, jiffies + delay);\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_hfcs(cs);\r\ninit2bds0(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\ndelay = (80*HZ)/1000 +1;\r\nmsleep(80);\r\nspin_lock_irqsave(&cs->lock, flags);\r\ncs->hw.hfcD.ctmt |= HFCD_TIM800;\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_CTMT, cs->hw.hfcD.ctmt);\r\ncs->BC_Write_Reg(cs, HFCD_DATA, HFCD_MST_MODE, cs->hw.hfcD.mst_m);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_TEST:\r\nreturn(0);\r\n}\r\nreturn(0);\r\n}\r\nint __devinit\r\nsetup_hfcs(struct IsdnCard *card)\r\n{\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, hfcs_revision);\r\nprintk(KERN_INFO "HiSax: HFC-S driver Rev. %s\n", HiSax_getrev(tmp));\r\n#ifdef __ISAPNP__\r\nif (!card->para[1] && isapnp_present()) {\r\nstruct pnp_dev *pnp_d;\r\nwhile(ipid->card_vendor) {\r\nif ((pnp_c = pnp_find_card(ipid->card_vendor,\r\nipid->card_device, pnp_c))) {\r\npnp_d = NULL;\r\nif ((pnp_d = pnp_find_dev(pnp_c,\r\nipid->vendor, ipid->function, pnp_d))) {\r\nint err;\r\nprintk(KERN_INFO "HiSax: %s detected\n",\r\n(char *)ipid->driver_data);\r\npnp_disable_dev(pnp_d);\r\nerr = pnp_activate_dev(pnp_d);\r\nif (err<0) {\r\nprintk(KERN_WARNING "%s: pnp_activate_dev ret(%d)\n",\r\n__func__, err);\r\nreturn(0);\r\n}\r\ncard->para[1] = pnp_port_start(pnp_d, 0);\r\ncard->para[0] = pnp_irq(pnp_d, 0);\r\nif (!card->para[0] || !card->para[1]) {\r\nprintk(KERN_ERR "HFC PnP:some resources are missing %ld/%lx\n",\r\ncard->para[0], card->para[1]);\r\npnp_disable_dev(pnp_d);\r\nreturn(0);\r\n}\r\nbreak;\r\n} else {\r\nprintk(KERN_ERR "HFC PnP: PnP error card found, no device\n");\r\n}\r\n}\r\nipid++;\r\npnp_c = NULL;\r\n}\r\nif (!ipid->card_vendor) {\r\nprintk(KERN_INFO "HFC PnP: no ISAPnP card found\n");\r\nreturn(0);\r\n}\r\n}\r\n#endif\r\ncs->hw.hfcD.addr = card->para[1] & 0xfffe;\r\ncs->irq = card->para[0];\r\ncs->hw.hfcD.cip = 0;\r\ncs->hw.hfcD.int_s1 = 0;\r\ncs->hw.hfcD.send = NULL;\r\ncs->bcs[0].hw.hfc.send = NULL;\r\ncs->bcs[1].hw.hfc.send = NULL;\r\ncs->hw.hfcD.dfifosize = 512;\r\ncs->dc.hfcd.ph_state = 0;\r\ncs->hw.hfcD.fifo = 255;\r\nif (cs->typ == ISDN_CTYPE_TELES3C) {\r\ncs->hw.hfcD.bfifosize = 1024 + 512;\r\n} else if (cs->typ == ISDN_CTYPE_ACERP10) {\r\ncs->hw.hfcD.bfifosize = 7*1024 + 512;\r\n} else\r\nreturn (0);\r\nif (!request_region(cs->hw.hfcD.addr, 2, "HFCS isdn")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s config port %x-%x already in use\n",\r\nCardType[card->typ],\r\ncs->hw.hfcD.addr,\r\ncs->hw.hfcD.addr + 2);\r\nreturn (0);\r\n}\r\nprintk(KERN_INFO\r\n"HFCS: defined at 0x%x IRQ %d HZ %d\n",\r\ncs->hw.hfcD.addr,\r\ncs->irq, HZ);\r\nif (cs->typ == ISDN_CTYPE_TELES3C) {\r\noutb(0x00, cs->hw.hfcD.addr);\r\noutb(0x56, cs->hw.hfcD.addr | 1);\r\n} else if (cs->typ == ISDN_CTYPE_ACERP10) {\r\noutb(0x00, cs->hw.hfcD.addr);\r\noutb(0x57, cs->hw.hfcD.addr | 1);\r\n}\r\nset_cs_func(cs);\r\ncs->hw.hfcD.timer.function = (void *) hfcs_Timer;\r\ncs->hw.hfcD.timer.data = (long) cs;\r\ninit_timer(&cs->hw.hfcD.timer);\r\ncs->cardmsg = &hfcs_card_msg;\r\ncs->irq_func = &hfcs_interrupt;\r\nreturn (1);\r\n}

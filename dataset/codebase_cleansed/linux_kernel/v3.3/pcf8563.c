unsigned char\r\npcf8563_readreg(int reg)\r\n{\r\nunsigned char res = rtc_read(reg);\r\nswitch (reg) {\r\ncase RTC_SECONDS:\r\ncase RTC_MINUTES:\r\nres &= 0x7F;\r\nbreak;\r\ncase RTC_HOURS:\r\ncase RTC_DAY_OF_MONTH:\r\nres &= 0x3F;\r\nbreak;\r\ncase RTC_WEEKDAY:\r\nres &= 0x07;\r\nbreak;\r\ncase RTC_MONTH:\r\nres &= 0x1F;\r\nbreak;\r\ncase RTC_CONTROL1:\r\nres &= 0xA8;\r\nbreak;\r\ncase RTC_CONTROL2:\r\nres &= 0x1F;\r\nbreak;\r\ncase RTC_CLOCKOUT_FREQ:\r\ncase RTC_TIMER_CONTROL:\r\nres &= 0x83;\r\nbreak;\r\n}\r\nreturn res;\r\n}\r\nvoid\r\npcf8563_writereg(int reg, unsigned char val)\r\n{\r\nrtc_write(reg, val);\r\n}\r\nvoid\r\nget_rtc_time(struct rtc_time *tm)\r\n{\r\ntm->tm_sec = rtc_read(RTC_SECONDS);\r\ntm->tm_min = rtc_read(RTC_MINUTES);\r\ntm->tm_hour = rtc_read(RTC_HOURS);\r\ntm->tm_mday = rtc_read(RTC_DAY_OF_MONTH);\r\ntm->tm_wday = rtc_read(RTC_WEEKDAY);\r\ntm->tm_mon = rtc_read(RTC_MONTH);\r\ntm->tm_year = rtc_read(RTC_YEAR);\r\nif (tm->tm_sec & 0x80) {\r\nprintk(KERN_ERR "%s: RTC Voltage Low - reliable date/time "\r\n"information is no longer guaranteed!\n", PCF8563_NAME);\r\n}\r\ntm->tm_year = bcd2bin(tm->tm_year) +\r\n((tm->tm_mon & 0x80) ? 100 : 0);\r\ntm->tm_sec &= 0x7F;\r\ntm->tm_min &= 0x7F;\r\ntm->tm_hour &= 0x3F;\r\ntm->tm_mday &= 0x3F;\r\ntm->tm_wday &= 0x07;\r\ntm->tm_mon &= 0x1F;\r\ntm->tm_sec = bcd2bin(tm->tm_sec);\r\ntm->tm_min = bcd2bin(tm->tm_min);\r\ntm->tm_hour = bcd2bin(tm->tm_hour);\r\ntm->tm_mday = bcd2bin(tm->tm_mday);\r\ntm->tm_mon = bcd2bin(tm->tm_mon);\r\ntm->tm_mon--;\r\n}\r\nint __init\r\npcf8563_init(void)\r\n{\r\nstatic int res;\r\nstatic int first = 1;\r\nif (!first)\r\nreturn res;\r\nfirst = 0;\r\nres = i2c_init();\r\nif (res < 0) {\r\nprintk(KERN_CRIT "pcf8563_init: Failed to init i2c.\n");\r\nreturn res;\r\n}\r\nif (rtc_write(RTC_CONTROL1, 0x00) < 0)\r\ngoto err;\r\nif (rtc_write(RTC_CONTROL2, 0x00) < 0)\r\ngoto err;\r\nif (rtc_write(RTC_CLOCKOUT_FREQ, 0x00) < 0)\r\ngoto err;\r\nif (rtc_write(RTC_TIMER_CONTROL, 0x03) < 0)\r\ngoto err;\r\nif (rtc_write(RTC_MINUTE_ALARM, 0x80) < 0)\r\ngoto err;\r\nif (rtc_write(RTC_HOUR_ALARM, 0x80) < 0)\r\ngoto err;\r\nif (rtc_write(RTC_DAY_ALARM, 0x80) < 0)\r\ngoto err;\r\nif (rtc_write(RTC_WEEKDAY_ALARM, 0x80) < 0)\r\ngoto err;\r\nif (rtc_read(RTC_SECONDS) & 0x80) {\r\nvoltage_low = 1;\r\nprintk(KERN_WARNING "%s: RTC Voltage Low - reliable "\r\n"date/time information is no longer guaranteed!\n",\r\nPCF8563_NAME);\r\n}\r\nreturn res;\r\nerr:\r\nprintk(KERN_INFO "%s: Error initializing chip.\n", PCF8563_NAME);\r\nres = -1;\r\nreturn res;\r\n}\r\nvoid __exit\r\npcf8563_exit(void)\r\n{\r\nunregister_chrdev(PCF8563_MAJOR, DEVICE_NAME);\r\n}\r\nstatic int pcf8563_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nif (_IOC_TYPE(cmd) != RTC_MAGIC)\r\nreturn -ENOTTY;\r\nif (_IOC_NR(cmd) > RTC_MAX_IOCTL)\r\nreturn -ENOTTY;\r\nswitch (cmd) {\r\ncase RTC_RD_TIME:\r\n{\r\nstruct rtc_time tm;\r\nmutex_lock(&rtc_lock);\r\nmemset(&tm, 0, sizeof tm);\r\nget_rtc_time(&tm);\r\nif (copy_to_user((struct rtc_time *) arg, &tm,\r\nsizeof tm)) {\r\nmutex_unlock(&rtc_lock);\r\nreturn -EFAULT;\r\n}\r\nmutex_unlock(&rtc_lock);\r\nreturn 0;\r\n}\r\ncase RTC_SET_TIME:\r\n{\r\nint leap;\r\nint year;\r\nint century;\r\nstruct rtc_time tm;\r\nmemset(&tm, 0, sizeof tm);\r\nif (!capable(CAP_SYS_TIME))\r\nreturn -EPERM;\r\nif (copy_from_user(&tm, (struct rtc_time *) arg, sizeof tm))\r\nreturn -EFAULT;\r\ntm.tm_year += 1900;\r\ntm.tm_mon += 1;\r\nyear = tm.tm_year;\r\nleap = (tm.tm_mon == 2) &&\r\n((year % 4 == 0 && year % 100 != 0) || year % 400 == 0);\r\nif ((tm.tm_year < 1970) ||\r\n(tm.tm_mon > 12) ||\r\n(tm.tm_mday == 0) ||\r\n(tm.tm_mday > days_in_month[tm.tm_mon] + leap) ||\r\n(tm.tm_wday >= 7) ||\r\n(tm.tm_hour >= 24) ||\r\n(tm.tm_min >= 60) ||\r\n(tm.tm_sec >= 60))\r\nreturn -EINVAL;\r\ncentury = (tm.tm_year >= 2000) ? 0x80 : 0;\r\ntm.tm_year = tm.tm_year % 100;\r\ntm.tm_year = bin2bcd(tm.tm_year);\r\ntm.tm_mon = bin2bcd(tm.tm_mon);\r\ntm.tm_mday = bin2bcd(tm.tm_mday);\r\ntm.tm_hour = bin2bcd(tm.tm_hour);\r\ntm.tm_min = bin2bcd(tm.tm_min);\r\ntm.tm_sec = bin2bcd(tm.tm_sec);\r\ntm.tm_mon |= century;\r\nmutex_lock(&rtc_lock);\r\nrtc_write(RTC_YEAR, tm.tm_year);\r\nrtc_write(RTC_MONTH, tm.tm_mon);\r\nrtc_write(RTC_WEEKDAY, tm.tm_wday);\r\nrtc_write(RTC_DAY_OF_MONTH, tm.tm_mday);\r\nrtc_write(RTC_HOURS, tm.tm_hour);\r\nrtc_write(RTC_MINUTES, tm.tm_min);\r\nrtc_write(RTC_SECONDS, tm.tm_sec);\r\nmutex_unlock(&rtc_lock);\r\nreturn 0;\r\n}\r\ncase RTC_VL_READ:\r\nif (voltage_low) {\r\nprintk(KERN_ERR "%s: RTC Voltage Low - "\r\n"reliable date/time information is no "\r\n"longer guaranteed!\n", PCF8563_NAME);\r\n}\r\nif (copy_to_user((int *) arg, &voltage_low, sizeof(int)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase RTC_VL_CLR:\r\n{\r\nint ret = rtc_read(RTC_SECONDS);\r\nrtc_write(RTC_SECONDS, (ret & 0x7F));\r\nvoltage_low = 0;\r\nreturn 0;\r\n}\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nstatic long pcf8563_unlocked_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nint ret;\r\nmutex_lock(&pcf8563_mutex);\r\nret = pcf8563_ioctl(filp, cmd, arg);\r\nmutex_unlock(&pcf8563_mutex);\r\nreturn ret;\r\n}\r\nstatic int __init pcf8563_register(void)\r\n{\r\nif (pcf8563_init() < 0) {\r\nprintk(KERN_INFO "%s: Unable to initialize Real-Time Clock "\r\n"Driver, %s\n", PCF8563_NAME, DRIVER_VERSION);\r\nreturn -1;\r\n}\r\nif (register_chrdev(PCF8563_MAJOR, DEVICE_NAME, &pcf8563_fops) < 0) {\r\nprintk(KERN_INFO "%s: Unable to get major number %d for RTC device.\n",\r\nPCF8563_NAME, PCF8563_MAJOR);\r\nreturn -1;\r\n}\r\nprintk(KERN_INFO "%s Real-Time Clock Driver, %s\n", PCF8563_NAME,\r\nDRIVER_VERSION);\r\nif (voltage_low) {\r\nprintk(KERN_WARNING "%s: RTC Voltage Low - reliable date/time "\r\n"information is no longer guaranteed!\n", PCF8563_NAME);\r\n}\r\nreturn 0;\r\n}

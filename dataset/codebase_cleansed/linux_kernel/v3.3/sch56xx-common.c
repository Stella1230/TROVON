static inline int superio_inb(int base, int reg)\r\n{\r\noutb(reg, base);\r\nreturn inb(base + 1);\r\n}\r\nstatic inline int superio_enter(int base)\r\n{\r\nif (!request_muxed_region(base, 2, "sch56xx")) {\r\npr_err("I/O address 0x%04x already in use\n", base);\r\nreturn -EBUSY;\r\n}\r\noutb(SIO_UNLOCK_KEY, base);\r\nreturn 0;\r\n}\r\nstatic inline void superio_select(int base, int ld)\r\n{\r\noutb(SIO_REG_LDSEL, base);\r\noutb(ld, base + 1);\r\n}\r\nstatic inline void superio_exit(int base)\r\n{\r\noutb(SIO_LOCK_KEY, base);\r\nrelease_region(base, 2);\r\n}\r\nstatic int sch56xx_send_cmd(u16 addr, u8 cmd, u16 reg, u8 v)\r\n{\r\nu8 val;\r\nint i;\r\nconst int max_busy_polls = 64;\r\nconst int max_lazy_polls = 32;\r\nval = inb(addr + 1);\r\noutb(val, addr + 1);\r\noutb(0x00, addr + 2);\r\noutb(0x80, addr + 3);\r\noutb(cmd, addr + 4);\r\noutb(0x01, addr + 5);\r\noutb(0x04, addr + 2);\r\nif (cmd == SCH56XX_CMD_WRITE)\r\noutb(v, addr + 4);\r\noutb(reg & 0xff, addr + 6);\r\noutb(reg >> 8, addr + 7);\r\noutb(0x01, addr);\r\nfor (i = 0; i < max_busy_polls + max_lazy_polls; i++) {\r\nif (i >= max_busy_polls)\r\nmsleep(1);\r\nval = inb(addr + 8);\r\nif (val)\r\noutb(val, addr + 8);\r\nif (val & 0x01)\r\nbreak;\r\n}\r\nif (i == max_busy_polls + max_lazy_polls) {\r\npr_err("Max retries exceeded reading virtual "\r\n"register 0x%04hx (%d)\n", reg, 1);\r\nreturn -EIO;\r\n}\r\nfor (i = 0; i < max_busy_polls; i++) {\r\nval = inb(addr + 1);\r\nif (val == 0x01)\r\nbreak;\r\nif (i == 0)\r\npr_warn("EC reports: 0x%02x reading virtual register "\r\n"0x%04hx\n", (unsigned int)val, reg);\r\n}\r\nif (i == max_busy_polls) {\r\npr_err("Max retries exceeded reading virtual "\r\n"register 0x%04hx (%d)\n", reg, 2);\r\nreturn -EIO;\r\n}\r\nif (cmd == SCH56XX_CMD_READ)\r\nreturn inb(addr + 4);\r\nreturn 0;\r\n}\r\nint sch56xx_read_virtual_reg(u16 addr, u16 reg)\r\n{\r\nreturn sch56xx_send_cmd(addr, SCH56XX_CMD_READ, reg, 0);\r\n}\r\nint sch56xx_write_virtual_reg(u16 addr, u16 reg, u8 val)\r\n{\r\nreturn sch56xx_send_cmd(addr, SCH56XX_CMD_WRITE, reg, val);\r\n}\r\nint sch56xx_read_virtual_reg16(u16 addr, u16 reg)\r\n{\r\nint lsb, msb;\r\nlsb = sch56xx_read_virtual_reg(addr, reg);\r\nif (lsb < 0)\r\nreturn lsb;\r\nmsb = sch56xx_read_virtual_reg(addr, reg + 1);\r\nif (msb < 0)\r\nreturn msb;\r\nreturn lsb | (msb << 8);\r\n}\r\nint sch56xx_read_virtual_reg12(u16 addr, u16 msb_reg, u16 lsn_reg,\r\nint high_nibble)\r\n{\r\nint msb, lsn;\r\nmsb = sch56xx_read_virtual_reg(addr, msb_reg);\r\nif (msb < 0)\r\nreturn msb;\r\nlsn = sch56xx_read_virtual_reg(addr, lsn_reg);\r\nif (lsn < 0)\r\nreturn lsn;\r\nif (high_nibble)\r\nreturn (msb << 4) | (lsn >> 4);\r\nelse\r\nreturn (msb << 4) | (lsn & 0x0f);\r\n}\r\nstatic int __init sch56xx_find(int sioaddr, unsigned short *address,\r\nconst char **name)\r\n{\r\nu8 devid;\r\nint err;\r\nerr = superio_enter(sioaddr);\r\nif (err)\r\nreturn err;\r\ndevid = superio_inb(sioaddr, SIO_REG_DEVID);\r\nswitch (devid) {\r\ncase SIO_SCH5627_ID:\r\n*name = "sch5627";\r\nbreak;\r\ncase SIO_SCH5636_ID:\r\n*name = "sch5636";\r\nbreak;\r\ndefault:\r\npr_debug("Unsupported device id: 0x%02x\n",\r\n(unsigned int)devid);\r\nerr = -ENODEV;\r\ngoto exit;\r\n}\r\nsuperio_select(sioaddr, SIO_SCH56XX_LD_EM);\r\nif (!(superio_inb(sioaddr, SIO_REG_ENABLE) & 0x01)) {\r\npr_warn("Device not activated\n");\r\nerr = -ENODEV;\r\ngoto exit;\r\n}\r\n*address = superio_inb(sioaddr, SIO_REG_ADDR) |\r\nsuperio_inb(sioaddr, SIO_REG_ADDR + 1) << 8;\r\nif (*address == 0) {\r\npr_warn("Base address not set\n");\r\nerr = -ENODEV;\r\ngoto exit;\r\n}\r\nexit:\r\nsuperio_exit(sioaddr);\r\nreturn err;\r\n}\r\nstatic int __init sch56xx_device_add(unsigned short address, const char *name)\r\n{\r\nstruct resource res = {\r\n.start = address,\r\n.end = address + REGION_LENGTH - 1,\r\n.flags = IORESOURCE_IO,\r\n};\r\nint err;\r\nsch56xx_pdev = platform_device_alloc(name, address);\r\nif (!sch56xx_pdev)\r\nreturn -ENOMEM;\r\nres.name = sch56xx_pdev->name;\r\nerr = acpi_check_resource_conflict(&res);\r\nif (err)\r\ngoto exit_device_put;\r\nerr = platform_device_add_resources(sch56xx_pdev, &res, 1);\r\nif (err) {\r\npr_err("Device resource addition failed\n");\r\ngoto exit_device_put;\r\n}\r\nerr = platform_device_add(sch56xx_pdev);\r\nif (err) {\r\npr_err("Device addition failed\n");\r\ngoto exit_device_put;\r\n}\r\nreturn 0;\r\nexit_device_put:\r\nplatform_device_put(sch56xx_pdev);\r\nreturn err;\r\n}\r\nstatic int __init sch56xx_init(void)\r\n{\r\nint err;\r\nunsigned short address;\r\nconst char *name;\r\nerr = sch56xx_find(0x4e, &address, &name);\r\nif (err)\r\nerr = sch56xx_find(0x2e, &address, &name);\r\nif (err)\r\nreturn err;\r\nreturn sch56xx_device_add(address, name);\r\n}\r\nstatic void __exit sch56xx_exit(void)\r\n{\r\nplatform_device_unregister(sch56xx_pdev);\r\n}

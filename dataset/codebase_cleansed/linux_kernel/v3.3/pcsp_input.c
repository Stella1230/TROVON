static void pcspkr_do_sound(unsigned int count)\r\n{\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&i8253_lock, flags);\r\nif (count) {\r\noutb_p(0xB6, 0x43);\r\noutb_p(count & 0xff, 0x42);\r\noutb((count >> 8) & 0xff, 0x42);\r\noutb_p(inb_p(0x61) | 3, 0x61);\r\n} else {\r\noutb(inb_p(0x61) & 0xFC, 0x61);\r\n}\r\nraw_spin_unlock_irqrestore(&i8253_lock, flags);\r\n}\r\nvoid pcspkr_stop_sound(void)\r\n{\r\npcspkr_do_sound(0);\r\n}\r\nstatic int pcspkr_input_event(struct input_dev *dev, unsigned int type,\r\nunsigned int code, int value)\r\n{\r\nunsigned int count = 0;\r\nif (atomic_read(&pcsp_chip.timer_active) || !pcsp_chip.pcspkr)\r\nreturn 0;\r\nswitch (type) {\r\ncase EV_SND:\r\nswitch (code) {\r\ncase SND_BELL:\r\nif (value)\r\nvalue = 1000;\r\ncase SND_TONE:\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nif (value > 20 && value < 32767)\r\ncount = PIT_TICK_RATE / value;\r\npcspkr_do_sound(count);\r\nreturn 0;\r\n}\r\nint __devinit pcspkr_input_init(struct input_dev **rdev, struct device *dev)\r\n{\r\nint err;\r\nstruct input_dev *input_dev = input_allocate_device();\r\nif (!input_dev)\r\nreturn -ENOMEM;\r\ninput_dev->name = "PC Speaker";\r\ninput_dev->phys = "isa0061/input0";\r\ninput_dev->id.bustype = BUS_ISA;\r\ninput_dev->id.vendor = 0x001f;\r\ninput_dev->id.product = 0x0001;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = dev;\r\ninput_dev->evbit[0] = BIT(EV_SND);\r\ninput_dev->sndbit[0] = BIT(SND_BELL) | BIT(SND_TONE);\r\ninput_dev->event = pcspkr_input_event;\r\nerr = input_register_device(input_dev);\r\nif (err) {\r\ninput_free_device(input_dev);\r\nreturn err;\r\n}\r\n*rdev = input_dev;\r\nreturn 0;\r\n}\r\nint pcspkr_input_remove(struct input_dev *dev)\r\n{\r\npcspkr_stop_sound();\r\ninput_unregister_device(dev);\r\nreturn 0;\r\n}

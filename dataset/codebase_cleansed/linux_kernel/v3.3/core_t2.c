static int\r\nmk_conf_addr(struct pci_bus *pbus, unsigned int device_fn, int where,\r\nunsigned long *pci_addr, unsigned char *type1)\r\n{\r\nunsigned long addr;\r\nu8 bus = pbus->number;\r\nDBG(("mk_conf_addr(bus=%d, dfn=0x%x, where=0x%x,"\r\n" addr=0x%lx, type1=0x%x)\n",\r\nbus, device_fn, where, pci_addr, type1));\r\nif (bus == 0) {\r\nint device = device_fn >> 3;\r\nif (device > 8) {\r\nDBG(("mk_conf_addr: device (%d)>20, returning -1\n",\r\ndevice));\r\nreturn -1;\r\n}\r\n*type1 = 0;\r\naddr = (0x0800L << device) | ((device_fn & 7) << 8) | (where);\r\n} else {\r\n*type1 = 1;\r\naddr = (bus << 16) | (device_fn << 8) | (where);\r\n}\r\n*pci_addr = addr;\r\nDBG(("mk_conf_addr: returning pci_addr 0x%lx\n", addr));\r\nreturn 0;\r\n}\r\nstatic unsigned int\r\nconf_read(unsigned long addr, unsigned char type1)\r\n{\r\nunsigned int value, cpu, taken;\r\nunsigned long t2_cfg = 0;\r\ncpu = smp_processor_id();\r\nDBG(("conf_read(addr=0x%lx, type1=%d)\n", addr, type1));\r\nif (type1) {\r\nt2_cfg = *(vulp)T2_HAE_3 & ~0xc0000000UL;\r\n*(vulp)T2_HAE_3 = 0x40000000UL | t2_cfg;\r\nmb();\r\n}\r\nmb();\r\ndraina();\r\nmcheck_expected(cpu) = 1;\r\nmcheck_taken(cpu) = 0;\r\nt2_mcheck_any_expected |= (1 << cpu);\r\nmb();\r\nvalue = *(vuip)addr;\r\nmb();\r\nmb();\r\nudelay(100);\r\nif ((taken = mcheck_taken(cpu))) {\r\nmcheck_taken(cpu) = 0;\r\nt2_mcheck_last_taken |= (1 << cpu);\r\nvalue = 0xffffffffU;\r\nmb();\r\n}\r\nmcheck_expected(cpu) = 0;\r\nt2_mcheck_any_expected = 0;\r\nmb();\r\nif (type1) {\r\n*(vulp)T2_HAE_3 = t2_cfg;\r\nmb();\r\n}\r\nreturn value;\r\n}\r\nstatic void\r\nconf_write(unsigned long addr, unsigned int value, unsigned char type1)\r\n{\r\nunsigned int cpu, taken;\r\nunsigned long t2_cfg = 0;\r\ncpu = smp_processor_id();\r\nif (type1) {\r\nt2_cfg = *(vulp)T2_HAE_3 & ~0xc0000000UL;\r\n*(vulp)T2_HAE_3 = t2_cfg | 0x40000000UL;\r\nmb();\r\n}\r\nmb();\r\ndraina();\r\nmcheck_expected(cpu) = 1;\r\nmcheck_taken(cpu) = 0;\r\nt2_mcheck_any_expected |= (1 << cpu);\r\nmb();\r\n*(vuip)addr = value;\r\nmb();\r\nmb();\r\nudelay(100);\r\nif ((taken = mcheck_taken(cpu))) {\r\nmcheck_taken(cpu) = 0;\r\nt2_mcheck_last_taken |= (1 << cpu);\r\nmb();\r\n}\r\nmcheck_expected(cpu) = 0;\r\nt2_mcheck_any_expected = 0;\r\nmb();\r\nif (type1) {\r\n*(vulp)T2_HAE_3 = t2_cfg;\r\nmb();\r\n}\r\n}\r\nstatic int\r\nt2_read_config(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, u32 *value)\r\n{\r\nunsigned long addr, pci_addr;\r\nunsigned char type1;\r\nint shift;\r\nlong mask;\r\nif (mk_conf_addr(bus, devfn, where, &pci_addr, &type1))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nmask = (size - 1) * 8;\r\nshift = (where & 3) * 8;\r\naddr = (pci_addr << 5) + mask + T2_CONF;\r\n*value = conf_read(addr, type1) >> (shift);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int\r\nt2_write_config(struct pci_bus *bus, unsigned int devfn, int where, int size,\r\nu32 value)\r\n{\r\nunsigned long addr, pci_addr;\r\nunsigned char type1;\r\nlong mask;\r\nif (mk_conf_addr(bus, devfn, where, &pci_addr, &type1))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nmask = (size - 1) * 8;\r\naddr = (pci_addr << 5) + mask + T2_CONF;\r\nconf_write(addr, value << ((where & 3) * 8), type1);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic void __init\r\nt2_direct_map_window1(unsigned long base, unsigned long length)\r\n{\r\nunsigned long temp;\r\n__direct_map_base = base;\r\n__direct_map_size = length;\r\ntemp = (base & 0xfff00000UL) | ((base + length - 1) >> 20);\r\n*(vulp)T2_WBASE1 = temp | 0x80000UL;\r\ntemp = (length - 1) & 0xfff00000UL;\r\n*(vulp)T2_WMASK1 = temp;\r\n*(vulp)T2_TBASE1 = 0;\r\n#if DEBUG_PRINT_FINAL_SETTINGS\r\nprintk("%s: setting WBASE1=0x%lx WMASK1=0x%lx TBASE1=0x%lx\n",\r\n__func__, *(vulp)T2_WBASE1, *(vulp)T2_WMASK1, *(vulp)T2_TBASE1);\r\n#endif\r\n}\r\nstatic void __init\r\nt2_sg_map_window2(struct pci_controller *hose,\r\nunsigned long base,\r\nunsigned long length)\r\n{\r\nunsigned long temp;\r\nhose->sg_isa = iommu_arena_new(hose, base, length, 0);\r\nhose->sg_pci = NULL;\r\ntemp = (base & 0xfff00000UL) | ((base + length - 1) >> 20);\r\n*(vulp)T2_WBASE2 = temp | 0xc0000UL;\r\ntemp = (length - 1) & 0xfff00000UL;\r\n*(vulp)T2_WMASK2 = temp;\r\n*(vulp)T2_TBASE2 = virt_to_phys(hose->sg_isa->ptes) >> 1;\r\nmb();\r\nt2_pci_tbi(hose, 0, -1);\r\n#if DEBUG_PRINT_FINAL_SETTINGS\r\nprintk("%s: setting WBASE2=0x%lx WMASK2=0x%lx TBASE2=0x%lx\n",\r\n__func__, *(vulp)T2_WBASE2, *(vulp)T2_WMASK2, *(vulp)T2_TBASE2);\r\n#endif\r\n}\r\nstatic void __init\r\nt2_save_configuration(void)\r\n{\r\n#if DEBUG_PRINT_INITIAL_SETTINGS\r\nprintk("%s: HAE_1 was 0x%lx\n", __func__, srm_hae);\r\nprintk("%s: HAE_2 was 0x%lx\n", __func__, *(vulp)T2_HAE_2);\r\nprintk("%s: HAE_3 was 0x%lx\n", __func__, *(vulp)T2_HAE_3);\r\nprintk("%s: HAE_4 was 0x%lx\n", __func__, *(vulp)T2_HAE_4);\r\nprintk("%s: HBASE was 0x%lx\n", __func__, *(vulp)T2_HBASE);\r\nprintk("%s: WBASE1=0x%lx WMASK1=0x%lx TBASE1=0x%lx\n", __func__,\r\n*(vulp)T2_WBASE1, *(vulp)T2_WMASK1, *(vulp)T2_TBASE1);\r\nprintk("%s: WBASE2=0x%lx WMASK2=0x%lx TBASE2=0x%lx\n", __func__,\r\n*(vulp)T2_WBASE2, *(vulp)T2_WMASK2, *(vulp)T2_TBASE2);\r\n#endif\r\nt2_saved_config.window[0].wbase = *(vulp)T2_WBASE1;\r\nt2_saved_config.window[0].wmask = *(vulp)T2_WMASK1;\r\nt2_saved_config.window[0].tbase = *(vulp)T2_TBASE1;\r\nt2_saved_config.window[1].wbase = *(vulp)T2_WBASE2;\r\nt2_saved_config.window[1].wmask = *(vulp)T2_WMASK2;\r\nt2_saved_config.window[1].tbase = *(vulp)T2_TBASE2;\r\nt2_saved_config.hae_1 = srm_hae;\r\nt2_saved_config.hae_2 = *(vulp)T2_HAE_2;\r\nt2_saved_config.hae_3 = *(vulp)T2_HAE_3;\r\nt2_saved_config.hae_4 = *(vulp)T2_HAE_4;\r\nt2_saved_config.hbase = *(vulp)T2_HBASE;\r\n}\r\nvoid __init\r\nt2_init_arch(void)\r\n{\r\nstruct pci_controller *hose;\r\nstruct resource *hae_mem;\r\nunsigned long temp;\r\nunsigned int i;\r\nfor (i = 0; i < NR_CPUS; i++) {\r\nmcheck_expected(i) = 0;\r\nmcheck_taken(i) = 0;\r\n}\r\nt2_mcheck_any_expected = 0;\r\nt2_mcheck_last_taken = 0;\r\ntemp = *(vulp)T2_IOCSR;\r\nif (!(temp & (0x1UL << 26))) {\r\nprintk("t2_init_arch: enabling SG TLB, IOCSR was 0x%lx\n",\r\ntemp);\r\n*(vulp)T2_IOCSR = temp | (0x1UL << 26);\r\nmb();\r\n*(vulp)T2_IOCSR;\r\n}\r\nt2_save_configuration();\r\npci_isa_hose = hose = alloc_pci_controller();\r\nhose->io_space = &ioport_resource;\r\nhae_mem = alloc_resource();\r\nhae_mem->start = 0;\r\nhae_mem->end = T2_MEM_R1_MASK;\r\nhae_mem->name = pci_hae0_name;\r\nif (request_resource(&iomem_resource, hae_mem) < 0)\r\nprintk(KERN_ERR "Failed to request HAE_MEM\n");\r\nhose->mem_space = hae_mem;\r\nhose->index = 0;\r\nhose->sparse_mem_base = T2_SPARSE_MEM - IDENT_ADDR;\r\nhose->dense_mem_base = T2_DENSE_MEM - IDENT_ADDR;\r\nhose->sparse_io_base = T2_IO - IDENT_ADDR;\r\nhose->dense_io_base = 0;\r\nt2_direct_map_window1(T2_DIRECTMAP_START, T2_DIRECTMAP_LENGTH);\r\nt2_sg_map_window2(hose, T2_ISA_SG_START, T2_ISA_SG_LENGTH);\r\n*(vulp)T2_HBASE = 0x0;\r\n*(vulp)T2_HAE_1 = 0; mb();\r\n*(vulp)T2_HAE_2 = 0; mb();\r\n*(vulp)T2_HAE_3 = 0; mb();\r\n*(vulp)T2_HAE_4 = 0; mb();\r\n}\r\nvoid\r\nt2_kill_arch(int mode)\r\n{\r\n*(vulp)T2_WBASE1 = t2_saved_config.window[0].wbase;\r\n*(vulp)T2_WMASK1 = t2_saved_config.window[0].wmask;\r\n*(vulp)T2_TBASE1 = t2_saved_config.window[0].tbase;\r\n*(vulp)T2_WBASE2 = t2_saved_config.window[1].wbase;\r\n*(vulp)T2_WMASK2 = t2_saved_config.window[1].wmask;\r\n*(vulp)T2_TBASE2 = t2_saved_config.window[1].tbase;\r\nmb();\r\n*(vulp)T2_HAE_1 = srm_hae;\r\n*(vulp)T2_HAE_2 = t2_saved_config.hae_2;\r\n*(vulp)T2_HAE_3 = t2_saved_config.hae_3;\r\n*(vulp)T2_HAE_4 = t2_saved_config.hae_4;\r\n*(vulp)T2_HBASE = t2_saved_config.hbase;\r\nmb();\r\n*(vulp)T2_HBASE;\r\n}\r\nvoid\r\nt2_pci_tbi(struct pci_controller *hose, dma_addr_t start, dma_addr_t end)\r\n{\r\nunsigned long t2_iocsr;\r\nt2_iocsr = *(vulp)T2_IOCSR;\r\n*(vulp)T2_IOCSR = t2_iocsr | (0x1UL << 28);\r\nmb();\r\n*(vulp)T2_IOCSR;\r\n*(vulp)T2_IOCSR = t2_iocsr & ~(0x1UL << 28);\r\nmb();\r\n*(vulp)T2_IOCSR;\r\n}\r\nstatic void\r\nt2_clear_errors(int cpu)\r\n{\r\nstruct sable_cpu_csr *cpu_regs;\r\ncpu_regs = (struct sable_cpu_csr *)T2_CPUn_BASE(cpu);\r\ncpu_regs->sic &= ~SIC_SEIC;\r\ncpu_regs->bcce |= cpu_regs->bcce;\r\ncpu_regs->cbe |= cpu_regs->cbe;\r\ncpu_regs->bcue |= cpu_regs->bcue;\r\ncpu_regs->dter |= cpu_regs->dter;\r\n*(vulp)T2_CERR1 |= *(vulp)T2_CERR1;\r\n*(vulp)T2_PERR1 |= *(vulp)T2_PERR1;\r\nmb();\r\nmb();\r\n}\r\nvoid\r\nt2_machine_check(unsigned long vector, unsigned long la_ptr)\r\n{\r\nint cpu = smp_processor_id();\r\n#ifdef CONFIG_VERBOSE_MCHECK\r\nstruct el_common *mchk_header = (struct el_common *)la_ptr;\r\n#endif\r\nmb();\r\nmb();\r\ndraina();\r\nt2_clear_errors(cpu);\r\nwrmces(0x7);\r\nmb();\r\nif (!mcheck_expected(cpu) && t2_mcheck_any_expected) {\r\n#ifdef CONFIG_VERBOSE_MCHECK\r\nif (alpha_verbose_mcheck > 1) {\r\nprintk("t2_machine_check(cpu%d): any_expected 0x%x -"\r\n" (assumed) spurious -"\r\n" code 0x%x\n", cpu, t2_mcheck_any_expected,\r\n(unsigned int)mchk_header->code);\r\n}\r\n#endif\r\nreturn;\r\n}\r\nif (!mcheck_expected(cpu) && !t2_mcheck_any_expected) {\r\nif (t2_mcheck_last_taken & (1 << cpu)) {\r\n#ifdef CONFIG_VERBOSE_MCHECK\r\nif (alpha_verbose_mcheck > 1) {\r\nprintk("t2_machine_check(cpu%d): last_taken 0x%x - "\r\n"unexpected mcheck - code 0x%x\n",\r\ncpu, t2_mcheck_last_taken,\r\n(unsigned int)mchk_header->code);\r\n}\r\n#endif\r\nt2_mcheck_last_taken = 0;\r\nmb();\r\nreturn;\r\n} else {\r\nt2_mcheck_last_taken = 0;\r\nmb();\r\n}\r\n}\r\n#ifdef CONFIG_VERBOSE_MCHECK\r\nif (alpha_verbose_mcheck > 1) {\r\nprintk("%s t2_mcheck(cpu%d): last_taken 0x%x - "\r\n"any_expected 0x%x - code 0x%x\n",\r\n(mcheck_expected(cpu) ? "EX" : "UN"), cpu,\r\nt2_mcheck_last_taken, t2_mcheck_any_expected,\r\n(unsigned int)mchk_header->code);\r\n}\r\n#endif\r\nprocess_mcheck_info(vector, la_ptr, "T2", mcheck_expected(cpu));\r\n}

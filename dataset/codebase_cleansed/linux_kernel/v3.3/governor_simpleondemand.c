static int devfreq_simple_ondemand_func(struct devfreq *df,\r\nunsigned long *freq)\r\n{\r\nstruct devfreq_dev_status stat;\r\nint err = df->profile->get_dev_status(df->dev.parent, &stat);\r\nunsigned long long a, b;\r\nunsigned int dfso_upthreshold = DFSO_UPTHRESHOLD;\r\nunsigned int dfso_downdifferential = DFSO_DOWNDIFFERENCTIAL;\r\nstruct devfreq_simple_ondemand_data *data = df->data;\r\nif (err)\r\nreturn err;\r\nif (data) {\r\nif (data->upthreshold)\r\ndfso_upthreshold = data->upthreshold;\r\nif (data->downdifferential)\r\ndfso_downdifferential = data->downdifferential;\r\n}\r\nif (dfso_upthreshold > 100 ||\r\ndfso_upthreshold < dfso_downdifferential)\r\nreturn -EINVAL;\r\nif (stat.total_time == 0) {\r\n*freq = UINT_MAX;\r\nreturn 0;\r\n}\r\nif (stat.busy_time >= (1 << 24) || stat.total_time >= (1 << 24)) {\r\nstat.busy_time >>= 7;\r\nstat.total_time >>= 7;\r\n}\r\nif (stat.busy_time * 100 >\r\nstat.total_time * dfso_upthreshold) {\r\n*freq = UINT_MAX;\r\nreturn 0;\r\n}\r\nif (stat.current_frequency == 0) {\r\n*freq = UINT_MAX;\r\nreturn 0;\r\n}\r\nif (stat.busy_time * 100 >\r\nstat.total_time * (dfso_upthreshold - dfso_downdifferential)) {\r\n*freq = stat.current_frequency;\r\nreturn 0;\r\n}\r\na = stat.busy_time;\r\na *= stat.current_frequency;\r\nb = div_u64(a, stat.total_time);\r\nb *= 100;\r\nb = div_u64(b, (dfso_upthreshold - dfso_downdifferential / 2));\r\n*freq = (unsigned long) b;\r\nreturn 0;\r\n}

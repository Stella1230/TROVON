static int patch_build_controls(struct snd_ac97 * ac97, const struct snd_kcontrol_new *controls, int count)\r\n{\r\nint idx, err;\r\nfor (idx = 0; idx < count; idx++)\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ac97_cnew(&controls[idx], ac97))) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic void reset_tlv(struct snd_ac97 *ac97, const char *name,\r\nconst unsigned int *tlv)\r\n{\r\nstruct snd_ctl_elem_id sid;\r\nstruct snd_kcontrol *kctl;\r\nmemset(&sid, 0, sizeof(sid));\r\nstrcpy(sid.name, name);\r\nsid.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nkctl = snd_ctl_find_id(ac97->bus->card, &sid);\r\nif (kctl && kctl->tlv.p)\r\nkctl->tlv.p = tlv;\r\n}\r\nstatic int ac97_update_bits_page(struct snd_ac97 *ac97, unsigned short reg, unsigned short mask, unsigned short value, unsigned short page)\r\n{\r\nunsigned short page_save;\r\nint ret;\r\nmutex_lock(&ac97->page_mutex);\r\npage_save = snd_ac97_read(ac97, AC97_INT_PAGING) & AC97_PAGE_MASK;\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING, AC97_PAGE_MASK, page);\r\nret = snd_ac97_update_bits(ac97, reg, mask, value);\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING, AC97_PAGE_MASK, page_save);\r\nmutex_unlock(&ac97->page_mutex);\r\nreturn ret;\r\n}\r\nstatic int ac97_enum_text_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo,\r\nconst char **texts, unsigned int nums)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = nums;\r\nif (uinfo->value.enumerated.item > nums - 1)\r\nuinfo->value.enumerated.item = nums - 1;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int ac97_surround_jack_mode_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char *texts[] = { "Shared", "Independent" };\r\nreturn ac97_enum_text_info(kcontrol, uinfo, texts, 2);\r\n}\r\nstatic int ac97_surround_jack_mode_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.enumerated.item[0] = ac97->indep_surround;\r\nreturn 0;\r\n}\r\nstatic int ac97_surround_jack_mode_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned char indep = !!ucontrol->value.enumerated.item[0];\r\nif (indep != ac97->indep_surround) {\r\nac97->indep_surround = indep;\r\nif (ac97->build_ops->update_jacks)\r\nac97->build_ops->update_jacks(ac97);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ac97_channel_mode_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char *texts[] = { "2ch", "4ch", "6ch", "8ch" };\r\nreturn ac97_enum_text_info(kcontrol, uinfo, texts,\r\nkcontrol->private_value);\r\n}\r\nstatic int ac97_channel_mode_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.enumerated.item[0] = ac97->channel_mode;\r\nreturn 0;\r\n}\r\nstatic int ac97_channel_mode_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned char mode = ucontrol->value.enumerated.item[0];\r\nif (mode >= kcontrol->private_value)\r\nreturn -EINVAL;\r\nif (mode != ac97->channel_mode) {\r\nac97->channel_mode = mode;\r\nif (ac97->build_ops->update_jacks)\r\nac97->build_ops->update_jacks(ac97);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int is_surround_on(struct snd_ac97 *ac97)\r\n{\r\nreturn ac97->channel_mode >= 1;\r\n}\r\nstatic inline int is_clfe_on(struct snd_ac97 *ac97)\r\n{\r\nreturn ac97->channel_mode >= 2;\r\n}\r\nstatic inline int is_shared_surrout(struct snd_ac97 *ac97)\r\n{\r\nreturn !ac97->indep_surround && is_surround_on(ac97);\r\n}\r\nstatic inline int is_shared_clfeout(struct snd_ac97 *ac97)\r\n{\r\nreturn !ac97->indep_surround && is_clfe_on(ac97);\r\n}\r\nstatic inline int is_shared_linein(struct snd_ac97 *ac97)\r\n{\r\nreturn !ac97->indep_surround && !is_surround_on(ac97);\r\n}\r\nstatic inline int is_shared_micin(struct snd_ac97 *ac97)\r\n{\r\nreturn !ac97->indep_surround && !is_clfe_on(ac97);\r\n}\r\nstatic inline int alc850_is_aux_back_surround(struct snd_ac97 *ac97)\r\n{\r\nreturn is_surround_on(ac97);\r\n}\r\nstatic int snd_ac97_ymf7x3_info_speaker(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[3] = {\r\n"Standard", "Small", "Smaller"\r\n};\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 3;\r\nif (uinfo->value.enumerated.item > 2)\r\nuinfo->value.enumerated.item = 2;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ymf7x3_get_speaker(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_YMF7X3_3D_MODE_SEL];\r\nval = (val >> 10) & 3;\r\nif (val > 0)\r\nval--;\r\nucontrol->value.enumerated.item[0] = val;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ymf7x3_put_speaker(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nif (ucontrol->value.enumerated.item[0] > 2)\r\nreturn -EINVAL;\r\nval = (ucontrol->value.enumerated.item[0] + 1) << 10;\r\nreturn snd_ac97_update(ac97, AC97_YMF7X3_3D_MODE_SEL, val);\r\n}\r\nstatic int snd_ac97_ymf7x3_spdif_source_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[2] = { "AC-Link", "A/D Converter" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 2;\r\nif (uinfo->value.enumerated.item > 1)\r\nuinfo->value.enumerated.item = 1;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ymf7x3_spdif_source_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_YMF7X3_DIT_CTRL];\r\nucontrol->value.enumerated.item[0] = (val >> 1) & 1;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ymf7x3_spdif_source_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nif (ucontrol->value.enumerated.item[0] > 1)\r\nreturn -EINVAL;\r\nval = ucontrol->value.enumerated.item[0] << 1;\r\nreturn snd_ac97_update_bits(ac97, AC97_YMF7X3_DIT_CTRL, 0x0002, val);\r\n}\r\nstatic int patch_yamaha_ymf7x3_3d(struct snd_ac97 *ac97)\r\n{\r\nstruct snd_kcontrol *kctl;\r\nint err;\r\nkctl = snd_ac97_cnew(&snd_ac97_controls_3d[0], ac97);\r\nerr = snd_ctl_add(ac97->bus->card, kctl);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(kctl->id.name, "3D Control - Wide");\r\nkctl->private_value = AC97_SINGLE_VALUE(AC97_3D_CONTROL, 9, 7, 0);\r\nsnd_ac97_write_cache(ac97, AC97_3D_CONTROL, 0x0000);\r\nerr = snd_ctl_add(ac97->bus->card,\r\nsnd_ac97_cnew(&snd_ac97_ymf7x3_controls_speaker,\r\nac97));\r\nif (err < 0)\r\nreturn err;\r\nsnd_ac97_write_cache(ac97, AC97_YMF7X3_3D_MODE_SEL, 0x0c00);\r\nreturn 0;\r\n}\r\nstatic int patch_yamaha_ymf743_build_spdif(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nerr = patch_build_controls(ac97, &snd_ac97_controls_spdif[0], 3);\r\nif (err < 0)\r\nreturn err;\r\nerr = patch_build_controls(ac97,\r\nsnd_ac97_yamaha_ymf743_controls_spdif, 3);\r\nif (err < 0)\r\nreturn err;\r\nsnd_ac97_write_cache(ac97, AC97_YMF7X3_DIT_CTRL, 0xa201);\r\nreturn 0;\r\n}\r\nstatic int patch_yamaha_ymf743(struct snd_ac97 *ac97)\r\n{\r\nac97->build_ops = &patch_yamaha_ymf743_ops;\r\nac97->caps |= AC97_BC_BASS_TREBLE;\r\nac97->caps |= 0x04 << 10;\r\nac97->rates[AC97_RATES_SPDIF] = SNDRV_PCM_RATE_48000;\r\nac97->ext_id |= AC97_EI_SPDIF;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ymf753_spdif_output_pin_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[3] = { "Disabled", "Pin 43", "Pin 48" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 3;\r\nif (uinfo->value.enumerated.item > 2)\r\nuinfo->value.enumerated.item = 2;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ymf753_spdif_output_pin_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_YMF7X3_DIT_CTRL];\r\nucontrol->value.enumerated.item[0] = (val & 0x0008) ? 2 : (val & 0x0020) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ymf753_spdif_output_pin_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nif (ucontrol->value.enumerated.item[0] > 2)\r\nreturn -EINVAL;\r\nval = (ucontrol->value.enumerated.item[0] == 2) ? 0x0008 :\r\n(ucontrol->value.enumerated.item[0] == 1) ? 0x0020 : 0;\r\nreturn snd_ac97_update_bits(ac97, AC97_YMF7X3_DIT_CTRL, 0x0028, val);\r\n}\r\nstatic int patch_yamaha_ymf753_post_spdif(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, snd_ac97_ymf753_controls_spdif, ARRAY_SIZE(snd_ac97_ymf753_controls_spdif))) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int patch_yamaha_ymf753(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_yamaha_ymf753_ops;\r\nac97->caps |= AC97_BC_BASS_TREBLE;\r\nac97->caps |= 0x04 << 10;\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson_wm9703_specific(struct snd_ac97 * ac97)\r\n{\r\nint err, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm97xx_snd_ac97_controls); i++) {\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ac97_cnew(&wm97xx_snd_ac97_controls[i], ac97))) < 0)\r\nreturn err;\r\n}\r\nsnd_ac97_write_cache(ac97, AC97_WM97XX_FMIXER_VOL, 0x0808);\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson03(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_wolfson_wm9703_ops;\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson_wm9704_specific(struct snd_ac97 * ac97)\r\n{\r\nint err, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm9704_snd_ac97_controls); i++) {\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ac97_cnew(&wm9704_snd_ac97_controls[i], ac97))) < 0)\r\nreturn err;\r\n}\r\nsnd_ac97_write_cache(ac97, AC97_WM9704_TEST, 0x0200);\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson04(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_wolfson_wm9704_ops;\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson05(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_wolfson_wm9703_ops;\r\n#ifdef CONFIG_TOUCHSCREEN_WM9705\r\nac97->flags |= AC97_HAS_NO_VIDEO | AC97_HAS_NO_AUX;\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson_wm9711_specific(struct snd_ac97 * ac97)\r\n{\r\nint err, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm9711_snd_ac97_controls); i++) {\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ac97_cnew(&wm9711_snd_ac97_controls[i], ac97))) < 0)\r\nreturn err;\r\n}\r\nsnd_ac97_write_cache(ac97, AC97_CODEC_CLASS_REV, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_PCI_SVID, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_VIDEO, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_AUX, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_PC_BEEP, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_CD, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson11(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_wolfson_wm9711_ops;\r\nac97->flags |= AC97_HAS_NO_REC_GAIN | AC97_STEREO_MUTES | AC97_HAS_NO_MIC |\r\nAC97_HAS_NO_PC_BEEP | AC97_HAS_NO_VIDEO | AC97_HAS_NO_CD;\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson_wm9713_3d (struct snd_ac97 * ac97)\r\n{\r\nint err, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm13_snd_ac97_controls_3d); i++) {\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ac97_cnew(&wm13_snd_ac97_controls_3d[i], ac97))) < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int patch_wolfson_wm9713_specific(struct snd_ac97 * ac97)\r\n{\r\nint err, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm13_snd_ac97_controls); i++) {\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ac97_cnew(&wm13_snd_ac97_controls[i], ac97))) < 0)\r\nreturn err;\r\n}\r\nsnd_ac97_write_cache(ac97, AC97_PC_BEEP, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_PHONE, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_MIC, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_LINE, 0x00da);\r\nsnd_ac97_write_cache(ac97, AC97_CD, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_VIDEO, 0xd612);\r\nsnd_ac97_write_cache(ac97, AC97_REC_GAIN, 0x1ba0);\r\nreturn 0;\r\n}\r\nstatic void patch_wolfson_wm9713_suspend (struct snd_ac97 * ac97)\r\n{\r\nsnd_ac97_write_cache(ac97, AC97_EXTENDED_MID, 0xfeff);\r\nsnd_ac97_write_cache(ac97, AC97_EXTENDED_MSTATUS, 0xffff);\r\n}\r\nstatic void patch_wolfson_wm9713_resume (struct snd_ac97 * ac97)\r\n{\r\nsnd_ac97_write_cache(ac97, AC97_EXTENDED_MID, 0xda00);\r\nsnd_ac97_write_cache(ac97, AC97_EXTENDED_MSTATUS, 0x3810);\r\nsnd_ac97_write_cache(ac97, AC97_POWERDOWN, 0x0);\r\n}\r\nstatic int patch_wolfson13(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_wolfson_wm9713_ops;\r\nac97->flags |= AC97_HAS_NO_REC_GAIN | AC97_STEREO_MUTES | AC97_HAS_NO_PHONE |\r\nAC97_HAS_NO_PC_BEEP | AC97_HAS_NO_VIDEO | AC97_HAS_NO_CD | AC97_HAS_NO_TONE |\r\nAC97_HAS_NO_STD_PCM;\r\nac97->scaps &= ~AC97_SCAP_MODEM;\r\nsnd_ac97_write_cache(ac97, AC97_EXTENDED_MID, 0xda00);\r\nsnd_ac97_write_cache(ac97, AC97_EXTENDED_MSTATUS, 0x3810);\r\nsnd_ac97_write_cache(ac97, AC97_POWERDOWN, 0x0);\r\nreturn 0;\r\n}\r\nstatic int patch_tritech_tr28028(struct snd_ac97 * ac97)\r\n{\r\nsnd_ac97_write_cache(ac97, 0x26, 0x0300);\r\nsnd_ac97_write_cache(ac97, 0x26, 0x0000);\r\nsnd_ac97_write_cache(ac97, AC97_SURROUND_MASTER, 0x0000);\r\nsnd_ac97_write_cache(ac97, AC97_SPDIF, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac9700_3d(struct snd_ac97 * ac97)\r\n{\r\nstruct snd_kcontrol *kctl;\r\nint err;\r\nif ((err = snd_ctl_add(ac97->bus->card, kctl = snd_ac97_cnew(&snd_ac97_controls_3d[0], ac97))) < 0)\r\nreturn err;\r\nstrcpy(kctl->id.name, "3D Control Sigmatel - Depth");\r\nkctl->private_value = AC97_SINGLE_VALUE(AC97_3D_CONTROL, 2, 3, 0);\r\nsnd_ac97_write_cache(ac97, AC97_3D_CONTROL, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac9708_3d(struct snd_ac97 * ac97)\r\n{\r\nstruct snd_kcontrol *kctl;\r\nint err;\r\nif ((err = snd_ctl_add(ac97->bus->card, kctl = snd_ac97_cnew(&snd_ac97_controls_3d[0], ac97))) < 0)\r\nreturn err;\r\nstrcpy(kctl->id.name, "3D Control Sigmatel - Depth");\r\nkctl->private_value = AC97_SINGLE_VALUE(AC97_3D_CONTROL, 0, 3, 0);\r\nif ((err = snd_ctl_add(ac97->bus->card, kctl = snd_ac97_cnew(&snd_ac97_controls_3d[0], ac97))) < 0)\r\nreturn err;\r\nstrcpy(kctl->id.name, "3D Control Sigmatel - Rear Depth");\r\nkctl->private_value = AC97_SINGLE_VALUE(AC97_3D_CONTROL, 2, 3, 0);\r\nsnd_ac97_write_cache(ac97, AC97_3D_CONTROL, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac97xx_specific(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_ANALOG, snd_ac97_read(ac97, AC97_SIGMATEL_ANALOG) & ~0x0003);\r\nif (snd_ac97_try_bit(ac97, AC97_SIGMATEL_ANALOG, 1))\r\nif ((err = patch_build_controls(ac97, &snd_ac97_sigmatel_controls[0], 1)) < 0)\r\nreturn err;\r\nif (snd_ac97_try_bit(ac97, AC97_SIGMATEL_ANALOG, 0))\r\nif ((err = patch_build_controls(ac97, &snd_ac97_sigmatel_controls[1], 1)) < 0)\r\nreturn err;\r\nif (snd_ac97_try_bit(ac97, AC97_SIGMATEL_DAC2INVERT, 2))\r\nif ((err = patch_build_controls(ac97, &snd_ac97_sigmatel_4speaker, 1)) < 0)\r\nreturn err;\r\nif (snd_ac97_try_bit(ac97, AC97_SIGMATEL_DAC2INVERT, 3))\r\nif ((err = patch_build_controls(ac97, &snd_ac97_sigmatel_phaseinvert, 1)) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac9700(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_sigmatel_stac9700_ops;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9708_put_bias(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nint err;\r\nmutex_lock(&ac97->page_mutex);\r\nsnd_ac97_write(ac97, AC97_SIGMATEL_BIAS1, 0xabba);\r\nerr = snd_ac97_update_bits(ac97, AC97_SIGMATEL_BIAS2, 0x0010,\r\n(ucontrol->value.integer.value[0] & 1) << 4);\r\nsnd_ac97_write(ac97, AC97_SIGMATEL_BIAS1, 0);\r\nmutex_unlock(&ac97->page_mutex);\r\nreturn err;\r\n}\r\nstatic int patch_sigmatel_stac9708_specific(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nsnd_ac97_remove_ctl(ac97, "PCM Out Path & Mute", NULL);\r\nsnd_ac97_rename_vol_ctl(ac97, "Headphone Playback", "Sigmatel Surround Playback");\r\nif ((err = patch_build_controls(ac97, &snd_ac97_stac9708_bias_control, 1)) < 0)\r\nreturn err;\r\nreturn patch_sigmatel_stac97xx_specific(ac97);\r\n}\r\nstatic int patch_sigmatel_stac9708(struct snd_ac97 * ac97)\r\n{\r\nunsigned int codec72, codec6c;\r\nac97->build_ops = &patch_sigmatel_stac9708_ops;\r\nac97->caps |= 0x10;\r\ncodec72 = snd_ac97_read(ac97, AC97_SIGMATEL_BIAS2) & 0x8000;\r\ncodec6c = snd_ac97_read(ac97, AC97_SIGMATEL_ANALOG);\r\nif ((codec72==0) && (codec6c==0)) {\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC2, 0x1000);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS2, 0x0007);\r\n} else if ((codec72==0x8000) && (codec6c==0)) {\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC2, 0x1001);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_DAC2INVERT, 0x0008);\r\n} else if ((codec72==0x8000) && (codec6c==0x0080)) {\r\n}\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_MULTICHN, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac9721(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_sigmatel_stac9700_ops;\r\nif (snd_ac97_read(ac97, AC97_SIGMATEL_ANALOG) == 0) {\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC2, 0x4000);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS2, 0x0002);\r\n}\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_MULTICHN, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac9744(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_sigmatel_stac9700_ops;\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC2, 0x0000);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS2, 0x0002);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_MULTICHN, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac9756(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_sigmatel_stac9700_ops;\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_CIC2, 0x0000);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS1, 0xabba);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_BIAS2, 0x0002);\r\nsnd_ac97_write_cache(ac97, AC97_SIGMATEL_MULTICHN, 0x0000);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9758_output_jack_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[5] = { "Input/Disabled", "Front Output",\r\n"Rear Output", "Center/LFE Output", "Mixer Output" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 5;\r\nif (uinfo->value.enumerated.item > 4)\r\nuinfo->value.enumerated.item = 4;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9758_output_jack_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nint shift = kcontrol->private_value;\r\nunsigned short val;\r\nval = ac97->regs[AC97_SIGMATEL_OUTSEL] >> shift;\r\nif (!(val & 4))\r\nucontrol->value.enumerated.item[0] = 0;\r\nelse\r\nucontrol->value.enumerated.item[0] = 1 + (val & 3);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9758_output_jack_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nint shift = kcontrol->private_value;\r\nunsigned short val;\r\nif (ucontrol->value.enumerated.item[0] > 4)\r\nreturn -EINVAL;\r\nif (ucontrol->value.enumerated.item[0] == 0)\r\nval = 0;\r\nelse\r\nval = 4 | (ucontrol->value.enumerated.item[0] - 1);\r\nreturn ac97_update_bits_page(ac97, AC97_SIGMATEL_OUTSEL,\r\n7 << shift, val << shift, 0);\r\n}\r\nstatic int snd_ac97_stac9758_input_jack_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[7] = { "Mic2 Jack", "Mic1 Jack", "Line In Jack",\r\n"Front Jack", "Rear Jack", "Center/LFE Jack", "Mute" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 7;\r\nif (uinfo->value.enumerated.item > 6)\r\nuinfo->value.enumerated.item = 6;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9758_input_jack_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nint shift = kcontrol->private_value;\r\nunsigned short val;\r\nval = ac97->regs[AC97_SIGMATEL_INSEL];\r\nucontrol->value.enumerated.item[0] = (val >> shift) & 7;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9758_input_jack_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nint shift = kcontrol->private_value;\r\nreturn ac97_update_bits_page(ac97, AC97_SIGMATEL_INSEL, 7 << shift,\r\nucontrol->value.enumerated.item[0] << shift, 0);\r\n}\r\nstatic int snd_ac97_stac9758_phonesel_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[3] = { "None", "Front Jack", "Rear Jack" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 3;\r\nif (uinfo->value.enumerated.item > 2)\r\nuinfo->value.enumerated.item = 2;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9758_phonesel_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.enumerated.item[0] = ac97->regs[AC97_SIGMATEL_IOMISC] & 3;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_stac9758_phonesel_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nreturn ac97_update_bits_page(ac97, AC97_SIGMATEL_IOMISC, 3,\r\nucontrol->value.enumerated.item[0], 0);\r\n}\r\nstatic int patch_sigmatel_stac9758_specific(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nerr = patch_sigmatel_stac97xx_specific(ac97);\r\nif (err < 0)\r\nreturn err;\r\nerr = patch_build_controls(ac97, snd_ac97_sigmatel_stac9758_controls,\r\nARRAY_SIZE(snd_ac97_sigmatel_stac9758_controls));\r\nif (err < 0)\r\nreturn err;\r\nsnd_ac97_rename_vol_ctl(ac97, "Headphone Playback", "Front Playback");\r\nsnd_ac97_rename_vol_ctl(ac97, "Video Playback", "Surround Mix Playback");\r\nreturn 0;\r\n}\r\nstatic int patch_sigmatel_stac9758(struct snd_ac97 * ac97)\r\n{\r\nstatic unsigned short regs[4] = {\r\nAC97_SIGMATEL_OUTSEL,\r\nAC97_SIGMATEL_IOMISC,\r\nAC97_SIGMATEL_INSEL,\r\nAC97_SIGMATEL_VARIOUS\r\n};\r\nstatic unsigned short def_regs[4] = {\r\n0xd794,\r\n0x2001,\r\n0x0201,\r\n0x0040\r\n};\r\nstatic unsigned short m675_regs[4] = {\r\n0xfc70,\r\n0x2102,\r\n0x0203,\r\n0x0041\r\n};\r\nunsigned short *pregs = def_regs;\r\nint i;\r\nif (ac97->pci &&\r\nac97->subsystem_vendor == 0x107b &&\r\nac97->subsystem_device == 0x0601)\r\npregs = m675_regs;\r\nac97->build_ops = &patch_sigmatel_stac9758_ops;\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING, AC97_PAGE_MASK, AC97_PAGE_VENDOR);\r\nfor (i = 0; i < 4; i++)\r\nsnd_ac97_write_cache(ac97, regs[i], pregs[i]);\r\nac97->flags |= AC97_STEREO_MUTES;\r\nreturn 0;\r\n}\r\nstatic int patch_cirrus_build_spdif(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, &snd_ac97_controls_spdif[0], 3)) < 0)\r\nreturn err;\r\nif ((err = patch_build_controls(ac97, &snd_ac97_cirrus_controls_spdif[0], 1)) < 0)\r\nreturn err;\r\nswitch (ac97->id & AC97_ID_CS_MASK) {\r\ncase AC97_ID_CS4205:\r\nif ((err = patch_build_controls(ac97, &snd_ac97_cirrus_controls_spdif[1], 1)) < 0)\r\nreturn err;\r\nbreak;\r\n}\r\nsnd_ac97_write_cache(ac97, AC97_CSR_SPDIF, 0x0a20);\r\nreturn 0;\r\n}\r\nstatic int patch_cirrus_spdif(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_cirrus_ops;\r\nac97->flags |= AC97_CS_SPDIF;\r\nac97->rates[AC97_RATES_SPDIF] &= ~SNDRV_PCM_RATE_32000;\r\nac97->ext_id |= AC97_EI_SPDIF;\r\nsnd_ac97_write_cache(ac97, AC97_CSR_ACMODE, 0x0080);\r\nreturn 0;\r\n}\r\nstatic int patch_cirrus_cs4299(struct snd_ac97 * ac97)\r\n{\r\nac97->flags |= AC97_HAS_PC_BEEP;\r\nreturn patch_cirrus_spdif(ac97);\r\n}\r\nstatic int patch_conexant_build_spdif(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, &snd_ac97_controls_spdif[0], 3)) < 0)\r\nreturn err;\r\nif ((err = patch_build_controls(ac97, &snd_ac97_conexant_controls_spdif[0], 1)) < 0)\r\nreturn err;\r\nsnd_ac97_write_cache(ac97, AC97_CXR_AUDIO_MISC,\r\nsnd_ac97_read(ac97, AC97_CXR_AUDIO_MISC) & ~(AC97_CXR_SPDIFEN|AC97_CXR_COPYRGT|AC97_CXR_SPDIF_MASK));\r\nreturn 0;\r\n}\r\nstatic int patch_conexant(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_conexant_ops;\r\nac97->flags |= AC97_CX_SPDIF;\r\nac97->ext_id |= AC97_EI_SPDIF;\r\nac97->rates[AC97_RATES_SPDIF] = SNDRV_PCM_RATE_48000;\r\nreturn 0;\r\n}\r\nstatic int patch_cx20551(struct snd_ac97 *ac97)\r\n{\r\nsnd_ac97_update_bits(ac97, 0x5c, 0x01, 0x01);\r\nreturn 0;\r\n}\r\nstatic void ad18xx_resume(struct snd_ac97 *ac97)\r\n{\r\nstatic unsigned short setup_regs[] = {\r\nAC97_AD_MISC, AC97_AD_SERIAL_CFG, AC97_AD_JACK_SPDIF,\r\n};\r\nint i, codec;\r\nfor (i = 0; i < (int)ARRAY_SIZE(setup_regs); i++) {\r\nunsigned short reg = setup_regs[i];\r\nif (test_bit(reg, ac97->reg_accessed)) {\r\nsnd_ac97_write(ac97, reg, ac97->regs[reg]);\r\nsnd_ac97_read(ac97, reg);\r\n}\r\n}\r\nif (! (ac97->flags & AC97_AD_MULTI))\r\nsnd_ac97_restore_status(ac97);\r\nelse {\r\nfor (codec = 0; codec < 3; codec++) {\r\nif (! ac97->spec.ad18xx.id[codec])\r\ncontinue;\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000,\r\nac97->spec.ad18xx.unchained[codec] | ac97->spec.ad18xx.chained[codec]);\r\nac97->bus->ops->write(ac97, AC97_AD_CODEC_CFG, ac97->spec.ad18xx.codec_cfg[codec]);\r\n}\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000, 0x7000);\r\nfor (i = 2; i < 0x7c ; i += 2) {\r\nif (i == AC97_POWERDOWN || i == AC97_EXTENDED_ID)\r\ncontinue;\r\nif (test_bit(i, ac97->reg_accessed)) {\r\nif (i == AC97_PCM) {\r\nfor (codec = 0; codec < 3; codec++) {\r\nif (! ac97->spec.ad18xx.id[codec])\r\ncontinue;\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000,\r\nac97->spec.ad18xx.unchained[codec] | ac97->spec.ad18xx.chained[codec]);\r\nac97->bus->ops->write(ac97, AC97_PCM, ac97->spec.ad18xx.pcmreg[codec]);\r\n}\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000, 0x7000);\r\ncontinue;\r\n} else if (i == AC97_AD_TEST ||\r\ni == AC97_AD_CODEC_CFG ||\r\ni == AC97_AD_SERIAL_CFG)\r\ncontinue;\r\n}\r\nsnd_ac97_write(ac97, i, ac97->regs[i]);\r\nsnd_ac97_read(ac97, i);\r\n}\r\n}\r\nsnd_ac97_restore_iec958(ac97);\r\n}\r\nstatic void ad1888_resume(struct snd_ac97 *ac97)\r\n{\r\nad18xx_resume(ac97);\r\nsnd_ac97_write_cache(ac97, AC97_CODEC_CLASS_REV, 0x8080);\r\n}\r\nstatic int patch_ad1819(struct snd_ac97 * ac97)\r\n{\r\nunsigned short scfg;\r\nscfg = snd_ac97_read(ac97, AC97_AD_SERIAL_CFG);\r\nsnd_ac97_write_cache(ac97, AC97_AD_SERIAL_CFG, scfg | 0x7000);\r\nac97->res_table = ad1819_restbl;\r\nreturn 0;\r\n}\r\nstatic unsigned short patch_ad1881_unchained(struct snd_ac97 * ac97, int idx, unsigned short mask)\r\n{\r\nunsigned short val;\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000, mask);\r\nsnd_ac97_write_cache(ac97, AC97_AD_CODEC_CFG, 0x0000);\r\nval = snd_ac97_read(ac97, AC97_VENDOR_ID2);\r\nif ((val & 0xff40) != 0x5340)\r\nreturn 0;\r\nac97->spec.ad18xx.unchained[idx] = mask;\r\nac97->spec.ad18xx.id[idx] = val;\r\nac97->spec.ad18xx.codec_cfg[idx] = 0x0000;\r\nreturn mask;\r\n}\r\nstatic int patch_ad1881_chained1(struct snd_ac97 * ac97, int idx, unsigned short codec_bits)\r\n{\r\nstatic int cfg_bits[3] = { 1<<12, 1<<14, 1<<13 };\r\nunsigned short val;\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000, cfg_bits[idx]);\r\nsnd_ac97_write_cache(ac97, AC97_AD_CODEC_CFG, 0x0004);\r\nval = snd_ac97_read(ac97, AC97_VENDOR_ID2);\r\nif ((val & 0xff40) != 0x5340)\r\nreturn 0;\r\nif (codec_bits)\r\nsnd_ac97_write_cache(ac97, AC97_AD_CODEC_CFG, codec_bits);\r\nac97->spec.ad18xx.chained[idx] = cfg_bits[idx];\r\nac97->spec.ad18xx.id[idx] = val;\r\nac97->spec.ad18xx.codec_cfg[idx] = codec_bits ? codec_bits : 0x0004;\r\nreturn 1;\r\n}\r\nstatic void patch_ad1881_chained(struct snd_ac97 * ac97, int unchained_idx, int cidx1, int cidx2)\r\n{\r\nif (ac97->spec.ad18xx.unchained[cidx1] || ac97->spec.ad18xx.chained[cidx1])\r\ncidx1 = -1;\r\nif (ac97->spec.ad18xx.unchained[cidx2] || ac97->spec.ad18xx.chained[cidx2])\r\ncidx2 = -1;\r\nif (cidx1 < 0 && cidx2 < 0)\r\nreturn;\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000,\r\nac97->spec.ad18xx.unchained[unchained_idx]);\r\nsnd_ac97_write_cache(ac97, AC97_AD_CODEC_CFG, 0x0002);\r\nac97->spec.ad18xx.codec_cfg[unchained_idx] = 0x0002;\r\nif (cidx1 >= 0) {\r\nif (cidx2 < 0)\r\npatch_ad1881_chained1(ac97, cidx1, 0);\r\nelse if (patch_ad1881_chained1(ac97, cidx1, 0x0006))\r\npatch_ad1881_chained1(ac97, cidx2, 0);\r\nelse if (patch_ad1881_chained1(ac97, cidx2, 0x0006))\r\npatch_ad1881_chained1(ac97, cidx1, 0);\r\n} else if (cidx2 >= 0) {\r\npatch_ad1881_chained1(ac97, cidx2, 0);\r\n}\r\n}\r\nstatic int patch_ad1881(struct snd_ac97 * ac97)\r\n{\r\nstatic const char cfg_idxs[3][2] = {\r\n{2, 1},\r\n{0, 2},\r\n{0, 1}\r\n};\r\nunsigned short codecs[3];\r\nunsigned short val;\r\nint idx, num;\r\nval = snd_ac97_read(ac97, AC97_AD_SERIAL_CFG);\r\nsnd_ac97_write_cache(ac97, AC97_AD_SERIAL_CFG, val);\r\ncodecs[0] = patch_ad1881_unchained(ac97, 0, (1<<12));\r\ncodecs[1] = patch_ad1881_unchained(ac97, 1, (1<<14));\r\ncodecs[2] = patch_ad1881_unchained(ac97, 2, (1<<13));\r\nif (! (codecs[0] || codecs[1] || codecs[2]))\r\ngoto __end;\r\nfor (idx = 0; idx < 3; idx++)\r\nif (ac97->spec.ad18xx.unchained[idx])\r\npatch_ad1881_chained(ac97, idx, cfg_idxs[idx][0], cfg_idxs[idx][1]);\r\nif (ac97->spec.ad18xx.id[1]) {\r\nac97->flags |= AC97_AD_MULTI;\r\nac97->scaps |= AC97_SCAP_SURROUND_DAC;\r\n}\r\nif (ac97->spec.ad18xx.id[2]) {\r\nac97->flags |= AC97_AD_MULTI;\r\nac97->scaps |= AC97_SCAP_CENTER_LFE_DAC;\r\n}\r\n__end:\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000, 0x7000);\r\nfor (idx = num = 0; idx < 3; idx++)\r\nif (ac97->spec.ad18xx.id[idx])\r\nnum++;\r\nif (num == 1) {\r\nsnd_ac97_write_cache(ac97, AC97_AD_CODEC_CFG, 0x0000);\r\nac97->spec.ad18xx.codec_cfg[0] =\r\nac97->spec.ad18xx.codec_cfg[1] =\r\nac97->spec.ad18xx.codec_cfg[2] = 0x0000;\r\n}\r\nac97->ext_id = snd_ac97_read(ac97, AC97_EXTENDED_ID);\r\nif (ac97->spec.ad18xx.id[0]) {\r\nac97->id &= 0xffff0000;\r\nac97->id |= ac97->spec.ad18xx.id[0];\r\n}\r\nac97->build_ops = &patch_ad1881_build_ops;\r\nreturn 0;\r\n}\r\nstatic int patch_ad1885_specific(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, snd_ac97_controls_ad1885, ARRAY_SIZE(snd_ac97_controls_ad1885))) < 0)\r\nreturn err;\r\nreset_tlv(ac97, "Headphone Playback Volume",\r\ndb_scale_6bit_6db_max);\r\nreturn 0;\r\n}\r\nstatic int patch_ad1885(struct snd_ac97 * ac97)\r\n{\r\npatch_ad1881(ac97);\r\nsnd_ac97_write_cache(ac97, AC97_AD_MISC, 0x0404);\r\nac97->build_ops = &patch_ad1885_build_ops;\r\nreturn 0;\r\n}\r\nstatic int patch_ad1886_specific(struct snd_ac97 * ac97)\r\n{\r\nreset_tlv(ac97, "Headphone Playback Volume",\r\ndb_scale_6bit_6db_max);\r\nreturn 0;\r\n}\r\nstatic int patch_ad1886(struct snd_ac97 * ac97)\r\n{\r\npatch_ad1881(ac97);\r\nsnd_ac97_write_cache(ac97, AC97_AD_JACK_SPDIF, 0x0010);\r\nac97->build_ops = &patch_ad1886_build_ops;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad198x_spdif_source_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[2] = { "AC-Link", "A/D Converter" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 2;\r\nif (uinfo->value.enumerated.item > 1)\r\nuinfo->value.enumerated.item = 1;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad198x_spdif_source_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_AD_SERIAL_CFG];\r\nucontrol->value.enumerated.item[0] = (val >> 2) & 1;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad198x_spdif_source_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nif (ucontrol->value.enumerated.item[0] > 1)\r\nreturn -EINVAL;\r\nval = ucontrol->value.enumerated.item[0] << 2;\r\nreturn snd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x0004, val);\r\n}\r\nstatic int patch_ad198x_post_spdif(struct snd_ac97 * ac97)\r\n{\r\nreturn patch_build_controls(ac97, &snd_ac97_ad198x_spdif_source, 1);\r\n}\r\nstatic int check_list(struct snd_ac97 *ac97, const unsigned int *list)\r\n{\r\nu32 subid = ((u32)ac97->subsystem_vendor << 16) | ac97->subsystem_device;\r\nfor (; *list; list++)\r\nif (*list == subid)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int patch_ad1981a_specific(struct snd_ac97 * ac97)\r\n{\r\nif (check_list(ac97, ad1981_jacks_blacklist))\r\nreturn 0;\r\nreturn patch_build_controls(ac97, snd_ac97_ad1981x_jack_sense,\r\nARRAY_SIZE(snd_ac97_ad1981x_jack_sense));\r\n}\r\nstatic void check_ad1981_hp_jack_sense(struct snd_ac97 *ac97)\r\n{\r\nif (check_list(ac97, ad1981_jacks_whitelist))\r\nsnd_ac97_update_bits(ac97, AC97_AD_JACK_SPDIF, 1<<11, 1<<11);\r\n}\r\nstatic int patch_ad1981a(struct snd_ac97 *ac97)\r\n{\r\npatch_ad1881(ac97);\r\nac97->build_ops = &patch_ad1981a_build_ops;\r\nsnd_ac97_update_bits(ac97, AC97_AD_MISC, AC97_AD198X_MSPLT, AC97_AD198X_MSPLT);\r\nac97->flags |= AC97_STEREO_MUTES;\r\ncheck_ad1981_hp_jack_sense(ac97);\r\nreturn 0;\r\n}\r\nstatic int patch_ad1981b_specific(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, &snd_ac97_ad198x_2cmic, 1)) < 0)\r\nreturn err;\r\nif (check_list(ac97, ad1981_jacks_blacklist))\r\nreturn 0;\r\nreturn patch_build_controls(ac97, snd_ac97_ad1981x_jack_sense,\r\nARRAY_SIZE(snd_ac97_ad1981x_jack_sense));\r\n}\r\nstatic int patch_ad1981b(struct snd_ac97 *ac97)\r\n{\r\npatch_ad1881(ac97);\r\nac97->build_ops = &patch_ad1981b_build_ops;\r\nsnd_ac97_update_bits(ac97, AC97_AD_MISC, AC97_AD198X_MSPLT, AC97_AD198X_MSPLT);\r\nac97->flags |= AC97_STEREO_MUTES;\r\ncheck_ad1981_hp_jack_sense(ac97);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1888_lohpsel_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_AD_MISC];\r\nucontrol->value.integer.value[0] = !(val & AC97_AD198X_LOSEL);\r\nif (ac97->spec.ad18xx.lo_as_master)\r\nucontrol->value.integer.value[0] =\r\n!ucontrol->value.integer.value[0];\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1888_lohpsel_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = !ucontrol->value.integer.value[0];\r\nif (ac97->spec.ad18xx.lo_as_master)\r\nval = !val;\r\nval = val ? (AC97_AD198X_LOSEL | AC97_AD198X_HPSEL) : 0;\r\nreturn snd_ac97_update_bits(ac97, AC97_AD_MISC,\r\nAC97_AD198X_LOSEL | AC97_AD198X_HPSEL, val);\r\n}\r\nstatic int snd_ac97_ad1888_downmix_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[3] = {"Off", "6 -> 4", "6 -> 2"};\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 3;\r\nif (uinfo->value.enumerated.item > 2)\r\nuinfo->value.enumerated.item = 2;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1888_downmix_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_AD_MISC];\r\nif (!(val & AC97_AD198X_DMIX1))\r\nucontrol->value.enumerated.item[0] = 0;\r\nelse\r\nucontrol->value.enumerated.item[0] = 1 + ((val >> 8) & 1);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1888_downmix_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nif (ucontrol->value.enumerated.item[0] > 2)\r\nreturn -EINVAL;\r\nif (ucontrol->value.enumerated.item[0] == 0)\r\nval = 0;\r\nelse\r\nval = AC97_AD198X_DMIX1 |\r\n((ucontrol->value.enumerated.item[0] - 1) << 8);\r\nreturn snd_ac97_update_bits(ac97, AC97_AD_MISC,\r\nAC97_AD198X_DMIX0 | AC97_AD198X_DMIX1, val);\r\n}\r\nstatic void ad1888_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nunsigned short val = 0;\r\nif (!ac97->spec.ad18xx.lo_as_master && is_shared_linein(ac97))\r\nval |= (1 << 12);\r\nif (is_shared_micin(ac97))\r\nval |= (1 << 11);\r\nsnd_ac97_update_bits(ac97, AC97_AD_MISC, (1 << 11) | (1 << 12), val);\r\n}\r\nstatic int patch_ad1888_specific(struct snd_ac97 *ac97)\r\n{\r\nif (!ac97->spec.ad18xx.lo_as_master) {\r\nsnd_ac97_rename_vol_ctl(ac97, "Master Playback",\r\n"Master Surround Playback");\r\nsnd_ac97_rename_vol_ctl(ac97, "Headphone Playback",\r\n"Master Playback");\r\n}\r\nreturn patch_build_controls(ac97, snd_ac97_ad1888_controls, ARRAY_SIZE(snd_ac97_ad1888_controls));\r\n}\r\nstatic int patch_ad1888(struct snd_ac97 * ac97)\r\n{\r\nunsigned short misc;\r\npatch_ad1881(ac97);\r\nac97->build_ops = &patch_ad1888_build_ops;\r\nif (ac97->subsystem_vendor == 0x1043 &&\r\nac97->subsystem_device == 0x1193)\r\nac97->spec.ad18xx.lo_as_master = 1;\r\nmisc = snd_ac97_read(ac97, AC97_AD_MISC);\r\nmisc |= AC97_AD198X_MSPLT | AC97_AD198X_AC97NC;\r\nif (!ac97->spec.ad18xx.lo_as_master)\r\nmisc |= AC97_AD198X_LOSEL | AC97_AD198X_HPSEL;\r\nsnd_ac97_write_cache(ac97, AC97_AD_MISC, misc);\r\nac97->flags |= AC97_STEREO_MUTES;\r\nreturn 0;\r\n}\r\nstatic int patch_ad1980_specific(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nif ((err = patch_ad1888_specific(ac97)) < 0)\r\nreturn err;\r\nreturn patch_build_controls(ac97, &snd_ac97_ad198x_2cmic, 1);\r\n}\r\nstatic int patch_ad1980(struct snd_ac97 * ac97)\r\n{\r\npatch_ad1888(ac97);\r\nac97->build_ops = &patch_ad1980_build_ops;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1985_vrefout_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[4] = {"High-Z", "3.7 V", "2.25 V", "0 V"};\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 4;\r\nif (uinfo->value.enumerated.item > 3)\r\nuinfo->value.enumerated.item = 3;\r\nstrcpy(uinfo->value.enumerated.name,\r\ntexts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1985_vrefout_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstatic const int reg2ctrl[4] = {2, 0, 1, 3};\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = (ac97->regs[AC97_AD_MISC] & AC97_AD198X_VREF_MASK)\r\n>> AC97_AD198X_VREF_SHIFT;\r\nucontrol->value.enumerated.item[0] = reg2ctrl[val];\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1985_vrefout_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstatic const int ctrl2reg[4] = {1, 2, 0, 3};\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nif (ucontrol->value.enumerated.item[0] > 3)\r\nreturn -EINVAL;\r\nval = ctrl2reg[ucontrol->value.enumerated.item[0]]\r\n<< AC97_AD198X_VREF_SHIFT;\r\nreturn snd_ac97_update_bits(ac97, AC97_AD_MISC,\r\nAC97_AD198X_VREF_MASK, val);\r\n}\r\nstatic void ad1985_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nad1888_update_jacks(ac97);\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 1 << 9,\r\nis_shared_micin(ac97) ? 1 << 9 : 0);\r\n}\r\nstatic int patch_ad1985_specific(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nsnd_ac97_rename_vol_ctl(ac97, "Master Playback",\r\n"Master Surround Playback");\r\nsnd_ac97_rename_vol_ctl(ac97, "Headphone Playback", "Master Playback");\r\nif ((err = patch_build_controls(ac97, &snd_ac97_ad198x_2cmic, 1)) < 0)\r\nreturn err;\r\nreturn patch_build_controls(ac97, snd_ac97_ad1985_controls,\r\nARRAY_SIZE(snd_ac97_ad1985_controls));\r\n}\r\nstatic int patch_ad1985(struct snd_ac97 * ac97)\r\n{\r\nunsigned short misc;\r\npatch_ad1881(ac97);\r\nac97->build_ops = &patch_ad1985_build_ops;\r\nmisc = snd_ac97_read(ac97, AC97_AD_MISC);\r\nsnd_ac97_write_cache(ac97, AC97_AD_MISC, misc |\r\nAC97_AD198X_LOSEL |\r\nAC97_AD198X_HPSEL |\r\nAC97_AD198X_MSPLT |\r\nAC97_AD198X_AC97NC);\r\nac97->flags |= AC97_STEREO_MUTES;\r\nad1985_update_jacks(ac97);\r\nac97->ext_id = (ac97->ext_id & ~AC97_EI_REV_MASK) | AC97_EI_REV_23;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1986_lososel_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_AD_MISC3];\r\nucontrol->value.integer.value[0] = (val & AC97_AD1986_LOSEL) != 0;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1986_lososel_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nint ret0;\r\nint ret1;\r\nint sprd = (ac97->regs[AC97_AD_MISC] & AC97_AD1986_SPRD) != 0;\r\nret0 = snd_ac97_update_bits(ac97, AC97_AD_MISC3, AC97_AD1986_LOSEL,\r\nucontrol->value.integer.value[0] != 0\r\n? AC97_AD1986_LOSEL : 0);\r\nif (ret0 < 0)\r\nreturn ret0;\r\nret1 = snd_ac97_update_bits(ac97, AC97_AD_MISC, AC97_AD1986_SOSEL,\r\n(ucontrol->value.integer.value[0] != 0\r\n|| sprd)\r\n? AC97_AD1986_SOSEL : 0);\r\nif (ret1 < 0)\r\nreturn ret1;\r\nreturn (ret0 > 0 || ret1 > 0) ? 1 : 0;\r\n}\r\nstatic int snd_ac97_ad1986_spread_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_AD_MISC];\r\nucontrol->value.integer.value[0] = (val & AC97_AD1986_SPRD) != 0;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1986_spread_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nint ret0;\r\nint ret1;\r\nint sprd = (ac97->regs[AC97_AD_MISC3] & AC97_AD1986_LOSEL) != 0;\r\nret0 = snd_ac97_update_bits(ac97, AC97_AD_MISC, AC97_AD1986_SPRD,\r\nucontrol->value.integer.value[0] != 0\r\n? AC97_AD1986_SPRD : 0);\r\nif (ret0 < 0)\r\nreturn ret0;\r\nret1 = snd_ac97_update_bits(ac97, AC97_AD_MISC, AC97_AD1986_SOSEL,\r\n(ucontrol->value.integer.value[0] != 0\r\n|| sprd)\r\n? AC97_AD1986_SOSEL : 0);\r\nif (ret1 < 0)\r\nreturn ret1;\r\nreturn (ret0 > 0 || ret1 > 0) ? 1 : 0;\r\n}\r\nstatic int snd_ac97_ad1986_miclisel_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.integer.value[0] = ac97->spec.ad18xx.swap_mic_linein;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1986_miclisel_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned char swap = ucontrol->value.integer.value[0] != 0;\r\nif (swap != ac97->spec.ad18xx.swap_mic_linein) {\r\nac97->spec.ad18xx.swap_mic_linein = swap;\r\nif (ac97->build_ops->update_jacks)\r\nac97->build_ops->update_jacks(ac97);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1986_vrefout_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nunsigned short reg = ac97->regs[AC97_AD_MISC2];\r\nif ((reg & AC97_AD1986_MVREF0) != 0)\r\nval = 2;\r\nelse if ((reg & AC97_AD1986_MVREF1) != 0)\r\nval = 3;\r\nelse if ((reg & AC97_AD1986_MVREF2) != 0)\r\nval = 1;\r\nelse\r\nval = 0;\r\nucontrol->value.enumerated.item[0] = val;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_ad1986_vrefout_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short cval;\r\nunsigned short lval;\r\nunsigned short mval;\r\nint cret;\r\nint lret;\r\nint mret;\r\nswitch (ucontrol->value.enumerated.item[0])\r\n{\r\ncase 0:\r\ncval = 0;\r\nlval = 0;\r\nmval = 0;\r\nbreak;\r\ncase 1:\r\ncval = AC97_AD1986_CVREF2;\r\nlval = AC97_AD1986_LVREF2;\r\nmval = AC97_AD1986_MVREF2;\r\nbreak;\r\ncase 2:\r\ncval = AC97_AD1986_CVREF0;\r\nlval = AC97_AD1986_LVREF0;\r\nmval = AC97_AD1986_MVREF0;\r\nbreak;\r\ncase 3:\r\ncval = AC97_AD1986_CVREF1;\r\nlval = AC97_AD1986_LVREF1;\r\nmval = AC97_AD1986_MVREF1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncret = snd_ac97_update_bits(ac97, AC97_AD_MISC2,\r\nAC97_AD1986_CVREF_MASK, cval);\r\nif (cret < 0)\r\nreturn cret;\r\nlret = snd_ac97_update_bits(ac97, AC97_AD_MISC3,\r\nAC97_AD1986_LVREF_MASK, lval);\r\nif (lret < 0)\r\nreturn lret;\r\nmret = snd_ac97_update_bits(ac97, AC97_AD_MISC2,\r\nAC97_AD1986_MVREF_MASK, mval);\r\nif (mret < 0)\r\nreturn mret;\r\nreturn (cret > 0 || lret > 0 || mret > 0) ? 1 : 0;\r\n}\r\nstatic void ad1986_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nunsigned short misc_val = 0;\r\nunsigned short ser_val;\r\nif (!is_surround_on(ac97))\r\nmisc_val |= AC97_AD1986_SODIS;\r\nif (!is_clfe_on(ac97))\r\nmisc_val |= AC97_AD1986_CLDIS;\r\nif (is_shared_linein(ac97))\r\nmisc_val |= AC97_AD1986_LISEL_SURR;\r\nelse if (ac97->spec.ad18xx.swap_mic_linein != 0)\r\nmisc_val |= AC97_AD1986_LISEL_MIC;\r\nsnd_ac97_update_bits(ac97, AC97_AD_MISC,\r\nAC97_AD1986_SODIS | AC97_AD1986_CLDIS |\r\nAC97_AD1986_LISEL_MASK,\r\nmisc_val);\r\nif (is_shared_micin(ac97))\r\nser_val = AC97_AD1986_OMS_C;\r\nelse if (ac97->spec.ad18xx.swap_mic_linein != 0)\r\nser_val = AC97_AD1986_OMS_L;\r\nelse\r\nser_val = AC97_AD1986_OMS_M;\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG,\r\nAC97_AD1986_OMS_MASK,\r\nser_val);\r\n}\r\nstatic int patch_ad1986_specific(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, &snd_ac97_ad198x_2cmic, 1)) < 0)\r\nreturn err;\r\nreturn patch_build_controls(ac97, snd_ac97_ad1986_controls,\r\nARRAY_SIZE(snd_ac97_ad1985_controls));\r\n}\r\nstatic int patch_ad1986(struct snd_ac97 * ac97)\r\n{\r\npatch_ad1881(ac97);\r\nac97->build_ops = &patch_ad1986_build_ops;\r\nac97->flags |= AC97_STEREO_MUTES;\r\nad1986_update_jacks(ac97);\r\nreturn 0;\r\n}\r\nstatic int patch_alc203(struct snd_ac97 *ac97)\r\n{\r\nsnd_ac97_update_bits(ac97, 0x7a, 0x400, 0x400);\r\nreturn 0;\r\n}\r\nstatic void alc650_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nint shared;\r\nshared = is_shared_surrout(ac97);\r\nsnd_ac97_update_bits(ac97, AC97_ALC650_MULTICH, 1 << 9,\r\nshared ? (1 << 9) : 0);\r\nshared = is_shared_clfeout(ac97);\r\nsnd_ac97_update_bits(ac97, AC97_ALC650_CLOCK, 1 << 12,\r\nshared ? (1 << 12) : 0);\r\nsnd_ac97_update_bits(ac97, AC97_ALC650_MULTICH, 1 << 10,\r\nshared ? (1 << 10) : 0);\r\nsnd_ac97_update_bits(ac97, AC97_ALC650_GPIO_STATUS, 0x100,\r\nshared ? 0 : 0x100);\r\n}\r\nstatic int patch_alc650_specific(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, snd_ac97_controls_alc650, ARRAY_SIZE(snd_ac97_controls_alc650))) < 0)\r\nreturn err;\r\nif (ac97->ext_id & AC97_EI_SPDIF) {\r\nif ((err = patch_build_controls(ac97, snd_ac97_spdif_controls_alc650, ARRAY_SIZE(snd_ac97_spdif_controls_alc650))) < 0)\r\nreturn err;\r\n}\r\nif (ac97->id != AC97_ID_ALC650F)\r\nreset_tlv(ac97, "Master Playback Volume",\r\ndb_scale_5bit_3db_max);\r\nreturn 0;\r\n}\r\nstatic int patch_alc650(struct snd_ac97 * ac97)\r\n{\r\nunsigned short val;\r\nac97->build_ops = &patch_alc650_ops;\r\nval = snd_ac97_read(ac97, AC97_ALC650_REVISION) & 0x3f;\r\nif (val < 3)\r\nac97->id = 0x414c4720;\r\nelse if (val < 0x10)\r\nac97->id = 0x414c4721;\r\nelse if (val < 0x20)\r\nac97->id = 0x414c4722;\r\nelse if (val < 0x30)\r\nac97->id = 0x414c4723;\r\nac97->spec.dev_flags = (ac97->id == 0x414c4722 ||\r\nac97->id == 0x414c4723);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_GPIO_STATUS,\r\nsnd_ac97_read(ac97, AC97_ALC650_GPIO_STATUS) | 0x8000);\r\nval = snd_ac97_read(ac97, AC97_ALC650_CLOCK);\r\nif (ac97->spec.dev_flags &&\r\n! (ac97->subsystem_vendor == 0x1043 &&\r\nac97->subsystem_device == 0x1103))\r\nval |= 0x03;\r\nelse\r\nval &= ~0x03;\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_CLOCK, val);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_MULTICH, 0);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_GPIO_SETUP,\r\nsnd_ac97_read(ac97, AC97_ALC650_GPIO_SETUP) | 0x01);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_GPIO_STATUS,\r\n(snd_ac97_read(ac97, AC97_ALC650_GPIO_STATUS) | 0x100) & ~0x10);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_SURR_DAC_VOL, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_LFE_DAC_VOL, 0x0808);\r\nreturn 0;\r\n}\r\nstatic void alc655_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nint shared;\r\nshared = is_shared_surrout(ac97);\r\nac97_update_bits_page(ac97, AC97_ALC650_MULTICH, 1 << 9,\r\nshared ? (1 << 9) : 0, 0);\r\nshared = is_shared_clfeout(ac97);\r\nsnd_ac97_update_bits(ac97, AC97_ALC650_CLOCK, 1 << 12,\r\nshared ? (1 << 12) : 0);\r\nac97_update_bits_page(ac97, AC97_ALC650_MULTICH, 1 << 10,\r\nshared ? (1 << 10) : 0, 0);\r\n}\r\nstatic int alc655_iec958_route_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts_655[3] = { "PCM", "Analog In", "IEC958 In" };\r\nstatic char *texts_658[4] = { "PCM", "Analog1 In", "Analog2 In", "IEC958 In" };\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = ac97->spec.dev_flags ? 4 : 3;\r\nif (uinfo->value.enumerated.item >= uinfo->value.enumerated.items)\r\nuinfo->value.enumerated.item = uinfo->value.enumerated.items - 1;\r\nstrcpy(uinfo->value.enumerated.name,\r\nac97->spec.dev_flags ?\r\ntexts_658[uinfo->value.enumerated.item] :\r\ntexts_655[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int alc655_iec958_route_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_ALC650_MULTICH];\r\nval = (val >> 12) & 3;\r\nif (ac97->spec.dev_flags && val == 3)\r\nval = 0;\r\nucontrol->value.enumerated.item[0] = val;\r\nreturn 0;\r\n}\r\nstatic int alc655_iec958_route_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nreturn ac97_update_bits_page(ac97, AC97_ALC650_MULTICH, 3 << 12,\r\n(unsigned short)ucontrol->value.enumerated.item[0] << 12,\r\n0);\r\n}\r\nstatic int patch_alc655_specific(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, snd_ac97_controls_alc655, ARRAY_SIZE(snd_ac97_controls_alc655))) < 0)\r\nreturn err;\r\nif (ac97->ext_id & AC97_EI_SPDIF) {\r\nif ((err = patch_build_controls(ac97, snd_ac97_spdif_controls_alc655, ARRAY_SIZE(snd_ac97_spdif_controls_alc655))) < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int patch_alc655(struct snd_ac97 * ac97)\r\n{\r\nunsigned int val;\r\nif (ac97->id == AC97_ID_ALC658) {\r\nac97->spec.dev_flags = 1;\r\nif ((snd_ac97_read(ac97, AC97_ALC650_REVISION) & 0x3f) == 2) {\r\nac97->id = AC97_ID_ALC658D;\r\nac97->spec.dev_flags = 2;\r\n}\r\n}\r\nac97->build_ops = &patch_alc655_ops;\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING, AC97_PAGE_MASK, AC97_PAGE_VENDOR);\r\nval = snd_ac97_read(ac97, 0x7a);\r\nif (ac97->spec.dev_flags)\r\nval &= ~(1 << 1);\r\nelse {\r\nif (ac97->subsystem_vendor == 0x1462 &&\r\n(ac97->subsystem_device == 0x0131 ||\r\nac97->subsystem_device == 0x0161 ||\r\nac97->subsystem_device == 0x0351 ||\r\nac97->subsystem_device == 0x0471 ||\r\nac97->subsystem_device == 0x0061))\r\nval &= ~(1 << 1);\r\nelse\r\nval |= (1 << 1);\r\nac97->ext_id |= AC97_EI_SPDIF;\r\n}\r\nval &= ~(1 << 12);\r\nsnd_ac97_write_cache(ac97, 0x7a, val);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_MULTICH, 1<<15);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_SURR_DAC_VOL, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_LFE_DAC_VOL, 0x0808);\r\nif (ac97->id == AC97_ID_ALC658D)\r\nsnd_ac97_update_bits(ac97, 0x74, 0x0800, 0x0800);\r\nreturn 0;\r\n}\r\nstatic void alc850_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nint shared;\r\nint aux_is_back_surround;\r\nshared = is_shared_surrout(ac97);\r\nsnd_ac97_update_bits(ac97, AC97_ALC850_MISC1, (1<<4)|(1<<5),\r\nshared ? (1<<5) : (1<<4));\r\nsnd_ac97_update_bits(ac97, AC97_ALC850_JACK_SELECT, 7 << 12,\r\nshared ? (2<<12) : (0<<12));\r\nshared = is_shared_clfeout(ac97);\r\nsnd_ac97_update_bits(ac97, AC97_ALC850_MISC1, (1<<12)|(1<<13),\r\nshared ? (1<<12) : (1<<13));\r\nsnd_ac97_update_bits(ac97, AC97_ALC850_JACK_SELECT, 7 << 4,\r\nshared ? (5<<4) : (1<<4));\r\naux_is_back_surround = alc850_is_aux_back_surround(ac97);\r\nsnd_ac97_update_bits(ac97, AC97_ALC850_MULTICH, 1 << 10,\r\naux_is_back_surround ? (1<<10) : (0<<10));\r\n}\r\nstatic int patch_alc850_specific(struct snd_ac97 *ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, snd_ac97_controls_alc850, ARRAY_SIZE(snd_ac97_controls_alc850))) < 0)\r\nreturn err;\r\nif (ac97->ext_id & AC97_EI_SPDIF) {\r\nif ((err = patch_build_controls(ac97, snd_ac97_spdif_controls_alc655, ARRAY_SIZE(snd_ac97_spdif_controls_alc655))) < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int patch_alc850(struct snd_ac97 *ac97)\r\n{\r\nac97->build_ops = &patch_alc850_ops;\r\nac97->spec.dev_flags = 0;\r\nac97->flags |= AC97_HAS_8CH;\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING, AC97_PAGE_MASK, AC97_PAGE_VENDOR);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_MULTICH, 1<<15);\r\nsnd_ac97_write_cache(ac97, 0x7a, (1<<1)|(1<<4)|(0<<5)|(1<<6)|\r\n(1<<7)|(0<<12)|(1<<13)|(0<<14));\r\nsnd_ac97_write_cache(ac97, 0x76, (0<<0)|(0<<2)|(1<<4)|(1<<7)|(2<<8)|\r\n(1<<11)|(0<<12)|(1<<15));\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_SURR_DAC_VOL, 0x0808);\r\nsnd_ac97_write_cache(ac97, AC97_ALC650_LFE_DAC_VOL, 0x0808);\r\nreturn 0;\r\n}\r\nstatic int patch_aztech_azf3328_specific(struct snd_ac97 *ac97)\r\n{\r\nstruct snd_kcontrol *kctl_3d_center =\r\nsnd_ac97_find_mixer_ctl(ac97, "3D Control - Center");\r\nstruct snd_kcontrol *kctl_3d_depth =\r\nsnd_ac97_find_mixer_ctl(ac97, "3D Control - Depth");\r\nif (kctl_3d_center) {\r\nkctl_3d_center->private_value =\r\nAC97_SINGLE_VALUE(AC97_3D_CONTROL, 1, 0x07, 0);\r\nsnd_ac97_rename_vol_ctl(ac97,\r\n"3D Control - Center", "3D Control - Width"\r\n);\r\n}\r\nif (kctl_3d_depth)\r\nkctl_3d_depth->private_value =\r\nAC97_SINGLE_VALUE(AC97_3D_CONTROL, 8, 0x03, 0);\r\nsnd_ac97_rename_vol_ctl(ac97,\r\n"Master Mono Playback", "Modem Playback"\r\n);\r\nsnd_ac97_rename_vol_ctl(ac97,\r\n"Headphone Playback", "FM Synth Playback"\r\n);\r\nreturn 0;\r\n}\r\nstatic int patch_aztech_azf3328(struct snd_ac97 *ac97)\r\n{\r\nac97->build_ops = &patch_aztech_azf3328_ops;\r\nreturn 0;\r\n}\r\nstatic void cm9738_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nsnd_ac97_update_bits(ac97, AC97_CM9738_VENDOR_CTRL, 1 << 10,\r\nis_shared_surrout(ac97) ? (1 << 10) : 0);\r\n}\r\nstatic int patch_cm9738_specific(struct snd_ac97 * ac97)\r\n{\r\nreturn patch_build_controls(ac97, snd_ac97_cm9738_controls, ARRAY_SIZE(snd_ac97_cm9738_controls));\r\n}\r\nstatic int patch_cm9738(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_cm9738_ops;\r\nac97->flags |= AC97_HAS_NO_PCM_VOL;\r\nsnd_ac97_write_cache(ac97, AC97_PCM, 0x8000);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_cmedia_spdif_playback_source_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[] = { "Analog", "Digital" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 2;\r\nif (uinfo->value.enumerated.item > 1)\r\nuinfo->value.enumerated.item = 1;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_cmedia_spdif_playback_source_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nval = ac97->regs[AC97_CM9739_SPDIF_CTRL];\r\nucontrol->value.enumerated.item[0] = (val >> 1) & 0x01;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_cmedia_spdif_playback_source_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nreturn snd_ac97_update_bits(ac97, AC97_CM9739_SPDIF_CTRL,\r\n0x01 << 1,\r\n(ucontrol->value.enumerated.item[0] & 0x01) << 1);\r\n}\r\nstatic void cm9739_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nsnd_ac97_update_bits(ac97, AC97_CM9739_MULTI_CHAN, 1 << 10,\r\nis_shared_surrout(ac97) ? (1 << 10) : 0);\r\nsnd_ac97_update_bits(ac97, AC97_CM9739_MULTI_CHAN, 0x3000,\r\nis_shared_clfeout(ac97) ? 0x1000 : 0x2000);\r\n}\r\nstatic int patch_cm9739_specific(struct snd_ac97 * ac97)\r\n{\r\nreturn patch_build_controls(ac97, snd_ac97_cm9739_controls, ARRAY_SIZE(snd_ac97_cm9739_controls));\r\n}\r\nstatic int patch_cm9739_post_spdif(struct snd_ac97 * ac97)\r\n{\r\nreturn patch_build_controls(ac97, snd_ac97_cm9739_controls_spdif, ARRAY_SIZE(snd_ac97_cm9739_controls_spdif));\r\n}\r\nstatic int patch_cm9739(struct snd_ac97 * ac97)\r\n{\r\nunsigned short val;\r\nac97->build_ops = &patch_cm9739_ops;\r\nac97->flags |= AC97_HAS_NO_MASTER_VOL | AC97_HAS_NO_PCM_VOL;\r\nsnd_ac97_write_cache(ac97, AC97_MASTER, 0x8000);\r\nsnd_ac97_write_cache(ac97, AC97_PCM, 0x8000);\r\nval = snd_ac97_read(ac97, AC97_EXTENDED_STATUS);\r\nif (val & AC97_EA_SPCV) {\r\nsnd_ac97_write_cache(ac97, AC97_CM9739_SPDIF_CTRL,\r\nsnd_ac97_read(ac97, AC97_CM9739_SPDIF_CTRL) | 0x01);\r\nac97->rates[AC97_RATES_SPDIF] = SNDRV_PCM_RATE_48000;\r\n} else {\r\nac97->ext_id &= ~AC97_EI_SPDIF;\r\nac97->rates[AC97_RATES_SPDIF] = 0;\r\n}\r\nval = snd_ac97_read(ac97, AC97_CM9739_MULTI_CHAN) & (1 << 4);\r\nval |= (1 << 3);\r\nval |= (1 << 13);\r\nif (! (ac97->ext_id & AC97_EI_SPDIF))\r\nval |= (1 << 14);\r\nsnd_ac97_write_cache(ac97, AC97_CM9739_MULTI_CHAN, val);\r\nsnd_ac97_write_cache(ac97, 0x70, 0x0100);\r\nsnd_ac97_write_cache(ac97, 0x72, 0x0020);\r\nif (ac97->pci &&\r\nac97->subsystem_vendor == 0x1043 &&\r\nac97->subsystem_device == 0x1843) {\r\nsnd_ac97_write_cache(ac97, AC97_CM9739_SPDIF_CTRL,\r\nsnd_ac97_read(ac97, AC97_CM9739_SPDIF_CTRL) & ~0x01);\r\nsnd_ac97_write_cache(ac97, AC97_CM9739_MULTI_CHAN,\r\nsnd_ac97_read(ac97, AC97_CM9739_MULTI_CHAN) | (1 << 14));\r\n}\r\nreturn 0;\r\n}\r\nstatic void cm9761_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nstatic unsigned short surr_on[3][2] = {\r\n{ 0x0008, 0x0000 },\r\n{ 0x0000, 0x0008 },\r\n{ 0x0000, 0x0008 },\r\n};\r\nstatic unsigned short clfe_on[3][2] = {\r\n{ 0x0000, 0x1000 },\r\n{ 0x1000, 0x0000 },\r\n{ 0x0000, 0x1000 },\r\n};\r\nstatic unsigned short surr_shared[3][2] = {\r\n{ 0x0000, 0x0400 },\r\n{ 0x0000, 0x0400 },\r\n{ 0x0000, 0x0400 },\r\n};\r\nstatic unsigned short clfe_shared[3][2] = {\r\n{ 0x2000, 0x0880 },\r\n{ 0x0000, 0x2880 },\r\n{ 0x2000, 0x0800 },\r\n};\r\nunsigned short val = 0;\r\nval |= surr_on[ac97->spec.dev_flags][is_surround_on(ac97)];\r\nval |= clfe_on[ac97->spec.dev_flags][is_clfe_on(ac97)];\r\nval |= surr_shared[ac97->spec.dev_flags][is_shared_surrout(ac97)];\r\nval |= clfe_shared[ac97->spec.dev_flags][is_shared_clfeout(ac97)];\r\nsnd_ac97_update_bits(ac97, AC97_CM9761_MULTI_CHAN, 0x3c88, val);\r\n}\r\nstatic int cm9761_spdif_out_source_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[] = { "AC-Link", "ADC", "SPDIF-In" };\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 3;\r\nif (uinfo->value.enumerated.item > 2)\r\nuinfo->value.enumerated.item = 2;\r\nstrcpy(uinfo->value.enumerated.name, texts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int cm9761_spdif_out_source_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nif (ac97->regs[AC97_CM9761_FUNC] & 0x1)\r\nucontrol->value.enumerated.item[0] = 2;\r\nelse if (ac97->regs[AC97_CM9761_SPDIF_CTRL] & 0x2)\r\nucontrol->value.enumerated.item[0] = 1;\r\nelse\r\nucontrol->value.enumerated.item[0] = 0;\r\nreturn 0;\r\n}\r\nstatic int cm9761_spdif_out_source_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ac97 *ac97 = snd_kcontrol_chip(kcontrol);\r\nif (ucontrol->value.enumerated.item[0] == 2)\r\nreturn snd_ac97_update_bits(ac97, AC97_CM9761_FUNC, 0x1, 0x1);\r\nsnd_ac97_update_bits(ac97, AC97_CM9761_FUNC, 0x1, 0);\r\nreturn snd_ac97_update_bits(ac97, AC97_CM9761_SPDIF_CTRL, 0x2,\r\nucontrol->value.enumerated.item[0] == 1 ? 0x2 : 0);\r\n}\r\nstatic int patch_cm9761_post_spdif(struct snd_ac97 * ac97)\r\n{\r\nreturn patch_build_controls(ac97, snd_ac97_cm9761_controls_spdif, ARRAY_SIZE(snd_ac97_cm9761_controls_spdif));\r\n}\r\nstatic int patch_cm9761_specific(struct snd_ac97 * ac97)\r\n{\r\nreturn patch_build_controls(ac97, snd_ac97_cm9761_controls, ARRAY_SIZE(snd_ac97_cm9761_controls));\r\n}\r\nstatic int patch_cm9761(struct snd_ac97 *ac97)\r\n{\r\nunsigned short val;\r\nac97->flags |= AC97_HAS_NO_PCM_VOL;\r\nsnd_ac97_write_cache(ac97, AC97_MASTER, 0x8808);\r\nsnd_ac97_write_cache(ac97, AC97_PCM, 0x8808);\r\nac97->spec.dev_flags = 0;\r\nif (ac97->id == AC97_ID_CM9761_82) {\r\nunsigned short tmp;\r\nval = snd_ac97_read(ac97, AC97_INT_PAGING);\r\nsnd_ac97_write_cache(ac97, AC97_INT_PAGING, (val & ~0x0f) | 0x01);\r\ntmp = snd_ac97_read(ac97, 0x60);\r\nac97->spec.dev_flags = tmp & 1;\r\nsnd_ac97_write_cache(ac97, AC97_INT_PAGING, val);\r\n} else if (ac97->id == AC97_ID_CM9761_83)\r\nac97->spec.dev_flags = 2;\r\nac97->build_ops = &patch_cm9761_ops;\r\nac97->ext_id |= AC97_EI_SPDIF;\r\nsnd_ac97_write_cache(ac97, AC97_EXTENDED_STATUS, 0x05c0);\r\nsnd_ac97_write_cache(ac97, AC97_CM9761_SPDIF_CTRL, 0x0001);\r\nac97->rates[AC97_RATES_SPDIF] = SNDRV_PCM_RATE_48000;\r\n#if 0\r\nif (ac97->spec.dev_flags)\r\nval = 0x0214;\r\nelse\r\nval = 0x321c;\r\n#endif\r\nval = snd_ac97_read(ac97, AC97_CM9761_MULTI_CHAN);\r\nval |= (1 << 4);\r\nsnd_ac97_write_cache(ac97, AC97_CM9761_MULTI_CHAN, val);\r\nsnd_ac97_write_cache(ac97, 0x70, 0x0100);\r\nsnd_ac97_write_cache(ac97, 0x72, 0x0020);\r\nreturn 0;\r\n}\r\nstatic int patch_cm9780_specific(struct snd_ac97 *ac97)\r\n{\r\nreturn patch_build_controls(ac97, cm9780_controls, ARRAY_SIZE(cm9780_controls));\r\n}\r\nstatic int patch_cm9780(struct snd_ac97 *ac97)\r\n{\r\nunsigned short val;\r\nac97->build_ops = &patch_cm9780_ops;\r\nif (ac97->ext_id & AC97_EI_SPDIF) {\r\nac97->rates[AC97_RATES_SPDIF] = SNDRV_PCM_RATE_48000;\r\nval = snd_ac97_read(ac97, AC97_CM9780_SPDIF);\r\nval |= 0x1;\r\nsnd_ac97_write_cache(ac97, AC97_CM9780_SPDIF, val);\r\n}\r\nreturn 0;\r\n}\r\nstatic struct snd_kcontrol *snd_ac97_find_mixer_ctl(struct snd_ac97 *ac97,\r\nconst char *name)\r\n{\r\nstruct snd_ctl_elem_id id;\r\nmemset(&id, 0, sizeof(id));\r\nid.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nstrcpy(id.name, name);\r\nreturn snd_ctl_find_id(ac97->bus->card, &id);\r\n}\r\nstatic int snd_ac97_add_vmaster(struct snd_ac97 *ac97, char *name,\r\nconst unsigned int *tlv, const char **slaves)\r\n{\r\nstruct snd_kcontrol *kctl;\r\nconst char **s;\r\nint err;\r\nkctl = snd_ctl_make_virtual_master(name, tlv);\r\nif (!kctl)\r\nreturn -ENOMEM;\r\nerr = snd_ctl_add(ac97->bus->card, kctl);\r\nif (err < 0)\r\nreturn err;\r\nfor (s = slaves; *s; s++) {\r\nstruct snd_kcontrol *sctl;\r\nsctl = snd_ac97_find_mixer_ctl(ac97, *s);\r\nif (!sctl) {\r\nsnd_printdd("Cannot find slave %s, skipped\n", *s);\r\ncontinue;\r\n}\r\nerr = snd_ctl_add_slave(kctl, sctl);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int patch_vt1616_specific(struct snd_ac97 * ac97)\r\n{\r\nstruct snd_kcontrol *kctl;\r\nint err;\r\nif (snd_ac97_try_bit(ac97, 0x5a, 9))\r\nif ((err = patch_build_controls(ac97, &snd_ac97_controls_vt1616[0], 1)) < 0)\r\nreturn err;\r\nif ((err = patch_build_controls(ac97, &snd_ac97_controls_vt1616[1], ARRAY_SIZE(snd_ac97_controls_vt1616) - 1)) < 0)\r\nreturn err;\r\nkctl = snd_ac97_find_mixer_ctl(ac97, "Master Playback Volume");\r\nif (!kctl)\r\nreturn -EINVAL;\r\nsnd_ac97_rename_vol_ctl(ac97, "Master Playback", "Front Playback");\r\nerr = snd_ac97_add_vmaster(ac97, "Master Playback Volume",\r\nkctl->tlv.p, slave_vols_vt1616);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ac97_add_vmaster(ac97, "Master Playback Switch",\r\nNULL, slave_sws_vt1616);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int patch_vt1616(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_vt1616_ops;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_vt1617a_smart51_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char* texts[] = { "LineIn Mic1", "LineIn Mic1 Mic3",\r\n"Surr LFE/C Mic3", "LineIn LFE/C Mic3",\r\n"LineIn Mic2", "LineIn Mic2 Mic1",\r\n"Surr LFE Mic1", "Surr LFE Mic1 Mic2"};\r\nreturn ac97_enum_text_info(kcontrol, uinfo, texts, 8);\r\n}\r\nstatic int snd_ac97_vt1617a_smart51_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nushort usSM51, usMS;\r\nstruct snd_ac97 *pac97;\r\npac97 = snd_kcontrol_chip(kcontrol);\r\nusSM51 = snd_ac97_read(pac97, 0x7a) >> 14;\r\nusMS = snd_ac97_read(pac97, 0x20) >> 8;\r\nucontrol->value.enumerated.item[0] = (usSM51 << 1) + usMS;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_vt1617a_smart51_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nushort usSM51, usMS, usReg;\r\nstruct snd_ac97 *pac97;\r\npac97 = snd_kcontrol_chip(kcontrol);\r\nusSM51 = ucontrol->value.enumerated.item[0] >> 1;\r\nusMS = ucontrol->value.enumerated.item[0] & 1;\r\nusReg = snd_ac97_read(pac97, 0x7a);\r\nsnd_ac97_write_cache(pac97, 0x7a, (usReg & 0x3FFF) + (usSM51 << 14));\r\nusReg = snd_ac97_read(pac97, 0x20);\r\nsnd_ac97_write_cache(pac97, 0x20, (usReg & 0xFEFF) + (usMS << 8));\r\nreturn 0;\r\n}\r\nstatic int patch_vt1617a(struct snd_ac97 * ac97)\r\n{\r\nint err = 0;\r\nint val;\r\nerr = patch_build_controls(ac97, &snd_ac97_controls_vt1617a[0],\r\nARRAY_SIZE(snd_ac97_controls_vt1617a));\r\nval = snd_ac97_read(ac97, 0x5c);\r\nif (!(val & 0x20))\r\nsnd_ac97_write_cache(ac97, 0x5c, 0x20);\r\nac97->ext_id |= AC97_EI_SPDIF;\r\nac97->rates[AC97_RATES_SPDIF] = SNDRV_PCM_RATE_44100 | SNDRV_PCM_RATE_48000;\r\nac97->build_ops = &patch_vt1616_ops;\r\nreturn err;\r\n}\r\nstatic int snd_ac97_vt1618_UAJ_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nreturn ac97_enum_text_info(kcontrol, uinfo,\r\nvt1618_uaj[kcontrol->private_value].items,\r\n4);\r\n}\r\nstatic int snd_ac97_vt1618_UAJ_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nunsigned short datpag, uaj;\r\nstruct snd_ac97 *pac97 = snd_kcontrol_chip(kcontrol);\r\nmutex_lock(&pac97->page_mutex);\r\ndatpag = snd_ac97_read(pac97, AC97_INT_PAGING) & AC97_PAGE_MASK;\r\nsnd_ac97_update_bits(pac97, AC97_INT_PAGING, AC97_PAGE_MASK, 0);\r\nuaj = snd_ac97_read(pac97, 0x60) &\r\nvt1618_uaj[kcontrol->private_value].mask;\r\nsnd_ac97_update_bits(pac97, AC97_INT_PAGING, AC97_PAGE_MASK, datpag);\r\nmutex_unlock(&pac97->page_mutex);\r\nucontrol->value.enumerated.item[0] = uaj >>\r\nvt1618_uaj[kcontrol->private_value].shift;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_vt1618_UAJ_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nreturn ac97_update_bits_page(snd_kcontrol_chip(kcontrol), 0x60,\r\nvt1618_uaj[kcontrol->private_value].mask,\r\nucontrol->value.enumerated.item[0]<<\r\nvt1618_uaj[kcontrol->private_value].shift,\r\n0);\r\n}\r\nstatic int snd_ac97_vt1618_aux_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char *txt_aux[] = {"Aux In", "Back Surr Out"};\r\nreturn ac97_enum_text_info(kcontrol, uinfo, txt_aux, 2);\r\n}\r\nstatic int snd_ac97_vt1618_aux_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.enumerated.item[0] =\r\n(snd_ac97_read(snd_kcontrol_chip(kcontrol), 0x5c) & 0x0008)>>3;\r\nreturn 0;\r\n}\r\nstatic int snd_ac97_vt1618_aux_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nsnd_ac97_update_bits(snd_kcontrol_chip(kcontrol), 0x5c, 0x0008,\r\nucontrol->value.enumerated.item[0] << 3);\r\nreturn snd_ac97_update_bits(snd_kcontrol_chip(kcontrol), 0x76, 0x0008,\r\nucontrol->value.enumerated.item[0] << 3);\r\n}\r\nstatic int patch_vt1618(struct snd_ac97 *ac97)\r\n{\r\nreturn patch_build_controls(ac97, snd_ac97_controls_vt1618,\r\nARRAY_SIZE(snd_ac97_controls_vt1618));\r\n}\r\nstatic void it2646_update_jacks(struct snd_ac97 *ac97)\r\n{\r\nsnd_ac97_update_bits(ac97, 0x76, 1 << 9,\r\nis_shared_surrout(ac97) ? (1<<9) : 0);\r\nsnd_ac97_update_bits(ac97, 0x76, 1 << 10,\r\nis_shared_clfeout(ac97) ? (1<<10) : 0);\r\n}\r\nstatic int patch_it2646_specific(struct snd_ac97 * ac97)\r\n{\r\nint err;\r\nif ((err = patch_build_controls(ac97, snd_ac97_controls_it2646, ARRAY_SIZE(snd_ac97_controls_it2646))) < 0)\r\nreturn err;\r\nif ((err = patch_build_controls(ac97, snd_ac97_spdif_controls_it2646, ARRAY_SIZE(snd_ac97_spdif_controls_it2646))) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int patch_it2646(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_it2646_ops;\r\nsnd_ac97_write_cache(ac97, 0x5E, 0x0808);\r\nsnd_ac97_write_cache(ac97, 0x7A, 0x0808);\r\nreturn 0;\r\n}\r\nstatic int patch_si3036_specific(struct snd_ac97 * ac97)\r\n{\r\nint idx, err;\r\nfor (idx = 0; idx < ARRAY_SIZE(snd_ac97_controls_si3036); idx++)\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ctl_new1(&snd_ac97_controls_si3036[idx], ac97))) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int mpatch_si3036(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_si3036_ops;\r\nsnd_ac97_write_cache(ac97, 0x5c, 0xf210 );\r\nsnd_ac97_write_cache(ac97, 0x68, 0);\r\nreturn 0;\r\n}\r\nstatic int patch_lm4550(struct snd_ac97 *ac97)\r\n{\r\nac97->res_table = lm4550_restbl;\r\nreturn 0;\r\n}\r\nstatic int patch_ucb1400_specific(struct snd_ac97 * ac97)\r\n{\r\nint idx, err;\r\nfor (idx = 0; idx < ARRAY_SIZE(snd_ac97_controls_ucb1400); idx++)\r\nif ((err = snd_ctl_add(ac97->bus->card, snd_ctl_new1(&snd_ac97_controls_ucb1400[idx], ac97))) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int patch_ucb1400(struct snd_ac97 * ac97)\r\n{\r\nac97->build_ops = &patch_ucb1400_ops;\r\nsnd_ac97_write_cache(ac97, 0x6a, 0x0050);\r\nsnd_ac97_write_cache(ac97, 0x6c, 0x0030);\r\nreturn 0;\r\n}

void c2_rnic_interrupt(struct c2_dev *c2dev)\r\n{\r\nunsigned int mq_index;\r\nwhile (c2dev->hints_read != be16_to_cpu(*c2dev->hint_count)) {\r\nmq_index = readl(c2dev->regs + PCI_BAR0_HOST_HINT);\r\nif (mq_index & 0x80000000) {\r\nbreak;\r\n}\r\nc2dev->hints_read++;\r\nhandle_mq(c2dev, mq_index);\r\n}\r\n}\r\nstatic void handle_mq(struct c2_dev *c2dev, u32 mq_index)\r\n{\r\nif (c2dev->qptr_array[mq_index] == NULL) {\r\npr_debug("handle_mq: stray activity for mq_index=%d\n",\r\nmq_index);\r\nreturn;\r\n}\r\nswitch (mq_index) {\r\ncase (0):\r\nwake_up(&c2dev->req_vq_wo);\r\nbreak;\r\ncase (1):\r\nhandle_vq(c2dev, mq_index);\r\nbreak;\r\ncase (2):\r\nhandle_vq(c2dev, 1);\r\nc2_ae_event(c2dev, mq_index);\r\nbreak;\r\ndefault:\r\nc2_cq_event(c2dev, mq_index);\r\nbreak;\r\n}\r\nreturn;\r\n}\r\nstatic void handle_vq(struct c2_dev *c2dev, u32 mq_index)\r\n{\r\nvoid *adapter_msg, *reply_msg;\r\nstruct c2wr_hdr *host_msg;\r\nstruct c2wr_hdr tmp;\r\nstruct c2_mq *reply_vq;\r\nstruct c2_vq_req *req;\r\nstruct iw_cm_event cm_event;\r\nint err;\r\nreply_vq = (struct c2_mq *) c2dev->qptr_array[mq_index];\r\nadapter_msg = c2_mq_consume(reply_vq);\r\nif (adapter_msg == NULL) {\r\nreturn;\r\n}\r\nhost_msg = vq_repbuf_alloc(c2dev);\r\nif (!host_msg) {\r\npr_debug("handle_vq: no repbufs!\n");\r\nhost_msg = &tmp;\r\nmemcpy(host_msg, adapter_msg, sizeof(tmp));\r\nreply_msg = NULL;\r\n} else {\r\nmemcpy(host_msg, adapter_msg, reply_vq->msg_size);\r\nreply_msg = host_msg;\r\n}\r\nc2_mq_free(reply_vq);\r\nreq = (struct c2_vq_req *) (unsigned long) host_msg->context;\r\nif (req == NULL) {\r\nvq_repbuf_free(c2dev, host_msg);\r\npr_debug("handle_vq: UNEXPECTEDLY got NULL req\n");\r\nreturn;\r\n}\r\nif (reply_msg)\r\nerr = c2_errno(reply_msg);\r\nelse\r\nerr = -ENOMEM;\r\nif (!err) switch (req->event) {\r\ncase IW_CM_EVENT_ESTABLISHED:\r\nc2_set_qp_state(req->qp,\r\nC2_QP_STATE_RTS);\r\ncm_event.ird = cm_event.ord = 128;\r\ncase IW_CM_EVENT_CLOSE:\r\ncm_event.event = req->event;\r\ncm_event.status = 0;\r\ncm_event.local_addr = req->cm_id->local_addr;\r\ncm_event.remote_addr = req->cm_id->remote_addr;\r\ncm_event.private_data = NULL;\r\ncm_event.private_data_len = 0;\r\nreq->cm_id->event_handler(req->cm_id, &cm_event);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreq->reply_msg = (u64) (unsigned long) (reply_msg);\r\natomic_set(&req->reply_ready, 1);\r\nwake_up(&req->wait_object);\r\nvq_req_put(c2dev, req);\r\n}

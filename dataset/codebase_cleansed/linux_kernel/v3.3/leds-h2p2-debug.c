void h2p2_dbg_leds_event(led_event_t evt)\r\n{\r\nunsigned long flags;\r\nstatic struct h2p2_dbg_fpga __iomem *fpga;\r\nstatic u16 led_state, hw_led_state;\r\nlocal_irq_save(flags);\r\nif (!(led_state & LED_STATE_ENABLED) && evt != led_start)\r\ngoto done;\r\nswitch (evt) {\r\ncase led_start:\r\nif (!fpga)\r\nfpga = ioremap(H2P2_DBG_FPGA_START,\r\nH2P2_DBG_FPGA_SIZE);\r\nif (fpga) {\r\nled_state |= LED_STATE_ENABLED;\r\n__raw_writew(~0, &fpga->leds);\r\n}\r\nbreak;\r\ncase led_stop:\r\ncase led_halted:\r\nif (! machine_is_omap_perseus2()) {\r\ngpio_set_value(GPIO_TIMER, 0);\r\ngpio_set_value(GPIO_IDLE, 0);\r\n}\r\n__raw_writew(~0, &fpga->leds);\r\nled_state &= ~LED_STATE_ENABLED;\r\nif (evt == led_halted) {\r\niounmap(fpga);\r\nfpga = NULL;\r\n}\r\ngoto done;\r\ncase led_claim:\r\nled_state |= LED_STATE_CLAIMED;\r\nhw_led_state = 0;\r\nbreak;\r\ncase led_release:\r\nled_state &= ~LED_STATE_CLAIMED;\r\nbreak;\r\n#ifdef CONFIG_LEDS_TIMER\r\ncase led_timer:\r\nled_state ^= LED_TIMER_ON;\r\nif (machine_is_omap_perseus2())\r\nhw_led_state ^= H2P2_DBG_FPGA_P2_LED_TIMER;\r\nelse {\r\ngpio_set_value(GPIO_TIMER, led_state & LED_TIMER_ON);\r\ngoto done;\r\n}\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_LEDS_CPU\r\ncase led_idle_start:\r\nif (machine_is_omap_perseus2())\r\nhw_led_state |= H2P2_DBG_FPGA_P2_LED_IDLE;\r\nelse {\r\ngpio_set_value(GPIO_IDLE, 1);\r\ngoto done;\r\n}\r\nbreak;\r\ncase led_idle_end:\r\nif (machine_is_omap_perseus2())\r\nhw_led_state &= ~H2P2_DBG_FPGA_P2_LED_IDLE;\r\nelse {\r\ngpio_set_value(GPIO_IDLE, 0);\r\ngoto done;\r\n}\r\nbreak;\r\n#endif\r\ncase led_green_on:\r\nhw_led_state |= H2P2_DBG_FPGA_LED_GREEN;\r\nbreak;\r\ncase led_green_off:\r\nhw_led_state &= ~H2P2_DBG_FPGA_LED_GREEN;\r\nbreak;\r\ncase led_amber_on:\r\nhw_led_state |= H2P2_DBG_FPGA_LED_AMBER;\r\nbreak;\r\ncase led_amber_off:\r\nhw_led_state &= ~H2P2_DBG_FPGA_LED_AMBER;\r\nbreak;\r\ncase led_red_on:\r\nhw_led_state |= H2P2_DBG_FPGA_LED_RED;\r\nbreak;\r\ncase led_red_off:\r\nhw_led_state &= ~H2P2_DBG_FPGA_LED_RED;\r\nbreak;\r\ncase led_blue_on:\r\nhw_led_state |= H2P2_DBG_FPGA_LED_BLUE;\r\nbreak;\r\ncase led_blue_off:\r\nhw_led_state &= ~H2P2_DBG_FPGA_LED_BLUE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (led_state & LED_STATE_ENABLED)\r\n__raw_writew(~hw_led_state, &fpga->leds);\r\ndone:\r\nlocal_irq_restore(flags);\r\n}

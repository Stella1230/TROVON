void *mwifiex_process_sta_txpd(struct mwifiex_private *priv,\r\nstruct sk_buff *skb)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nstruct txpd *local_tx_pd;\r\nstruct mwifiex_txinfo *tx_info = MWIFIEX_SKB_TXCB(skb);\r\nu8 pad;\r\nif (!skb->len) {\r\ndev_err(adapter->dev, "Tx: bad packet length: %d\n",\r\nskb->len);\r\ntx_info->status_code = -1;\r\nreturn skb->data;\r\n}\r\npad = (4 - (((void *)skb->data - NULL) & 0x3)) % 4;\r\nBUG_ON(skb_headroom(skb) < (sizeof(*local_tx_pd) + INTF_HEADER_LEN\r\n+ pad));\r\nskb_push(skb, sizeof(*local_tx_pd) + pad);\r\nlocal_tx_pd = (struct txpd *) skb->data;\r\nmemset(local_tx_pd, 0, sizeof(struct txpd));\r\nlocal_tx_pd->bss_num = priv->bss_num;\r\nlocal_tx_pd->bss_type = priv->bss_type;\r\nlocal_tx_pd->tx_pkt_length = cpu_to_le16((u16) (skb->len -\r\n(sizeof(struct txpd) + pad)));\r\nlocal_tx_pd->priority = (u8) skb->priority;\r\nlocal_tx_pd->pkt_delay_2ms =\r\nmwifiex_wmm_compute_drv_pkt_delay(priv, skb);\r\nif (local_tx_pd->priority <\r\nARRAY_SIZE(priv->wmm.user_pri_pkt_tx_ctrl))\r\nlocal_tx_pd->tx_control =\r\ncpu_to_le32(priv->wmm.user_pri_pkt_tx_ctrl[local_tx_pd->\r\npriority]);\r\nif (adapter->pps_uapsd_mode) {\r\nif (mwifiex_check_last_packet_indication(priv)) {\r\nadapter->tx_lock_flag = true;\r\nlocal_tx_pd->flags =\r\nMWIFIEX_TxPD_POWER_MGMT_LAST_PACKET;\r\n}\r\n}\r\nlocal_tx_pd->tx_pkt_offset = cpu_to_le16(sizeof(struct txpd) + pad);\r\nskb_push(skb, INTF_HEADER_LEN);\r\nif (!local_tx_pd->tx_control)\r\nlocal_tx_pd->tx_control = cpu_to_le32(priv->pkt_tx_ctrl);\r\nreturn skb->data;\r\n}\r\nint mwifiex_send_null_packet(struct mwifiex_private *priv, u8 flags)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nstruct txpd *local_tx_pd;\r\n#define NULL_PACKET_HDR 64\r\nu32 data_len = NULL_PACKET_HDR;\r\nstruct sk_buff *skb;\r\nint ret;\r\nstruct mwifiex_txinfo *tx_info = NULL;\r\nif (adapter->surprise_removed)\r\nreturn -1;\r\nif (!priv->media_connected)\r\nreturn -1;\r\nif (adapter->data_sent)\r\nreturn -1;\r\nskb = dev_alloc_skb(data_len);\r\nif (!skb)\r\nreturn -1;\r\ntx_info = MWIFIEX_SKB_TXCB(skb);\r\ntx_info->bss_index = priv->bss_index;\r\nskb_reserve(skb, sizeof(struct txpd) + INTF_HEADER_LEN);\r\nskb_push(skb, sizeof(struct txpd));\r\nlocal_tx_pd = (struct txpd *) skb->data;\r\nlocal_tx_pd->tx_control = cpu_to_le32(priv->pkt_tx_ctrl);\r\nlocal_tx_pd->flags = flags;\r\nlocal_tx_pd->priority = WMM_HIGHEST_PRIORITY;\r\nlocal_tx_pd->tx_pkt_offset = cpu_to_le16(sizeof(struct txpd));\r\nlocal_tx_pd->bss_num = priv->bss_num;\r\nlocal_tx_pd->bss_type = priv->bss_type;\r\nskb_push(skb, INTF_HEADER_LEN);\r\nret = adapter->if_ops.host_to_card(adapter, MWIFIEX_TYPE_DATA,\r\nskb, NULL);\r\nswitch (ret) {\r\ncase -EBUSY:\r\nadapter->data_sent = true;\r\ncase -1:\r\ndev_kfree_skb_any(skb);\r\ndev_err(adapter->dev, "%s: host_to_card failed: ret=%d\n",\r\n__func__, ret);\r\nadapter->dbg.num_tx_host_to_card_failure++;\r\nbreak;\r\ncase 0:\r\ndev_kfree_skb_any(skb);\r\ndev_dbg(adapter->dev, "data: %s: host_to_card succeeded\n",\r\n__func__);\r\nadapter->tx_lock_flag = true;\r\nbreak;\r\ncase -EINPROGRESS:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nu8\r\nmwifiex_check_last_packet_indication(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nu8 ret = false;\r\nif (!adapter->sleep_period.period)\r\nreturn ret;\r\nif (mwifiex_wmm_lists_empty(adapter))\r\nret = true;\r\nif (ret && !adapter->cmd_sent && !adapter->curr_cmd\r\n&& !is_command_pending(adapter)) {\r\nadapter->delay_null_pkt = false;\r\nret = true;\r\n} else {\r\nret = false;\r\nadapter->delay_null_pkt = true;\r\n}\r\nreturn ret;\r\n}

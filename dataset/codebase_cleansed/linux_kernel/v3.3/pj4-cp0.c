static int iwmmxt_do(struct notifier_block *self, unsigned long cmd, void *t)\r\n{\r\nstruct thread_info *thread = t;\r\nswitch (cmd) {\r\ncase THREAD_NOTIFY_FLUSH:\r\ncase THREAD_NOTIFY_EXIT:\r\niwmmxt_task_release(thread);\r\nbreak;\r\ncase THREAD_NOTIFY_SWITCH:\r\niwmmxt_task_switch(thread);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic u32 __init pj4_cp_access_read(void)\r\n{\r\nu32 value;\r\n__asm__ __volatile__ (\r\n"mrc p15, 0, %0, c1, c0, 2\n\t"\r\n: "=r" (value));\r\nreturn value;\r\n}\r\nstatic void __init pj4_cp_access_write(u32 value)\r\n{\r\nu32 temp;\r\n__asm__ __volatile__ (\r\n"mcr p15, 0, %1, c1, c0, 2\n\t"\r\n"mrc p15, 0, %0, c1, c0, 2\n\t"\r\n"mov %0, %0\n\t"\r\n"sub pc, pc, #4\n\t"\r\n: "=r" (temp) : "r" (value));\r\n}\r\nstatic int __init pj4_cp0_init(void)\r\n{\r\nu32 cp_access;\r\ncp_access = pj4_cp_access_read() & ~0xf;\r\npj4_cp_access_write(cp_access);\r\nprintk(KERN_INFO "PJ4 iWMMXt coprocessor enabled.\n");\r\nelf_hwcap |= HWCAP_IWMMXT;\r\nthread_register_notifier(&iwmmxt_notifier_block);\r\nreturn 0;\r\n}

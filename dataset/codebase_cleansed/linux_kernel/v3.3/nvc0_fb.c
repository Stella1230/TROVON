static inline void\r\nnvc0_mfb_subp_isr(struct drm_device *dev, int unit, int subp)\r\n{\r\nu32 subp_base = 0x141000 + (unit * 0x2000) + (subp * 0x400);\r\nu32 stat = nv_rd32(dev, subp_base + 0x020);\r\nif (stat) {\r\nNV_INFO(dev, "PMFB%d_SUBP%d: 0x%08x\n", unit, subp, stat);\r\nnv_wr32(dev, subp_base + 0x020, stat);\r\n}\r\n}\r\nstatic void\r\nnvc0_mfb_isr(struct drm_device *dev)\r\n{\r\nu32 units = nv_rd32(dev, 0x00017c);\r\nwhile (units) {\r\nu32 subp, unit = ffs(units) - 1;\r\nfor (subp = 0; subp < 2; subp++)\r\nnvc0_mfb_subp_isr(dev, unit, subp);\r\nunits &= ~(1 << unit);\r\n}\r\n}\r\nstatic void\r\nnvc0_fb_destroy(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fb_engine *pfb = &dev_priv->engine.fb;\r\nstruct nvc0_fb_priv *priv = pfb->priv;\r\nnouveau_irq_unregister(dev, 25);\r\nif (priv->r100c10_page) {\r\npci_unmap_page(dev->pdev, priv->r100c10, PAGE_SIZE,\r\nPCI_DMA_BIDIRECTIONAL);\r\n__free_page(priv->r100c10_page);\r\n}\r\nkfree(priv);\r\npfb->priv = NULL;\r\n}\r\nstatic int\r\nnvc0_fb_create(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fb_engine *pfb = &dev_priv->engine.fb;\r\nstruct nvc0_fb_priv *priv;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npfb->priv = priv;\r\npriv->r100c10_page = alloc_page(GFP_KERNEL | __GFP_ZERO);\r\nif (!priv->r100c10_page) {\r\nnvc0_fb_destroy(dev);\r\nreturn -ENOMEM;\r\n}\r\npriv->r100c10 = pci_map_page(dev->pdev, priv->r100c10_page, 0,\r\nPAGE_SIZE, PCI_DMA_BIDIRECTIONAL);\r\nif (pci_dma_mapping_error(dev->pdev, priv->r100c10)) {\r\nnvc0_fb_destroy(dev);\r\nreturn -EFAULT;\r\n}\r\nnouveau_irq_register(dev, 25, nvc0_mfb_isr);\r\nreturn 0;\r\n}\r\nint\r\nnvc0_fb_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nvc0_fb_priv *priv;\r\nint ret;\r\nif (!dev_priv->engine.fb.priv) {\r\nret = nvc0_fb_create(dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\npriv = dev_priv->engine.fb.priv;\r\nnv_wr32(dev, 0x100c10, priv->r100c10 >> 8);\r\nreturn 0;\r\n}\r\nvoid\r\nnvc0_fb_takedown(struct drm_device *dev)\r\n{\r\nnvc0_fb_destroy(dev);\r\n}

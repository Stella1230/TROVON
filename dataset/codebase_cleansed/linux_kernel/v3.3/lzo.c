static int lzo_init(struct crypto_tfm *tfm)\r\n{\r\nstruct lzo_ctx *ctx = crypto_tfm_ctx(tfm);\r\nctx->lzo_comp_mem = vmalloc(LZO1X_MEM_COMPRESS);\r\nif (!ctx->lzo_comp_mem)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void lzo_exit(struct crypto_tfm *tfm)\r\n{\r\nstruct lzo_ctx *ctx = crypto_tfm_ctx(tfm);\r\nvfree(ctx->lzo_comp_mem);\r\n}\r\nstatic int lzo_compress(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nstruct lzo_ctx *ctx = crypto_tfm_ctx(tfm);\r\nsize_t tmp_len = *dlen;\r\nint err;\r\nerr = lzo1x_1_compress(src, slen, dst, &tmp_len, ctx->lzo_comp_mem);\r\nif (err != LZO_E_OK)\r\nreturn -EINVAL;\r\n*dlen = tmp_len;\r\nreturn 0;\r\n}\r\nstatic int lzo_decompress(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nint err;\r\nsize_t tmp_len = *dlen;\r\nerr = lzo1x_decompress_safe(src, slen, dst, &tmp_len);\r\nif (err != LZO_E_OK)\r\nreturn -EINVAL;\r\n*dlen = tmp_len;\r\nreturn 0;\r\n}\r\nstatic int __init lzo_mod_init(void)\r\n{\r\nreturn crypto_register_alg(&alg);\r\n}\r\nstatic void __exit lzo_mod_fini(void)\r\n{\r\ncrypto_unregister_alg(&alg);\r\n}

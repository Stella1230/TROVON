static int gfs_init(void)\r\n{\r\nENTER();\r\nreturn functionfs_init();\r\n}\r\nstatic void gfs_exit(void)\r\n{\r\nENTER();\r\nif (test_and_clear_bit(0, &gfs_registered))\r\nusb_composite_unregister(&gfs_driver);\r\nfunctionfs_cleanup();\r\n}\r\nstatic int functionfs_ready_callback(struct ffs_data *ffs)\r\n{\r\nint ret;\r\nENTER();\r\nif (WARN_ON(test_and_set_bit(0, &gfs_registered)))\r\nreturn -EBUSY;\r\ngfs_ffs_data = ffs;\r\nret = usb_composite_probe(&gfs_driver, gfs_bind);\r\nif (unlikely(ret < 0))\r\nclear_bit(0, &gfs_registered);\r\nreturn ret;\r\n}\r\nstatic void functionfs_closed_callback(struct ffs_data *ffs)\r\n{\r\nENTER();\r\nif (test_and_clear_bit(0, &gfs_registered))\r\nusb_composite_unregister(&gfs_driver);\r\n}\r\nstatic int functionfs_check_dev_callback(const char *dev_name)\r\n{\r\nreturn 0;\r\n}\r\nstatic int gfs_bind(struct usb_composite_dev *cdev)\r\n{\r\nint ret, i;\r\nENTER();\r\nif (WARN_ON(!gfs_ffs_data))\r\nreturn -ENODEV;\r\nret = gether_setup(cdev->gadget, gfs_hostaddr);\r\nif (unlikely(ret < 0))\r\ngoto error_quick;\r\nret = usb_string_ids_tab(cdev, gfs_strings);\r\nif (unlikely(ret < 0))\r\ngoto error;\r\nret = functionfs_bind(gfs_ffs_data, cdev);\r\nif (unlikely(ret < 0))\r\ngoto error;\r\nfor (i = 0; i < ARRAY_SIZE(gfs_configurations); ++i) {\r\nstruct gfs_configuration *c = gfs_configurations + i;\r\nc->c.label = gfs_strings[i].s;\r\nc->c.iConfiguration = gfs_strings[i].id;\r\nc->c.bConfigurationValue = 1 + i;\r\nc->c.bmAttributes = USB_CONFIG_ATT_SELFPOWER;\r\nret = usb_add_config(cdev, &c->c, gfs_do_config);\r\nif (unlikely(ret < 0))\r\ngoto error_unbind;\r\n}\r\nreturn 0;\r\nerror_unbind:\r\nfunctionfs_unbind(gfs_ffs_data);\r\nerror:\r\ngether_cleanup();\r\nerror_quick:\r\ngfs_ffs_data = NULL;\r\nreturn ret;\r\n}\r\nstatic int gfs_unbind(struct usb_composite_dev *cdev)\r\n{\r\nENTER();\r\nif (gfs_ffs_data) {\r\ngether_cleanup();\r\nfunctionfs_unbind(gfs_ffs_data);\r\ngfs_ffs_data = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gfs_do_config(struct usb_configuration *c)\r\n{\r\nstruct gfs_configuration *gc =\r\ncontainer_of(c, struct gfs_configuration, c);\r\nint ret;\r\nif (WARN_ON(!gfs_ffs_data))\r\nreturn -ENODEV;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = gfs_otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nif (gc->eth) {\r\nret = gc->eth(c, gfs_hostaddr);\r\nif (unlikely(ret < 0))\r\nreturn ret;\r\n}\r\nret = functionfs_bind_config(c->cdev, c, gfs_ffs_data);\r\nif (unlikely(ret < 0))\r\nreturn ret;\r\nif (c->next_interface_id < ARRAY_SIZE(c->interface))\r\nc->interface[c->next_interface_id] = NULL;\r\nreturn 0;\r\n}\r\nstatic int eth_bind_config(struct usb_configuration *c, u8 ethaddr[ETH_ALEN])\r\n{\r\nreturn can_support_ecm(c->cdev->gadget)\r\n? ecm_bind_config(c, ethaddr)\r\n: geth_bind_config(c, ethaddr);\r\n}

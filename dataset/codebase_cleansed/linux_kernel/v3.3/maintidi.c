diva_strace_library_interface_t* DivaSTraceLibraryCreateInstance (int Adapter,\r\nconst diva_trace_library_user_interface_t* user_proc,\r\nbyte* pmem) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)pmem;\r\nint i;\r\nif (!pLib) {\r\nreturn NULL;\r\n}\r\npmem += sizeof(*pLib);\r\nmemset(pLib, 0x00, sizeof(*pLib));\r\npLib->Adapter = Adapter;\r\npLib->instance.hLib = pLib;\r\npLib->instance.DivaSTraceLibraryStart = DivaSTraceLibraryStart;\r\npLib->instance.DivaSTraceLibraryStop = DivaSTraceLibraryStop;\r\npLib->instance.DivaSTraceLibraryFinit = SuperTraceLibraryFinit;\r\npLib->instance.DivaSTraceMessageInput = SuperTraceMessageInput;\r\npLib->instance.DivaSTraceGetHandle = SuperTraceGetHandle;\r\npLib->instance.DivaSTraceSetAudioTap = SuperTraceSetAudioTap;\r\npLib->instance.DivaSTraceSetBChannel = SuperTraceSetBChannel;\r\npLib->instance.DivaSTraceSetDChannel = SuperTraceSetDChannel;\r\npLib->instance.DivaSTraceSetInfo = SuperTraceSetInfo;\r\npLib->instance.DivaSTraceGetOutgoingCallStatistics = \\r\nSuperTraceGetOutgoingCallStatistics;\r\npLib->instance.DivaSTraceGetIncomingCallStatistics = \\r\nSuperTraceGetIncomingCallStatistics;\r\npLib->instance.DivaSTraceGetModemStatistics = \\r\nSuperTraceGetModemStatistics;\r\npLib->instance.DivaSTraceGetFaxStatistics = \\r\nSuperTraceGetFaxStatistics;\r\npLib->instance.DivaSTraceGetBLayer1Statistics = \\r\nSuperTraceGetBLayer1Statistics;\r\npLib->instance.DivaSTraceGetBLayer2Statistics = \\r\nSuperTraceGetBLayer2Statistics;\r\npLib->instance.DivaSTraceGetDLayer1Statistics = \\r\nSuperTraceGetDLayer1Statistics;\r\npLib->instance.DivaSTraceGetDLayer2Statistics = \\r\nSuperTraceGetDLayer2Statistics;\r\npLib->instance.DivaSTraceClearCall = SuperTraceClearCall;\r\nif (user_proc) {\r\npLib->user_proc_table.user_context = user_proc->user_context;\r\npLib->user_proc_table.notify_proc = user_proc->notify_proc;\r\npLib->user_proc_table.trace_proc = user_proc->trace_proc;\r\npLib->user_proc_table.error_notify_proc = user_proc->error_notify_proc;\r\n}\r\nif (!(pLib->hAdapter = SuperTraceOpenAdapter (Adapter))) {\r\ndiva_mnt_internal_dprintf (0, DLI_ERR, "Can not open XDI adapter");\r\nreturn NULL;\r\n}\r\npLib->Channels = SuperTraceGetNumberOfChannels (pLib->hAdapter);\r\npLib->parse_entries = (MODEM_PARSE_ENTRIES + FAX_PARSE_ENTRIES + \\r\nSTAT_PARSE_ENTRIES + \\r\nLINE_PARSE_ENTRIES + 1) * pLib->Channels;\r\npLib->parse_table = (diva_strace_path2action_t*)pmem;\r\nfor (i = 0; i < 30; i++) {\r\npLib->lines[i].pInterface = &pLib->Interface;\r\npLib->lines[i].pInterfaceStat = &pLib->InterfaceStat;\r\n}\r\npLib->e.R = &pLib->RData;\r\npLib->req_busy = 1;\r\npLib->rc_ok = ASSIGN_OK;\r\ndiva_create_parse_table (pLib);\r\nreturn ((diva_strace_library_interface_t*)pLib);\r\n}\r\nstatic int DivaSTraceLibraryStart (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nreturn (SuperTraceASSIGN (pLib->hAdapter, pLib->buffer));\r\n}\r\nstatic int DivaSTraceLibraryStop (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nif (!pLib->e.Id) {\r\nreturn (1);\r\n}\r\nswitch (pLib->removal_state) {\r\ncase 0:\r\npLib->removal_state = 1;\r\nScheduleNextTraceRequest(pLib);\r\nbreak;\r\ncase 3:\r\nreturn (1);\r\n}\r\nreturn (0);\r\n}\r\nstatic int SuperTraceLibraryFinit (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nif (pLib) {\r\nif (pLib->hAdapter) {\r\nSuperTraceCloseAdapter (pLib->hAdapter);\r\n}\r\nreturn (0);\r\n}\r\nreturn (-1);\r\n}\r\nstatic void* SuperTraceGetHandle (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nreturn (&pLib->e);\r\n}\r\nstatic int SuperTraceMessageInput (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nint ret = 0;\r\nbyte Rc, Ind;\r\nif (pLib->e.complete == 255) {\r\npLib->req_busy = 0;\r\nRc = pLib->e.Rc;\r\npLib->e.Rc = 0;\r\nif (pLib->removal_state == 2) {\r\npLib->removal_state = 3;\r\nreturn (0);\r\n}\r\nif (Rc != pLib->rc_ok) {\r\nint ignore = 0;\r\nif (pLib->general_b_ch_event == 1) {\r\npLib->general_b_ch_event = 2;\r\nignore = 1;\r\n} else if (pLib->general_fax_event == 1) {\r\npLib->general_fax_event = 2;\r\nignore = 1;\r\n} else if (pLib->general_mdm_event == 1) {\r\npLib->general_mdm_event = 2;\r\nignore = 1;\r\n} else if ((pLib->ChannelsTraceActive < pLib->Channels) && pLib->ChannelsTraceActive) {\r\npLib->ChannelsTraceActive = pLib->Channels;\r\nignore = 1;\r\n} else if (pLib->ModemTraceActive < pLib->Channels) {\r\npLib->ModemTraceActive = pLib->Channels;\r\nignore = 1;\r\n} else if (pLib->FaxTraceActive < pLib->Channels) {\r\npLib->FaxTraceActive = pLib->Channels;\r\nignore = 1;\r\n} else if (pLib->audio_trace_init == 2) {\r\nignore = 1;\r\npLib->audio_trace_init = 1;\r\n} else if (pLib->eye_pattern_pending) {\r\npLib->eye_pattern_pending = 0;\r\nignore = 1;\r\n} else if (pLib->audio_tap_pending) {\r\npLib->audio_tap_pending = 0;\r\nignore = 1;\r\n}\r\nif (!ignore) {\r\nreturn (-1);\r\n}\r\n} else {\r\nif (pLib->general_b_ch_event == 1) {\r\npLib->ChannelsTraceActive = pLib->Channels;\r\npLib->general_b_ch_event = 2;\r\n} else if (pLib->general_fax_event == 1) {\r\npLib->general_fax_event = 2;\r\npLib->FaxTraceActive = pLib->Channels;\r\n} else if (pLib->general_mdm_event == 1) {\r\npLib->general_mdm_event = 2;\r\npLib->ModemTraceActive = pLib->Channels;\r\n}\r\n}\r\nif (pLib->audio_trace_init == 2) {\r\npLib->audio_trace_init = 1;\r\n}\r\npLib->rc_ok = 0xff;\r\nif ((ret = ScheduleNextTraceRequest(pLib))) {\r\nreturn (-1);\r\n}\r\n} else {\r\nInd = pLib->e.Ind;\r\npLib->e.Ind = 0;\r\nif (pLib->removal_state) {\r\npLib->e.RNum = 0;\r\npLib->e.RNR = 2;\r\n} else if (pLib->req_busy) {\r\npLib->e.RNum = 0;\r\npLib->e.RNR = 1;\r\n} else {\r\nif (pLib->e.complete != 0x02) {\r\npLib->e.RNum = 1;\r\npLib->e.R->P = (byte*)&pLib->buffer[0];\r\npLib->e.R->PLength = (word)(sizeof(pLib->buffer) - 1);\r\n} else {\r\nbyte* p = (byte*)&pLib->buffer[0];\r\npLib->buffer[pLib->e.R->PLength] = 0;\r\nswitch (Ind) {\r\ncase MAN_COMBI_IND: {\r\nint total_length = pLib->e.R->PLength;\r\nword this_ind_length;\r\nwhile (total_length > 3 && *p) {\r\nInd = *p++;\r\nthis_ind_length = (word)p[0] | ((word)p[1] << 8);\r\np += 2;\r\nswitch (Ind) {\r\ncase MAN_INFO_IND:\r\nif (process_idi_info (pLib, (diva_man_var_header_t*)p)) {\r\nreturn (-1);\r\n}\r\nbreak;\r\ncase MAN_EVENT_IND:\r\nif (process_idi_event (pLib, (diva_man_var_header_t*)p)) {\r\nreturn (-1);\r\n}\r\nbreak;\r\ncase MAN_TRACE_IND:\r\nif (pLib->trace_on == 1) {\r\npLib->trace_on++;\r\n} else {\r\nif (pLib->user_proc_table.trace_proc) {\r\n(*(pLib->user_proc_table.trace_proc))(pLib->user_proc_table.user_context,\r\n&pLib->instance, pLib->Adapter,\r\np, this_ind_length);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\ndiva_mnt_internal_dprintf (0, DLI_ERR, "Unknown IDI Ind (DMA mode): %02x", Ind);\r\n}\r\np += (this_ind_length+1);\r\ntotal_length -= (4 + this_ind_length);\r\n}\r\n} break;\r\ncase MAN_INFO_IND:\r\nif (process_idi_info (pLib, (diva_man_var_header_t*)p)) {\r\nreturn (-1);\r\n}\r\nbreak;\r\ncase MAN_EVENT_IND:\r\nif (process_idi_event (pLib, (diva_man_var_header_t*)p)) {\r\nreturn (-1);\r\n}\r\nbreak;\r\ncase MAN_TRACE_IND:\r\nif (pLib->trace_on == 1) {\r\npLib->trace_on++;\r\n} else {\r\nif (pLib->user_proc_table.trace_proc) {\r\n(*(pLib->user_proc_table.trace_proc))(pLib->user_proc_table.user_context,\r\n&pLib->instance, pLib->Adapter,\r\np, pLib->e.R->PLength);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\ndiva_mnt_internal_dprintf (0, DLI_ERR, "Unknown IDI Ind: %02x", Ind);\r\n}\r\n}\r\n}\r\n}\r\nif ((ret = ScheduleNextTraceRequest(pLib))) {\r\nreturn (-1);\r\n}\r\nreturn (ret);\r\n}\r\nstatic int ScheduleNextTraceRequest (diva_strace_context_t* pLib) {\r\nchar name[64];\r\nint ret = 0;\r\nint i;\r\nif (pLib->req_busy) {\r\nreturn (0);\r\n}\r\nif (pLib->removal_state == 1) {\r\nif (SuperTraceREMOVE (pLib->hAdapter)) {\r\npLib->removal_state = 3;\r\n} else {\r\npLib->req_busy = 1;\r\npLib->removal_state = 2;\r\n}\r\nreturn (0);\r\n}\r\nif (pLib->removal_state) {\r\nreturn (0);\r\n}\r\nif (!pLib->general_b_ch_event) {\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, "State\\B Event", pLib->buffer))) {\r\nreturn (-1);\r\n}\r\npLib->general_b_ch_event = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->general_fax_event) {\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, "State\\FAX Event", pLib->buffer))) {\r\nreturn (-1);\r\n}\r\npLib->general_fax_event = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->general_mdm_event) {\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, "State\\Modem Event", pLib->buffer))) {\r\nreturn (-1);\r\n}\r\npLib->general_mdm_event = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->ChannelsTraceActive < pLib->Channels) {\r\npLib->ChannelsTraceActive++;\r\nsprintf (name, "State\\B%d\\Line", pLib->ChannelsTraceActive);\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, name, pLib->buffer))) {\r\npLib->ChannelsTraceActive--;\r\nreturn (-1);\r\n}\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->ModemTraceActive < pLib->Channels) {\r\npLib->ModemTraceActive++;\r\nsprintf (name, "State\\B%d\\Modem\\Event", pLib->ModemTraceActive);\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, name, pLib->buffer))) {\r\npLib->ModemTraceActive--;\r\nreturn (-1);\r\n}\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->FaxTraceActive < pLib->Channels) {\r\npLib->FaxTraceActive++;\r\nsprintf (name, "State\\B%d\\FAX\\Event", pLib->FaxTraceActive);\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, name, pLib->buffer))) {\r\npLib->FaxTraceActive--;\r\nreturn (-1);\r\n}\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->trace_mask_init) {\r\nword tmp = 0x0000;\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\Event Enable",\r\n&tmp,\r\n0x87,\r\nsizeof(tmp))) {\r\nreturn (-1);\r\n}\r\npLib->trace_mask_init = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->audio_trace_init) {\r\ndword tmp = 0x00000000;\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\AudioCh# Enable",\r\n&tmp,\r\n0x87,\r\nsizeof(tmp))) {\r\nreturn (-1);\r\n}\r\npLib->audio_trace_init = 2;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->bchannel_init) {\r\ndword tmp = 0x00000000;\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\B-Ch# Enable",\r\n&tmp,\r\n0x87,\r\nsizeof(tmp))) {\r\nreturn (-1);\r\n}\r\npLib->bchannel_init = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->trace_length_init) {\r\nword tmp = 30;\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\Max Log Length",\r\n&tmp,\r\n0x82,\r\nsizeof(tmp))) {\r\nreturn (-1);\r\n}\r\npLib->trace_length_init = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->trace_on) {\r\nif (SuperTraceTraceOnRequest (pLib->hAdapter,\r\n"Trace\\Log Buffer",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->trace_on = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->trace_event_mask != pLib->current_trace_event_mask) {\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\Event Enable",\r\n&pLib->trace_event_mask,\r\n0x87,\r\nsizeof(pLib->trace_event_mask))) {\r\nreturn (-1);\r\n}\r\npLib->current_trace_event_mask = pLib->trace_event_mask;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif ((pLib->audio_tap_pending >= 0) && (pLib->audio_tap_mask != pLib->current_audio_tap_mask)) {\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\AudioCh# Enable",\r\n&pLib->audio_tap_mask,\r\n0x87,\r\nsizeof(pLib->audio_tap_mask))) {\r\nreturn (-1);\r\n}\r\npLib->current_audio_tap_mask = pLib->audio_tap_mask;\r\npLib->audio_tap_pending = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif ((pLib->eye_pattern_pending >= 0) && (pLib->audio_tap_mask != pLib->current_eye_pattern_mask)) {\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\EyeCh# Enable",\r\n&pLib->audio_tap_mask,\r\n0x87,\r\nsizeof(pLib->audio_tap_mask))) {\r\nreturn (-1);\r\n}\r\npLib->current_eye_pattern_mask = pLib->audio_tap_mask;\r\npLib->eye_pattern_pending = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->bchannel_trace_mask != pLib->current_bchannel_trace_mask) {\r\nif (SuperTraceWriteVar (pLib->hAdapter,\r\npLib->buffer,\r\n"Trace\\B-Ch# Enable",\r\n&pLib->bchannel_trace_mask,\r\n0x87,\r\nsizeof(pLib->bchannel_trace_mask))) {\r\nreturn (-1);\r\n}\r\npLib->current_bchannel_trace_mask = pLib->bchannel_trace_mask;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->trace_events_down) {\r\nif (SuperTraceTraceOnRequest (pLib->hAdapter,\r\n"Events Down",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->trace_events_down = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->l1_trace) {\r\nif (SuperTraceTraceOnRequest (pLib->hAdapter,\r\n"State\\Layer1",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->l1_trace = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->l2_trace) {\r\nif (SuperTraceTraceOnRequest (pLib->hAdapter,\r\n"State\\Layer2 No1",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->l2_trace = 1;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nfor (i = 0; i < 30; i++) {\r\nif (pLib->pending_line_status & (1L << i)) {\r\nsprintf (name, "State\\B%d", i+1);\r\nif (SuperTraceReadRequest (pLib->hAdapter, name, pLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->pending_line_status &= ~(1L << i);\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->pending_modem_status & (1L << i)) {\r\nsprintf (name, "State\\B%d\\Modem", i+1);\r\nif (SuperTraceReadRequest (pLib->hAdapter, name, pLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->pending_modem_status &= ~(1L << i);\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->pending_fax_status & (1L << i)) {\r\nsprintf (name, "State\\B%d\\FAX", i+1);\r\nif (SuperTraceReadRequest (pLib->hAdapter, name, pLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->pending_fax_status &= ~(1L << i);\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->clear_call_command & (1L << i)) {\r\nsprintf (name, "State\\B%d\\Clear Call", i+1);\r\nif (SuperTraceExecuteRequest (pLib->hAdapter, name, pLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->clear_call_command &= ~(1L << i);\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\n}\r\nif (pLib->outgoing_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\Outgoing Calls",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->outgoing_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->incoming_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\Incoming Calls",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->incoming_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->modem_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\Modem",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->modem_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->fax_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\FAX",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->fax_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->b1_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\B-Layer1",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->b1_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->b2_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\B-Layer2",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->b2_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->d1_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\D-Layer1",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->d1_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (pLib->d2_ifc_stats) {\r\nif (SuperTraceReadRequest (pLib->hAdapter,\r\n"Statistics\\D-Layer2",\r\npLib->buffer)) {\r\nreturn (-1);\r\n}\r\npLib->d2_ifc_stats = 0;\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->IncomingCallsCallsActive) {\r\npLib->IncomingCallsCallsActive = 1;\r\nsprintf (name, "%s", "Statistics\\Incoming Calls\\Calls");\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, name, pLib->buffer))) {\r\npLib->IncomingCallsCallsActive = 0;\r\nreturn (-1);\r\n}\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->IncomingCallsConnectedActive) {\r\npLib->IncomingCallsConnectedActive = 1;\r\nsprintf (name, "%s", "Statistics\\Incoming Calls\\Connected");\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, name, pLib->buffer))) {\r\npLib->IncomingCallsConnectedActive = 0;\r\nreturn (-1);\r\n}\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->OutgoingCallsCallsActive) {\r\npLib->OutgoingCallsCallsActive = 1;\r\nsprintf (name, "%s", "Statistics\\Outgoing Calls\\Calls");\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, name, pLib->buffer))) {\r\npLib->OutgoingCallsCallsActive = 0;\r\nreturn (-1);\r\n}\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nif (!pLib->OutgoingCallsConnectedActive) {\r\npLib->OutgoingCallsConnectedActive = 1;\r\nsprintf (name, "%s", "Statistics\\Outgoing Calls\\Connected");\r\nif ((ret = SuperTraceTraceOnRequest(pLib->hAdapter, name, pLib->buffer))) {\r\npLib->OutgoingCallsConnectedActive = 0;\r\nreturn (-1);\r\n}\r\npLib->req_busy = 1;\r\nreturn (0);\r\n}\r\nreturn (0);\r\n}\r\nstatic int process_idi_event (diva_strace_context_t* pLib,\r\ndiva_man_var_header_t* pVar) {\r\nconst char* path = (char*)&pVar->path_length+1;\r\nchar name[64];\r\nint i;\r\nif (!strncmp("State\\B Event", path, pVar->path_length)) {\r\ndword ch_id;\r\nif (!diva_trace_read_variable (pVar, &ch_id)) {\r\nif (!pLib->line_init_event && !pLib->pending_line_status) {\r\nfor (i = 1; i <= pLib->Channels; i++) {\r\ndiva_line_event(pLib, i);\r\n}\r\nreturn (0);\r\n} else if (ch_id && ch_id <= pLib->Channels) {\r\nreturn (diva_line_event(pLib, (int)ch_id));\r\n}\r\nreturn (0);\r\n}\r\nreturn (-1);\r\n}\r\nif (!strncmp("State\\FAX Event", path, pVar->path_length)) {\r\ndword ch_id;\r\nif (!diva_trace_read_variable (pVar, &ch_id)) {\r\nif (!pLib->pending_fax_status && !pLib->fax_init_event) {\r\nfor (i = 1; i <= pLib->Channels; i++) {\r\ndiva_fax_event(pLib, i);\r\n}\r\nreturn (0);\r\n} else if (ch_id && ch_id <= pLib->Channels) {\r\nreturn (diva_fax_event(pLib, (int)ch_id));\r\n}\r\nreturn (0);\r\n}\r\nreturn (-1);\r\n}\r\nif (!strncmp("State\\Modem Event", path, pVar->path_length)) {\r\ndword ch_id;\r\nif (!diva_trace_read_variable (pVar, &ch_id)) {\r\nif (!pLib->pending_modem_status && !pLib->modem_init_event) {\r\nfor (i = 1; i <= pLib->Channels; i++) {\r\ndiva_modem_event(pLib, i);\r\n}\r\nreturn (0);\r\n} else if (ch_id && ch_id <= pLib->Channels) {\r\nreturn (diva_modem_event(pLib, (int)ch_id));\r\n}\r\nreturn (0);\r\n}\r\nreturn (-1);\r\n}\r\nfor (i = 1; i <= pLib->Channels; i++) {\r\nsprintf (name, "State\\B%d\\Line", i);\r\nif (find_var (pVar, name)) {\r\nreturn (diva_line_event(pLib, i));\r\n}\r\n}\r\nfor (i = 1; i <= pLib->Channels; i++) {\r\nsprintf (name, "State\\B%d\\Modem\\Event", i);\r\nif (find_var (pVar, name)) {\r\nreturn (diva_modem_event (pLib, i));\r\n}\r\n}\r\nfor (i = 1; i <= pLib->Channels; i++) {\r\nsprintf (name, "State\\B%d\\FAX\\Event", i);\r\nif (find_var (pVar, name)) {\r\nreturn (diva_fax_event (pLib, i));\r\n}\r\n}\r\nif (!strncmp("Events Down", path, pVar->path_length)) {\r\nif (pLib->trace_events_down == 1) {\r\npLib->trace_events_down = 2;\r\n} else {\r\ndiva_trace_error (pLib, 1, "Events Down", 0);\r\n}\r\nreturn (0);\r\n}\r\nif (!strncmp("State\\Layer1", path, pVar->path_length)) {\r\ndiva_strace_read_asz (pVar, &pLib->lines[0].pInterface->Layer1[0]);\r\nif (pLib->l1_trace == 1) {\r\npLib->l1_trace = 2;\r\n} else {\r\ndiva_trace_notify_user (pLib, 0, DIVA_SUPER_TRACE_INTERFACE_CHANGE);\r\n}\r\nreturn (0);\r\n}\r\nif (!strncmp("State\\Layer2 No1", path, pVar->path_length)) {\r\nchar* tmp = &pLib->lines[0].pInterface->Layer2[0];\r\ndword l2_state;\r\nif (diva_strace_read_uint(pVar, &l2_state))\r\nreturn -1;\r\nswitch (l2_state) {\r\ncase 0:\r\nstrcpy (tmp, "Idle");\r\nbreak;\r\ncase 1:\r\nstrcpy (tmp, "Layer2 UP");\r\nbreak;\r\ncase 2:\r\nstrcpy (tmp, "Layer2 Disconnecting");\r\nbreak;\r\ncase 3:\r\nstrcpy (tmp, "Layer2 Connecting");\r\nbreak;\r\ncase 4:\r\nstrcpy (tmp, "SPID Initializing");\r\nbreak;\r\ncase 5:\r\nstrcpy (tmp, "SPID Initialised");\r\nbreak;\r\ncase 6:\r\nstrcpy (tmp, "Layer2 Connecting");\r\nbreak;\r\ncase 7:\r\nstrcpy (tmp, "Auto SPID Stopped");\r\nbreak;\r\ncase 8:\r\nstrcpy (tmp, "Auto SPID Idle");\r\nbreak;\r\ncase 9:\r\nstrcpy (tmp, "Auto SPID Requested");\r\nbreak;\r\ncase 10:\r\nstrcpy (tmp, "Auto SPID Delivery");\r\nbreak;\r\ncase 11:\r\nstrcpy (tmp, "Auto SPID Complete");\r\nbreak;\r\ndefault:\r\nsprintf (tmp, "U:%d", (int)l2_state);\r\n}\r\nif (pLib->l2_trace == 1) {\r\npLib->l2_trace = 2;\r\n} else {\r\ndiva_trace_notify_user (pLib, 0, DIVA_SUPER_TRACE_INTERFACE_CHANGE);\r\n}\r\nreturn (0);\r\n}\r\nif (!strncmp("Statistics\\Incoming Calls\\Calls", path, pVar->path_length) ||\r\n!strncmp("Statistics\\Incoming Calls\\Connected", path, pVar->path_length)) {\r\nreturn (SuperTraceGetIncomingCallStatistics (pLib));\r\n}\r\nif (!strncmp("Statistics\\Outgoing Calls\\Calls", path, pVar->path_length) ||\r\n!strncmp("Statistics\\Outgoing Calls\\Connected", path, pVar->path_length)) {\r\nreturn (SuperTraceGetOutgoingCallStatistics (pLib));\r\n}\r\nreturn (-1);\r\n}\r\nstatic int diva_line_event (diva_strace_context_t* pLib, int Channel) {\r\npLib->pending_line_status |= (1L << (Channel-1));\r\nreturn (0);\r\n}\r\nstatic int diva_modem_event (diva_strace_context_t* pLib, int Channel) {\r\npLib->pending_modem_status |= (1L << (Channel-1));\r\nreturn (0);\r\n}\r\nstatic int diva_fax_event (diva_strace_context_t* pLib, int Channel) {\r\npLib->pending_fax_status |= (1L << (Channel-1));\r\nreturn (0);\r\n}\r\nstatic int process_idi_info (diva_strace_context_t* pLib,\r\ndiva_man_var_header_t* pVar) {\r\nconst char* path = (char*)&pVar->path_length+1;\r\nchar name[64];\r\nint i, len;\r\nfor (i = pLib->Channels; i > 0; i--) {\r\nlen = sprintf (name, "State\\B%d\\Modem", i);\r\nif (!strncmp(name, path, len)) {\r\nreturn (diva_modem_info (pLib, i, pVar));\r\n}\r\n}\r\nfor (i = pLib->Channels; i > 0; i--) {\r\nlen = sprintf (name, "State\\B%d\\FAX", i);\r\nif (!strncmp(name, path, len)) {\r\nreturn (diva_fax_info (pLib, i, pVar));\r\n}\r\n}\r\nfor (i = pLib->Channels; i > 0; i--) {\r\nlen = sprintf (name, "State\\B%d", i);\r\nif (!strncmp(name, path, len)) {\r\nreturn (diva_line_info (pLib, i, pVar));\r\n}\r\n}\r\nif (!diva_ifc_statistics (pLib, pVar)) {\r\nreturn (0);\r\n}\r\nreturn (-1);\r\n}\r\nstatic int diva_modem_info (diva_strace_context_t* pLib,\r\nint Channel,\r\ndiva_man_var_header_t* pVar) {\r\ndiva_man_var_header_t* cur;\r\nint i, nr = Channel - 1;\r\nfor (i = pLib->modem_parse_entry_first[nr];\r\ni <= pLib->modem_parse_entry_last[nr]; i++) {\r\nif ((cur = find_var (pVar, pLib->parse_table[i].path))) {\r\nif (diva_trace_read_variable (cur, pLib->parse_table[i].variable)) {\r\ndiva_trace_error (pLib, -3 , __FILE__, __LINE__);\r\nreturn (-1);\r\n}\r\n} else {\r\ndiva_trace_error (pLib, -2 , __FILE__, __LINE__);\r\nreturn (-1);\r\n}\r\n}\r\nif (pLib->modem_init_event & (1L << nr)) {\r\ndiva_trace_notify_user (pLib, nr, DIVA_SUPER_TRACE_NOTIFY_MODEM_CHANGE);\r\n} else {\r\npLib->modem_init_event |= (1L << nr);\r\n}\r\nreturn (0);\r\n}\r\nstatic int diva_fax_info (diva_strace_context_t* pLib,\r\nint Channel,\r\ndiva_man_var_header_t* pVar) {\r\ndiva_man_var_header_t* cur;\r\nint i, nr = Channel - 1;\r\nfor (i = pLib->fax_parse_entry_first[nr];\r\ni <= pLib->fax_parse_entry_last[nr]; i++) {\r\nif ((cur = find_var (pVar, pLib->parse_table[i].path))) {\r\nif (diva_trace_read_variable (cur, pLib->parse_table[i].variable)) {\r\ndiva_trace_error (pLib, -3 , __FILE__, __LINE__);\r\nreturn (-1);\r\n}\r\n} else {\r\ndiva_trace_error (pLib, -2 , __FILE__, __LINE__);\r\nreturn (-1);\r\n}\r\n}\r\nif (pLib->fax_init_event & (1L << nr)) {\r\ndiva_trace_notify_user (pLib, nr, DIVA_SUPER_TRACE_NOTIFY_FAX_CHANGE);\r\n} else {\r\npLib->fax_init_event |= (1L << nr);\r\n}\r\nreturn (0);\r\n}\r\nstatic int diva_line_info (diva_strace_context_t* pLib,\r\nint Channel,\r\ndiva_man_var_header_t* pVar) {\r\ndiva_man_var_header_t* cur;\r\nint i, nr = Channel - 1;\r\nfor (i = pLib->line_parse_entry_first[nr];\r\ni <= pLib->line_parse_entry_last[nr]; i++) {\r\nif ((cur = find_var (pVar, pLib->parse_table[i].path))) {\r\nif (diva_trace_read_variable (cur, pLib->parse_table[i].variable)) {\r\ndiva_trace_error (pLib, -3 , __FILE__, __LINE__);\r\nreturn (-1);\r\n}\r\n} else {\r\ndiva_trace_error (pLib, -2 , __FILE__, __LINE__);\r\nreturn (-1);\r\n}\r\n}\r\nif (pLib->line_init_event & (1L << nr)) {\r\ndiva_trace_notify_user (pLib, nr, DIVA_SUPER_TRACE_NOTIFY_LINE_CHANGE);\r\n} else {\r\npLib->line_init_event |= (1L << nr);\r\nif (strcmp (&pLib->lines[nr].Line[0], "Idle")) {\r\ndiva_trace_notify_user (pLib, nr, DIVA_SUPER_TRACE_NOTIFY_LINE_CHANGE);\r\n}\r\n}\r\nreturn (0);\r\n}\r\nstatic diva_man_var_header_t* get_next_var (diva_man_var_header_t* pVar) {\r\nbyte* msg = (byte*)pVar;\r\nbyte* start;\r\nint msg_length;\r\nif (*msg != ESC) return NULL;\r\nstart = msg + 2;\r\nmsg_length = *(msg+1);\r\nmsg = (start+msg_length);\r\nif (*msg != ESC) return NULL;\r\nreturn ((diva_man_var_header_t*)msg);\r\n}\r\nstatic diva_man_var_header_t* find_var (diva_man_var_header_t* pVar,\r\nconst char* name) {\r\nconst char* path;\r\ndo {\r\npath = (char*)&pVar->path_length+1;\r\nif (!strncmp (name, path, pVar->path_length)) {\r\nbreak;\r\n}\r\n} while ((pVar = get_next_var (pVar)));\r\nreturn (pVar);\r\n}\r\nstatic void diva_create_line_parse_table (diva_strace_context_t* pLib,\r\nint Channel) {\r\ndiva_trace_line_state_t* pLine = &pLib->lines[Channel];\r\nint nr = Channel+1;\r\nif ((pLib->cur_parse_entry + LINE_PARSE_ENTRIES) >= pLib->parse_entries) {\r\ndiva_trace_error (pLib, -1, __FILE__, __LINE__);\r\nreturn;\r\n}\r\npLine->ChannelNumber = nr;\r\npLib->line_parse_entry_first[Channel] = pLib->cur_parse_entry;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Framing", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->Framing[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Line", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->Line[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Layer2", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->Layer2[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Layer3", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->Layer3[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Remote Address", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLine->RemoteAddress[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Remote SubAddr", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLine->RemoteSubAddress[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Local Address", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLine->LocalAddress[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Local SubAddr", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLine->LocalSubAddress[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\BC", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->call_BC;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\HLC", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->call_HLC;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\LLC", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->call_LLC;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Charges", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->Charges;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Call Reference", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->CallReference;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Last Disc Cause", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLine->LastDisconnecCause;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\User ID", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pLine->UserID[0];\r\npLib->line_parse_entry_last[Channel] = pLib->cur_parse_entry - 1;\r\n}\r\nstatic void diva_create_fax_parse_table (diva_strace_context_t* pLib,\r\nint Channel) {\r\ndiva_trace_fax_state_t* pFax = &pLib->lines[Channel].fax;\r\nint nr = Channel+1;\r\nif ((pLib->cur_parse_entry + FAX_PARSE_ENTRIES) >= pLib->parse_entries) {\r\ndiva_trace_error (pLib, -1, __FILE__, __LINE__);\r\nreturn;\r\n}\r\npFax->ChannelNumber = nr;\r\npLib->fax_parse_entry_first[Channel] = pLib->cur_parse_entry;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Event", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Event;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Page Counter", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Page_Counter;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Features", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Features;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Station ID", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Station_ID[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Subaddress", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Subaddress[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Password", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Password[0];\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Speed", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Speed;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Resolution", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Resolution;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Paper Width", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Paper_Width;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Paper Length", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Paper_Length;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Scanline Time", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Scanline_Time;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\FAX\\Disc Reason", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pFax->Disc_Reason;\r\npLib->fax_parse_entry_last[Channel] = pLib->cur_parse_entry - 1;\r\n}\r\nstatic void diva_create_modem_parse_table (diva_strace_context_t* pLib,\r\nint Channel) {\r\ndiva_trace_modem_state_t* pModem = &pLib->lines[Channel].modem;\r\nint nr = Channel+1;\r\nif ((pLib->cur_parse_entry + MODEM_PARSE_ENTRIES) >= pLib->parse_entries) {\r\ndiva_trace_error (pLib, -1, __FILE__, __LINE__);\r\nreturn;\r\n}\r\npModem->ChannelNumber = nr;\r\npLib->modem_parse_entry_first[Channel] = pLib->cur_parse_entry;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Event", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->Event;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Norm", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->Norm;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Options", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->Options;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\TX Speed", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->TxSpeed;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\RX Speed", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->RxSpeed;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Roundtrip ms", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->RoundtripMsec;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Symbol Rate", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->SymbolRate;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\RX Level dBm", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->RxLeveldBm;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Echo Level dBm", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->EchoLeveldBm;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\SNR dB", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->SNRdb;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\MAE", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->MAE;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Local Retrains", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->LocalRetrains;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Remote Retrains", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->RemoteRetrains;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Local Resyncs", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->LocalResyncs;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Remote Resyncs", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->RemoteResyncs;\r\nsprintf (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"State\\B%d\\Modem\\Disc Reason", nr);\r\npLib->parse_table[pLib->cur_parse_entry++].variable = &pModem->DiscReason;\r\npLib->modem_parse_entry_last[Channel] = pLib->cur_parse_entry - 1;\r\n}\r\nstatic void diva_create_parse_table (diva_strace_context_t* pLib) {\r\nint i;\r\nfor (i = 0; i < pLib->Channels; i++) {\r\ndiva_create_line_parse_table (pLib, i);\r\ndiva_create_modem_parse_table (pLib, i);\r\ndiva_create_fax_parse_table (pLib, i);\r\n}\r\npLib->statistic_parse_first = pLib->cur_parse_entry;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Outgoing Calls\\Calls");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.outg.Calls;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Outgoing Calls\\Connected");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.outg.Connected;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Outgoing Calls\\User Busy");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.outg.User_Busy;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Outgoing Calls\\No Answer");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.outg.No_Answer;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Outgoing Calls\\Wrong Number");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.outg.Wrong_Number;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Outgoing Calls\\Call Rejected");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.outg.Call_Rejected;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Outgoing Calls\\Other Failures");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.outg.Other_Failures;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\Calls");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.Calls;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\Connected");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.Connected;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\User Busy");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.User_Busy;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\Call Rejected");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.Call_Rejected;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\Wrong Number");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.Wrong_Number;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\Incompatible Dst");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.Incompatible_Dst;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\Out of Order");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.Out_of_Order;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Incoming Calls\\Ignored");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.inc.Ignored;\r\npLib->mdm_statistic_parse_first = pLib->cur_parse_entry;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Normal");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Normal;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Unspecified");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Unspecified;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Busy Tone");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Busy_Tone;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Congestion");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Congestion;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Carr. Wait");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Carr_Wait;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Trn Timeout");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Trn_Timeout;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Incompat.");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Incompat;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc Frame Rej.");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_Frame_Rej;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\Modem\\Disc V42bis");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.mdm.Disc_V42bis;\r\npLib->mdm_statistic_parse_last = pLib->cur_parse_entry - 1;\r\npLib->fax_statistic_parse_first = pLib->cur_parse_entry;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Normal");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Normal;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Not Ident.");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Not_Ident;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc No Response");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_No_Response;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Retries");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Retries;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Unexp. Msg.");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Unexp_Msg;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc No Polling.");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_No_Polling;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Training");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Training;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Unexpected");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Unexpected;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Application");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Application;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Incompat.");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Incompat;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc No Command");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_No_Command;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Long Msg");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Long_Msg;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Supervisor");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Supervisor;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc SUB SEP PWD");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_SUB_SEP_PWD;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Invalid Msg");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Invalid_Msg;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Page Coding");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Page_Coding;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc App Timeout");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_App_Timeout;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\FAX\\Disc Unspecified");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.fax.Disc_Unspecified;\r\npLib->fax_statistic_parse_last = pLib->cur_parse_entry - 1;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer1\\X-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b1.X_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer1\\X-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b1.X_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer1\\X-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b1.X_Errors;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer1\\R-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b1.R_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer1\\R-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b1.R_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer1\\R-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b1.R_Errors;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer2\\X-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b2.X_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer2\\X-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b2.X_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer2\\X-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b2.X_Errors;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer2\\R-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b2.R_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer2\\R-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b2.R_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\B-Layer2\\R-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.b2.R_Errors;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer1\\X-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d1.X_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer1\\X-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d1.X_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer1\\X-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d1.X_Errors;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer1\\R-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d1.R_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer1\\R-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d1.R_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer1\\R-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d1.R_Errors;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer2\\X-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d2.X_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer2\\X-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d2.X_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer2\\X-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d2.X_Errors;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer2\\R-Frames");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d2.R_Frames;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer2\\R-Bytes");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d2.R_Bytes;\r\nstrcpy (pLib->parse_table[pLib->cur_parse_entry].path,\r\n"Statistics\\D-Layer2\\R-Errors");\r\npLib->parse_table[pLib->cur_parse_entry++].variable = \\r\n&pLib->InterfaceStat.d2.R_Errors;\r\npLib->statistic_parse_last = pLib->cur_parse_entry - 1;\r\n}\r\nstatic void diva_trace_error (diva_strace_context_t* pLib,\r\nint error, const char* file, int line) {\r\nif (pLib->user_proc_table.error_notify_proc) {\r\n(*(pLib->user_proc_table.error_notify_proc))(\\r\npLib->user_proc_table.user_context,\r\n&pLib->instance, pLib->Adapter,\r\nerror, file, line);\r\n}\r\n}\r\nstatic void diva_trace_notify_user (diva_strace_context_t* pLib,\r\nint Channel,\r\nint notify_subject) {\r\nif (pLib->user_proc_table.notify_proc) {\r\n(*(pLib->user_proc_table.notify_proc))(pLib->user_proc_table.user_context,\r\n&pLib->instance,\r\npLib->Adapter,\r\n&pLib->lines[Channel],\r\nnotify_subject);\r\n}\r\n}\r\nstatic int diva_trace_read_variable (diva_man_var_header_t* pVar,\r\nvoid* variable) {\r\nswitch (pVar->type) {\r\ncase 0x03:\r\nreturn (diva_strace_read_asz (pVar, (char*)variable));\r\ncase 0x04:\r\nreturn (diva_strace_read_asc (pVar, (char*)variable));\r\ncase 0x05:\r\nreturn (diva_strace_read_ie (pVar, (diva_trace_ie_t*)variable));\r\ncase 0x81:\r\nreturn (diva_strace_read_int (pVar, (int*)variable));\r\ncase 0x82:\r\nreturn (diva_strace_read_uint (pVar, (dword*)variable));\r\ncase 0x83:\r\nreturn (diva_strace_read_uint (pVar, (dword*)variable));\r\ncase 0x87:\r\nreturn (diva_strace_read_uint (pVar, (dword*)variable));\r\n}\r\nreturn (-1);\r\n}\r\nstatic int diva_strace_read_int (diva_man_var_header_t* pVar, int* var) {\r\nbyte* ptr = (char*)&pVar->path_length;\r\nint value;\r\nptr += (pVar->path_length + 1);\r\nswitch (pVar->value_length) {\r\ncase 1:\r\nvalue = *(char*)ptr;\r\nbreak;\r\ncase 2:\r\nvalue = (short)GET_WORD(ptr);\r\nbreak;\r\ncase 4:\r\nvalue = (int)GET_DWORD(ptr);\r\nbreak;\r\ndefault:\r\nreturn (-1);\r\n}\r\n*var = value;\r\nreturn (0);\r\n}\r\nstatic int diva_strace_read_uint (diva_man_var_header_t* pVar, dword* var) {\r\nbyte* ptr = (char*)&pVar->path_length;\r\ndword value;\r\nptr += (pVar->path_length + 1);\r\nswitch (pVar->value_length) {\r\ncase 1:\r\nvalue = (byte)(*ptr);\r\nbreak;\r\ncase 2:\r\nvalue = (word)GET_WORD(ptr);\r\nbreak;\r\ncase 3:\r\nvalue = (dword)GET_DWORD(ptr);\r\nvalue &= 0x00ffffff;\r\nbreak;\r\ncase 4:\r\nvalue = (dword)GET_DWORD(ptr);\r\nbreak;\r\ndefault:\r\nreturn (-1);\r\n}\r\n*var = value;\r\nreturn (0);\r\n}\r\nstatic int diva_strace_read_asz (diva_man_var_header_t* pVar, char* var) {\r\nchar* ptr = (char*)&pVar->path_length;\r\nint length;\r\nptr += (pVar->path_length + 1);\r\nif (!(length = pVar->value_length)) {\r\nlength = strlen (ptr);\r\n}\r\nmemcpy (var, ptr, length);\r\nvar[length] = 0;\r\nreturn (0);\r\n}\r\nstatic int diva_strace_read_asc (diva_man_var_header_t* pVar, char* var) {\r\nchar* ptr = (char*)&pVar->path_length;\r\nptr += (pVar->path_length + 1);\r\nmemcpy (var, ptr+1, *ptr);\r\nvar[(int)*ptr] = 0;\r\nreturn (0);\r\n}\r\nstatic int diva_strace_read_ie (diva_man_var_header_t* pVar,\r\ndiva_trace_ie_t* var) {\r\nchar* ptr = (char*)&pVar->path_length;\r\nptr += (pVar->path_length + 1);\r\nvar->length = *ptr;\r\nmemcpy (&var->data[0], ptr+1, *ptr);\r\nreturn (0);\r\n}\r\nstatic int SuperTraceSetAudioTap (void* hLib, int Channel, int on) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nif ((Channel < 1) || (Channel > pLib->Channels)) {\r\nreturn (-1);\r\n}\r\nChannel--;\r\nif (on) {\r\npLib->audio_tap_mask |= (1L << Channel);\r\n} else {\r\npLib->audio_tap_mask &= ~(1L << Channel);\r\n}\r\nif (pLib->audio_tap_mask) {\r\npLib->trace_event_mask |= TM_M_DATA;\r\n} else {\r\npLib->trace_event_mask &= ~TM_M_DATA;\r\n}\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceSetBChannel (void* hLib, int Channel, int on) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nif ((Channel < 1) || (Channel > pLib->Channels)) {\r\nreturn (-1);\r\n}\r\nChannel--;\r\nif (on) {\r\npLib->bchannel_trace_mask |= (1L << Channel);\r\n} else {\r\npLib->bchannel_trace_mask &= ~(1L << Channel);\r\n}\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceSetDChannel (void* hLib, int on) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nif (on) {\r\npLib->trace_event_mask |= (TM_D_CHAN | TM_C_COMM | TM_DL_ERR | TM_LAYER1);\r\n} else {\r\npLib->trace_event_mask &= ~(TM_D_CHAN | TM_C_COMM | TM_DL_ERR | TM_LAYER1);\r\n}\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceSetInfo (void* hLib, int on) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nif (on) {\r\npLib->trace_event_mask |= TM_STRING;\r\n} else {\r\npLib->trace_event_mask &= ~TM_STRING;\r\n}\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceClearCall (void* hLib, int Channel) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\nif ((Channel < 1) || (Channel > pLib->Channels)) {\r\nreturn (-1);\r\n}\r\nChannel--;\r\npLib->clear_call_command |= (1L << Channel);\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int diva_ifc_statistics (diva_strace_context_t* pLib,\r\ndiva_man_var_header_t* pVar) {\r\ndiva_man_var_header_t* cur;\r\nint i, one_updated = 0, mdm_updated = 0, fax_updated = 0;\r\nfor (i = pLib->statistic_parse_first; i <= pLib->statistic_parse_last; i++) {\r\nif ((cur = find_var (pVar, pLib->parse_table[i].path))) {\r\nif (diva_trace_read_variable (cur, pLib->parse_table[i].variable)) {\r\ndiva_trace_error (pLib, -3 , __FILE__, __LINE__);\r\nreturn (-1);\r\n}\r\none_updated = 1;\r\nif ((i >= pLib->mdm_statistic_parse_first) && (i <= pLib->mdm_statistic_parse_last)) {\r\nmdm_updated = 1;\r\n}\r\nif ((i >= pLib->fax_statistic_parse_first) && (i <= pLib->fax_statistic_parse_last)) {\r\nfax_updated = 1;\r\n}\r\n}\r\n}\r\nif (mdm_updated) {\r\ndiva_trace_notify_user (pLib, 0, DIVA_SUPER_TRACE_NOTIFY_MDM_STAT_CHANGE);\r\n} else if (fax_updated) {\r\ndiva_trace_notify_user (pLib, 0, DIVA_SUPER_TRACE_NOTIFY_FAX_STAT_CHANGE);\r\n} else if (one_updated) {\r\ndiva_trace_notify_user (pLib, 0, DIVA_SUPER_TRACE_NOTIFY_STAT_CHANGE);\r\n}\r\nreturn (one_updated ? 0 : -1);\r\n}\r\nstatic int SuperTraceGetOutgoingCallStatistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->outgoing_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceGetIncomingCallStatistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->incoming_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceGetModemStatistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->modem_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceGetFaxStatistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->fax_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceGetBLayer1Statistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->b1_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceGetBLayer2Statistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->b2_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceGetDLayer1Statistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->d1_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\nstatic int SuperTraceGetDLayer2Statistics (void* hLib) {\r\ndiva_strace_context_t* pLib = (diva_strace_context_t*)hLib;\r\npLib->d2_ifc_stats = 1;\r\nreturn (ScheduleNextTraceRequest (pLib));\r\n}\r\ndword DivaSTraceGetMemotyRequirement (int channels) {\r\ndword parse_entries = (MODEM_PARSE_ENTRIES + FAX_PARSE_ENTRIES + \\r\nSTAT_PARSE_ENTRIES + \\r\nLINE_PARSE_ENTRIES + 1) * channels;\r\nreturn (sizeof(diva_strace_context_t) + \\r\n(parse_entries * sizeof(diva_strace_path2action_t)));\r\n}

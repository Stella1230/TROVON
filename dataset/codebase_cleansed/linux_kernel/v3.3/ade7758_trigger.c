static irqreturn_t ade7758_data_rdy_trig_poll(int irq, void *private)\r\n{\r\ndisable_irq_nosync(irq);\r\niio_trigger_poll(private, iio_get_time_ns());\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ade7758_data_rdy_trigger_set_state(struct iio_trigger *trig,\r\nbool state)\r\n{\r\nstruct iio_dev *indio_dev = trig->private_data;\r\ndev_dbg(&indio_dev->dev, "%s (%d)\n", __func__, state);\r\nreturn ade7758_set_irq(&indio_dev->dev, state);\r\n}\r\nstatic int ade7758_trig_try_reen(struct iio_trigger *trig)\r\n{\r\nstruct iio_dev *indio_dev = trig->private_data;\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nenable_irq(st->us->irq);\r\nreturn 0;\r\n}\r\nint ade7758_probe_trigger(struct iio_dev *indio_dev)\r\n{\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nint ret;\r\nst->trig = iio_allocate_trigger("%s-dev%d",\r\nspi_get_device_id(st->us)->name,\r\nindio_dev->id);\r\nif (st->trig == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nret = request_irq(st->us->irq,\r\nade7758_data_rdy_trig_poll,\r\nIRQF_TRIGGER_LOW,\r\nspi_get_device_id(st->us)->name,\r\nst->trig);\r\nif (ret)\r\ngoto error_free_trig;\r\nst->trig->dev.parent = &st->us->dev;\r\nst->trig->ops = &ade7758_trigger_ops;\r\nst->trig->private_data = indio_dev;\r\nret = iio_trigger_register(st->trig);\r\nindio_dev->trig = st->trig;\r\nif (ret)\r\ngoto error_free_irq;\r\nreturn 0;\r\nerror_free_irq:\r\nfree_irq(st->us->irq, st->trig);\r\nerror_free_trig:\r\niio_free_trigger(st->trig);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nvoid ade7758_remove_trigger(struct iio_dev *indio_dev)\r\n{\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\niio_trigger_unregister(st->trig);\r\nfree_irq(st->us->irq, st->trig);\r\niio_free_trigger(st->trig);\r\n}

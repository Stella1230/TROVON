static void psb_lid_timer_func(unsigned long data)\r\n{\r\nstruct drm_psb_private * dev_priv = (struct drm_psb_private *)data;\r\nstruct drm_device *dev = (struct drm_device *)dev_priv->dev;\r\nstruct timer_list *lid_timer = &dev_priv->lid_timer;\r\nunsigned long irq_flags;\r\nu32 *lid_state = dev_priv->lid_state;\r\nu32 pp_status;\r\nif (readl(lid_state) == dev_priv->lid_last_state)\r\ngoto lid_timer_schedule;\r\nif ((readl(lid_state)) & 0x01) {\r\nREG_WRITE(PP_CONTROL, REG_READ(PP_CONTROL) | POWER_TARGET_ON);\r\ndo {\r\npp_status = REG_READ(PP_STATUS);\r\n} while ((pp_status & PP_ON) == 0);\r\npsb_intel_lvds_set_brightness(dev, 100);\r\n} else {\r\npsb_intel_lvds_set_brightness(dev, 0);\r\nREG_WRITE(PP_CONTROL, REG_READ(PP_CONTROL) & ~POWER_TARGET_ON);\r\ndo {\r\npp_status = REG_READ(PP_STATUS);\r\n} while ((pp_status & PP_ON) == 0);\r\n}\r\ndev_priv->lid_last_state = readl(lid_state);\r\nlid_timer_schedule:\r\nspin_lock_irqsave(&dev_priv->lid_lock, irq_flags);\r\nif (!timer_pending(lid_timer)) {\r\nlid_timer->expires = jiffies + PSB_LID_DELAY;\r\nadd_timer(lid_timer);\r\n}\r\nspin_unlock_irqrestore(&dev_priv->lid_lock, irq_flags);\r\n}\r\nvoid psb_lid_timer_init(struct drm_psb_private *dev_priv)\r\n{\r\nstruct timer_list *lid_timer = &dev_priv->lid_timer;\r\nunsigned long irq_flags;\r\nspin_lock_init(&dev_priv->lid_lock);\r\nspin_lock_irqsave(&dev_priv->lid_lock, irq_flags);\r\ninit_timer(lid_timer);\r\nlid_timer->data = (unsigned long)dev_priv;\r\nlid_timer->function = psb_lid_timer_func;\r\nlid_timer->expires = jiffies + PSB_LID_DELAY;\r\nadd_timer(lid_timer);\r\nspin_unlock_irqrestore(&dev_priv->lid_lock, irq_flags);\r\n}\r\nvoid psb_lid_timer_takedown(struct drm_psb_private *dev_priv)\r\n{\r\ndel_timer_sync(&dev_priv->lid_timer);\r\n}

int m5mols_do_scenemode(struct m5mols_info *info, u8 mode)\r\n{\r\nstruct v4l2_subdev *sd = &info->sd;\r\nstruct m5mols_scenemode scenemode = m5mols_default_scenemode[mode];\r\nint ret;\r\nif (mode > REG_SCENE_CANDLE)\r\nreturn -EINVAL;\r\nret = m5mols_lock_3a(info, false);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_EV_PRESET_MONITOR, mode);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_EV_PRESET_CAPTURE, mode);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_MODE, scenemode.metering);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_INDEX, scenemode.ev_bias);\r\nif (!ret)\r\nret = m5mols_write(sd, AWB_MODE, scenemode.wb_mode);\r\nif (!ret)\r\nret = m5mols_write(sd, AWB_MANUAL, scenemode.wb_preset);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CHROMA_EN, scenemode.chroma_en);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CHROMA_LVL, scenemode.chroma_lvl);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_EDGE_EN, scenemode.edge_en);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_EDGE_LVL, scenemode.edge_lvl);\r\nif (!ret && is_available_af(info))\r\nret = m5mols_write(sd, AF_MODE, scenemode.af_range);\r\nif (!ret && is_available_af(info))\r\nret = m5mols_write(sd, FD_CTL, scenemode.fd_mode);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_TONE_CTL, scenemode.tone);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_ISO, scenemode.iso);\r\nif (!ret)\r\nret = m5mols_mode(info, REG_CAPTURE);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_WDR_EN, scenemode.wdr);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_MCC_MODE, scenemode.mcc);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_LIGHT_CTRL, scenemode.light);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_FLASH_CTRL, scenemode.flash);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPC_MODE, scenemode.capt_mode);\r\nif (!ret)\r\nret = m5mols_mode(info, REG_MONITOR);\r\nreturn ret;\r\n}\r\nstatic int m5mols_lock_ae(struct m5mols_info *info, bool lock)\r\n{\r\nint ret = 0;\r\nif (info->lock_ae != lock)\r\nret = m5mols_write(&info->sd, AE_LOCK,\r\nlock ? REG_AE_LOCK : REG_AE_UNLOCK);\r\nif (!ret)\r\ninfo->lock_ae = lock;\r\nreturn ret;\r\n}\r\nstatic int m5mols_lock_awb(struct m5mols_info *info, bool lock)\r\n{\r\nint ret = 0;\r\nif (info->lock_awb != lock)\r\nret = m5mols_write(&info->sd, AWB_LOCK,\r\nlock ? REG_AWB_LOCK : REG_AWB_UNLOCK);\r\nif (!ret)\r\ninfo->lock_awb = lock;\r\nreturn ret;\r\n}\r\nint m5mols_lock_3a(struct m5mols_info *info, bool lock)\r\n{\r\nint ret;\r\nret = m5mols_lock_ae(info, lock);\r\nif (!ret)\r\nret = m5mols_lock_awb(info, lock);\r\nif (!ret && is_available_af(info) && lock)\r\nret = m5mols_write(&info->sd, AF_EXECUTE, REG_AF_STOP);\r\nreturn ret;\r\n}\r\nint m5mols_set_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_subdev *sd = to_sd(ctrl);\r\nstruct m5mols_info *info = to_m5mols(sd);\r\nint ret;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_ZOOM_ABSOLUTE:\r\nreturn m5mols_write(sd, MON_ZOOM, ctrl->val);\r\ncase V4L2_CID_EXPOSURE_AUTO:\r\nret = m5mols_lock_ae(info,\r\nctrl->val == V4L2_EXPOSURE_AUTO ? false : true);\r\nif (!ret && ctrl->val == V4L2_EXPOSURE_AUTO)\r\nret = m5mols_write(sd, AE_MODE, REG_AE_ALL);\r\nif (!ret && ctrl->val == V4L2_EXPOSURE_MANUAL) {\r\nint val = info->exposure->val;\r\nret = m5mols_write(sd, AE_MODE, REG_AE_OFF);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_MAN_GAIN_MON, val);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_MAN_GAIN_CAP, val);\r\n}\r\nreturn ret;\r\ncase V4L2_CID_AUTO_WHITE_BALANCE:\r\nret = m5mols_lock_awb(info, ctrl->val ? false : true);\r\nif (!ret)\r\nret = m5mols_write(sd, AWB_MODE, ctrl->val ?\r\nREG_AWB_AUTO : REG_AWB_PRESET);\r\nreturn ret;\r\ncase V4L2_CID_SATURATION:\r\nret = m5mols_write(sd, MON_CHROMA_LVL, ctrl->val);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CHROMA_EN, REG_CHROMA_ON);\r\nreturn ret;\r\ncase V4L2_CID_COLORFX:\r\nret = m5mols_write(sd, PARM_EFFECT,\r\nctrl->val == V4L2_COLORFX_NEGATIVE ? REG_EFFECT_NEGA :\r\nctrl->val == V4L2_COLORFX_EMBOSS ? REG_EFFECT_EMBOSS :\r\nREG_EFFECT_OFF);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_EFFECT,\r\nctrl->val == V4L2_COLORFX_SEPIA ?\r\nREG_COLOR_EFFECT_ON : REG_COLOR_EFFECT_OFF);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CFIXR,\r\nctrl->val == V4L2_COLORFX_SEPIA ?\r\nREG_CFIXR_SEPIA : 0);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CFIXB,\r\nctrl->val == V4L2_COLORFX_SEPIA ?\r\nREG_CFIXB_SEPIA : 0);\r\nreturn ret;\r\n}\r\nreturn -EINVAL;\r\n}

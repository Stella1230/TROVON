static void udbg_550_flush(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((in_8(&udbg_comport->lsr) & LSR_THRE) == 0)\r\n;\r\n}\r\n}\r\nstatic void udbg_550_putc(char c)\r\n{\r\nif (udbg_comport) {\r\nif (c == '\n')\r\nudbg_550_putc('\r');\r\nudbg_550_flush();\r\nout_8(&udbg_comport->thr, c);\r\n}\r\n}\r\nstatic int udbg_550_getc_poll(void)\r\n{\r\nif (udbg_comport) {\r\nif ((in_8(&udbg_comport->lsr) & LSR_DR) != 0)\r\nreturn in_8(&udbg_comport->rbr);\r\nelse\r\nreturn -1;\r\n}\r\nreturn -1;\r\n}\r\nstatic int udbg_550_getc(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((in_8(&udbg_comport->lsr) & LSR_DR) == 0)\r\n;\r\nreturn in_8(&udbg_comport->rbr);\r\n}\r\nreturn -1;\r\n}\r\nvoid udbg_init_uart(void __iomem *comport, unsigned int speed,\r\nunsigned int clock)\r\n{\r\nunsigned int dll, base_bauds;\r\nif (clock == 0)\r\nclock = 1843200;\r\nif (speed == 0)\r\nspeed = 9600;\r\nbase_bauds = clock / 16;\r\ndll = base_bauds / speed;\r\nif (comport) {\r\nudbg_comport = (struct NS16550 __iomem *)comport;\r\nout_8(&udbg_comport->lcr, 0x00);\r\nout_8(&udbg_comport->ier, 0xff);\r\nout_8(&udbg_comport->ier, 0x00);\r\nout_8(&udbg_comport->lcr, LCR_DLAB);\r\nout_8(&udbg_comport->dll, dll & 0xff);\r\nout_8(&udbg_comport->dlm, dll >> 8);\r\nout_8(&udbg_comport->lcr, 0x03);\r\nout_8(&udbg_comport->mcr, 0x03);\r\nout_8(&udbg_comport->fcr ,0x07);\r\nudbg_putc = udbg_550_putc;\r\nudbg_flush = udbg_550_flush;\r\nudbg_getc = udbg_550_getc;\r\nudbg_getc_poll = udbg_550_getc_poll;\r\n}\r\n}\r\nunsigned int udbg_probe_uart_speed(void __iomem *comport, unsigned int clock)\r\n{\r\nunsigned int dll, dlm, divisor, prescaler, speed;\r\nu8 old_lcr;\r\nstruct NS16550 __iomem *port = comport;\r\nold_lcr = in_8(&port->lcr);\r\nout_8(&port->lcr, LCR_DLAB);\r\ndll = in_8(&port->dll);\r\ndlm = in_8(&port->dlm);\r\ndivisor = dlm << 8 | dll;\r\nif (in_8(&port->mcr) & 0x80)\r\nprescaler = 4;\r\nelse\r\nprescaler = 1;\r\nout_8(&port->lcr, old_lcr);\r\nspeed = (clock / prescaler) / (divisor * 16);\r\nif (speed > (clock / 16))\r\nspeed = 9600;\r\nreturn speed;\r\n}\r\nvoid udbg_maple_real_flush(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((real_readb(&udbg_comport->lsr) & LSR_THRE) == 0)\r\n;\r\n}\r\n}\r\nvoid udbg_maple_real_putc(char c)\r\n{\r\nif (udbg_comport) {\r\nif (c == '\n')\r\nudbg_maple_real_putc('\r');\r\nudbg_maple_real_flush();\r\nreal_writeb(c, &udbg_comport->thr); eieio();\r\n}\r\n}\r\nvoid __init udbg_init_maple_realmode(void)\r\n{\r\nudbg_comport = (struct NS16550 __iomem *)0xf40003f8;\r\nudbg_putc = udbg_maple_real_putc;\r\nudbg_flush = udbg_maple_real_flush;\r\nudbg_getc = NULL;\r\nudbg_getc_poll = NULL;\r\n}\r\nvoid udbg_pas_real_flush(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((real_205_readb(&udbg_comport->lsr) & LSR_THRE) == 0)\r\n;\r\n}\r\n}\r\nvoid udbg_pas_real_putc(char c)\r\n{\r\nif (udbg_comport) {\r\nif (c == '\n')\r\nudbg_pas_real_putc('\r');\r\nudbg_pas_real_flush();\r\nreal_205_writeb(c, &udbg_comport->thr); eieio();\r\n}\r\n}\r\nvoid udbg_init_pas_realmode(void)\r\n{\r\nudbg_comport = (struct NS16550 __iomem *)0xfcff03f8UL;\r\nudbg_putc = udbg_pas_real_putc;\r\nudbg_flush = udbg_pas_real_flush;\r\nudbg_getc = NULL;\r\nudbg_getc_poll = NULL;\r\n}\r\nstatic void udbg_44x_as1_flush(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((as1_readb(&udbg_comport->lsr) & LSR_THRE) == 0)\r\n;\r\n}\r\n}\r\nstatic void udbg_44x_as1_putc(char c)\r\n{\r\nif (udbg_comport) {\r\nif (c == '\n')\r\nudbg_44x_as1_putc('\r');\r\nudbg_44x_as1_flush();\r\nas1_writeb(c, &udbg_comport->thr); eieio();\r\n}\r\n}\r\nstatic int udbg_44x_as1_getc(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((as1_readb(&udbg_comport->lsr) & LSR_DR) == 0)\r\n;\r\nreturn as1_readb(&udbg_comport->rbr);\r\n}\r\nreturn -1;\r\n}\r\nvoid __init udbg_init_44x_as1(void)\r\n{\r\nudbg_comport =\r\n(struct NS16550 __iomem *)PPC44x_EARLY_DEBUG_VIRTADDR;\r\nudbg_putc = udbg_44x_as1_putc;\r\nudbg_flush = udbg_44x_as1_flush;\r\nudbg_getc = udbg_44x_as1_getc;\r\n}\r\nstatic void udbg_40x_real_flush(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((real_readb(&udbg_comport->lsr) & LSR_THRE) == 0)\r\n;\r\n}\r\n}\r\nstatic void udbg_40x_real_putc(char c)\r\n{\r\nif (udbg_comport) {\r\nif (c == '\n')\r\nudbg_40x_real_putc('\r');\r\nudbg_40x_real_flush();\r\nreal_writeb(c, &udbg_comport->thr); eieio();\r\n}\r\n}\r\nstatic int udbg_40x_real_getc(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((real_readb(&udbg_comport->lsr) & LSR_DR) == 0)\r\n;\r\nreturn real_readb(&udbg_comport->rbr);\r\n}\r\nreturn -1;\r\n}\r\nvoid __init udbg_init_40x_realmode(void)\r\n{\r\nudbg_comport = (struct NS16550 __iomem *)\r\nCONFIG_PPC_EARLY_DEBUG_40x_PHYSADDR;\r\nudbg_putc = udbg_40x_real_putc;\r\nudbg_flush = udbg_40x_real_flush;\r\nudbg_getc = udbg_40x_real_getc;\r\nudbg_getc_poll = NULL;\r\n}\r\nstatic void udbg_wsp_flush(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((readb(&udbg_comport->lsr) & LSR_THRE) == 0)\r\n;\r\n}\r\n}\r\nstatic void udbg_wsp_putc(char c)\r\n{\r\nif (udbg_comport) {\r\nif (c == '\n')\r\nudbg_wsp_putc('\r');\r\nudbg_wsp_flush();\r\nwriteb(c, &udbg_comport->thr); eieio();\r\n}\r\n}\r\nstatic int udbg_wsp_getc(void)\r\n{\r\nif (udbg_comport) {\r\nwhile ((readb(&udbg_comport->lsr) & LSR_DR) == 0)\r\n;\r\nreturn readb(&udbg_comport->rbr);\r\n}\r\nreturn -1;\r\n}\r\nstatic int udbg_wsp_getc_poll(void)\r\n{\r\nif (udbg_comport)\r\nif (readb(&udbg_comport->lsr) & LSR_DR)\r\nreturn readb(&udbg_comport->rbr);\r\nreturn -1;\r\n}\r\nvoid __init udbg_init_wsp(void)\r\n{\r\nudbg_comport = (struct NS16550 __iomem *)WSP_UART_VIRT;\r\nudbg_init_uart(udbg_comport, 57600, 50000000);\r\nudbg_putc = udbg_wsp_putc;\r\nudbg_flush = udbg_wsp_flush;\r\nudbg_getc = udbg_wsp_getc;\r\nudbg_getc_poll = udbg_wsp_getc_poll;\r\n}

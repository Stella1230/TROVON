static inline u_char\r\nreadreg(unsigned int ale, unsigned int adr, u_char off)\r\n{\r\nregister u_char ret;\r\nint max_delay = 2000;\r\nbyteout(ale, off);\r\nret = HFC_BUSY & bytein(ale);\r\nwhile (ret && --max_delay)\r\nret = HFC_BUSY & bytein(ale);\r\nif (!max_delay) {\r\nprintk(KERN_WARNING "TeleInt Busy not inactive\n");\r\nreturn (0);\r\n}\r\nret = bytein(adr);\r\nreturn (ret);\r\n}\r\nstatic inline void\r\nreadfifo(unsigned int ale, unsigned int adr, u_char off, u_char * data, int size)\r\n{\r\nregister u_char ret;\r\nregister int max_delay = 20000;\r\nregister int i;\r\nbyteout(ale, off);\r\nfor (i = 0; i<size; i++) {\r\nret = HFC_BUSY & bytein(ale);\r\nwhile (ret && --max_delay)\r\nret = HFC_BUSY & bytein(ale);\r\nif (!max_delay) {\r\nprintk(KERN_WARNING "TeleInt Busy not inactive\n");\r\nreturn;\r\n}\r\ndata[i] = bytein(adr);\r\n}\r\n}\r\nstatic inline void\r\nwritereg(unsigned int ale, unsigned int adr, u_char off, u_char data)\r\n{\r\nregister u_char ret;\r\nint max_delay = 2000;\r\nbyteout(ale, off);\r\nret = HFC_BUSY & bytein(ale);\r\nwhile (ret && --max_delay)\r\nret = HFC_BUSY & bytein(ale);\r\nif (!max_delay) {\r\nprintk(KERN_WARNING "TeleInt Busy not inactive\n");\r\nreturn;\r\n}\r\nbyteout(adr, data);\r\n}\r\nstatic inline void\r\nwritefifo(unsigned int ale, unsigned int adr, u_char off, u_char * data, int size)\r\n{\r\nregister u_char ret;\r\nregister int max_delay = 20000;\r\nregister int i;\r\nbyteout(ale, off);\r\nfor (i = 0; i<size; i++) {\r\nret = HFC_BUSY & bytein(ale);\r\nwhile (ret && --max_delay)\r\nret = HFC_BUSY & bytein(ale);\r\nif (!max_delay) {\r\nprintk(KERN_WARNING "TeleInt Busy not inactive\n");\r\nreturn;\r\n}\r\nbyteout(adr, data[i]);\r\n}\r\n}\r\nstatic u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\ncs->hw.hfc.cip = offset;\r\nreturn (readreg(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\ncs->hw.hfc.cip = offset;\r\nwritereg(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, offset, value);\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char * data, int size)\r\n{\r\ncs->hw.hfc.cip = 0;\r\nreadfifo(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, 0, data, size);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char * data, int size)\r\n{\r\ncs->hw.hfc.cip = 0;\r\nwritefifo(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, 0, data, size);\r\n}\r\nstatic u_char\r\nReadHFC(struct IsdnCardState *cs, int data, u_char reg)\r\n{\r\nregister u_char ret;\r\nif (data) {\r\ncs->hw.hfc.cip = reg;\r\nbyteout(cs->hw.hfc.addr | 1, reg);\r\nret = bytein(cs->hw.hfc.addr);\r\nif (cs->debug & L1_DEB_HSCX_FIFO && (data != 2))\r\ndebugl1(cs, "hfc RD %02x %02x", reg, ret);\r\n} else\r\nret = bytein(cs->hw.hfc.addr | 1);\r\nreturn (ret);\r\n}\r\nstatic void\r\nWriteHFC(struct IsdnCardState *cs, int data, u_char reg, u_char value)\r\n{\r\nbyteout(cs->hw.hfc.addr | 1, reg);\r\ncs->hw.hfc.cip = reg;\r\nif (data)\r\nbyteout(cs->hw.hfc.addr, value);\r\nif (cs->debug & L1_DEB_HSCX_FIFO && (data != 2))\r\ndebugl1(cs, "hfc W%c %02x %02x", data ? 'D' : 'C', reg, value);\r\n}\r\nstatic irqreturn_t\r\nTeleInt_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nval = readreg(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, ISAC_ISTA);\r\nStart_ISAC:\r\nif (val)\r\nisac_interrupt(cs, val);\r\nval = readreg(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, ISAC_ISTA);\r\nif (val) {\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "ISAC IntStat after IntRoutine");\r\ngoto Start_ISAC;\r\n}\r\nwritereg(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, ISAC_MASK, 0xFF);\r\nwritereg(cs->hw.hfc.addr | 1, cs->hw.hfc.addr, ISAC_MASK, 0x0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nTeleInt_Timer(struct IsdnCardState *cs)\r\n{\r\nint stat = 0;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nif (cs->bcs[0].mode) {\r\nstat |= 1;\r\nmain_irq_hfc(&cs->bcs[0]);\r\n}\r\nif (cs->bcs[1].mode) {\r\nstat |= 2;\r\nmain_irq_hfc(&cs->bcs[1]);\r\n}\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nstat = HZ/100;\r\nif (!stat)\r\nstat = 1;\r\ncs->hw.hfc.timer.expires = jiffies + stat;\r\nadd_timer(&cs->hw.hfc.timer);\r\n}\r\nstatic void\r\nrelease_io_TeleInt(struct IsdnCardState *cs)\r\n{\r\ndel_timer(&cs->hw.hfc.timer);\r\nreleasehfc(cs);\r\nif (cs->hw.hfc.addr)\r\nrelease_region(cs->hw.hfc.addr, 2);\r\n}\r\nstatic void\r\nreset_TeleInt(struct IsdnCardState *cs)\r\n{\r\nprintk(KERN_INFO "TeleInt: resetting card\n");\r\ncs->hw.hfc.cirm |= HFC_RESET;\r\nbyteout(cs->hw.hfc.addr | 1, cs->hw.hfc.cirm);\r\nmdelay(10);\r\ncs->hw.hfc.cirm &= ~HFC_RESET;\r\nbyteout(cs->hw.hfc.addr | 1, cs->hw.hfc.cirm);\r\nmdelay(10);\r\n}\r\nstatic int\r\nTeleInt_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nint delay;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_TeleInt(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_RELEASE:\r\nrelease_io_TeleInt(cs);\r\nreturn(0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_TeleInt(cs);\r\ninithfc(cs);\r\nclear_pending_isac_ints(cs);\r\ninitisac(cs);\r\ncs->writeisac(cs, ISAC_MASK, 0);\r\ncs->writeisac(cs, ISAC_CMDR, 0x41);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\ndelay = HZ/100;\r\nif (!delay)\r\ndelay = 1;\r\ncs->hw.hfc.timer.expires = jiffies + delay;\r\nadd_timer(&cs->hw.hfc.timer);\r\nreturn(0);\r\ncase CARD_TEST:\r\nreturn(0);\r\n}\r\nreturn(0);\r\n}\r\nint __devinit\r\nsetup_TeleInt(struct IsdnCard *card)\r\n{\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, TeleInt_revision);\r\nprintk(KERN_INFO "HiSax: TeleInt driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_TELEINT)\r\nreturn (0);\r\ncs->hw.hfc.addr = card->para[1] & 0x3fe;\r\ncs->irq = card->para[0];\r\ncs->hw.hfc.cirm = HFC_CIRM;\r\ncs->hw.hfc.isac_spcr = 0x00;\r\ncs->hw.hfc.cip = 0;\r\ncs->hw.hfc.ctmt = HFC_CTMT | HFC_CLTIMER;\r\ncs->bcs[0].hw.hfc.send = NULL;\r\ncs->bcs[1].hw.hfc.send = NULL;\r\ncs->hw.hfc.fifosize = 7 * 1024 + 512;\r\ncs->hw.hfc.timer.function = (void *) TeleInt_Timer;\r\ncs->hw.hfc.timer.data = (long) cs;\r\ninit_timer(&cs->hw.hfc.timer);\r\nif (!request_region(cs->hw.hfc.addr, 2, "TeleInt isdn")) {\r\nprintk(KERN_WARNING\r\n"HiSax: TeleInt config port %x-%x already in use\n",\r\ncs->hw.hfc.addr,\r\ncs->hw.hfc.addr + 2);\r\nreturn (0);\r\n}\r\nbyteout(cs->hw.hfc.addr, cs->hw.hfc.addr & 0xff);\r\nbyteout(cs->hw.hfc.addr | 1, ((cs->hw.hfc.addr & 0x300) >> 8) | 0x54);\r\nswitch (cs->irq) {\r\ncase 3:\r\ncs->hw.hfc.cirm |= HFC_INTA;\r\nbreak;\r\ncase 4:\r\ncs->hw.hfc.cirm |= HFC_INTB;\r\nbreak;\r\ncase 5:\r\ncs->hw.hfc.cirm |= HFC_INTC;\r\nbreak;\r\ncase 7:\r\ncs->hw.hfc.cirm |= HFC_INTD;\r\nbreak;\r\ncase 10:\r\ncs->hw.hfc.cirm |= HFC_INTE;\r\nbreak;\r\ncase 11:\r\ncs->hw.hfc.cirm |= HFC_INTF;\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "TeleInt: wrong IRQ\n");\r\nrelease_io_TeleInt(cs);\r\nreturn (0);\r\n}\r\nbyteout(cs->hw.hfc.addr | 1, cs->hw.hfc.cirm);\r\nbyteout(cs->hw.hfc.addr | 1, cs->hw.hfc.ctmt);\r\nprintk(KERN_INFO "TeleInt: defined at 0x%x IRQ %d\n",\r\ncs->hw.hfc.addr, cs->irq);\r\nsetup_isac(cs);\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadHFC;\r\ncs->BC_Write_Reg = &WriteHFC;\r\ncs->cardmsg = &TeleInt_card_msg;\r\ncs->irq_func = &TeleInt_interrupt;\r\nISACVersion(cs, "TeleInt:");\r\nreturn (1);\r\n}

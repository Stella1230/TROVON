static int em3027_get_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nunsigned char addr = EM3027_REG_WATCH_SEC;\r\nunsigned char buf[7];\r\nstruct i2c_msg msgs[] = {\r\n{client->addr, 0, 1, &addr},\r\n{client->addr, I2C_M_RD, 7, buf},\r\n};\r\nif ((i2c_transfer(client->adapter, &msgs[0], 2)) != 2) {\r\ndev_err(&client->dev, "%s: read error\n", __func__);\r\nreturn -EIO;\r\n}\r\ntm->tm_sec = bcd2bin(buf[0]);\r\ntm->tm_min = bcd2bin(buf[1]);\r\ntm->tm_hour = bcd2bin(buf[2]);\r\ntm->tm_mday = bcd2bin(buf[3]);\r\ntm->tm_wday = bcd2bin(buf[4]);\r\ntm->tm_mon = bcd2bin(buf[5]);\r\ntm->tm_year = bcd2bin(buf[6]) + 100;\r\nreturn 0;\r\n}\r\nstatic int em3027_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nunsigned char buf[8];\r\nstruct i2c_msg msg = {\r\nclient->addr, 0, 8, buf,\r\n};\r\nbuf[0] = EM3027_REG_WATCH_SEC;\r\nbuf[1] = bin2bcd(tm->tm_sec);\r\nbuf[2] = bin2bcd(tm->tm_min);\r\nbuf[3] = bin2bcd(tm->tm_hour);\r\nbuf[4] = bin2bcd(tm->tm_mday);\r\nbuf[5] = bin2bcd(tm->tm_wday);\r\nbuf[6] = bin2bcd(tm->tm_mon);\r\nbuf[7] = bin2bcd(tm->tm_year % 100);\r\nif ((i2c_transfer(client->adapter, &msg, 1)) != 1) {\r\ndev_err(&client->dev, "%s: write error\n", __func__);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int em3027_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct rtc_device *rtc;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\nrtc = rtc_device_register(em3027_driver.driver.name, &client->dev,\r\n&em3027_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\ni2c_set_clientdata(client, rtc);\r\nreturn 0;\r\n}\r\nstatic int em3027_remove(struct i2c_client *client)\r\n{\r\nstruct rtc_device *rtc = i2c_get_clientdata(client);\r\nif (rtc)\r\nrtc_device_unregister(rtc);\r\nreturn 0;\r\n}\r\nstatic int __init em3027_init(void)\r\n{\r\nreturn i2c_add_driver(&em3027_driver);\r\n}\r\nstatic void __exit em3027_exit(void)\r\n{\r\ni2c_del_driver(&em3027_driver);\r\n}

static u32 pmc_read(unsigned long reg)\r\n{\r\nreturn readl(pmc + reg);\r\n}\r\nstatic void pmc_write(u32 val, unsigned long reg)\r\n{\r\nwritel(val, pmc + reg);\r\n}\r\nstatic int tegra_powergate_set(int id, bool new_state)\r\n{\r\nbool status;\r\nunsigned long flags;\r\nspin_lock_irqsave(&tegra_powergate_lock, flags);\r\nstatus = pmc_read(PWRGATE_STATUS) & (1 << id);\r\nif (status == new_state) {\r\nspin_unlock_irqrestore(&tegra_powergate_lock, flags);\r\nreturn -EINVAL;\r\n}\r\npmc_write(PWRGATE_TOGGLE_START | id, PWRGATE_TOGGLE);\r\nspin_unlock_irqrestore(&tegra_powergate_lock, flags);\r\nreturn 0;\r\n}\r\nint tegra_powergate_power_on(int id)\r\n{\r\nif (id < 0 || id >= TEGRA_NUM_POWERGATE)\r\nreturn -EINVAL;\r\nreturn tegra_powergate_set(id, true);\r\n}\r\nint tegra_powergate_power_off(int id)\r\n{\r\nif (id < 0 || id >= TEGRA_NUM_POWERGATE)\r\nreturn -EINVAL;\r\nreturn tegra_powergate_set(id, false);\r\n}\r\nstatic bool tegra_powergate_is_powered(int id)\r\n{\r\nu32 status;\r\nWARN_ON(id < 0 || id >= TEGRA_NUM_POWERGATE);\r\nstatus = pmc_read(PWRGATE_STATUS) & (1 << id);\r\nreturn !!status;\r\n}\r\nint tegra_powergate_remove_clamping(int id)\r\n{\r\nu32 mask;\r\nif (id < 0 || id >= TEGRA_NUM_POWERGATE)\r\nreturn -EINVAL;\r\nif (id == TEGRA_POWERGATE_VDEC)\r\nmask = (1 << TEGRA_POWERGATE_PCIE);\r\nelse if (id == TEGRA_POWERGATE_PCIE)\r\nmask = (1 << TEGRA_POWERGATE_VDEC);\r\nelse\r\nmask = (1 << id);\r\npmc_write(mask, REMOVE_CLAMPING);\r\nreturn 0;\r\n}\r\nint tegra_powergate_sequence_power_up(int id, struct clk *clk)\r\n{\r\nint ret;\r\ntegra_periph_reset_assert(clk);\r\nret = tegra_powergate_power_on(id);\r\nif (ret)\r\ngoto err_power;\r\nret = clk_enable(clk);\r\nif (ret)\r\ngoto err_clk;\r\nudelay(10);\r\nret = tegra_powergate_remove_clamping(id);\r\nif (ret)\r\ngoto err_clamp;\r\nudelay(10);\r\ntegra_periph_reset_deassert(clk);\r\nreturn 0;\r\nerr_clamp:\r\nclk_disable(clk);\r\nerr_clk:\r\ntegra_powergate_power_off(id);\r\nerr_power:\r\nreturn ret;\r\n}\r\nstatic int powergate_show(struct seq_file *s, void *data)\r\n{\r\nint i;\r\nseq_printf(s, " powergate powered\n");\r\nseq_printf(s, "------------------\n");\r\nfor (i = 0; i < TEGRA_NUM_POWERGATE; i++)\r\nseq_printf(s, " %9s %7s\n", powergate_name[i],\r\ntegra_powergate_is_powered(i) ? "yes" : "no");\r\nreturn 0;\r\n}\r\nstatic int powergate_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, powergate_show, inode->i_private);\r\n}\r\nstatic int __init powergate_debugfs_init(void)\r\n{\r\nstruct dentry *d;\r\nint err = -ENOMEM;\r\nd = debugfs_create_file("powergate", S_IRUGO, NULL, NULL,\r\n&powergate_fops);\r\nif (!d)\r\nreturn -ENOMEM;\r\nreturn err;\r\n}

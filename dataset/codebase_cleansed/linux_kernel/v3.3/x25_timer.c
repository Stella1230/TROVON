void x25_init_timers(struct sock *sk)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nsetup_timer(&x25->timer, x25_timer_expiry, (unsigned long)sk);\r\nsk->sk_timer.data = (unsigned long)sk;\r\nsk->sk_timer.function = &x25_heartbeat_expiry;\r\n}\r\nvoid x25_start_heartbeat(struct sock *sk)\r\n{\r\nmod_timer(&sk->sk_timer, jiffies + 5 * HZ);\r\n}\r\nvoid x25_stop_heartbeat(struct sock *sk)\r\n{\r\ndel_timer(&sk->sk_timer);\r\n}\r\nvoid x25_start_t2timer(struct sock *sk)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nmod_timer(&x25->timer, jiffies + x25->t2);\r\n}\r\nvoid x25_start_t21timer(struct sock *sk)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nmod_timer(&x25->timer, jiffies + x25->t21);\r\n}\r\nvoid x25_start_t22timer(struct sock *sk)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nmod_timer(&x25->timer, jiffies + x25->t22);\r\n}\r\nvoid x25_start_t23timer(struct sock *sk)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nmod_timer(&x25->timer, jiffies + x25->t23);\r\n}\r\nvoid x25_stop_timer(struct sock *sk)\r\n{\r\ndel_timer(&x25_sk(sk)->timer);\r\n}\r\nunsigned long x25_display_timer(struct sock *sk)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nif (!timer_pending(&x25->timer))\r\nreturn 0;\r\nreturn x25->timer.expires - jiffies;\r\n}\r\nstatic void x25_heartbeat_expiry(unsigned long param)\r\n{\r\nstruct sock *sk = (struct sock *)param;\r\nbh_lock_sock(sk);\r\nif (sock_owned_by_user(sk))\r\ngoto restart_heartbeat;\r\nswitch (x25_sk(sk)->state) {\r\ncase X25_STATE_0:\r\nif (sock_flag(sk, SOCK_DESTROY) ||\r\n(sk->sk_state == TCP_LISTEN &&\r\nsock_flag(sk, SOCK_DEAD))) {\r\nbh_unlock_sock(sk);\r\nx25_destroy_socket_from_timer(sk);\r\nreturn;\r\n}\r\nbreak;\r\ncase X25_STATE_3:\r\nx25_check_rbuf(sk);\r\nbreak;\r\n}\r\nrestart_heartbeat:\r\nx25_start_heartbeat(sk);\r\nbh_unlock_sock(sk);\r\n}\r\nstatic inline void x25_do_timer_expiry(struct sock * sk)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nswitch (x25->state) {\r\ncase X25_STATE_3:\r\nif (x25->condition & X25_COND_ACK_PENDING) {\r\nx25->condition &= ~X25_COND_ACK_PENDING;\r\nx25_enquiry_response(sk);\r\n}\r\nbreak;\r\ncase X25_STATE_1:\r\ncase X25_STATE_4:\r\nx25_write_internal(sk, X25_CLEAR_REQUEST);\r\nx25->state = X25_STATE_2;\r\nx25_start_t23timer(sk);\r\nbreak;\r\ncase X25_STATE_2:\r\nx25_disconnect(sk, ETIMEDOUT, 0, 0);\r\nbreak;\r\n}\r\n}\r\nstatic void x25_timer_expiry(unsigned long param)\r\n{\r\nstruct sock *sk = (struct sock *)param;\r\nbh_lock_sock(sk);\r\nif (sock_owned_by_user(sk)) {\r\nif (x25_sk(sk)->state == X25_STATE_3)\r\nx25_start_t2timer(sk);\r\n} else\r\nx25_do_timer_expiry(sk);\r\nbh_unlock_sock(sk);\r\n}

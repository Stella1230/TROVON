int snd_vx_setup_firmware(struct vx_core *chip)\r\n{\r\nstatic char *fw_files[VX_TYPE_NUMS][4] = {\r\n[VX_TYPE_BOARD] = {\r\nNULL, "x1_1_vx2.xlx", "bd56002.boot", "l_1_vx2.d56",\r\n},\r\n[VX_TYPE_V2] = {\r\nNULL, "x1_2_v22.xlx", "bd563v2.boot", "l_1_v22.d56",\r\n},\r\n[VX_TYPE_MIC] = {\r\nNULL, "x1_2_v22.xlx", "bd563v2.boot", "l_1_v22.d56",\r\n},\r\n[VX_TYPE_VXPOCKET] = {\r\n"bx_1_vxp.b56", "x1_1_vxp.xlx", "bd563s3.boot", "l_1_vxp.d56"\r\n},\r\n[VX_TYPE_VXP440] = {\r\n"bx_1_vp4.b56", "x1_1_vp4.xlx", "bd563s3.boot", "l_1_vp4.d56"\r\n},\r\n};\r\nint i, err;\r\nfor (i = 0; i < 4; i++) {\r\nchar path[32];\r\nconst struct firmware *fw;\r\nif (! fw_files[chip->type][i])\r\ncontinue;\r\nsprintf(path, "vx/%s", fw_files[chip->type][i]);\r\nif (request_firmware(&fw, path, chip->dev)) {\r\nsnd_printk(KERN_ERR "vx: can't load firmware %s\n", path);\r\nreturn -ENOENT;\r\n}\r\nerr = chip->ops->load_dsp(chip, i, fw);\r\nif (err < 0) {\r\nrelease_firmware(fw);\r\nreturn err;\r\n}\r\nif (i == 1)\r\nchip->chip_status |= VX_STAT_XILINX_LOADED;\r\n#ifdef CONFIG_PM\r\nchip->firmware[i] = fw;\r\n#else\r\nrelease_firmware(fw);\r\n#endif\r\n}\r\nif ((err = snd_vx_pcm_new(chip)) < 0)\r\nreturn err;\r\nif ((err = snd_vx_mixer_new(chip)) < 0)\r\nreturn err;\r\nif (chip->ops->add_controls)\r\nif ((err = chip->ops->add_controls(chip)) < 0)\r\nreturn err;\r\nchip->chip_status |= VX_STAT_DEVICE_INIT;\r\nchip->chip_status |= VX_STAT_CHIP_INIT;\r\nreturn snd_card_register(chip->card);\r\n}\r\nvoid snd_vx_free_firmware(struct vx_core *chip)\r\n{\r\n#ifdef CONFIG_PM\r\nint i;\r\nfor (i = 0; i < 4; i++)\r\nrelease_firmware(chip->firmware[i]);\r\n#endif\r\n}\r\nstatic int vx_hwdep_dsp_status(struct snd_hwdep *hw,\r\nstruct snd_hwdep_dsp_status *info)\r\n{\r\nstatic char *type_ids[VX_TYPE_NUMS] = {\r\n[VX_TYPE_BOARD] = "vxboard",\r\n[VX_TYPE_V2] = "vx222",\r\n[VX_TYPE_MIC] = "vx222",\r\n[VX_TYPE_VXPOCKET] = "vxpocket",\r\n[VX_TYPE_VXP440] = "vxp440",\r\n};\r\nstruct vx_core *vx = hw->private_data;\r\nif (snd_BUG_ON(!type_ids[vx->type]))\r\nreturn -EINVAL;\r\nstrcpy(info->id, type_ids[vx->type]);\r\nif (vx_is_pcmcia(vx))\r\ninfo->num_dsps = 4;\r\nelse\r\ninfo->num_dsps = 3;\r\nif (vx->chip_status & VX_STAT_CHIP_INIT)\r\ninfo->chip_ready = 1;\r\ninfo->version = VX_DRIVER_VERSION;\r\nreturn 0;\r\n}\r\nstatic void free_fw(const struct firmware *fw)\r\n{\r\nif (fw) {\r\nvfree(fw->data);\r\nkfree(fw);\r\n}\r\n}\r\nstatic int vx_hwdep_dsp_load(struct snd_hwdep *hw,\r\nstruct snd_hwdep_dsp_image *dsp)\r\n{\r\nstruct vx_core *vx = hw->private_data;\r\nint index, err;\r\nstruct firmware *fw;\r\nif (snd_BUG_ON(!vx->ops->load_dsp))\r\nreturn -ENXIO;\r\nfw = kmalloc(sizeof(*fw), GFP_KERNEL);\r\nif (! fw) {\r\nsnd_printk(KERN_ERR "cannot allocate firmware\n");\r\nreturn -ENOMEM;\r\n}\r\nfw->size = dsp->length;\r\nfw->data = vmalloc(fw->size);\r\nif (! fw->data) {\r\nsnd_printk(KERN_ERR "cannot allocate firmware image (length=%d)\n",\r\n(int)fw->size);\r\nkfree(fw);\r\nreturn -ENOMEM;\r\n}\r\nif (copy_from_user((void *)fw->data, dsp->image, dsp->length)) {\r\nfree_fw(fw);\r\nreturn -EFAULT;\r\n}\r\nindex = dsp->index;\r\nif (! vx_is_pcmcia(vx))\r\nindex++;\r\nerr = vx->ops->load_dsp(vx, index, fw);\r\nif (err < 0) {\r\nfree_fw(fw);\r\nreturn err;\r\n}\r\n#ifdef CONFIG_PM\r\nvx->firmware[index] = fw;\r\n#else\r\nfree_fw(fw);\r\n#endif\r\nif (index == 1)\r\nvx->chip_status |= VX_STAT_XILINX_LOADED;\r\nif (index < 3)\r\nreturn 0;\r\nif (! (vx->chip_status & VX_STAT_DEVICE_INIT)) {\r\nif ((err = snd_vx_pcm_new(vx)) < 0)\r\nreturn err;\r\nif ((err = snd_vx_mixer_new(vx)) < 0)\r\nreturn err;\r\nif (vx->ops->add_controls)\r\nif ((err = vx->ops->add_controls(vx)) < 0)\r\nreturn err;\r\nif ((err = snd_card_register(vx->card)) < 0)\r\nreturn err;\r\nvx->chip_status |= VX_STAT_DEVICE_INIT;\r\n}\r\nvx->chip_status |= VX_STAT_CHIP_INIT;\r\nreturn 0;\r\n}\r\nint snd_vx_setup_firmware(struct vx_core *chip)\r\n{\r\nint err;\r\nstruct snd_hwdep *hw;\r\nif ((err = snd_hwdep_new(chip->card, SND_VX_HWDEP_ID, 0, &hw)) < 0)\r\nreturn err;\r\nhw->iface = SNDRV_HWDEP_IFACE_VX;\r\nhw->private_data = chip;\r\nhw->ops.dsp_status = vx_hwdep_dsp_status;\r\nhw->ops.dsp_load = vx_hwdep_dsp_load;\r\nhw->exclusive = 1;\r\nsprintf(hw->name, "VX Loader (%s)", chip->card->driver);\r\nchip->hwdep = hw;\r\nreturn snd_card_register(chip->card);\r\n}\r\nvoid snd_vx_free_firmware(struct vx_core *chip)\r\n{\r\n#ifdef CONFIG_PM\r\nint i;\r\nfor (i = 0; i < 4; i++)\r\nfree_fw(chip->firmware[i]);\r\n#endif\r\n}

const struct zorro_device_id *\r\nzorro_match_device(const struct zorro_device_id *ids,\r\nconst struct zorro_dev *z)\r\n{\r\nwhile (ids->id) {\r\nif (ids->id == ZORRO_WILDCARD || ids->id == z->id)\r\nreturn ids;\r\nids++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int zorro_device_probe(struct device *dev)\r\n{\r\nint error = 0;\r\nstruct zorro_driver *drv = to_zorro_driver(dev->driver);\r\nstruct zorro_dev *z = to_zorro_dev(dev);\r\nif (!z->driver && drv->probe) {\r\nconst struct zorro_device_id *id;\r\nid = zorro_match_device(drv->id_table, z);\r\nif (id)\r\nerror = drv->probe(z, id);\r\nif (error >= 0) {\r\nz->driver = drv;\r\nerror = 0;\r\n}\r\n}\r\nreturn error;\r\n}\r\nstatic int zorro_device_remove(struct device *dev)\r\n{\r\nstruct zorro_dev *z = to_zorro_dev(dev);\r\nstruct zorro_driver *drv = to_zorro_driver(dev->driver);\r\nif (drv) {\r\nif (drv->remove)\r\ndrv->remove(z);\r\nz->driver = NULL;\r\n}\r\nreturn 0;\r\n}\r\nint zorro_register_driver(struct zorro_driver *drv)\r\n{\r\ndrv->driver.name = drv->name;\r\ndrv->driver.bus = &zorro_bus_type;\r\nreturn driver_register(&drv->driver);\r\n}\r\nvoid zorro_unregister_driver(struct zorro_driver *drv)\r\n{\r\ndriver_unregister(&drv->driver);\r\n}\r\nstatic int zorro_bus_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct zorro_dev *z = to_zorro_dev(dev);\r\nstruct zorro_driver *zorro_drv = to_zorro_driver(drv);\r\nconst struct zorro_device_id *ids = zorro_drv->id_table;\r\nif (!ids)\r\nreturn 0;\r\nwhile (ids->id) {\r\nif (ids->id == ZORRO_WILDCARD || ids->id == z->id)\r\nreturn 1;\r\nids++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int zorro_uevent(struct device *dev, struct kobj_uevent_env *env)\r\n{\r\n#ifdef CONFIG_HOTPLUG\r\nstruct zorro_dev *z;\r\nif (!dev)\r\nreturn -ENODEV;\r\nz = to_zorro_dev(dev);\r\nif (!z)\r\nreturn -ENODEV;\r\nif (add_uevent_var(env, "ZORRO_ID=%08X", z->id) ||\r\nadd_uevent_var(env, "ZORRO_SLOT_NAME=%s", dev_name(dev)) ||\r\nadd_uevent_var(env, "ZORRO_SLOT_ADDR=%04X", z->slotaddr) ||\r\nadd_uevent_var(env, "MODALIAS=" ZORRO_DEVICE_MODALIAS_FMT, z->id))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n#else\r\nreturn -ENODEV;\r\n#endif\r\n}\r\nstatic int __init zorro_driver_init(void)\r\n{\r\nreturn bus_register(&zorro_bus_type);\r\n}

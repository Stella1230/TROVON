static int samsung_bl_init(struct device *dev)\r\n{\r\nint ret = 0;\r\nstruct platform_device *timer_dev =\r\ncontainer_of(dev->parent, struct platform_device, dev);\r\nstruct samsung_bl_gpio_info *bl_gpio_info =\r\ntimer_dev->dev.platform_data;\r\nret = gpio_request(bl_gpio_info->no, "Backlight");\r\nif (ret) {\r\nprintk(KERN_ERR "failed to request GPIO for LCD Backlight\n");\r\nreturn ret;\r\n}\r\ns3c_gpio_cfgpin(bl_gpio_info->no, bl_gpio_info->func);\r\nreturn 0;\r\n}\r\nstatic void samsung_bl_exit(struct device *dev)\r\n{\r\nstruct platform_device *timer_dev =\r\ncontainer_of(dev->parent, struct platform_device, dev);\r\nstruct samsung_bl_gpio_info *bl_gpio_info =\r\ntimer_dev->dev.platform_data;\r\ns3c_gpio_cfgpin(bl_gpio_info->no, S3C_GPIO_OUTPUT);\r\ngpio_free(bl_gpio_info->no);\r\n}\r\nvoid samsung_bl_set(struct samsung_bl_gpio_info *gpio_info,\r\nstruct platform_pwm_backlight_data *bl_data)\r\n{\r\nint ret = 0;\r\nstruct platform_device *samsung_bl_device;\r\nstruct platform_pwm_backlight_data *samsung_bl_data;\r\nsamsung_bl_device = kmemdup(&samsung_dfl_bl_device,\r\nsizeof(struct platform_device), GFP_KERNEL);\r\nif (!samsung_bl_device) {\r\nprintk(KERN_ERR "%s: no memory for platform dev\n", __func__);\r\nreturn;\r\n}\r\nsamsung_bl_data = s3c_set_platdata(&samsung_dfl_bl_data,\r\nsizeof(struct platform_pwm_backlight_data), samsung_bl_device);\r\nif (!samsung_bl_data) {\r\nprintk(KERN_ERR "%s: no memory for platform dev\n", __func__);\r\ngoto err_data;\r\n}\r\nsamsung_bl_data->pwm_id = bl_data->pwm_id;\r\nsamsung_bl_device->dev.parent =\r\n&s3c_device_timer[samsung_bl_data->pwm_id].dev;\r\nif (bl_data->max_brightness)\r\nsamsung_bl_data->max_brightness = bl_data->max_brightness;\r\nif (bl_data->dft_brightness)\r\nsamsung_bl_data->dft_brightness = bl_data->dft_brightness;\r\nif (bl_data->lth_brightness)\r\nsamsung_bl_data->lth_brightness = bl_data->lth_brightness;\r\nif (bl_data->pwm_period_ns)\r\nsamsung_bl_data->pwm_period_ns = bl_data->pwm_period_ns;\r\nif (bl_data->init)\r\nsamsung_bl_data->init = bl_data->init;\r\nif (bl_data->notify)\r\nsamsung_bl_data->notify = bl_data->notify;\r\nif (bl_data->exit)\r\nsamsung_bl_data->exit = bl_data->exit;\r\nif (bl_data->check_fb)\r\nsamsung_bl_data->check_fb = bl_data->check_fb;\r\ns3c_device_timer[samsung_bl_data->pwm_id].dev.platform_data = gpio_info;\r\nret = platform_device_register(\r\n&s3c_device_timer[samsung_bl_data->pwm_id]);\r\nif (ret) {\r\nprintk(KERN_ERR "failed to register pwm timer for backlight: %d\n", ret);\r\ngoto err_plat_reg1;\r\n}\r\nret = platform_device_register(samsung_bl_device);\r\nif (ret) {\r\nprintk(KERN_ERR "failed to register backlight device: %d\n", ret);\r\ngoto err_plat_reg2;\r\n}\r\nreturn;\r\nerr_plat_reg2:\r\nplatform_device_unregister(&s3c_device_timer[samsung_bl_data->pwm_id]);\r\nerr_plat_reg1:\r\nkfree(samsung_bl_data);\r\nerr_data:\r\nkfree(samsung_bl_device);\r\nreturn;\r\n}

int ocfs2_dir_resv_allowed(struct ocfs2_super *osb)\r\n{\r\nreturn (osb->osb_resv_level && osb->osb_dir_resv_level);\r\n}\r\nstatic unsigned int ocfs2_resv_window_bits(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv)\r\n{\r\nstruct ocfs2_super *osb = resmap->m_osb;\r\nunsigned int bits;\r\nif (!(resv->r_flags & OCFS2_RESV_FLAG_DIR)) {\r\nbits = 4 << osb->osb_resv_level;\r\n} else {\r\nbits = 4 << osb->osb_dir_resv_level;\r\n}\r\nreturn bits;\r\n}\r\nstatic inline unsigned int ocfs2_resv_end(struct ocfs2_alloc_reservation *resv)\r\n{\r\nif (resv->r_len)\r\nreturn resv->r_start + resv->r_len - 1;\r\nreturn resv->r_start;\r\n}\r\nstatic inline int ocfs2_resv_empty(struct ocfs2_alloc_reservation *resv)\r\n{\r\nreturn !!(resv->r_len == 0);\r\n}\r\nstatic inline int ocfs2_resmap_disabled(struct ocfs2_reservation_map *resmap)\r\n{\r\nif (resmap->m_osb->osb_resv_level == 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void ocfs2_dump_resv(struct ocfs2_reservation_map *resmap)\r\n{\r\nstruct ocfs2_super *osb = resmap->m_osb;\r\nstruct rb_node *node;\r\nstruct ocfs2_alloc_reservation *resv;\r\nint i = 0;\r\nmlog(ML_NOTICE, "Dumping resmap for device %s. Bitmap length: %u\n",\r\nosb->dev_str, resmap->m_bitmap_len);\r\nnode = rb_first(&resmap->m_reservations);\r\nwhile (node) {\r\nresv = rb_entry(node, struct ocfs2_alloc_reservation, r_node);\r\nmlog(ML_NOTICE, "start: %u\tend: %u\tlen: %u\tlast_start: %u"\r\n"\tlast_len: %u\n", resv->r_start,\r\nocfs2_resv_end(resv), resv->r_len, resv->r_last_start,\r\nresv->r_last_len);\r\nnode = rb_next(node);\r\ni++;\r\n}\r\nmlog(ML_NOTICE, "%d reservations found. LRU follows\n", i);\r\ni = 0;\r\nlist_for_each_entry(resv, &resmap->m_lru, r_lru) {\r\nmlog(ML_NOTICE, "LRU(%d) start: %u\tend: %u\tlen: %u\t"\r\n"last_start: %u\tlast_len: %u\n", i, resv->r_start,\r\nocfs2_resv_end(resv), resv->r_len, resv->r_last_start,\r\nresv->r_last_len);\r\ni++;\r\n}\r\n}\r\nstatic int ocfs2_validate_resmap_bits(struct ocfs2_reservation_map *resmap,\r\nint i,\r\nstruct ocfs2_alloc_reservation *resv)\r\n{\r\nchar *disk_bitmap = resmap->m_disk_bitmap;\r\nunsigned int start = resv->r_start;\r\nunsigned int end = ocfs2_resv_end(resv);\r\nwhile (start <= end) {\r\nif (ocfs2_test_bit(start, disk_bitmap)) {\r\nmlog(ML_ERROR,\r\n"reservation %d covers an allocated area "\r\n"starting at bit %u!\n", i, start);\r\nreturn 1;\r\n}\r\nstart++;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ocfs2_check_resmap(struct ocfs2_reservation_map *resmap)\r\n{\r\nunsigned int off = 0;\r\nint i = 0;\r\nstruct rb_node *node;\r\nstruct ocfs2_alloc_reservation *resv;\r\nnode = rb_first(&resmap->m_reservations);\r\nwhile (node) {\r\nresv = rb_entry(node, struct ocfs2_alloc_reservation, r_node);\r\nif (i > 0 && resv->r_start <= off) {\r\nmlog(ML_ERROR, "reservation %d has bad start off!\n",\r\ni);\r\ngoto bad;\r\n}\r\nif (resv->r_len == 0) {\r\nmlog(ML_ERROR, "reservation %d has no length!\n",\r\ni);\r\ngoto bad;\r\n}\r\nif (resv->r_start > ocfs2_resv_end(resv)) {\r\nmlog(ML_ERROR, "reservation %d has invalid range!\n",\r\ni);\r\ngoto bad;\r\n}\r\nif (ocfs2_resv_end(resv) >= resmap->m_bitmap_len) {\r\nmlog(ML_ERROR, "reservation %d extends past bitmap!\n",\r\ni);\r\ngoto bad;\r\n}\r\nif (ocfs2_validate_resmap_bits(resmap, i, resv))\r\ngoto bad;\r\noff = ocfs2_resv_end(resv);\r\nnode = rb_next(node);\r\ni++;\r\n}\r\nreturn;\r\nbad:\r\nocfs2_dump_resv(resmap);\r\nBUG();\r\n}\r\nstatic inline void ocfs2_check_resmap(struct ocfs2_reservation_map *resmap)\r\n{\r\n}\r\nvoid ocfs2_resv_init_once(struct ocfs2_alloc_reservation *resv)\r\n{\r\nmemset(resv, 0, sizeof(*resv));\r\nINIT_LIST_HEAD(&resv->r_lru);\r\n}\r\nvoid ocfs2_resv_set_type(struct ocfs2_alloc_reservation *resv,\r\nunsigned int flags)\r\n{\r\nBUG_ON(flags & ~OCFS2_RESV_TYPES);\r\nresv->r_flags |= flags;\r\n}\r\nint ocfs2_resmap_init(struct ocfs2_super *osb,\r\nstruct ocfs2_reservation_map *resmap)\r\n{\r\nmemset(resmap, 0, sizeof(*resmap));\r\nresmap->m_osb = osb;\r\nresmap->m_reservations = RB_ROOT;\r\nINIT_LIST_HEAD(&resmap->m_lru);\r\nreturn 0;\r\n}\r\nstatic void ocfs2_resv_mark_lru(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv)\r\n{\r\nassert_spin_locked(&resv_lock);\r\nif (!list_empty(&resv->r_lru))\r\nlist_del_init(&resv->r_lru);\r\nlist_add_tail(&resv->r_lru, &resmap->m_lru);\r\n}\r\nstatic void __ocfs2_resv_trunc(struct ocfs2_alloc_reservation *resv)\r\n{\r\nresv->r_len = 0;\r\nresv->r_start = 0;\r\n}\r\nstatic void ocfs2_resv_remove(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv)\r\n{\r\nif (resv->r_flags & OCFS2_RESV_FLAG_INUSE) {\r\nlist_del_init(&resv->r_lru);\r\nrb_erase(&resv->r_node, &resmap->m_reservations);\r\nresv->r_flags &= ~OCFS2_RESV_FLAG_INUSE;\r\n}\r\n}\r\nstatic void __ocfs2_resv_discard(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv)\r\n{\r\nassert_spin_locked(&resv_lock);\r\n__ocfs2_resv_trunc(resv);\r\nresv->r_last_len = resv->r_last_start = 0;\r\nocfs2_resv_remove(resmap, resv);\r\n}\r\nvoid ocfs2_resv_discard(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv)\r\n{\r\nif (resv) {\r\nspin_lock(&resv_lock);\r\n__ocfs2_resv_discard(resmap, resv);\r\nspin_unlock(&resv_lock);\r\n}\r\n}\r\nstatic void ocfs2_resmap_clear_all_resv(struct ocfs2_reservation_map *resmap)\r\n{\r\nstruct rb_node *node;\r\nstruct ocfs2_alloc_reservation *resv;\r\nassert_spin_locked(&resv_lock);\r\nwhile ((node = rb_last(&resmap->m_reservations)) != NULL) {\r\nresv = rb_entry(node, struct ocfs2_alloc_reservation, r_node);\r\n__ocfs2_resv_discard(resmap, resv);\r\n}\r\n}\r\nvoid ocfs2_resmap_restart(struct ocfs2_reservation_map *resmap,\r\nunsigned int clen, char *disk_bitmap)\r\n{\r\nif (ocfs2_resmap_disabled(resmap))\r\nreturn;\r\nspin_lock(&resv_lock);\r\nocfs2_resmap_clear_all_resv(resmap);\r\nresmap->m_bitmap_len = clen;\r\nresmap->m_disk_bitmap = disk_bitmap;\r\nspin_unlock(&resv_lock);\r\n}\r\nvoid ocfs2_resmap_uninit(struct ocfs2_reservation_map *resmap)\r\n{\r\n}\r\nstatic void ocfs2_resv_insert(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *new)\r\n{\r\nstruct rb_root *root = &resmap->m_reservations;\r\nstruct rb_node *parent = NULL;\r\nstruct rb_node **p = &root->rb_node;\r\nstruct ocfs2_alloc_reservation *tmp;\r\nassert_spin_locked(&resv_lock);\r\ntrace_ocfs2_resv_insert(new->r_start, new->r_len);\r\nwhile (*p) {\r\nparent = *p;\r\ntmp = rb_entry(parent, struct ocfs2_alloc_reservation, r_node);\r\nif (new->r_start < tmp->r_start) {\r\np = &(*p)->rb_left;\r\nBUG_ON(ocfs2_resv_end(new) >= tmp->r_start);\r\n} else if (new->r_start > ocfs2_resv_end(tmp)) {\r\np = &(*p)->rb_right;\r\n} else {\r\nmlog(ML_ERROR, "Duplicate reservation window!\n");\r\nBUG();\r\n}\r\n}\r\nrb_link_node(&new->r_node, parent, p);\r\nrb_insert_color(&new->r_node, root);\r\nnew->r_flags |= OCFS2_RESV_FLAG_INUSE;\r\nocfs2_resv_mark_lru(resmap, new);\r\nocfs2_check_resmap(resmap);\r\n}\r\nstatic struct ocfs2_alloc_reservation *\r\nocfs2_find_resv_lhs(struct ocfs2_reservation_map *resmap, unsigned int goal)\r\n{\r\nstruct ocfs2_alloc_reservation *resv = NULL;\r\nstruct ocfs2_alloc_reservation *prev_resv = NULL;\r\nstruct rb_node *node = resmap->m_reservations.rb_node;\r\nassert_spin_locked(&resv_lock);\r\nif (!node)\r\nreturn NULL;\r\nnode = rb_first(&resmap->m_reservations);\r\nwhile (node) {\r\nresv = rb_entry(node, struct ocfs2_alloc_reservation, r_node);\r\nif (resv->r_start <= goal && ocfs2_resv_end(resv) >= goal)\r\nbreak;\r\nif (resv->r_start > goal) {\r\nresv = prev_resv;\r\nbreak;\r\n}\r\nprev_resv = resv;\r\nnode = rb_next(node);\r\n}\r\nreturn resv;\r\n}\r\nstatic int ocfs2_resmap_find_free_bits(struct ocfs2_reservation_map *resmap,\r\nunsigned int wanted,\r\nunsigned int search_start,\r\nunsigned int search_len,\r\nunsigned int *rstart,\r\nunsigned int *rlen)\r\n{\r\nvoid *bitmap = resmap->m_disk_bitmap;\r\nunsigned int best_start, best_len = 0;\r\nint offset, start, found;\r\ntrace_ocfs2_resmap_find_free_bits_begin(search_start, search_len,\r\nwanted, resmap->m_bitmap_len);\r\nfound = best_start = best_len = 0;\r\nstart = search_start;\r\nwhile ((offset = ocfs2_find_next_zero_bit(bitmap, resmap->m_bitmap_len,\r\nstart)) != -1) {\r\nif (offset >= (search_start + search_len))\r\nbreak;\r\nif (offset == start) {\r\nfound++;\r\nstart++;\r\n} else {\r\nfound = 1;\r\nstart = offset + 1;\r\n}\r\nif (found > best_len) {\r\nbest_len = found;\r\nbest_start = start - found;\r\n}\r\nif (found >= wanted)\r\nbreak;\r\n}\r\nif (best_len == 0)\r\nreturn 0;\r\nif (best_len >= wanted)\r\nbest_len = wanted;\r\n*rlen = best_len;\r\n*rstart = best_start;\r\ntrace_ocfs2_resmap_find_free_bits_end(best_start, best_len);\r\nreturn *rlen;\r\n}\r\nstatic void __ocfs2_resv_find_window(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv,\r\nunsigned int goal, unsigned int wanted)\r\n{\r\nstruct rb_root *root = &resmap->m_reservations;\r\nunsigned int gap_start, gap_end, gap_len;\r\nstruct ocfs2_alloc_reservation *prev_resv, *next_resv;\r\nstruct rb_node *prev, *next;\r\nunsigned int cstart, clen;\r\nunsigned int best_start = 0, best_len = 0;\r\ntrace_ocfs2_resv_find_window_begin(resv->r_start, ocfs2_resv_end(resv),\r\ngoal, wanted, RB_EMPTY_ROOT(root));\r\nassert_spin_locked(&resv_lock);\r\nif (RB_EMPTY_ROOT(root)) {\r\nclen = ocfs2_resmap_find_free_bits(resmap, wanted, goal,\r\nresmap->m_bitmap_len - goal,\r\n&cstart, &clen);\r\nBUG_ON(goal == 0 && clen == 0);\r\nif (clen == 0)\r\nreturn;\r\nresv->r_start = cstart;\r\nresv->r_len = clen;\r\nocfs2_resv_insert(resmap, resv);\r\nreturn;\r\n}\r\nprev_resv = ocfs2_find_resv_lhs(resmap, goal);\r\nif (prev_resv == NULL) {\r\nnext = rb_first(root);\r\nnext_resv = rb_entry(next, struct ocfs2_alloc_reservation,\r\nr_node);\r\nif (next_resv->r_start <= goal) {\r\nmlog(ML_ERROR, "goal: %u next_resv: start %u len %u\n",\r\ngoal, next_resv->r_start, next_resv->r_len);\r\nocfs2_dump_resv(resmap);\r\nBUG();\r\n}\r\nclen = ocfs2_resmap_find_free_bits(resmap, wanted, goal,\r\nnext_resv->r_start - goal,\r\n&cstart, &clen);\r\nif (clen) {\r\nbest_len = clen;\r\nbest_start = cstart;\r\nif (best_len == wanted)\r\ngoto out_insert;\r\n}\r\nprev_resv = next_resv;\r\nnext_resv = NULL;\r\n}\r\ntrace_ocfs2_resv_find_window_prev(prev_resv->r_start,\r\nocfs2_resv_end(prev_resv));\r\nprev = &prev_resv->r_node;\r\nwhile (1) {\r\nnext = rb_next(prev);\r\nif (next) {\r\nnext_resv = rb_entry(next,\r\nstruct ocfs2_alloc_reservation,\r\nr_node);\r\ngap_start = ocfs2_resv_end(prev_resv) + 1;\r\ngap_end = next_resv->r_start - 1;\r\ngap_len = gap_end - gap_start + 1;\r\n} else {\r\ngap_start = ocfs2_resv_end(prev_resv) + 1;\r\ngap_len = resmap->m_bitmap_len - gap_start;\r\ngap_end = resmap->m_bitmap_len - 1;\r\n}\r\ntrace_ocfs2_resv_find_window_next(next ? next_resv->r_start: -1,\r\nnext ? ocfs2_resv_end(next_resv) : -1);\r\nif (gap_len <= best_len)\r\ngoto next_resv;\r\nclen = ocfs2_resmap_find_free_bits(resmap, wanted, gap_start,\r\ngap_len, &cstart, &clen);\r\nif (clen == wanted) {\r\nbest_len = clen;\r\nbest_start = cstart;\r\ngoto out_insert;\r\n} else if (clen > best_len) {\r\nbest_len = clen;\r\nbest_start = cstart;\r\n}\r\nnext_resv:\r\nif (!next)\r\nbreak;\r\nprev = next;\r\nprev_resv = rb_entry(prev, struct ocfs2_alloc_reservation,\r\nr_node);\r\n}\r\nout_insert:\r\nif (best_len) {\r\nresv->r_start = best_start;\r\nresv->r_len = best_len;\r\nocfs2_resv_insert(resmap, resv);\r\n}\r\n}\r\nstatic void ocfs2_cannibalize_resv(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv,\r\nunsigned int wanted)\r\n{\r\nstruct ocfs2_alloc_reservation *lru_resv;\r\nint tmpwindow = !!(resv->r_flags & OCFS2_RESV_FLAG_TMP);\r\nunsigned int min_bits;\r\nif (!tmpwindow)\r\nmin_bits = ocfs2_resv_window_bits(resmap, resv) >> 1;\r\nelse\r\nmin_bits = wanted;\r\nlru_resv = list_first_entry(&resmap->m_lru,\r\nstruct ocfs2_alloc_reservation, r_lru);\r\ntrace_ocfs2_cannibalize_resv_begin(lru_resv->r_start,\r\nlru_resv->r_len,\r\nocfs2_resv_end(lru_resv));\r\nif (lru_resv->r_len <= min_bits) {\r\nresv->r_start = lru_resv->r_start;\r\nresv->r_len = lru_resv->r_len;\r\n__ocfs2_resv_discard(resmap, lru_resv);\r\n} else {\r\nunsigned int shrink;\r\nif (tmpwindow)\r\nshrink = min_bits;\r\nelse\r\nshrink = lru_resv->r_len / 2;\r\nlru_resv->r_len -= shrink;\r\nresv->r_start = ocfs2_resv_end(lru_resv) + 1;\r\nresv->r_len = shrink;\r\n}\r\ntrace_ocfs2_cannibalize_resv_end(resv->r_start, ocfs2_resv_end(resv),\r\nresv->r_len, resv->r_last_start,\r\nresv->r_last_len);\r\nocfs2_resv_insert(resmap, resv);\r\n}\r\nstatic void ocfs2_resv_find_window(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv,\r\nunsigned int wanted)\r\n{\r\nunsigned int goal = 0;\r\nBUG_ON(!ocfs2_resv_empty(resv));\r\nif (resv->r_last_len) {\r\ngoal = resv->r_last_start + resv->r_last_len;\r\nif (goal >= resmap->m_bitmap_len)\r\ngoal = 0;\r\n}\r\n__ocfs2_resv_find_window(resmap, resv, goal, wanted);\r\nif (ocfs2_resv_empty(resv) && goal != 0)\r\n__ocfs2_resv_find_window(resmap, resv, 0, wanted);\r\nif (ocfs2_resv_empty(resv)) {\r\nocfs2_cannibalize_resv(resmap, resv, wanted);\r\n}\r\nBUG_ON(ocfs2_resv_empty(resv));\r\n}\r\nint ocfs2_resmap_resv_bits(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv,\r\nint *cstart, int *clen)\r\n{\r\nif (resv == NULL || ocfs2_resmap_disabled(resmap))\r\nreturn -ENOSPC;\r\nspin_lock(&resv_lock);\r\nif (ocfs2_resv_empty(resv)) {\r\nunsigned int wanted = ocfs2_resv_window_bits(resmap, resv);\r\nif ((resv->r_flags & OCFS2_RESV_FLAG_TMP) || wanted < *clen)\r\nwanted = *clen;\r\nocfs2_resv_find_window(resmap, resv, wanted);\r\ntrace_ocfs2_resmap_resv_bits(resv->r_start, resv->r_len);\r\n}\r\nBUG_ON(ocfs2_resv_empty(resv));\r\n*cstart = resv->r_start;\r\n*clen = resv->r_len;\r\nspin_unlock(&resv_lock);\r\nreturn 0;\r\n}\r\nstatic void\r\nocfs2_adjust_resv_from_alloc(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv,\r\nunsigned int start, unsigned int end)\r\n{\r\nunsigned int rhs = 0;\r\nunsigned int old_end = ocfs2_resv_end(resv);\r\nBUG_ON(start != resv->r_start || old_end < end);\r\nif (old_end == end) {\r\n__ocfs2_resv_discard(resmap, resv);\r\nreturn;\r\n}\r\nrhs = old_end - end;\r\nBUG_ON(rhs == 0);\r\nresv->r_start = end + 1;\r\nresv->r_len = old_end - resv->r_start + 1;\r\n}\r\nvoid ocfs2_resmap_claimed_bits(struct ocfs2_reservation_map *resmap,\r\nstruct ocfs2_alloc_reservation *resv,\r\nu32 cstart, u32 clen)\r\n{\r\nunsigned int cend = cstart + clen - 1;\r\nif (resmap == NULL || ocfs2_resmap_disabled(resmap))\r\nreturn;\r\nif (resv == NULL)\r\nreturn;\r\nBUG_ON(cstart != resv->r_start);\r\nspin_lock(&resv_lock);\r\ntrace_ocfs2_resmap_claimed_bits_begin(cstart, cend, clen, resv->r_start,\r\nocfs2_resv_end(resv), resv->r_len,\r\nresv->r_last_start,\r\nresv->r_last_len);\r\nBUG_ON(cstart < resv->r_start);\r\nBUG_ON(cstart > ocfs2_resv_end(resv));\r\nBUG_ON(cend > ocfs2_resv_end(resv));\r\nocfs2_adjust_resv_from_alloc(resmap, resv, cstart, cend);\r\nresv->r_last_start = cstart;\r\nresv->r_last_len = clen;\r\nif (!ocfs2_resv_empty(resv))\r\nocfs2_resv_mark_lru(resmap, resv);\r\ntrace_ocfs2_resmap_claimed_bits_end(resv->r_start, ocfs2_resv_end(resv),\r\nresv->r_len, resv->r_last_start,\r\nresv->r_last_len);\r\nocfs2_check_resmap(resmap);\r\nspin_unlock(&resv_lock);\r\n}

static int xfs_fileid_length(int fileid_type)\r\n{\r\nswitch (fileid_type) {\r\ncase FILEID_INO32_GEN:\r\nreturn 2;\r\ncase FILEID_INO32_GEN_PARENT:\r\nreturn 4;\r\ncase FILEID_INO32_GEN | XFS_FILEID_TYPE_64FLAG:\r\nreturn 3;\r\ncase FILEID_INO32_GEN_PARENT | XFS_FILEID_TYPE_64FLAG:\r\nreturn 6;\r\n}\r\nreturn 255;\r\n}\r\nSTATIC int\r\nxfs_fs_encode_fh(\r\nstruct dentry *dentry,\r\n__u32 *fh,\r\nint *max_len,\r\nint connectable)\r\n{\r\nstruct fid *fid = (struct fid *)fh;\r\nstruct xfs_fid64 *fid64 = (struct xfs_fid64 *)fh;\r\nstruct inode *inode = dentry->d_inode;\r\nint fileid_type;\r\nint len;\r\nif (S_ISDIR(inode->i_mode) || !connectable)\r\nfileid_type = FILEID_INO32_GEN;\r\nelse\r\nfileid_type = FILEID_INO32_GEN_PARENT;\r\nif (!(XFS_M(inode->i_sb)->m_flags & XFS_MOUNT_SMALL_INUMS) ||\r\n(XFS_M(inode->i_sb)->m_flags & XFS_MOUNT_32BITINODES))\r\nfileid_type |= XFS_FILEID_TYPE_64FLAG;\r\nlen = xfs_fileid_length(fileid_type);\r\nif (*max_len < len) {\r\n*max_len = len;\r\nreturn 255;\r\n}\r\n*max_len = len;\r\nswitch (fileid_type) {\r\ncase FILEID_INO32_GEN_PARENT:\r\nspin_lock(&dentry->d_lock);\r\nfid->i32.parent_ino = XFS_I(dentry->d_parent->d_inode)->i_ino;\r\nfid->i32.parent_gen = dentry->d_parent->d_inode->i_generation;\r\nspin_unlock(&dentry->d_lock);\r\ncase FILEID_INO32_GEN:\r\nfid->i32.ino = XFS_I(inode)->i_ino;\r\nfid->i32.gen = inode->i_generation;\r\nbreak;\r\ncase FILEID_INO32_GEN_PARENT | XFS_FILEID_TYPE_64FLAG:\r\nspin_lock(&dentry->d_lock);\r\nfid64->parent_ino = XFS_I(dentry->d_parent->d_inode)->i_ino;\r\nfid64->parent_gen = dentry->d_parent->d_inode->i_generation;\r\nspin_unlock(&dentry->d_lock);\r\ncase FILEID_INO32_GEN | XFS_FILEID_TYPE_64FLAG:\r\nfid64->ino = XFS_I(inode)->i_ino;\r\nfid64->gen = inode->i_generation;\r\nbreak;\r\n}\r\nreturn fileid_type;\r\n}\r\nSTATIC struct inode *\r\nxfs_nfs_get_inode(\r\nstruct super_block *sb,\r\nu64 ino,\r\nu32 generation)\r\n{\r\nxfs_mount_t *mp = XFS_M(sb);\r\nxfs_inode_t *ip;\r\nint error;\r\nif (ino == 0)\r\nreturn ERR_PTR(-ESTALE);\r\nerror = xfs_iget(mp, NULL, ino, XFS_IGET_UNTRUSTED, 0, &ip);\r\nif (error) {\r\nif (error == EINVAL || error == ENOENT)\r\nerror = ESTALE;\r\nreturn ERR_PTR(-error);\r\n}\r\nif (ip->i_d.di_gen != generation) {\r\nIRELE(ip);\r\nreturn ERR_PTR(-ESTALE);\r\n}\r\nreturn VFS_I(ip);\r\n}\r\nSTATIC struct dentry *\r\nxfs_fs_fh_to_dentry(struct super_block *sb, struct fid *fid,\r\nint fh_len, int fileid_type)\r\n{\r\nstruct xfs_fid64 *fid64 = (struct xfs_fid64 *)fid;\r\nstruct inode *inode = NULL;\r\nif (fh_len < xfs_fileid_length(fileid_type))\r\nreturn NULL;\r\nswitch (fileid_type) {\r\ncase FILEID_INO32_GEN_PARENT:\r\ncase FILEID_INO32_GEN:\r\ninode = xfs_nfs_get_inode(sb, fid->i32.ino, fid->i32.gen);\r\nbreak;\r\ncase FILEID_INO32_GEN_PARENT | XFS_FILEID_TYPE_64FLAG:\r\ncase FILEID_INO32_GEN | XFS_FILEID_TYPE_64FLAG:\r\ninode = xfs_nfs_get_inode(sb, fid64->ino, fid64->gen);\r\nbreak;\r\n}\r\nreturn d_obtain_alias(inode);\r\n}\r\nSTATIC struct dentry *\r\nxfs_fs_fh_to_parent(struct super_block *sb, struct fid *fid,\r\nint fh_len, int fileid_type)\r\n{\r\nstruct xfs_fid64 *fid64 = (struct xfs_fid64 *)fid;\r\nstruct inode *inode = NULL;\r\nswitch (fileid_type) {\r\ncase FILEID_INO32_GEN_PARENT:\r\ninode = xfs_nfs_get_inode(sb, fid->i32.parent_ino,\r\nfid->i32.parent_gen);\r\nbreak;\r\ncase FILEID_INO32_GEN_PARENT | XFS_FILEID_TYPE_64FLAG:\r\ninode = xfs_nfs_get_inode(sb, fid64->parent_ino,\r\nfid64->parent_gen);\r\nbreak;\r\n}\r\nreturn d_obtain_alias(inode);\r\n}\r\nSTATIC struct dentry *\r\nxfs_fs_get_parent(\r\nstruct dentry *child)\r\n{\r\nint error;\r\nstruct xfs_inode *cip;\r\nerror = xfs_lookup(XFS_I(child->d_inode), &xfs_name_dotdot, &cip, NULL);\r\nif (unlikely(error))\r\nreturn ERR_PTR(-error);\r\nreturn d_obtain_alias(VFS_I(cip));\r\n}\r\nSTATIC int\r\nxfs_fs_nfs_commit_metadata(\r\nstruct inode *inode)\r\n{\r\nstruct xfs_inode *ip = XFS_I(inode);\r\nstruct xfs_mount *mp = ip->i_mount;\r\nxfs_lsn_t lsn = 0;\r\nxfs_ilock(ip, XFS_ILOCK_SHARED);\r\nif (xfs_ipincount(ip))\r\nlsn = ip->i_itemp->ili_last_lsn;\r\nxfs_iunlock(ip, XFS_ILOCK_SHARED);\r\nif (!lsn)\r\nreturn 0;\r\nreturn _xfs_log_force_lsn(mp, lsn, XFS_LOG_SYNC, NULL);\r\n}

char *cachefiles_cook_key(const u8 *raw, int keylen, uint8_t type)\r\n{\r\nunsigned char csum, ch;\r\nunsigned int acc;\r\nchar *key;\r\nint loop, len, max, seg, mark, print;\r\n_enter(",%d", keylen);\r\nBUG_ON(keylen < 2 || keylen > 514);\r\ncsum = raw[0] + raw[1];\r\nprint = 1;\r\nfor (loop = 2; loop < keylen; loop++) {\r\nch = raw[loop];\r\ncsum += ch;\r\nprint &= cachefiles_filecharmap[ch];\r\n}\r\nif (print) {\r\nmax = keylen - 2;\r\nmax += 2;\r\nmax += 5;\r\nmax += 3 * 2;\r\nmax += 1;\r\n} else {\r\nkeylen = (keylen + 2) / 3;\r\nmax = keylen * 4;\r\nmax += 5;\r\nmax += 3 * 2;\r\nmax += 1;\r\n}\r\nmax += 1;\r\n_debug("max: %d", max);\r\nkey = kmalloc(max, GFP_KERNEL);\r\nif (!key)\r\nreturn NULL;\r\nlen = 0;\r\nsprintf(key, "@%02x%c+", (unsigned) csum, 0);\r\nlen = 5;\r\nmark = len - 1;\r\nif (print) {\r\nacc = *(uint16_t *) raw;\r\nraw += 2;\r\nkey[len + 1] = cachefiles_charmap[acc & 63];\r\nacc >>= 6;\r\nkey[len] = cachefiles_charmap[acc & 63];\r\nlen += 2;\r\nseg = 250;\r\nfor (loop = keylen; loop > 0; loop--) {\r\nif (seg <= 0) {\r\nkey[len++] = '\0';\r\nmark = len;\r\nkey[len++] = '+';\r\nseg = 252;\r\n}\r\nkey[len++] = *raw++;\r\nASSERT(len < max);\r\n}\r\nswitch (type) {\r\ncase FSCACHE_COOKIE_TYPE_INDEX: type = 'I'; break;\r\ncase FSCACHE_COOKIE_TYPE_DATAFILE: type = 'D'; break;\r\ndefault: type = 'S'; break;\r\n}\r\n} else {\r\nseg = 252;\r\nfor (loop = keylen; loop > 0; loop--) {\r\nif (seg <= 0) {\r\nkey[len++] = '\0';\r\nmark = len;\r\nkey[len++] = '+';\r\nseg = 252;\r\n}\r\nacc = *raw++;\r\nacc |= *raw++ << 8;\r\nacc |= *raw++ << 16;\r\n_debug("acc: %06x", acc);\r\nkey[len++] = cachefiles_charmap[acc & 63];\r\nacc >>= 6;\r\nkey[len++] = cachefiles_charmap[acc & 63];\r\nacc >>= 6;\r\nkey[len++] = cachefiles_charmap[acc & 63];\r\nacc >>= 6;\r\nkey[len++] = cachefiles_charmap[acc & 63];\r\nASSERT(len < max);\r\n}\r\nswitch (type) {\r\ncase FSCACHE_COOKIE_TYPE_INDEX: type = 'J'; break;\r\ncase FSCACHE_COOKIE_TYPE_DATAFILE: type = 'E'; break;\r\ndefault: type = 'T'; break;\r\n}\r\n}\r\nkey[mark] = type;\r\nkey[len++] = 0;\r\nkey[len] = 0;\r\n_leave(" = %p %d", key, len);\r\nreturn key;\r\n}

static irqreturn_t ci13xxx_pci_irq(int irq, void *pdev)\r\n{\r\nif (irq == 0) {\r\ndev_err(&((struct pci_dev *)pdev)->dev, "Invalid IRQ0 usage!");\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn udc_irq();\r\n}\r\nstatic int __devinit ci13xxx_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nvoid __iomem *regs = NULL;\r\nint retval = 0;\r\nif (id == NULL)\r\nreturn -EINVAL;\r\nretval = pci_enable_device(pdev);\r\nif (retval)\r\ngoto done;\r\nif (!pdev->irq) {\r\ndev_err(&pdev->dev, "No IRQ, check BIOS/PCI setup!");\r\nretval = -ENODEV;\r\ngoto disable_device;\r\n}\r\nretval = pci_request_regions(pdev, UDC_DRIVER_NAME);\r\nif (retval)\r\ngoto disable_device;\r\nregs = pci_iomap(pdev, 0, 0);\r\nif (!regs) {\r\ndev_err(&pdev->dev, "Error mapping memory!");\r\nretval = -EFAULT;\r\ngoto release_regions;\r\n}\r\npci_set_drvdata(pdev, (__force void *)regs);\r\npci_set_master(pdev);\r\npci_try_set_mwi(pdev);\r\nretval = udc_probe(&ci13xxx_pci_udc_driver, &pdev->dev, regs);\r\nif (retval)\r\ngoto iounmap;\r\nretval = request_irq(pdev->irq, ci13xxx_pci_irq, IRQF_SHARED,\r\nUDC_DRIVER_NAME, pdev);\r\nif (retval)\r\ngoto gadget_remove;\r\nreturn 0;\r\ngadget_remove:\r\nudc_remove();\r\niounmap:\r\npci_iounmap(pdev, regs);\r\nrelease_regions:\r\npci_release_regions(pdev);\r\ndisable_device:\r\npci_disable_device(pdev);\r\ndone:\r\nreturn retval;\r\n}\r\nstatic void __devexit ci13xxx_pci_remove(struct pci_dev *pdev)\r\n{\r\nfree_irq(pdev->irq, pdev);\r\nudc_remove();\r\npci_iounmap(pdev, (__force void __iomem *)pci_get_drvdata(pdev));\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}\r\nstatic int __init ci13xxx_pci_init(void)\r\n{\r\nreturn pci_register_driver(&ci13xxx_pci_driver);\r\n}\r\nstatic void __exit ci13xxx_pci_exit(void)\r\n{\r\npci_unregister_driver(&ci13xxx_pci_driver);\r\n}

static int fc_header(struct sk_buff *skb, struct net_device *dev,\r\nunsigned short type,\r\nconst void *daddr, const void *saddr, unsigned len)\r\n{\r\nstruct fch_hdr *fch;\r\nint hdr_len;\r\nif (type == ETH_P_IP || type == ETH_P_ARP)\r\n{\r\nstruct fcllc *fcllc;\r\nhdr_len = sizeof(struct fch_hdr) + sizeof(struct fcllc);\r\nfch = (struct fch_hdr *)skb_push(skb, hdr_len);\r\nfcllc = (struct fcllc *)(fch+1);\r\nfcllc->dsap = fcllc->ssap = EXTENDED_SAP;\r\nfcllc->llc = UI_CMD;\r\nfcllc->protid[0] = fcllc->protid[1] = fcllc->protid[2] = 0x00;\r\nfcllc->ethertype = htons(type);\r\n}\r\nelse\r\n{\r\nhdr_len = sizeof(struct fch_hdr);\r\nfch = (struct fch_hdr *)skb_push(skb, hdr_len);\r\n}\r\nif(saddr)\r\nmemcpy(fch->saddr,saddr,dev->addr_len);\r\nelse\r\nmemcpy(fch->saddr,dev->dev_addr,dev->addr_len);\r\nif(daddr)\r\n{\r\nmemcpy(fch->daddr,daddr,dev->addr_len);\r\nreturn hdr_len;\r\n}\r\nreturn -hdr_len;\r\n}\r\nstatic int fc_rebuild_header(struct sk_buff *skb)\r\n{\r\n#ifdef CONFIG_INET\r\nstruct fch_hdr *fch=(struct fch_hdr *)skb->data;\r\nstruct fcllc *fcllc=(struct fcllc *)(skb->data+sizeof(struct fch_hdr));\r\nif(fcllc->ethertype != htons(ETH_P_IP)) {\r\nprintk("fc_rebuild_header: Don't know how to resolve type %04X addresses ?\n", ntohs(fcllc->ethertype));\r\nreturn 0;\r\n}\r\nreturn arp_find(fch->daddr, skb);\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nstatic void fc_setup(struct net_device *dev)\r\n{\r\ndev->header_ops = &fc_header_ops;\r\ndev->type = ARPHRD_IEEE802;\r\ndev->hard_header_len = FC_HLEN;\r\ndev->mtu = 2024;\r\ndev->addr_len = FC_ALEN;\r\ndev->tx_queue_len = 100;\r\ndev->flags = IFF_BROADCAST;\r\nmemset(dev->broadcast, 0xFF, FC_ALEN);\r\n}\r\nstruct net_device *alloc_fcdev(int sizeof_priv)\r\n{\r\nreturn alloc_netdev(sizeof_priv, "fc%d", fc_setup);\r\n}

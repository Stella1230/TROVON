STATIC int\r\nxfs_growfs_rt_alloc(\r\nxfs_mount_t *mp,\r\nxfs_extlen_t oblocks,\r\nxfs_extlen_t nblocks,\r\nxfs_inode_t *ip)\r\n{\r\nxfs_fileoff_t bno;\r\nxfs_buf_t *bp;\r\nint committed;\r\nxfs_daddr_t d;\r\nint error;\r\nxfs_fsblock_t firstblock;\r\nxfs_bmap_free_t flist;\r\nxfs_fsblock_t fsbno;\r\nxfs_bmbt_irec_t map;\r\nint nmap;\r\nint resblks;\r\nwhile (oblocks < nblocks) {\r\nint cancelflags = 0;\r\nxfs_trans_t *tp;\r\ntp = xfs_trans_alloc(mp, XFS_TRANS_GROWFSRT_ALLOC);\r\nresblks = XFS_GROWFSRT_SPACE_RES(mp, nblocks - oblocks);\r\nif ((error = xfs_trans_reserve(tp, resblks,\r\nXFS_GROWRTALLOC_LOG_RES(mp), 0,\r\nXFS_TRANS_PERM_LOG_RES,\r\nXFS_DEFAULT_PERM_LOG_COUNT)))\r\ngoto error_cancel;\r\ncancelflags = XFS_TRANS_RELEASE_LOG_RES;\r\nxfs_ilock(ip, XFS_ILOCK_EXCL);\r\nxfs_trans_ijoin(tp, ip, XFS_ILOCK_EXCL);\r\nxfs_bmap_init(&flist, &firstblock);\r\nnmap = 1;\r\ncancelflags |= XFS_TRANS_ABORT;\r\nerror = xfs_bmapi_write(tp, ip, oblocks, nblocks - oblocks,\r\nXFS_BMAPI_METADATA, &firstblock,\r\nresblks, &map, &nmap, &flist);\r\nif (!error && nmap < 1)\r\nerror = XFS_ERROR(ENOSPC);\r\nif (error)\r\ngoto error_cancel;\r\nerror = xfs_bmap_finish(&tp, &flist, &committed);\r\nif (error)\r\ngoto error_cancel;\r\nerror = xfs_trans_commit(tp, XFS_TRANS_RELEASE_LOG_RES);\r\nif (error)\r\ngoto error;\r\ncancelflags = 0;\r\nfor (bno = map.br_startoff, fsbno = map.br_startblock;\r\nbno < map.br_startoff + map.br_blockcount;\r\nbno++, fsbno++) {\r\ntp = xfs_trans_alloc(mp, XFS_TRANS_GROWFSRT_ZERO);\r\nif ((error = xfs_trans_reserve(tp, 0,\r\nXFS_GROWRTZERO_LOG_RES(mp), 0, 0, 0)))\r\ngoto error_cancel;\r\nxfs_ilock(ip, XFS_ILOCK_EXCL);\r\nxfs_trans_ijoin(tp, ip, XFS_ILOCK_EXCL);\r\nd = XFS_FSB_TO_DADDR(mp, fsbno);\r\nbp = xfs_trans_get_buf(tp, mp->m_ddev_targp, d,\r\nmp->m_bsize, 0);\r\nif (bp == NULL) {\r\nerror = XFS_ERROR(EIO);\r\nerror_cancel:\r\nxfs_trans_cancel(tp, cancelflags);\r\ngoto error;\r\n}\r\nmemset(bp->b_addr, 0, mp->m_sb.sb_blocksize);\r\nxfs_trans_log_buf(tp, bp, 0, mp->m_sb.sb_blocksize - 1);\r\nerror = xfs_trans_commit(tp, 0);\r\nif (error)\r\ngoto error;\r\n}\r\noblocks = map.br_startoff + map.br_blockcount;\r\n}\r\nreturn 0;\r\nerror:\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_rtallocate_extent_block(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bbno,\r\nxfs_extlen_t minlen,\r\nxfs_extlen_t maxlen,\r\nxfs_extlen_t *len,\r\nxfs_rtblock_t *nextp,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb,\r\nxfs_extlen_t prod,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nxfs_rtblock_t besti;\r\nxfs_rtblock_t bestlen;\r\nxfs_rtblock_t end;\r\nint error;\r\nxfs_rtblock_t i;\r\nxfs_rtblock_t next;\r\nint stat;\r\nfor (i = XFS_BLOCKTOBIT(mp, bbno), besti = -1, bestlen = 0,\r\nend = XFS_BLOCKTOBIT(mp, bbno + 1) - 1;\r\ni <= end;\r\ni++) {\r\nerror = xfs_rtcheck_range(mp, tp, i, maxlen, 1, &next, &stat);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (stat) {\r\nerror = xfs_rtallocate_range(mp, tp, i, maxlen, rbpp,\r\nrsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n*len = maxlen;\r\n*rtblock = i;\r\nreturn 0;\r\n}\r\nif (minlen < maxlen) {\r\nxfs_rtblock_t thislen;\r\nthislen = next - i;\r\nif (thislen >= minlen && thislen > bestlen) {\r\nbesti = i;\r\nbestlen = thislen;\r\n}\r\n}\r\nif (next < end) {\r\nerror = xfs_rtfind_forw(mp, tp, next, end, &i);\r\nif (error) {\r\nreturn error;\r\n}\r\n} else\r\nbreak;\r\n}\r\nif (minlen < maxlen && besti != -1) {\r\nxfs_extlen_t p;\r\nif (prod > 1 && (p = do_mod(bestlen, prod)))\r\nbestlen -= p;\r\nerror = xfs_rtallocate_range(mp, tp, besti, bestlen, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n*len = bestlen;\r\n*rtblock = besti;\r\nreturn 0;\r\n}\r\n*nextp = next;\r\n*rtblock = NULLRTBLOCK;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtallocate_extent_exact(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bno,\r\nxfs_extlen_t minlen,\r\nxfs_extlen_t maxlen,\r\nxfs_extlen_t *len,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb,\r\nxfs_extlen_t prod,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nint error;\r\nxfs_extlen_t i;\r\nint isfree;\r\nxfs_rtblock_t next;\r\nASSERT(minlen % prod == 0 && maxlen % prod == 0);\r\nerror = xfs_rtcheck_range(mp, tp, bno, maxlen, 1, &next, &isfree);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (isfree) {\r\nerror = xfs_rtallocate_range(mp, tp, bno, maxlen, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n*len = maxlen;\r\n*rtblock = bno;\r\nreturn 0;\r\n}\r\nmaxlen = next - bno;\r\nif (maxlen < minlen) {\r\n*rtblock = NULLRTBLOCK;\r\nreturn 0;\r\n}\r\nif (prod > 1 && (i = maxlen % prod)) {\r\nmaxlen -= i;\r\nif (maxlen < minlen) {\r\n*rtblock = NULLRTBLOCK;\r\nreturn 0;\r\n}\r\n}\r\nerror = xfs_rtallocate_range(mp, tp, bno, maxlen, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n*len = maxlen;\r\n*rtblock = bno;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtallocate_extent_near(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bno,\r\nxfs_extlen_t minlen,\r\nxfs_extlen_t maxlen,\r\nxfs_extlen_t *len,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb,\r\nxfs_extlen_t prod,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nint any;\r\nxfs_rtblock_t bbno;\r\nint error;\r\nint i;\r\nint j;\r\nint log2len;\r\nxfs_rtblock_t n;\r\nxfs_rtblock_t r;\r\nASSERT(minlen % prod == 0 && maxlen % prod == 0);\r\nif (bno >= mp->m_sb.sb_rextents)\r\nbno = mp->m_sb.sb_rextents - 1;\r\nerror = xfs_rtallocate_extent_exact(mp, tp, bno, minlen, maxlen, len,\r\nrbpp, rsb, prod, &r);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (r != NULLRTBLOCK) {\r\n*rtblock = r;\r\nreturn 0;\r\n}\r\nbbno = XFS_BITTOBLOCK(mp, bno);\r\ni = 0;\r\nASSERT(minlen != 0);\r\nlog2len = xfs_highbit32(minlen);\r\nfor (;;) {\r\nerror = xfs_rtany_summary(mp, tp, log2len, mp->m_rsumlevels - 1,\r\nbbno + i, rbpp, rsb, &any);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (any) {\r\nif (i >= 0) {\r\nerror = xfs_rtallocate_extent_block(mp, tp,\r\nbbno + i, minlen, maxlen, len, &n, rbpp,\r\nrsb, prod, &r);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (r != NULLRTBLOCK) {\r\n*rtblock = r;\r\nreturn 0;\r\n}\r\n}\r\nelse {\r\nfor (j = -1; j > i; j--) {\r\nerror = xfs_rtany_summary(mp, tp,\r\nlog2len, mp->m_rsumlevels - 1,\r\nbbno + j, rbpp, rsb, &any);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (any)\r\ncontinue;\r\nerror = xfs_rtallocate_extent_block(mp,\r\ntp, bbno + j, minlen, maxlen,\r\nlen, &n, rbpp, rsb, prod, &r);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (r != NULLRTBLOCK) {\r\n*rtblock = r;\r\nreturn 0;\r\n}\r\n}\r\nerror = xfs_rtallocate_extent_block(mp, tp,\r\nbbno + i, minlen, maxlen, len, &n, rbpp,\r\nrsb, prod, &r);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (r != NULLRTBLOCK) {\r\n*rtblock = r;\r\nreturn 0;\r\n}\r\n}\r\n}\r\nif (i > 0 && (int)bbno - i >= 0)\r\ni = -i;\r\nelse if (i > 0 && (int)bbno + i < mp->m_sb.sb_rbmblocks - 1)\r\ni++;\r\nelse if (i <= 0 && (int)bbno - i < mp->m_sb.sb_rbmblocks - 1)\r\ni = 1 - i;\r\nelse if (i <= 0 && (int)bbno + i > 0)\r\ni--;\r\nelse\r\nbreak;\r\n}\r\n*rtblock = NULLRTBLOCK;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtallocate_extent_size(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_extlen_t minlen,\r\nxfs_extlen_t maxlen,\r\nxfs_extlen_t *len,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb,\r\nxfs_extlen_t prod,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nint error;\r\nint i;\r\nint l;\r\nxfs_rtblock_t n;\r\nxfs_rtblock_t r;\r\nxfs_suminfo_t sum;\r\nASSERT(minlen % prod == 0 && maxlen % prod == 0);\r\nASSERT(maxlen != 0);\r\nfor (l = xfs_highbit32(maxlen); l < mp->m_rsumlevels; l++) {\r\nfor (i = 0; i < mp->m_sb.sb_rbmblocks; i++) {\r\nerror = xfs_rtget_summary(mp, tp, l, i, rbpp, rsb,\r\n&sum);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (!sum)\r\ncontinue;\r\nerror = xfs_rtallocate_extent_block(mp, tp, i, maxlen,\r\nmaxlen, len, &n, rbpp, rsb, prod, &r);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (r != NULLRTBLOCK) {\r\n*rtblock = r;\r\nreturn 0;\r\n}\r\nif (XFS_BITTOBLOCK(mp, n) > i + 1)\r\ni = XFS_BITTOBLOCK(mp, n) - 1;\r\n}\r\n}\r\nif (minlen > --maxlen) {\r\n*rtblock = NULLRTBLOCK;\r\nreturn 0;\r\n}\r\nASSERT(minlen != 0);\r\nASSERT(maxlen != 0);\r\nfor (l = xfs_highbit32(maxlen); l >= xfs_highbit32(minlen); l--) {\r\nfor (i = 0; i < mp->m_sb.sb_rbmblocks; i++) {\r\nerror = xfs_rtget_summary(mp, tp, l, i, rbpp, rsb,\r\n&sum);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (!sum)\r\ncontinue;\r\nerror = xfs_rtallocate_extent_block(mp, tp, i,\r\nXFS_RTMAX(minlen, 1 << l),\r\nXFS_RTMIN(maxlen, (1 << (l + 1)) - 1),\r\nlen, &n, rbpp, rsb, prod, &r);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (r != NULLRTBLOCK) {\r\n*rtblock = r;\r\nreturn 0;\r\n}\r\nif (XFS_BITTOBLOCK(mp, n) > i + 1)\r\ni = XFS_BITTOBLOCK(mp, n) - 1;\r\n}\r\n}\r\n*rtblock = NULLRTBLOCK;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtallocate_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_extlen_t len,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb)\r\n{\r\nxfs_rtblock_t end;\r\nint error;\r\nxfs_rtblock_t postblock;\r\nxfs_rtblock_t preblock;\r\nend = start + len - 1;\r\nerror = xfs_rtfind_back(mp, tp, start, 0, &preblock);\r\nif (error) {\r\nreturn error;\r\n}\r\nerror = xfs_rtfind_forw(mp, tp, end, mp->m_sb.sb_rextents - 1,\r\n&postblock);\r\nif (error) {\r\nreturn error;\r\n}\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(postblock + 1 - preblock),\r\nXFS_BITTOBLOCK(mp, preblock), -1, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (preblock < start) {\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(start - preblock),\r\nXFS_BITTOBLOCK(mp, preblock), 1, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n}\r\nif (postblock > end) {\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(postblock - end),\r\nXFS_BITTOBLOCK(mp, end + 1), 1, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n}\r\nerror = xfs_rtmodify_range(mp, tp, start, len, 0);\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_rtany_summary(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nint low,\r\nint high,\r\nxfs_rtblock_t bbno,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb,\r\nint *stat)\r\n{\r\nint error;\r\nint log;\r\nxfs_suminfo_t sum;\r\nfor (log = low; log <= high; log++) {\r\nerror = xfs_rtget_summary(mp, tp, log, bbno, rbpp, rsb, &sum);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (sum) {\r\n*stat = 1;\r\nreturn 0;\r\n}\r\n}\r\n*stat = 0;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtbuf_get(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t block,\r\nint issum,\r\nxfs_buf_t **bpp)\r\n{\r\nxfs_buf_t *bp;\r\nxfs_inode_t *ip;\r\nxfs_bmbt_irec_t map;\r\nint nmap;\r\nint error;\r\nip = issum ? mp->m_rsumip : mp->m_rbmip;\r\nerror = xfs_bmapi_read(ip, block, 1, &map, &nmap, XFS_DATA_FORK);\r\nif (error)\r\nreturn error;\r\nASSERT(map.br_startblock != NULLFSBLOCK);\r\nerror = xfs_trans_read_buf(mp, tp, mp->m_ddev_targp,\r\nXFS_FSB_TO_DADDR(mp, map.br_startblock),\r\nmp->m_bsize, 0, &bp);\r\nif (error)\r\nreturn error;\r\nASSERT(!xfs_buf_geterror(bp));\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtcheck_alloc_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bno,\r\nxfs_extlen_t len,\r\nint *stat)\r\n{\r\nxfs_rtblock_t new;\r\nreturn xfs_rtcheck_range(mp, tp, bno, len, 0, &new, stat);\r\n}\r\nSTATIC int\r\nxfs_rtcheck_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_extlen_t len,\r\nint val,\r\nxfs_rtblock_t *new,\r\nint *stat)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtblock_t i;\r\nxfs_rtblock_t lastbit;\r\nxfs_rtword_t mask;\r\nxfs_rtword_t wdiff;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nb = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nval = -val;\r\nif (bit) {\r\nlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\r\nmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\r\nif ((wdiff = (*b ^ val) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni = XFS_RTLOBIT(wdiff) - bit;\r\n*new = start + i;\r\n*stat = 0;\r\nreturn 0;\r\n}\r\ni = lastbit - bit;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\nif ((wdiff = *b ^ val)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*new = start + i;\r\n*stat = 0;\r\nreturn 0;\r\n}\r\ni += XFS_NBWORD;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n}\r\nif ((lastbit = len - i)) {\r\nmask = ((xfs_rtword_t)1 << lastbit) - 1;\r\nif ((wdiff = (*b ^ val) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*new = start + i;\r\n*stat = 0;\r\nreturn 0;\r\n} else\r\ni = len;\r\n}\r\nxfs_trans_brelse(tp, bp);\r\n*new = start + i;\r\n*stat = 1;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtfind_back(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_rtblock_t limit,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtblock_t firstbit;\r\nxfs_rtblock_t i;\r\nxfs_rtblock_t len;\r\nxfs_rtword_t mask;\r\nxfs_rtword_t want;\r\nxfs_rtword_t wdiff;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nb = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nlen = start - limit + 1;\r\nwant = (*b & ((xfs_rtword_t)1 << bit)) ? -1 : 0;\r\nif (bit < XFS_NBWORD - 1) {\r\nfirstbit = XFS_RTMAX((xfs_srtblock_t)(bit - len + 1), 0);\r\nmask = (((xfs_rtword_t)1 << (bit - firstbit + 1)) - 1) <<\r\nfirstbit;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni = bit - XFS_RTHIBIT(wdiff);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n}\r\ni = bit - firstbit + 1;\r\nif (--word == -1 && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, --block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BLOCKWMASK(mp);\r\nb = &bufp[word];\r\n} else {\r\nb--;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\nif ((wdiff = *b ^ want)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_NBWORD - 1 - XFS_RTHIBIT(wdiff);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n}\r\ni += XFS_NBWORD;\r\nif (--word == -1 && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, --block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BLOCKWMASK(mp);\r\nb = &bufp[word];\r\n} else {\r\nb--;\r\n}\r\n}\r\nif (len - i) {\r\nfirstbit = XFS_NBWORD - (len - i);\r\nmask = (((xfs_rtword_t)1 << (len - i)) - 1) << firstbit;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_NBWORD - 1 - XFS_RTHIBIT(wdiff);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n} else\r\ni = len;\r\n}\r\nxfs_trans_brelse(tp, bp);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtfind_forw(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_rtblock_t limit,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtblock_t i;\r\nxfs_rtblock_t lastbit;\r\nxfs_rtblock_t len;\r\nxfs_rtword_t mask;\r\nxfs_rtword_t want;\r\nxfs_rtword_t wdiff;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nb = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nlen = limit - start + 1;\r\nwant = (*b & ((xfs_rtword_t)1 << bit)) ? -1 : 0;\r\nif (bit) {\r\nlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\r\nmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni = XFS_RTLOBIT(wdiff) - bit;\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n}\r\ni = lastbit - bit;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\nif ((wdiff = *b ^ want)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n}\r\ni += XFS_NBWORD;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n}\r\nif ((lastbit = len - i)) {\r\nmask = ((xfs_rtword_t)1 << lastbit) - 1;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n} else\r\ni = len;\r\n}\r\nxfs_trans_brelse(tp, bp);\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtfree_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_extlen_t len,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb)\r\n{\r\nxfs_rtblock_t end;\r\nint error;\r\nxfs_rtblock_t postblock;\r\nxfs_rtblock_t preblock;\r\nend = start + len - 1;\r\nerror = xfs_rtmodify_range(mp, tp, start, len, 1);\r\nif (error) {\r\nreturn error;\r\n}\r\nerror = xfs_rtfind_back(mp, tp, start, 0, &preblock);\r\nif (error) {\r\nreturn error;\r\n}\r\nerror = xfs_rtfind_forw(mp, tp, end, mp->m_sb.sb_rextents - 1,\r\n&postblock);\r\nif (error)\r\nreturn error;\r\nif (preblock < start) {\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(start - preblock),\r\nXFS_BITTOBLOCK(mp, preblock), -1, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n}\r\nif (postblock > end) {\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(postblock - end),\r\nXFS_BITTOBLOCK(mp, end + 1), -1, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n}\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(postblock + 1 - preblock),\r\nXFS_BITTOBLOCK(mp, preblock), 1, rbpp, rsb);\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_rtget_summary(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nint log,\r\nxfs_rtblock_t bbno,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb,\r\nxfs_suminfo_t *sum)\r\n{\r\nxfs_buf_t *bp;\r\nint error;\r\nxfs_fsblock_t sb;\r\nint so;\r\nxfs_suminfo_t *sp;\r\nso = XFS_SUMOFFS(mp, log, bbno);\r\nsb = XFS_SUMOFFSTOBLOCK(mp, so);\r\nif (rbpp && *rbpp && *rsb == sb)\r\nbp = *rbpp;\r\nelse {\r\nif (rbpp && *rbpp)\r\nxfs_trans_brelse(tp, *rbpp);\r\nerror = xfs_rtbuf_get(mp, tp, sb, 1, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (rbpp) {\r\n*rbpp = bp;\r\n*rsb = sb;\r\n}\r\n}\r\nsp = XFS_SUMPTR(mp, bp, so);\r\n*sum = *sp;\r\nif (!rbpp)\r\nxfs_trans_brelse(tp, bp);\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtmodify_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_extlen_t len,\r\nint val)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtword_t *first;\r\nint i;\r\nint lastbit;\r\nxfs_rtword_t mask;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nfirst = b = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nval = -val;\r\nif (bit) {\r\nlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\r\nmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\r\nif (val)\r\n*b |= mask;\r\nelse\r\n*b &= ~mask;\r\ni = lastbit - bit;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_log_buf(tp, bp,\r\n(uint)((char *)first - (char *)bufp),\r\n(uint)((char *)b - (char *)bufp));\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nfirst = b = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\n*b = val;\r\ni += XFS_NBWORD;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_log_buf(tp, bp,\r\n(uint)((char *)first - (char *)bufp),\r\n(uint)((char *)b - (char *)bufp));\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nfirst = b = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n}\r\nif ((lastbit = len - i)) {\r\nbit = 0;\r\nmask = ((xfs_rtword_t)1 << lastbit) - 1;\r\nif (val)\r\n*b |= mask;\r\nelse\r\n*b &= ~mask;\r\nb++;\r\n}\r\nif (b > first)\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)first - (char *)bufp),\r\n(uint)((char *)b - (char *)bufp - 1));\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtmodify_summary(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nint log,\r\nxfs_rtblock_t bbno,\r\nint delta,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb)\r\n{\r\nxfs_buf_t *bp;\r\nint error;\r\nxfs_fsblock_t sb;\r\nint so;\r\nxfs_suminfo_t *sp;\r\nso = XFS_SUMOFFS(mp, log, bbno);\r\nsb = XFS_SUMOFFSTOBLOCK(mp, so);\r\nif (rbpp && *rbpp && *rsb == sb)\r\nbp = *rbpp;\r\nelse {\r\nif (rbpp && *rbpp)\r\nxfs_trans_brelse(tp, *rbpp);\r\nerror = xfs_rtbuf_get(mp, tp, sb, 1, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nif (rbpp) {\r\n*rbpp = bp;\r\n*rsb = sb;\r\n}\r\n}\r\nsp = XFS_SUMPTR(mp, bp, so);\r\n*sp += delta;\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)sp - (char *)bp->b_addr),\r\n(uint)((char *)sp - (char *)bp->b_addr + sizeof(*sp) - 1));\r\nreturn 0;\r\n}\r\nint\r\nxfs_growfs_rt(\r\nxfs_mount_t *mp,\r\nxfs_growfs_rt_t *in)\r\n{\r\nxfs_rtblock_t bmbno;\r\nxfs_buf_t *bp;\r\nint error;\r\nxfs_mount_t *nmp;\r\nxfs_drfsbno_t nrblocks;\r\nxfs_extlen_t nrbmblocks;\r\nxfs_drtbno_t nrextents;\r\nuint8_t nrextslog;\r\nxfs_extlen_t nrsumblocks;\r\nuint nrsumlevels;\r\nuint nrsumsize;\r\nxfs_sb_t *nsbp;\r\nxfs_extlen_t rbmblocks;\r\nxfs_extlen_t rsumblocks;\r\nxfs_sb_t *sbp;\r\nxfs_fsblock_t sumbno;\r\nsbp = &mp->m_sb;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn XFS_ERROR(EPERM);\r\nif (mp->m_rtdev_targp == NULL || mp->m_rbmip == NULL ||\r\n(nrblocks = in->newblocks) <= sbp->sb_rblocks ||\r\n(sbp->sb_rblocks && (in->extsize != sbp->sb_rextsize)))\r\nreturn XFS_ERROR(EINVAL);\r\nif ((error = xfs_sb_validate_fsb_count(sbp, nrblocks)))\r\nreturn error;\r\nbp = xfs_buf_read_uncached(mp, mp->m_rtdev_targp,\r\nXFS_FSB_TO_BB(mp, nrblocks - 1),\r\nXFS_FSB_TO_B(mp, 1), 0);\r\nif (!bp)\r\nreturn EIO;\r\nxfs_buf_relse(bp);\r\nnrextents = nrblocks;\r\ndo_div(nrextents, in->extsize);\r\nnrbmblocks = howmany_64(nrextents, NBBY * sbp->sb_blocksize);\r\nnrextslog = xfs_highbit32(nrextents);\r\nnrsumlevels = nrextslog + 1;\r\nnrsumsize = (uint)sizeof(xfs_suminfo_t) * nrsumlevels * nrbmblocks;\r\nnrsumblocks = XFS_B_TO_FSB(mp, nrsumsize);\r\nnrsumsize = XFS_FSB_TO_B(mp, nrsumblocks);\r\nif (nrsumblocks > (mp->m_sb.sb_logblocks >> 1))\r\nreturn XFS_ERROR(EINVAL);\r\nrbmblocks = XFS_B_TO_FSB(mp, mp->m_rbmip->i_d.di_size);\r\nrsumblocks = XFS_B_TO_FSB(mp, mp->m_rsumip->i_d.di_size);\r\nerror = xfs_growfs_rt_alloc(mp, rbmblocks, nrbmblocks, mp->m_rbmip);\r\nif (error)\r\nreturn error;\r\nerror = xfs_growfs_rt_alloc(mp, rsumblocks, nrsumblocks, mp->m_rsumip);\r\nif (error)\r\nreturn error;\r\nnmp = kmem_alloc(sizeof(*nmp), KM_SLEEP);\r\nfor (bmbno = sbp->sb_rbmblocks -\r\n((sbp->sb_rextents & ((1 << mp->m_blkbit_log) - 1)) != 0);\r\nbmbno < nrbmblocks;\r\nbmbno++) {\r\nxfs_trans_t *tp;\r\nint cancelflags = 0;\r\n*nmp = *mp;\r\nnsbp = &nmp->m_sb;\r\nnsbp->sb_rextsize = in->extsize;\r\nnsbp->sb_rbmblocks = bmbno + 1;\r\nnsbp->sb_rblocks =\r\nXFS_RTMIN(nrblocks,\r\nnsbp->sb_rbmblocks * NBBY *\r\nnsbp->sb_blocksize * nsbp->sb_rextsize);\r\nnsbp->sb_rextents = nsbp->sb_rblocks;\r\ndo_div(nsbp->sb_rextents, nsbp->sb_rextsize);\r\nASSERT(nsbp->sb_rextents != 0);\r\nnsbp->sb_rextslog = xfs_highbit32(nsbp->sb_rextents);\r\nnrsumlevels = nmp->m_rsumlevels = nsbp->sb_rextslog + 1;\r\nnrsumsize =\r\n(uint)sizeof(xfs_suminfo_t) * nrsumlevels *\r\nnsbp->sb_rbmblocks;\r\nnrsumblocks = XFS_B_TO_FSB(mp, nrsumsize);\r\nnmp->m_rsumsize = nrsumsize = XFS_FSB_TO_B(mp, nrsumblocks);\r\ntp = xfs_trans_alloc(mp, XFS_TRANS_GROWFSRT_FREE);\r\nif ((error = xfs_trans_reserve(tp, 0,\r\nXFS_GROWRTFREE_LOG_RES(nmp), 0, 0, 0)))\r\ngoto error_cancel;\r\nxfs_ilock(mp->m_rbmip, XFS_ILOCK_EXCL);\r\nxfs_trans_ijoin(tp, mp->m_rbmip, XFS_ILOCK_EXCL);\r\nmp->m_rbmip->i_d.di_size =\r\nnsbp->sb_rbmblocks * nsbp->sb_blocksize;\r\nxfs_trans_log_inode(tp, mp->m_rbmip, XFS_ILOG_CORE);\r\ncancelflags |= XFS_TRANS_ABORT;\r\nxfs_ilock(mp->m_rsumip, XFS_ILOCK_EXCL);\r\nxfs_trans_ijoin(tp, mp->m_rsumip, XFS_ILOCK_EXCL);\r\nmp->m_rsumip->i_d.di_size = nmp->m_rsumsize;\r\nxfs_trans_log_inode(tp, mp->m_rsumip, XFS_ILOG_CORE);\r\nif (sbp->sb_rbmblocks != nsbp->sb_rbmblocks ||\r\nmp->m_rsumlevels != nmp->m_rsumlevels) {\r\nerror = xfs_rtcopy_summary(mp, nmp, tp);\r\nif (error)\r\ngoto error_cancel;\r\n}\r\nif (nsbp->sb_rextsize != sbp->sb_rextsize)\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_REXTSIZE,\r\nnsbp->sb_rextsize - sbp->sb_rextsize);\r\nif (nsbp->sb_rbmblocks != sbp->sb_rbmblocks)\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_RBMBLOCKS,\r\nnsbp->sb_rbmblocks - sbp->sb_rbmblocks);\r\nif (nsbp->sb_rblocks != sbp->sb_rblocks)\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_RBLOCKS,\r\nnsbp->sb_rblocks - sbp->sb_rblocks);\r\nif (nsbp->sb_rextents != sbp->sb_rextents)\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_REXTENTS,\r\nnsbp->sb_rextents - sbp->sb_rextents);\r\nif (nsbp->sb_rextslog != sbp->sb_rextslog)\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_REXTSLOG,\r\nnsbp->sb_rextslog - sbp->sb_rextslog);\r\nbp = NULL;\r\nerror = xfs_rtfree_range(nmp, tp, sbp->sb_rextents,\r\nnsbp->sb_rextents - sbp->sb_rextents, &bp, &sumbno);\r\nif (error) {\r\nerror_cancel:\r\nxfs_trans_cancel(tp, cancelflags);\r\nbreak;\r\n}\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_FREXTENTS,\r\nnsbp->sb_rextents - sbp->sb_rextents);\r\nmp->m_rsumlevels = nrsumlevels;\r\nmp->m_rsumsize = nrsumsize;\r\nerror = xfs_trans_commit(tp, 0);\r\nif (error)\r\nbreak;\r\n}\r\nkmem_free(nmp);\r\nreturn error;\r\n}\r\nint\r\nxfs_rtallocate_extent(\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bno,\r\nxfs_extlen_t minlen,\r\nxfs_extlen_t maxlen,\r\nxfs_extlen_t *len,\r\nxfs_alloctype_t type,\r\nint wasdel,\r\nxfs_extlen_t prod,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nxfs_mount_t *mp = tp->t_mountp;\r\nint error;\r\nxfs_rtblock_t r;\r\nxfs_fsblock_t sb;\r\nxfs_buf_t *sumbp;\r\nASSERT(xfs_isilocked(mp->m_rbmip, XFS_ILOCK_EXCL));\r\nASSERT(minlen > 0 && minlen <= maxlen);\r\nif (prod > 1) {\r\nxfs_extlen_t i;\r\nif ((i = maxlen % prod))\r\nmaxlen -= i;\r\nif ((i = minlen % prod))\r\nminlen += prod - i;\r\nif (maxlen < minlen) {\r\n*rtblock = NULLRTBLOCK;\r\nreturn 0;\r\n}\r\n}\r\nsumbp = NULL;\r\nswitch (type) {\r\ncase XFS_ALLOCTYPE_ANY_AG:\r\nerror = xfs_rtallocate_extent_size(mp, tp, minlen, maxlen, len,\r\n&sumbp, &sb, prod, &r);\r\nbreak;\r\ncase XFS_ALLOCTYPE_NEAR_BNO:\r\nerror = xfs_rtallocate_extent_near(mp, tp, bno, minlen, maxlen,\r\nlen, &sumbp, &sb, prod, &r);\r\nbreak;\r\ncase XFS_ALLOCTYPE_THIS_BNO:\r\nerror = xfs_rtallocate_extent_exact(mp, tp, bno, minlen, maxlen,\r\nlen, &sumbp, &sb, prod, &r);\r\nbreak;\r\ndefault:\r\nerror = EIO;\r\nASSERT(0);\r\n}\r\nif (error)\r\nreturn error;\r\nif (r != NULLRTBLOCK) {\r\nlong slen = (long)*len;\r\nASSERT(*len >= minlen && *len <= maxlen);\r\nif (wasdel)\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_RES_FREXTENTS, -slen);\r\nelse\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_FREXTENTS, -slen);\r\n}\r\n*rtblock = r;\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtfree_extent(\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bno,\r\nxfs_extlen_t len)\r\n{\r\nint error;\r\nxfs_mount_t *mp;\r\nxfs_fsblock_t sb;\r\nxfs_buf_t *sumbp;\r\nmp = tp->t_mountp;\r\nxfs_ilock(mp->m_rbmip, XFS_ILOCK_EXCL);\r\nxfs_trans_ijoin(tp, mp->m_rbmip, XFS_ILOCK_EXCL);\r\n#if defined(__KERNEL__) && defined(DEBUG)\r\n{\r\nint stat;\r\nerror = xfs_rtcheck_alloc_range(mp, tp, bno, len, &stat);\r\nif (error) {\r\nreturn error;\r\n}\r\nASSERT(stat);\r\n}\r\n#endif\r\nsumbp = NULL;\r\nerror = xfs_rtfree_range(mp, tp, bno, len, &sumbp, &sb);\r\nif (error) {\r\nreturn error;\r\n}\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_FREXTENTS, (long)len);\r\nif (tp->t_frextents_delta + mp->m_sb.sb_frextents ==\r\nmp->m_sb.sb_rextents) {\r\nif (!(mp->m_rbmip->i_d.di_flags & XFS_DIFLAG_NEWRTBM))\r\nmp->m_rbmip->i_d.di_flags |= XFS_DIFLAG_NEWRTBM;\r\n*(__uint64_t *)&mp->m_rbmip->i_d.di_atime = 0;\r\nxfs_trans_log_inode(tp, mp->m_rbmip, XFS_ILOG_CORE);\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtmount_init(\r\nxfs_mount_t *mp)\r\n{\r\nxfs_buf_t *bp;\r\nxfs_daddr_t d;\r\nxfs_sb_t *sbp;\r\nsbp = &mp->m_sb;\r\nif (sbp->sb_rblocks == 0)\r\nreturn 0;\r\nif (mp->m_rtdev_targp == NULL) {\r\nxfs_warn(mp,\r\n"Filesystem has a realtime volume, use rtdev=device option");\r\nreturn XFS_ERROR(ENODEV);\r\n}\r\nmp->m_rsumlevels = sbp->sb_rextslog + 1;\r\nmp->m_rsumsize =\r\n(uint)sizeof(xfs_suminfo_t) * mp->m_rsumlevels *\r\nsbp->sb_rbmblocks;\r\nmp->m_rsumsize = roundup(mp->m_rsumsize, sbp->sb_blocksize);\r\nmp->m_rbmip = mp->m_rsumip = NULL;\r\nd = (xfs_daddr_t)XFS_FSB_TO_BB(mp, mp->m_sb.sb_rblocks);\r\nif (XFS_BB_TO_FSB(mp, d) != mp->m_sb.sb_rblocks) {\r\nxfs_warn(mp, "realtime mount -- %llu != %llu",\r\n(unsigned long long) XFS_BB_TO_FSB(mp, d),\r\n(unsigned long long) mp->m_sb.sb_rblocks);\r\nreturn XFS_ERROR(EFBIG);\r\n}\r\nbp = xfs_buf_read_uncached(mp, mp->m_rtdev_targp,\r\nd - XFS_FSB_TO_BB(mp, 1),\r\nXFS_FSB_TO_B(mp, 1), 0);\r\nif (!bp) {\r\nxfs_warn(mp, "realtime device size check failed");\r\nreturn EIO;\r\n}\r\nxfs_buf_relse(bp);\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtmount_inodes(\r\nxfs_mount_t *mp)\r\n{\r\nint error;\r\nxfs_sb_t *sbp;\r\nsbp = &mp->m_sb;\r\nif (sbp->sb_rbmino == NULLFSINO)\r\nreturn 0;\r\nerror = xfs_iget(mp, NULL, sbp->sb_rbmino, 0, 0, &mp->m_rbmip);\r\nif (error)\r\nreturn error;\r\nASSERT(mp->m_rbmip != NULL);\r\nASSERT(sbp->sb_rsumino != NULLFSINO);\r\nerror = xfs_iget(mp, NULL, sbp->sb_rsumino, 0, 0, &mp->m_rsumip);\r\nif (error) {\r\nIRELE(mp->m_rbmip);\r\nreturn error;\r\n}\r\nASSERT(mp->m_rsumip != NULL);\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_rtunmount_inodes(\r\nstruct xfs_mount *mp)\r\n{\r\nif (mp->m_rbmip)\r\nIRELE(mp->m_rbmip);\r\nif (mp->m_rsumip)\r\nIRELE(mp->m_rsumip);\r\n}\r\nint\r\nxfs_rtpick_extent(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_extlen_t len,\r\nxfs_rtblock_t *pick)\r\n{\r\nxfs_rtblock_t b;\r\nint log2;\r\n__uint64_t resid;\r\n__uint64_t seq;\r\n__uint64_t *seqp;\r\nASSERT(xfs_isilocked(mp->m_rbmip, XFS_ILOCK_EXCL));\r\nseqp = (__uint64_t *)&mp->m_rbmip->i_d.di_atime;\r\nif (!(mp->m_rbmip->i_d.di_flags & XFS_DIFLAG_NEWRTBM)) {\r\nmp->m_rbmip->i_d.di_flags |= XFS_DIFLAG_NEWRTBM;\r\n*seqp = 0;\r\n}\r\nseq = *seqp;\r\nif ((log2 = xfs_highbit64(seq)) == -1)\r\nb = 0;\r\nelse {\r\nresid = seq - (1ULL << log2);\r\nb = (mp->m_sb.sb_rextents * ((resid << 1) + 1ULL)) >>\r\n(log2 + 1);\r\nif (b >= mp->m_sb.sb_rextents)\r\nb = do_mod(b, mp->m_sb.sb_rextents);\r\nif (b + len > mp->m_sb.sb_rextents)\r\nb = mp->m_sb.sb_rextents - len;\r\n}\r\n*seqp = seq + 1;\r\nxfs_trans_log_inode(tp, mp->m_rbmip, XFS_ILOG_CORE);\r\n*pick = b;\r\nreturn 0;\r\n}

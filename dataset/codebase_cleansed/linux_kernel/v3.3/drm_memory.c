int drm_mem_info(char *buf, char **start, off_t offset,\r\nint len, int *eof, void *data)\r\n{\r\nreturn 0;\r\n}\r\nstatic void *agp_remap(unsigned long offset, unsigned long size,\r\nstruct drm_device * dev)\r\n{\r\nunsigned long i, num_pages =\r\nPAGE_ALIGN(size) / PAGE_SIZE;\r\nstruct drm_agp_mem *agpmem;\r\nstruct page **page_map;\r\nstruct page **phys_page_map;\r\nvoid *addr;\r\nsize = PAGE_ALIGN(size);\r\n#ifdef __alpha__\r\noffset -= dev->hose->mem_space->start;\r\n#endif\r\nlist_for_each_entry(agpmem, &dev->agp->memory, head)\r\nif (agpmem->bound <= offset\r\n&& (agpmem->bound + (agpmem->pages << PAGE_SHIFT)) >=\r\n(offset + size))\r\nbreak;\r\nif (&agpmem->head == &dev->agp->memory)\r\nreturn NULL;\r\npage_map = vmalloc(num_pages * sizeof(struct page *));\r\nif (!page_map)\r\nreturn NULL;\r\nphys_page_map = (agpmem->memory->pages + (offset - agpmem->bound) / PAGE_SIZE);\r\nfor (i = 0; i < num_pages; ++i)\r\npage_map[i] = phys_page_map[i];\r\naddr = vmap(page_map, num_pages, VM_IOREMAP, PAGE_AGP);\r\nvfree(page_map);\r\nreturn addr;\r\n}\r\nvoid drm_free_agp(DRM_AGP_MEM * handle, int pages)\r\n{\r\nagp_free_memory(handle);\r\n}\r\nint drm_bind_agp(DRM_AGP_MEM * handle, unsigned int start)\r\n{\r\nreturn agp_bind_memory(handle, start);\r\n}\r\nint drm_unbind_agp(DRM_AGP_MEM * handle)\r\n{\r\nreturn agp_unbind_memory(handle);\r\n}\r\nstatic inline void *agp_remap(unsigned long offset, unsigned long size,\r\nstruct drm_device * dev)\r\n{\r\nreturn NULL;\r\n}\r\nvoid drm_core_ioremap(struct drm_local_map *map, struct drm_device *dev)\r\n{\r\nif (drm_core_has_AGP(dev) &&\r\ndev->agp && dev->agp->cant_use_aperture && map->type == _DRM_AGP)\r\nmap->handle = agp_remap(map->offset, map->size, dev);\r\nelse\r\nmap->handle = ioremap(map->offset, map->size);\r\n}\r\nvoid drm_core_ioremap_wc(struct drm_local_map *map, struct drm_device *dev)\r\n{\r\nif (drm_core_has_AGP(dev) &&\r\ndev->agp && dev->agp->cant_use_aperture && map->type == _DRM_AGP)\r\nmap->handle = agp_remap(map->offset, map->size, dev);\r\nelse\r\nmap->handle = ioremap_wc(map->offset, map->size);\r\n}\r\nvoid drm_core_ioremapfree(struct drm_local_map *map, struct drm_device *dev)\r\n{\r\nif (!map->handle || !map->size)\r\nreturn;\r\nif (drm_core_has_AGP(dev) &&\r\ndev->agp && dev->agp->cant_use_aperture && map->type == _DRM_AGP)\r\nvunmap(map->handle);\r\nelse\r\niounmap(map->handle);\r\n}

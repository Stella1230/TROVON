static ssize_t w1_counter_read(struct device *device,\r\nstruct device_attribute *attr, char *out_buf)\r\n{\r\nstruct w1_slave *sl = dev_to_w1_slave(device);\r\nstruct w1_master *dev = sl->master;\r\nu8 rbuf[COUNTER_COUNT * READ_BYTE_COUNT];\r\nu8 wrbuf[3];\r\nint rom_addr;\r\nint read_byte_count;\r\nint result;\r\nssize_t c;\r\nint ii;\r\nint p;\r\nint crc;\r\nc = PAGE_SIZE;\r\nrom_addr = (12 << 5) + 31;\r\nwrbuf[0] = 0xA5;\r\nwrbuf[1] = rom_addr & 0xFF;\r\nwrbuf[2] = rom_addr >> 8;\r\nmutex_lock(&dev->mutex);\r\nif (!w1_reset_select_slave(sl)) {\r\nw1_write_block(dev, wrbuf, 3);\r\nread_byte_count = 0;\r\nfor (p = 0; p < 4; p++) {\r\nread_byte_count += w1_read_block(dev,\r\nrbuf + (p * READ_BYTE_COUNT), READ_BYTE_COUNT);\r\nfor (ii = 0; ii < READ_BYTE_COUNT; ++ii)\r\nc -= snprintf(out_buf + PAGE_SIZE - c,\r\nc, "%02x ",\r\nrbuf[(p * READ_BYTE_COUNT) + ii]);\r\nif (read_byte_count != (p + 1) * READ_BYTE_COUNT) {\r\ndev_warn(device,\r\n"w1_counter_read() returned %u bytes "\r\n"instead of %d bytes wanted.\n",\r\nread_byte_count,\r\nREAD_BYTE_COUNT);\r\nc -= snprintf(out_buf + PAGE_SIZE - c,\r\nc, "crc=NO\n");\r\n} else {\r\nif (p == 0) {\r\ncrc = crc16(CRC16_INIT, wrbuf, 3);\r\ncrc = crc16(crc, rbuf, 11);\r\n} else {\r\ncrc = crc16(CRC16_INIT,\r\n(rbuf + 11) +\r\n((p - 1) * READ_BYTE_COUNT),\r\nREAD_BYTE_COUNT);\r\n}\r\nif (crc == CRC16_VALID) {\r\nresult = 0;\r\nfor (ii = 4; ii > 0; ii--) {\r\nresult <<= 8;\r\nresult |= rbuf[(p *\r\nREAD_BYTE_COUNT) + ii];\r\n}\r\nc -= snprintf(out_buf + PAGE_SIZE - c,\r\nc, "crc=YES c=%d\n", result);\r\n} else {\r\nc -= snprintf(out_buf + PAGE_SIZE - c,\r\nc, "crc=NO\n");\r\n}\r\n}\r\n}\r\n} else {\r\nc -= snprintf(out_buf + PAGE_SIZE - c, c, "Connection error");\r\n}\r\nmutex_unlock(&dev->mutex);\r\nreturn PAGE_SIZE - c;\r\n}\r\nstatic int w1_f1d_add_slave(struct w1_slave *sl)\r\n{\r\nreturn device_create_file(&sl->dev, &w1_counter_attr);\r\n}\r\nstatic void w1_f1d_remove_slave(struct w1_slave *sl)\r\n{\r\ndevice_remove_file(&sl->dev, &w1_counter_attr);\r\n}\r\nstatic int __init w1_f1d_init(void)\r\n{\r\nreturn w1_register_family(&w1_family_1d);\r\n}\r\nstatic void __exit w1_f1d_exit(void)\r\n{\r\nw1_unregister_family(&w1_family_1d);\r\n}

static void trout_process_mddi_table(struct msm_mddi_client_data *client_data,\r\nstruct mddi_table *table, size_t count)\r\n{\r\nint i;\r\nfor (i = 0; i < count; i++) {\r\nuint32_t reg = table[i].reg;\r\nuint32_t value = table[i].value;\r\nif (reg == 0)\r\nudelay(value);\r\nelse if (reg == 1)\r\nmsleep(value);\r\nelse\r\nclient_data->remote_write(client_data, value, reg);\r\n}\r\n}\r\nstatic int trout_mddi_toshiba_client_init(\r\nstruct msm_mddi_bridge_platform_data *bridge_data,\r\nstruct msm_mddi_client_data *client_data)\r\n{\r\nint panel_id;\r\nclient_data->auto_hibernate(client_data, 0);\r\ntrout_process_mddi_table(client_data, mddi_toshiba_init_table,\r\nARRAY_SIZE(mddi_toshiba_init_table));\r\nclient_data->auto_hibernate(client_data, 1);\r\npanel_id = (client_data->remote_read(client_data, GPIODATA) >> 4) & 3;\r\nif (panel_id > 1) {\r\nprintk(KERN_WARNING "unknown panel id at mddi_enable\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int trout_mddi_toshiba_client_uninit(\r\nstruct msm_mddi_bridge_platform_data *bridge_data,\r\nstruct msm_mddi_client_data *client_data)\r\n{\r\nreturn 0;\r\n}\r\nint __init trout_init_panel(void)\r\n{\r\nint rc;\r\nif (!machine_is_trout())\r\nreturn 0;\r\nvreg_mddi_1v5 = vreg_get(0, "gp2");\r\nif (IS_ERR(vreg_mddi_1v5))\r\nreturn PTR_ERR(vreg_mddi_1v5);\r\nvreg_lcm_2v85 = vreg_get(0, "gp4");\r\nif (IS_ERR(vreg_lcm_2v85))\r\nreturn PTR_ERR(vreg_lcm_2v85);\r\ntrout_new_backlight = system_rev >= 5;\r\nif (trout_new_backlight) {\r\nuint32_t config = PCOM_GPIO_CFG(27, 0, GPIO_OUTPUT,\r\nGPIO_NO_PULL, GPIO_8MA);\r\nmsm_proc_comm(PCOM_RPC_GPIO_TLMM_CONFIG_EX, &config, 0);\r\n} else {\r\nuint32_t config = PCOM_GPIO_CFG(27, 1, GPIO_OUTPUT,\r\nGPIO_NO_PULL, GPIO_8MA);\r\nmsm_proc_comm(PCOM_RPC_GPIO_TLMM_CONFIG_EX, &config, 0);\r\ngp_clk = clk_get(NULL, "gp_clk");\r\nif (IS_ERR(gp_clk)) {\r\nprintk(KERN_ERR "trout_init_panel: could not get gp"\r\n"clock\n");\r\ngp_clk = NULL;\r\n}\r\nrc = clk_set_rate(gp_clk, 19200000);\r\nif (rc)\r\nprintk(KERN_ERR "trout_init_panel: set clock rate "\r\n"failed\n");\r\n}\r\nrc = platform_device_register(&msm_device_mdp);\r\nif (rc)\r\nreturn rc;\r\nmsm_device_mddi0.dev.platform_data = &mddi_pdata;\r\nreturn platform_device_register(&msm_device_mddi0);\r\n}

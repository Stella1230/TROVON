static void setup_modem_intcon(void __iomem *modem_intcon_base)\r\n{\r\nwritel(MODEM_INTCON_CPU_NBR, modem_intcon_base + DEST_IRQ41_OFFSET);\r\nwritel(MODEM_INTCON_CPU_NBR, modem_intcon_base + DEST_IRQ43_OFFSET);\r\nwritel(MODEM_INTCON_CPU_NBR, modem_intcon_base + DEST_IRQ45_OFFSET);\r\nwritel(MODEM_INTCON_PRIO_HIGH, modem_intcon_base + PRIO_IRQ41_OFFSET);\r\nwritel(MODEM_INTCON_PRIO_HIGH, modem_intcon_base + PRIO_IRQ43_OFFSET);\r\nwritel(MODEM_INTCON_PRIO_HIGH, modem_intcon_base + PRIO_IRQ45_OFFSET);\r\nwritel(MODEM_INTCON_ALLOW_IRQ41 |\r\nMODEM_INTCON_ALLOW_IRQ43 |\r\nMODEM_INTCON_ALLOW_IRQ45,\r\nmodem_intcon_base + ALLOW_IRQ_OFFSET);\r\n}\r\nstatic irqreturn_t modem_cpu_irq_handler(int irq, void *data)\r\n{\r\nint real_irq;\r\nint virt_irq;\r\nstruct modem_irq *mi = (struct modem_irq *)data;\r\nreal_irq = readl(mi->modem_intcon_base + MODEM_IRQ_REG_OFFSET) & 0xFF;\r\nvirt_irq = IRQ_MODEM_EVENTS_BASE + real_irq;\r\npr_debug("modem_irq: Worker read addr 0x%X and got value 0x%X "\r\n"which will be 0x%X (%d) which translates to "\r\n"virtual IRQ 0x%X (%d)!\n",\r\n(u32)mi->modem_intcon_base + MODEM_IRQ_REG_OFFSET,\r\nreal_irq,\r\nreal_irq & 0xFF,\r\nreal_irq & 0xFF,\r\nvirt_irq,\r\nvirt_irq);\r\nif (virt_irq != 0)\r\ngeneric_handle_irq(virt_irq);\r\npr_debug("modem_irq: Done handling virtual IRQ %d!\n", virt_irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void create_virtual_irq(int irq, struct irq_chip *modem_irq_chip)\r\n{\r\nirq_set_chip_and_handler(irq, modem_irq_chip, handle_simple_irq);\r\nset_irq_flags(irq, IRQF_VALID);\r\npr_debug("modem_irq: Created virtual IRQ %d\n", irq);\r\n}\r\nstatic int modem_irq_init(void)\r\n{\r\nint err;\r\nstatic struct irq_chip modem_irq_chip;\r\nstruct modem_irq *mi;\r\nif (!cpu_is_u5500())\r\nreturn -ENODEV;\r\npr_info("modem_irq: Set up IRQ handler for incoming modem IRQ %d\n",\r\nIRQ_DB5500_MODEM);\r\nmi = kmalloc(sizeof(struct modem_irq), GFP_KERNEL);\r\nif (!mi) {\r\npr_err("modem_irq: Could not allocate device\n");\r\nreturn -ENOMEM;\r\n}\r\nmi->modem_intcon_base =\r\nioremap(MODEM_INTCON_BASE_ADDR, MODEM_INTCON_SIZE);\r\npr_debug("modem_irq: ioremapped modem_intcon_base from "\r\n"phy 0x%x to virt 0x%x\n", MODEM_INTCON_BASE_ADDR,\r\n(u32)mi->modem_intcon_base);\r\nsetup_modem_intcon(mi->modem_intcon_base);\r\nmodem_irq_chip = dummy_irq_chip;\r\nmodem_irq_chip.name = "modem_irq";\r\ncreate_virtual_irq(MBOX_PAIR0_VIRT_IRQ, &modem_irq_chip);\r\ncreate_virtual_irq(MBOX_PAIR1_VIRT_IRQ, &modem_irq_chip);\r\ncreate_virtual_irq(MBOX_PAIR2_VIRT_IRQ, &modem_irq_chip);\r\nerr = request_threaded_irq(IRQ_DB5500_MODEM, NULL,\r\nmodem_cpu_irq_handler, IRQF_ONESHOT,\r\n"modem_irq", mi);\r\nif (err)\r\npr_err("modem_irq: Could not register IRQ %d\n",\r\nIRQ_DB5500_MODEM);\r\nreturn 0;\r\n}

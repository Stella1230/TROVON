static unsigned long\r\ninsert_bat (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((insn >> 21) & 0x1f) << 16);\r\n}\r\nstatic long\r\nextract_bat (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nif (((insn >> 21) & 0x1f) != ((insn >> 16) & 0x1f))\r\n*invalid = 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long\r\ninsert_bba (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((insn >> 16) & 0x1f) << 11);\r\n}\r\nstatic long\r\nextract_bba (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nif (((insn >> 16) & 0x1f) != ((insn >> 11) & 0x1f))\r\n*invalid = 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long\r\ninsert_bd (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (value & 0xfffc);\r\n}\r\nstatic long\r\nextract_bd (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn & 0xfffc) ^ 0x8000) - 0x8000;\r\n}\r\nstatic unsigned long\r\ninsert_bdm (unsigned long insn,\r\nlong value,\r\nint dialect,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif ((dialect & PPC_OPCODE_POWER4) == 0)\r\n{\r\nif ((value & 0x8000) != 0)\r\ninsn |= 1 << 21;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x14 << 21)) == (0x04 << 21))\r\ninsn |= 0x02 << 21;\r\nelse if ((insn & (0x14 << 21)) == (0x10 << 21))\r\ninsn |= 0x08 << 21;\r\n}\r\nreturn insn | (value & 0xfffc);\r\n}\r\nstatic long\r\nextract_bdm (unsigned long insn,\r\nint dialect,\r\nint *invalid)\r\n{\r\nif ((dialect & PPC_OPCODE_POWER4) == 0)\r\n{\r\nif (((insn & (1 << 21)) == 0) != ((insn & (1 << 15)) == 0))\r\n*invalid = 1;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x17 << 21)) != (0x06 << 21)\r\n&& (insn & (0x1d << 21)) != (0x18 << 21))\r\n*invalid = 1;\r\n}\r\nreturn ((insn & 0xfffc) ^ 0x8000) - 0x8000;\r\n}\r\nstatic unsigned long\r\ninsert_bdp (unsigned long insn,\r\nlong value,\r\nint dialect,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif ((dialect & PPC_OPCODE_POWER4) == 0)\r\n{\r\nif ((value & 0x8000) == 0)\r\ninsn |= 1 << 21;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x14 << 21)) == (0x04 << 21))\r\ninsn |= 0x03 << 21;\r\nelse if ((insn & (0x14 << 21)) == (0x10 << 21))\r\ninsn |= 0x09 << 21;\r\n}\r\nreturn insn | (value & 0xfffc);\r\n}\r\nstatic long\r\nextract_bdp (unsigned long insn,\r\nint dialect,\r\nint *invalid)\r\n{\r\nif ((dialect & PPC_OPCODE_POWER4) == 0)\r\n{\r\nif (((insn & (1 << 21)) == 0) == ((insn & (1 << 15)) == 0))\r\n*invalid = 1;\r\n}\r\nelse\r\n{\r\nif ((insn & (0x17 << 21)) != (0x07 << 21)\r\n&& (insn & (0x1d << 21)) != (0x19 << 21))\r\n*invalid = 1;\r\n}\r\nreturn ((insn & 0xfffc) ^ 0x8000) - 0x8000;\r\n}\r\nstatic int\r\nvalid_bo (long value, int dialect)\r\n{\r\nif ((dialect & PPC_OPCODE_POWER4) == 0)\r\n{\r\nswitch (value & 0x14)\r\n{\r\ndefault:\r\ncase 0:\r\nreturn 1;\r\ncase 0x4:\r\nreturn (value & 0x2) == 0;\r\ncase 0x10:\r\nreturn (value & 0x8) == 0;\r\ncase 0x14:\r\nreturn value == 0x14;\r\n}\r\n}\r\nelse\r\n{\r\nif ((value & 0x14) == 0)\r\nreturn (value & 0x1) == 0;\r\nelse if ((value & 0x14) == 0x14)\r\nreturn value == 0x14;\r\nelse\r\nreturn 1;\r\n}\r\n}\r\nstatic unsigned long\r\ninsert_bo (unsigned long insn,\r\nlong value,\r\nint dialect,\r\nconst char **errmsg)\r\n{\r\nif (!valid_bo (value, dialect))\r\n*errmsg = _("invalid conditional option");\r\nreturn insn | ((value & 0x1f) << 21);\r\n}\r\nstatic long\r\nextract_bo (unsigned long insn,\r\nint dialect,\r\nint *invalid)\r\n{\r\nlong value;\r\nvalue = (insn >> 21) & 0x1f;\r\nif (!valid_bo (value, dialect))\r\n*invalid = 1;\r\nreturn value;\r\n}\r\nstatic unsigned long\r\ninsert_boe (unsigned long insn,\r\nlong value,\r\nint dialect,\r\nconst char **errmsg)\r\n{\r\nif (!valid_bo (value, dialect))\r\n*errmsg = _("invalid conditional option");\r\nelse if ((value & 1) != 0)\r\n*errmsg = _("attempt to set y bit when using + or - modifier");\r\nreturn insn | ((value & 0x1f) << 21);\r\n}\r\nstatic long\r\nextract_boe (unsigned long insn,\r\nint dialect,\r\nint *invalid)\r\n{\r\nlong value;\r\nvalue = (insn >> 21) & 0x1f;\r\nif (!valid_bo (value, dialect))\r\n*invalid = 1;\r\nreturn value & 0x1e;\r\n}\r\nstatic unsigned long\r\ninsert_dq (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 0xf) != 0)\r\n*errmsg = _("offset not a multiple of 16");\r\nreturn insn | (value & 0xfff0);\r\n}\r\nstatic long\r\nextract_dq (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn & 0xfff0) ^ 0x8000) - 0x8000;\r\n}\r\nstatic unsigned long\r\ninsert_ev2 (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 1) != 0)\r\n*errmsg = _("offset not a multiple of 2");\r\nif ((value > 62) != 0)\r\n*errmsg = _("offset greater than 62");\r\nreturn insn | ((value & 0x3e) << 10);\r\n}\r\nstatic long\r\nextract_ev2 (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn (insn >> 10) & 0x3e;\r\n}\r\nstatic unsigned long\r\ninsert_ev4 (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 3) != 0)\r\n*errmsg = _("offset not a multiple of 4");\r\nif ((value > 124) != 0)\r\n*errmsg = _("offset greater than 124");\r\nreturn insn | ((value & 0x7c) << 9);\r\n}\r\nstatic long\r\nextract_ev4 (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn (insn >> 9) & 0x7c;\r\n}\r\nstatic unsigned long\r\ninsert_ev8 (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 7) != 0)\r\n*errmsg = _("offset not a multiple of 8");\r\nif ((value > 248) != 0)\r\n*errmsg = _("offset greater than 248");\r\nreturn insn | ((value & 0xf8) << 8);\r\n}\r\nstatic long\r\nextract_ev8 (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn (insn >> 8) & 0xf8;\r\n}\r\nstatic unsigned long\r\ninsert_ds (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 3) != 0)\r\n*errmsg = _("offset not a multiple of 4");\r\nreturn insn | (value & 0xfffc);\r\n}\r\nstatic long\r\nextract_ds (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn & 0xfffc) ^ 0x8000) - 0x8000;\r\n}\r\nstatic unsigned long\r\ninsert_de (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value > 2047 || value < -2048)\r\n*errmsg = _("offset not between -2048 and 2047");\r\nreturn insn | ((value << 4) & 0xfff0);\r\n}\r\nstatic long\r\nextract_de (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn (insn & 0xfff0) >> 4;\r\n}\r\nstatic unsigned long\r\ninsert_des (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value > 8191 || value < -8192)\r\n*errmsg = _("offset not between -8192 and 8191");\r\nelse if ((value & 3) != 0)\r\n*errmsg = _("offset not a multiple of 4");\r\nreturn insn | ((value << 2) & 0xfff0);\r\n}\r\nstatic long\r\nextract_des (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn (((insn >> 2) & 0x3ffc) ^ 0x2000) - 0x2000;\r\n}\r\nstatic unsigned long\r\ninsert_fxm (unsigned long insn,\r\nlong value,\r\nint dialect,\r\nconst char **errmsg)\r\n{\r\nif ((insn & (1 << 20)) != 0)\r\n{\r\nif (value == 0 || (value & -value) != value)\r\n{\r\n*errmsg = _("invalid mask field");\r\nvalue = 0;\r\n}\r\n}\r\nelse if (value == 0)\r\n;\r\nelse if ((value & -value) == value\r\n&& ((dialect & PPC_OPCODE_POWER4) != 0\r\n|| ((dialect & PPC_OPCODE_ANY) != 0\r\n&& (insn & (0x3ff << 1)) == 19 << 1)))\r\ninsn |= 1 << 20;\r\nelse if ((insn & (0x3ff << 1)) == 19 << 1)\r\n{\r\n*errmsg = _("ignoring invalid mfcr mask");\r\nvalue = 0;\r\n}\r\nreturn insn | ((value & 0xff) << 12);\r\n}\r\nstatic long\r\nextract_fxm (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nlong mask = (insn >> 12) & 0xff;\r\nif ((insn & (1 << 20)) != 0)\r\n{\r\nif (mask == 0 || (mask & -mask) != mask)\r\n*invalid = 1;\r\n}\r\nelse if ((insn & (0x3ff << 1)) == 19 << 1)\r\n{\r\nif (mask != 0)\r\n*invalid = 1;\r\n}\r\nreturn mask;\r\n}\r\nstatic unsigned long\r\ninsert_li (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 3) != 0)\r\n*errmsg = _("ignoring least significant bits in branch offset");\r\nreturn insn | (value & 0x3fffffc);\r\n}\r\nstatic long\r\nextract_li (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn & 0x3fffffc) ^ 0x2000000) - 0x2000000;\r\n}\r\nstatic unsigned long\r\ninsert_mbe (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nunsigned long uval, mask;\r\nint mb, me, mx, count, last;\r\nuval = value;\r\nif (uval == 0)\r\n{\r\n*errmsg = _("illegal bitmask");\r\nreturn insn;\r\n}\r\nmb = 0;\r\nme = 32;\r\nif ((uval & 1) != 0)\r\nlast = 1;\r\nelse\r\nlast = 0;\r\ncount = 0;\r\nfor (mx = 0, mask = 1L << 31; mx < 32; ++mx, mask >>= 1)\r\n{\r\nif ((uval & mask) && !last)\r\n{\r\n++count;\r\nmb = mx;\r\nlast = 1;\r\n}\r\nelse if (!(uval & mask) && last)\r\n{\r\n++count;\r\nme = mx;\r\nlast = 0;\r\n}\r\n}\r\nif (me == 0)\r\nme = 32;\r\nif (count != 2 && (count != 0 || ! last))\r\n*errmsg = _("illegal bitmask");\r\nreturn insn | (mb << 6) | ((me - 1) << 1);\r\n}\r\nstatic long\r\nextract_mbe (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nlong ret;\r\nint mb, me;\r\nint i;\r\n*invalid = 1;\r\nmb = (insn >> 6) & 0x1f;\r\nme = (insn >> 1) & 0x1f;\r\nif (mb < me + 1)\r\n{\r\nret = 0;\r\nfor (i = mb; i <= me; i++)\r\nret |= 1L << (31 - i);\r\n}\r\nelse if (mb == me + 1)\r\nret = ~0;\r\nelse\r\n{\r\nret = ~0;\r\nfor (i = me + 1; i < mb; i++)\r\nret &= ~(1L << (31 - i));\r\n}\r\nreturn ret;\r\n}\r\nstatic unsigned long\r\ninsert_mb6 (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 6) | (value & 0x20);\r\n}\r\nstatic long\r\nextract_mb6 (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 6) & 0x1f) | (insn & 0x20);\r\n}\r\nstatic unsigned long\r\ninsert_nb (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value < 0 || value > 32)\r\n*errmsg = _("value out of range");\r\nif (value == 32)\r\nvalue = 0;\r\nreturn insn | ((value & 0x1f) << 11);\r\n}\r\nstatic long\r\nextract_nb (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nlong ret;\r\nret = (insn >> 11) & 0x1f;\r\nif (ret == 0)\r\nret = 32;\r\nreturn ret;\r\n}\r\nstatic unsigned long\r\ninsert_nsi (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (-value & 0xffff);\r\n}\r\nstatic long\r\nextract_nsi (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\n*invalid = 1;\r\nreturn -(((insn & 0xffff) ^ 0x8000) - 0x8000);\r\n}\r\nstatic unsigned long\r\ninsert_ral (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value == 0\r\n|| (unsigned long) value == ((insn >> 21) & 0x1f))\r\n*errmsg = "invalid register operand when updating";\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_ram (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((unsigned long) value >= ((insn >> 21) & 0x1f))\r\n*errmsg = _("index register in load range");\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_raq (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nlong rtvalue = (insn & RT_MASK) >> 21;\r\nif (value == rtvalue)\r\n*errmsg = _("source and target register operands must be different");\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_ras (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif (value == 0)\r\n*errmsg = _("invalid register operand when updating");\r\nreturn insn | ((value & 0x1f) << 16);\r\n}\r\nstatic unsigned long\r\ninsert_rbs (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | (((insn >> 21) & 0x1f) << 11);\r\n}\r\nstatic long\r\nextract_rbs (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid)\r\n{\r\nif (((insn >> 21) & 0x1f) != ((insn >> 11) & 0x1f))\r\n*invalid = 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long\r\ninsert_rtq (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 1) != 0)\r\n*errmsg = _("target register operand must be even");\r\nreturn insn | ((value & 0x1f) << 21);\r\n}\r\nstatic unsigned long\r\ninsert_rsq (unsigned long insn,\r\nlong value ATTRIBUTE_UNUSED,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg)\r\n{\r\nif ((value & 1) != 0)\r\n*errmsg = _("source register operand must be even");\r\nreturn insn | ((value & 0x1f) << 21);\r\n}\r\nstatic unsigned long\r\ninsert_sh6 (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 11) | ((value & 0x20) >> 4);\r\n}\r\nstatic long\r\nextract_sh6 (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 11) & 0x1f) | ((insn << 4) & 0x20);\r\n}\r\nstatic unsigned long\r\ninsert_spr (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nreturn insn | ((value & 0x1f) << 16) | ((value & 0x3e0) << 6);\r\n}\r\nstatic long\r\nextract_spr (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nreturn ((insn >> 16) & 0x1f) | ((insn >> 6) & 0x3e0);\r\n}\r\nstatic unsigned long\r\ninsert_sprg (unsigned long insn,\r\nlong value,\r\nint dialect,\r\nconst char **errmsg)\r\n{\r\nif (value > 7\r\n|| (value > 3\r\n&& (dialect & (PPC_OPCODE_BOOKE | PPC_OPCODE_403)) == 0))\r\n*errmsg = _("invalid sprg number");\r\nif (value <= 3 || (insn & 0x100) != 0)\r\nvalue |= 0x10;\r\nreturn insn | ((value & 0x17) << 16);\r\n}\r\nstatic long\r\nextract_sprg (unsigned long insn,\r\nint dialect,\r\nint *invalid)\r\n{\r\nunsigned long val = (insn >> 16) & 0x1f;\r\nif (val <= 3\r\n|| (val < 0x10 && (insn & 0x100) != 0)\r\n|| (val - 0x10 > 3\r\n&& (dialect & (PPC_OPCODE_BOOKE | PPC_OPCODE_403)) == 0))\r\n*invalid = 1;\r\nreturn val & 7;\r\n}\r\nstatic unsigned long\r\ninsert_tbr (unsigned long insn,\r\nlong value,\r\nint dialect ATTRIBUTE_UNUSED,\r\nconst char **errmsg ATTRIBUTE_UNUSED)\r\n{\r\nif (value == 0)\r\nvalue = TB;\r\nreturn insn | ((value & 0x1f) << 16) | ((value & 0x3e0) << 6);\r\n}\r\nstatic long\r\nextract_tbr (unsigned long insn,\r\nint dialect ATTRIBUTE_UNUSED,\r\nint *invalid ATTRIBUTE_UNUSED)\r\n{\r\nlong ret;\r\nret = ((insn >> 16) & 0x1f) | ((insn >> 6) & 0x3e0);\r\nif (ret == TB)\r\nret = 0;\r\nreturn ret;\r\n}

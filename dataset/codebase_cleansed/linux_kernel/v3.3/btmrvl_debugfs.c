static int btmrvl_open_generic(struct inode *inode, struct file *file)\r\n{\r\nfile->private_data = inode->i_private;\r\nreturn 0;\r\n}\r\nstatic ssize_t btmrvl_hscfgcmd_write(struct file *file,\r\nconst char __user *ubuf, size_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nlong result, ret;\r\nmemset(buf, 0, sizeof(buf));\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nret = strict_strtol(buf, 10, &result);\r\nif (ret)\r\nreturn ret;\r\npriv->btmrvl_dev.hscfgcmd = result;\r\nif (priv->btmrvl_dev.hscfgcmd) {\r\nbtmrvl_prepare_command(priv);\r\nwake_up_interruptible(&priv->main_thread.wait_q);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t btmrvl_hscfgcmd_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n",\r\npriv->btmrvl_dev.hscfgcmd);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_psmode_write(struct file *file, const char __user *ubuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nlong result, ret;\r\nmemset(buf, 0, sizeof(buf));\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nret = strict_strtol(buf, 10, &result);\r\nif (ret)\r\nreturn ret;\r\npriv->btmrvl_dev.psmode = result;\r\nreturn count;\r\n}\r\nstatic ssize_t btmrvl_psmode_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n",\r\npriv->btmrvl_dev.psmode);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_pscmd_write(struct file *file, const char __user *ubuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nlong result, ret;\r\nmemset(buf, 0, sizeof(buf));\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nret = strict_strtol(buf, 10, &result);\r\nif (ret)\r\nreturn ret;\r\npriv->btmrvl_dev.pscmd = result;\r\nif (priv->btmrvl_dev.pscmd) {\r\nbtmrvl_prepare_command(priv);\r\nwake_up_interruptible(&priv->main_thread.wait_q);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t btmrvl_pscmd_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n", priv->btmrvl_dev.pscmd);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_gpiogap_write(struct file *file, const char __user *ubuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nlong result, ret;\r\nmemset(buf, 0, sizeof(buf));\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nret = strict_strtol(buf, 16, &result);\r\nif (ret)\r\nreturn ret;\r\npriv->btmrvl_dev.gpio_gap = result;\r\nreturn count;\r\n}\r\nstatic ssize_t btmrvl_gpiogap_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "0x%x\n",\r\npriv->btmrvl_dev.gpio_gap);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_hscmd_write(struct file *file, const char __user *ubuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nlong result, ret;\r\nmemset(buf, 0, sizeof(buf));\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nret = strict_strtol(buf, 10, &result);\r\nif (ret)\r\nreturn ret;\r\npriv->btmrvl_dev.hscmd = result;\r\nif (priv->btmrvl_dev.hscmd) {\r\nbtmrvl_prepare_command(priv);\r\nwake_up_interruptible(&priv->main_thread.wait_q);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t btmrvl_hscmd_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n", priv->btmrvl_dev.hscmd);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_hsmode_write(struct file *file, const char __user *ubuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nlong result, ret;\r\nmemset(buf, 0, sizeof(buf));\r\nif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\r\nreturn -EFAULT;\r\nret = strict_strtol(buf, 10, &result);\r\nif (ret)\r\nreturn ret;\r\npriv->btmrvl_dev.hsmode = result;\r\nreturn count;\r\n}\r\nstatic ssize_t btmrvl_hsmode_read(struct file *file, char __user * userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n", priv->btmrvl_dev.hsmode);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_curpsmode_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n", priv->adapter->psmode);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_psstate_read(struct file *file, char __user * userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n", priv->adapter->ps_state);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_hsstate_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n", priv->adapter->hs_state);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nstatic ssize_t btmrvl_txdnldready_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct btmrvl_private *priv = file->private_data;\r\nchar buf[16];\r\nint ret;\r\nret = snprintf(buf, sizeof(buf) - 1, "%d\n",\r\npriv->btmrvl_dev.tx_dnld_rdy);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\r\n}\r\nvoid btmrvl_debugfs_init(struct hci_dev *hdev)\r\n{\r\nstruct btmrvl_private *priv = hdev->driver_data;\r\nstruct btmrvl_debugfs_data *dbg;\r\nif (!hdev->debugfs)\r\nreturn;\r\ndbg = kzalloc(sizeof(*dbg), GFP_KERNEL);\r\npriv->debugfs_data = dbg;\r\nif (!dbg) {\r\nBT_ERR("Can not allocate memory for btmrvl_debugfs_data.");\r\nreturn;\r\n}\r\ndbg->config_dir = debugfs_create_dir("config", hdev->debugfs);\r\ndbg->psmode = debugfs_create_file("psmode", 0644, dbg->config_dir,\r\nhdev->driver_data, &btmrvl_psmode_fops);\r\ndbg->pscmd = debugfs_create_file("pscmd", 0644, dbg->config_dir,\r\nhdev->driver_data, &btmrvl_pscmd_fops);\r\ndbg->gpiogap = debugfs_create_file("gpiogap", 0644, dbg->config_dir,\r\nhdev->driver_data, &btmrvl_gpiogap_fops);\r\ndbg->hsmode = debugfs_create_file("hsmode", 0644, dbg->config_dir,\r\nhdev->driver_data, &btmrvl_hsmode_fops);\r\ndbg->hscmd = debugfs_create_file("hscmd", 0644, dbg->config_dir,\r\nhdev->driver_data, &btmrvl_hscmd_fops);\r\ndbg->hscfgcmd = debugfs_create_file("hscfgcmd", 0644, dbg->config_dir,\r\nhdev->driver_data, &btmrvl_hscfgcmd_fops);\r\ndbg->status_dir = debugfs_create_dir("status", hdev->debugfs);\r\ndbg->curpsmode = debugfs_create_file("curpsmode", 0444,\r\ndbg->status_dir,\r\nhdev->driver_data,\r\n&btmrvl_curpsmode_fops);\r\ndbg->psstate = debugfs_create_file("psstate", 0444, dbg->status_dir,\r\nhdev->driver_data, &btmrvl_psstate_fops);\r\ndbg->hsstate = debugfs_create_file("hsstate", 0444, dbg->status_dir,\r\nhdev->driver_data, &btmrvl_hsstate_fops);\r\ndbg->txdnldready = debugfs_create_file("txdnldready", 0444,\r\ndbg->status_dir,\r\nhdev->driver_data,\r\n&btmrvl_txdnldready_fops);\r\n}\r\nvoid btmrvl_debugfs_remove(struct hci_dev *hdev)\r\n{\r\nstruct btmrvl_private *priv = hdev->driver_data;\r\nstruct btmrvl_debugfs_data *dbg = priv->debugfs_data;\r\nif (!dbg)\r\nreturn;\r\ndebugfs_remove(dbg->psmode);\r\ndebugfs_remove(dbg->pscmd);\r\ndebugfs_remove(dbg->gpiogap);\r\ndebugfs_remove(dbg->hsmode);\r\ndebugfs_remove(dbg->hscmd);\r\ndebugfs_remove(dbg->hscfgcmd);\r\ndebugfs_remove(dbg->config_dir);\r\ndebugfs_remove(dbg->curpsmode);\r\ndebugfs_remove(dbg->psstate);\r\ndebugfs_remove(dbg->hsstate);\r\ndebugfs_remove(dbg->txdnldready);\r\ndebugfs_remove(dbg->status_dir);\r\nkfree(dbg);\r\n}

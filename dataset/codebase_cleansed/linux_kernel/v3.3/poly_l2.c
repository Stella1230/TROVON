void poly_l2(FPU_REG *st0_ptr, FPU_REG *st1_ptr, u_char st1_sign)\r\n{\r\nlong int exponent, expon, expon_expon;\r\nXsig accumulator, expon_accum, yaccum;\r\nu_char sign, argsign;\r\nFPU_REG x;\r\nint tag;\r\nexponent = exponent16(st0_ptr);\r\nif (st0_ptr->sigh > (unsigned)0xb504f334) {\r\nsignificand(&x) = -significand(st0_ptr);\r\nsetexponent16(&x, -1);\r\nexponent++;\r\nargsign = SIGN_NEG;\r\n} else {\r\nx.sigh = st0_ptr->sigh - 0x80000000;\r\nx.sigl = st0_ptr->sigl;\r\nsetexponent16(&x, 0);\r\nargsign = SIGN_POS;\r\n}\r\ntag = FPU_normalize_nuo(&x);\r\nif (tag == TAG_Zero) {\r\nexpon = 0;\r\naccumulator.msw = accumulator.midw = accumulator.lsw = 0;\r\n} else {\r\nlog2_kernel(&x, argsign, &accumulator, &expon);\r\n}\r\nif (exponent < 0) {\r\nsign = SIGN_NEG;\r\nexponent = -exponent;\r\n} else\r\nsign = SIGN_POS;\r\nexpon_accum.msw = exponent;\r\nexpon_accum.midw = expon_accum.lsw = 0;\r\nif (exponent) {\r\nexpon_expon = 31 + norm_Xsig(&expon_accum);\r\nshr_Xsig(&accumulator, expon_expon - expon);\r\nif (sign ^ argsign)\r\nnegate_Xsig(&accumulator);\r\nadd_Xsig_Xsig(&accumulator, &expon_accum);\r\n} else {\r\nexpon_expon = expon;\r\nsign = argsign;\r\n}\r\nyaccum.lsw = 0;\r\nXSIG_LL(yaccum) = significand(st1_ptr);\r\nmul_Xsig_Xsig(&accumulator, &yaccum);\r\nexpon_expon += round_Xsig(&accumulator);\r\nif (accumulator.msw == 0) {\r\nFPU_copy_to_reg1(&CONST_Z, TAG_Zero);\r\nreturn;\r\n}\r\nsignificand(st1_ptr) = XSIG_LL(accumulator);\r\nsetexponent16(st1_ptr, expon_expon + exponent16(st1_ptr) + 1);\r\ntag = FPU_round(st1_ptr, 1, 0, FULL_PRECISION, sign ^ st1_sign);\r\nFPU_settagi(1, tag);\r\nset_precision_flag_up();\r\nreturn;\r\n}\r\nint poly_l2p1(u_char sign0, u_char sign1,\r\nFPU_REG * st0_ptr, FPU_REG * st1_ptr, FPU_REG * dest)\r\n{\r\nu_char tag;\r\nlong int exponent;\r\nXsig accumulator, yaccum;\r\nif (exponent16(st0_ptr) < 0) {\r\nlog2_kernel(st0_ptr, sign0, &accumulator, &exponent);\r\nyaccum.lsw = 0;\r\nXSIG_LL(yaccum) = significand(st1_ptr);\r\nmul_Xsig_Xsig(&accumulator, &yaccum);\r\nexponent += round_Xsig(&accumulator);\r\nexponent += exponent16(st1_ptr) + 1;\r\nif (exponent < EXP_WAY_UNDER)\r\nexponent = EXP_WAY_UNDER;\r\nsignificand(dest) = XSIG_LL(accumulator);\r\nsetexponent16(dest, exponent);\r\ntag = FPU_round(dest, 1, 0, FULL_PRECISION, sign0 ^ sign1);\r\nFPU_settagi(1, tag);\r\nif (tag == TAG_Valid)\r\nset_precision_flag_up();\r\n} else {\r\nif (sign0 != SIGN_POS) {\r\n#ifdef PECULIAR_486\r\nchangesign(st1_ptr);\r\n#else\r\nif (arith_invalid(1) < 0)\r\nreturn 1;\r\n#endif\r\n}\r\nif (sign0 == SIGN_NEG)\r\nset_precision_flag_down();\r\nelse\r\nset_precision_flag_up();\r\n}\r\nif (exponent(dest) <= EXP_UNDER)\r\nEXCEPTION(EX_Underflow);\r\nreturn 0;\r\n}\r\nstatic void log2_kernel(FPU_REG const *arg, u_char argsign, Xsig *accum_result,\r\nlong int *expon)\r\n{\r\nlong int exponent, adj;\r\nunsigned long long Xsq;\r\nXsig accumulator, Numer, Denom, argSignif, arg_signif;\r\nexponent = exponent16(arg);\r\nNumer.lsw = Denom.lsw = 0;\r\nXSIG_LL(Numer) = XSIG_LL(Denom) = significand(arg);\r\nif (argsign == SIGN_POS) {\r\nshr_Xsig(&Denom, 2 - (1 + exponent));\r\nDenom.msw |= 0x80000000;\r\ndiv_Xsig(&Numer, &Denom, &argSignif);\r\n} else {\r\nshr_Xsig(&Denom, 1 - (1 + exponent));\r\nnegate_Xsig(&Denom);\r\nif (Denom.msw & 0x80000000) {\r\ndiv_Xsig(&Numer, &Denom, &argSignif);\r\nexponent++;\r\n} else {\r\nargSignif.lsw = Numer.lsw;\r\nargSignif.midw = Numer.midw;\r\nargSignif.msw = Numer.msw;\r\n}\r\n}\r\n#ifndef PECULIAR_486\r\nif (exponent >= -2) {\r\nif ((exponent > -2) || (argSignif.msw > (unsigned)0xafb0ccc0)) {\r\n}\r\n}\r\n#endif\r\narg_signif.lsw = argSignif.lsw;\r\nXSIG_LL(arg_signif) = XSIG_LL(argSignif);\r\nadj = norm_Xsig(&argSignif);\r\naccumulator.lsw = argSignif.lsw;\r\nXSIG_LL(accumulator) = XSIG_LL(argSignif);\r\nmul_Xsig_Xsig(&accumulator, &accumulator);\r\nshr_Xsig(&accumulator, 2 * (-1 - (1 + exponent + adj)));\r\nXsq = XSIG_LL(accumulator);\r\nif (accumulator.lsw & 0x80000000)\r\nXsq++;\r\naccumulator.msw = accumulator.midw = accumulator.lsw = 0;\r\npolynomial_Xsig(&accumulator, &Xsq, logterms, HIPOWER - 1);\r\nmul_Xsig_Xsig(&accumulator, &argSignif);\r\nshr_Xsig(&accumulator, 6 - adj);\r\nmul32_Xsig(&arg_signif, leadterm);\r\nadd_two_Xsig(&accumulator, &arg_signif, &exponent);\r\n*expon = exponent + 1;\r\naccum_result->lsw = accumulator.lsw;\r\naccum_result->midw = accumulator.midw;\r\naccum_result->msw = accumulator.msw;\r\n}

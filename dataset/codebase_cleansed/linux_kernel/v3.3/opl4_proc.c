static int snd_opl4_mem_proc_open(struct snd_info_entry *entry,\r\nunsigned short mode, void **file_private_data)\r\n{\r\nstruct snd_opl4 *opl4 = entry->private_data;\r\nmutex_lock(&opl4->access_mutex);\r\nif (opl4->memory_access) {\r\nmutex_unlock(&opl4->access_mutex);\r\nreturn -EBUSY;\r\n}\r\nopl4->memory_access++;\r\nmutex_unlock(&opl4->access_mutex);\r\nreturn 0;\r\n}\r\nstatic int snd_opl4_mem_proc_release(struct snd_info_entry *entry,\r\nunsigned short mode, void *file_private_data)\r\n{\r\nstruct snd_opl4 *opl4 = entry->private_data;\r\nmutex_lock(&opl4->access_mutex);\r\nopl4->memory_access--;\r\nmutex_unlock(&opl4->access_mutex);\r\nreturn 0;\r\n}\r\nstatic ssize_t snd_opl4_mem_proc_read(struct snd_info_entry *entry,\r\nvoid *file_private_data,\r\nstruct file *file, char __user *_buf,\r\nsize_t count, loff_t pos)\r\n{\r\nstruct snd_opl4 *opl4 = entry->private_data;\r\nchar* buf;\r\nbuf = vmalloc(count);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nsnd_opl4_read_memory(opl4, buf, pos, count);\r\nif (copy_to_user(_buf, buf, count)) {\r\nvfree(buf);\r\nreturn -EFAULT;\r\n}\r\nvfree(buf);\r\nreturn count;\r\n}\r\nstatic ssize_t snd_opl4_mem_proc_write(struct snd_info_entry *entry,\r\nvoid *file_private_data,\r\nstruct file *file,\r\nconst char __user *_buf,\r\nsize_t count, loff_t pos)\r\n{\r\nstruct snd_opl4 *opl4 = entry->private_data;\r\nchar *buf;\r\nbuf = vmalloc(count);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nif (copy_from_user(buf, _buf, count)) {\r\nvfree(buf);\r\nreturn -EFAULT;\r\n}\r\nsnd_opl4_write_memory(opl4, buf, pos, count);\r\nvfree(buf);\r\nreturn count;\r\n}\r\nint snd_opl4_create_proc(struct snd_opl4 *opl4)\r\n{\r\nstruct snd_info_entry *entry;\r\nentry = snd_info_create_card_entry(opl4->card, "opl4-mem", opl4->card->proc_root);\r\nif (entry) {\r\nif (opl4->hardware < OPL3_HW_OPL4_ML) {\r\nentry->mode |= S_IWUSR;\r\nentry->size = 4 * 1024 * 1024;\r\n} else {\r\nentry->size = 1 * 1024 * 1024;\r\n}\r\nentry->content = SNDRV_INFO_CONTENT_DATA;\r\nentry->c.ops = &snd_opl4_mem_proc_ops;\r\nentry->module = THIS_MODULE;\r\nentry->private_data = opl4;\r\nif (snd_info_register(entry) < 0) {\r\nsnd_info_free_entry(entry);\r\nentry = NULL;\r\n}\r\n}\r\nopl4->proc_entry = entry;\r\nreturn 0;\r\n}\r\nvoid snd_opl4_free_proc(struct snd_opl4 *opl4)\r\n{\r\nsnd_info_free_entry(opl4->proc_entry);\r\n}

static void post_qp_event(struct c4iw_dev *dev, struct c4iw_cq *chp,\r\nstruct c4iw_qp *qhp,\r\nstruct t4_cqe *err_cqe,\r\nenum ib_event_type ib_event)\r\n{\r\nstruct ib_event event;\r\nstruct c4iw_qp_attributes attrs;\r\nunsigned long flag;\r\nif ((qhp->attr.state == C4IW_QP_STATE_ERROR) ||\r\n(qhp->attr.state == C4IW_QP_STATE_TERMINATE)) {\r\nPDBG("%s AE received after RTS - "\r\n"qp state %d qpid 0x%x status 0x%x\n", __func__,\r\nqhp->attr.state, qhp->wq.sq.qid, CQE_STATUS(err_cqe));\r\nreturn;\r\n}\r\nprintk(KERN_ERR MOD "AE qpid 0x%x opcode %d status 0x%x "\r\n"type %d wrid.hi 0x%x wrid.lo 0x%x\n",\r\nCQE_QPID(err_cqe), CQE_OPCODE(err_cqe),\r\nCQE_STATUS(err_cqe), CQE_TYPE(err_cqe),\r\nCQE_WRID_HI(err_cqe), CQE_WRID_LOW(err_cqe));\r\nif (qhp->attr.state == C4IW_QP_STATE_RTS) {\r\nattrs.next_state = C4IW_QP_STATE_TERMINATE;\r\nc4iw_modify_qp(qhp->rhp, qhp, C4IW_QP_ATTR_NEXT_STATE,\r\n&attrs, 0);\r\n}\r\nevent.event = ib_event;\r\nevent.device = chp->ibcq.device;\r\nif (ib_event == IB_EVENT_CQ_ERR)\r\nevent.element.cq = &chp->ibcq;\r\nelse\r\nevent.element.qp = &qhp->ibqp;\r\nif (qhp->ibqp.event_handler)\r\n(*qhp->ibqp.event_handler)(&event, qhp->ibqp.qp_context);\r\nspin_lock_irqsave(&chp->comp_handler_lock, flag);\r\n(*chp->ibcq.comp_handler)(&chp->ibcq, chp->ibcq.cq_context);\r\nspin_unlock_irqrestore(&chp->comp_handler_lock, flag);\r\n}\r\nvoid c4iw_ev_dispatch(struct c4iw_dev *dev, struct t4_cqe *err_cqe)\r\n{\r\nstruct c4iw_cq *chp;\r\nstruct c4iw_qp *qhp;\r\nu32 cqid;\r\nspin_lock(&dev->lock);\r\nqhp = get_qhp(dev, CQE_QPID(err_cqe));\r\nif (!qhp) {\r\nprintk(KERN_ERR MOD "BAD AE qpid 0x%x opcode %d "\r\n"status 0x%x type %d wrid.hi 0x%x wrid.lo 0x%x\n",\r\nCQE_QPID(err_cqe),\r\nCQE_OPCODE(err_cqe), CQE_STATUS(err_cqe),\r\nCQE_TYPE(err_cqe), CQE_WRID_HI(err_cqe),\r\nCQE_WRID_LOW(err_cqe));\r\nspin_unlock(&dev->lock);\r\ngoto out;\r\n}\r\nif (SQ_TYPE(err_cqe))\r\ncqid = qhp->attr.scq;\r\nelse\r\ncqid = qhp->attr.rcq;\r\nchp = get_chp(dev, cqid);\r\nif (!chp) {\r\nprintk(KERN_ERR MOD "BAD AE cqid 0x%x qpid 0x%x opcode %d "\r\n"status 0x%x type %d wrid.hi 0x%x wrid.lo 0x%x\n",\r\ncqid, CQE_QPID(err_cqe),\r\nCQE_OPCODE(err_cqe), CQE_STATUS(err_cqe),\r\nCQE_TYPE(err_cqe), CQE_WRID_HI(err_cqe),\r\nCQE_WRID_LOW(err_cqe));\r\nspin_unlock(&dev->lock);\r\ngoto out;\r\n}\r\nc4iw_qp_add_ref(&qhp->ibqp);\r\natomic_inc(&chp->refcnt);\r\nspin_unlock(&dev->lock);\r\nif (RQ_TYPE(err_cqe) &&\r\n(CQE_OPCODE(err_cqe) == FW_RI_RDMA_WRITE)) {\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_REQ_ERR);\r\ngoto done;\r\n}\r\nswitch (CQE_STATUS(err_cqe)) {\r\ncase T4_ERR_SUCCESS:\r\nprintk(KERN_ERR MOD "AE with status 0!\n");\r\nbreak;\r\ncase T4_ERR_STAG:\r\ncase T4_ERR_PDID:\r\ncase T4_ERR_QPID:\r\ncase T4_ERR_ACCESS:\r\ncase T4_ERR_WRAP:\r\ncase T4_ERR_BOUND:\r\ncase T4_ERR_INVALIDATE_SHARED_MR:\r\ncase T4_ERR_INVALIDATE_MR_WITH_MW_BOUND:\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_ACCESS_ERR);\r\nbreak;\r\ncase T4_ERR_ECC:\r\ncase T4_ERR_ECC_PSTAG:\r\ncase T4_ERR_INTERNAL_ERR:\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_DEVICE_FATAL);\r\nbreak;\r\ncase T4_ERR_OUT_OF_RQE:\r\ncase T4_ERR_PBL_ADDR_BOUND:\r\ncase T4_ERR_CRC:\r\ncase T4_ERR_MARKER:\r\ncase T4_ERR_PDU_LEN_ERR:\r\ncase T4_ERR_DDP_VERSION:\r\ncase T4_ERR_RDMA_VERSION:\r\ncase T4_ERR_OPCODE:\r\ncase T4_ERR_DDP_QUEUE_NUM:\r\ncase T4_ERR_MSN:\r\ncase T4_ERR_TBIT:\r\ncase T4_ERR_MO:\r\ncase T4_ERR_MSN_GAP:\r\ncase T4_ERR_MSN_RANGE:\r\ncase T4_ERR_RQE_ADDR_BOUND:\r\ncase T4_ERR_IRD_OVERFLOW:\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_FATAL);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR MOD "Unknown T4 status 0x%x QPID 0x%x\n",\r\nCQE_STATUS(err_cqe), qhp->wq.sq.qid);\r\npost_qp_event(dev, chp, qhp, err_cqe, IB_EVENT_QP_FATAL);\r\nbreak;\r\n}\r\ndone:\r\nif (atomic_dec_and_test(&chp->refcnt))\r\nwake_up(&chp->wait);\r\nc4iw_qp_rem_ref(&qhp->ibqp);\r\nout:\r\nreturn;\r\n}\r\nint c4iw_ev_handler(struct c4iw_dev *dev, u32 qid)\r\n{\r\nstruct c4iw_cq *chp;\r\nunsigned long flag;\r\nchp = get_chp(dev, qid);\r\nif (chp) {\r\nspin_lock_irqsave(&chp->comp_handler_lock, flag);\r\n(*chp->ibcq.comp_handler)(&chp->ibcq, chp->ibcq.cq_context);\r\nspin_unlock_irqrestore(&chp->comp_handler_lock, flag);\r\n} else\r\nPDBG("%s unknown cqid 0x%x\n", __func__, qid);\r\nreturn 0;\r\n}

static void nfcwilink_register_complete(void *priv_data, char data)\r\n{\r\nstruct nfcwilink *drv = priv_data;\r\nnfc_dev_dbg(&drv->pdev->dev, "register_complete entry");\r\ndrv->st_register_cb_status = data;\r\ncomplete(&drv->st_register_completed);\r\n}\r\nstatic long nfcwilink_receive(void *priv_data, struct sk_buff *skb)\r\n{\r\nstruct nfcwilink *drv = priv_data;\r\nint rc;\r\nnfc_dev_dbg(&drv->pdev->dev, "receive entry, len %d", skb->len);\r\nif (!skb)\r\nreturn -EFAULT;\r\nif (!drv) {\r\nkfree_skb(skb);\r\nreturn -EFAULT;\r\n}\r\nskb_pull(skb, (NFCWILINK_HDR_LEN-1));\r\nskb->dev = (void *) drv->ndev;\r\nrc = nci_recv_frame(skb);\r\nif (rc < 0) {\r\nnfc_dev_err(&drv->pdev->dev, "nci_recv_frame failed %d", rc);\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nfcwilink_open(struct nci_dev *ndev)\r\n{\r\nstruct nfcwilink *drv = nci_get_drvdata(ndev);\r\nunsigned long comp_ret;\r\nint rc;\r\nnfc_dev_dbg(&drv->pdev->dev, "open entry");\r\nif (test_and_set_bit(NFCWILINK_RUNNING, &drv->flags)) {\r\nrc = -EBUSY;\r\ngoto exit;\r\n}\r\nnfcwilink_proto.priv_data = drv;\r\ninit_completion(&drv->st_register_completed);\r\ndrv->st_register_cb_status = -EINPROGRESS;\r\nrc = st_register(&nfcwilink_proto);\r\nif (rc < 0) {\r\nif (rc == -EINPROGRESS) {\r\ncomp_ret = wait_for_completion_timeout(\r\n&drv->st_register_completed,\r\nmsecs_to_jiffies(NFCWILINK_REGISTER_TIMEOUT));\r\nnfc_dev_dbg(&drv->pdev->dev,\r\n"wait_for_completion_timeout returned %ld",\r\ncomp_ret);\r\nif (comp_ret == 0) {\r\nrc = -ETIMEDOUT;\r\ngoto clear_exit;\r\n} else if (drv->st_register_cb_status != 0) {\r\nrc = drv->st_register_cb_status;\r\nnfc_dev_err(&drv->pdev->dev,\r\n"st_register_cb failed %d", rc);\r\ngoto clear_exit;\r\n}\r\n} else {\r\nnfc_dev_err(&drv->pdev->dev,\r\n"st_register failed %d", rc);\r\ngoto clear_exit;\r\n}\r\n}\r\nBUG_ON(nfcwilink_proto.write == NULL);\r\ndrv->st_write = nfcwilink_proto.write;\r\ngoto exit;\r\nclear_exit:\r\nclear_bit(NFCWILINK_RUNNING, &drv->flags);\r\nexit:\r\nreturn rc;\r\n}\r\nstatic int nfcwilink_close(struct nci_dev *ndev)\r\n{\r\nstruct nfcwilink *drv = nci_get_drvdata(ndev);\r\nint rc;\r\nnfc_dev_dbg(&drv->pdev->dev, "close entry");\r\nif (!test_and_clear_bit(NFCWILINK_RUNNING, &drv->flags))\r\nreturn 0;\r\nrc = st_unregister(&nfcwilink_proto);\r\nif (rc)\r\nnfc_dev_err(&drv->pdev->dev, "st_unregister failed %d", rc);\r\ndrv->st_write = NULL;\r\nreturn rc;\r\n}\r\nstatic int nfcwilink_send(struct sk_buff *skb)\r\n{\r\nstruct nci_dev *ndev = (struct nci_dev *)skb->dev;\r\nstruct nfcwilink *drv = nci_get_drvdata(ndev);\r\nstruct nfcwilink_hdr hdr = {NFCWILINK_CHNL, NFCWILINK_OPCODE, 0x0000};\r\nlong len;\r\nnfc_dev_dbg(&drv->pdev->dev, "send entry, len %d", skb->len);\r\nif (!test_bit(NFCWILINK_RUNNING, &drv->flags))\r\nreturn -EBUSY;\r\nhdr.len = skb->len;\r\nmemcpy(skb_push(skb, NFCWILINK_HDR_LEN), &hdr, NFCWILINK_HDR_LEN);\r\nlen = drv->st_write(skb);\r\nif (len < 0) {\r\nkfree_skb(skb);\r\nnfc_dev_err(&drv->pdev->dev, "st_write failed %ld", len);\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nfcwilink_probe(struct platform_device *pdev)\r\n{\r\nstatic struct nfcwilink *drv;\r\nint rc;\r\nu32 protocols;\r\nnfc_dev_dbg(&pdev->dev, "probe entry");\r\ndrv = kzalloc(sizeof(struct nfcwilink), GFP_KERNEL);\r\nif (!drv) {\r\nrc = -ENOMEM;\r\ngoto exit;\r\n}\r\ndrv->pdev = pdev;\r\nprotocols = NFC_PROTO_JEWEL_MASK\r\n| NFC_PROTO_MIFARE_MASK | NFC_PROTO_FELICA_MASK\r\n| NFC_PROTO_ISO14443_MASK\r\n| NFC_PROTO_NFC_DEP_MASK;\r\ndrv->ndev = nci_allocate_device(&nfcwilink_ops,\r\nprotocols,\r\nNFCWILINK_HDR_LEN,\r\n0);\r\nif (!drv->ndev) {\r\nnfc_dev_err(&pdev->dev, "nci_allocate_device failed");\r\nrc = -ENOMEM;\r\ngoto free_exit;\r\n}\r\nnci_set_parent_dev(drv->ndev, &pdev->dev);\r\nnci_set_drvdata(drv->ndev, drv);\r\nrc = nci_register_device(drv->ndev);\r\nif (rc < 0) {\r\nnfc_dev_err(&pdev->dev, "nci_register_device failed %d", rc);\r\ngoto free_dev_exit;\r\n}\r\ndev_set_drvdata(&pdev->dev, drv);\r\ngoto exit;\r\nfree_dev_exit:\r\nnci_free_device(drv->ndev);\r\nfree_exit:\r\nkfree(drv);\r\nexit:\r\nreturn rc;\r\n}\r\nstatic int nfcwilink_remove(struct platform_device *pdev)\r\n{\r\nstruct nfcwilink *drv = dev_get_drvdata(&pdev->dev);\r\nstruct nci_dev *ndev;\r\nnfc_dev_dbg(&pdev->dev, "remove entry");\r\nif (!drv)\r\nreturn -EFAULT;\r\nndev = drv->ndev;\r\nnci_unregister_device(ndev);\r\nnci_free_device(ndev);\r\nkfree(drv);\r\ndev_set_drvdata(&pdev->dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init nfcwilink_init(void)\r\n{\r\nprintk(KERN_INFO "NFC Driver for TI WiLink");\r\nreturn platform_driver_register(&nfcwilink_driver);\r\n}\r\nstatic void __exit nfcwilink_exit(void)\r\n{\r\nplatform_driver_unregister(&nfcwilink_driver);\r\n}

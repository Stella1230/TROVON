int\r\nnv10_fifo_channel_id(struct drm_device *dev)\r\n{\r\nreturn nv_rd32(dev, NV03_PFIFO_CACHE1_PUSH1) &\r\nNV10_PFIFO_CACHE1_PUSH1_CHID_MASK;\r\n}\r\nint\r\nnv10_fifo_create_context(struct nouveau_channel *chan)\r\n{\r\nstruct drm_nouveau_private *dev_priv = chan->dev->dev_private;\r\nstruct drm_device *dev = chan->dev;\r\nuint32_t fc = NV10_RAMFC(chan->id);\r\nint ret;\r\nret = nouveau_gpuobj_new_fake(dev, NV10_RAMFC(chan->id), ~0,\r\nNV10_RAMFC__SIZE, NVOBJ_FLAG_ZERO_ALLOC |\r\nNVOBJ_FLAG_ZERO_FREE, &chan->ramfc);\r\nif (ret)\r\nreturn ret;\r\nchan->user = ioremap(pci_resource_start(dev->pdev, 0) +\r\nNV03_USER(chan->id), PAGE_SIZE);\r\nif (!chan->user)\r\nreturn -ENOMEM;\r\nnv_wi32(dev, fc + 0, chan->pushbuf_base);\r\nnv_wi32(dev, fc + 4, chan->pushbuf_base);\r\nnv_wi32(dev, fc + 12, chan->pushbuf->pinst >> 4);\r\nnv_wi32(dev, fc + 20, NV_PFIFO_CACHE1_DMA_FETCH_TRIG_128_BYTES |\r\nNV_PFIFO_CACHE1_DMA_FETCH_SIZE_128_BYTES |\r\nNV_PFIFO_CACHE1_DMA_FETCH_MAX_REQS_8 |\r\n#ifdef __BIG_ENDIAN\r\nNV_PFIFO_CACHE1_BIG_ENDIAN |\r\n#endif\r\n0);\r\nnv_wr32(dev, NV04_PFIFO_MODE,\r\nnv_rd32(dev, NV04_PFIFO_MODE) | (1 << chan->id));\r\nreturn 0;\r\n}\r\nstatic void\r\nnv10_fifo_do_load_context(struct drm_device *dev, int chid)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nuint32_t fc = NV10_RAMFC(chid), tmp;\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_PUT, nv_ri32(dev, fc + 0));\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_GET, nv_ri32(dev, fc + 4));\r\nnv_wr32(dev, NV10_PFIFO_CACHE1_REF_CNT, nv_ri32(dev, fc + 8));\r\ntmp = nv_ri32(dev, fc + 12);\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_INSTANCE, tmp & 0xFFFF);\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_DCOUNT, tmp >> 16);\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_STATE, nv_ri32(dev, fc + 16));\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_FETCH, nv_ri32(dev, fc + 20));\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_ENGINE, nv_ri32(dev, fc + 24));\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_PULL1, nv_ri32(dev, fc + 28));\r\nif (dev_priv->chipset < 0x17)\r\ngoto out;\r\nnv_wr32(dev, NV10_PFIFO_CACHE1_ACQUIRE_VALUE, nv_ri32(dev, fc + 32));\r\ntmp = nv_ri32(dev, fc + 36);\r\nnv_wr32(dev, NV10_PFIFO_CACHE1_ACQUIRE_TIMESTAMP, tmp);\r\nnv_wr32(dev, NV10_PFIFO_CACHE1_ACQUIRE_TIMEOUT, nv_ri32(dev, fc + 40));\r\nnv_wr32(dev, NV10_PFIFO_CACHE1_SEMAPHORE, nv_ri32(dev, fc + 44));\r\nnv_wr32(dev, NV10_PFIFO_CACHE1_DMA_SUBROUTINE, nv_ri32(dev, fc + 48));\r\nout:\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_GET, 0);\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_PUT, 0);\r\n}\r\nint\r\nnv10_fifo_load_context(struct nouveau_channel *chan)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nuint32_t tmp;\r\nnv10_fifo_do_load_context(dev, chan->id);\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_PUSH1,\r\nNV03_PFIFO_CACHE1_PUSH1_DMA | chan->id);\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_PUSH, 1);\r\ntmp = nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_CTL) & ~(1 << 31);\r\nnv_wr32(dev, NV04_PFIFO_CACHE1_DMA_CTL, tmp);\r\nreturn 0;\r\n}\r\nint\r\nnv10_fifo_unload_context(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nuint32_t fc, tmp;\r\nint chid;\r\nchid = pfifo->channel_id(dev);\r\nif (chid < 0 || chid >= dev_priv->engine.fifo.channels)\r\nreturn 0;\r\nfc = NV10_RAMFC(chid);\r\nnv_wi32(dev, fc + 0, nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_PUT));\r\nnv_wi32(dev, fc + 4, nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_GET));\r\nnv_wi32(dev, fc + 8, nv_rd32(dev, NV10_PFIFO_CACHE1_REF_CNT));\r\ntmp = nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_INSTANCE) & 0xFFFF;\r\ntmp |= (nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_DCOUNT) << 16);\r\nnv_wi32(dev, fc + 12, tmp);\r\nnv_wi32(dev, fc + 16, nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_STATE));\r\nnv_wi32(dev, fc + 20, nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_FETCH));\r\nnv_wi32(dev, fc + 24, nv_rd32(dev, NV04_PFIFO_CACHE1_ENGINE));\r\nnv_wi32(dev, fc + 28, nv_rd32(dev, NV04_PFIFO_CACHE1_PULL1));\r\nif (dev_priv->chipset < 0x17)\r\ngoto out;\r\nnv_wi32(dev, fc + 32, nv_rd32(dev, NV10_PFIFO_CACHE1_ACQUIRE_VALUE));\r\ntmp = nv_rd32(dev, NV10_PFIFO_CACHE1_ACQUIRE_TIMESTAMP);\r\nnv_wi32(dev, fc + 36, tmp);\r\nnv_wi32(dev, fc + 40, nv_rd32(dev, NV10_PFIFO_CACHE1_ACQUIRE_TIMEOUT));\r\nnv_wi32(dev, fc + 44, nv_rd32(dev, NV10_PFIFO_CACHE1_SEMAPHORE));\r\nnv_wi32(dev, fc + 48, nv_rd32(dev, NV04_PFIFO_CACHE1_DMA_GET));\r\nout:\r\nnv10_fifo_do_load_context(dev, pfifo->channels - 1);\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_PUSH1, pfifo->channels - 1);\r\nreturn 0;\r\n}\r\nstatic void\r\nnv10_fifo_init_reset(struct drm_device *dev)\r\n{\r\nnv_wr32(dev, NV03_PMC_ENABLE,\r\nnv_rd32(dev, NV03_PMC_ENABLE) & ~NV_PMC_ENABLE_PFIFO);\r\nnv_wr32(dev, NV03_PMC_ENABLE,\r\nnv_rd32(dev, NV03_PMC_ENABLE) | NV_PMC_ENABLE_PFIFO);\r\nnv_wr32(dev, 0x003224, 0x000f0078);\r\nnv_wr32(dev, 0x002044, 0x0101ffff);\r\nnv_wr32(dev, 0x002040, 0x000000ff);\r\nnv_wr32(dev, 0x002500, 0x00000000);\r\nnv_wr32(dev, 0x003000, 0x00000000);\r\nnv_wr32(dev, 0x003050, 0x00000000);\r\nnv_wr32(dev, 0x003258, 0x00000000);\r\nnv_wr32(dev, 0x003210, 0x00000000);\r\nnv_wr32(dev, 0x003270, 0x00000000);\r\n}\r\nstatic void\r\nnv10_fifo_init_ramxx(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nnv_wr32(dev, NV03_PFIFO_RAMHT, (0x03 << 24) |\r\n((dev_priv->ramht->bits - 9) << 16) |\r\n(dev_priv->ramht->gpuobj->pinst >> 8));\r\nnv_wr32(dev, NV03_PFIFO_RAMRO, dev_priv->ramro->pinst >> 8);\r\nif (dev_priv->chipset < 0x17) {\r\nnv_wr32(dev, NV03_PFIFO_RAMFC, dev_priv->ramfc->pinst >> 8);\r\n} else {\r\nnv_wr32(dev, NV03_PFIFO_RAMFC, (dev_priv->ramfc->pinst >> 8) |\r\n(1 << 16) );\r\n}\r\n}\r\nstatic void\r\nnv10_fifo_init_intr(struct drm_device *dev)\r\n{\r\nnouveau_irq_register(dev, 8, nv04_fifo_isr);\r\nnv_wr32(dev, 0x002100, 0xffffffff);\r\nnv_wr32(dev, 0x002140, 0xffffffff);\r\n}\r\nint\r\nnv10_fifo_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nint i;\r\nnv10_fifo_init_reset(dev);\r\nnv10_fifo_init_ramxx(dev);\r\nnv10_fifo_do_load_context(dev, pfifo->channels - 1);\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_PUSH1, pfifo->channels - 1);\r\nnv10_fifo_init_intr(dev);\r\npfifo->enable(dev);\r\npfifo->reassign(dev, true);\r\nfor (i = 0; i < dev_priv->engine.fifo.channels; i++) {\r\nif (dev_priv->channels.ptr[i]) {\r\nuint32_t mode = nv_rd32(dev, NV04_PFIFO_MODE);\r\nnv_wr32(dev, NV04_PFIFO_MODE, mode | (1 << i));\r\n}\r\n}\r\nreturn 0;\r\n}

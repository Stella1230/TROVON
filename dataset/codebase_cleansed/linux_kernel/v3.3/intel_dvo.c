static struct intel_dvo *enc_to_intel_dvo(struct drm_encoder *encoder)\r\n{\r\nreturn container_of(encoder, struct intel_dvo, base.base);\r\n}\r\nstatic struct intel_dvo *intel_attached_dvo(struct drm_connector *connector)\r\n{\r\nreturn container_of(intel_attached_encoder(connector),\r\nstruct intel_dvo, base);\r\n}\r\nstatic void intel_dvo_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct drm_i915_private *dev_priv = encoder->dev->dev_private;\r\nstruct intel_dvo *intel_dvo = enc_to_intel_dvo(encoder);\r\nu32 dvo_reg = intel_dvo->dev.dvo_reg;\r\nu32 temp = I915_READ(dvo_reg);\r\nif (mode == DRM_MODE_DPMS_ON) {\r\nI915_WRITE(dvo_reg, temp | DVO_ENABLE);\r\nI915_READ(dvo_reg);\r\nintel_dvo->dev.dev_ops->dpms(&intel_dvo->dev, mode);\r\n} else {\r\nintel_dvo->dev.dev_ops->dpms(&intel_dvo->dev, mode);\r\nI915_WRITE(dvo_reg, temp & ~DVO_ENABLE);\r\nI915_READ(dvo_reg);\r\n}\r\n}\r\nstatic int intel_dvo_mode_valid(struct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(connector);\r\nif (mode->flags & DRM_MODE_FLAG_DBLSCAN)\r\nreturn MODE_NO_DBLESCAN;\r\nif (intel_dvo->panel_fixed_mode) {\r\nif (mode->hdisplay > intel_dvo->panel_fixed_mode->hdisplay)\r\nreturn MODE_PANEL;\r\nif (mode->vdisplay > intel_dvo->panel_fixed_mode->vdisplay)\r\nreturn MODE_PANEL;\r\n}\r\nreturn intel_dvo->dev.dev_ops->mode_valid(&intel_dvo->dev, mode);\r\n}\r\nstatic bool intel_dvo_mode_fixup(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct intel_dvo *intel_dvo = enc_to_intel_dvo(encoder);\r\nif (intel_dvo->panel_fixed_mode != NULL) {\r\n#define C(x) adjusted_mode->x = intel_dvo->panel_fixed_mode->x\r\nC(hdisplay);\r\nC(hsync_start);\r\nC(hsync_end);\r\nC(htotal);\r\nC(vdisplay);\r\nC(vsync_start);\r\nC(vsync_end);\r\nC(vtotal);\r\nC(clock);\r\ndrm_mode_set_crtcinfo(adjusted_mode, CRTC_INTERLACE_HALVE_V);\r\n#undef C\r\n}\r\nif (intel_dvo->dev.dev_ops->mode_fixup)\r\nreturn intel_dvo->dev.dev_ops->mode_fixup(&intel_dvo->dev, mode, adjusted_mode);\r\nreturn true;\r\n}\r\nstatic void intel_dvo_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(encoder->crtc);\r\nstruct intel_dvo *intel_dvo = enc_to_intel_dvo(encoder);\r\nint pipe = intel_crtc->pipe;\r\nu32 dvo_val;\r\nu32 dvo_reg = intel_dvo->dev.dvo_reg, dvo_srcdim_reg;\r\nint dpll_reg = DPLL(pipe);\r\nswitch (dvo_reg) {\r\ncase DVOA:\r\ndefault:\r\ndvo_srcdim_reg = DVOA_SRCDIM;\r\nbreak;\r\ncase DVOB:\r\ndvo_srcdim_reg = DVOB_SRCDIM;\r\nbreak;\r\ncase DVOC:\r\ndvo_srcdim_reg = DVOC_SRCDIM;\r\nbreak;\r\n}\r\nintel_dvo->dev.dev_ops->mode_set(&intel_dvo->dev, mode, adjusted_mode);\r\ndvo_val = I915_READ(dvo_reg) &\r\n(DVO_PRESERVE_MASK | DVO_DATA_ORDER_GBRG);\r\ndvo_val |= DVO_DATA_ORDER_FP | DVO_BORDER_ENABLE |\r\nDVO_BLANK_ACTIVE_HIGH;\r\nif (pipe == 1)\r\ndvo_val |= DVO_PIPE_B_SELECT;\r\ndvo_val |= DVO_PIPE_STALL;\r\nif (adjusted_mode->flags & DRM_MODE_FLAG_PHSYNC)\r\ndvo_val |= DVO_HSYNC_ACTIVE_HIGH;\r\nif (adjusted_mode->flags & DRM_MODE_FLAG_PVSYNC)\r\ndvo_val |= DVO_VSYNC_ACTIVE_HIGH;\r\nI915_WRITE(dpll_reg, I915_READ(dpll_reg) | DPLL_DVO_HIGH_SPEED);\r\nI915_WRITE(dvo_srcdim_reg,\r\n(adjusted_mode->hdisplay << DVO_SRCDIM_HORIZONTAL_SHIFT) |\r\n(adjusted_mode->vdisplay << DVO_SRCDIM_VERTICAL_SHIFT));\r\nI915_WRITE(dvo_reg, dvo_val);\r\n}\r\nstatic enum drm_connector_status\r\nintel_dvo_detect(struct drm_connector *connector, bool force)\r\n{\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(connector);\r\nreturn intel_dvo->dev.dev_ops->detect(&intel_dvo->dev);\r\n}\r\nstatic int intel_dvo_get_modes(struct drm_connector *connector)\r\n{\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(connector);\r\nstruct drm_i915_private *dev_priv = connector->dev->dev_private;\r\nintel_ddc_get_modes(connector,\r\n&dev_priv->gmbus[GMBUS_PORT_DPC].adapter);\r\nif (!list_empty(&connector->probed_modes))\r\nreturn 1;\r\nif (intel_dvo->panel_fixed_mode != NULL) {\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(connector->dev, intel_dvo->panel_fixed_mode);\r\nif (mode) {\r\ndrm_mode_probed_add(connector, mode);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void intel_dvo_destroy(struct drm_connector *connector)\r\n{\r\ndrm_sysfs_connector_remove(connector);\r\ndrm_connector_cleanup(connector);\r\nkfree(connector);\r\n}\r\nstatic void intel_dvo_enc_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct intel_dvo *intel_dvo = enc_to_intel_dvo(encoder);\r\nif (intel_dvo->dev.dev_ops->destroy)\r\nintel_dvo->dev.dev_ops->destroy(&intel_dvo->dev);\r\nkfree(intel_dvo->panel_fixed_mode);\r\nintel_encoder_destroy(encoder);\r\n}\r\nstatic struct drm_display_mode *\r\nintel_dvo_get_current_mode(struct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = connector->dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(connector);\r\nuint32_t dvo_val = I915_READ(intel_dvo->dev.dvo_reg);\r\nstruct drm_display_mode *mode = NULL;\r\nif (dvo_val & DVO_ENABLE) {\r\nstruct drm_crtc *crtc;\r\nint pipe = (dvo_val & DVO_PIPE_B_SELECT) ? 1 : 0;\r\ncrtc = intel_get_crtc_for_pipe(dev, pipe);\r\nif (crtc) {\r\nmode = intel_crtc_mode_get(dev, crtc);\r\nif (mode) {\r\nmode->type |= DRM_MODE_TYPE_PREFERRED;\r\nif (dvo_val & DVO_HSYNC_ACTIVE_HIGH)\r\nmode->flags |= DRM_MODE_FLAG_PHSYNC;\r\nif (dvo_val & DVO_VSYNC_ACTIVE_HIGH)\r\nmode->flags |= DRM_MODE_FLAG_PVSYNC;\r\n}\r\n}\r\n}\r\nreturn mode;\r\n}\r\nvoid intel_dvo_init(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_encoder *intel_encoder;\r\nstruct intel_dvo *intel_dvo;\r\nstruct intel_connector *intel_connector;\r\nint i;\r\nint encoder_type = DRM_MODE_ENCODER_NONE;\r\nintel_dvo = kzalloc(sizeof(struct intel_dvo), GFP_KERNEL);\r\nif (!intel_dvo)\r\nreturn;\r\nintel_connector = kzalloc(sizeof(struct intel_connector), GFP_KERNEL);\r\nif (!intel_connector) {\r\nkfree(intel_dvo);\r\nreturn;\r\n}\r\nintel_encoder = &intel_dvo->base;\r\ndrm_encoder_init(dev, &intel_encoder->base,\r\n&intel_dvo_enc_funcs, encoder_type);\r\nfor (i = 0; i < ARRAY_SIZE(intel_dvo_devices); i++) {\r\nstruct drm_connector *connector = &intel_connector->base;\r\nconst struct intel_dvo_device *dvo = &intel_dvo_devices[i];\r\nstruct i2c_adapter *i2c;\r\nint gpio;\r\nif (dvo->gpio != 0)\r\ngpio = dvo->gpio;\r\nelse if (dvo->type == INTEL_DVO_CHIP_LVDS)\r\ngpio = GMBUS_PORT_SSC;\r\nelse\r\ngpio = GMBUS_PORT_DPB;\r\ni2c = &dev_priv->gmbus[gpio].adapter;\r\nintel_dvo->dev = *dvo;\r\nif (!dvo->dev_ops->init(&intel_dvo->dev, i2c))\r\ncontinue;\r\nintel_encoder->type = INTEL_OUTPUT_DVO;\r\nintel_encoder->crtc_mask = (1 << 0) | (1 << 1);\r\nswitch (dvo->type) {\r\ncase INTEL_DVO_CHIP_TMDS:\r\nintel_encoder->clone_mask =\r\n(1 << INTEL_DVO_TMDS_CLONE_BIT) |\r\n(1 << INTEL_ANALOG_CLONE_BIT);\r\ndrm_connector_init(dev, connector,\r\n&intel_dvo_connector_funcs,\r\nDRM_MODE_CONNECTOR_DVII);\r\nencoder_type = DRM_MODE_ENCODER_TMDS;\r\nbreak;\r\ncase INTEL_DVO_CHIP_LVDS:\r\nintel_encoder->clone_mask =\r\n(1 << INTEL_DVO_LVDS_CLONE_BIT);\r\ndrm_connector_init(dev, connector,\r\n&intel_dvo_connector_funcs,\r\nDRM_MODE_CONNECTOR_LVDS);\r\nencoder_type = DRM_MODE_ENCODER_LVDS;\r\nbreak;\r\n}\r\ndrm_connector_helper_add(connector,\r\n&intel_dvo_connector_helper_funcs);\r\nconnector->display_info.subpixel_order = SubPixelHorizontalRGB;\r\nconnector->interlace_allowed = false;\r\nconnector->doublescan_allowed = false;\r\ndrm_encoder_helper_add(&intel_encoder->base,\r\n&intel_dvo_helper_funcs);\r\nintel_connector_attach_encoder(intel_connector, intel_encoder);\r\nif (dvo->type == INTEL_DVO_CHIP_LVDS) {\r\nintel_dvo->panel_fixed_mode =\r\nintel_dvo_get_current_mode(connector);\r\nintel_dvo->panel_wants_dither = true;\r\n}\r\ndrm_sysfs_connector_add(connector);\r\nreturn;\r\n}\r\ndrm_encoder_cleanup(&intel_encoder->base);\r\nkfree(intel_dvo);\r\nkfree(intel_connector);\r\n}

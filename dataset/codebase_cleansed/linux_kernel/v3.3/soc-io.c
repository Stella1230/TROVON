static int hw_write(struct snd_soc_codec *codec, unsigned int reg,\r\nunsigned int value)\r\n{\r\nint ret;\r\nif (!snd_soc_codec_volatile_register(codec, reg) &&\r\nreg < codec->driver->reg_cache_size &&\r\n!codec->cache_bypass) {\r\nret = snd_soc_cache_write(codec, reg, value);\r\nif (ret < 0)\r\nreturn -1;\r\n}\r\nif (codec->cache_only) {\r\ncodec->cache_sync = 1;\r\nreturn 0;\r\n}\r\nreturn regmap_write(codec->control_data, reg, value);\r\n}\r\nstatic unsigned int hw_read(struct snd_soc_codec *codec, unsigned int reg)\r\n{\r\nint ret;\r\nunsigned int val;\r\nif (reg >= codec->driver->reg_cache_size ||\r\nsnd_soc_codec_volatile_register(codec, reg) ||\r\ncodec->cache_bypass) {\r\nif (codec->cache_only)\r\nreturn -1;\r\nret = regmap_read(codec->control_data, reg, &val);\r\nif (ret == 0)\r\nreturn val;\r\nelse\r\nreturn -1;\r\n}\r\nret = snd_soc_cache_read(codec, reg, &val);\r\nif (ret < 0)\r\nreturn -1;\r\nreturn val;\r\n}\r\nstatic int snd_soc_hw_bulk_write_raw(struct snd_soc_codec *codec,\r\nunsigned int reg,\r\nconst void *data, size_t len)\r\n{\r\nif (!codec->cache_bypass\r\n&& !snd_soc_codec_volatile_register(codec, reg)\r\n&& reg < codec->driver->reg_cache_size)\r\nreturn -EINVAL;\r\nreturn regmap_raw_write(codec->control_data, reg, data, len);\r\n}\r\nint snd_soc_codec_set_cache_io(struct snd_soc_codec *codec,\r\nint addr_bits, int data_bits,\r\nenum snd_soc_control_type control)\r\n{\r\nstruct regmap_config config;\r\nmemset(&config, 0, sizeof(config));\r\ncodec->write = hw_write;\r\ncodec->read = hw_read;\r\ncodec->bulk_write_raw = snd_soc_hw_bulk_write_raw;\r\nconfig.reg_bits = addr_bits;\r\nconfig.val_bits = data_bits;\r\nswitch (control) {\r\n#if defined(CONFIG_REGMAP_I2C) || defined(CONFIG_REGMAP_I2C_MODULE)\r\ncase SND_SOC_I2C:\r\ncodec->control_data = regmap_init_i2c(to_i2c_client(codec->dev),\r\n&config);\r\nbreak;\r\n#endif\r\n#if defined(CONFIG_REGMAP_SPI) || defined(CONFIG_REGMAP_SPI_MODULE)\r\ncase SND_SOC_SPI:\r\ncodec->control_data = regmap_init_spi(to_spi_device(codec->dev),\r\n&config);\r\nbreak;\r\n#endif\r\ncase SND_SOC_REGMAP:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (IS_ERR(codec->control_data))\r\nreturn PTR_ERR(codec->control_data);\r\nreturn 0;\r\n}\r\nint snd_soc_codec_set_cache_io(struct snd_soc_codec *codec,\r\nint addr_bits, int data_bits,\r\nenum snd_soc_control_type control)\r\n{\r\nreturn -ENOTSUPP;\r\n}

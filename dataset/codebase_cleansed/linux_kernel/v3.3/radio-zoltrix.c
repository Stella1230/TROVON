static int zol_setvol(struct zoltrix *zol, int vol)\r\n{\r\nzol->curvol = vol;\r\nif (zol->muted)\r\nreturn 0;\r\nmutex_lock(&zol->lock);\r\nif (vol == 0) {\r\noutb(0, zol->io);\r\noutb(0, zol->io);\r\ninb(zol->io + 3);\r\nmutex_unlock(&zol->lock);\r\nreturn 0;\r\n}\r\noutb(zol->curvol-1, zol->io);\r\nmsleep(10);\r\ninb(zol->io + 2);\r\nmutex_unlock(&zol->lock);\r\nreturn 0;\r\n}\r\nstatic void zol_mute(struct zoltrix *zol)\r\n{\r\nzol->muted = 1;\r\nmutex_lock(&zol->lock);\r\noutb(0, zol->io);\r\noutb(0, zol->io);\r\ninb(zol->io + 3);\r\nmutex_unlock(&zol->lock);\r\n}\r\nstatic void zol_unmute(struct zoltrix *zol)\r\n{\r\nzol->muted = 0;\r\nzol_setvol(zol, zol->curvol);\r\n}\r\nstatic int zol_setfreq(struct zoltrix *zol, unsigned long freq)\r\n{\r\nstruct v4l2_device *v4l2_dev = &zol->v4l2_dev;\r\nunsigned long long bitmask, f, m;\r\nunsigned int stereo = zol->stereo;\r\nint i;\r\nif (freq == 0) {\r\nv4l2_warn(v4l2_dev, "cannot set a frequency of 0.\n");\r\nreturn -EINVAL;\r\n}\r\nm = (freq / 160 - 8800) * 2;\r\nf = (unsigned long long)m + 0x4d1c;\r\nbitmask = 0xc480402c10080000ull;\r\ni = 45;\r\nmutex_lock(&zol->lock);\r\nzol->curfreq = freq;\r\noutb(0, zol->io);\r\noutb(0, zol->io);\r\ninb(zol->io + 3);\r\noutb(0x40, zol->io);\r\noutb(0xc0, zol->io);\r\nbitmask = (bitmask ^ ((f & 0xff) << 47) ^ ((f & 0xff00) << 30) ^ (stereo << 31));\r\nwhile (i--) {\r\nif ((bitmask & 0x8000000000000000ull) != 0) {\r\noutb(0x80, zol->io);\r\nudelay(50);\r\noutb(0x00, zol->io);\r\nudelay(50);\r\noutb(0x80, zol->io);\r\nudelay(50);\r\n} else {\r\noutb(0xc0, zol->io);\r\nudelay(50);\r\noutb(0x40, zol->io);\r\nudelay(50);\r\noutb(0xc0, zol->io);\r\nudelay(50);\r\n}\r\nbitmask *= 2;\r\n}\r\noutb(0x80, zol->io);\r\noutb(0xc0, zol->io);\r\noutb(0x40, zol->io);\r\nudelay(1000);\r\ninb(zol->io + 2);\r\nudelay(1000);\r\nif (zol->muted) {\r\noutb(0, zol->io);\r\noutb(0, zol->io);\r\ninb(zol->io + 3);\r\nudelay(1000);\r\n}\r\nmutex_unlock(&zol->lock);\r\nif (!zol->muted)\r\nzol_setvol(zol, zol->curvol);\r\nreturn 0;\r\n}\r\nstatic int zol_getsigstr(struct zoltrix *zol)\r\n{\r\nint a, b;\r\nmutex_lock(&zol->lock);\r\noutb(0x00, zol->io);\r\noutb(zol->curvol, zol->io);\r\nmsleep(20);\r\na = inb(zol->io);\r\nmsleep(10);\r\nb = inb(zol->io);\r\nmutex_unlock(&zol->lock);\r\nif (a != b)\r\nreturn 0;\r\nreturn a == 0xcf || a == 0xdf || a == 0xef;\r\n}\r\nstatic int zol_is_stereo(struct zoltrix *zol)\r\n{\r\nint x1, x2;\r\nmutex_lock(&zol->lock);\r\noutb(0x00, zol->io);\r\noutb(zol->curvol, zol->io);\r\nmsleep(20);\r\nx1 = inb(zol->io);\r\nmsleep(10);\r\nx2 = inb(zol->io);\r\nmutex_unlock(&zol->lock);\r\nreturn x1 == x2 && x1 == 0xcf;\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstrlcpy(v->driver, "radio-zoltrix", sizeof(v->driver));\r\nstrlcpy(v->card, "Zoltrix Radio", sizeof(v->card));\r\nstrlcpy(v->bus_info, "ISA", sizeof(v->bus_info));\r\nv->capabilities = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct zoltrix *zol = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->type = V4L2_TUNER_RADIO;\r\nv->rangelow = 88 * 16000;\r\nv->rangehigh = 108 * 16000;\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\r\nv->capability = V4L2_TUNER_CAP_LOW;\r\nif (zol_is_stereo(zol))\r\nv->audmode = V4L2_TUNER_MODE_STEREO;\r\nelse\r\nv->audmode = V4L2_TUNER_MODE_MONO;\r\nv->signal = 0xFFFF * zol_getsigstr(zol);\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nreturn v->index ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct zoltrix *zol = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\nif (zol_setfreq(zol, f->frequency) != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct zoltrix *zol = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = zol->curfreq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_queryctrl(struct file *file, void *priv,\r\nstruct v4l2_queryctrl *qc)\r\n{\r\nswitch (qc->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 1, 1, 1);\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 65535, 4096, 65535);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct zoltrix *zol = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nctrl->value = zol->muted;\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nctrl->value = zol->curvol * 4096;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_s_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct zoltrix *zol = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (ctrl->value)\r\nzol_mute(zol);\r\nelse {\r\nzol_unmute(zol);\r\nzol_setvol(zol, zol->curvol);\r\n}\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nzol_setvol(zol, ctrl->value / 4096);\r\nreturn 0;\r\n}\r\nzol->stereo = 1;\r\nif (zol_setfreq(zol, zol->curfreq) != 0)\r\nreturn -EINVAL;\r\n#if 0\r\nif (v->mode & VIDEO_SOUND_STEREO) {\r\nzol->stereo = 1;\r\nzol_setfreq(zol, zol->curfreq);\r\n}\r\nif (v->mode & VIDEO_SOUND_MONO) {\r\nzol->stereo = 0;\r\nzol_setfreq(zol, zol->curfreq);\r\n}\r\n#endif\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_input(struct file *filp, void *priv, unsigned int *i)\r\n{\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_input(struct file *filp, void *priv, unsigned int i)\r\n{\r\nreturn i ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\na->index = 0;\r\nstrlcpy(a->name, "Radio", sizeof(a->name));\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nreturn a->index ? -EINVAL : 0;\r\n}\r\nstatic int __init zoltrix_init(void)\r\n{\r\nstruct zoltrix *zol = &zoltrix_card;\r\nstruct v4l2_device *v4l2_dev = &zol->v4l2_dev;\r\nint res;\r\nstrlcpy(v4l2_dev->name, "zoltrix", sizeof(v4l2_dev->name));\r\nzol->io = io;\r\nif (zol->io == -1) {\r\nv4l2_err(v4l2_dev, "You must set an I/O address with io=0x20c or 0x30c\n");\r\nreturn -EINVAL;\r\n}\r\nif (zol->io != 0x20c && zol->io != 0x30c) {\r\nv4l2_err(v4l2_dev, "invalid port, try 0x20c or 0x30c\n");\r\nreturn -ENXIO;\r\n}\r\nif (!request_region(zol->io, 2, "zoltrix")) {\r\nv4l2_err(v4l2_dev, "port 0x%x already in use\n", zol->io);\r\nreturn -EBUSY;\r\n}\r\nres = v4l2_device_register(NULL, v4l2_dev);\r\nif (res < 0) {\r\nrelease_region(zol->io, 2);\r\nv4l2_err(v4l2_dev, "Could not register v4l2_device\n");\r\nreturn res;\r\n}\r\nmutex_init(&zol->lock);\r\noutb(0, zol->io);\r\noutb(0, zol->io);\r\nmsleep(20);\r\ninb(zol->io + 3);\r\nzol->curvol = 0;\r\nzol->stereo = 1;\r\nstrlcpy(zol->vdev.name, v4l2_dev->name, sizeof(zol->vdev.name));\r\nzol->vdev.v4l2_dev = v4l2_dev;\r\nzol->vdev.fops = &zoltrix_fops;\r\nzol->vdev.ioctl_ops = &zoltrix_ioctl_ops;\r\nzol->vdev.release = video_device_release_empty;\r\nvideo_set_drvdata(&zol->vdev, zol);\r\nif (video_register_device(&zol->vdev, VFL_TYPE_RADIO, radio_nr) < 0) {\r\nv4l2_device_unregister(v4l2_dev);\r\nrelease_region(zol->io, 2);\r\nreturn -EINVAL;\r\n}\r\nv4l2_info(v4l2_dev, "Zoltrix Radio Plus card driver.\n");\r\nreturn 0;\r\n}\r\nstatic void __exit zoltrix_exit(void)\r\n{\r\nstruct zoltrix *zol = &zoltrix_card;\r\nvideo_unregister_device(&zol->vdev);\r\nv4l2_device_unregister(&zol->v4l2_dev);\r\nrelease_region(zol->io, 2);\r\n}

static int h3600_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nint err;\r\nswitch (skt->nr) {\r\ncase 0:\r\nerr = gpio_request(H3XXX_GPIO_PCMCIA_IRQ0, "PCMCIA IRQ0");\r\nif (err)\r\ngoto err00;\r\nerr = gpio_direction_input(H3XXX_GPIO_PCMCIA_IRQ0);\r\nif (err)\r\ngoto err01;\r\nskt->socket.pci_irq = gpio_to_irq(H3XXX_GPIO_PCMCIA_IRQ0);\r\nerr = gpio_request(H3XXX_GPIO_PCMCIA_CD0, "PCMCIA CD0");\r\nif (err)\r\ngoto err01;\r\nerr = gpio_direction_input(H3XXX_GPIO_PCMCIA_CD0);\r\nif (err)\r\ngoto err02;\r\nirqs[0].irq = gpio_to_irq(H3XXX_GPIO_PCMCIA_CD0);\r\nerr = gpio_request(H3XXX_EGPIO_OPT_NVRAM_ON, "OPT NVRAM ON");\r\nif (err)\r\ngoto err02;\r\nerr = gpio_direction_output(H3XXX_EGPIO_OPT_NVRAM_ON, 0);\r\nif (err)\r\ngoto err03;\r\nerr = gpio_request(H3XXX_EGPIO_OPT_ON, "OPT ON");\r\nif (err)\r\ngoto err03;\r\nerr = gpio_direction_output(H3XXX_EGPIO_OPT_ON, 0);\r\nif (err)\r\ngoto err04;\r\nerr = gpio_request(H3XXX_EGPIO_OPT_RESET, "OPT RESET");\r\nif (err)\r\ngoto err04;\r\nerr = gpio_direction_output(H3XXX_EGPIO_OPT_RESET, 0);\r\nif (err)\r\ngoto err05;\r\nerr = gpio_request(H3XXX_EGPIO_CARD_RESET, "PCMCIA CARD RESET");\r\nif (err)\r\ngoto err05;\r\nerr = gpio_direction_output(H3XXX_EGPIO_CARD_RESET, 0);\r\nif (err)\r\ngoto err06;\r\nerr = soc_pcmcia_request_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nif (err)\r\ngoto err06;\r\nbreak;\r\ncase 1:\r\nerr = gpio_request(H3XXX_GPIO_PCMCIA_IRQ1, "PCMCIA IRQ1");\r\nif (err)\r\ngoto err10;\r\nerr = gpio_direction_input(H3XXX_GPIO_PCMCIA_IRQ1);\r\nif (err)\r\ngoto err11;\r\nskt->socket.pci_irq = gpio_to_irq(H3XXX_GPIO_PCMCIA_IRQ1);\r\nerr = gpio_request(H3XXX_GPIO_PCMCIA_CD1, "PCMCIA CD1");\r\nif (err)\r\ngoto err11;\r\nerr = gpio_direction_input(H3XXX_GPIO_PCMCIA_CD1);\r\nif (err)\r\ngoto err12;\r\nirqs[1].irq = gpio_to_irq(H3XXX_GPIO_PCMCIA_CD1);\r\nerr = soc_pcmcia_request_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nif (err)\r\ngoto err12;\r\nbreak;\r\n}\r\nreturn 0;\r\nerr06: gpio_free(H3XXX_EGPIO_CARD_RESET);\r\nerr05: gpio_free(H3XXX_EGPIO_OPT_RESET);\r\nerr04: gpio_free(H3XXX_EGPIO_OPT_ON);\r\nerr03: gpio_free(H3XXX_EGPIO_OPT_NVRAM_ON);\r\nerr02: gpio_free(H3XXX_GPIO_PCMCIA_CD0);\r\nerr01: gpio_free(H3XXX_GPIO_PCMCIA_IRQ0);\r\nerr00: return err;\r\nerr12: gpio_free(H3XXX_GPIO_PCMCIA_CD0);\r\nerr11: gpio_free(H3XXX_GPIO_PCMCIA_IRQ0);\r\nerr10: return err;\r\n}\r\nstatic void h3600_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\nsoc_pcmcia_free_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nswitch (skt->nr) {\r\ncase 0:\r\ngpio_set_value(H3XXX_EGPIO_OPT_NVRAM_ON, 0);\r\ngpio_set_value(H3XXX_EGPIO_OPT_ON, 0);\r\ngpio_set_value(H3XXX_EGPIO_OPT_RESET, 1);\r\ngpio_free(H3XXX_EGPIO_CARD_RESET);\r\ngpio_free(H3XXX_EGPIO_OPT_RESET);\r\ngpio_free(H3XXX_EGPIO_OPT_ON);\r\ngpio_free(H3XXX_EGPIO_OPT_NVRAM_ON);\r\ngpio_free(H3XXX_GPIO_PCMCIA_CD0);\r\ngpio_free(H3XXX_GPIO_PCMCIA_IRQ0);\r\nbreak;\r\ncase 1:\r\ngpio_free(H3XXX_GPIO_PCMCIA_CD1);\r\ngpio_free(H3XXX_GPIO_PCMCIA_IRQ1);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nh3600_pcmcia_socket_state(struct soc_pcmcia_socket *skt, struct pcmcia_state *state)\r\n{\r\nswitch (skt->nr) {\r\ncase 0:\r\nstate->detect = !gpio_get_value(H3XXX_GPIO_PCMCIA_CD0);\r\nstate->ready = !!gpio_get_value(H3XXX_GPIO_PCMCIA_IRQ0);\r\nstate->bvd1 = 0;\r\nstate->bvd2 = 0;\r\nstate->wrprot = 0;\r\nstate->vs_3v = 0;\r\nstate->vs_Xv = 0;\r\nbreak;\r\ncase 1:\r\nstate->detect = !gpio_get_value(H3XXX_GPIO_PCMCIA_CD1);\r\nstate->ready = !!gpio_get_value(H3XXX_GPIO_PCMCIA_IRQ1);\r\nstate->bvd1 = 0;\r\nstate->bvd2 = 0;\r\nstate->wrprot = 0;\r\nstate->vs_3v = 0;\r\nstate->vs_Xv = 0;\r\nbreak;\r\n}\r\n}\r\nstatic int\r\nh3600_pcmcia_configure_socket(struct soc_pcmcia_socket *skt, const socket_state_t *state)\r\n{\r\nif (state->Vcc != 0 && state->Vcc != 33 && state->Vcc != 50) {\r\nprintk(KERN_ERR "h3600_pcmcia: unrecognized Vcc %u.%uV\n",\r\nstate->Vcc / 10, state->Vcc % 10);\r\nreturn -1;\r\n}\r\ngpio_set_value(H3XXX_EGPIO_CARD_RESET, !!(state->flags & SS_RESET));\r\nreturn 0;\r\n}\r\nstatic void h3600_pcmcia_socket_init(struct soc_pcmcia_socket *skt)\r\n{\r\ngpio_set_value(H3XXX_EGPIO_OPT_NVRAM_ON, 1);\r\ngpio_set_value(H3XXX_EGPIO_OPT_ON, 1);\r\ngpio_set_value(H3XXX_EGPIO_OPT_RESET, 0);\r\nmsleep(10);\r\nsoc_pcmcia_enable_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\n}\r\nstatic void h3600_pcmcia_socket_suspend(struct soc_pcmcia_socket *skt)\r\n{\r\nsoc_pcmcia_disable_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nif (skt->nr == 1) {\r\ngpio_set_value(H3XXX_EGPIO_OPT_ON, 0);\r\ngpio_set_value(H3XXX_EGPIO_OPT_NVRAM_ON, 0);\r\ngpio_set_value(H3XXX_EGPIO_OPT_RESET, 1);\r\n}\r\n}\r\nint __devinit pcmcia_h3600_init(struct device *dev)\r\n{\r\nint ret = -ENODEV;\r\nif (machine_is_h3600() || machine_is_h3100())\r\nret = sa11xx_drv_pcmcia_probe(dev, &h3600_pcmcia_ops, 0, 2);\r\nreturn ret;\r\n}

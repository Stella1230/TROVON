int omap4_dpllmx_gatectrl_read(struct clk *clk)\r\n{\r\nu32 v;\r\nu32 mask;\r\nif (!clk || !clk->clksel_reg || !cpu_is_omap44xx())\r\nreturn -EINVAL;\r\nmask = clk->flags & CLOCK_CLKOUTX2 ?\r\nOMAP4430_DPLL_CLKOUTX2_GATE_CTRL_MASK :\r\nOMAP4430_DPLL_CLKOUT_GATE_CTRL_MASK;\r\nv = __raw_readl(clk->clksel_reg);\r\nv &= mask;\r\nv >>= __ffs(mask);\r\nreturn v;\r\n}\r\nvoid omap4_dpllmx_allow_gatectrl(struct clk *clk)\r\n{\r\nu32 v;\r\nu32 mask;\r\nif (!clk || !clk->clksel_reg || !cpu_is_omap44xx())\r\nreturn;\r\nmask = clk->flags & CLOCK_CLKOUTX2 ?\r\nOMAP4430_DPLL_CLKOUTX2_GATE_CTRL_MASK :\r\nOMAP4430_DPLL_CLKOUT_GATE_CTRL_MASK;\r\nv = __raw_readl(clk->clksel_reg);\r\nv &= ~mask;\r\n__raw_writel(v, clk->clksel_reg);\r\n}\r\nvoid omap4_dpllmx_deny_gatectrl(struct clk *clk)\r\n{\r\nu32 v;\r\nu32 mask;\r\nif (!clk || !clk->clksel_reg || !cpu_is_omap44xx())\r\nreturn;\r\nmask = clk->flags & CLOCK_CLKOUTX2 ?\r\nOMAP4430_DPLL_CLKOUTX2_GATE_CTRL_MASK :\r\nOMAP4430_DPLL_CLKOUT_GATE_CTRL_MASK;\r\nv = __raw_readl(clk->clksel_reg);\r\nv |= mask;\r\n__raw_writel(v, clk->clksel_reg);\r\n}\r\nunsigned long omap4_dpll_regm4xen_recalc(struct clk *clk)\r\n{\r\nu32 v;\r\nunsigned long rate;\r\nstruct dpll_data *dd;\r\nif (!clk || !clk->dpll_data)\r\nreturn 0;\r\ndd = clk->dpll_data;\r\nrate = omap2_get_dpll_rate(clk);\r\nv = __raw_readl(dd->control_reg);\r\nif (v & OMAP4430_DPLL_REGM4XEN_MASK)\r\nrate *= OMAP4430_REGM4XEN_MULT;\r\nreturn rate;\r\n}\r\nlong omap4_dpll_regm4xen_round_rate(struct clk *clk, unsigned long target_rate)\r\n{\r\nu32 v;\r\nstruct dpll_data *dd;\r\nlong r;\r\nif (!clk || !clk->dpll_data)\r\nreturn -EINVAL;\r\ndd = clk->dpll_data;\r\nv = __raw_readl(dd->control_reg) & OMAP4430_DPLL_REGM4XEN_MASK;\r\nif (v)\r\ntarget_rate = target_rate / OMAP4430_REGM4XEN_MULT;\r\nr = omap2_dpll_round_rate(clk, target_rate);\r\nif (r == ~0)\r\nreturn r;\r\nif (v)\r\nclk->dpll_data->last_rounded_rate *= OMAP4430_REGM4XEN_MULT;\r\nreturn clk->dpll_data->last_rounded_rate;\r\n}

static inline int\r\n__inode_direct_access(struct inode *inode, sector_t block,\r\nvoid **kaddr, unsigned long *pfn)\r\n{\r\nstruct block_device *bdev = inode->i_sb->s_bdev;\r\nconst struct block_device_operations *ops = bdev->bd_disk->fops;\r\nsector_t sector;\r\nsector = block * (PAGE_SIZE / 512);\r\nBUG_ON(!ops->direct_access);\r\nreturn ops->direct_access(bdev, sector, kaddr, pfn);\r\n}\r\nstatic inline int\r\n__ext2_get_block(struct inode *inode, pgoff_t pgoff, int create,\r\nsector_t *result)\r\n{\r\nstruct buffer_head tmp;\r\nint rc;\r\nmemset(&tmp, 0, sizeof(struct buffer_head));\r\nrc = ext2_get_block(inode, pgoff, &tmp, create);\r\n*result = tmp.b_blocknr;\r\nif (!tmp.b_blocknr && !rc) {\r\nBUG_ON(create);\r\nrc = -ENODATA;\r\n}\r\nreturn rc;\r\n}\r\nint\r\next2_clear_xip_target(struct inode *inode, sector_t block)\r\n{\r\nvoid *kaddr;\r\nunsigned long pfn;\r\nint rc;\r\nrc = __inode_direct_access(inode, block, &kaddr, &pfn);\r\nif (!rc)\r\nclear_page(kaddr);\r\nreturn rc;\r\n}\r\nvoid ext2_xip_verify_sb(struct super_block *sb)\r\n{\r\nstruct ext2_sb_info *sbi = EXT2_SB(sb);\r\nif ((sbi->s_mount_opt & EXT2_MOUNT_XIP) &&\r\n!sb->s_bdev->bd_disk->fops->direct_access) {\r\nsbi->s_mount_opt &= (~EXT2_MOUNT_XIP);\r\next2_msg(sb, KERN_WARNING,\r\n"warning: ignoring xip option - "\r\n"not supported by bdev");\r\n}\r\n}\r\nint ext2_get_xip_mem(struct address_space *mapping, pgoff_t pgoff, int create,\r\nvoid **kmem, unsigned long *pfn)\r\n{\r\nint rc;\r\nsector_t block;\r\nrc = __ext2_get_block(mapping->host, pgoff, create, &block);\r\nif (rc)\r\nreturn rc;\r\nrc = __inode_direct_access(mapping->host, block, kmem, pfn);\r\nreturn rc;\r\n}

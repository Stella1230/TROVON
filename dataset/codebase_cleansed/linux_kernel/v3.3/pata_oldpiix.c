static int oldpiix_pre_reset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstatic const struct pci_bits oldpiix_enable_bits[] = {\r\n{ 0x41U, 1U, 0x80UL, 0x80UL },\r\n{ 0x43U, 1U, 0x80UL, 0x80UL },\r\n};\r\nif (!pci_test_config_bits(pdev, &oldpiix_enable_bits[ap->port_no]))\r\nreturn -ENOENT;\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic void oldpiix_set_piomode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nunsigned int pio = adev->pio_mode - XFER_PIO_0;\r\nstruct pci_dev *dev = to_pci_dev(ap->host->dev);\r\nunsigned int idetm_port= ap->port_no ? 0x42 : 0x40;\r\nu16 idetm_data;\r\nint control = 0;\r\nstatic const\r\nu8 timings[][2] = { { 0, 0 },\r\n{ 0, 0 },\r\n{ 1, 0 },\r\n{ 2, 1 },\r\n{ 2, 3 }, };\r\nif (pio > 1)\r\ncontrol |= 1;\r\nif (ata_pio_need_iordy(adev))\r\ncontrol |= 2;\r\nif (adev->class == ATA_DEV_ATA)\r\ncontrol |= 4;\r\npci_read_config_word(dev, idetm_port, &idetm_data);\r\nif (adev->devno == 0) {\r\nidetm_data &= 0xCCE0;\r\nidetm_data |= control;\r\n} else {\r\nidetm_data &= 0xCC0E;\r\nidetm_data |= (control << 4);\r\n}\r\nidetm_data |= (timings[pio][0] << 12) |\r\n(timings[pio][1] << 8);\r\npci_write_config_word(dev, idetm_port, idetm_data);\r\nap->private_data = adev;\r\n}\r\nstatic void oldpiix_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(ap->host->dev);\r\nu8 idetm_port = ap->port_no ? 0x42 : 0x40;\r\nu16 idetm_data;\r\nstatic const\r\nu8 timings[][2] = { { 0, 0 },\r\n{ 0, 0 },\r\n{ 1, 0 },\r\n{ 2, 1 },\r\n{ 2, 3 }, };\r\nunsigned int mwdma = adev->dma_mode - XFER_MW_DMA_0;\r\nunsigned int control;\r\nconst unsigned int needed_pio[3] = {\r\nXFER_PIO_0, XFER_PIO_3, XFER_PIO_4\r\n};\r\nint pio = needed_pio[mwdma] - XFER_PIO_0;\r\npci_read_config_word(dev, idetm_port, &idetm_data);\r\ncontrol = 3;\r\nif (adev->class == ATA_DEV_ATA)\r\ncontrol |= 4;\r\nif (adev->pio_mode < needed_pio[mwdma])\r\ncontrol |= 8;\r\nif (adev->devno == 0) {\r\nidetm_data &= 0xCCE0;\r\nidetm_data |= control;\r\n} else {\r\nidetm_data &= 0xCC0E;\r\nidetm_data |= (control << 4);\r\n}\r\nidetm_data |= (timings[pio][0] << 12) | (timings[pio][1] << 8);\r\npci_write_config_word(dev, idetm_port, idetm_data);\r\nap->private_data = adev;\r\n}\r\nstatic unsigned int oldpiix_qc_issue(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct ata_device *adev = qc->dev;\r\nif (adev != ap->private_data) {\r\noldpiix_set_piomode(ap, adev);\r\nif (ata_dma_enabled(adev))\r\noldpiix_set_dmamode(ap, adev);\r\n}\r\nreturn ata_bmdma_qc_issue(qc);\r\n}\r\nstatic int oldpiix_init_one (struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA12_ONLY,\r\n.port_ops = &oldpiix_pata_ops,\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &oldpiix_sht, NULL, 0);\r\n}\r\nstatic int __init oldpiix_init(void)\r\n{\r\nreturn pci_register_driver(&oldpiix_pci_driver);\r\n}\r\nstatic void __exit oldpiix_exit(void)\r\n{\r\npci_unregister_driver(&oldpiix_pci_driver);\r\n}

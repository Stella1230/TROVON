static unsigned long ftrace_nop_replace(struct dyn_ftrace *rec)\r\n{\r\nreturn rec->arch.old_mcount ? OLD_NOP : NOP;\r\n}\r\nstatic unsigned long adjust_address(struct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nif (!rec->arch.old_mcount)\r\nreturn addr;\r\nif (addr == MCOUNT_ADDR)\r\naddr = OLD_MCOUNT_ADDR;\r\nelse if (addr == FTRACE_ADDR)\r\naddr = OLD_FTRACE_ADDR;\r\nreturn addr;\r\n}\r\nstatic unsigned long ftrace_nop_replace(struct dyn_ftrace *rec)\r\n{\r\nreturn NOP;\r\n}\r\nstatic unsigned long adjust_address(struct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nreturn addr;\r\n}\r\nstatic unsigned long ftrace_gen_branch(unsigned long pc, unsigned long addr,\r\nbool link)\r\n{\r\nunsigned long s, j1, j2, i1, i2, imm10, imm11;\r\nunsigned long first, second;\r\nlong offset;\r\noffset = (long)addr - (long)(pc + 4);\r\nif (offset < -16777216 || offset > 16777214) {\r\nWARN_ON_ONCE(1);\r\nreturn 0;\r\n}\r\ns = (offset >> 24) & 0x1;\r\ni1 = (offset >> 23) & 0x1;\r\ni2 = (offset >> 22) & 0x1;\r\nimm10 = (offset >> 12) & 0x3ff;\r\nimm11 = (offset >> 1) & 0x7ff;\r\nj1 = (!i1) ^ s;\r\nj2 = (!i2) ^ s;\r\nfirst = 0xf000 | (s << 10) | imm10;\r\nsecond = 0x9000 | (j1 << 13) | (j2 << 11) | imm11;\r\nif (link)\r\nsecond |= 1 << 14;\r\nreturn (second << 16) | first;\r\n}\r\nstatic unsigned long ftrace_gen_branch(unsigned long pc, unsigned long addr,\r\nbool link)\r\n{\r\nunsigned long opcode = 0xea000000;\r\nlong offset;\r\nif (link)\r\nopcode |= 1 << 24;\r\noffset = (long)addr - (long)(pc + 8);\r\nif (unlikely(offset < -33554432 || offset > 33554428)) {\r\nWARN_ON_ONCE(1);\r\nreturn 0;\r\n}\r\noffset = (offset >> 2) & 0x00ffffff;\r\nreturn opcode | offset;\r\n}\r\nstatic unsigned long ftrace_call_replace(unsigned long pc, unsigned long addr)\r\n{\r\nreturn ftrace_gen_branch(pc, addr, true);\r\n}\r\nstatic int ftrace_modify_code(unsigned long pc, unsigned long old,\r\nunsigned long new)\r\n{\r\nunsigned long replaced;\r\nif (probe_kernel_read(&replaced, (void *)pc, MCOUNT_INSN_SIZE))\r\nreturn -EFAULT;\r\nif (replaced != old)\r\nreturn -EINVAL;\r\nif (probe_kernel_write((void *)pc, &new, MCOUNT_INSN_SIZE))\r\nreturn -EPERM;\r\nflush_icache_range(pc, pc + MCOUNT_INSN_SIZE);\r\nreturn 0;\r\n}\r\nint ftrace_update_ftrace_func(ftrace_func_t func)\r\n{\r\nunsigned long pc, old;\r\nunsigned long new;\r\nint ret;\r\npc = (unsigned long)&ftrace_call;\r\nmemcpy(&old, &ftrace_call, MCOUNT_INSN_SIZE);\r\nnew = ftrace_call_replace(pc, (unsigned long)func);\r\nret = ftrace_modify_code(pc, old, new);\r\n#ifdef CONFIG_OLD_MCOUNT\r\nif (!ret) {\r\npc = (unsigned long)&ftrace_call_old;\r\nmemcpy(&old, &ftrace_call_old, MCOUNT_INSN_SIZE);\r\nnew = ftrace_call_replace(pc, (unsigned long)func);\r\nret = ftrace_modify_code(pc, old, new);\r\n}\r\n#endif\r\nreturn ret;\r\n}\r\nint ftrace_make_call(struct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nunsigned long new, old;\r\nunsigned long ip = rec->ip;\r\nold = ftrace_nop_replace(rec);\r\nnew = ftrace_call_replace(ip, adjust_address(rec, addr));\r\nreturn ftrace_modify_code(rec->ip, old, new);\r\n}\r\nint ftrace_make_nop(struct module *mod,\r\nstruct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nunsigned long ip = rec->ip;\r\nunsigned long old;\r\nunsigned long new;\r\nint ret;\r\nold = ftrace_call_replace(ip, adjust_address(rec, addr));\r\nnew = ftrace_nop_replace(rec);\r\nret = ftrace_modify_code(ip, old, new);\r\n#ifdef CONFIG_OLD_MCOUNT\r\nif (ret == -EINVAL && addr == MCOUNT_ADDR) {\r\nrec->arch.old_mcount = true;\r\nold = ftrace_call_replace(ip, adjust_address(rec, addr));\r\nnew = ftrace_nop_replace(rec);\r\nret = ftrace_modify_code(ip, old, new);\r\n}\r\n#endif\r\nreturn ret;\r\n}\r\nint __init ftrace_dyn_arch_init(void *data)\r\n{\r\n*(unsigned long *)data = 0;\r\nreturn 0;\r\n}\r\nvoid prepare_ftrace_return(unsigned long *parent, unsigned long self_addr,\r\nunsigned long frame_pointer)\r\n{\r\nunsigned long return_hooker = (unsigned long) &return_to_handler;\r\nstruct ftrace_graph_ent trace;\r\nunsigned long old;\r\nint err;\r\nif (unlikely(atomic_read(&current->tracing_graph_pause)))\r\nreturn;\r\nold = *parent;\r\n*parent = return_hooker;\r\nerr = ftrace_push_return_trace(old, self_addr, &trace.depth,\r\nframe_pointer);\r\nif (err == -EBUSY) {\r\n*parent = old;\r\nreturn;\r\n}\r\ntrace.func = self_addr;\r\nif (!ftrace_graph_entry(&trace)) {\r\ncurrent->curr_ret_stack--;\r\n*parent = old;\r\n}\r\n}\r\nstatic int __ftrace_modify_caller(unsigned long *callsite,\r\nvoid (*func) (void), bool enable)\r\n{\r\nunsigned long caller_fn = (unsigned long) func;\r\nunsigned long pc = (unsigned long) callsite;\r\nunsigned long branch = ftrace_gen_branch(pc, caller_fn, false);\r\nunsigned long nop = 0xe1a00000;\r\nunsigned long old = enable ? nop : branch;\r\nunsigned long new = enable ? branch : nop;\r\nreturn ftrace_modify_code(pc, old, new);\r\n}\r\nstatic int ftrace_modify_graph_caller(bool enable)\r\n{\r\nint ret;\r\nret = __ftrace_modify_caller(&ftrace_graph_call,\r\nftrace_graph_caller,\r\nenable);\r\n#ifdef CONFIG_OLD_MCOUNT\r\nif (!ret)\r\nret = __ftrace_modify_caller(&ftrace_graph_call_old,\r\nftrace_graph_caller_old,\r\nenable);\r\n#endif\r\nreturn ret;\r\n}\r\nint ftrace_enable_ftrace_graph_caller(void)\r\n{\r\nreturn ftrace_modify_graph_caller(true);\r\n}\r\nint ftrace_disable_ftrace_graph_caller(void)\r\n{\r\nreturn ftrace_modify_graph_caller(false);\r\n}

struct clk *clk_get(struct device *dev, const char *id)\r\n{\r\nreturn &cpu_clk;\r\n}\r\nstatic void propagate_rate(struct clk *clk)\r\n{\r\nstruct clk *clkp;\r\nlist_for_each_entry(clkp, &clock_list, node) {\r\nif (likely(clkp->parent != clk))\r\ncontinue;\r\nif (likely(clkp->ops && clkp->ops->recalc))\r\nclkp->ops->recalc(clkp);\r\nif (unlikely(clkp->flags & CLK_RATE_PROPAGATES))\r\npropagate_rate(clkp);\r\n}\r\n}\r\nint clk_enable(struct clk *clk)\r\n{\r\nreturn 0;\r\n}\r\nvoid clk_disable(struct clk *clk)\r\n{\r\n}\r\nunsigned long clk_get_rate(struct clk *clk)\r\n{\r\nreturn (unsigned long)clk->rate;\r\n}\r\nvoid clk_put(struct clk *clk)\r\n{\r\n}\r\nint clk_set_rate(struct clk *clk, unsigned long rate)\r\n{\r\nreturn clk_set_rate_ex(clk, rate, 0);\r\n}\r\nint clk_set_rate_ex(struct clk *clk, unsigned long rate, int algo_id)\r\n{\r\nint ret = 0;\r\nint regval;\r\nint i;\r\nif (likely(clk->ops && clk->ops->set_rate)) {\r\nunsigned long flags;\r\nspin_lock_irqsave(&clock_lock, flags);\r\nret = clk->ops->set_rate(clk, rate, algo_id);\r\nspin_unlock_irqrestore(&clock_lock, flags);\r\n}\r\nif (unlikely(clk->flags & CLK_RATE_PROPAGATES))\r\npropagate_rate(clk);\r\nfor (i = 0; loongson2_clockmod_table[i].frequency != CPUFREQ_TABLE_END;\r\ni++) {\r\nif (loongson2_clockmod_table[i].frequency ==\r\nCPUFREQ_ENTRY_INVALID)\r\ncontinue;\r\nif (rate == loongson2_clockmod_table[i].frequency)\r\nbreak;\r\n}\r\nif (rate != loongson2_clockmod_table[i].frequency)\r\nreturn -ENOTSUPP;\r\nclk->rate = rate;\r\nregval = LOONGSON_CHIPCFG0;\r\nregval = (regval & ~0x7) | (loongson2_clockmod_table[i].index - 1);\r\nLOONGSON_CHIPCFG0 = regval;\r\nreturn ret;\r\n}\r\nlong clk_round_rate(struct clk *clk, unsigned long rate)\r\n{\r\nif (likely(clk->ops && clk->ops->round_rate)) {\r\nunsigned long flags, rounded;\r\nspin_lock_irqsave(&clock_lock, flags);\r\nrounded = clk->ops->round_rate(clk, rate);\r\nspin_unlock_irqrestore(&clock_lock, flags);\r\nreturn rounded;\r\n}\r\nreturn rate;\r\n}\r\nvoid loongson2_cpu_wait(void)\r\n{\r\nu32 cpu_freq;\r\nunsigned long flags;\r\nspin_lock_irqsave(&loongson2_wait_lock, flags);\r\ncpu_freq = LOONGSON_CHIPCFG0;\r\nLOONGSON_CHIPCFG0 &= ~0x7;\r\nLOONGSON_CHIPCFG0 = cpu_freq;\r\nspin_unlock_irqrestore(&loongson2_wait_lock, flags);\r\n}

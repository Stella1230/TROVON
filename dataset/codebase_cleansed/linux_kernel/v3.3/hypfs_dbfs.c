static struct hypfs_dbfs_data *hypfs_dbfs_data_alloc(struct hypfs_dbfs_file *f)\r\n{\r\nstruct hypfs_dbfs_data *data;\r\ndata = kmalloc(sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn NULL;\r\nkref_init(&data->kref);\r\ndata->dbfs_file = f;\r\nreturn data;\r\n}\r\nstatic void hypfs_dbfs_data_free(struct kref *kref)\r\n{\r\nstruct hypfs_dbfs_data *data;\r\ndata = container_of(kref, struct hypfs_dbfs_data, kref);\r\ndata->dbfs_file->data_free(data->buf_free_ptr);\r\nkfree(data);\r\n}\r\nstatic void data_free_delayed(struct work_struct *work)\r\n{\r\nstruct hypfs_dbfs_data *data;\r\nstruct hypfs_dbfs_file *df;\r\ndf = container_of(work, struct hypfs_dbfs_file, data_free_work.work);\r\nmutex_lock(&df->lock);\r\ndata = df->data;\r\ndf->data = NULL;\r\nmutex_unlock(&df->lock);\r\nkref_put(&data->kref, hypfs_dbfs_data_free);\r\n}\r\nstatic ssize_t dbfs_read(struct file *file, char __user *buf,\r\nsize_t size, loff_t *ppos)\r\n{\r\nstruct hypfs_dbfs_data *data;\r\nstruct hypfs_dbfs_file *df;\r\nssize_t rc;\r\nif (*ppos != 0)\r\nreturn 0;\r\ndf = file->f_path.dentry->d_inode->i_private;\r\nmutex_lock(&df->lock);\r\nif (!df->data) {\r\ndata = hypfs_dbfs_data_alloc(df);\r\nif (!data) {\r\nmutex_unlock(&df->lock);\r\nreturn -ENOMEM;\r\n}\r\nrc = df->data_create(&data->buf, &data->buf_free_ptr,\r\n&data->size);\r\nif (rc) {\r\nmutex_unlock(&df->lock);\r\nkfree(data);\r\nreturn rc;\r\n}\r\ndf->data = data;\r\nschedule_delayed_work(&df->data_free_work, HZ);\r\n}\r\ndata = df->data;\r\nkref_get(&data->kref);\r\nmutex_unlock(&df->lock);\r\nrc = simple_read_from_buffer(buf, size, ppos, data->buf, data->size);\r\nkref_put(&data->kref, hypfs_dbfs_data_free);\r\nreturn rc;\r\n}\r\nint hypfs_dbfs_create_file(struct hypfs_dbfs_file *df)\r\n{\r\ndf->dentry = debugfs_create_file(df->name, 0400, dbfs_dir, df,\r\n&dbfs_ops);\r\nif (IS_ERR(df->dentry))\r\nreturn PTR_ERR(df->dentry);\r\nmutex_init(&df->lock);\r\nINIT_DELAYED_WORK(&df->data_free_work, data_free_delayed);\r\nreturn 0;\r\n}\r\nvoid hypfs_dbfs_remove_file(struct hypfs_dbfs_file *df)\r\n{\r\ndebugfs_remove(df->dentry);\r\n}\r\nint hypfs_dbfs_init(void)\r\n{\r\ndbfs_dir = debugfs_create_dir("s390_hypfs", NULL);\r\nif (IS_ERR(dbfs_dir))\r\nreturn PTR_ERR(dbfs_dir);\r\nreturn 0;\r\n}\r\nvoid hypfs_dbfs_exit(void)\r\n{\r\ndebugfs_remove(dbfs_dir);\r\n}

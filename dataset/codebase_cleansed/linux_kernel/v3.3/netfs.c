int __fscache_register_netfs(struct fscache_netfs *netfs)\r\n{\r\nstruct fscache_netfs *ptr;\r\nint ret;\r\n_enter("{%s}", netfs->name);\r\nINIT_LIST_HEAD(&netfs->link);\r\nnetfs->primary_index =\r\nkmem_cache_zalloc(fscache_cookie_jar, GFP_KERNEL);\r\nif (!netfs->primary_index) {\r\n_leave(" = -ENOMEM");\r\nreturn -ENOMEM;\r\n}\r\natomic_set(&netfs->primary_index->usage, 1);\r\natomic_set(&netfs->primary_index->n_children, 0);\r\nnetfs->primary_index->def = &fscache_fsdef_netfs_def;\r\nnetfs->primary_index->parent = &fscache_fsdef_index;\r\nnetfs->primary_index->netfs_data = netfs;\r\natomic_inc(&netfs->primary_index->parent->usage);\r\natomic_inc(&netfs->primary_index->parent->n_children);\r\nspin_lock_init(&netfs->primary_index->lock);\r\nINIT_HLIST_HEAD(&netfs->primary_index->backing_objects);\r\ndown_write(&fscache_addremove_sem);\r\nret = -EEXIST;\r\nlist_for_each_entry(ptr, &fscache_netfs_list, link) {\r\nif (strcmp(ptr->name, netfs->name) == 0)\r\ngoto already_registered;\r\n}\r\nlist_add(&netfs->link, &fscache_netfs_list);\r\nret = 0;\r\nprintk(KERN_NOTICE "FS-Cache: Netfs '%s' registered for caching\n",\r\nnetfs->name);\r\nalready_registered:\r\nup_write(&fscache_addremove_sem);\r\nif (ret < 0) {\r\nnetfs->primary_index->parent = NULL;\r\n__fscache_cookie_put(netfs->primary_index);\r\nnetfs->primary_index = NULL;\r\n}\r\n_leave(" = %d", ret);\r\nreturn ret;\r\n}\r\nvoid __fscache_unregister_netfs(struct fscache_netfs *netfs)\r\n{\r\n_enter("{%s.%u}", netfs->name, netfs->version);\r\ndown_write(&fscache_addremove_sem);\r\nlist_del(&netfs->link);\r\nfscache_relinquish_cookie(netfs->primary_index, 0);\r\nup_write(&fscache_addremove_sem);\r\nprintk(KERN_NOTICE "FS-Cache: Netfs '%s' unregistered from caching\n",\r\nnetfs->name);\r\n_leave("");\r\n}

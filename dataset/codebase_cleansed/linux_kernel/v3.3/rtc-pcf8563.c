static int pcf8563_get_datetime(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nstruct pcf8563 *pcf8563 = i2c_get_clientdata(client);\r\nunsigned char buf[13] = { PCF8563_REG_ST1 };\r\nstruct i2c_msg msgs[] = {\r\n{ client->addr, 0, 1, buf },\r\n{ client->addr, I2C_M_RD, 13, buf },\r\n};\r\nif ((i2c_transfer(client->adapter, msgs, 2)) != 2) {\r\ndev_err(&client->dev, "%s: read error\n", __func__);\r\nreturn -EIO;\r\n}\r\nif (buf[PCF8563_REG_SC] & PCF8563_SC_LV)\r\ndev_info(&client->dev,\r\n"low voltage detected, date/time is not reliable.\n");\r\ndev_dbg(&client->dev,\r\n"%s: raw data is st1=%02x, st2=%02x, sec=%02x, min=%02x, hr=%02x, "\r\n"mday=%02x, wday=%02x, mon=%02x, year=%02x\n",\r\n__func__,\r\nbuf[0], buf[1], buf[2], buf[3],\r\nbuf[4], buf[5], buf[6], buf[7],\r\nbuf[8]);\r\ntm->tm_sec = bcd2bin(buf[PCF8563_REG_SC] & 0x7F);\r\ntm->tm_min = bcd2bin(buf[PCF8563_REG_MN] & 0x7F);\r\ntm->tm_hour = bcd2bin(buf[PCF8563_REG_HR] & 0x3F);\r\ntm->tm_mday = bcd2bin(buf[PCF8563_REG_DM] & 0x3F);\r\ntm->tm_wday = buf[PCF8563_REG_DW] & 0x07;\r\ntm->tm_mon = bcd2bin(buf[PCF8563_REG_MO] & 0x1F) - 1;\r\ntm->tm_year = bcd2bin(buf[PCF8563_REG_YR]);\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\npcf8563->c_polarity = (buf[PCF8563_REG_MO] & PCF8563_MO_C) ?\r\n(tm->tm_year >= 100) : (tm->tm_year < 100);\r\ndev_dbg(&client->dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nif (rtc_valid_tm(tm) < 0)\r\ndev_err(&client->dev, "retrieved date/time is not valid.\n");\r\nreturn 0;\r\n}\r\nstatic int pcf8563_set_datetime(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nstruct pcf8563 *pcf8563 = i2c_get_clientdata(client);\r\nint i, err;\r\nunsigned char buf[9];\r\ndev_dbg(&client->dev, "%s: secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nbuf[PCF8563_REG_SC] = bin2bcd(tm->tm_sec);\r\nbuf[PCF8563_REG_MN] = bin2bcd(tm->tm_min);\r\nbuf[PCF8563_REG_HR] = bin2bcd(tm->tm_hour);\r\nbuf[PCF8563_REG_DM] = bin2bcd(tm->tm_mday);\r\nbuf[PCF8563_REG_MO] = bin2bcd(tm->tm_mon + 1);\r\nbuf[PCF8563_REG_YR] = bin2bcd(tm->tm_year % 100);\r\nif (pcf8563->c_polarity ? (tm->tm_year >= 100) : (tm->tm_year < 100))\r\nbuf[PCF8563_REG_MO] |= PCF8563_MO_C;\r\nbuf[PCF8563_REG_DW] = tm->tm_wday & 0x07;\r\nfor (i = 0; i < 7; i++) {\r\nunsigned char data[2] = { PCF8563_REG_SC + i,\r\nbuf[PCF8563_REG_SC + i] };\r\nerr = i2c_master_send(client, data, sizeof(data));\r\nif (err != sizeof(data)) {\r\ndev_err(&client->dev,\r\n"%s: err=%d addr=%02x, data=%02x\n",\r\n__func__, err, data[0], data[1]);\r\nreturn -EIO;\r\n}\r\n};\r\nreturn 0;\r\n}\r\nstatic int pcf8563_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn pcf8563_get_datetime(to_i2c_client(dev), tm);\r\n}\r\nstatic int pcf8563_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn pcf8563_set_datetime(to_i2c_client(dev), tm);\r\n}\r\nstatic int pcf8563_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct pcf8563 *pcf8563;\r\nint err = 0;\r\ndev_dbg(&client->dev, "%s\n", __func__);\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\npcf8563 = kzalloc(sizeof(struct pcf8563), GFP_KERNEL);\r\nif (!pcf8563)\r\nreturn -ENOMEM;\r\ndev_info(&client->dev, "chip found, driver version " DRV_VERSION "\n");\r\ni2c_set_clientdata(client, pcf8563);\r\npcf8563->rtc = rtc_device_register(pcf8563_driver.driver.name,\r\n&client->dev, &pcf8563_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(pcf8563->rtc)) {\r\nerr = PTR_ERR(pcf8563->rtc);\r\ngoto exit_kfree;\r\n}\r\nreturn 0;\r\nexit_kfree:\r\nkfree(pcf8563);\r\nreturn err;\r\n}\r\nstatic int pcf8563_remove(struct i2c_client *client)\r\n{\r\nstruct pcf8563 *pcf8563 = i2c_get_clientdata(client);\r\nif (pcf8563->rtc)\r\nrtc_device_unregister(pcf8563->rtc);\r\nkfree(pcf8563);\r\nreturn 0;\r\n}\r\nstatic int __init pcf8563_init(void)\r\n{\r\nreturn i2c_add_driver(&pcf8563_driver);\r\n}\r\nstatic void __exit pcf8563_exit(void)\r\n{\r\ni2c_del_driver(&pcf8563_driver);\r\n}

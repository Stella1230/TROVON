int sun_partition(struct parsed_partitions *state)\r\n{\r\nint i;\r\n__be16 csum;\r\nint slot = 1;\r\n__be16 *ush;\r\nSector sect;\r\nstruct sun_disklabel {\r\nunsigned char info[128];\r\nstruct sun_vtoc {\r\n__be32 version;\r\nchar volume[8];\r\n__be16 nparts;\r\nstruct sun_info {\r\n__be16 id;\r\n__be16 flags;\r\n} infos[8];\r\n__be16 padding;\r\n__be32 bootinfo[3];\r\n__be32 sanity;\r\n__be32 reserved[10];\r\n__be32 timestamp[8];\r\n} vtoc;\r\n__be32 write_reinstruct;\r\n__be32 read_reinstruct;\r\nunsigned char spare[148];\r\n__be16 rspeed;\r\n__be16 pcylcount;\r\n__be16 sparecyl;\r\n__be16 obs1;\r\n__be16 obs2;\r\n__be16 ilfact;\r\n__be16 ncyl;\r\n__be16 nacyl;\r\n__be16 ntrks;\r\n__be16 nsect;\r\n__be16 obs3;\r\n__be16 obs4;\r\nstruct sun_partition {\r\n__be32 start_cylinder;\r\n__be32 num_sectors;\r\n} partitions[8];\r\n__be16 magic;\r\n__be16 csum;\r\n} * label;\r\nstruct sun_partition *p;\r\nunsigned long spc;\r\nchar b[BDEVNAME_SIZE];\r\nint use_vtoc;\r\nint nparts;\r\nlabel = read_part_sector(state, 0, &sect);\r\nif (!label)\r\nreturn -1;\r\np = label->partitions;\r\nif (be16_to_cpu(label->magic) != SUN_LABEL_MAGIC) {\r\nput_dev_sector(sect);\r\nreturn 0;\r\n}\r\nush = ((__be16 *) (label+1)) - 1;\r\nfor (csum = 0; ush >= ((__be16 *) label);)\r\ncsum ^= *ush--;\r\nif (csum) {\r\nprintk("Dev %s Sun disklabel: Csum bad, label corrupted\n",\r\nbdevname(state->bdev, b));\r\nput_dev_sector(sect);\r\nreturn 0;\r\n}\r\nuse_vtoc = ((be32_to_cpu(label->vtoc.sanity) == SUN_VTOC_SANITY) &&\r\n(be32_to_cpu(label->vtoc.version) == 1) &&\r\n(be16_to_cpu(label->vtoc.nparts) <= 8));\r\nnparts = (use_vtoc) ? be16_to_cpu(label->vtoc.nparts) : 8;\r\nuse_vtoc = use_vtoc || !(label->vtoc.sanity ||\r\nlabel->vtoc.version || label->vtoc.nparts);\r\nspc = be16_to_cpu(label->ntrks) * be16_to_cpu(label->nsect);\r\nfor (i = 0; i < nparts; i++, p++) {\r\nunsigned long st_sector;\r\nunsigned int num_sectors;\r\nst_sector = be32_to_cpu(p->start_cylinder) * spc;\r\nnum_sectors = be32_to_cpu(p->num_sectors);\r\nif (num_sectors) {\r\nput_partition(state, slot, st_sector, num_sectors);\r\nstate->parts[slot].flags = 0;\r\nif (use_vtoc) {\r\nif (be16_to_cpu(label->vtoc.infos[i].id) == LINUX_RAID_PARTITION)\r\nstate->parts[slot].flags |= ADDPART_FLAG_RAID;\r\nelse if (be16_to_cpu(label->vtoc.infos[i].id) == SUN_WHOLE_DISK)\r\nstate->parts[slot].flags |= ADDPART_FLAG_WHOLEDISK;\r\n}\r\n}\r\nslot++;\r\n}\r\nstrlcat(state->pp_buf, "\n", PAGE_SIZE);\r\nput_dev_sector(sect);\r\nreturn 1;\r\n}

unsigned short w_EepromReadWord(unsigned short w_PCIBoardEepromAddress, char *pc_PCIChipInformation,\r\nunsigned short w_EepromStartAddress)\r\n{\r\nunsigned char b_Counter = 0;\r\nunsigned char b_ReadByte = 0;\r\nunsigned char b_ReadLowByte = 0;\r\nunsigned char b_ReadHighByte = 0;\r\nunsigned char b_SelectedAddressLow = 0;\r\nunsigned char b_SelectedAddressHigh = 0;\r\nunsigned short w_ReadWord = 0;\r\nif ((!strcmp(pc_PCIChipInformation, "S5920")) ||\r\n(!strcmp(pc_PCIChipInformation, "S5933")))\r\n{\r\nfor (b_Counter = 0; b_Counter < 2; b_Counter++)\r\n{\r\nb_SelectedAddressLow = (w_EepromStartAddress + b_Counter) % 256;\r\nb_SelectedAddressHigh = (w_EepromStartAddress + b_Counter) / 256;\r\noutb(NVCMD_LOAD_LOW, w_PCIBoardEepromAddress + 0x3F);\r\nv_EepromWaitBusy(w_PCIBoardEepromAddress);\r\noutb(b_SelectedAddressLow,\r\nw_PCIBoardEepromAddress + 0x3E);\r\nv_EepromWaitBusy(w_PCIBoardEepromAddress);\r\noutb(NVCMD_LOAD_HIGH, w_PCIBoardEepromAddress + 0x3F);\r\nv_EepromWaitBusy(w_PCIBoardEepromAddress);\r\noutb(b_SelectedAddressHigh,\r\nw_PCIBoardEepromAddress + 0x3E);\r\nv_EepromWaitBusy(w_PCIBoardEepromAddress);\r\noutb(NVCMD_BEGIN_READ, w_PCIBoardEepromAddress + 0x3F);\r\nv_EepromWaitBusy(w_PCIBoardEepromAddress);\r\nb_ReadByte = inb(w_PCIBoardEepromAddress + 0x3E);\r\nv_EepromWaitBusy(w_PCIBoardEepromAddress);\r\nif (b_Counter == 0)\r\n{\r\nb_ReadLowByte = b_ReadByte;\r\n}\r\nelse\r\n{\r\nb_ReadHighByte = b_ReadByte;\r\n}\r\n}\r\nw_ReadWord = (b_ReadLowByte | (((unsigned short) b_ReadHighByte) * 256));\r\n}\r\nif (!strcmp(pc_PCIChipInformation, "93C76"))\r\n{\r\nv_EepromCs76Read(w_PCIBoardEepromAddress, w_EepromStartAddress,\r\n&w_ReadWord);\r\n}\r\nreturn w_ReadWord;\r\n}\r\nvoid v_EepromWaitBusy(unsigned short w_PCIBoardEepromAddress)\r\n{\r\nunsigned char b_EepromBusy = 0;\r\ndo\r\n{\r\nb_EepromBusy = inb(w_PCIBoardEepromAddress + 0x3F);\r\nb_EepromBusy = b_EepromBusy & 0x80;\r\n} while (b_EepromBusy == 0x80);\r\n}\r\nvoid v_EepromClock76(unsigned int dw_Address, unsigned int dw_RegisterValue)\r\n{\r\noutl(dw_RegisterValue & 0x6, dw_Address);\r\nudelay(100);\r\noutl(dw_RegisterValue | 0x1, dw_Address);\r\nudelay(100);\r\n}\r\nvoid v_EepromSendCommand76(unsigned int dw_Address, unsigned int dw_EepromCommand,\r\nunsigned char b_DataLengthInBits)\r\n{\r\nchar c_BitPos = 0;\r\nunsigned int dw_RegisterValue = 0;\r\ndw_RegisterValue = 0x2;\r\noutl(dw_RegisterValue, dw_Address);\r\nudelay(100);\r\nfor (c_BitPos = (b_DataLengthInBits - 1); c_BitPos >= 0; c_BitPos--)\r\n{\r\nif (dw_EepromCommand & (1 << c_BitPos))\r\n{\r\ndw_RegisterValue = dw_RegisterValue | 0x4;\r\n}\r\nelse\r\n{\r\ndw_RegisterValue = dw_RegisterValue & 0x3;\r\n}\r\noutl(dw_RegisterValue, dw_Address);\r\nudelay(100);\r\nv_EepromClock76(dw_Address, dw_RegisterValue);\r\n}\r\n}\r\nvoid v_EepromCs76Read(unsigned int dw_Address, unsigned short w_offset, unsigned short *pw_Value)\r\n{\r\nchar c_BitPos = 0;\r\nunsigned int dw_RegisterValue = 0;\r\nunsigned int dw_RegisterValueRead = 0;\r\nv_EepromSendCommand76(dw_Address, (EE_READ << 4) | (w_offset / 2),\r\nEE76_CMD_LEN);\r\ndw_RegisterValue = (((w_offset / 2) & 0x1) << 2) | 0x2;\r\n*pw_Value = 0;\r\nfor (c_BitPos = 0; c_BitPos < 16; c_BitPos++)\r\n{\r\nv_EepromClock76(dw_Address, dw_RegisterValue);\r\ndw_RegisterValueRead = inl(dw_Address);\r\nudelay(100);\r\nif (dw_RegisterValueRead & 0x8)\r\n{\r\n*pw_Value = (*pw_Value << 1) | 0x1;\r\n}\r\nelse\r\n{\r\n*pw_Value = (*pw_Value << 1);\r\n}\r\n}\r\ndw_RegisterValue = 0x0;\r\noutl(dw_RegisterValue, dw_Address);\r\nudelay(100);\r\n}\r\nint i_EepromReadMainHeader(unsigned short w_PCIBoardEepromAddress,\r\nchar *pc_PCIChipInformation, struct comedi_device *dev)\r\n{\r\nunsigned short w_Temp, i, w_Count = 0;\r\nunsigned int ui_Temp;\r\nstruct str_MainHeader s_MainHeader;\r\nstruct str_DigitalInputHeader s_DigitalInputHeader;\r\nstruct str_DigitalOutputHeader s_DigitalOutputHeader;\r\nstruct str_AnalogOutputHeader s_AnalogOutputHeader;\r\nstruct str_AnalogInputHeader s_AnalogInputHeader;\r\ns_MainHeader.w_HeaderSize =\r\nw_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation,\r\n0x100 + 8);\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + 10);\r\ns_MainHeader.b_Nfunctions = (unsigned char) w_Temp & 0x00FF;\r\nfor (i = 0; i < s_MainHeader.b_Nfunctions; i++) {\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + 12 + w_Count);\r\ns_MainHeader.s_Functions[i].b_Type = (unsigned char) w_Temp & 0x3F;\r\nw_Count = w_Count + 2;\r\ns_MainHeader.s_Functions[i].w_Address =\r\nw_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + 12 + w_Count);\r\nw_Count = w_Count + 2;\r\n}\r\nfor (i = 0; i < s_MainHeader.b_Nfunctions; i++) {\r\nswitch (s_MainHeader.s_Functions[i].b_Type) {\r\ncase EEPROM_DIGITALINPUT:\r\ni_EepromReadDigitalInputHeader(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation,\r\ns_MainHeader.s_Functions[i].w_Address,\r\n&s_DigitalInputHeader);\r\ndevpriv->s_EeParameters.i_NbrDiChannel =\r\ns_DigitalInputHeader.w_Nchannel;\r\nbreak;\r\ncase EEPROM_DIGITALOUTPUT:\r\ni_EepromReadDigitalOutputHeader(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation,\r\ns_MainHeader.s_Functions[i].w_Address,\r\n&s_DigitalOutputHeader);\r\ndevpriv->s_EeParameters.i_NbrDoChannel =\r\ns_DigitalOutputHeader.w_Nchannel;\r\nui_Temp = 0xffffffff;\r\ndevpriv->s_EeParameters.i_DoMaxdata =\r\nui_Temp >> (32 -\r\ndevpriv->s_EeParameters.i_NbrDoChannel);\r\nbreak;\r\ncase EEPROM_ANALOGINPUT:\r\ni_EepromReadAnlogInputHeader(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation,\r\ns_MainHeader.s_Functions[i].w_Address,\r\n&s_AnalogInputHeader);\r\nif (!(strcmp(this_board->pc_DriverName, "apci3200")))\r\ndevpriv->s_EeParameters.i_NbrAiChannel =\r\ns_AnalogInputHeader.w_Nchannel * 4;\r\nelse\r\ndevpriv->s_EeParameters.i_NbrAiChannel =\r\ns_AnalogInputHeader.w_Nchannel;\r\ndevpriv->s_EeParameters.i_Dma =\r\ns_AnalogInputHeader.b_HasDma;\r\ndevpriv->s_EeParameters.ui_MinAcquisitiontimeNs =\r\n(unsigned int) s_AnalogInputHeader.w_MinConvertTiming *\r\n1000;\r\ndevpriv->s_EeParameters.ui_MinDelaytimeNs =\r\n(unsigned int) s_AnalogInputHeader.w_MinDelayTiming *\r\n1000;\r\nui_Temp = 0xffff;\r\ndevpriv->s_EeParameters.i_AiMaxdata =\r\nui_Temp >> (16 -\r\ns_AnalogInputHeader.b_Resolution);\r\nbreak;\r\ncase EEPROM_ANALOGOUTPUT:\r\ni_EepromReadAnlogOutputHeader(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation,\r\ns_MainHeader.s_Functions[i].w_Address,\r\n&s_AnalogOutputHeader);\r\ndevpriv->s_EeParameters.i_NbrAoChannel =\r\ns_AnalogOutputHeader.w_Nchannel;\r\nui_Temp = 0xffff;\r\ndevpriv->s_EeParameters.i_AoMaxdata =\r\nui_Temp >> (16 -\r\ns_AnalogOutputHeader.b_Resolution);\r\nbreak;\r\ncase EEPROM_TIMER:\r\ndevpriv->s_EeParameters.i_Timer = 1;\r\nbreak;\r\ncase EEPROM_WATCHDOG:\r\ndevpriv->s_EeParameters.i_Timer = 1;\r\nbreak;\r\ncase EEPROM_TIMER_WATCHDOG_COUNTER:\r\ndevpriv->s_EeParameters.i_Timer = 1;\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint i_EepromReadDigitalInputHeader(unsigned short w_PCIBoardEepromAddress,\r\nchar *pc_PCIChipInformation, unsigned short w_Address,\r\nstruct str_DigitalInputHeader *s_Header)\r\n{\r\nunsigned short w_Temp;\r\ns_Header->w_Nchannel =\r\nw_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation,\r\n0x100 + w_Address + 6);\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + w_Address + 8);\r\ns_Header->b_Interruptible = (unsigned char) (w_Temp >> 7) & 0x01;\r\ns_Header->w_NinterruptLogic =\r\nw_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation,\r\n0x100 + w_Address + 10);\r\nreturn 0;\r\n}\r\nint i_EepromReadDigitalOutputHeader(unsigned short w_PCIBoardEepromAddress,\r\nchar *pc_PCIChipInformation, unsigned short w_Address,\r\nstruct str_DigitalOutputHeader *s_Header)\r\n{\r\ns_Header->w_Nchannel =\r\nw_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation,\r\n0x100 + w_Address + 6);\r\nreturn 0;\r\n}\r\nint i_EepromReadTimerHeader(unsigned short w_PCIBoardEepromAddress,\r\nchar *pc_PCIChipInformation, unsigned short w_Address,\r\nstruct str_TimerMainHeader *s_Header)\r\n{\r\nunsigned short i, w_Size = 0, w_Temp;\r\ns_Header->w_Ntimer =\r\nw_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation,\r\n0x100 + w_Address + 6);\r\nfor (i = 0; i < s_Header->w_Ntimer; i++) {\r\ns_Header->s_TimerDetails[i].w_HeaderSize =\r\nw_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation,\r\n0x100 + w_Address + 8 + w_Size + 0);\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation,\r\n0x100 + w_Address + 8 + w_Size + 2);\r\ns_Header->s_TimerDetails[i].b_Resolution =\r\n(unsigned char) (w_Temp >> 10) & 0x3F;\r\ns_Header->s_TimerDetails[i].b_Mode =\r\n(unsigned char) (w_Temp >> 4) & 0x3F;\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation,\r\n0x100 + w_Address + 8 + w_Size + 4);\r\ns_Header->s_TimerDetails[i].w_MinTiming = (w_Temp >> 6) & 0x3FF;\r\ns_Header->s_TimerDetails[i].b_TimeBase = (unsigned char) (w_Temp) & 0x3F;\r\nw_Size += s_Header->s_TimerDetails[i].w_HeaderSize;\r\n}\r\nreturn 0;\r\n}\r\nint i_EepromReadAnlogOutputHeader(unsigned short w_PCIBoardEepromAddress,\r\nchar *pc_PCIChipInformation, unsigned short w_Address,\r\nstruct str_AnalogOutputHeader *s_Header)\r\n{\r\nunsigned short w_Temp;\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + w_Address + 10);\r\ns_Header->w_Nchannel = (w_Temp >> 4) & 0x03FF;\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + w_Address + 16);\r\ns_Header->b_Resolution = (unsigned char) (w_Temp >> 8) & 0xFF;\r\nreturn 0;\r\n}\r\nint i_EepromReadAnlogInputHeader(unsigned short w_PCIBoardEepromAddress,\r\nchar *pc_PCIChipInformation, unsigned short w_Address,\r\nstruct str_AnalogInputHeader *s_Header)\r\n{\r\nunsigned short w_Temp, w_Offset;\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + w_Address + 10);\r\ns_Header->w_Nchannel = (w_Temp >> 4) & 0x03FF;\r\ns_Header->w_MinConvertTiming =\r\nw_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation,\r\n0x100 + w_Address + 16);\r\ns_Header->w_MinDelayTiming =\r\nw_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation,\r\n0x100 + w_Address + 30);\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + w_Address + 20);\r\ns_Header->b_HasDma = (w_Temp >> 13) & 0x01;\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress, pc_PCIChipInformation, 0x100 + w_Address + 72);\r\nw_Temp = w_Temp & 0x00FF;\r\nif (w_Temp)\r\n{\r\nw_Offset = 74 + (2 * w_Temp) + (10 * (1 + (w_Temp / 16)));\r\nw_Offset = w_Offset + 2;\r\n} else\r\n{\r\nw_Offset = 74;\r\nw_Offset = w_Offset + 2;\r\n}\r\nw_Temp = w_EepromReadWord(w_PCIBoardEepromAddress,\r\npc_PCIChipInformation, 0x100 + w_Address + w_Offset);\r\ns_Header->b_Resolution = w_Temp & 0x001F;\r\nreturn 0;\r\n}

void __init\r\nmpc5200_setup_xlb_arbiter(void)\r\n{\r\nstruct device_node *np;\r\nstruct mpc52xx_xlb __iomem *xlb;\r\nnp = of_find_matching_node(NULL, mpc52xx_xlb_ids);\r\nxlb = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!xlb) {\r\nprintk(KERN_ERR __FILE__ ": "\r\n"Error mapping XLB in mpc52xx_setup_cpu(). "\r\n"Expect some abnormal behavior\n");\r\nreturn;\r\n}\r\nout_be32(&xlb->master_pri_enable, 0xff);\r\nout_be32(&xlb->master_priority, 0x11111111);\r\nif ((mfspr(SPRN_SVR) & MPC5200_SVR_MASK) == MPC5200_SVR)\r\nout_be32(&xlb->config, in_be32(&xlb->config) | MPC52xx_XLB_CFG_PLDIS);\r\niounmap(xlb);\r\n}\r\nvoid __init\r\nmpc52xx_declare_of_platform_devices(void)\r\n{\r\nif (of_platform_bus_probe(NULL, mpc52xx_bus_ids, NULL))\r\nprintk(KERN_ERR __FILE__ ": "\r\n"Error while probing of_platform bus\n");\r\n}\r\nvoid __init\r\nmpc52xx_map_common_devices(void)\r\n{\r\nstruct device_node *np;\r\nfor_each_matching_node(np, mpc52xx_gpt_ids) {\r\nif (of_get_property(np, "fsl,has-wdt", NULL) ||\r\nof_get_property(np, "has-wdt", NULL)) {\r\nmpc52xx_wdt = of_iomap(np, 0);\r\nof_node_put(np);\r\nbreak;\r\n}\r\n}\r\nnp = of_find_matching_node(NULL, mpc52xx_cdm_ids);\r\nmpc52xx_cdm = of_iomap(np, 0);\r\nof_node_put(np);\r\nnp = of_find_matching_node(NULL, mpc52xx_gpio_simple);\r\nsimple_gpio = of_iomap(np, 0);\r\nof_node_put(np);\r\nnp = of_find_matching_node(NULL, mpc52xx_gpio_wkup);\r\nwkup_gpio = of_iomap(np, 0);\r\nof_node_put(np);\r\n}\r\nint mpc52xx_set_psc_clkdiv(int psc_id, int clkdiv)\r\n{\r\nunsigned long flags;\r\nu16 __iomem *reg;\r\nu32 val;\r\nu32 mask;\r\nu32 mclken_div;\r\nif (!mpc52xx_cdm)\r\nreturn -ENODEV;\r\nmclken_div = 0x8000 | (clkdiv & 0x1FF);\r\nswitch (psc_id) {\r\ncase 1: reg = &mpc52xx_cdm->mclken_div_psc1; mask = 0x20; break;\r\ncase 2: reg = &mpc52xx_cdm->mclken_div_psc2; mask = 0x40; break;\r\ncase 3: reg = &mpc52xx_cdm->mclken_div_psc3; mask = 0x80; break;\r\ncase 6: reg = &mpc52xx_cdm->mclken_div_psc6; mask = 0x10; break;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nspin_lock_irqsave(&mpc52xx_lock, flags);\r\nout_be16(reg, mclken_div);\r\nval = in_be32(&mpc52xx_cdm->clk_enables);\r\nout_be32(&mpc52xx_cdm->clk_enables, val | mask);\r\nspin_unlock_irqrestore(&mpc52xx_lock, flags);\r\nreturn 0;\r\n}\r\nunsigned int mpc52xx_get_xtal_freq(struct device_node *node)\r\n{\r\nu32 val;\r\nunsigned int freq;\r\nif (!mpc52xx_cdm)\r\nreturn 0;\r\nfreq = mpc5xxx_get_bus_frequency(node);\r\nif (!freq)\r\nreturn 0;\r\nif (in_8(&mpc52xx_cdm->ipb_clk_sel) & 0x1)\r\nfreq *= 2;\r\nval = in_be32(&mpc52xx_cdm->rstcfg);\r\nif (val & (1 << 5))\r\nfreq *= 8;\r\nelse\r\nfreq *= 4;\r\nif (val & (1 << 6))\r\nfreq /= 12;\r\nelse\r\nfreq /= 16;\r\nreturn freq;\r\n}\r\nvoid\r\nmpc52xx_restart(char *cmd)\r\n{\r\nlocal_irq_disable();\r\nif (mpc52xx_wdt) {\r\nout_be32(&mpc52xx_wdt->mode, 0x00000000);\r\nout_be32(&mpc52xx_wdt->count, 0x000000ff);\r\nout_be32(&mpc52xx_wdt->mode, 0x00009004);\r\n} else\r\nprintk(KERN_ERR __FILE__ ": "\r\n"mpc52xx_restart: Can't access wdt. "\r\n"Restart impossible, system halted.\n");\r\nwhile (1);\r\n}\r\nint mpc5200_psc_ac97_gpio_reset(int psc_number)\r\n{\r\nunsigned long flags;\r\nu32 gpio;\r\nu32 mux;\r\nint out;\r\nint reset;\r\nint sync;\r\nif ((!simple_gpio) || (!wkup_gpio))\r\nreturn -ENODEV;\r\nswitch (psc_number) {\r\ncase 0:\r\nreset = PSC1_RESET;\r\nsync = PSC1_SYNC;\r\nout = PSC1_SDATA_OUT;\r\ngpio = MPC52xx_GPIO_PSC1_MASK;\r\nbreak;\r\ncase 1:\r\nreset = PSC2_RESET;\r\nsync = PSC2_SYNC;\r\nout = PSC2_SDATA_OUT;\r\ngpio = MPC52xx_GPIO_PSC2_MASK;\r\nbreak;\r\ndefault:\r\npr_err(__FILE__ ": Unable to determine PSC, no ac97 "\r\n"cold-reset will be performed\n");\r\nreturn -ENODEV;\r\n}\r\nspin_lock_irqsave(&gpio_lock, flags);\r\nmux = in_be32(&simple_gpio->port_config);\r\nout_be32(&simple_gpio->port_config, mux & (~gpio));\r\nsetbits8(&wkup_gpio->wkup_gpioe, reset);\r\nsetbits32(&simple_gpio->simple_gpioe, sync | out);\r\nsetbits8(&wkup_gpio->wkup_ddr, reset);\r\nsetbits32(&simple_gpio->simple_ddr, sync | out);\r\nclrbits32(&simple_gpio->simple_dvo, sync | out);\r\nclrbits8(&wkup_gpio->wkup_dvo, reset);\r\nudelay(1);\r\nsetbits8(&wkup_gpio->wkup_dvo, reset);\r\n__delay(7);\r\nout_be32(&simple_gpio->port_config, mux);\r\nspin_unlock_irqrestore(&gpio_lock, flags);\r\nreturn 0;\r\n}

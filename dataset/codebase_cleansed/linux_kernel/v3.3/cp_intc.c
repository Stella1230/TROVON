static inline unsigned int cp_intc_read(unsigned offset)\r\n{\r\nreturn __raw_readl(davinci_intc_base + offset);\r\n}\r\nstatic inline void cp_intc_write(unsigned long value, unsigned offset)\r\n{\r\n__raw_writel(value, davinci_intc_base + offset);\r\n}\r\nstatic void cp_intc_ack_irq(struct irq_data *d)\r\n{\r\ncp_intc_write(d->irq, CP_INTC_SYS_STAT_IDX_CLR);\r\n}\r\nstatic void cp_intc_mask_irq(struct irq_data *d)\r\n{\r\ncp_intc_write(1, CP_INTC_HOST_ENABLE_IDX_CLR);\r\ncp_intc_write(d->irq, CP_INTC_SYS_ENABLE_IDX_CLR);\r\ncp_intc_write(1, CP_INTC_HOST_ENABLE_IDX_SET);\r\n}\r\nstatic void cp_intc_unmask_irq(struct irq_data *d)\r\n{\r\ncp_intc_write(d->irq, CP_INTC_SYS_ENABLE_IDX_SET);\r\n}\r\nstatic int cp_intc_set_irq_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nunsigned reg = BIT_WORD(d->irq);\r\nunsigned mask = BIT_MASK(d->irq);\r\nunsigned polarity = cp_intc_read(CP_INTC_SYS_POLARITY(reg));\r\nunsigned type = cp_intc_read(CP_INTC_SYS_TYPE(reg));\r\nswitch (flow_type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\npolarity |= mask;\r\ntype |= mask;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\npolarity &= ~mask;\r\ntype |= mask;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\npolarity |= mask;\r\ntype &= ~mask;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\npolarity &= ~mask;\r\ntype &= ~mask;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncp_intc_write(polarity, CP_INTC_SYS_POLARITY(reg));\r\ncp_intc_write(type, CP_INTC_SYS_TYPE(reg));\r\nreturn 0;\r\n}\r\nstatic int cp_intc_set_wake(struct irq_data *d, unsigned int on)\r\n{\r\nreturn 0;\r\n}\r\nvoid __init cp_intc_init(void)\r\n{\r\nunsigned long num_irq = davinci_soc_info.intc_irq_num;\r\nu8 *irq_prio = davinci_soc_info.intc_irq_prios;\r\nu32 *host_map = davinci_soc_info.intc_host_map;\r\nunsigned num_reg = BITS_TO_LONGS(num_irq);\r\nint i;\r\ndavinci_intc_type = DAVINCI_INTC_TYPE_CP_INTC;\r\ndavinci_intc_base = ioremap(davinci_soc_info.intc_base, SZ_8K);\r\nif (WARN_ON(!davinci_intc_base))\r\nreturn;\r\ncp_intc_write(0, CP_INTC_GLOBAL_ENABLE);\r\ncp_intc_write(0, CP_INTC_HOST_ENABLE(0));\r\nfor (i = 0; i < num_reg; i++)\r\ncp_intc_write(~0, CP_INTC_SYS_ENABLE_CLR(i));\r\ncp_intc_write(0, CP_INTC_CTRL);\r\ncp_intc_write(0, CP_INTC_HOST_CTRL);\r\nfor (i = 0; i < num_reg; i++)\r\ncp_intc_write(~0, CP_INTC_SYS_STAT_CLR(i));\r\ncp_intc_write(1, CP_INTC_HOST_ENABLE_IDX_SET);\r\nnum_reg = (num_irq + 3) >> 2;\r\nif (irq_prio) {\r\nunsigned j, k;\r\nu32 val;\r\nfor (k = i = 0; i < num_reg; i++) {\r\nfor (val = j = 0; j < 4; j++, k++) {\r\nval >>= 8;\r\nif (k < num_irq)\r\nval |= irq_prio[k] << 24;\r\n}\r\ncp_intc_write(val, CP_INTC_CHAN_MAP(i));\r\n}\r\n} else {\r\nfor (i = 0; i < num_reg; i++)\r\ncp_intc_write(0x0f0f0f0f, CP_INTC_CHAN_MAP(i));\r\n}\r\nif (host_map)\r\nfor (i = 0; host_map[i] != -1; i++)\r\ncp_intc_write(host_map[i], CP_INTC_HOST_MAP(i));\r\nfor (i = 0; i < num_irq; i++) {\r\nirq_set_chip(i, &cp_intc_irq_chip);\r\nset_irq_flags(i, IRQF_VALID | IRQF_PROBE);\r\nirq_set_handler(i, handle_edge_irq);\r\n}\r\ncp_intc_write(1, CP_INTC_GLOBAL_ENABLE);\r\n}

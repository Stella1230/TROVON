static int get_gpio_val(int rate)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(juli_rates); i++)\r\nif (juli_rates[i] == rate)\r\nreturn gpio_vals[i];\r\nreturn 0;\r\n}\r\nstatic void juli_ak4114_write(void *private_data, unsigned char reg,\r\nunsigned char val)\r\n{\r\nsnd_vt1724_write_i2c((struct snd_ice1712 *)private_data, AK4114_ADDR,\r\nreg, val);\r\n}\r\nstatic unsigned char juli_ak4114_read(void *private_data, unsigned char reg)\r\n{\r\nreturn snd_vt1724_read_i2c((struct snd_ice1712 *)private_data,\r\nAK4114_ADDR, reg);\r\n}\r\nstatic void juli_spdif_in_open(struct snd_ice1712 *ice,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct juli_spec *spec = ice->spec;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nint rate;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK ||\r\n!ice->is_spdif_master(ice))\r\nreturn;\r\nrate = snd_ak4114_external_rate(spec->ak4114);\r\nif (rate >= runtime->hw.rate_min && rate <= runtime->hw.rate_max) {\r\nruntime->hw.rate_min = rate;\r\nruntime->hw.rate_max = rate;\r\n}\r\n}\r\nstatic void juli_akm_lock(struct snd_akm4xxx *ak, int chip)\r\n{\r\n}\r\nstatic void juli_akm_unlock(struct snd_akm4xxx *ak, int chip)\r\n{\r\n}\r\nstatic void juli_akm_write(struct snd_akm4xxx *ak, int chip,\r\nunsigned char addr, unsigned char data)\r\n{\r\nstruct snd_ice1712 *ice = ak->private_data[0];\r\nif (snd_BUG_ON(chip))\r\nreturn;\r\nsnd_vt1724_write_i2c(ice, AK4358_ADDR, addr, data);\r\n}\r\nstatic void juli_akm_set_rate_val(struct snd_akm4xxx *ak, unsigned int rate)\r\n{\r\nunsigned char old, tmp, ak4358_dfs;\r\nunsigned int ak5385_pins, old_gpio, new_gpio;\r\nstruct snd_ice1712 *ice = ak->private_data[0];\r\nstruct juli_spec *spec = ice->spec;\r\nif (rate == 0)\r\nreturn;\r\nif (rate > 96000) {\r\nak4358_dfs = 2;\r\nak5385_pins = GPIO_AK5385A_DFS1 | GPIO_AK5385A_CKS0;\r\n} else if (rate > 48000) {\r\nak4358_dfs = 1;\r\nak5385_pins = GPIO_AK5385A_DFS0;\r\n} else {\r\nak4358_dfs = 0;\r\nak5385_pins = 0;\r\n}\r\nold_gpio = ice->gpio.get_data(ice);\r\nnew_gpio = (old_gpio & ~GPIO_AK5385A_MASK) | ak5385_pins;\r\nice->gpio.set_data(ice, new_gpio);\r\nold = inb(ICEMT1724(ice, AC97_CMD));\r\noutb(old | VT1724_AC97_COLD, ICEMT1724(ice, AC97_CMD));\r\nudelay(1);\r\noutb(old & ~VT1724_AC97_COLD, ICEMT1724(ice, AC97_CMD));\r\ntmp = snd_akm4xxx_get(ak, 0, 2);\r\nsnd_akm4xxx_reset(ak, 1);\r\ntmp = snd_akm4xxx_get(ak, 0, 2);\r\ntmp &= ~(0x03 << 4);\r\ntmp |= ak4358_dfs << 4;\r\nsnd_akm4xxx_set(ak, 0, 2, tmp);\r\nsnd_akm4xxx_reset(ak, 0);\r\nsnd_ak4114_reinit(spec->ak4114);\r\n}\r\nstatic int juli_mute_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned int val;\r\nval = ice->gpio.get_data(ice) & (unsigned int) kcontrol->private_value;\r\nif (kcontrol->private_value == GPIO_MUTE_CONTROL)\r\nucontrol->value.integer.value[0] = (val) ? 0 : 1;\r\nelse\r\nucontrol->value.integer.value[0] = (val) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int juli_mute_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned int old_gpio, new_gpio;\r\nold_gpio = ice->gpio.get_data(ice);\r\nif (ucontrol->value.integer.value[0]) {\r\nif (kcontrol->private_value == GPIO_MUTE_CONTROL) {\r\nnew_gpio = old_gpio & ~GPIO_MUTE_CONTROL;\r\nsnd_akm4xxx_write(ice->akm, 0, 0x01, 0x01);\r\n} else\r\nnew_gpio = old_gpio |\r\n(unsigned int) kcontrol->private_value;\r\n} else {\r\nif (kcontrol->private_value == GPIO_MUTE_CONTROL) {\r\nnew_gpio = old_gpio | GPIO_MUTE_CONTROL;\r\nsnd_akm4xxx_write(ice->akm, 0, 0x01, 0x03);\r\n} else\r\nnew_gpio = old_gpio &\r\n~((unsigned int) kcontrol->private_value);\r\n}\r\nif (old_gpio != new_gpio) {\r\nice->gpio.set_data(ice, new_gpio);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct snd_kcontrol __devinit *ctl_find(struct snd_card *card,\r\nconst char *name)\r\n{\r\nstruct snd_ctl_elem_id sid;\r\nmemset(&sid, 0, sizeof(sid));\r\nstrcpy(sid.name, name);\r\nsid.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nreturn snd_ctl_find_id(card, &sid);\r\n}\r\nstatic void __devinit add_slaves(struct snd_card *card,\r\nstruct snd_kcontrol *master, char **list)\r\n{\r\nfor (; *list; list++) {\r\nstruct snd_kcontrol *slave = ctl_find(card, *list);\r\nif (slave) {\r\nsnd_ctl_add_slave(master, slave);\r\n}\r\n}\r\n}\r\nstatic int __devinit juli_add_controls(struct snd_ice1712 *ice)\r\n{\r\nstruct juli_spec *spec = ice->spec;\r\nint err;\r\nunsigned int i;\r\nstruct snd_kcontrol *vmaster;\r\nerr = snd_ice1712_akm4xxx_build_controls(ice);\r\nif (err < 0)\r\nreturn err;\r\nfor (i = 0; i < ARRAY_SIZE(juli_mute_controls); i++) {\r\nerr = snd_ctl_add(ice->card,\r\nsnd_ctl_new1(&juli_mute_controls[i], ice));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nvmaster = snd_ctl_make_virtual_master("Master Playback Volume",\r\njuli_master_db_scale);\r\nif (!vmaster)\r\nreturn -ENOMEM;\r\nadd_slaves(ice->card, vmaster, slave_vols);\r\nerr = snd_ctl_add(ice->card, vmaster);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ak4114_build(spec->ak4114, NULL,\r\nice->pcm->streams[SNDRV_PCM_STREAM_CAPTURE].substream);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int juli_resume(struct snd_ice1712 *ice)\r\n{\r\nstruct snd_akm4xxx *ak = ice->akm;\r\nstruct juli_spec *spec = ice->spec;\r\nsnd_akm4xxx_reset(ak, 0);\r\nsnd_ak4114_reinit(spec->ak4114);\r\nreturn 0;\r\n}\r\nstatic int juli_suspend(struct snd_ice1712 *ice)\r\n{\r\nstruct snd_akm4xxx *ak = ice->akm;\r\nsnd_akm4xxx_reset(ak, 1);\r\nreturn 0;\r\n}\r\nstatic inline int juli_is_spdif_master(struct snd_ice1712 *ice)\r\n{\r\nreturn (ice->gpio.get_data(ice) & GPIO_INTERNAL_CLOCK) ? 0 : 1;\r\n}\r\nstatic unsigned int juli_get_rate(struct snd_ice1712 *ice)\r\n{\r\nint i;\r\nunsigned char result;\r\nresult = ice->gpio.get_data(ice) & GPIO_RATE_MASK;\r\nfor (i = 0; i < ARRAY_SIZE(gpio_vals); i++)\r\nif (gpio_vals[i] == result)\r\nreturn juli_rates[i];\r\nreturn 0;\r\n}\r\nstatic void juli_set_rate(struct snd_ice1712 *ice, unsigned int rate)\r\n{\r\nunsigned int old, new;\r\nunsigned char val;\r\nold = ice->gpio.get_data(ice);\r\nnew = (old & ~GPIO_RATE_MASK) | get_gpio_val(rate);\r\nice->gpio.set_data(ice, new);\r\nval = inb(ICEMT1724(ice, RATE));\r\noutb(val | VT1724_SPDIF_MASTER, ICEMT1724(ice, RATE));\r\n}\r\nstatic inline unsigned char juli_set_mclk(struct snd_ice1712 *ice,\r\nunsigned int rate)\r\n{\r\nreturn 0;\r\n}\r\nstatic int juli_set_spdif_clock(struct snd_ice1712 *ice, int type)\r\n{\r\nunsigned int old;\r\nold = ice->gpio.get_data(ice);\r\nice->gpio.set_data(ice, (old & ~GPIO_RATE_MASK) | GPIO_MULTI_1X |\r\nGPIO_FREQ_48KHZ);\r\nreturn 0;\r\n}\r\nstatic void juli_ak4114_change(struct ak4114 *ak4114, unsigned char c0,\r\nunsigned char c1)\r\n{\r\nstruct snd_ice1712 *ice = ak4114->change_callback_private;\r\nint rate;\r\nif (ice->is_spdif_master(ice) && c1) {\r\nrate = snd_ak4114_external_rate(ak4114);\r\njuli_akm_set_rate_val(ice->akm, rate);\r\n}\r\n}\r\nstatic int __devinit juli_init(struct snd_ice1712 *ice)\r\n{\r\nstatic const unsigned char ak4114_init_vals[] = {\r\nAK4114_RST | AK4114_PWN |\r\nAK4114_OCKS0 | AK4114_OCKS1,\r\nAK4114_DIF_I24I2S,\r\nAK4114_TX1E,\r\nAK4114_EFH_1024 | AK4114_DIT |\r\nAK4114_IPS(1),\r\n0,\r\n0\r\n};\r\nstatic const unsigned char ak4114_init_txcsb[] = {\r\n0x41, 0x02, 0x2c, 0x00, 0x00\r\n};\r\nint err;\r\nstruct juli_spec *spec;\r\nstruct snd_akm4xxx *ak;\r\nspec = kzalloc(sizeof(*spec), GFP_KERNEL);\r\nif (!spec)\r\nreturn -ENOMEM;\r\nice->spec = spec;\r\nerr = snd_ak4114_create(ice->card,\r\njuli_ak4114_read,\r\njuli_ak4114_write,\r\nak4114_init_vals, ak4114_init_txcsb,\r\nice, &spec->ak4114);\r\nif (err < 0)\r\nreturn err;\r\nspec->ak4114->change_callback = juli_ak4114_change;\r\nspec->ak4114->change_callback_private = ice;\r\nspec->ak4114->check_flags = 0;\r\n#if 0\r\nspec->analog = (ice->gpio.get_data(ice) & GPIO_ANALOG_PRESENT) ? 0 : 1;\r\n#else\r\nspec->analog = 1;\r\n#endif\r\nif (spec->analog) {\r\nprintk(KERN_INFO "juli@: analog I/O detected\n");\r\nice->num_total_dacs = 2;\r\nice->num_total_adcs = 2;\r\nice->akm = kzalloc(sizeof(struct snd_akm4xxx), GFP_KERNEL);\r\nak = ice->akm;\r\nif (!ak)\r\nreturn -ENOMEM;\r\nice->akm_codecs = 1;\r\nerr = snd_ice1712_akm4xxx_init(ak, &akm_juli_dac, NULL, ice);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nice->hw_rates = &juli_rates_info;\r\nice->is_spdif_master = juli_is_spdif_master;\r\nice->get_rate = juli_get_rate;\r\nice->set_rate = juli_set_rate;\r\nice->set_mclk = juli_set_mclk;\r\nice->set_spdif_clock = juli_set_spdif_clock;\r\nice->spdif.ops.open = juli_spdif_in_open;\r\n#ifdef CONFIG_PM\r\nice->pm_resume = juli_resume;\r\nice->pm_suspend = juli_suspend;\r\nice->pm_suspend_enabled = 1;\r\n#endif\r\nreturn 0;\r\n}

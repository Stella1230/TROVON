void\r\nsbecom_proc_brd_cleanup (ci_t * ci)\r\n{\r\nif (ci->dir_dev)\r\n{\r\nchar dir[7 + SBE_IFACETMPL_SIZE + 1];\r\nsnprintf(dir, sizeof(dir), "driver/%s", ci->devname);\r\nremove_proc_entry("info", ci->dir_dev);\r\nremove_proc_entry(dir, NULL);\r\nci->dir_dev = NULL;\r\n}\r\n}\r\nstatic int\r\nsbecom_proc_get_sbe_info (char *buffer, char **start, off_t offset,\r\nint length, int *eof, void *priv)\r\n{\r\nci_t *ci = (ci_t *) priv;\r\nint len = 0;\r\nchar *spd;\r\nstruct sbe_brd_info *bip;\r\nif (!(bip = OS_kmalloc (sizeof (struct sbe_brd_info))))\r\n{\r\nreturn -ENOMEM;\r\n}\r\n#if 0\r\npr_info(">> sbecom_proc_get_sbe_info: entered, offset %d. length %d.\n",\r\n(int) offset, (int) length);\r\n#endif\r\n{\r\nhdw_info_t *hi = &hdw_info[ci->brdno];\r\nu_int8_t *bsn = 0;\r\nswitch (hi->promfmt)\r\n{\r\ncase PROM_FORMAT_TYPE1:\r\nbsn = (u_int8_t *) hi->mfg_info.pft1.Serial;\r\nbreak;\r\ncase PROM_FORMAT_TYPE2:\r\nbsn = (u_int8_t *) hi->mfg_info.pft2.Serial;\r\nbreak;\r\n}\r\nsbecom_get_brdinfo (ci, bip, bsn);\r\n}\r\n#if 0\r\npr_info(">> sbecom_get_brdinfo: returned, first_if %p <%s> last_if %p <%s>\n",\r\n(char *) &bip->first_iname, (char *) &bip->first_iname,\r\n(char *) &bip->last_iname, (char *) &bip->last_iname);\r\n#endif\r\nlen += sprintf (buffer + len, "Board Type: ");\r\nswitch (bip->brd_id)\r\n{\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C1T3):\r\nlen += sprintf (buffer + len, "wanPMC-C1T3");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPTMC_256T3_E1):\r\nlen += sprintf (buffer + len, "wanPTMC-256T3 <E1>");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPTMC_256T3_T1):\r\nlen += sprintf (buffer + len, "wanPTMC-256T3 <T1>");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPTMC_C24TE1):\r\nlen += sprintf (buffer + len, "wanPTMC-C24TE1");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C4T1E1):\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C4T1E1_L):\r\nlen += sprintf (buffer + len, "wanPMC-C4T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C2T1E1):\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C2T1E1_L):\r\nlen += sprintf (buffer + len, "wanPMC-C2T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C1T1E1):\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C1T1E1_L):\r\nlen += sprintf (buffer + len, "wanPMC-C1T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPCI_C4T1E1):\r\nlen += sprintf (buffer + len, "wanPCI-C4T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPCI_C2T1E1):\r\nlen += sprintf (buffer + len, "wanPCI-C2T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID (PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPCI_C1T1E1):\r\nlen += sprintf (buffer + len, "wanPCI-C1T1E1");\r\nbreak;\r\ndefault:\r\nlen += sprintf (buffer + len, "unknown");\r\nbreak;\r\n}\r\nlen += sprintf (buffer + len, " [%08X]\n", bip->brd_id);\r\nlen += sprintf (buffer + len, "Board Number: %d\n", bip->brdno);\r\nlen += sprintf (buffer + len, "Hardware ID: 0x%02X\n", ci->hdw_bid);\r\nlen += sprintf (buffer + len, "Board SN: %06X\n", bip->brd_sn);\r\nlen += sprintf(buffer + len, "Board MAC: %pMF\n",\r\nbip->brd_mac_addr);\r\nlen += sprintf (buffer + len, "Ports: %d\n", ci->max_port);\r\nlen += sprintf (buffer + len, "Channels: %d\n", bip->brd_chan_cnt);\r\n#if 1\r\nlen += sprintf (buffer + len, "Interface: %s -> %s\n",\r\n(char *) &bip->first_iname, (char *) &bip->last_iname);\r\n#else\r\nlen += sprintf (buffer + len, "Interface: <not available> 1st %p lst %p\n",\r\n(char *) &bip->first_iname, (char *) &bip->last_iname);\r\n#endif\r\nswitch (bip->brd_pci_speed)\r\n{\r\ncase BINFO_PCI_SPEED_33:\r\nspd = "33Mhz";\r\nbreak;\r\ncase BINFO_PCI_SPEED_66:\r\nspd = "66Mhz";\r\nbreak;\r\ndefault:\r\nspd = "<not available>";\r\nbreak;\r\n}\r\nlen += sprintf (buffer + len, "PCI Bus Speed: %s\n", spd);\r\nlen += sprintf (buffer + len, "Release: %s\n", ci->release);\r\n#ifdef SBE_PMCC4_ENABLE\r\n{\r\nextern int cxt1e1_max_mru;\r\n#if 0\r\nextern int max_chans_used;\r\nextern int cxt1e1_max_mtu;\r\n#endif\r\nextern int max_rxdesc_used, max_txdesc_used;\r\nlen += sprintf (buffer + len, "\ncxt1e1_max_mru: %d\n", cxt1e1_max_mru);\r\n#if 0\r\nlen += sprintf (buffer + len, "\nmax_chans_used: %d\n", max_chans_used);\r\nlen += sprintf (buffer + len, "cxt1e1_max_mtu: %d\n", cxt1e1_max_mtu);\r\n#endif\r\nlen += sprintf (buffer + len, "max_rxdesc_used: %d\n", max_rxdesc_used);\r\nlen += sprintf (buffer + len, "max_txdesc_used: %d\n", max_txdesc_used);\r\n}\r\n#endif\r\nOS_kfree (bip);\r\n#if 1\r\n*eof = 1;\r\n#endif\r\n#if 0\r\nif (len <= offset + length)\r\n*eof = 1;\r\n*start = buffer + offset;\r\nlen -= offset;\r\nif (len > length)\r\nlen = length;\r\nif (len < 0)\r\nlen = 0;\r\n#endif\r\n#if 0\r\n{\r\noff_t begin = 0;\r\nint size = 0;\r\noff_t pos = 0;\r\nsize = len;\r\npos = begin + size;\r\nif (pos < offset)\r\n{\r\nlen = 0;\r\nbegin = pos;\r\n}\r\n*start = buffer + (offset - begin);\r\nlen -= (offset - begin);\r\nif (len > length)\r\nlen = length;\r\n}\r\n#endif\r\n#if 0\r\nlen = strlen (buffer);\r\n*start = NULL;\r\nif (offset + length >= len)\r\n*eof = 1;\r\nelse\r\n*eof = 0;\r\n#endif\r\n#if 0\r\npr_info(">> proc_fs: returned len = %d., start %p\n", len, start);\r\n#endif\r\nreturn len;\r\n}\r\nint __init\r\nsbecom_proc_brd_init (ci_t * ci)\r\n{\r\nstruct proc_dir_entry *e;\r\nchar dir[7 + SBE_IFACETMPL_SIZE + 1];\r\nsnprintf(dir, sizeof(dir), "driver/%s", ci->devname);\r\nci->dir_dev = proc_mkdir(dir, NULL);\r\nif (!ci->dir_dev)\r\n{\r\npr_err("Unable to create directory /proc/driver/%s\n", ci->devname);\r\ngoto fail;\r\n}\r\ne = create_proc_read_entry ("info", S_IFREG | S_IRUGO,\r\nci->dir_dev, sbecom_proc_get_sbe_info, ci);\r\nif (!e)\r\n{\r\npr_err("Unable to create entry /proc/driver/%s/info\n", ci->devname);\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nsbecom_proc_brd_cleanup (ci);\r\nreturn 1;\r\n}\r\nvoid\r\nsbecom_proc_brd_cleanup (ci_t * ci)\r\n{\r\n}\r\nint __init\r\nsbecom_proc_brd_init (ci_t * ci)\r\n{\r\nreturn 0;\r\n}

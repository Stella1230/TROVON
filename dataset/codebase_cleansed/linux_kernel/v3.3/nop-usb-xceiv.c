void usb_nop_xceiv_register(void)\r\n{\r\nif (pd)\r\nreturn;\r\npd = platform_device_register_simple("nop_usb_xceiv", -1, NULL, 0);\r\nif (!pd) {\r\nprintk(KERN_ERR "Unable to register usb nop transceiver\n");\r\nreturn;\r\n}\r\n}\r\nvoid usb_nop_xceiv_unregister(void)\r\n{\r\nplatform_device_unregister(pd);\r\npd = NULL;\r\n}\r\nstatic inline struct nop_usb_xceiv *xceiv_to_nop(struct otg_transceiver *x)\r\n{\r\nreturn container_of(x, struct nop_usb_xceiv, otg);\r\n}\r\nstatic int nop_set_suspend(struct otg_transceiver *x, int suspend)\r\n{\r\nreturn 0;\r\n}\r\nstatic int nop_set_peripheral(struct otg_transceiver *x,\r\nstruct usb_gadget *gadget)\r\n{\r\nstruct nop_usb_xceiv *nop;\r\nif (!x)\r\nreturn -ENODEV;\r\nnop = xceiv_to_nop(x);\r\nif (!gadget) {\r\nnop->otg.gadget = NULL;\r\nreturn -ENODEV;\r\n}\r\nnop->otg.gadget = gadget;\r\nnop->otg.state = OTG_STATE_B_IDLE;\r\nreturn 0;\r\n}\r\nstatic int nop_set_host(struct otg_transceiver *x, struct usb_bus *host)\r\n{\r\nstruct nop_usb_xceiv *nop;\r\nif (!x)\r\nreturn -ENODEV;\r\nnop = xceiv_to_nop(x);\r\nif (!host) {\r\nnop->otg.host = NULL;\r\nreturn -ENODEV;\r\n}\r\nnop->otg.host = host;\r\nreturn 0;\r\n}\r\nstatic int __devinit nop_usb_xceiv_probe(struct platform_device *pdev)\r\n{\r\nstruct nop_usb_xceiv *nop;\r\nint err;\r\nnop = kzalloc(sizeof *nop, GFP_KERNEL);\r\nif (!nop)\r\nreturn -ENOMEM;\r\nnop->dev = &pdev->dev;\r\nnop->otg.dev = nop->dev;\r\nnop->otg.label = "nop-xceiv";\r\nnop->otg.state = OTG_STATE_UNDEFINED;\r\nnop->otg.set_host = nop_set_host;\r\nnop->otg.set_peripheral = nop_set_peripheral;\r\nnop->otg.set_suspend = nop_set_suspend;\r\nerr = otg_set_transceiver(&nop->otg);\r\nif (err) {\r\ndev_err(&pdev->dev, "can't register transceiver, err: %d\n",\r\nerr);\r\ngoto exit;\r\n}\r\nplatform_set_drvdata(pdev, nop);\r\nATOMIC_INIT_NOTIFIER_HEAD(&nop->otg.notifier);\r\nreturn 0;\r\nexit:\r\nkfree(nop);\r\nreturn err;\r\n}\r\nstatic int __devexit nop_usb_xceiv_remove(struct platform_device *pdev)\r\n{\r\nstruct nop_usb_xceiv *nop = platform_get_drvdata(pdev);\r\notg_set_transceiver(NULL);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(nop);\r\nreturn 0;\r\n}\r\nstatic int __init nop_usb_xceiv_init(void)\r\n{\r\nreturn platform_driver_register(&nop_usb_xceiv_driver);\r\n}\r\nstatic void __exit nop_usb_xceiv_exit(void)\r\n{\r\nplatform_driver_unregister(&nop_usb_xceiv_driver);\r\n}

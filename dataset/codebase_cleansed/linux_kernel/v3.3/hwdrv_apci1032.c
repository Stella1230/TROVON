int i_APCI1032_ConfigDigitalInput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ui_TmpValue;\r\nunsigned int ul_Command1 = 0;\r\nunsigned int ul_Command2 = 0;\r\ndevpriv->tsk_Current = current;\r\nif (data[0] == ADDIDATA_ENABLE) {\r\nul_Command1 = ul_Command1 | data[2];\r\nul_Command2 = ul_Command2 | data[3];\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_MODE1);\r\noutl(ul_Command2,\r\ndevpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_MODE2);\r\nif (data[1] == ADDIDATA_OR) {\r\noutl(0x4, devpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\nui_TmpValue =\r\ninl(devpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\n}\r\nelse\r\noutl(0x6, devpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\n}\r\nelse {\r\nul_Command1 = ul_Command1 & 0xFFFF0000;\r\nul_Command2 = ul_Command2 & 0xFFFF0000;\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_MODE1);\r\noutl(ul_Command2,\r\ndevpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_MODE2);\r\noutl(0x0, devpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI1032_Read1DigitalInput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ui_TmpValue = 0;\r\nunsigned int ui_Channel;\r\nui_Channel = CR_CHAN(insn->chanspec);\r\nif (ui_Channel <= 31) {\r\nui_TmpValue = (unsigned int) inl(devpriv->iobase + APCI1032_DIGITAL_IP);\r\n*data = (ui_TmpValue >> ui_Channel) & 0x1;\r\n}\r\nelse {\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI1032_ReadMoreDigitalInput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ui_PortValue = data[0];\r\nunsigned int ui_Mask = 0;\r\nunsigned int ui_NoOfChannels;\r\nui_NoOfChannels = CR_CHAN(insn->chanspec);\r\nif (data[1] == 0) {\r\n*data = (unsigned int) inl(devpriv->iobase + APCI1032_DIGITAL_IP);\r\nswitch (ui_NoOfChannels) {\r\ncase 2:\r\nui_Mask = 3;\r\n*data = (*data >> (2 * ui_PortValue)) & ui_Mask;\r\nbreak;\r\ncase 4:\r\nui_Mask = 15;\r\n*data = (*data >> (4 * ui_PortValue)) & ui_Mask;\r\nbreak;\r\ncase 8:\r\nui_Mask = 255;\r\n*data = (*data >> (8 * ui_PortValue)) & ui_Mask;\r\nbreak;\r\ncase 16:\r\nui_Mask = 65535;\r\n*data = (*data >> (16 * ui_PortValue)) & ui_Mask;\r\nbreak;\r\ncase 31:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\n}\r\nelse {\r\nif (data[1] == 1)\r\n*data = ui_InterruptStatus;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic void v_APCI1032_Interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nunsigned int ui_Temp;\r\nui_Temp = inl(devpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\noutl(ui_Temp & APCI1032_DIGITAL_IP_INTERRUPT_DISABLE,\r\ndevpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\nui_InterruptStatus =\r\ninl(devpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_STATUS);\r\nui_InterruptStatus = ui_InterruptStatus & 0X0000FFFF;\r\nsend_sig(SIGIO, devpriv->tsk_Current, 0);\r\noutl(ui_Temp, devpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\nreturn;\r\n}\r\nint i_APCI1032_Reset(struct comedi_device *dev)\r\n{\r\noutl(0x0, devpriv->iobase + APCI1032_DIGITAL_IP_IRQ);\r\ninl(devpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_STATUS);\r\noutl(0x0, devpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_MODE1);\r\noutl(0x0, devpriv->iobase + APCI1032_DIGITAL_IP_INTERRUPT_MODE2);\r\nreturn 0;\r\n}

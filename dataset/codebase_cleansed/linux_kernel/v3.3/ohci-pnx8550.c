static void pnx8550_start_hc(struct platform_device *dev)\r\n{\r\noutl(0x00000003, PCI_BASE | 0x0004770c);\r\noutl(0x00000003, PCI_BASE | 0x00047710);\r\nudelay(100);\r\n}\r\nstatic void pnx8550_stop_hc(struct platform_device *dev)\r\n{\r\nudelay(10);\r\n}\r\nint usb_hcd_pnx8550_probe (const struct hc_driver *driver,\r\nstruct platform_device *dev)\r\n{\r\nint retval;\r\nstruct usb_hcd *hcd;\r\nif (dev->resource[0].flags != IORESOURCE_MEM ||\r\ndev->resource[1].flags != IORESOURCE_IRQ) {\r\ndev_err (&dev->dev,"invalid resource type\n");\r\nreturn -ENOMEM;\r\n}\r\nhcd = usb_create_hcd (driver, &dev->dev, "pnx8550");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = dev->resource[0].start;\r\nhcd->rsrc_len = dev->resource[0].end - dev->resource[0].start + 1;\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\ndev_err(&dev->dev, "request_mem_region [0x%08llx, 0x%08llx] "\r\n"failed\n", hcd->rsrc_start, hcd->rsrc_len);\r\nretval = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\ndev_err(&dev->dev, "ioremap [[0x%08llx, 0x%08llx] failed\n",\r\nhcd->rsrc_start, hcd->rsrc_len);\r\nretval = -ENOMEM;\r\ngoto err2;\r\n}\r\npnx8550_start_hc(dev);\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nretval = usb_add_hcd(hcd, dev->resource[1].start, 0);\r\nif (retval == 0)\r\nreturn retval;\r\npnx8550_stop_hc(dev);\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn retval;\r\n}\r\nvoid usb_hcd_pnx8550_remove (struct usb_hcd *hcd, struct platform_device *dev)\r\n{\r\nusb_remove_hcd(hcd);\r\npnx8550_stop_hc(dev);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\n}\r\nstatic int __devinit\r\nohci_pnx8550_start (struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci (hcd);\r\nint ret;\r\nohci_dbg (ohci, "ohci_pnx8550_start, ohci:%p", ohci);\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nif ((ret = ohci_run (ohci)) < 0) {\r\nerr ("can't start %s", hcd->self.bus_name);\r\nohci_stop (hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_pnx8550_drv_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nret = usb_hcd_pnx8550_probe(&ohci_pnx8550_hc_driver, pdev);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_pnx8550_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_hcd_pnx8550_remove(hcd, pdev);\r\nreturn 0;\r\n}

static inline void dmabrg_call_handler(int i)\r\n{\r\ndmabrg_handlers[i].handler(dmabrg_handlers[i].data);\r\n}\r\nstatic irqreturn_t dmabrg_irq(int irq, void *data)\r\n{\r\nunsigned long dcr;\r\nunsigned int i;\r\ndcr = __raw_readl(DMABRGCR);\r\n__raw_writel(dcr & ~0x00ff0003, DMABRGCR);\r\ndcr &= dcr >> 8;\r\nif (dcr & 1)\r\ndmabrg_call_handler(DMABRGIRQ_USBDMA);\r\nif (dcr & 2)\r\ndmabrg_call_handler(DMABRGIRQ_USBDMAERR);\r\ndcr >>= 16;\r\nwhile (dcr) {\r\ni = __ffs(dcr);\r\ndcr &= dcr - 1;\r\ndmabrg_call_handler(i + DMABRGIRQ_A0TXF);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void dmabrg_disable_irq(unsigned int dmairq)\r\n{\r\nunsigned long dcr;\r\ndcr = __raw_readl(DMABRGCR);\r\ndcr &= ~(1 << ((dmairq > 1) ? dmairq + 22 : dmairq + 8));\r\n__raw_writel(dcr, DMABRGCR);\r\n}\r\nstatic void dmabrg_enable_irq(unsigned int dmairq)\r\n{\r\nunsigned long dcr;\r\ndcr = __raw_readl(DMABRGCR);\r\ndcr |= (1 << ((dmairq > 1) ? dmairq + 22 : dmairq + 8));\r\n__raw_writel(dcr, DMABRGCR);\r\n}\r\nint dmabrg_request_irq(unsigned int dmairq, void(*handler)(void*),\r\nvoid *data)\r\n{\r\nif ((dmairq > 9) || !handler)\r\nreturn -ENOENT;\r\nif (dmabrg_handlers[dmairq].handler)\r\nreturn -EBUSY;\r\ndmabrg_handlers[dmairq].handler = handler;\r\ndmabrg_handlers[dmairq].data = data;\r\ndmabrg_enable_irq(dmairq);\r\nreturn 0;\r\n}\r\nvoid dmabrg_free_irq(unsigned int dmairq)\r\n{\r\nif (likely(dmairq < 10)) {\r\ndmabrg_disable_irq(dmairq);\r\ndmabrg_handlers[dmairq].handler = NULL;\r\ndmabrg_handlers[dmairq].data = NULL;\r\n}\r\n}\r\nstatic int __init dmabrg_init(void)\r\n{\r\nunsigned long or;\r\nint ret;\r\ndmabrg_handlers = kzalloc(10 * sizeof(struct dmabrg_handler),\r\nGFP_KERNEL);\r\nif (!dmabrg_handlers)\r\nreturn -ENOMEM;\r\n#ifdef CONFIG_SH_DMA\r\nret = request_dma(0, "DMAC 0 (DMABRG)");\r\nif (ret < 0)\r\nprintk(KERN_INFO "DMABRG: DMAC ch0 not reserved!\n");\r\n#endif\r\n__raw_writel(0, DMABRGCR);\r\n__raw_writel(0, DMACHCR0);\r\n__raw_writel(0x94000000, DMARSRA);\r\nor = __raw_readl(DMAOR);\r\n__raw_writel(or | DMAOR_BRG | DMAOR_DMEN, DMAOR);\r\nret = request_irq(DMABRGI0, dmabrg_irq, 0,\r\n"DMABRG USB address error", NULL);\r\nif (ret)\r\ngoto out0;\r\nret = request_irq(DMABRGI1, dmabrg_irq, 0,\r\n"DMABRG Transfer End", NULL);\r\nif (ret)\r\ngoto out1;\r\nret = request_irq(DMABRGI2, dmabrg_irq, 0,\r\n"DMABRG Transfer Half", NULL);\r\nif (ret == 0)\r\nreturn ret;\r\nfree_irq(DMABRGI1, 0);\r\nout1: free_irq(DMABRGI0, 0);\r\nout0: kfree(dmabrg_handlers);\r\nreturn ret;\r\n}

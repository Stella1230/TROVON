int mg_check_int_error(struct rts51x_chip *chip)\r\n{\r\nu8 value;\r\nrts51x_read_register(chip, MS_TRANS_CFG, &value);\r\nif (value & (INT_ERR | INT_CMDNK))\r\nTRACE_RET(chip, STATUS_FAIL);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int mg_send_ex_cmd(struct rts51x_chip *chip, u8 cmd, u8 entry_num)\r\n{\r\nint retval, i;\r\nu8 data[8];\r\ndata[0] = cmd;\r\ndata[1] = 0;\r\ndata[2] = 0;\r\ndata[3] = 0;\r\ndata[4] = 0;\r\ndata[5] = 0;\r\ndata[6] = entry_num;\r\ndata[7] = 0;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval =\r\nms_write_bytes(chip, PRO_EX_SET_CMD, 7, WAIT_INT, data, 8);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_set_tpc_para_sub(struct rts51x_chip *chip, int type, u8 mg_entry_num)\r\n{\r\nint retval;\r\nu8 buf[6];\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nif (type == 0)\r\nretval = ms_set_rw_reg_addr(chip, 0, 0, Pro_TPCParm, 1);\r\nelse\r\nretval = ms_set_rw_reg_addr(chip, 0, 0, Pro_DataCount1, 6);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nbuf[0] = 0;\r\nbuf[1] = 0;\r\nif (type == 1) {\r\nbuf[2] = 0;\r\nbuf[3] = 0;\r\nbuf[4] = 0;\r\nbuf[5] = mg_entry_num;\r\n}\r\nretval =\r\nms_write_bytes(chip, PRO_WRITE_REG, (type == 0) ? 1 : 6,\r\nNO_WAIT_INT, buf, 6);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_set_leaf_id(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint retval;\r\nint i;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf1[32], buf2[12];\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nif (scsi_bufflen(srb) < 12) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nretval = mg_send_ex_cmd(chip, MG_SET_LID, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nTRACE_RET(chip, retval);\r\n}\r\nmemset(buf1, 0, 32);\r\nrts51x_get_xfer_buf(buf2, min(12, (int)scsi_bufflen(srb)), srb);\r\nfor (i = 0; i < 8; i++)\r\nbuf1[8 + i] = buf2[4 + i];\r\nretval =\r\nms_write_bytes(chip, PRO_WRITE_SHORT_DATA, 32, WAIT_INT, buf1, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nTRACE_RET(chip, retval);\r\n}\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nTRACE_RET(chip, retval);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_get_local_EKB(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint retval = STATUS_FAIL;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 *buf = NULL;\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nbuf = kmalloc(1540, GFP_KERNEL);\r\nif (!buf)\r\nTRACE_RET(chip, STATUS_NOMEM);\r\nbuf[0] = 0x04;\r\nbuf[1] = 0x1A;\r\nbuf[2] = 0x00;\r\nbuf[3] = 0x00;\r\nretval = mg_send_ex_cmd(chip, MG_GET_LEKB, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_GOTO(chip, GetEKBFinish);\r\n}\r\nretval = ms_transfer_data(chip, MS_TM_AUTO_READ, PRO_READ_LONG_DATA,\r\n3, WAIT_INT, 0, 0, buf + 4, 1536);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrts51x_write_register(chip, CARD_STOP, MS_STOP | MS_CLR_ERR,\r\nMS_STOP | MS_CLR_ERR);\r\nTRACE_GOTO(chip, GetEKBFinish);\r\n}\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_GOTO(chip, GetEKBFinish);\r\n}\r\nbufflen = min(1052, (int)scsi_bufflen(srb));\r\nrts51x_set_xfer_buf(buf, bufflen, srb);\r\nGetEKBFinish:\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nint mg_chg(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint bufflen;\r\nint i;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf[32], tmp;\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nretval = mg_send_ex_cmd(chip, MG_GET_ID, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, retval);\r\n}\r\nretval =\r\nms_read_bytes(chip, PRO_READ_SHORT_DATA, 32, WAIT_INT, buf, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, retval);\r\n}\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, retval);\r\n}\r\nmemcpy(ms_card->magic_gate_id, buf, 16);\r\nfor (i = 0; i < 2500; i++) {\r\nRTS51X_READ_REG(chip, MS_TRANS_CFG, &tmp);\r\nif (tmp &\r\n(MS_INT_CED | MS_INT_CMDNK | MS_INT_BREQ | MS_INT_ERR))\r\nbreak;\r\nwait_timeout(1);\r\n}\r\nif (i == 2500) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nretval = mg_send_ex_cmd(chip, MG_SET_RD, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, retval);\r\n}\r\nbufflen = min(12, (int)scsi_bufflen(srb));\r\nrts51x_get_xfer_buf(buf, bufflen, srb);\r\nfor (i = 0; i < 8; i++)\r\nbuf[i] = buf[4 + i];\r\nfor (i = 0; i < 24; i++)\r\nbuf[8 + i] = 0;\r\nretval =\r\nms_write_bytes(chip, PRO_WRITE_SHORT_DATA, 32, WAIT_INT, buf, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, retval);\r\n}\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, retval);\r\n}\r\nms_card->mg_auth = 0;\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_get_rsp_chg(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf1[32], buf2[36], tmp;\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nretval = mg_send_ex_cmd(chip, MG_MAKE_RMS, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_RET(chip, retval);\r\n}\r\nretval =\r\nms_read_bytes(chip, PRO_READ_SHORT_DATA, 32, WAIT_INT, buf1, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_RET(chip, retval);\r\n}\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_RET(chip, retval);\r\n}\r\nbuf2[0] = 0x00;\r\nbuf2[1] = 0x22;\r\nbuf2[2] = 0x00;\r\nbuf2[3] = 0x00;\r\nmemcpy(buf2 + 4, ms_card->magic_gate_id, 16);\r\nmemcpy(buf2 + 20, buf1, 16);\r\nbufflen = min(36, (int)scsi_bufflen(srb));\r\nrts51x_set_xfer_buf(buf2, bufflen, srb);\r\nfor (i = 0; i < 2500; i++) {\r\nRTS51X_READ_REG(chip, MS_TRANS_CFG, &tmp);\r\nif (tmp & (MS_INT_CED | MS_INT_CMDNK |\r\nMS_INT_BREQ | MS_INT_ERR))\r\nbreak;\r\nwait_timeout(1);\r\n}\r\nif (i == 2500) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_rsp(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint i;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf[32];\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nretval = mg_send_ex_cmd(chip, MG_MAKE_KSE, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_RET(chip, retval);\r\n}\r\nbufflen = min(12, (int)scsi_bufflen(srb));\r\nrts51x_get_xfer_buf(buf, bufflen, srb);\r\nfor (i = 0; i < 8; i++)\r\nbuf[i] = buf[4 + i];\r\nfor (i = 0; i < 24; i++)\r\nbuf[8 + i] = 0;\r\nretval =\r\nms_write_bytes(chip, PRO_WRITE_SHORT_DATA, 32, WAIT_INT, buf, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_RET(chip, retval);\r\n}\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nTRACE_RET(chip, retval);\r\n}\r\nms_card->mg_auth = 1;\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_get_ICV(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 *buf = NULL;\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nbuf = kmalloc(1028, GFP_KERNEL);\r\nif (!buf)\r\nTRACE_RET(chip, STATUS_NOMEM);\r\nbuf[0] = 0x04;\r\nbuf[1] = 0x02;\r\nbuf[2] = 0x00;\r\nbuf[3] = 0x00;\r\nretval = mg_send_ex_cmd(chip, MG_GET_IBD, ms_card->mg_entry_num);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_GOTO(chip, GetICVFinish);\r\n}\r\nretval = ms_transfer_data(chip, MS_TM_AUTO_READ, PRO_READ_LONG_DATA,\r\n2, WAIT_INT, 0, 0, buf + 4, 1024);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrts51x_write_register(chip, CARD_STOP, MS_STOP | MS_CLR_ERR,\r\nMS_STOP | MS_CLR_ERR);\r\nTRACE_GOTO(chip, GetICVFinish);\r\n}\r\nretval = mg_check_int_error(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_GOTO(chip, GetICVFinish);\r\n}\r\nbufflen = min(1028, (int)scsi_bufflen(srb));\r\nrts51x_set_xfer_buf(buf, bufflen, srb);\r\nGetICVFinish:\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nint mg_set_ICV(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint bufflen;\r\n#ifdef MG_SET_ICV_SLOW\r\nint i;\r\n#endif\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 *buf = NULL;\r\nRTS51X_DEBUGP("--%s--\n", __func__);\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nbuf = kmalloc(1028, GFP_KERNEL);\r\nif (!buf)\r\nTRACE_RET(chip, STATUS_NOMEM);\r\nbufflen = min(1028, (int)scsi_bufflen(srb));\r\nrts51x_get_xfer_buf(buf, bufflen, srb);\r\nretval = mg_send_ex_cmd(chip, MG_SET_IBD, ms_card->mg_entry_num);\r\nif (retval != STATUS_SUCCESS) {\r\nif (ms_card->mg_auth == 0) {\r\nif ((buf[5] & 0xC0) != 0)\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nelse\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n} else {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_WRITE_ERR);\r\n}\r\nTRACE_GOTO(chip, SetICVFinish);\r\n}\r\n#ifdef MG_SET_ICV_SLOW\r\nfor (i = 0; i < 2; i++) {\r\nudelay(50);\r\nrts51x_init_cmd(chip);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, MS_TPC, 0xFF,\r\nPRO_WRITE_LONG_DATA);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG, 0xFF,\r\nWAIT_INT);\r\ntrans_dma_enable(DMA_TO_DEVICE, chip, 512, DMA_512);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, MS_TRANSFER, 0xFF,\r\nMS_TRANSFER_START | MS_TM_NORMAL_WRITE);\r\nrts51x_add_cmd(chip, CHECK_REG_CMD, MS_TRANSFER,\r\nMS_TRANSFER_END, MS_TRANSFER_END);\r\nretval = rts51x_send_cmd(chip, MODE_CDOR, 100);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_WRITE_ERR);\r\nTRACE_GOTO(chip, SetICVFinish);\r\n}\r\nretval = rts51x_transfer_data_rcc(chip, SND_BULK_PIPE(chip),\r\nbuf + 4 + i * 512, 512, 0,\r\nNULL, 3000, STAGE_DO);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_clear_ms_error(chip);\r\nif (ms_card->mg_auth == 0) {\r\nif ((buf[5] & 0xC0) != 0)\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nelse\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n} else {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n}\r\nretval = STATUS_FAIL;\r\nTRACE_GOTO(chip, SetICVFinish);\r\n}\r\nretval = rts51x_get_rsp(chip, 1, 3000);\r\nif (CHECK_MS_TRANS_FAIL(chip, retval)\r\n|| mg_check_int_error(chip)) {\r\nrts51x_clear_ms_error(chip);\r\nif (ms_card->mg_auth == 0) {\r\nif ((buf[5] & 0xC0) != 0)\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nelse\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n} else {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n}\r\nretval = STATUS_FAIL;\r\nTRACE_GOTO(chip, SetICVFinish);\r\n}\r\n}\r\n#else\r\nretval = ms_transfer_data(chip, MS_TM_AUTO_WRITE, PRO_WRITE_LONG_DATA,\r\n2, WAIT_INT, 0, 0, buf + 4, 1024);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_clear_ms_error(chip);\r\nif (ms_card->mg_auth == 0) {\r\nif ((buf[5] & 0xC0) != 0)\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nelse\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n} else {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_WRITE_ERR);\r\n}\r\nTRACE_GOTO(chip, SetICVFinish);\r\n}\r\n#endif\r\nSetICVFinish:\r\nkfree(buf);\r\nreturn retval;\r\n}

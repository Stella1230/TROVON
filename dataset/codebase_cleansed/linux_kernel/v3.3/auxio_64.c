static void __auxio_rmw(u8 bits_on, u8 bits_off, int ebus)\r\n{\r\nif (auxio_register) {\r\nunsigned long flags;\r\nu8 regval, newval;\r\nspin_lock_irqsave(&auxio_lock, flags);\r\nregval = (ebus ?\r\n(u8) readl(auxio_register) :\r\nsbus_readb(auxio_register));\r\nnewval = regval | bits_on;\r\nnewval &= ~bits_off;\r\nif (!ebus)\r\nnewval &= ~AUXIO_AUX1_MASK;\r\nif (ebus)\r\nwritel((u32) newval, auxio_register);\r\nelse\r\nsbus_writeb(newval, auxio_register);\r\nspin_unlock_irqrestore(&auxio_lock, flags);\r\n}\r\n}\r\nstatic void __auxio_set_bit(u8 bit, int on, int ebus)\r\n{\r\nu8 bits_on = (ebus ? AUXIO_PCIO_LED : AUXIO_AUX1_LED);\r\nu8 bits_off = 0;\r\nif (!on) {\r\nu8 tmp = bits_off;\r\nbits_off = bits_on;\r\nbits_on = tmp;\r\n}\r\n__auxio_rmw(bits_on, bits_off, ebus);\r\n}\r\nvoid auxio_set_led(int on)\r\n{\r\nint ebus = auxio_devtype == AUXIO_TYPE_EBUS;\r\nu8 bit;\r\nbit = (ebus ? AUXIO_PCIO_LED : AUXIO_AUX1_LED);\r\n__auxio_set_bit(bit, on, ebus);\r\n}\r\nstatic void __auxio_sbus_set_lte(int on)\r\n{\r\n__auxio_set_bit(AUXIO_AUX1_LTE, on, 0);\r\n}\r\nvoid auxio_set_lte(int on)\r\n{\r\nswitch(auxio_devtype) {\r\ncase AUXIO_TYPE_SBUS:\r\n__auxio_sbus_set_lte(on);\r\nbreak;\r\ncase AUXIO_TYPE_EBUS:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int __devinit auxio_probe(struct platform_device *dev)\r\n{\r\nstruct device_node *dp = dev->dev.of_node;\r\nunsigned long size;\r\nif (!strcmp(dp->parent->name, "ebus")) {\r\nauxio_devtype = AUXIO_TYPE_EBUS;\r\nsize = sizeof(u32);\r\n} else if (!strcmp(dp->parent->name, "sbus")) {\r\nauxio_devtype = AUXIO_TYPE_SBUS;\r\nsize = 1;\r\n} else {\r\nprintk("auxio: Unknown parent bus type [%s]\n",\r\ndp->parent->name);\r\nreturn -ENODEV;\r\n}\r\nauxio_register = of_ioremap(&dev->resource[0], 0, size, "auxio");\r\nif (!auxio_register)\r\nreturn -ENODEV;\r\nprintk(KERN_INFO "AUXIO: Found device at %s\n",\r\ndp->full_name);\r\nif (auxio_devtype == AUXIO_TYPE_EBUS)\r\nauxio_set_led(AUXIO_LED_ON);\r\nreturn 0;\r\n}\r\nstatic int __init auxio_init(void)\r\n{\r\nreturn platform_driver_register(&auxio_driver);\r\n}

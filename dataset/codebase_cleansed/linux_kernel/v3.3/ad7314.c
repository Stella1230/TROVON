static int ad7314_spi_read(struct ad7314_data *chip, s16 *data)\r\n{\r\nint ret;\r\nret = spi_read(chip->spi_dev, (u8 *)&chip->rx, sizeof(chip->rx));\r\nif (ret < 0) {\r\ndev_err(&chip->spi_dev->dev, "SPI read error\n");\r\nreturn ret;\r\n}\r\n*data = be16_to_cpu(chip->rx);\r\nreturn ret;\r\n}\r\nstatic ssize_t ad7314_show_temperature(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct ad7314_data *chip = dev_get_drvdata(dev);\r\ns16 data;\r\nint ret;\r\nret = ad7314_spi_read(chip, &data);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (spi_get_device_id(chip->spi_dev)->driver_data) {\r\ncase ad7314:\r\ndata = (data & AD7314_TEMP_MASK) >> AD7314_TEMP_OFFSET;\r\ndata = (data << 6) >> 6;\r\nreturn sprintf(buf, "%d\n", 250 * data);\r\ncase adt7301:\r\ncase adt7302:\r\ndata &= ADT7301_TEMP_MASK;\r\ndata = (data << 2) >> 2;\r\nreturn sprintf(buf, "%d\n",\r\nDIV_ROUND_CLOSEST(data * 3125, 100));\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int __devinit ad7314_probe(struct spi_device *spi_dev)\r\n{\r\nint ret;\r\nstruct ad7314_data *chip;\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (chip == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\ndev_set_drvdata(&spi_dev->dev, chip);\r\nret = sysfs_create_group(&spi_dev->dev.kobj, &ad7314_group);\r\nif (ret < 0)\r\ngoto error_free_chip;\r\nchip->hwmon_dev = hwmon_device_register(&spi_dev->dev);\r\nif (IS_ERR(chip->hwmon_dev)) {\r\nret = PTR_ERR(chip->hwmon_dev);\r\ngoto error_remove_group;\r\n}\r\nreturn 0;\r\nerror_remove_group:\r\nsysfs_remove_group(&spi_dev->dev.kobj, &ad7314_group);\r\nerror_free_chip:\r\nkfree(chip);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int __devexit ad7314_remove(struct spi_device *spi_dev)\r\n{\r\nstruct ad7314_data *chip = dev_get_drvdata(&spi_dev->dev);\r\nhwmon_device_unregister(chip->hwmon_dev);\r\nsysfs_remove_group(&spi_dev->dev.kobj, &ad7314_group);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic __init int ad7314_init(void)\r\n{\r\nreturn spi_register_driver(&ad7314_driver);\r\n}\r\nstatic __exit void ad7314_exit(void)\r\n{\r\nspi_unregister_driver(&ad7314_driver);\r\n}

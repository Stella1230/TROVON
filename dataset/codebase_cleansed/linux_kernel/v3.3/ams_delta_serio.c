static int check_data(int data)\r\n{\r\nint i, parity = 0;\r\nif (!(data & 0x400)) {\r\ndev_warn(&ams_delta_serio->dev,\r\n"invalid stop bit, data=0x%X\n",\r\ndata);\r\nreturn SERIO_FRAME;\r\n}\r\nfor (i = 1; i < 10; i++) {\r\nif (data & (1 << i))\r\nparity++;\r\n}\r\nif (!(parity & 0x01)) {\r\ndev_warn(&ams_delta_serio->dev,\r\n"paritiy check failed, data=0x%X parity=0x%X\n",\r\ndata, parity);\r\nreturn SERIO_PARITY;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t ams_delta_serio_interrupt(int irq, void *dev_id)\r\n{\r\nint *circ_buff = &fiq_buffer[FIQ_CIRC_BUFF];\r\nint data, dfl;\r\nu8 scancode;\r\nfiq_buffer[FIQ_IRQ_PEND] = 0;\r\nwhile (fiq_buffer[FIQ_KEYS_CNT] > 0) {\r\ndata = circ_buff[fiq_buffer[FIQ_HEAD_OFFSET]++];\r\nfiq_buffer[FIQ_KEYS_CNT]--;\r\nif (fiq_buffer[FIQ_HEAD_OFFSET] == fiq_buffer[FIQ_BUF_LEN])\r\nfiq_buffer[FIQ_HEAD_OFFSET] = 0;\r\ndfl = check_data(data);\r\nscancode = (u8) (data >> 1) & 0xFF;\r\nserio_interrupt(ams_delta_serio, scancode, dfl);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ams_delta_serio_open(struct serio *serio)\r\n{\r\nams_delta_latch2_write(AMD_DELTA_LATCH2_KEYBRD_PWR,\r\nAMD_DELTA_LATCH2_KEYBRD_PWR);\r\nreturn 0;\r\n}\r\nstatic void ams_delta_serio_close(struct serio *serio)\r\n{\r\nams_delta_latch2_write(AMD_DELTA_LATCH2_KEYBRD_PWR, 0);\r\n}\r\nstatic int __init ams_delta_serio_init(void)\r\n{\r\nint err;\r\nif (!machine_is_ams_delta())\r\nreturn -ENODEV;\r\nams_delta_serio = kzalloc(sizeof(struct serio), GFP_KERNEL);\r\nif (!ams_delta_serio)\r\nreturn -ENOMEM;\r\nams_delta_serio->id.type = SERIO_8042;\r\nams_delta_serio->open = ams_delta_serio_open;\r\nams_delta_serio->close = ams_delta_serio_close;\r\nstrlcpy(ams_delta_serio->name, "AMS DELTA keyboard adapter",\r\nsizeof(ams_delta_serio->name));\r\nstrlcpy(ams_delta_serio->phys, "GPIO/serio0",\r\nsizeof(ams_delta_serio->phys));\r\nerr = gpio_request(AMS_DELTA_GPIO_PIN_KEYBRD_DATA, "serio-data");\r\nif (err) {\r\npr_err("ams_delta_serio: Couldn't request gpio pin for data\n");\r\ngoto serio;\r\n}\r\ngpio_direction_input(AMS_DELTA_GPIO_PIN_KEYBRD_DATA);\r\nerr = gpio_request(AMS_DELTA_GPIO_PIN_KEYBRD_CLK, "serio-clock");\r\nif (err) {\r\npr_err("ams_delta_serio: couldn't request gpio pin for clock\n");\r\ngoto gpio_data;\r\n}\r\ngpio_direction_input(AMS_DELTA_GPIO_PIN_KEYBRD_CLK);\r\nerr = request_irq(gpio_to_irq(AMS_DELTA_GPIO_PIN_KEYBRD_CLK),\r\nams_delta_serio_interrupt, IRQ_TYPE_EDGE_RISING,\r\n"ams-delta-serio", 0);\r\nif (err < 0) {\r\npr_err("ams_delta_serio: couldn't request gpio interrupt %d\n",\r\ngpio_to_irq(AMS_DELTA_GPIO_PIN_KEYBRD_CLK));\r\ngoto gpio_clk;\r\n}\r\nirq_set_handler(gpio_to_irq(AMS_DELTA_GPIO_PIN_KEYBRD_CLK),\r\nhandle_simple_irq);\r\nserio_register_port(ams_delta_serio);\r\ndev_info(&ams_delta_serio->dev, "%s\n", ams_delta_serio->name);\r\nreturn 0;\r\ngpio_clk:\r\ngpio_free(AMS_DELTA_GPIO_PIN_KEYBRD_CLK);\r\ngpio_data:\r\ngpio_free(AMS_DELTA_GPIO_PIN_KEYBRD_DATA);\r\nserio:\r\nkfree(ams_delta_serio);\r\nreturn err;\r\n}\r\nstatic void __exit ams_delta_serio_exit(void)\r\n{\r\nserio_unregister_port(ams_delta_serio);\r\nfree_irq(OMAP_GPIO_IRQ(AMS_DELTA_GPIO_PIN_KEYBRD_CLK), 0);\r\ngpio_free(AMS_DELTA_GPIO_PIN_KEYBRD_CLK);\r\ngpio_free(AMS_DELTA_GPIO_PIN_KEYBRD_DATA);\r\n}

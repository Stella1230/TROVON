static void __init\r\nsisfb_setdefaultparms(void)\r\n{\r\nsisfb_off = 0;\r\nsisfb_parm_mem = 0;\r\nsisfb_accel = -1;\r\nsisfb_ypan = -1;\r\nsisfb_max = -1;\r\nsisfb_userom = -1;\r\nsisfb_useoem = -1;\r\nsisfb_mode_idx = -1;\r\nsisfb_parm_rate = -1;\r\nsisfb_crt1off = 0;\r\nsisfb_forcecrt1 = -1;\r\nsisfb_crt2type = -1;\r\nsisfb_crt2flags = 0;\r\nsisfb_pdc = 0xff;\r\nsisfb_pdca = 0xff;\r\nsisfb_scalelcd = -1;\r\nsisfb_specialtiming = CUT_NONE;\r\nsisfb_lvdshl = -1;\r\nsisfb_dstn = 0;\r\nsisfb_fstn = 0;\r\nsisfb_tvplug = -1;\r\nsisfb_tvstd = -1;\r\nsisfb_tvxposoffset = 0;\r\nsisfb_tvyposoffset = 0;\r\nsisfb_nocrt2rate = 0;\r\n#if !defined(__i386__) && !defined(__x86_64__)\r\nsisfb_resetcard = 0;\r\nsisfb_videoram = 0;\r\n#endif\r\n}\r\nstatic void __devinit\r\nsisfb_search_vesamode(unsigned int vesamode, bool quiet)\r\n{\r\nint i = 0, j = 0;\r\nif(vesamode == 0) {\r\nif(!quiet)\r\nprintk(KERN_ERR "sisfb: Invalid mode. Using default.\n");\r\nsisfb_mode_idx = DEFAULT_MODE;\r\nreturn;\r\n}\r\nvesamode &= 0x1dff;\r\nwhile(sisbios_mode[i++].mode_no[0] != 0) {\r\nif( (sisbios_mode[i-1].vesa_mode_no_1 == vesamode) ||\r\n(sisbios_mode[i-1].vesa_mode_no_2 == vesamode) ) {\r\nif(sisfb_fstn) {\r\nif(sisbios_mode[i-1].mode_no[1] == 0x50 ||\r\nsisbios_mode[i-1].mode_no[1] == 0x56 ||\r\nsisbios_mode[i-1].mode_no[1] == 0x53)\r\ncontinue;\r\n} else {\r\nif(sisbios_mode[i-1].mode_no[1] == 0x5a ||\r\nsisbios_mode[i-1].mode_no[1] == 0x5b)\r\ncontinue;\r\n}\r\nsisfb_mode_idx = i - 1;\r\nj = 1;\r\nbreak;\r\n}\r\n}\r\nif((!j) && !quiet)\r\nprintk(KERN_ERR "sisfb: Invalid VESA mode 0x%x'\n", vesamode);\r\n}\r\nstatic void __devinit\r\nsisfb_search_mode(char *name, bool quiet)\r\n{\r\nunsigned int j = 0, xres = 0, yres = 0, depth = 0, rate = 0;\r\nint i = 0;\r\nchar strbuf[16], strbuf1[20];\r\nchar *nameptr = name;\r\nif(name == NULL) {\r\nif(!quiet)\r\nprintk(KERN_ERR "sisfb: Internal error, using default mode.\n");\r\nsisfb_mode_idx = DEFAULT_MODE;\r\nreturn;\r\n}\r\nif(!strnicmp(name, sisbios_mode[MODE_INDEX_NONE].name, strlen(name))) {\r\nif(!quiet)\r\nprintk(KERN_ERR "sisfb: Mode 'none' not supported anymore. Using default.\n");\r\nsisfb_mode_idx = DEFAULT_MODE;\r\nreturn;\r\n}\r\nif(strlen(name) <= 19) {\r\nstrcpy(strbuf1, name);\r\nfor(i = 0; i < strlen(strbuf1); i++) {\r\nif(strbuf1[i] < '0' || strbuf1[i] > '9') strbuf1[i] = ' ';\r\n}\r\nif(sscanf(strbuf1, "%u %u %u %u", &xres, &yres, &depth, &rate) == 4) {\r\nif((rate <= 32) || (depth > 32)) {\r\nj = rate; rate = depth; depth = j;\r\n}\r\nsprintf(strbuf, "%ux%ux%u", xres, yres, depth);\r\nnameptr = strbuf;\r\nsisfb_parm_rate = rate;\r\n} else if(sscanf(strbuf1, "%u %u %u", &xres, &yres, &depth) == 3) {\r\nsprintf(strbuf, "%ux%ux%u", xres, yres, depth);\r\nnameptr = strbuf;\r\n} else {\r\nxres = 0;\r\nif((sscanf(strbuf1, "%u %u", &xres, &yres) == 2) && (xres != 0)) {\r\nsprintf(strbuf, "%ux%ux8", xres, yres);\r\nnameptr = strbuf;\r\n} else {\r\nsisfb_search_vesamode(simple_strtoul(name, NULL, 0), quiet);\r\nreturn;\r\n}\r\n}\r\n}\r\ni = 0; j = 0;\r\nwhile(sisbios_mode[i].mode_no[0] != 0) {\r\nif(!strnicmp(nameptr, sisbios_mode[i++].name, strlen(nameptr))) {\r\nif(sisfb_fstn) {\r\nif(sisbios_mode[i-1].mode_no[1] == 0x50 ||\r\nsisbios_mode[i-1].mode_no[1] == 0x56 ||\r\nsisbios_mode[i-1].mode_no[1] == 0x53)\r\ncontinue;\r\n} else {\r\nif(sisbios_mode[i-1].mode_no[1] == 0x5a ||\r\nsisbios_mode[i-1].mode_no[1] == 0x5b)\r\ncontinue;\r\n}\r\nsisfb_mode_idx = i - 1;\r\nj = 1;\r\nbreak;\r\n}\r\n}\r\nif((!j) && !quiet)\r\nprintk(KERN_ERR "sisfb: Invalid mode '%s'\n", nameptr);\r\n}\r\nstatic void __devinit\r\nsisfb_get_vga_mode_from_kernel(void)\r\n{\r\n#ifdef CONFIG_X86\r\nchar mymode[32];\r\nint mydepth = screen_info.lfb_depth;\r\nif(screen_info.orig_video_isVGA != VIDEO_TYPE_VLFB) return;\r\nif( (screen_info.lfb_width >= 320) && (screen_info.lfb_width <= 2048) &&\r\n(screen_info.lfb_height >= 200) && (screen_info.lfb_height <= 1536) &&\r\n(mydepth >= 8) && (mydepth <= 32) ) {\r\nif(mydepth == 24) mydepth = 32;\r\nsprintf(mymode, "%ux%ux%u", screen_info.lfb_width,\r\nscreen_info.lfb_height,\r\nmydepth);\r\nprintk(KERN_DEBUG\r\n"sisfb: Using vga mode %s pre-set by kernel as default\n",\r\nmymode);\r\nsisfb_search_mode(mymode, true);\r\n}\r\n#endif\r\nreturn;\r\n}\r\nstatic void __init\r\nsisfb_search_crt2type(const char *name)\r\n{\r\nint i = 0;\r\nif(name == NULL) return;\r\nwhile(sis_crt2type[i].type_no != -1) {\r\nif(!strnicmp(name, sis_crt2type[i].name, strlen(sis_crt2type[i].name))) {\r\nsisfb_crt2type = sis_crt2type[i].type_no;\r\nsisfb_tvplug = sis_crt2type[i].tvplug_no;\r\nsisfb_crt2flags = sis_crt2type[i].flags;\r\nbreak;\r\n}\r\ni++;\r\n}\r\nsisfb_dstn = (sisfb_crt2flags & FL_550_DSTN) ? 1 : 0;\r\nsisfb_fstn = (sisfb_crt2flags & FL_550_FSTN) ? 1 : 0;\r\nif(sisfb_crt2type < 0)\r\nprintk(KERN_ERR "sisfb: Invalid CRT2 type: %s\n", name);\r\n}\r\nstatic void __init\r\nsisfb_search_tvstd(const char *name)\r\n{\r\nint i = 0;\r\nif(name == NULL)\r\nreturn;\r\nwhile(sis_tvtype[i].type_no != -1) {\r\nif(!strnicmp(name, sis_tvtype[i].name, strlen(sis_tvtype[i].name))) {\r\nsisfb_tvstd = sis_tvtype[i].type_no;\r\nbreak;\r\n}\r\ni++;\r\n}\r\n}\r\nstatic void __init\r\nsisfb_search_specialtiming(const char *name)\r\n{\r\nint i = 0;\r\nbool found = false;\r\nif(name == NULL)\r\nreturn;\r\nif(!strnicmp(name, "none", 4)) {\r\nsisfb_specialtiming = CUT_FORCENONE;\r\nprintk(KERN_DEBUG "sisfb: Special timing disabled\n");\r\n} else {\r\nwhile(mycustomttable[i].chipID != 0) {\r\nif(!strnicmp(name,mycustomttable[i].optionName,\r\nstrlen(mycustomttable[i].optionName))) {\r\nsisfb_specialtiming = mycustomttable[i].SpecialID;\r\nfound = true;\r\nprintk(KERN_INFO "sisfb: Special timing for %s %s forced (\"%s\")\n",\r\nmycustomttable[i].vendorName,\r\nmycustomttable[i].cardName,\r\nmycustomttable[i].optionName);\r\nbreak;\r\n}\r\ni++;\r\n}\r\nif(!found) {\r\nprintk(KERN_WARNING "sisfb: Invalid SpecialTiming parameter, valid are:");\r\nprintk(KERN_WARNING "\t\"none\" (to disable special timings)\n");\r\ni = 0;\r\nwhile(mycustomttable[i].chipID != 0) {\r\nprintk(KERN_WARNING "\t\"%s\" (for %s %s)\n",\r\nmycustomttable[i].optionName,\r\nmycustomttable[i].vendorName,\r\nmycustomttable[i].cardName);\r\ni++;\r\n}\r\n}\r\n}\r\n}\r\nstatic void __devinit\r\nsisfb_detect_custom_timing(struct sis_video_info *ivideo)\r\n{\r\nunsigned char *biosver = NULL;\r\nunsigned char *biosdate = NULL;\r\nbool footprint;\r\nu32 chksum = 0;\r\nint i, j;\r\nif(ivideo->SiS_Pr.UseROM) {\r\nbiosver = ivideo->SiS_Pr.VirtualRomBase + 0x06;\r\nbiosdate = ivideo->SiS_Pr.VirtualRomBase + 0x2c;\r\nfor(i = 0; i < 32768; i++)\r\nchksum += ivideo->SiS_Pr.VirtualRomBase[i];\r\n}\r\ni = 0;\r\ndo {\r\nif( (mycustomttable[i].chipID == ivideo->chip) &&\r\n((!strlen(mycustomttable[i].biosversion)) ||\r\n(ivideo->SiS_Pr.UseROM &&\r\n(!strncmp(mycustomttable[i].biosversion, biosver,\r\nstrlen(mycustomttable[i].biosversion))))) &&\r\n((!strlen(mycustomttable[i].biosdate)) ||\r\n(ivideo->SiS_Pr.UseROM &&\r\n(!strncmp(mycustomttable[i].biosdate, biosdate,\r\nstrlen(mycustomttable[i].biosdate))))) &&\r\n((!mycustomttable[i].bioschksum) ||\r\n(ivideo->SiS_Pr.UseROM &&\r\n(mycustomttable[i].bioschksum == chksum))) &&\r\n(mycustomttable[i].pcisubsysvendor == ivideo->subsysvendor) &&\r\n(mycustomttable[i].pcisubsyscard == ivideo->subsysdevice) ) {\r\nfootprint = true;\r\nfor(j = 0; j < 5; j++) {\r\nif(mycustomttable[i].biosFootprintAddr[j]) {\r\nif(ivideo->SiS_Pr.UseROM) {\r\nif(ivideo->SiS_Pr.VirtualRomBase[mycustomttable[i].biosFootprintAddr[j]] !=\r\nmycustomttable[i].biosFootprintData[j]) {\r\nfootprint = false;\r\n}\r\n} else\r\nfootprint = false;\r\n}\r\n}\r\nif(footprint) {\r\nivideo->SiS_Pr.SiS_CustomT = mycustomttable[i].SpecialID;\r\nprintk(KERN_DEBUG "sisfb: Identified [%s %s], special timing applies\n",\r\nmycustomttable[i].vendorName,\r\nmycustomttable[i].cardName);\r\nprintk(KERN_DEBUG "sisfb: [specialtiming parameter name: %s]\n",\r\nmycustomttable[i].optionName);\r\nbreak;\r\n}\r\n}\r\ni++;\r\n} while(mycustomttable[i].chipID);\r\n}\r\nstatic bool __devinit\r\nsisfb_interpret_edid(struct sisfb_monitor *monitor, u8 *buffer)\r\n{\r\nint i, j, xres, yres, refresh, index;\r\nu32 emodes;\r\nif(buffer[0] != 0x00 || buffer[1] != 0xff ||\r\nbuffer[2] != 0xff || buffer[3] != 0xff ||\r\nbuffer[4] != 0xff || buffer[5] != 0xff ||\r\nbuffer[6] != 0xff || buffer[7] != 0x00) {\r\nprintk(KERN_DEBUG "sisfb: Bad EDID header\n");\r\nreturn false;\r\n}\r\nif(buffer[0x12] != 0x01) {\r\nprintk(KERN_INFO "sisfb: EDID version %d not supported\n",\r\nbuffer[0x12]);\r\nreturn false;\r\n}\r\nmonitor->feature = buffer[0x18];\r\nif(!(buffer[0x14] & 0x80)) {\r\nif(!(buffer[0x14] & 0x08)) {\r\nprintk(KERN_INFO\r\n"sisfb: WARNING: Monitor does not support separate syncs\n");\r\n}\r\n}\r\nif(buffer[0x13] >= 0x01) {\r\nj = 0x36;\r\nfor(i=0; i<4; i++) {\r\nif(buffer[j] == 0x00 && buffer[j + 1] == 0x00 &&\r\nbuffer[j + 2] == 0x00 && buffer[j + 3] == 0xfd &&\r\nbuffer[j + 4] == 0x00) {\r\nmonitor->hmin = buffer[j + 7];\r\nmonitor->hmax = buffer[j + 8];\r\nmonitor->vmin = buffer[j + 5];\r\nmonitor->vmax = buffer[j + 6];\r\nmonitor->dclockmax = buffer[j + 9] * 10 * 1000;\r\nmonitor->datavalid = true;\r\nbreak;\r\n}\r\nj += 18;\r\n}\r\n}\r\nif(!monitor->datavalid) {\r\nmonitor->hmin = 65535; monitor->hmax = 0;\r\nmonitor->vmin = 65535; monitor->vmax = 0;\r\nmonitor->dclockmax = 0;\r\nemodes = buffer[0x23] | (buffer[0x24] << 8) | (buffer[0x25] << 16);\r\nfor(i = 0; i < 13; i++) {\r\nif(emodes & sisfb_ddcsmodes[i].mask) {\r\nif(monitor->hmin > sisfb_ddcsmodes[i].h) monitor->hmin = sisfb_ddcsmodes[i].h;\r\nif(monitor->hmax < sisfb_ddcsmodes[i].h) monitor->hmax = sisfb_ddcsmodes[i].h + 1;\r\nif(monitor->vmin > sisfb_ddcsmodes[i].v) monitor->vmin = sisfb_ddcsmodes[i].v;\r\nif(monitor->vmax < sisfb_ddcsmodes[i].v) monitor->vmax = sisfb_ddcsmodes[i].v;\r\nif(monitor->dclockmax < sisfb_ddcsmodes[i].d) monitor->dclockmax = sisfb_ddcsmodes[i].d;\r\n}\r\n}\r\nindex = 0x26;\r\nfor(i = 0; i < 8; i++) {\r\nxres = (buffer[index] + 31) * 8;\r\nswitch(buffer[index + 1] & 0xc0) {\r\ncase 0xc0: yres = (xres * 9) / 16; break;\r\ncase 0x80: yres = (xres * 4) / 5; break;\r\ncase 0x40: yres = (xres * 3) / 4; break;\r\ndefault: yres = xres; break;\r\n}\r\nrefresh = (buffer[index + 1] & 0x3f) + 60;\r\nif((xres >= 640) && (yres >= 480)) {\r\nfor(j = 0; j < 8; j++) {\r\nif((xres == sisfb_ddcfmodes[j].x) &&\r\n(yres == sisfb_ddcfmodes[j].y) &&\r\n(refresh == sisfb_ddcfmodes[j].v)) {\r\nif(monitor->hmin > sisfb_ddcfmodes[j].h) monitor->hmin = sisfb_ddcfmodes[j].h;\r\nif(monitor->hmax < sisfb_ddcfmodes[j].h) monitor->hmax = sisfb_ddcfmodes[j].h + 1;\r\nif(monitor->vmin > sisfb_ddcsmodes[j].v) monitor->vmin = sisfb_ddcsmodes[j].v;\r\nif(monitor->vmax < sisfb_ddcsmodes[j].v) monitor->vmax = sisfb_ddcsmodes[j].v;\r\nif(monitor->dclockmax < sisfb_ddcsmodes[j].d) monitor->dclockmax = sisfb_ddcsmodes[j].d;\r\n}\r\n}\r\n}\r\nindex += 2;\r\n}\r\nif((monitor->hmin <= monitor->hmax) && (monitor->vmin <= monitor->vmax)) {\r\nmonitor->datavalid = true;\r\n}\r\n}\r\nreturn monitor->datavalid;\r\n}\r\nstatic void __devinit\r\nsisfb_handle_ddc(struct sis_video_info *ivideo, struct sisfb_monitor *monitor, int crtno)\r\n{\r\nunsigned short temp, i, realcrtno = crtno;\r\nunsigned char buffer[256];\r\nmonitor->datavalid = false;\r\nif(crtno) {\r\nif(ivideo->vbflags & CRT2_LCD) realcrtno = 1;\r\nelse if(ivideo->vbflags & CRT2_VGA) realcrtno = 2;\r\nelse return;\r\n}\r\nif((ivideo->sisfb_crt1off) && (!crtno))\r\nreturn;\r\ntemp = SiS_HandleDDC(&ivideo->SiS_Pr, ivideo->vbflags, ivideo->sisvga_engine,\r\nrealcrtno, 0, &buffer[0], ivideo->vbflags2);\r\nif((!temp) || (temp == 0xffff)) {\r\nprintk(KERN_INFO "sisfb: CRT%d DDC probing failed\n", crtno + 1);\r\nreturn;\r\n} else {\r\nprintk(KERN_INFO "sisfb: CRT%d DDC supported\n", crtno + 1);\r\nprintk(KERN_INFO "sisfb: CRT%d DDC level: %s%s%s%s\n",\r\ncrtno + 1,\r\n(temp & 0x1a) ? "" : "[none of the supported]",\r\n(temp & 0x02) ? "2 " : "",\r\n(temp & 0x08) ? "D&P" : "",\r\n(temp & 0x10) ? "FPDI-2" : "");\r\nif(temp & 0x02) {\r\ni = 3;\r\ndo {\r\ntemp = SiS_HandleDDC(&ivideo->SiS_Pr, ivideo->vbflags, ivideo->sisvga_engine,\r\nrealcrtno, 1, &buffer[0], ivideo->vbflags2);\r\n} while((temp) && i--);\r\nif(!temp) {\r\nif(sisfb_interpret_edid(monitor, &buffer[0])) {\r\nprintk(KERN_INFO "sisfb: Monitor range H %d-%dKHz, V %d-%dHz, Max. dotclock %dMHz\n",\r\nmonitor->hmin, monitor->hmax, monitor->vmin, monitor->vmax,\r\nmonitor->dclockmax / 1000);\r\n} else {\r\nprintk(KERN_INFO "sisfb: CRT%d DDC EDID corrupt\n", crtno + 1);\r\n}\r\n} else {\r\nprintk(KERN_INFO "sisfb: CRT%d DDC reading failed\n", crtno + 1);\r\n}\r\n} else {\r\nprintk(KERN_INFO "sisfb: VESA D&P and FPDI-2 not supported yet\n");\r\n}\r\n}\r\n}\r\nstatic bool\r\nsisfb_verify_rate(struct sis_video_info *ivideo, struct sisfb_monitor *monitor,\r\nint mode_idx, int rate_idx, int rate)\r\n{\r\nint htotal, vtotal;\r\nunsigned int dclock, hsync;\r\nif(!monitor->datavalid)\r\nreturn true;\r\nif(mode_idx < 0)\r\nreturn false;\r\nswitch(sisbios_mode[mode_idx].mode_no[ivideo->mni]) {\r\ncase 0x59:\r\ncase 0x41:\r\ncase 0x4f:\r\ncase 0x50:\r\ncase 0x56:\r\ncase 0x53:\r\ncase 0x2f:\r\ncase 0x5d:\r\ncase 0x5e:\r\nreturn true;\r\n#ifdef CONFIG_FB_SIS_315\r\ncase 0x5a:\r\ncase 0x5b:\r\nif(ivideo->sisvga_engine == SIS_315_VGA) return true;\r\n#endif\r\n}\r\nif(rate < (monitor->vmin - 1))\r\nreturn false;\r\nif(rate > (monitor->vmax + 1))\r\nreturn false;\r\nif(sisfb_gettotalfrommode(&ivideo->SiS_Pr,\r\nsisbios_mode[mode_idx].mode_no[ivideo->mni],\r\n&htotal, &vtotal, rate_idx)) {\r\ndclock = (htotal * vtotal * rate) / 1000;\r\nif(dclock > (monitor->dclockmax + 1000))\r\nreturn false;\r\nhsync = dclock / htotal;\r\nif(hsync < (monitor->hmin - 1))\r\nreturn false;\r\nif(hsync > (monitor->hmax + 1))\r\nreturn false;\r\n} else {\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic int\r\nsisfb_validate_mode(struct sis_video_info *ivideo, int myindex, u32 vbflags)\r\n{\r\nu16 xres=0, yres, myres;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nif(!(sisbios_mode[myindex].chipset & MD_SIS300))\r\nreturn -1 ;\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nif(!(sisbios_mode[myindex].chipset & MD_SIS315))\r\nreturn -1;\r\n}\r\n#endif\r\nmyres = sisbios_mode[myindex].yres;\r\nswitch(vbflags & VB_DISPTYPE_DISP2) {\r\ncase CRT2_LCD:\r\nxres = ivideo->lcdxres; yres = ivideo->lcdyres;\r\nif((ivideo->SiS_Pr.SiS_CustomT != CUT_PANEL848) &&\r\n(ivideo->SiS_Pr.SiS_CustomT != CUT_PANEL856)) {\r\nif(sisbios_mode[myindex].xres > xres)\r\nreturn -1;\r\nif(myres > yres)\r\nreturn -1;\r\n}\r\nif(ivideo->sisfb_fstn) {\r\nif(sisbios_mode[myindex].xres == 320) {\r\nif(myres == 240) {\r\nswitch(sisbios_mode[myindex].mode_no[1]) {\r\ncase 0x50: myindex = MODE_FSTN_8; break;\r\ncase 0x56: myindex = MODE_FSTN_16; break;\r\ncase 0x53: return -1;\r\n}\r\n}\r\n}\r\n}\r\nif(SiS_GetModeID_LCD(ivideo->sisvga_engine, vbflags, sisbios_mode[myindex].xres,\r\nsisbios_mode[myindex].yres, 0, ivideo->sisfb_fstn,\r\nivideo->SiS_Pr.SiS_CustomT, xres, yres, ivideo->vbflags2) < 0x14) {\r\nreturn -1;\r\n}\r\nbreak;\r\ncase CRT2_TV:\r\nif(SiS_GetModeID_TV(ivideo->sisvga_engine, vbflags, sisbios_mode[myindex].xres,\r\nsisbios_mode[myindex].yres, 0, ivideo->vbflags2) < 0x14) {\r\nreturn -1;\r\n}\r\nbreak;\r\ncase CRT2_VGA:\r\nif(SiS_GetModeID_VGA2(ivideo->sisvga_engine, vbflags, sisbios_mode[myindex].xres,\r\nsisbios_mode[myindex].yres, 0, ivideo->vbflags2) < 0x14) {\r\nreturn -1;\r\n}\r\nbreak;\r\n}\r\nreturn myindex;\r\n}\r\nstatic u8\r\nsisfb_search_refresh_rate(struct sis_video_info *ivideo, unsigned int rate, int mode_idx)\r\n{\r\nint i = 0;\r\nu16 xres = sisbios_mode[mode_idx].xres;\r\nu16 yres = sisbios_mode[mode_idx].yres;\r\nivideo->rate_idx = 0;\r\nwhile((sisfb_vrate[i].idx != 0) && (sisfb_vrate[i].xres <= xres)) {\r\nif((sisfb_vrate[i].xres == xres) && (sisfb_vrate[i].yres == yres)) {\r\nif(sisfb_vrate[i].refresh == rate) {\r\nivideo->rate_idx = sisfb_vrate[i].idx;\r\nbreak;\r\n} else if(sisfb_vrate[i].refresh > rate) {\r\nif((sisfb_vrate[i].refresh - rate) <= 3) {\r\nDPRINTK("sisfb: Adjusting rate from %d up to %d\n",\r\nrate, sisfb_vrate[i].refresh);\r\nivideo->rate_idx = sisfb_vrate[i].idx;\r\nivideo->refresh_rate = sisfb_vrate[i].refresh;\r\n} else if((sisfb_vrate[i].idx != 1) &&\r\n((rate - sisfb_vrate[i-1].refresh) <= 2)) {\r\nDPRINTK("sisfb: Adjusting rate from %d down to %d\n",\r\nrate, sisfb_vrate[i-1].refresh);\r\nivideo->rate_idx = sisfb_vrate[i-1].idx;\r\nivideo->refresh_rate = sisfb_vrate[i-1].refresh;\r\n}\r\nbreak;\r\n} else if((rate - sisfb_vrate[i].refresh) <= 2) {\r\nDPRINTK("sisfb: Adjusting rate from %d down to %d\n",\r\nrate, sisfb_vrate[i].refresh);\r\nivideo->rate_idx = sisfb_vrate[i].idx;\r\nbreak;\r\n}\r\n}\r\ni++;\r\n}\r\nif(ivideo->rate_idx > 0) {\r\nreturn ivideo->rate_idx;\r\n} else {\r\nprintk(KERN_INFO "sisfb: Unsupported rate %d for %dx%d\n",\r\nrate, xres, yres);\r\nreturn 0;\r\n}\r\n}\r\nstatic bool\r\nsisfb_bridgeisslave(struct sis_video_info *ivideo)\r\n{\r\nunsigned char P1_00;\r\nif(!(ivideo->vbflags2 & VB2_VIDEOBRIDGE))\r\nreturn false;\r\nP1_00 = SiS_GetReg(SISPART1, 0x00);\r\nif( ((ivideo->sisvga_engine == SIS_300_VGA) && (P1_00 & 0xa0) == 0x20) ||\r\n((ivideo->sisvga_engine == SIS_315_VGA) && (P1_00 & 0x50) == 0x10) ) {\r\nreturn true;\r\n} else {\r\nreturn false;\r\n}\r\n}\r\nstatic bool\r\nsisfballowretracecrt1(struct sis_video_info *ivideo)\r\n{\r\nu8 temp;\r\ntemp = SiS_GetReg(SISCR, 0x17);\r\nif(!(temp & 0x80))\r\nreturn false;\r\ntemp = SiS_GetReg(SISSR, 0x1f);\r\nif(temp & 0xc0)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic bool\r\nsisfbcheckvretracecrt1(struct sis_video_info *ivideo)\r\n{\r\nif(!sisfballowretracecrt1(ivideo))\r\nreturn false;\r\nif (SiS_GetRegByte(SISINPSTAT) & 0x08)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nstatic void\r\nsisfbwaitretracecrt1(struct sis_video_info *ivideo)\r\n{\r\nint watchdog;\r\nif(!sisfballowretracecrt1(ivideo))\r\nreturn;\r\nwatchdog = 65536;\r\nwhile ((!(SiS_GetRegByte(SISINPSTAT) & 0x08)) && --watchdog);\r\nwatchdog = 65536;\r\nwhile ((SiS_GetRegByte(SISINPSTAT) & 0x08) && --watchdog);\r\n}\r\nstatic bool\r\nsisfbcheckvretracecrt2(struct sis_video_info *ivideo)\r\n{\r\nunsigned char temp, reg;\r\nswitch(ivideo->sisvga_engine) {\r\ncase SIS_300_VGA: reg = 0x25; break;\r\ncase SIS_315_VGA: reg = 0x30; break;\r\ndefault: return false;\r\n}\r\ntemp = SiS_GetReg(SISPART1, reg);\r\nif(temp & 0x02)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nstatic bool\r\nsisfb_CheckVBRetrace(struct sis_video_info *ivideo)\r\n{\r\nif(ivideo->currentvbflags & VB_DISPTYPE_DISP2) {\r\nif(!sisfb_bridgeisslave(ivideo)) {\r\nreturn sisfbcheckvretracecrt2(ivideo);\r\n}\r\n}\r\nreturn sisfbcheckvretracecrt1(ivideo);\r\n}\r\nstatic u32\r\nsisfb_setupvbblankflags(struct sis_video_info *ivideo, u32 *vcount, u32 *hcount)\r\n{\r\nu8 idx, reg1, reg2, reg3, reg4;\r\nu32 ret = 0;\r\n(*vcount) = (*hcount) = 0;\r\nif((ivideo->currentvbflags & VB_DISPTYPE_DISP2) && (!(sisfb_bridgeisslave(ivideo)))) {\r\nret |= (FB_VBLANK_HAVE_VSYNC |\r\nFB_VBLANK_HAVE_HBLANK |\r\nFB_VBLANK_HAVE_VBLANK |\r\nFB_VBLANK_HAVE_VCOUNT |\r\nFB_VBLANK_HAVE_HCOUNT);\r\nswitch(ivideo->sisvga_engine) {\r\ncase SIS_300_VGA: idx = 0x25; break;\r\ndefault:\r\ncase SIS_315_VGA: idx = 0x30; break;\r\n}\r\nreg1 = SiS_GetReg(SISPART1, (idx+0));\r\nreg2 = SiS_GetReg(SISPART1, (idx+1));\r\nreg3 = SiS_GetReg(SISPART1, (idx+2));\r\nreg4 = SiS_GetReg(SISPART1, (idx+3));\r\nif(reg1 & 0x01) ret |= FB_VBLANK_VBLANKING;\r\nif(reg1 & 0x02) ret |= FB_VBLANK_VSYNCING;\r\nif(reg4 & 0x80) ret |= FB_VBLANK_HBLANKING;\r\n(*vcount) = reg3 | ((reg4 & 0x70) << 4);\r\n(*hcount) = reg2 | ((reg4 & 0x0f) << 8);\r\n} else if(sisfballowretracecrt1(ivideo)) {\r\nret |= (FB_VBLANK_HAVE_VSYNC |\r\nFB_VBLANK_HAVE_VBLANK |\r\nFB_VBLANK_HAVE_VCOUNT |\r\nFB_VBLANK_HAVE_HCOUNT);\r\nreg1 = SiS_GetRegByte(SISINPSTAT);\r\nif(reg1 & 0x08) ret |= FB_VBLANK_VSYNCING;\r\nif(reg1 & 0x01) ret |= FB_VBLANK_VBLANKING;\r\nreg1 = SiS_GetReg(SISCR, 0x20);\r\nreg1 = SiS_GetReg(SISCR, 0x1b);\r\nreg2 = SiS_GetReg(SISCR, 0x1c);\r\nreg3 = SiS_GetReg(SISCR, 0x1d);\r\n(*vcount) = reg2 | ((reg3 & 0x07) << 8);\r\n(*hcount) = (reg1 | ((reg3 & 0x10) << 4)) << 3;\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nsisfb_myblank(struct sis_video_info *ivideo, int blank)\r\n{\r\nu8 sr01, sr11, sr1f, cr63=0, p2_0, p1_13;\r\nbool backlight = true;\r\nswitch(blank) {\r\ncase FB_BLANK_UNBLANK:\r\nsr01 = 0x00;\r\nsr11 = 0x00;\r\nsr1f = 0x00;\r\ncr63 = 0x00;\r\np2_0 = 0x20;\r\np1_13 = 0x00;\r\nbacklight = true;\r\nbreak;\r\ncase FB_BLANK_NORMAL:\r\nsr01 = 0x20;\r\nsr11 = 0x00;\r\nsr1f = 0x00;\r\ncr63 = 0x00;\r\np2_0 = 0x20;\r\np1_13 = 0x00;\r\nbacklight = true;\r\nbreak;\r\ncase FB_BLANK_VSYNC_SUSPEND:\r\nsr01 = 0x20;\r\nsr11 = 0x08;\r\nsr1f = 0x80;\r\ncr63 = 0x40;\r\np2_0 = 0x40;\r\np1_13 = 0x80;\r\nbacklight = false;\r\nbreak;\r\ncase FB_BLANK_HSYNC_SUSPEND:\r\nsr01 = 0x20;\r\nsr11 = 0x08;\r\nsr1f = 0x40;\r\ncr63 = 0x40;\r\np2_0 = 0x80;\r\np1_13 = 0x40;\r\nbacklight = false;\r\nbreak;\r\ncase FB_BLANK_POWERDOWN:\r\nsr01 = 0x20;\r\nsr11 = 0x08;\r\nsr1f = 0xc0;\r\ncr63 = 0x40;\r\np2_0 = 0xc0;\r\np1_13 = 0xc0;\r\nbacklight = false;\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\nif(ivideo->currentvbflags & VB_DISPTYPE_CRT1) {\r\nif( (!ivideo->sisfb_thismonitor.datavalid) ||\r\n((ivideo->sisfb_thismonitor.datavalid) &&\r\n(ivideo->sisfb_thismonitor.feature & 0xe0))) {\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nSiS_SetRegANDOR(SISCR, ivideo->SiS_Pr.SiS_MyCR63, 0xbf, cr63);\r\n}\r\nif(!(sisfb_bridgeisslave(ivideo))) {\r\nSiS_SetRegANDOR(SISSR, 0x01, ~0x20, sr01);\r\nSiS_SetRegANDOR(SISSR, 0x1f, 0x3f, sr1f);\r\n}\r\n}\r\n}\r\nif(ivideo->currentvbflags & CRT2_LCD) {\r\nif(ivideo->vbflags2 & VB2_SISLVDSBRIDGE) {\r\nif(backlight) {\r\nSiS_SiS30xBLOn(&ivideo->SiS_Pr);\r\n} else {\r\nSiS_SiS30xBLOff(&ivideo->SiS_Pr);\r\n}\r\n} else if(ivideo->sisvga_engine == SIS_315_VGA) {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->vbflags2 & VB2_CHRONTEL) {\r\nif(backlight) {\r\nSiS_Chrontel701xBLOn(&ivideo->SiS_Pr);\r\n} else {\r\nSiS_Chrontel701xBLOff(&ivideo->SiS_Pr);\r\n}\r\n}\r\n#endif\r\n}\r\nif(((ivideo->sisvga_engine == SIS_300_VGA) &&\r\n(ivideo->vbflags2 & (VB2_301|VB2_30xBDH|VB2_LVDS))) ||\r\n((ivideo->sisvga_engine == SIS_315_VGA) &&\r\n((ivideo->vbflags2 & (VB2_LVDS | VB2_CHRONTEL)) == VB2_LVDS))) {\r\nSiS_SetRegANDOR(SISSR, 0x11, ~0x0c, sr11);\r\n}\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nif((ivideo->vbflags2 & VB2_30xB) &&\r\n(!(ivideo->vbflags2 & VB2_30xBDH))) {\r\nSiS_SetRegANDOR(SISPART1, 0x13, 0x3f, p1_13);\r\n}\r\n} else if(ivideo->sisvga_engine == SIS_315_VGA) {\r\nif((ivideo->vbflags2 & VB2_30xB) &&\r\n(!(ivideo->vbflags2 & VB2_30xBDH))) {\r\nSiS_SetRegANDOR(SISPART2, 0x00, 0x1f, p2_0);\r\n}\r\n}\r\n} else if(ivideo->currentvbflags & CRT2_VGA) {\r\nif(ivideo->vbflags2 & VB2_30xB) {\r\nSiS_SetRegANDOR(SISPART2, 0x00, 0x1f, p2_0);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nunsigned int\r\nsisfb_read_nbridge_pci_dword(struct SiS_Private *SiS_Pr, int reg)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)SiS_Pr->ivideo;\r\nu32 val = 0;\r\npci_read_config_dword(ivideo->nbridge, reg, &val);\r\nreturn (unsigned int)val;\r\n}\r\nvoid\r\nsisfb_write_nbridge_pci_dword(struct SiS_Private *SiS_Pr, int reg, unsigned int val)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)SiS_Pr->ivideo;\r\npci_write_config_dword(ivideo->nbridge, reg, (u32)val);\r\n}\r\nunsigned int\r\nsisfb_read_lpc_pci_dword(struct SiS_Private *SiS_Pr, int reg)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)SiS_Pr->ivideo;\r\nu32 val = 0;\r\nif(!ivideo->lpcdev) return 0;\r\npci_read_config_dword(ivideo->lpcdev, reg, &val);\r\nreturn (unsigned int)val;\r\n}\r\nvoid\r\nsisfb_write_nbridge_pci_byte(struct SiS_Private *SiS_Pr, int reg, unsigned char val)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)SiS_Pr->ivideo;\r\npci_write_config_byte(ivideo->nbridge, reg, (u8)val);\r\n}\r\nunsigned int\r\nsisfb_read_mio_pci_word(struct SiS_Private *SiS_Pr, int reg)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)SiS_Pr->ivideo;\r\nu16 val = 0;\r\nif(!ivideo->lpcdev) return 0;\r\npci_read_config_word(ivideo->lpcdev, reg, &val);\r\nreturn (unsigned int)val;\r\n}\r\nstatic int\r\nsisfb_get_cmap_len(const struct fb_var_screeninfo *var)\r\n{\r\nreturn (var->bits_per_pixel == 8) ? 256 : 16;\r\n}\r\nstatic void\r\nsisfb_set_vparms(struct sis_video_info *ivideo)\r\n{\r\nswitch(ivideo->video_bpp) {\r\ncase 8:\r\nivideo->DstColor = 0x0000;\r\nivideo->SiS310_AccelDepth = 0x00000000;\r\nivideo->video_cmap_len = 256;\r\nbreak;\r\ncase 16:\r\nivideo->DstColor = 0x8000;\r\nivideo->SiS310_AccelDepth = 0x00010000;\r\nivideo->video_cmap_len = 16;\r\nbreak;\r\ncase 32:\r\nivideo->DstColor = 0xC000;\r\nivideo->SiS310_AccelDepth = 0x00020000;\r\nivideo->video_cmap_len = 16;\r\nbreak;\r\ndefault:\r\nivideo->video_cmap_len = 16;\r\nprintk(KERN_ERR "sisfb: Unsupported depth %d", ivideo->video_bpp);\r\nivideo->accel = 0;\r\n}\r\n}\r\nstatic int\r\nsisfb_calc_maxyres(struct sis_video_info *ivideo, struct fb_var_screeninfo *var)\r\n{\r\nint maxyres = ivideo->sisfb_mem / (var->xres_virtual * (var->bits_per_pixel >> 3));\r\nif(maxyres > 32767) maxyres = 32767;\r\nreturn maxyres;\r\n}\r\nstatic void\r\nsisfb_calc_pitch(struct sis_video_info *ivideo, struct fb_var_screeninfo *var)\r\n{\r\nivideo->video_linelength = var->xres_virtual * (var->bits_per_pixel >> 3);\r\nivideo->scrnpitchCRT1 = ivideo->video_linelength;\r\nif(!(ivideo->currentvbflags & CRT1_LCDA)) {\r\nif((var->vmode & FB_VMODE_MASK) == FB_VMODE_INTERLACED) {\r\nivideo->scrnpitchCRT1 <<= 1;\r\n}\r\n}\r\n}\r\nstatic void\r\nsisfb_set_pitch(struct sis_video_info *ivideo)\r\n{\r\nbool isslavemode = false;\r\nunsigned short HDisplay1 = ivideo->scrnpitchCRT1 >> 3;\r\nunsigned short HDisplay2 = ivideo->video_linelength >> 3;\r\nif(sisfb_bridgeisslave(ivideo)) isslavemode = true;\r\nif((ivideo->currentvbflags & VB_DISPTYPE_DISP1) || (isslavemode)) {\r\nSiS_SetReg(SISCR, 0x13, (HDisplay1 & 0xFF));\r\nSiS_SetRegANDOR(SISSR, 0x0E, 0xF0, (HDisplay1 >> 8));\r\n}\r\nif((ivideo->currentvbflags & VB_DISPTYPE_DISP2) && (!isslavemode)) {\r\nSiS_SetRegOR(SISPART1, ivideo->CRT2_write_enable, 0x01);\r\nSiS_SetReg(SISPART1, 0x07, (HDisplay2 & 0xFF));\r\nSiS_SetRegANDOR(SISPART1, 0x09, 0xF0, (HDisplay2 >> 8));\r\n}\r\n}\r\nstatic void\r\nsisfb_bpp_to_var(struct sis_video_info *ivideo, struct fb_var_screeninfo *var)\r\n{\r\nivideo->video_cmap_len = sisfb_get_cmap_len(var);\r\nswitch(var->bits_per_pixel) {\r\ncase 8:\r\nvar->red.offset = var->green.offset = var->blue.offset = 0;\r\nvar->red.length = var->green.length = var->blue.length = 8;\r\nbreak;\r\ncase 16:\r\nvar->red.offset = 11;\r\nvar->red.length = 5;\r\nvar->green.offset = 5;\r\nvar->green.length = 6;\r\nvar->blue.offset = 0;\r\nvar->blue.length = 5;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nbreak;\r\ncase 32:\r\nvar->red.offset = 16;\r\nvar->red.length = 8;\r\nvar->green.offset = 8;\r\nvar->green.length = 8;\r\nvar->blue.offset = 0;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 24;\r\nvar->transp.length = 8;\r\nbreak;\r\n}\r\n}\r\nstatic int\r\nsisfb_set_mode(struct sis_video_info *ivideo, int clrscrn)\r\n{\r\nunsigned short modeno = ivideo->mode_no;\r\nmodeno |= 0x80;\r\nSiS_SetReg(SISSR, IND_SIS_PASSWORD, SIS_PASSWORD);\r\nsisfb_pre_setmode(ivideo);\r\nif(!SiSSetMode(&ivideo->SiS_Pr, modeno)) {\r\nprintk(KERN_ERR "sisfb: Setting mode[0x%x] failed\n", ivideo->mode_no);\r\nreturn -EINVAL;\r\n}\r\nSiS_SetReg(SISSR, IND_SIS_PASSWORD, SIS_PASSWORD);\r\nsisfb_post_setmode(ivideo);\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_do_set_var(struct fb_var_screeninfo *var, int isactive, struct fb_info *info)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nunsigned int htotal = 0, vtotal = 0;\r\nunsigned int drate = 0, hrate = 0;\r\nint found_mode = 0, ret;\r\nint old_mode;\r\nu32 pixclock;\r\nhtotal = var->left_margin + var->xres + var->right_margin + var->hsync_len;\r\nvtotal = var->upper_margin + var->lower_margin + var->vsync_len;\r\npixclock = var->pixclock;\r\nif((var->vmode & FB_VMODE_MASK) == FB_VMODE_NONINTERLACED) {\r\nvtotal += var->yres;\r\nvtotal <<= 1;\r\n} else if((var->vmode & FB_VMODE_MASK) == FB_VMODE_DOUBLE) {\r\nvtotal += var->yres;\r\nvtotal <<= 2;\r\n} else if((var->vmode & FB_VMODE_MASK) == FB_VMODE_INTERLACED) {\r\nvtotal += var->yres;\r\nvtotal <<= 1;\r\n} else vtotal += var->yres;\r\nif(!(htotal) || !(vtotal)) {\r\nDPRINTK("sisfb: Invalid 'var' information\n");\r\nreturn -EINVAL;\r\n}\r\nif(pixclock && htotal && vtotal) {\r\ndrate = 1000000000 / pixclock;\r\nhrate = (drate * 1000) / htotal;\r\nivideo->refresh_rate = (unsigned int) (hrate * 2 / vtotal);\r\n} else {\r\nivideo->refresh_rate = 60;\r\n}\r\nold_mode = ivideo->sisfb_mode_idx;\r\nivideo->sisfb_mode_idx = 0;\r\nwhile( (sisbios_mode[ivideo->sisfb_mode_idx].mode_no[0] != 0) &&\r\n(sisbios_mode[ivideo->sisfb_mode_idx].xres <= var->xres) ) {\r\nif( (sisbios_mode[ivideo->sisfb_mode_idx].xres == var->xres) &&\r\n(sisbios_mode[ivideo->sisfb_mode_idx].yres == var->yres) &&\r\n(sisbios_mode[ivideo->sisfb_mode_idx].bpp == var->bits_per_pixel)) {\r\nivideo->mode_no = sisbios_mode[ivideo->sisfb_mode_idx].mode_no[ivideo->mni];\r\nfound_mode = 1;\r\nbreak;\r\n}\r\nivideo->sisfb_mode_idx++;\r\n}\r\nif(found_mode) {\r\nivideo->sisfb_mode_idx = sisfb_validate_mode(ivideo,\r\nivideo->sisfb_mode_idx, ivideo->currentvbflags);\r\n} else {\r\nivideo->sisfb_mode_idx = -1;\r\n}\r\nif(ivideo->sisfb_mode_idx < 0) {\r\nprintk(KERN_ERR "sisfb: Mode %dx%dx%d not supported\n", var->xres,\r\nvar->yres, var->bits_per_pixel);\r\nivideo->sisfb_mode_idx = old_mode;\r\nreturn -EINVAL;\r\n}\r\nivideo->mode_no = sisbios_mode[ivideo->sisfb_mode_idx].mode_no[ivideo->mni];\r\nif(sisfb_search_refresh_rate(ivideo, ivideo->refresh_rate, ivideo->sisfb_mode_idx) == 0) {\r\nivideo->rate_idx = sisbios_mode[ivideo->sisfb_mode_idx].rate_idx;\r\nivideo->refresh_rate = 60;\r\n}\r\nif(isactive) {\r\nivideo->accel = 0;\r\n#if defined(FBINFO_HWACCEL_DISABLED) && defined(FBINFO_HWACCEL_XPAN)\r\n#ifdef STUPID_ACCELF_TEXT_SHIT\r\nif(var->accel_flags & FB_ACCELF_TEXT) {\r\ninfo->flags &= ~FBINFO_HWACCEL_DISABLED;\r\n} else {\r\ninfo->flags |= FBINFO_HWACCEL_DISABLED;\r\n}\r\n#endif\r\nif(!(info->flags & FBINFO_HWACCEL_DISABLED)) ivideo->accel = -1;\r\n#else\r\nif(var->accel_flags & FB_ACCELF_TEXT) ivideo->accel = -1;\r\n#endif\r\nif((ret = sisfb_set_mode(ivideo, 1))) {\r\nreturn ret;\r\n}\r\nivideo->video_bpp = sisbios_mode[ivideo->sisfb_mode_idx].bpp;\r\nivideo->video_width = sisbios_mode[ivideo->sisfb_mode_idx].xres;\r\nivideo->video_height = sisbios_mode[ivideo->sisfb_mode_idx].yres;\r\nsisfb_calc_pitch(ivideo, var);\r\nsisfb_set_pitch(ivideo);\r\nsisfb_set_vparms(ivideo);\r\nivideo->current_width = ivideo->video_width;\r\nivideo->current_height = ivideo->video_height;\r\nivideo->current_bpp = ivideo->video_bpp;\r\nivideo->current_htotal = htotal;\r\nivideo->current_vtotal = vtotal;\r\nivideo->current_linelength = ivideo->video_linelength;\r\nivideo->current_pixclock = var->pixclock;\r\nivideo->current_refresh_rate = ivideo->refresh_rate;\r\nivideo->sisfb_lastrates[ivideo->mode_no] = ivideo->refresh_rate;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nsisfb_set_base_CRT1(struct sis_video_info *ivideo, unsigned int base)\r\n{\r\nSiS_SetReg(SISSR, IND_SIS_PASSWORD, SIS_PASSWORD);\r\nSiS_SetReg(SISCR, 0x0D, base & 0xFF);\r\nSiS_SetReg(SISCR, 0x0C, (base >> 8) & 0xFF);\r\nSiS_SetReg(SISSR, 0x0D, (base >> 16) & 0xFF);\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nSiS_SetRegANDOR(SISSR, 0x37, 0xFE, (base >> 24) & 0x01);\r\n}\r\n}\r\nstatic void\r\nsisfb_set_base_CRT2(struct sis_video_info *ivideo, unsigned int base)\r\n{\r\nif(ivideo->currentvbflags & VB_DISPTYPE_DISP2) {\r\nSiS_SetRegOR(SISPART1, ivideo->CRT2_write_enable, 0x01);\r\nSiS_SetReg(SISPART1, 0x06, (base & 0xFF));\r\nSiS_SetReg(SISPART1, 0x05, ((base >> 8) & 0xFF));\r\nSiS_SetReg(SISPART1, 0x04, ((base >> 16) & 0xFF));\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nSiS_SetRegANDOR(SISPART1, 0x02, 0x7F, ((base >> 24) & 0x01) << 7);\r\n}\r\n}\r\n}\r\nstatic int\r\nsisfb_pan_var(struct sis_video_info *ivideo, struct fb_info *info,\r\nstruct fb_var_screeninfo *var)\r\n{\r\nivideo->current_base = var->yoffset * info->var.xres_virtual\r\n+ var->xoffset;\r\nswitch (info->var.bits_per_pixel) {\r\ncase 32:\r\nbreak;\r\ncase 16:\r\nivideo->current_base >>= 1;\r\nbreak;\r\ncase 8:\r\ndefault:\r\nivideo->current_base >>= 2;\r\nbreak;\r\n}\r\nivideo->current_base += (ivideo->video_offset >> 2);\r\nsisfb_set_base_CRT1(ivideo, ivideo->current_base);\r\nsisfb_set_base_CRT2(ivideo, ivideo->current_base);\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_open(struct fb_info *info, int user)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_release(struct fb_info *info, int user)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_setcolreg(unsigned regno, unsigned red, unsigned green, unsigned blue,\r\nunsigned transp, struct fb_info *info)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nif(regno >= sisfb_get_cmap_len(&info->var))\r\nreturn 1;\r\nswitch(info->var.bits_per_pixel) {\r\ncase 8:\r\nSiS_SetRegByte(SISDACA, regno);\r\nSiS_SetRegByte(SISDACD, (red >> 10));\r\nSiS_SetRegByte(SISDACD, (green >> 10));\r\nSiS_SetRegByte(SISDACD, (blue >> 10));\r\nif(ivideo->currentvbflags & VB_DISPTYPE_DISP2) {\r\nSiS_SetRegByte(SISDAC2A, regno);\r\nSiS_SetRegByte(SISDAC2D, (red >> 8));\r\nSiS_SetRegByte(SISDAC2D, (green >> 8));\r\nSiS_SetRegByte(SISDAC2D, (blue >> 8));\r\n}\r\nbreak;\r\ncase 16:\r\nif (regno >= 16)\r\nbreak;\r\n((u32 *)(info->pseudo_palette))[regno] =\r\n(red & 0xf800) |\r\n((green & 0xfc00) >> 5) |\r\n((blue & 0xf800) >> 11);\r\nbreak;\r\ncase 32:\r\nif (regno >= 16)\r\nbreak;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\n((u32 *)(info->pseudo_palette))[regno] =\r\n(red << 16) | (green << 8) | (blue);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_set_par(struct fb_info *info)\r\n{\r\nint err;\r\nif((err = sisfb_do_set_var(&info->var, 1, info)))\r\nreturn err;\r\nsisfb_get_fix(&info->fix, -1, info);\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_check_var(struct fb_var_screeninfo *var, struct fb_info *info)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nunsigned int htotal = 0, vtotal = 0, myrateindex = 0;\r\nunsigned int drate = 0, hrate = 0, maxyres;\r\nint found_mode = 0;\r\nint refresh_rate, search_idx, tidx;\r\nbool recalc_clock = false;\r\nu32 pixclock;\r\nhtotal = var->left_margin + var->xres + var->right_margin + var->hsync_len;\r\nvtotal = var->upper_margin + var->lower_margin + var->vsync_len;\r\npixclock = var->pixclock;\r\nif((var->vmode & FB_VMODE_MASK) == FB_VMODE_NONINTERLACED) {\r\nvtotal += var->yres;\r\nvtotal <<= 1;\r\n} else if((var->vmode & FB_VMODE_MASK) == FB_VMODE_DOUBLE) {\r\nvtotal += var->yres;\r\nvtotal <<= 2;\r\n} else if((var->vmode & FB_VMODE_MASK) == FB_VMODE_INTERLACED) {\r\nvtotal += var->yres;\r\nvtotal <<= 1;\r\n} else\r\nvtotal += var->yres;\r\nif(!(htotal) || !(vtotal)) {\r\nSISFAIL("sisfb: no valid timing data");\r\n}\r\nsearch_idx = 0;\r\nwhile( (sisbios_mode[search_idx].mode_no[0] != 0) &&\r\n(sisbios_mode[search_idx].xres <= var->xres) ) {\r\nif( (sisbios_mode[search_idx].xres == var->xres) &&\r\n(sisbios_mode[search_idx].yres == var->yres) &&\r\n(sisbios_mode[search_idx].bpp == var->bits_per_pixel)) {\r\nif((tidx = sisfb_validate_mode(ivideo, search_idx,\r\nivideo->currentvbflags)) > 0) {\r\nfound_mode = 1;\r\nsearch_idx = tidx;\r\nbreak;\r\n}\r\n}\r\nsearch_idx++;\r\n}\r\nif(!found_mode) {\r\nsearch_idx = 0;\r\nwhile(sisbios_mode[search_idx].mode_no[0] != 0) {\r\nif( (var->xres <= sisbios_mode[search_idx].xres) &&\r\n(var->yres <= sisbios_mode[search_idx].yres) &&\r\n(var->bits_per_pixel == sisbios_mode[search_idx].bpp) ) {\r\nif((tidx = sisfb_validate_mode(ivideo,search_idx,\r\nivideo->currentvbflags)) > 0) {\r\nfound_mode = 1;\r\nsearch_idx = tidx;\r\nbreak;\r\n}\r\n}\r\nsearch_idx++;\r\n}\r\nif(found_mode) {\r\nprintk(KERN_DEBUG\r\n"sisfb: Adapted from %dx%dx%d to %dx%dx%d\n",\r\nvar->xres, var->yres, var->bits_per_pixel,\r\nsisbios_mode[search_idx].xres,\r\nsisbios_mode[search_idx].yres,\r\nvar->bits_per_pixel);\r\nvar->xres = sisbios_mode[search_idx].xres;\r\nvar->yres = sisbios_mode[search_idx].yres;\r\n} else {\r\nprintk(KERN_ERR\r\n"sisfb: Failed to find supported mode near %dx%dx%d\n",\r\nvar->xres, var->yres, var->bits_per_pixel);\r\nreturn -EINVAL;\r\n}\r\n}\r\nif( ((ivideo->vbflags2 & VB2_LVDS) ||\r\n((ivideo->vbflags2 & VB2_30xBDH) && (ivideo->currentvbflags & CRT2_LCD))) &&\r\n(var->bits_per_pixel == 8) ) {\r\nrefresh_rate = 60;\r\nrecalc_clock = true;\r\n} else if( (ivideo->current_htotal == htotal) &&\r\n(ivideo->current_vtotal == vtotal) &&\r\n(ivideo->current_pixclock == pixclock) ) {\r\ndrate = 1000000000 / pixclock;\r\nhrate = (drate * 1000) / htotal;\r\nrefresh_rate = (unsigned int) (hrate * 2 / vtotal);\r\n} else if( ( (ivideo->current_htotal != htotal) ||\r\n(ivideo->current_vtotal != vtotal) ) &&\r\n(ivideo->current_pixclock == var->pixclock) ) {\r\nif(ivideo->sisfb_lastrates[sisbios_mode[search_idx].mode_no[ivideo->mni]]) {\r\nrefresh_rate =\r\nivideo->sisfb_lastrates[sisbios_mode[search_idx].mode_no[ivideo->mni]];\r\n} else if(ivideo->sisfb_parm_rate != -1) {\r\nrefresh_rate = ivideo->sisfb_parm_rate;\r\n} else {\r\nrefresh_rate = 60;\r\n}\r\nrecalc_clock = true;\r\n} else if((pixclock) && (htotal) && (vtotal)) {\r\ndrate = 1000000000 / pixclock;\r\nhrate = (drate * 1000) / htotal;\r\nrefresh_rate = (unsigned int) (hrate * 2 / vtotal);\r\n} else if(ivideo->current_refresh_rate) {\r\nrefresh_rate = ivideo->current_refresh_rate;\r\nrecalc_clock = true;\r\n} else {\r\nrefresh_rate = 60;\r\nrecalc_clock = true;\r\n}\r\nmyrateindex = sisfb_search_refresh_rate(ivideo, refresh_rate, search_idx);\r\nif(recalc_clock) {\r\nif(!myrateindex) myrateindex = sisbios_mode[search_idx].rate_idx;\r\nvar->pixclock = (u32) (1000000000 / sisfb_mode_rate_to_dclock(&ivideo->SiS_Pr,\r\nsisbios_mode[search_idx].mode_no[ivideo->mni],\r\nmyrateindex));\r\nsisfb_mode_rate_to_ddata(&ivideo->SiS_Pr,\r\nsisbios_mode[search_idx].mode_no[ivideo->mni],\r\nmyrateindex, var);\r\nif((var->vmode & FB_VMODE_MASK) == FB_VMODE_DOUBLE) {\r\nvar->pixclock <<= 1;\r\n}\r\n}\r\nif(ivideo->sisfb_thismonitor.datavalid) {\r\nif(!sisfb_verify_rate(ivideo, &ivideo->sisfb_thismonitor, search_idx,\r\nmyrateindex, refresh_rate)) {\r\nprintk(KERN_INFO\r\n"sisfb: WARNING: Refresh rate exceeds monitor specs!\n");\r\n}\r\n}\r\nsisfb_bpp_to_var(ivideo, var);\r\nif(var->xoffset < 0) var->xoffset = 0;\r\nif(var->yoffset < 0) var->yoffset = 0;\r\nif(var->xres > var->xres_virtual)\r\nvar->xres_virtual = var->xres;\r\nif(ivideo->sisfb_ypan) {\r\nmaxyres = sisfb_calc_maxyres(ivideo, var);\r\nif(ivideo->sisfb_max) {\r\nvar->yres_virtual = maxyres;\r\n} else {\r\nif(var->yres_virtual > maxyres) {\r\nvar->yres_virtual = maxyres;\r\n}\r\n}\r\nif(var->yres_virtual <= var->yres) {\r\nvar->yres_virtual = var->yres;\r\n}\r\n} else {\r\nif(var->yres != var->yres_virtual) {\r\nvar->yres_virtual = var->yres;\r\n}\r\nvar->xoffset = 0;\r\nvar->yoffset = 0;\r\n}\r\nif(var->xoffset > var->xres_virtual - var->xres) {\r\nvar->xoffset = var->xres_virtual - var->xres - 1;\r\n}\r\nif(var->yoffset > var->yres_virtual - var->yres) {\r\nvar->yoffset = var->yres_virtual - var->yres - 1;\r\n}\r\nvar->red.msb_right =\r\nvar->green.msb_right =\r\nvar->blue.msb_right =\r\nvar->transp.offset =\r\nvar->transp.length =\r\nvar->transp.msb_right = 0;\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_pan_display(struct fb_var_screeninfo *var, struct fb_info* info)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nint err;\r\nif (var->vmode & FB_VMODE_YWRAP)\r\nreturn -EINVAL;\r\nif (var->xoffset + info->var.xres > info->var.xres_virtual ||\r\nvar->yoffset + info->var.yres > info->var.yres_virtual)\r\nreturn -EINVAL;\r\nerr = sisfb_pan_var(ivideo, info, var);\r\nif (err < 0)\r\nreturn err;\r\ninfo->var.xoffset = var->xoffset;\r\ninfo->var.yoffset = var->yoffset;\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_blank(int blank, struct fb_info *info)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nreturn sisfb_myblank(ivideo, blank);\r\n}\r\nstatic int sisfb_ioctl(struct fb_info *info, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nstruct sis_memreq sismemreq;\r\nstruct fb_vblank sisvbblank;\r\nu32 gpu32 = 0;\r\n#ifndef __user\r\n#define __user\r\n#endif\r\nu32 __user *argp = (u32 __user *)arg;\r\nswitch(cmd) {\r\ncase FBIO_ALLOC:\r\nif(!capable(CAP_SYS_RAWIO))\r\nreturn -EPERM;\r\nif(copy_from_user(&sismemreq, (void __user *)arg, sizeof(sismemreq)))\r\nreturn -EFAULT;\r\nsis_malloc(&sismemreq);\r\nif(copy_to_user((void __user *)arg, &sismemreq, sizeof(sismemreq))) {\r\nsis_free((u32)sismemreq.offset);\r\nreturn -EFAULT;\r\n}\r\nbreak;\r\ncase FBIO_FREE:\r\nif(!capable(CAP_SYS_RAWIO))\r\nreturn -EPERM;\r\nif(get_user(gpu32, argp))\r\nreturn -EFAULT;\r\nsis_free(gpu32);\r\nbreak;\r\ncase FBIOGET_VBLANK:\r\nmemset(&sisvbblank, 0, sizeof(struct fb_vblank));\r\nsisvbblank.count = 0;\r\nsisvbblank.flags = sisfb_setupvbblankflags(ivideo, &sisvbblank.vcount, &sisvbblank.hcount);\r\nif(copy_to_user((void __user *)arg, &sisvbblank, sizeof(sisvbblank)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase SISFB_GET_INFO_SIZE:\r\nreturn put_user(sizeof(struct sisfb_info), argp);\r\ncase SISFB_GET_INFO_OLD:\r\nif(ivideo->warncount++ < 10)\r\nprintk(KERN_INFO\r\n"sisfb: Deprecated ioctl call received - update your application!\n");\r\ncase SISFB_GET_INFO:\r\nivideo->sisfb_infoblock.sisfb_id = SISFB_ID;\r\nivideo->sisfb_infoblock.sisfb_version = VER_MAJOR;\r\nivideo->sisfb_infoblock.sisfb_revision = VER_MINOR;\r\nivideo->sisfb_infoblock.sisfb_patchlevel = VER_LEVEL;\r\nivideo->sisfb_infoblock.chip_id = ivideo->chip_id;\r\nivideo->sisfb_infoblock.sisfb_pci_vendor = ivideo->chip_vendor;\r\nivideo->sisfb_infoblock.memory = ivideo->video_size / 1024;\r\nivideo->sisfb_infoblock.heapstart = ivideo->heapstart / 1024;\r\nif(ivideo->modechanged) {\r\nivideo->sisfb_infoblock.fbvidmode = ivideo->mode_no;\r\n} else {\r\nivideo->sisfb_infoblock.fbvidmode = ivideo->modeprechange;\r\n}\r\nivideo->sisfb_infoblock.sisfb_caps = ivideo->caps;\r\nivideo->sisfb_infoblock.sisfb_tqlen = ivideo->cmdQueueSize / 1024;\r\nivideo->sisfb_infoblock.sisfb_pcibus = ivideo->pcibus;\r\nivideo->sisfb_infoblock.sisfb_pcislot = ivideo->pcislot;\r\nivideo->sisfb_infoblock.sisfb_pcifunc = ivideo->pcifunc;\r\nivideo->sisfb_infoblock.sisfb_lcdpdc = ivideo->detectedpdc;\r\nivideo->sisfb_infoblock.sisfb_lcdpdca = ivideo->detectedpdca;\r\nivideo->sisfb_infoblock.sisfb_lcda = ivideo->detectedlcda;\r\nivideo->sisfb_infoblock.sisfb_vbflags = ivideo->vbflags;\r\nivideo->sisfb_infoblock.sisfb_currentvbflags = ivideo->currentvbflags;\r\nivideo->sisfb_infoblock.sisfb_scalelcd = ivideo->SiS_Pr.UsePanelScaler;\r\nivideo->sisfb_infoblock.sisfb_specialtiming = ivideo->SiS_Pr.SiS_CustomT;\r\nivideo->sisfb_infoblock.sisfb_haveemi = ivideo->SiS_Pr.HaveEMI ? 1 : 0;\r\nivideo->sisfb_infoblock.sisfb_haveemilcd = ivideo->SiS_Pr.HaveEMILCD ? 1 : 0;\r\nivideo->sisfb_infoblock.sisfb_emi30 = ivideo->SiS_Pr.EMI_30;\r\nivideo->sisfb_infoblock.sisfb_emi31 = ivideo->SiS_Pr.EMI_31;\r\nivideo->sisfb_infoblock.sisfb_emi32 = ivideo->SiS_Pr.EMI_32;\r\nivideo->sisfb_infoblock.sisfb_emi33 = ivideo->SiS_Pr.EMI_33;\r\nivideo->sisfb_infoblock.sisfb_tvxpos = (u16)(ivideo->tvxpos + 32);\r\nivideo->sisfb_infoblock.sisfb_tvypos = (u16)(ivideo->tvypos + 32);\r\nivideo->sisfb_infoblock.sisfb_heapsize = ivideo->sisfb_heap_size / 1024;\r\nivideo->sisfb_infoblock.sisfb_videooffset = ivideo->video_offset;\r\nivideo->sisfb_infoblock.sisfb_curfstn = ivideo->curFSTN;\r\nivideo->sisfb_infoblock.sisfb_curdstn = ivideo->curDSTN;\r\nivideo->sisfb_infoblock.sisfb_vbflags2 = ivideo->vbflags2;\r\nivideo->sisfb_infoblock.sisfb_can_post = ivideo->sisfb_can_post ? 1 : 0;\r\nivideo->sisfb_infoblock.sisfb_card_posted = ivideo->sisfb_card_posted ? 1 : 0;\r\nivideo->sisfb_infoblock.sisfb_was_boot_device = ivideo->sisfb_was_boot_device ? 1 : 0;\r\nif(copy_to_user((void __user *)arg, &ivideo->sisfb_infoblock,\r\nsizeof(ivideo->sisfb_infoblock)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase SISFB_GET_VBRSTATUS_OLD:\r\nif(ivideo->warncount++ < 10)\r\nprintk(KERN_INFO\r\n"sisfb: Deprecated ioctl call received - update your application!\n");\r\ncase SISFB_GET_VBRSTATUS:\r\nif(sisfb_CheckVBRetrace(ivideo))\r\nreturn put_user((u32)1, argp);\r\nelse\r\nreturn put_user((u32)0, argp);\r\ncase SISFB_GET_AUTOMAXIMIZE_OLD:\r\nif(ivideo->warncount++ < 10)\r\nprintk(KERN_INFO\r\n"sisfb: Deprecated ioctl call received - update your application!\n");\r\ncase SISFB_GET_AUTOMAXIMIZE:\r\nif(ivideo->sisfb_max)\r\nreturn put_user((u32)1, argp);\r\nelse\r\nreturn put_user((u32)0, argp);\r\ncase SISFB_SET_AUTOMAXIMIZE_OLD:\r\nif(ivideo->warncount++ < 10)\r\nprintk(KERN_INFO\r\n"sisfb: Deprecated ioctl call received - update your application!\n");\r\ncase SISFB_SET_AUTOMAXIMIZE:\r\nif(get_user(gpu32, argp))\r\nreturn -EFAULT;\r\nivideo->sisfb_max = (gpu32) ? 1 : 0;\r\nbreak;\r\ncase SISFB_SET_TVPOSOFFSET:\r\nif(get_user(gpu32, argp))\r\nreturn -EFAULT;\r\nsisfb_set_TVxposoffset(ivideo, ((int)(gpu32 >> 16)) - 32);\r\nsisfb_set_TVyposoffset(ivideo, ((int)(gpu32 & 0xffff)) - 32);\r\nbreak;\r\ncase SISFB_GET_TVPOSOFFSET:\r\nreturn put_user((u32)(((ivideo->tvxpos+32)<<16)|((ivideo->tvypos+32)&0xffff)),\r\nargp);\r\ncase SISFB_COMMAND:\r\nif(copy_from_user(&ivideo->sisfb_command, (void __user *)arg,\r\nsizeof(struct sisfb_cmd)))\r\nreturn -EFAULT;\r\nsisfb_handle_command(ivideo, &ivideo->sisfb_command);\r\nif(copy_to_user((void __user *)arg, &ivideo->sisfb_command,\r\nsizeof(struct sisfb_cmd)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase SISFB_SET_LOCK:\r\nif(get_user(gpu32, argp))\r\nreturn -EFAULT;\r\nivideo->sisfblocked = (gpu32) ? 1 : 0;\r\nbreak;\r\ndefault:\r\n#ifdef SIS_NEW_CONFIG_COMPAT\r\nreturn -ENOIOCTLCMD;\r\n#else\r\nreturn -EINVAL;\r\n#endif\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nsisfb_get_fix(struct fb_fix_screeninfo *fix, int con, struct fb_info *info)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nmemset(fix, 0, sizeof(struct fb_fix_screeninfo));\r\nstrlcpy(fix->id, ivideo->myid, sizeof(fix->id));\r\nmutex_lock(&info->mm_lock);\r\nfix->smem_start = ivideo->video_base + ivideo->video_offset;\r\nfix->smem_len = ivideo->sisfb_mem;\r\nmutex_unlock(&info->mm_lock);\r\nfix->type = FB_TYPE_PACKED_PIXELS;\r\nfix->type_aux = 0;\r\nfix->visual = (ivideo->video_bpp == 8) ? FB_VISUAL_PSEUDOCOLOR : FB_VISUAL_TRUECOLOR;\r\nfix->xpanstep = 1;\r\nfix->ypanstep = (ivideo->sisfb_ypan) ? 1 : 0;\r\nfix->ywrapstep = 0;\r\nfix->line_length = ivideo->video_linelength;\r\nfix->mmio_start = ivideo->mmio_base;\r\nfix->mmio_len = ivideo->mmio_size;\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nfix->accel = FB_ACCEL_SIS_GLAMOUR;\r\n} else if((ivideo->chip == SIS_330) ||\r\n(ivideo->chip == SIS_760) ||\r\n(ivideo->chip == SIS_761)) {\r\nfix->accel = FB_ACCEL_SIS_XABRE;\r\n} else if(ivideo->chip == XGI_20) {\r\nfix->accel = FB_ACCEL_XGI_VOLARI_Z;\r\n} else if(ivideo->chip >= XGI_40) {\r\nfix->accel = FB_ACCEL_XGI_VOLARI_V;\r\n} else {\r\nfix->accel = FB_ACCEL_SIS_GLAMOUR_2;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct pci_dev * __devinit\r\nsisfb_get_northbridge(int basechipid)\r\n{\r\nstruct pci_dev *pdev = NULL;\r\nint nbridgenum, nbridgeidx, i;\r\nstatic const unsigned short nbridgeids[] = {\r\nPCI_DEVICE_ID_SI_540,\r\nPCI_DEVICE_ID_SI_630,\r\nPCI_DEVICE_ID_SI_730,\r\nPCI_DEVICE_ID_SI_550,\r\nPCI_DEVICE_ID_SI_650,\r\nPCI_DEVICE_ID_SI_651,\r\nPCI_DEVICE_ID_SI_740,\r\nPCI_DEVICE_ID_SI_661,\r\nPCI_DEVICE_ID_SI_741,\r\nPCI_DEVICE_ID_SI_660,\r\nPCI_DEVICE_ID_SI_760,\r\nPCI_DEVICE_ID_SI_761\r\n};\r\nswitch(basechipid) {\r\n#ifdef CONFIG_FB_SIS_300\r\ncase SIS_540: nbridgeidx = 0; nbridgenum = 1; break;\r\ncase SIS_630: nbridgeidx = 1; nbridgenum = 2; break;\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\ncase SIS_550: nbridgeidx = 3; nbridgenum = 1; break;\r\ncase SIS_650: nbridgeidx = 4; nbridgenum = 3; break;\r\ncase SIS_660: nbridgeidx = 7; nbridgenum = 5; break;\r\n#endif\r\ndefault: return NULL;\r\n}\r\nfor(i = 0; i < nbridgenum; i++) {\r\nif((pdev = pci_get_device(PCI_VENDOR_ID_SI,\r\nnbridgeids[nbridgeidx+i], NULL)))\r\nbreak;\r\n}\r\nreturn pdev;\r\n}\r\nstatic int __devinit\r\nsisfb_get_dram_size(struct sis_video_info *ivideo)\r\n{\r\n#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)\r\nu8 reg;\r\n#endif\r\nivideo->video_size = 0;\r\nivideo->UMAsize = ivideo->LFBsize = 0;\r\nswitch(ivideo->chip) {\r\n#ifdef CONFIG_FB_SIS_300\r\ncase SIS_300:\r\nreg = SiS_GetReg(SISSR, 0x14);\r\nivideo->video_size = ((reg & 0x3F) + 1) << 20;\r\nbreak;\r\ncase SIS_540:\r\ncase SIS_630:\r\ncase SIS_730:\r\nif(!ivideo->nbridge)\r\nreturn -1;\r\npci_read_config_byte(ivideo->nbridge, 0x63, &reg);\r\nivideo->video_size = 1 << (((reg & 0x70) >> 4) + 21);\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\ncase SIS_315H:\r\ncase SIS_315PRO:\r\ncase SIS_315:\r\nreg = SiS_GetReg(SISSR, 0x14);\r\nivideo->video_size = (1 << ((reg & 0xf0) >> 4)) << 20;\r\nswitch((reg >> 2) & 0x03) {\r\ncase 0x01:\r\ncase 0x03:\r\nivideo->video_size <<= 1;\r\nbreak;\r\ncase 0x02:\r\nivideo->video_size += (ivideo->video_size/2);\r\n}\r\nbreak;\r\ncase SIS_330:\r\nreg = SiS_GetReg(SISSR, 0x14);\r\nivideo->video_size = (1 << ((reg & 0xf0) >> 4)) << 20;\r\nif(reg & 0x0c) ivideo->video_size <<= 1;\r\nbreak;\r\ncase SIS_550:\r\ncase SIS_650:\r\ncase SIS_740:\r\nreg = SiS_GetReg(SISSR, 0x14);\r\nivideo->video_size = (((reg & 0x3f) + 1) << 2) << 20;\r\nbreak;\r\ncase SIS_661:\r\ncase SIS_741:\r\nreg = SiS_GetReg(SISCR, 0x79);\r\nivideo->video_size = (1 << ((reg & 0xf0) >> 4)) << 20;\r\nbreak;\r\ncase SIS_660:\r\ncase SIS_760:\r\ncase SIS_761:\r\nreg = SiS_GetReg(SISCR, 0x79);\r\nreg = (reg & 0xf0) >> 4;\r\nif(reg) {\r\nivideo->video_size = (1 << reg) << 20;\r\nivideo->UMAsize = ivideo->video_size;\r\n}\r\nreg = SiS_GetReg(SISCR, 0x78);\r\nreg &= 0x30;\r\nif(reg) {\r\nif(reg == 0x10) {\r\nivideo->LFBsize = (32 << 20);\r\n} else {\r\nivideo->LFBsize = (64 << 20);\r\n}\r\nivideo->video_size += ivideo->LFBsize;\r\n}\r\nbreak;\r\ncase SIS_340:\r\ncase XGI_20:\r\ncase XGI_40:\r\nreg = SiS_GetReg(SISSR, 0x14);\r\nivideo->video_size = (1 << ((reg & 0xf0) >> 4)) << 20;\r\nif(ivideo->chip != XGI_20) {\r\nreg = (reg & 0x0c) >> 2;\r\nif(ivideo->revision_id == 2) {\r\nif(reg & 0x01) reg = 0x02;\r\nelse reg = 0x00;\r\n}\r\nif(reg == 0x02) ivideo->video_size <<= 1;\r\nelse if(reg == 0x03) ivideo->video_size <<= 2;\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __devinit\r\nsisfb_detect_VB_connect(struct sis_video_info *ivideo)\r\n{\r\nu8 cr32, temp;\r\nif(ivideo->chip == XGI_20) {\r\nivideo->sisfb_crt1off = 0;\r\nreturn;\r\n}\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\ntemp = SiS_GetReg(SISSR, 0x17);\r\nif((temp & 0x0F) && (ivideo->chip != SIS_300)) {\r\nif(!(ivideo->vbflags & (TV_PAL | TV_NTSC | TV_PALM | TV_PALN))) {\r\ntemp = SiS_GetReg(SISSR, 0x16);\r\nif(temp & 0x20)\r\nivideo->vbflags |= TV_PAL;\r\nelse\r\nivideo->vbflags |= TV_NTSC;\r\n}\r\n}\r\n}\r\n#endif\r\ncr32 = SiS_GetReg(SISCR, 0x32);\r\nif(cr32 & SIS_CRT1) {\r\nivideo->sisfb_crt1off = 0;\r\n} else {\r\nivideo->sisfb_crt1off = (cr32 & 0xDF) ? 1 : 0;\r\n}\r\nivideo->vbflags &= ~(CRT2_TV | CRT2_LCD | CRT2_VGA);\r\nif(cr32 & SIS_VB_TV) ivideo->vbflags |= CRT2_TV;\r\nif(cr32 & SIS_VB_LCD) ivideo->vbflags |= CRT2_LCD;\r\nif(cr32 & SIS_VB_CRT2) ivideo->vbflags |= CRT2_VGA;\r\nif(ivideo->chip != SIS_550) {\r\nivideo->sisfb_dstn = ivideo->sisfb_fstn = 0;\r\n}\r\nif(ivideo->sisfb_tvplug != -1) {\r\nif( (ivideo->sisvga_engine != SIS_315_VGA) ||\r\n(!(ivideo->vbflags2 & VB2_SISYPBPRBRIDGE)) ) {\r\nif(ivideo->sisfb_tvplug & TV_YPBPR) {\r\nivideo->sisfb_tvplug = -1;\r\nprintk(KERN_ERR "sisfb: YPbPr not supported\n");\r\n}\r\n}\r\n}\r\nif(ivideo->sisfb_tvplug != -1) {\r\nif( (ivideo->sisvga_engine != SIS_315_VGA) ||\r\n(!(ivideo->vbflags2 & VB2_SISHIVISIONBRIDGE)) ) {\r\nif(ivideo->sisfb_tvplug & TV_HIVISION) {\r\nivideo->sisfb_tvplug = -1;\r\nprintk(KERN_ERR "sisfb: HiVision not supported\n");\r\n}\r\n}\r\n}\r\nif(ivideo->sisfb_tvstd != -1) {\r\nif( (!(ivideo->vbflags2 & VB2_SISBRIDGE)) &&\r\n(!((ivideo->sisvga_engine == SIS_315_VGA) &&\r\n(ivideo->vbflags2 & VB2_CHRONTEL))) ) {\r\nif(ivideo->sisfb_tvstd & (TV_PALM | TV_PALN | TV_NTSCJ)) {\r\nivideo->sisfb_tvstd = -1;\r\nprintk(KERN_ERR "sisfb: PALM/PALN/NTSCJ not supported\n");\r\n}\r\n}\r\n}\r\nif(ivideo->sisfb_tvplug != -1) {\r\nivideo->vbflags |= ivideo->sisfb_tvplug;\r\n} else {\r\nif(cr32 & SIS_VB_YPBPR) ivideo->vbflags |= (TV_YPBPR|TV_YPBPR525I);\r\nelse if(cr32 & SIS_VB_HIVISION) ivideo->vbflags |= TV_HIVISION;\r\nelse if(cr32 & SIS_VB_SCART) ivideo->vbflags |= TV_SCART;\r\nelse {\r\nif(cr32 & SIS_VB_SVIDEO) ivideo->vbflags |= TV_SVIDEO;\r\nif(cr32 & SIS_VB_COMPOSITE) ivideo->vbflags |= TV_AVIDEO;\r\n}\r\n}\r\nif(!(ivideo->vbflags & (TV_YPBPR | TV_HIVISION))) {\r\nif(ivideo->sisfb_tvstd != -1) {\r\nivideo->vbflags &= ~(TV_NTSC | TV_PAL | TV_PALM | TV_PALN | TV_NTSCJ);\r\nivideo->vbflags |= ivideo->sisfb_tvstd;\r\n}\r\nif(ivideo->vbflags & TV_SCART) {\r\nivideo->vbflags &= ~(TV_NTSC | TV_PALM | TV_PALN | TV_NTSCJ);\r\nivideo->vbflags |= TV_PAL;\r\n}\r\nif(!(ivideo->vbflags & (TV_PAL | TV_NTSC | TV_PALM | TV_PALN | TV_NTSCJ))) {\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\ntemp = SiS_GetReg(SISSR, 0x38);\r\nif(temp & 0x01) ivideo->vbflags |= TV_PAL;\r\nelse ivideo->vbflags |= TV_NTSC;\r\n} else if((ivideo->chip <= SIS_315PRO) || (ivideo->chip >= SIS_330)) {\r\ntemp = SiS_GetReg(SISSR, 0x38);\r\nif(temp & 0x01) ivideo->vbflags |= TV_PAL;\r\nelse ivideo->vbflags |= TV_NTSC;\r\n} else {\r\ntemp = SiS_GetReg(SISCR, 0x79);\r\nif(temp & 0x20) ivideo->vbflags |= TV_PAL;\r\nelse ivideo->vbflags |= TV_NTSC;\r\n}\r\n}\r\n}\r\nif(ivideo->sisfb_forcecrt1 != -1) {\r\nivideo->sisfb_crt1off = (ivideo->sisfb_forcecrt1) ? 0 : 1;\r\n}\r\n}\r\nstatic bool __devinit\r\nsisfb_test_DDC1(struct sis_video_info *ivideo)\r\n{\r\nunsigned short old;\r\nint count = 48;\r\nold = SiS_ReadDDC1Bit(&ivideo->SiS_Pr);\r\ndo {\r\nif(old != SiS_ReadDDC1Bit(&ivideo->SiS_Pr)) break;\r\n} while(count--);\r\nreturn (count != -1);\r\n}\r\nstatic void __devinit\r\nsisfb_sense_crt1(struct sis_video_info *ivideo)\r\n{\r\nbool mustwait = false;\r\nu8 sr1F, cr17;\r\n#ifdef CONFIG_FB_SIS_315\r\nu8 cr63=0;\r\n#endif\r\nu16 temp = 0xffff;\r\nint i;\r\nsr1F = SiS_GetReg(SISSR, 0x1F);\r\nSiS_SetRegOR(SISSR, 0x1F, 0x04);\r\nSiS_SetRegAND(SISSR, 0x1F, 0x3F);\r\nif(sr1F & 0xc0) mustwait = true;\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\ncr63 = SiS_GetReg(SISCR, ivideo->SiS_Pr.SiS_MyCR63);\r\ncr63 &= 0x40;\r\nSiS_SetRegAND(SISCR, ivideo->SiS_Pr.SiS_MyCR63, 0xBF);\r\n}\r\n#endif\r\ncr17 = SiS_GetReg(SISCR, 0x17);\r\ncr17 &= 0x80;\r\nif(!cr17) {\r\nSiS_SetRegOR(SISCR, 0x17, 0x80);\r\nmustwait = true;\r\nSiS_SetReg(SISSR, 0x00, 0x01);\r\nSiS_SetReg(SISSR, 0x00, 0x03);\r\n}\r\nif(mustwait) {\r\nfor(i=0; i < 10; i++) sisfbwaitretracecrt1(ivideo);\r\n}\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->chip >= SIS_330) {\r\nSiS_SetRegAND(SISCR, 0x32, ~0x20);\r\nif(ivideo->chip >= SIS_340) {\r\nSiS_SetReg(SISCR, 0x57, 0x4a);\r\n} else {\r\nSiS_SetReg(SISCR, 0x57, 0x5f);\r\n}\r\nSiS_SetRegOR(SISCR, 0x53, 0x02);\r\nwhile ((SiS_GetRegByte(SISINPSTAT)) & 0x01) break;\r\nwhile (!((SiS_GetRegByte(SISINPSTAT)) & 0x01)) break;\r\nif ((SiS_GetRegByte(SISMISCW)) & 0x10) temp = 1;\r\nSiS_SetRegAND(SISCR, 0x53, 0xfd);\r\nSiS_SetRegAND(SISCR, 0x57, 0x00);\r\n}\r\n#endif\r\nif(temp == 0xffff) {\r\ni = 3;\r\ndo {\r\ntemp = SiS_HandleDDC(&ivideo->SiS_Pr, ivideo->vbflags,\r\nivideo->sisvga_engine, 0, 0, NULL, ivideo->vbflags2);\r\n} while(((temp == 0) || (temp == 0xffff)) && i--);\r\nif((temp == 0) || (temp == 0xffff)) {\r\nif(sisfb_test_DDC1(ivideo)) temp = 1;\r\n}\r\n}\r\nif((temp) && (temp != 0xffff)) {\r\nSiS_SetRegOR(SISCR, 0x32, 0x20);\r\n}\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nSiS_SetRegANDOR(SISCR, ivideo->SiS_Pr.SiS_MyCR63, 0xBF, cr63);\r\n}\r\n#endif\r\nSiS_SetRegANDOR(SISCR, 0x17, 0x7F, cr17);\r\nSiS_SetReg(SISSR, 0x1F, sr1F);\r\n}\r\nstatic void __devinit\r\nSiS_SenseLCD(struct sis_video_info *ivideo)\r\n{\r\nunsigned char buffer[256];\r\nunsigned short temp, realcrtno, i;\r\nu8 reg, cr37 = 0, paneltype = 0;\r\nu16 xres, yres;\r\nivideo->SiS_Pr.PanelSelfDetected = false;\r\nif(!(ivideo->vbflags2 & VB2_SISTMDSBRIDGE))\r\nreturn;\r\nif(ivideo->vbflags2 & VB2_30xBDH)\r\nreturn;\r\nreg = SiS_GetReg(SISCR, 0x32);\r\nif(reg & 0x08)\r\nreturn;\r\nrealcrtno = 1;\r\nif(ivideo->SiS_Pr.DDCPortMixup)\r\nrealcrtno = 0;\r\ntemp = SiS_HandleDDC(&ivideo->SiS_Pr, ivideo->vbflags, ivideo->sisvga_engine,\r\nrealcrtno, 0, &buffer[0], ivideo->vbflags2);\r\nif((!temp) || (temp == 0xffff) || (!(temp & 0x02)))\r\nreturn;\r\ni = 3;\r\ndo {\r\ntemp = SiS_HandleDDC(&ivideo->SiS_Pr, ivideo->vbflags,\r\nivideo->sisvga_engine, realcrtno, 1,\r\n&buffer[0], ivideo->vbflags2);\r\n} while((temp) && i--);\r\nif(temp)\r\nreturn;\r\nif(!(buffer[0x14] & 0x80))\r\nreturn;\r\nif(!(buffer[0x18] & 0x02))\r\nreturn;\r\nxres = buffer[0x38] | ((buffer[0x3a] & 0xf0) << 4);\r\nyres = buffer[0x3b] | ((buffer[0x3d] & 0xf0) << 4);\r\nswitch(xres) {\r\ncase 1024:\r\nif(yres == 768)\r\npaneltype = 0x02;\r\nbreak;\r\ncase 1280:\r\nif(yres == 1024)\r\npaneltype = 0x03;\r\nbreak;\r\ncase 1600:\r\nif((yres == 1200) && (ivideo->vbflags2 & VB2_30xC))\r\npaneltype = 0x0b;\r\nbreak;\r\n}\r\nif(!paneltype)\r\nreturn;\r\nif(buffer[0x23])\r\ncr37 |= 0x10;\r\nif((buffer[0x47] & 0x18) == 0x18)\r\ncr37 |= ((((buffer[0x47] & 0x06) ^ 0x06) << 5) | 0x20);\r\nelse\r\ncr37 |= 0xc0;\r\nSiS_SetReg(SISCR, 0x36, paneltype);\r\ncr37 &= 0xf1;\r\nSiS_SetRegANDOR(SISCR, 0x37, 0x0c, cr37);\r\nSiS_SetRegOR(SISCR, 0x32, 0x08);\r\nivideo->SiS_Pr.PanelSelfDetected = true;\r\n}\r\nstatic int __devinit\r\nSISDoSense(struct sis_video_info *ivideo, u16 type, u16 test)\r\n{\r\nint temp, mytest, result, i, j;\r\nfor(j = 0; j < 10; j++) {\r\nresult = 0;\r\nfor(i = 0; i < 3; i++) {\r\nmytest = test;\r\nSiS_SetReg(SISPART4, 0x11, (type & 0x00ff));\r\ntemp = (type >> 8) | (mytest & 0x00ff);\r\nSiS_SetRegANDOR(SISPART4, 0x10, 0xe0, temp);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x1500);\r\nmytest >>= 8;\r\nmytest &= 0x7f;\r\ntemp = SiS_GetReg(SISPART4, 0x03);\r\ntemp ^= 0x0e;\r\ntemp &= mytest;\r\nif(temp == mytest) result++;\r\n#if 1\r\nSiS_SetReg(SISPART4, 0x11, 0x00);\r\nSiS_SetRegAND(SISPART4, 0x10, 0xe0);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x1000);\r\n#endif\r\n}\r\nif((result == 0) || (result >= 2)) break;\r\n}\r\nreturn result;\r\n}\r\nstatic void __devinit\r\nSiS_Sense30x(struct sis_video_info *ivideo)\r\n{\r\nu8 backupP4_0d,backupP2_00,backupP2_4d,backupSR_1e,biosflag=0;\r\nu16 svhs=0, svhs_c=0;\r\nu16 cvbs=0, cvbs_c=0;\r\nu16 vga2=0, vga2_c=0;\r\nint myflag, result;\r\nchar stdstr[] = "sisfb: Detected";\r\nchar tvstr[] = "TV connected to";\r\nif(ivideo->vbflags2 & VB2_301) {\r\nsvhs = 0x00b9; cvbs = 0x00b3; vga2 = 0x00d1;\r\nmyflag = SiS_GetReg(SISPART4, 0x01);\r\nif(myflag & 0x04) {\r\nsvhs = 0x00dd; cvbs = 0x00ee; vga2 = 0x00fd;\r\n}\r\n} else if(ivideo->vbflags2 & (VB2_301B | VB2_302B)) {\r\nsvhs = 0x016b; cvbs = 0x0174; vga2 = 0x0190;\r\n} else if(ivideo->vbflags2 & (VB2_301LV | VB2_302LV)) {\r\nsvhs = 0x0200; cvbs = 0x0100;\r\n} else if(ivideo->vbflags2 & (VB2_301C | VB2_302ELV | VB2_307T | VB2_307LV)) {\r\nsvhs = 0x016b; cvbs = 0x0110; vga2 = 0x0190;\r\n} else\r\nreturn;\r\nvga2_c = 0x0e08; svhs_c = 0x0404; cvbs_c = 0x0804;\r\nif(ivideo->vbflags & (VB2_301LV|VB2_302LV|VB2_302ELV|VB2_307LV)) {\r\nsvhs_c = 0x0408; cvbs_c = 0x0808;\r\n}\r\nbiosflag = 2;\r\nif(ivideo->haveXGIROM) {\r\nbiosflag = ivideo->bios_abase[0x58] & 0x03;\r\n} else if(ivideo->newrom) {\r\nif(ivideo->bios_abase[0x5d] & 0x04) biosflag |= 0x01;\r\n} else if(ivideo->sisvga_engine == SIS_300_VGA) {\r\nif(ivideo->bios_abase) {\r\nbiosflag = ivideo->bios_abase[0xfe] & 0x03;\r\n}\r\n}\r\nif(ivideo->chip == SIS_300) {\r\nmyflag = SiS_GetReg(SISSR, 0x3b);\r\nif(!(myflag & 0x01)) vga2 = vga2_c = 0;\r\n}\r\nif(!(ivideo->vbflags2 & VB2_SISVGA2BRIDGE)) {\r\nvga2 = vga2_c = 0;\r\n}\r\nbackupSR_1e = SiS_GetReg(SISSR, 0x1e);\r\nSiS_SetRegOR(SISSR, 0x1e, 0x20);\r\nbackupP4_0d = SiS_GetReg(SISPART4, 0x0d);\r\nif(ivideo->vbflags2 & VB2_30xC) {\r\nSiS_SetRegANDOR(SISPART4, 0x0d, ~0x07, 0x01);\r\n} else {\r\nSiS_SetRegOR(SISPART4, 0x0d, 0x04);\r\n}\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x2000);\r\nbackupP2_00 = SiS_GetReg(SISPART2, 0x00);\r\nSiS_SetReg(SISPART2, 0x00, ((backupP2_00 | 0x1c) & 0xfc));\r\nbackupP2_4d = SiS_GetReg(SISPART2, 0x4d);\r\nif(ivideo->vbflags2 & VB2_SISYPBPRBRIDGE) {\r\nSiS_SetReg(SISPART2, 0x4d, (backupP2_4d & ~0x10));\r\n}\r\nif(!(ivideo->vbflags2 & VB2_30xCLV)) {\r\nSISDoSense(ivideo, 0, 0);\r\n}\r\nSiS_SetRegAND(SISCR, 0x32, ~0x14);\r\nif(vga2_c || vga2) {\r\nif(SISDoSense(ivideo, vga2, vga2_c)) {\r\nif(biosflag & 0x01) {\r\nprintk(KERN_INFO "%s %s SCART output\n", stdstr, tvstr);\r\nSiS_SetRegOR(SISCR, 0x32, 0x04);\r\n} else {\r\nprintk(KERN_INFO "%s secondary VGA connection\n", stdstr);\r\nSiS_SetRegOR(SISCR, 0x32, 0x10);\r\n}\r\n}\r\n}\r\nSiS_SetRegAND(SISCR, 0x32, 0x3f);\r\nif(ivideo->vbflags2 & VB2_30xCLV) {\r\nSiS_SetRegOR(SISPART4, 0x0d, 0x04);\r\n}\r\nif((ivideo->sisvga_engine == SIS_315_VGA) && (ivideo->vbflags2 & VB2_SISYPBPRBRIDGE)) {\r\nSiS_SetReg(SISPART2, 0x4d, (backupP2_4d | 0x10));\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x2000);\r\nif((result = SISDoSense(ivideo, svhs, 0x0604))) {\r\nif((result = SISDoSense(ivideo, cvbs, 0x0804))) {\r\nprintk(KERN_INFO "%s %s YPbPr component output\n", stdstr, tvstr);\r\nSiS_SetRegOR(SISCR, 0x32, 0x80);\r\n}\r\n}\r\nSiS_SetReg(SISPART2, 0x4d, backupP2_4d);\r\n}\r\nSiS_SetRegAND(SISCR, 0x32, ~0x03);\r\nif(!(ivideo->vbflags & TV_YPBPR)) {\r\nif((result = SISDoSense(ivideo, svhs, svhs_c))) {\r\nprintk(KERN_INFO "%s %s SVIDEO output\n", stdstr, tvstr);\r\nSiS_SetRegOR(SISCR, 0x32, 0x02);\r\n}\r\nif((biosflag & 0x02) || (!result)) {\r\nif(SISDoSense(ivideo, cvbs, cvbs_c)) {\r\nprintk(KERN_INFO "%s %s COMPOSITE output\n", stdstr, tvstr);\r\nSiS_SetRegOR(SISCR, 0x32, 0x01);\r\n}\r\n}\r\n}\r\nSISDoSense(ivideo, 0, 0);\r\nSiS_SetReg(SISPART2, 0x00, backupP2_00);\r\nSiS_SetReg(SISPART4, 0x0d, backupP4_0d);\r\nSiS_SetReg(SISSR, 0x1e, backupSR_1e);\r\nif(ivideo->vbflags2 & VB2_30xCLV) {\r\nbiosflag = SiS_GetReg(SISPART2, 0x00);\r\nif(biosflag & 0x20) {\r\nfor(myflag = 2; myflag > 0; myflag--) {\r\nbiosflag ^= 0x20;\r\nSiS_SetReg(SISPART2, 0x00, biosflag);\r\n}\r\n}\r\n}\r\nSiS_SetReg(SISPART2, 0x00, backupP2_00);\r\n}\r\nstatic void __devinit\r\nSiS_SenseCh(struct sis_video_info *ivideo)\r\n{\r\n#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)\r\nu8 temp1, temp2;\r\nchar stdstr[] = "sisfb: Chrontel: Detected TV connected to";\r\n#endif\r\n#ifdef CONFIG_FB_SIS_300\r\nunsigned char test[3];\r\nint i;\r\n#endif\r\nif(ivideo->chip < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nivideo->SiS_Pr.SiS_IF_DEF_CH70xx = 1;\r\nSiS_SetChrontelGPIO(&ivideo->SiS_Pr, 0x9c);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 1000);\r\ntemp1 = SiS_GetCH700x(&ivideo->SiS_Pr, 0x25);\r\ntemp2 = SiS_GetCH700x(&ivideo->SiS_Pr, 0x0e);\r\nif(((temp2 & 0x07) == 0x01) || (temp2 & 0x04)) {\r\nSiS_SetCH700x(&ivideo->SiS_Pr, 0x0e, 0x0b);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 300);\r\n}\r\ntemp2 = SiS_GetCH700x(&ivideo->SiS_Pr, 0x25);\r\nif(temp2 != temp1) temp1 = temp2;\r\nif((temp1 >= 0x22) && (temp1 <= 0x50)) {\r\ntemp1 = SiS_GetCH700x(&ivideo->SiS_Pr, 0x0e);\r\nif((temp1 & 0x03) != 0x03) {\r\nSiS_SetCH700x(&ivideo->SiS_Pr, 0x0e,0x0b);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 300);\r\n}\r\nfor(i = 0; i < 3; i++) {\r\nSiS_SetCH700x(&ivideo->SiS_Pr, 0x10, 0x01);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x96);\r\nSiS_SetCH700x(&ivideo->SiS_Pr, 0x10, 0x00);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x96);\r\ntemp1 = SiS_GetCH700x(&ivideo->SiS_Pr, 0x10);\r\nif(!(temp1 & 0x08)) test[i] = 0x02;\r\nelse if(!(temp1 & 0x02)) test[i] = 0x01;\r\nelse test[i] = 0;\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x96);\r\n}\r\nif(test[0] == test[1]) temp1 = test[0];\r\nelse if(test[0] == test[2]) temp1 = test[0];\r\nelse if(test[1] == test[2]) temp1 = test[1];\r\nelse {\r\nprintk(KERN_INFO\r\n"sisfb: TV detection unreliable - test results varied\n");\r\ntemp1 = test[2];\r\n}\r\nif(temp1 == 0x02) {\r\nprintk(KERN_INFO "%s SVIDEO output\n", stdstr);\r\nivideo->vbflags |= TV_SVIDEO;\r\nSiS_SetRegOR(SISCR, 0x32, 0x02);\r\nSiS_SetRegAND(SISCR, 0x32, ~0x05);\r\n} else if (temp1 == 0x01) {\r\nprintk(KERN_INFO "%s CVBS output\n", stdstr);\r\nivideo->vbflags |= TV_AVIDEO;\r\nSiS_SetRegOR(SISCR, 0x32, 0x01);\r\nSiS_SetRegAND(SISCR, 0x32, ~0x06);\r\n} else {\r\nSiS_SetCH70xxANDOR(&ivideo->SiS_Pr, 0x0e, 0x01, 0xF8);\r\nSiS_SetRegAND(SISCR, 0x32, ~0x07);\r\n}\r\n} else if(temp1 == 0) {\r\nSiS_SetCH70xxANDOR(&ivideo->SiS_Pr, 0x0e, 0x01, 0xF8);\r\nSiS_SetRegAND(SISCR, 0x32, ~0x07);\r\n}\r\nSiS_SetChrontelGPIO(&ivideo->SiS_Pr, 0x00);\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nivideo->SiS_Pr.SiS_IF_DEF_CH70xx = 2;\r\ntemp1 = SiS_GetCH701x(&ivideo->SiS_Pr, 0x49);\r\nSiS_SetCH701x(&ivideo->SiS_Pr, 0x49, 0x20);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x96);\r\ntemp2 = SiS_GetCH701x(&ivideo->SiS_Pr, 0x20);\r\ntemp2 |= 0x01;\r\nSiS_SetCH701x(&ivideo->SiS_Pr, 0x20, temp2);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x96);\r\ntemp2 ^= 0x01;\r\nSiS_SetCH701x(&ivideo->SiS_Pr, 0x20, temp2);\r\nSiS_DDC2Delay(&ivideo->SiS_Pr, 0x96);\r\ntemp2 = SiS_GetCH701x(&ivideo->SiS_Pr, 0x20);\r\nSiS_SetCH701x(&ivideo->SiS_Pr, 0x49, temp1);\r\ntemp1 = 0;\r\nif(temp2 & 0x02) temp1 |= 0x01;\r\nif(temp2 & 0x10) temp1 |= 0x01;\r\nif(temp2 & 0x04) temp1 |= 0x02;\r\nif( (temp1 & 0x01) && (temp1 & 0x02) ) temp1 = 0x04;\r\nswitch(temp1) {\r\ncase 0x01:\r\nprintk(KERN_INFO "%s CVBS output\n", stdstr);\r\nivideo->vbflags |= TV_AVIDEO;\r\nSiS_SetRegOR(SISCR, 0x32, 0x01);\r\nSiS_SetRegAND(SISCR, 0x32, ~0x06);\r\nbreak;\r\ncase 0x02:\r\nprintk(KERN_INFO "%s SVIDEO output\n", stdstr);\r\nivideo->vbflags |= TV_SVIDEO;\r\nSiS_SetRegOR(SISCR, 0x32, 0x02);\r\nSiS_SetRegAND(SISCR, 0x32, ~0x05);\r\nbreak;\r\ncase 0x04:\r\nprintk(KERN_INFO "%s SCART output\n", stdstr);\r\nSiS_SetRegOR(SISCR, 0x32, 0x04);\r\nSiS_SetRegAND(SISCR, 0x32, ~0x03);\r\nbreak;\r\ndefault:\r\nSiS_SetRegAND(SISCR, 0x32, ~0x07);\r\n}\r\n#endif\r\n}\r\n}\r\nstatic void __devinit\r\nsisfb_get_VB_type(struct sis_video_info *ivideo)\r\n{\r\nchar stdstr[] = "sisfb: Detected";\r\nchar bridgestr[] = "video bridge";\r\nu8 vb_chipid;\r\nu8 reg;\r\nif(ivideo->chip == XGI_20)\r\nreturn;\r\nvb_chipid = SiS_GetReg(SISPART4, 0x00);\r\nswitch(vb_chipid) {\r\ncase 0x01:\r\nreg = SiS_GetReg(SISPART4, 0x01);\r\nif(reg < 0xb0) {\r\nivideo->vbflags |= VB_301;\r\nivideo->vbflags2 |= VB2_301;\r\nprintk(KERN_INFO "%s SiS301 %s\n", stdstr, bridgestr);\r\n} else if(reg < 0xc0) {\r\nivideo->vbflags |= VB_301B;\r\nivideo->vbflags2 |= VB2_301B;\r\nreg = SiS_GetReg(SISPART4, 0x23);\r\nif(!(reg & 0x02)) {\r\nivideo->vbflags |= VB_30xBDH;\r\nivideo->vbflags2 |= VB2_30xBDH;\r\nprintk(KERN_INFO "%s SiS301B-DH %s\n", stdstr, bridgestr);\r\n} else {\r\nprintk(KERN_INFO "%s SiS301B %s\n", stdstr, bridgestr);\r\n}\r\n} else if(reg < 0xd0) {\r\nivideo->vbflags |= VB_301C;\r\nivideo->vbflags2 |= VB2_301C;\r\nprintk(KERN_INFO "%s SiS301C %s\n", stdstr, bridgestr);\r\n} else if(reg < 0xe0) {\r\nivideo->vbflags |= VB_301LV;\r\nivideo->vbflags2 |= VB2_301LV;\r\nprintk(KERN_INFO "%s SiS301LV %s\n", stdstr, bridgestr);\r\n} else if(reg <= 0xe1) {\r\nreg = SiS_GetReg(SISPART4, 0x39);\r\nif(reg == 0xff) {\r\nivideo->vbflags |= VB_302LV;\r\nivideo->vbflags2 |= VB2_302LV;\r\nprintk(KERN_INFO "%s SiS302LV %s\n", stdstr, bridgestr);\r\n} else {\r\nivideo->vbflags |= VB_301C;\r\nivideo->vbflags2 |= VB2_301C;\r\nprintk(KERN_INFO "%s SiS301C(P4) %s\n", stdstr, bridgestr);\r\n#if 0\r\nivideo->vbflags |= VB_302ELV;\r\nivideo->vbflags2 |= VB2_302ELV;\r\nprintk(KERN_INFO "%s SiS302ELV %s\n", stdstr, bridgestr);\r\n#endif\r\n}\r\n}\r\nbreak;\r\ncase 0x02:\r\nivideo->vbflags |= VB_302B;\r\nivideo->vbflags2 |= VB2_302B;\r\nprintk(KERN_INFO "%s SiS302B %s\n", stdstr, bridgestr);\r\nbreak;\r\n}\r\nif((!(ivideo->vbflags2 & VB2_VIDEOBRIDGE)) && (ivideo->chip != SIS_300)) {\r\nreg = SiS_GetReg(SISCR, 0x37);\r\nreg &= SIS_EXTERNAL_CHIP_MASK;\r\nreg >>= 1;\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\n#ifdef CONFIG_FB_SIS_300\r\nswitch(reg) {\r\ncase SIS_EXTERNAL_CHIP_LVDS:\r\nivideo->vbflags |= VB_LVDS;\r\nivideo->vbflags2 |= VB2_LVDS;\r\nbreak;\r\ncase SIS_EXTERNAL_CHIP_TRUMPION:\r\nivideo->vbflags |= (VB_LVDS | VB_TRUMPION);\r\nivideo->vbflags2 |= (VB2_LVDS | VB2_TRUMPION);\r\nbreak;\r\ncase SIS_EXTERNAL_CHIP_CHRONTEL:\r\nivideo->vbflags |= VB_CHRONTEL;\r\nivideo->vbflags2 |= VB2_CHRONTEL;\r\nbreak;\r\ncase SIS_EXTERNAL_CHIP_LVDS_CHRONTEL:\r\nivideo->vbflags |= (VB_LVDS | VB_CHRONTEL);\r\nivideo->vbflags2 |= (VB2_LVDS | VB2_CHRONTEL);\r\nbreak;\r\n}\r\nif(ivideo->vbflags2 & VB2_CHRONTEL) ivideo->chronteltype = 1;\r\n#endif\r\n} else if(ivideo->chip < SIS_661) {\r\n#ifdef CONFIG_FB_SIS_315\r\nswitch (reg) {\r\ncase SIS310_EXTERNAL_CHIP_LVDS:\r\nivideo->vbflags |= VB_LVDS;\r\nivideo->vbflags2 |= VB2_LVDS;\r\nbreak;\r\ncase SIS310_EXTERNAL_CHIP_LVDS_CHRONTEL:\r\nivideo->vbflags |= (VB_LVDS | VB_CHRONTEL);\r\nivideo->vbflags2 |= (VB2_LVDS | VB2_CHRONTEL);\r\nbreak;\r\n}\r\nif(ivideo->vbflags2 & VB2_CHRONTEL) ivideo->chronteltype = 2;\r\n#endif\r\n} else if(ivideo->chip >= SIS_661) {\r\n#ifdef CONFIG_FB_SIS_315\r\nreg = SiS_GetReg(SISCR, 0x38);\r\nreg >>= 5;\r\nswitch(reg) {\r\ncase 0x02:\r\nivideo->vbflags |= VB_LVDS;\r\nivideo->vbflags2 |= VB2_LVDS;\r\nbreak;\r\ncase 0x03:\r\nivideo->vbflags |= (VB_LVDS | VB_CHRONTEL);\r\nivideo->vbflags2 |= (VB2_LVDS | VB2_CHRONTEL);\r\nbreak;\r\ncase 0x04:\r\nivideo->vbflags |= (VB_LVDS | VB_CONEXANT);\r\nivideo->vbflags2 |= (VB2_LVDS | VB2_CONEXANT);\r\nbreak;\r\n}\r\nif(ivideo->vbflags2 & VB2_CHRONTEL) ivideo->chronteltype = 2;\r\n#endif\r\n}\r\nif(ivideo->vbflags2 & VB2_LVDS) {\r\nprintk(KERN_INFO "%s LVDS transmitter\n", stdstr);\r\n}\r\nif((ivideo->sisvga_engine == SIS_300_VGA) && (ivideo->vbflags2 & VB2_TRUMPION)) {\r\nprintk(KERN_INFO "%s Trumpion Zurac LCD scaler\n", stdstr);\r\n}\r\nif(ivideo->vbflags2 & VB2_CHRONTEL) {\r\nprintk(KERN_INFO "%s Chrontel TV encoder\n", stdstr);\r\n}\r\nif((ivideo->chip >= SIS_661) && (ivideo->vbflags2 & VB2_CONEXANT)) {\r\nprintk(KERN_INFO "%s Conexant external device\n", stdstr);\r\n}\r\n}\r\nif(ivideo->vbflags2 & VB2_SISBRIDGE) {\r\nSiS_SenseLCD(ivideo);\r\nSiS_Sense30x(ivideo);\r\n} else if(ivideo->vbflags2 & VB2_CHRONTEL) {\r\nSiS_SenseCh(ivideo);\r\n}\r\n}\r\nstatic void\r\nsisfb_engine_init(struct sis_video_info *ivideo)\r\n{\r\nivideo->caps &= ~(TURBO_QUEUE_CAP |\r\nMMIO_CMD_QUEUE_CAP |\r\nVM_CMD_QUEUE_CAP |\r\nAGP_CMD_QUEUE_CAP);\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nu32 tqueue_pos;\r\nu8 tq_state;\r\ntqueue_pos = (ivideo->video_size - ivideo->cmdQueueSize) / (64 * 1024);\r\ntq_state = SiS_GetReg(SISSR, IND_SIS_TURBOQUEUE_SET);\r\ntq_state |= 0xf0;\r\ntq_state &= 0xfc;\r\ntq_state |= (u8)(tqueue_pos >> 8);\r\nSiS_SetReg(SISSR, IND_SIS_TURBOQUEUE_SET, tq_state);\r\nSiS_SetReg(SISSR, IND_SIS_TURBOQUEUE_ADR, (u8)(tqueue_pos & 0xff));\r\nivideo->caps |= TURBO_QUEUE_CAP;\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nu32 tempq = 0, templ;\r\nu8 temp;\r\nif(ivideo->chip == XGI_20) {\r\nswitch(ivideo->cmdQueueSize) {\r\ncase (64 * 1024):\r\ntemp = SIS_CMD_QUEUE_SIZE_Z7_64k;\r\nbreak;\r\ncase (128 * 1024):\r\ndefault:\r\ntemp = SIS_CMD_QUEUE_SIZE_Z7_128k;\r\n}\r\n} else {\r\nswitch(ivideo->cmdQueueSize) {\r\ncase (4 * 1024 * 1024):\r\ntemp = SIS_CMD_QUEUE_SIZE_4M;\r\nbreak;\r\ncase (2 * 1024 * 1024):\r\ntemp = SIS_CMD_QUEUE_SIZE_2M;\r\nbreak;\r\ncase (1 * 1024 * 1024):\r\ntemp = SIS_CMD_QUEUE_SIZE_1M;\r\nbreak;\r\ndefault:\r\ncase (512 * 1024):\r\ntemp = SIS_CMD_QUEUE_SIZE_512k;\r\n}\r\n}\r\nSiS_SetReg(SISSR, IND_SIS_CMDQUEUE_THRESHOLD, COMMAND_QUEUE_THRESHOLD);\r\nSiS_SetReg(SISSR, IND_SIS_CMDQUEUE_SET, SIS_CMD_QUEUE_RESET);\r\nif((ivideo->chip >= XGI_40) && ivideo->modechanged) {\r\nif(!((templ = MMIO_IN32(ivideo->mmio_vbase, 0x8240)) & (1 << 10))) {\r\nMMIO_OUT32(ivideo->mmio_vbase, Q_WRITE_PTR, 0);\r\nSiS_SetReg(SISSR, IND_SIS_CMDQUEUE_SET, (temp | SIS_VRAM_CMDQUEUE_ENABLE));\r\ntempq = MMIO_IN32(ivideo->mmio_vbase, Q_READ_PTR);\r\nMMIO_OUT32(ivideo->mmio_vbase, Q_WRITE_PTR, tempq);\r\ntempq = (u32)(ivideo->video_size - ivideo->cmdQueueSize);\r\nMMIO_OUT32(ivideo->mmio_vbase, Q_BASE_ADDR, tempq);\r\nwritel(0x16800000 + 0x8240, ivideo->video_vbase + tempq);\r\nwritel(templ | (1 << 10), ivideo->video_vbase + tempq + 4);\r\nwritel(0x168F0000, ivideo->video_vbase + tempq + 8);\r\nwritel(0x168F0000, ivideo->video_vbase + tempq + 12);\r\nMMIO_OUT32(ivideo->mmio_vbase, Q_WRITE_PTR, (tempq + 16));\r\nsisfb_syncaccel(ivideo);\r\nSiS_SetReg(SISSR, IND_SIS_CMDQUEUE_SET, SIS_CMD_QUEUE_RESET);\r\n}\r\n}\r\ntempq = MMIO_IN32(ivideo->mmio_vbase, MMIO_QUEUE_READPORT);\r\nMMIO_OUT32(ivideo->mmio_vbase, MMIO_QUEUE_WRITEPORT, tempq);\r\ntemp |= (SIS_MMIO_CMD_ENABLE | SIS_CMD_AUTO_CORR);\r\nSiS_SetReg(SISSR, IND_SIS_CMDQUEUE_SET, temp);\r\ntempq = (u32)(ivideo->video_size - ivideo->cmdQueueSize);\r\nMMIO_OUT32(ivideo->mmio_vbase, MMIO_QUEUE_PHYBASE, tempq);\r\nivideo->caps |= MMIO_CMD_QUEUE_CAP;\r\n}\r\n#endif\r\nivideo->engineok = 1;\r\n}\r\nstatic void __devinit\r\nsisfb_detect_lcd_type(struct sis_video_info *ivideo)\r\n{\r\nu8 reg;\r\nint i;\r\nreg = SiS_GetReg(SISCR, 0x36);\r\nreg &= 0x0f;\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nivideo->CRT2LCDType = sis300paneltype[reg];\r\n} else if(ivideo->chip >= SIS_661) {\r\nivideo->CRT2LCDType = sis661paneltype[reg];\r\n} else {\r\nivideo->CRT2LCDType = sis310paneltype[reg];\r\nif((ivideo->chip == SIS_550) && (sisfb_fstn)) {\r\nif((ivideo->CRT2LCDType != LCD_320x240_2) &&\r\n(ivideo->CRT2LCDType != LCD_320x240_3)) {\r\nivideo->CRT2LCDType = LCD_320x240;\r\n}\r\n}\r\n}\r\nif(ivideo->CRT2LCDType == LCD_UNKNOWN) {\r\nivideo->CRT2LCDType = LCD_1024x768;\r\nSiS_SetRegANDOR(SISCR, 0x36, 0xf0, 0x02);\r\nSiS_SetRegANDOR(SISCR, 0x37, 0xee, 0x01);\r\nprintk(KERN_DEBUG "sisfb: Invalid panel ID (%02x), assuming 1024x768, RGB18\n", reg);\r\n}\r\nfor(i = 0; i < SIS_LCD_NUMBER; i++) {\r\nif(ivideo->CRT2LCDType == sis_lcd_data[i].lcdtype) {\r\nivideo->lcdxres = sis_lcd_data[i].xres;\r\nivideo->lcdyres = sis_lcd_data[i].yres;\r\nivideo->lcddefmodeidx = sis_lcd_data[i].default_mode_idx;\r\nbreak;\r\n}\r\n}\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->SiS_Pr.SiS_CustomT == CUT_BARCO1366) {\r\nivideo->lcdxres = 1360; ivideo->lcdyres = 1024;\r\nivideo->lcddefmodeidx = DEFAULT_MODE_1360;\r\n} else if(ivideo->SiS_Pr.SiS_CustomT == CUT_PANEL848) {\r\nivideo->lcdxres = 848; ivideo->lcdyres = 480;\r\nivideo->lcddefmodeidx = DEFAULT_MODE_848;\r\n} else if(ivideo->SiS_Pr.SiS_CustomT == CUT_PANEL856) {\r\nivideo->lcdxres = 856; ivideo->lcdyres = 480;\r\nivideo->lcddefmodeidx = DEFAULT_MODE_856;\r\n}\r\n#endif\r\nprintk(KERN_DEBUG "sisfb: Detected %dx%d flat panel\n",\r\nivideo->lcdxres, ivideo->lcdyres);\r\n}\r\nstatic void __devinit\r\nsisfb_save_pdc_emi(struct sis_video_info *ivideo)\r\n{\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nif(ivideo->vbflags2 & (VB2_LVDS | VB2_30xBDH)) {\r\nint tmp;\r\ntmp = SiS_GetReg(SISCR, 0x30);\r\nif(tmp & 0x20) {\r\nivideo->detectedpdc = SiS_GetReg(SISPART1, 0x13);\r\nivideo->detectedpdc &= 0x3c;\r\nif(ivideo->SiS_Pr.PDC == -1) {\r\nivideo->SiS_Pr.PDC = ivideo->detectedpdc;\r\n}\r\nprintk(KERN_INFO "sisfb: Detected LCD PDC 0x%02x\n",\r\nivideo->detectedpdc);\r\n}\r\nif((ivideo->SiS_Pr.PDC != -1) &&\r\n(ivideo->SiS_Pr.PDC != ivideo->detectedpdc)) {\r\nprintk(KERN_INFO "sisfb: Using LCD PDC 0x%02x\n",\r\nivideo->SiS_Pr.PDC);\r\n}\r\n}\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nif(ivideo->vbflags2 & VB2_SISLCDABRIDGE) {\r\nint tmp;\r\ntmp = SiS_GetReg(SISPART1, 0x13);\r\nif(tmp & 0x04) {\r\nivideo->SiS_Pr.SiS_UseLCDA = true;\r\nivideo->detectedlcda = 0x03;\r\n}\r\n}\r\nif(ivideo->vbflags2 & VB2_SISLVDSBRIDGE) {\r\nint tmp;\r\ntmp = SiS_GetReg(SISCR, 0x30);\r\nif((tmp & 0x20) || (ivideo->detectedlcda != 0xff)) {\r\nu8 pdc;\r\npdc = SiS_GetReg(SISPART1, 0x2D);\r\nivideo->detectedpdc = (pdc & 0x0f) << 1;\r\nivideo->detectedpdca = (pdc & 0xf0) >> 3;\r\npdc = SiS_GetReg(SISPART1, 0x35);\r\nivideo->detectedpdc |= ((pdc >> 7) & 0x01);\r\npdc = SiS_GetReg(SISPART1, 0x20);\r\nivideo->detectedpdca |= ((pdc >> 6) & 0x01);\r\nif(ivideo->newrom) {\r\nif(ivideo->detectedlcda != 0xff) {\r\nivideo->detectedpdc = 0xff;\r\n} else {\r\nivideo->detectedpdca = 0xff;\r\n}\r\n}\r\nif(ivideo->SiS_Pr.PDC == -1) {\r\nif(ivideo->detectedpdc != 0xff) {\r\nivideo->SiS_Pr.PDC = ivideo->detectedpdc;\r\n}\r\n}\r\nif(ivideo->SiS_Pr.PDCA == -1) {\r\nif(ivideo->detectedpdca != 0xff) {\r\nivideo->SiS_Pr.PDCA = ivideo->detectedpdca;\r\n}\r\n}\r\nif(ivideo->detectedpdc != 0xff) {\r\nprintk(KERN_INFO\r\n"sisfb: Detected LCD PDC 0x%02x (for LCD=CRT2)\n",\r\nivideo->detectedpdc);\r\n}\r\nif(ivideo->detectedpdca != 0xff) {\r\nprintk(KERN_INFO\r\n"sisfb: Detected LCD PDC1 0x%02x (for LCD=CRT1)\n",\r\nivideo->detectedpdca);\r\n}\r\n}\r\nif(ivideo->vbflags2 & VB2_SISEMIBRIDGE) {\r\nivideo->SiS_Pr.EMI_30 = SiS_GetReg(SISPART4, 0x30);\r\nivideo->SiS_Pr.EMI_31 = SiS_GetReg(SISPART4, 0x31);\r\nivideo->SiS_Pr.EMI_32 = SiS_GetReg(SISPART4, 0x32);\r\nivideo->SiS_Pr.EMI_33 = SiS_GetReg(SISPART4, 0x33);\r\nivideo->SiS_Pr.HaveEMI = true;\r\nif((tmp & 0x20) || (ivideo->detectedlcda != 0xff)) {\r\nivideo->SiS_Pr.HaveEMILCD = true;\r\n}\r\n}\r\n}\r\nif(ivideo->vbflags2 & VB2_30xBLV) {\r\nif((ivideo->SiS_Pr.PDC != -1) &&\r\n(ivideo->SiS_Pr.PDC != ivideo->detectedpdc)) {\r\nprintk(KERN_INFO "sisfb: Using LCD PDC 0x%02x (for LCD=CRT2)\n",\r\nivideo->SiS_Pr.PDC);\r\n}\r\nif((ivideo->SiS_Pr.PDCA != -1) &&\r\n(ivideo->SiS_Pr.PDCA != ivideo->detectedpdca)) {\r\nprintk(KERN_INFO "sisfb: Using LCD PDC1 0x%02x (for LCD=CRT1)\n",\r\nivideo->SiS_Pr.PDCA);\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\nstatic u32 __devinit\r\nsisfb_getheapstart(struct sis_video_info *ivideo)\r\n{\r\nu32 ret = ivideo->sisfb_parm_mem * 1024;\r\nu32 maxoffs = ivideo->video_size - ivideo->hwcursor_size - ivideo->cmdQueueSize;\r\nu32 def;\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nif(ivideo->video_size > 0x1000000) {\r\ndef = 0xc00000;\r\n} else if(ivideo->video_size > 0x800000) {\r\ndef = 0x800000;\r\n} else {\r\ndef = 0x400000;\r\n}\r\n} else if(ivideo->UMAsize && ivideo->LFBsize) {\r\nret = def = 0;\r\n} else {\r\ndef = maxoffs - 0x8000;\r\n}\r\nif((!ret) || (ret > maxoffs) || (ivideo->cardnumber != 0))\r\nret = def;\r\nreturn ret;\r\n}\r\nstatic u32 __devinit\r\nsisfb_getheapsize(struct sis_video_info *ivideo)\r\n{\r\nu32 max = ivideo->video_size - ivideo->hwcursor_size - ivideo->cmdQueueSize;\r\nu32 ret = 0;\r\nif(ivideo->UMAsize && ivideo->LFBsize) {\r\nif( (!ivideo->sisfb_parm_mem) ||\r\n((ivideo->sisfb_parm_mem * 1024) > max) ||\r\n((max - (ivideo->sisfb_parm_mem * 1024)) < ivideo->UMAsize) ) {\r\nret = ivideo->UMAsize;\r\nmax -= ivideo->UMAsize;\r\n} else {\r\nret = max - (ivideo->sisfb_parm_mem * 1024);\r\nmax = ivideo->sisfb_parm_mem * 1024;\r\n}\r\nivideo->video_offset = ret;\r\nivideo->sisfb_mem = max;\r\n} else {\r\nret = max - ivideo->heapstart;\r\nivideo->sisfb_mem = ivideo->heapstart;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devinit\r\nsisfb_heap_init(struct sis_video_info *ivideo)\r\n{\r\nstruct SIS_OH *poh;\r\nivideo->video_offset = 0;\r\nif(ivideo->sisfb_parm_mem) {\r\nif( (ivideo->sisfb_parm_mem < (2 * 1024 * 1024)) ||\r\n(ivideo->sisfb_parm_mem > ivideo->video_size) ) {\r\nivideo->sisfb_parm_mem = 0;\r\n}\r\n}\r\nivideo->heapstart = sisfb_getheapstart(ivideo);\r\nivideo->sisfb_heap_size = sisfb_getheapsize(ivideo);\r\nivideo->sisfb_heap_start = ivideo->video_vbase + ivideo->heapstart;\r\nivideo->sisfb_heap_end = ivideo->sisfb_heap_start + ivideo->sisfb_heap_size;\r\nprintk(KERN_INFO "sisfb: Memory heap starting at %dK, size %dK\n",\r\n(int)(ivideo->heapstart / 1024), (int)(ivideo->sisfb_heap_size / 1024));\r\nivideo->sisfb_heap.vinfo = ivideo;\r\nivideo->sisfb_heap.poha_chain = NULL;\r\nivideo->sisfb_heap.poh_freelist = NULL;\r\npoh = sisfb_poh_new_node(&ivideo->sisfb_heap);\r\nif(poh == NULL)\r\nreturn 1;\r\npoh->poh_next = &ivideo->sisfb_heap.oh_free;\r\npoh->poh_prev = &ivideo->sisfb_heap.oh_free;\r\npoh->size = ivideo->sisfb_heap_size;\r\npoh->offset = ivideo->heapstart;\r\nivideo->sisfb_heap.oh_free.poh_next = poh;\r\nivideo->sisfb_heap.oh_free.poh_prev = poh;\r\nivideo->sisfb_heap.oh_free.size = 0;\r\nivideo->sisfb_heap.max_freesize = poh->size;\r\nivideo->sisfb_heap.oh_used.poh_next = &ivideo->sisfb_heap.oh_used;\r\nivideo->sisfb_heap.oh_used.poh_prev = &ivideo->sisfb_heap.oh_used;\r\nivideo->sisfb_heap.oh_used.size = SENTINEL;\r\nif(ivideo->cardnumber == 0) {\r\nsisfb_heap = &ivideo->sisfb_heap;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct SIS_OH *\r\nsisfb_poh_new_node(struct SIS_HEAP *memheap)\r\n{\r\nstruct SIS_OHALLOC *poha;\r\nstruct SIS_OH *poh;\r\nunsigned long cOhs;\r\nint i;\r\nif(memheap->poh_freelist == NULL) {\r\npoha = kmalloc(SIS_OH_ALLOC_SIZE, GFP_KERNEL);\r\nif(!poha)\r\nreturn NULL;\r\npoha->poha_next = memheap->poha_chain;\r\nmemheap->poha_chain = poha;\r\ncOhs = (SIS_OH_ALLOC_SIZE - sizeof(struct SIS_OHALLOC)) / sizeof(struct SIS_OH) + 1;\r\npoh = &poha->aoh[0];\r\nfor(i = cOhs - 1; i != 0; i--) {\r\npoh->poh_next = poh + 1;\r\npoh = poh + 1;\r\n}\r\npoh->poh_next = NULL;\r\nmemheap->poh_freelist = &poha->aoh[0];\r\n}\r\npoh = memheap->poh_freelist;\r\nmemheap->poh_freelist = poh->poh_next;\r\nreturn poh;\r\n}\r\nstatic struct SIS_OH *\r\nsisfb_poh_allocate(struct SIS_HEAP *memheap, u32 size)\r\n{\r\nstruct SIS_OH *pohThis;\r\nstruct SIS_OH *pohRoot;\r\nint bAllocated = 0;\r\nif(size > memheap->max_freesize) {\r\nDPRINTK("sisfb: Can't allocate %dk video memory\n",\r\n(unsigned int) size / 1024);\r\nreturn NULL;\r\n}\r\npohThis = memheap->oh_free.poh_next;\r\nwhile(pohThis != &memheap->oh_free) {\r\nif(size <= pohThis->size) {\r\nbAllocated = 1;\r\nbreak;\r\n}\r\npohThis = pohThis->poh_next;\r\n}\r\nif(!bAllocated) {\r\nDPRINTK("sisfb: Can't allocate %dk video memory\n",\r\n(unsigned int) size / 1024);\r\nreturn NULL;\r\n}\r\nif(size == pohThis->size) {\r\npohRoot = pohThis;\r\nsisfb_delete_node(pohThis);\r\n} else {\r\npohRoot = sisfb_poh_new_node(memheap);\r\nif(pohRoot == NULL)\r\nreturn NULL;\r\npohRoot->offset = pohThis->offset;\r\npohRoot->size = size;\r\npohThis->offset += size;\r\npohThis->size -= size;\r\n}\r\nmemheap->max_freesize -= size;\r\npohThis = &memheap->oh_used;\r\nsisfb_insert_node(pohThis, pohRoot);\r\nreturn pohRoot;\r\n}\r\nstatic void\r\nsisfb_delete_node(struct SIS_OH *poh)\r\n{\r\npoh->poh_prev->poh_next = poh->poh_next;\r\npoh->poh_next->poh_prev = poh->poh_prev;\r\n}\r\nstatic void\r\nsisfb_insert_node(struct SIS_OH *pohList, struct SIS_OH *poh)\r\n{\r\nstruct SIS_OH *pohTemp = pohList->poh_next;\r\npohList->poh_next = poh;\r\npohTemp->poh_prev = poh;\r\npoh->poh_prev = pohList;\r\npoh->poh_next = pohTemp;\r\n}\r\nstatic struct SIS_OH *\r\nsisfb_poh_free(struct SIS_HEAP *memheap, u32 base)\r\n{\r\nstruct SIS_OH *pohThis;\r\nstruct SIS_OH *poh_freed;\r\nstruct SIS_OH *poh_prev;\r\nstruct SIS_OH *poh_next;\r\nu32 ulUpper;\r\nu32 ulLower;\r\nint foundNode = 0;\r\npoh_freed = memheap->oh_used.poh_next;\r\nwhile(poh_freed != &memheap->oh_used) {\r\nif(poh_freed->offset == base) {\r\nfoundNode = 1;\r\nbreak;\r\n}\r\npoh_freed = poh_freed->poh_next;\r\n}\r\nif(!foundNode)\r\nreturn NULL;\r\nmemheap->max_freesize += poh_freed->size;\r\npoh_prev = poh_next = NULL;\r\nulUpper = poh_freed->offset + poh_freed->size;\r\nulLower = poh_freed->offset;\r\npohThis = memheap->oh_free.poh_next;\r\nwhile(pohThis != &memheap->oh_free) {\r\nif(pohThis->offset == ulUpper) {\r\npoh_next = pohThis;\r\n} else if((pohThis->offset + pohThis->size) == ulLower) {\r\npoh_prev = pohThis;\r\n}\r\npohThis = pohThis->poh_next;\r\n}\r\nsisfb_delete_node(poh_freed);\r\nif(poh_prev && poh_next) {\r\npoh_prev->size += (poh_freed->size + poh_next->size);\r\nsisfb_delete_node(poh_next);\r\nsisfb_free_node(memheap, poh_freed);\r\nsisfb_free_node(memheap, poh_next);\r\nreturn poh_prev;\r\n}\r\nif(poh_prev) {\r\npoh_prev->size += poh_freed->size;\r\nsisfb_free_node(memheap, poh_freed);\r\nreturn poh_prev;\r\n}\r\nif(poh_next) {\r\npoh_next->size += poh_freed->size;\r\npoh_next->offset = poh_freed->offset;\r\nsisfb_free_node(memheap, poh_freed);\r\nreturn poh_next;\r\n}\r\nsisfb_insert_node(&memheap->oh_free, poh_freed);\r\nreturn poh_freed;\r\n}\r\nstatic void\r\nsisfb_free_node(struct SIS_HEAP *memheap, struct SIS_OH *poh)\r\n{\r\nif(poh == NULL)\r\nreturn;\r\npoh->poh_next = memheap->poh_freelist;\r\nmemheap->poh_freelist = poh;\r\n}\r\nstatic void\r\nsis_int_malloc(struct sis_video_info *ivideo, struct sis_memreq *req)\r\n{\r\nstruct SIS_OH *poh = NULL;\r\nif((ivideo) && (ivideo->sisfb_id == SISFB_ID) && (!ivideo->havenoheap))\r\npoh = sisfb_poh_allocate(&ivideo->sisfb_heap, (u32)req->size);\r\nif(poh == NULL) {\r\nreq->offset = req->size = 0;\r\nDPRINTK("sisfb: Video RAM allocation failed\n");\r\n} else {\r\nreq->offset = poh->offset;\r\nreq->size = poh->size;\r\nDPRINTK("sisfb: Video RAM allocation succeeded: 0x%lx\n",\r\n(poh->offset + ivideo->video_vbase));\r\n}\r\n}\r\nvoid\r\nsis_malloc(struct sis_memreq *req)\r\n{\r\nstruct sis_video_info *ivideo = sisfb_heap->vinfo;\r\nif(&ivideo->sisfb_heap == sisfb_heap)\r\nsis_int_malloc(ivideo, req);\r\nelse\r\nreq->offset = req->size = 0;\r\n}\r\nvoid\r\nsis_malloc_new(struct pci_dev *pdev, struct sis_memreq *req)\r\n{\r\nstruct sis_video_info *ivideo = pci_get_drvdata(pdev);\r\nsis_int_malloc(ivideo, req);\r\n}\r\nstatic void\r\nsis_int_free(struct sis_video_info *ivideo, u32 base)\r\n{\r\nstruct SIS_OH *poh;\r\nif((!ivideo) || (ivideo->sisfb_id != SISFB_ID) || (ivideo->havenoheap))\r\nreturn;\r\npoh = sisfb_poh_free(&ivideo->sisfb_heap, base);\r\nif(poh == NULL) {\r\nDPRINTK("sisfb: sisfb_poh_free() failed at base 0x%x\n",\r\n(unsigned int) base);\r\n}\r\n}\r\nvoid\r\nsis_free(u32 base)\r\n{\r\nstruct sis_video_info *ivideo = sisfb_heap->vinfo;\r\nsis_int_free(ivideo, base);\r\n}\r\nvoid\r\nsis_free_new(struct pci_dev *pdev, u32 base)\r\n{\r\nstruct sis_video_info *ivideo = pci_get_drvdata(pdev);\r\nsis_int_free(ivideo, base);\r\n}\r\nstatic void\r\nsisfb_check_engine_and_sync(struct sis_video_info *ivideo)\r\n{\r\nu8 cr30, cr31;\r\ncr30 = SiS_GetReg(SISSR, IND_SIS_PCI_ADDRESS_SET);\r\ncr31 = SiS_GetReg(SISSR, IND_SIS_MODULE_ENABLE);\r\nif((cr30 & SIS_MEM_MAP_IO_ENABLE) && (cr31 & 0x42)) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nsisfb_syncaccel(ivideo);\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\ncr30 = SiS_GetReg(SISSR, 0x26);\r\nif((cr30 & 0xe0) && (!(cr30 & 0x01))) {\r\nsisfb_syncaccel(ivideo);\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\nstatic void\r\nsisfb_pre_setmode(struct sis_video_info *ivideo)\r\n{\r\nu8 cr30 = 0, cr31 = 0, cr33 = 0, cr35 = 0, cr38 = 0;\r\nint tvregnum = 0;\r\nivideo->currentvbflags &= (VB_VIDEOBRIDGE | VB_DISPTYPE_DISP2);\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\ncr31 = SiS_GetReg(SISCR, 0x31);\r\ncr31 &= ~0x60;\r\ncr31 |= 0x04;\r\ncr33 = ivideo->rate_idx & 0x0F;\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nif(ivideo->chip >= SIS_661) {\r\ncr38 = SiS_GetReg(SISCR, 0x38);\r\ncr38 &= ~0x07;\r\n} else {\r\ntvregnum = 0x38;\r\ncr38 = SiS_GetReg(SISCR, tvregnum);\r\ncr38 &= ~0x3b;\r\n}\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\ntvregnum = 0x35;\r\ncr38 = SiS_GetReg(SISCR, tvregnum);\r\n}\r\n#endif\r\nSiS_SetEnableDstn(&ivideo->SiS_Pr, false);\r\nSiS_SetEnableFstn(&ivideo->SiS_Pr, false);\r\nivideo->curFSTN = ivideo->curDSTN = 0;\r\nswitch(ivideo->currentvbflags & VB_DISPTYPE_DISP2) {\r\ncase CRT2_TV:\r\ncr38 &= ~0xc0;\r\nif((ivideo->vbflags & TV_YPBPR) && (ivideo->vbflags2 & VB2_SISYPBPRBRIDGE)) {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->chip >= SIS_661) {\r\ncr38 |= 0x04;\r\nif(ivideo->vbflags & TV_YPBPR525P) cr35 |= 0x20;\r\nelse if(ivideo->vbflags & TV_YPBPR750P) cr35 |= 0x40;\r\nelse if(ivideo->vbflags & TV_YPBPR1080I) cr35 |= 0x60;\r\ncr30 |= SIS_SIMULTANEOUS_VIEW_ENABLE;\r\ncr35 &= ~0x01;\r\nivideo->currentvbflags |= (TV_YPBPR | (ivideo->vbflags & TV_YPBPRALL));\r\n} else if(ivideo->sisvga_engine == SIS_315_VGA) {\r\ncr30 |= (0x80 | SIS_SIMULTANEOUS_VIEW_ENABLE);\r\ncr38 |= 0x08;\r\nif(ivideo->vbflags & TV_YPBPR525P) cr38 |= 0x10;\r\nelse if(ivideo->vbflags & TV_YPBPR750P) cr38 |= 0x20;\r\nelse if(ivideo->vbflags & TV_YPBPR1080I) cr38 |= 0x30;\r\ncr31 &= ~0x01;\r\nivideo->currentvbflags |= (TV_YPBPR | (ivideo->vbflags & TV_YPBPRALL));\r\n}\r\n#endif\r\n} else if((ivideo->vbflags & TV_HIVISION) &&\r\n(ivideo->vbflags2 & VB2_SISHIVISIONBRIDGE)) {\r\nif(ivideo->chip >= SIS_661) {\r\ncr38 |= 0x04;\r\ncr35 |= 0x60;\r\n} else {\r\ncr30 |= 0x80;\r\n}\r\ncr30 |= SIS_SIMULTANEOUS_VIEW_ENABLE;\r\ncr31 |= 0x01;\r\ncr35 |= 0x01;\r\nivideo->currentvbflags |= TV_HIVISION;\r\n} else if(ivideo->vbflags & TV_SCART) {\r\ncr30 = (SIS_VB_OUTPUT_SCART | SIS_SIMULTANEOUS_VIEW_ENABLE);\r\ncr31 |= 0x01;\r\ncr35 |= 0x01;\r\nivideo->currentvbflags |= TV_SCART;\r\n} else {\r\nif(ivideo->vbflags & TV_SVIDEO) {\r\ncr30 = (SIS_VB_OUTPUT_SVIDEO | SIS_SIMULTANEOUS_VIEW_ENABLE);\r\nivideo->currentvbflags |= TV_SVIDEO;\r\n}\r\nif(ivideo->vbflags & TV_AVIDEO) {\r\ncr30 = (SIS_VB_OUTPUT_COMPOSITE | SIS_SIMULTANEOUS_VIEW_ENABLE);\r\nivideo->currentvbflags |= TV_AVIDEO;\r\n}\r\n}\r\ncr31 |= SIS_DRIVER_MODE;\r\nif(ivideo->vbflags & (TV_AVIDEO | TV_SVIDEO)) {\r\nif(ivideo->vbflags & TV_PAL) {\r\ncr31 |= 0x01; cr35 |= 0x01;\r\nivideo->currentvbflags |= TV_PAL;\r\nif(ivideo->vbflags & TV_PALM) {\r\ncr38 |= 0x40; cr35 |= 0x04;\r\nivideo->currentvbflags |= TV_PALM;\r\n} else if(ivideo->vbflags & TV_PALN) {\r\ncr38 |= 0x80; cr35 |= 0x08;\r\nivideo->currentvbflags |= TV_PALN;\r\n}\r\n} else {\r\ncr31 &= ~0x01; cr35 &= ~0x01;\r\nivideo->currentvbflags |= TV_NTSC;\r\nif(ivideo->vbflags & TV_NTSCJ) {\r\ncr38 |= 0x40; cr35 |= 0x02;\r\nivideo->currentvbflags |= TV_NTSCJ;\r\n}\r\n}\r\n}\r\nbreak;\r\ncase CRT2_LCD:\r\ncr30 = (SIS_VB_OUTPUT_LCD | SIS_SIMULTANEOUS_VIEW_ENABLE);\r\ncr31 |= SIS_DRIVER_MODE;\r\nSiS_SetEnableDstn(&ivideo->SiS_Pr, ivideo->sisfb_dstn);\r\nSiS_SetEnableFstn(&ivideo->SiS_Pr, ivideo->sisfb_fstn);\r\nivideo->curFSTN = ivideo->sisfb_fstn;\r\nivideo->curDSTN = ivideo->sisfb_dstn;\r\nbreak;\r\ncase CRT2_VGA:\r\ncr30 = (SIS_VB_OUTPUT_CRT2 | SIS_SIMULTANEOUS_VIEW_ENABLE);\r\ncr31 |= SIS_DRIVER_MODE;\r\nif(ivideo->sisfb_nocrt2rate) {\r\ncr33 |= (sisbios_mode[ivideo->sisfb_mode_idx].rate_idx << 4);\r\n} else {\r\ncr33 |= ((ivideo->rate_idx & 0x0F) << 4);\r\n}\r\nbreak;\r\ndefault:\r\ncr30 = 0x00;\r\ncr31 |= (SIS_DRIVER_MODE | SIS_VB_OUTPUT_DISABLE);\r\n}\r\nSiS_SetReg(SISCR, 0x30, cr30);\r\nSiS_SetReg(SISCR, 0x33, cr33);\r\nif(ivideo->chip >= SIS_661) {\r\n#ifdef CONFIG_FB_SIS_315\r\ncr31 &= ~0x01;\r\nSiS_SetRegANDOR(SISCR, 0x35, ~0x10, cr35);\r\ncr38 &= 0x07;\r\nSiS_SetRegANDOR(SISCR, 0x38, 0xf8, cr38);\r\n#endif\r\n} else if(ivideo->chip != SIS_300) {\r\nSiS_SetReg(SISCR, tvregnum, cr38);\r\n}\r\nSiS_SetReg(SISCR, 0x31, cr31);\r\nivideo->SiS_Pr.SiS_UseOEM = ivideo->sisfb_useoem;\r\nsisfb_check_engine_and_sync(ivideo);\r\n}\r\nstatic void\r\nsisfb_fixup_SR11(struct sis_video_info *ivideo)\r\n{\r\nu8 tmpreg;\r\nif(ivideo->chip >= SIS_661) {\r\ntmpreg = SiS_GetReg(SISSR, 0x11);\r\nif(tmpreg & 0x20) {\r\ntmpreg = SiS_GetReg(SISSR, 0x3e);\r\ntmpreg = (tmpreg + 1) & 0xff;\r\nSiS_SetReg(SISSR, 0x3e, tmpreg);\r\ntmpreg = SiS_GetReg(SISSR, 0x11);\r\n}\r\nif(tmpreg & 0xf0) {\r\nSiS_SetRegAND(SISSR, 0x11, 0x0f);\r\n}\r\n}\r\n}\r\nstatic void\r\nsisfb_set_TVxposoffset(struct sis_video_info *ivideo, int val)\r\n{\r\nif(val > 32) val = 32;\r\nif(val < -32) val = -32;\r\nivideo->tvxpos = val;\r\nif(ivideo->sisfblocked) return;\r\nif(!ivideo->modechanged) return;\r\nif(ivideo->currentvbflags & CRT2_TV) {\r\nif(ivideo->vbflags2 & VB2_CHRONTEL) {\r\nint x = ivideo->tvx;\r\nswitch(ivideo->chronteltype) {\r\ncase 1:\r\nx += val;\r\nif(x < 0) x = 0;\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nSiS_SetCH700x(&ivideo->SiS_Pr, 0x0a, (x & 0xff));\r\nSiS_SetCH70xxANDOR(&ivideo->SiS_Pr, 0x08, ((x & 0x0100) >> 7), 0xFD);\r\nbreak;\r\ncase 2:\r\nbreak;\r\n}\r\n} else if(ivideo->vbflags2 & VB2_SISBRIDGE) {\r\nu8 p2_1f,p2_20,p2_2b,p2_42,p2_43;\r\nunsigned short temp;\r\np2_1f = ivideo->p2_1f;\r\np2_20 = ivideo->p2_20;\r\np2_2b = ivideo->p2_2b;\r\np2_42 = ivideo->p2_42;\r\np2_43 = ivideo->p2_43;\r\ntemp = p2_1f | ((p2_20 & 0xf0) << 4);\r\ntemp += (val * 2);\r\np2_1f = temp & 0xff;\r\np2_20 = (temp & 0xf00) >> 4;\r\np2_2b = ((p2_2b & 0x0f) + (val * 2)) & 0x0f;\r\ntemp = p2_43 | ((p2_42 & 0xf0) << 4);\r\ntemp += (val * 2);\r\np2_43 = temp & 0xff;\r\np2_42 = (temp & 0xf00) >> 4;\r\nSiS_SetReg(SISPART2, 0x1f, p2_1f);\r\nSiS_SetRegANDOR(SISPART2, 0x20, 0x0F, p2_20);\r\nSiS_SetRegANDOR(SISPART2, 0x2b, 0xF0, p2_2b);\r\nSiS_SetRegANDOR(SISPART2, 0x42, 0x0F, p2_42);\r\nSiS_SetReg(SISPART2, 0x43, p2_43);\r\n}\r\n}\r\n}\r\nstatic void\r\nsisfb_set_TVyposoffset(struct sis_video_info *ivideo, int val)\r\n{\r\nif(val > 32) val = 32;\r\nif(val < -32) val = -32;\r\nivideo->tvypos = val;\r\nif(ivideo->sisfblocked) return;\r\nif(!ivideo->modechanged) return;\r\nif(ivideo->currentvbflags & CRT2_TV) {\r\nif(ivideo->vbflags2 & VB2_CHRONTEL) {\r\nint y = ivideo->tvy;\r\nswitch(ivideo->chronteltype) {\r\ncase 1:\r\ny -= val;\r\nif(y < 0) y = 0;\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nSiS_SetCH700x(&ivideo->SiS_Pr, 0x0b, (y & 0xff));\r\nSiS_SetCH70xxANDOR(&ivideo->SiS_Pr, 0x08, ((y & 0x0100) >> 8), 0xFE);\r\nbreak;\r\ncase 2:\r\nbreak;\r\n}\r\n} else if(ivideo->vbflags2 & VB2_SISBRIDGE) {\r\nchar p2_01, p2_02;\r\nval /= 2;\r\np2_01 = ivideo->p2_01;\r\np2_02 = ivideo->p2_02;\r\np2_01 += val;\r\np2_02 += val;\r\nif(!(ivideo->currentvbflags & (TV_HIVISION | TV_YPBPR))) {\r\nwhile((p2_01 <= 0) || (p2_02 <= 0)) {\r\np2_01 += 2;\r\np2_02 += 2;\r\n}\r\n}\r\nSiS_SetReg(SISPART2, 0x01, p2_01);\r\nSiS_SetReg(SISPART2, 0x02, p2_02);\r\n}\r\n}\r\n}\r\nstatic void\r\nsisfb_post_setmode(struct sis_video_info *ivideo)\r\n{\r\nbool crt1isoff = false;\r\nbool doit = true;\r\n#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)\r\nu8 reg;\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nu8 reg1;\r\n#endif\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\n#ifdef CONFIG_FB_SIS_315\r\nsisfb_fixup_SR11(ivideo);\r\n#endif\r\nivideo->modechanged = 1;\r\nif(ivideo->vbflags2 & VB2_VIDEOBRIDGE) {\r\nif(sisfb_bridgeisslave(ivideo)) doit = false;\r\n} else\r\nivideo->sisfb_crt1off = 0;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nif((ivideo->sisfb_crt1off) && (doit)) {\r\ncrt1isoff = true;\r\nreg = 0x00;\r\n} else {\r\ncrt1isoff = false;\r\nreg = 0x80;\r\n}\r\nSiS_SetRegANDOR(SISCR, 0x17, 0x7f, reg);\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nif((ivideo->sisfb_crt1off) && (doit)) {\r\ncrt1isoff = true;\r\nreg = 0x40;\r\nreg1 = 0xc0;\r\n} else {\r\ncrt1isoff = false;\r\nreg = 0x00;\r\nreg1 = 0x00;\r\n}\r\nSiS_SetRegANDOR(SISCR, ivideo->SiS_Pr.SiS_MyCR63, ~0x40, reg);\r\nSiS_SetRegANDOR(SISSR, 0x1f, 0x3f, reg1);\r\n}\r\n#endif\r\nif(crt1isoff) {\r\nivideo->currentvbflags &= ~VB_DISPTYPE_CRT1;\r\nivideo->currentvbflags |= VB_SINGLE_MODE;\r\n} else {\r\nivideo->currentvbflags |= VB_DISPTYPE_CRT1;\r\nif(ivideo->currentvbflags & VB_DISPTYPE_CRT2) {\r\nivideo->currentvbflags |= VB_MIRROR_MODE;\r\n} else {\r\nivideo->currentvbflags |= VB_SINGLE_MODE;\r\n}\r\n}\r\nSiS_SetRegAND(SISSR, IND_SIS_RAMDAC_CONTROL, ~0x04);\r\nif(ivideo->currentvbflags & CRT2_TV) {\r\nif(ivideo->vbflags2 & VB2_SISBRIDGE) {\r\nivideo->p2_1f = SiS_GetReg(SISPART2, 0x1f);\r\nivideo->p2_20 = SiS_GetReg(SISPART2, 0x20);\r\nivideo->p2_2b = SiS_GetReg(SISPART2, 0x2b);\r\nivideo->p2_42 = SiS_GetReg(SISPART2, 0x42);\r\nivideo->p2_43 = SiS_GetReg(SISPART2, 0x43);\r\nivideo->p2_01 = SiS_GetReg(SISPART2, 0x01);\r\nivideo->p2_02 = SiS_GetReg(SISPART2, 0x02);\r\n} else if(ivideo->vbflags2 & VB2_CHRONTEL) {\r\nif(ivideo->chronteltype == 1) {\r\nivideo->tvx = SiS_GetCH700x(&ivideo->SiS_Pr, 0x0a);\r\nivideo->tvx |= (((SiS_GetCH700x(&ivideo->SiS_Pr, 0x08) & 0x02) >> 1) << 8);\r\nivideo->tvy = SiS_GetCH700x(&ivideo->SiS_Pr, 0x0b);\r\nivideo->tvy |= ((SiS_GetCH700x(&ivideo->SiS_Pr, 0x08) & 0x01) << 8);\r\n}\r\n}\r\n}\r\nif(ivideo->tvxpos) {\r\nsisfb_set_TVxposoffset(ivideo, ivideo->tvxpos);\r\n}\r\nif(ivideo->tvypos) {\r\nsisfb_set_TVyposoffset(ivideo, ivideo->tvypos);\r\n}\r\nsisfb_check_engine_and_sync(ivideo);\r\nif(ivideo->accel) {\r\nsisfb_engine_init(ivideo);\r\n} else {\r\nivideo->engineok = 0;\r\n}\r\n}\r\nstatic int\r\nsisfb_reset_mode(struct sis_video_info *ivideo)\r\n{\r\nif(sisfb_set_mode(ivideo, 0))\r\nreturn 1;\r\nsisfb_set_pitch(ivideo);\r\nsisfb_set_base_CRT1(ivideo, ivideo->current_base);\r\nsisfb_set_base_CRT2(ivideo, ivideo->current_base);\r\nreturn 0;\r\n}\r\nstatic void\r\nsisfb_handle_command(struct sis_video_info *ivideo, struct sisfb_cmd *sisfb_command)\r\n{\r\nint mycrt1off;\r\nswitch(sisfb_command->sisfb_cmd) {\r\ncase SISFB_CMD_GETVBFLAGS:\r\nif(!ivideo->modechanged) {\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_EARLY;\r\n} else {\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_OK;\r\nsisfb_command->sisfb_result[1] = ivideo->currentvbflags;\r\nsisfb_command->sisfb_result[2] = ivideo->vbflags2;\r\n}\r\nbreak;\r\ncase SISFB_CMD_SWITCHCRT1:\r\nif(!ivideo->modechanged) {\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_EARLY;\r\n} else if(sisfb_command->sisfb_arg[0] == 99) {\r\nsisfb_command->sisfb_result[1] = ivideo->sisfb_crt1off ? 0 : 1;\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_OK;\r\n} else if(ivideo->sisfblocked) {\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_LOCKED;\r\n} else if((!(ivideo->currentvbflags & CRT2_ENABLE)) &&\r\n(sisfb_command->sisfb_arg[0] == 0)) {\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_NOCRT2;\r\n} else {\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_OK;\r\nmycrt1off = sisfb_command->sisfb_arg[0] ? 0 : 1;\r\nif( ((ivideo->currentvbflags & VB_DISPTYPE_CRT1) && mycrt1off) ||\r\n((!(ivideo->currentvbflags & VB_DISPTYPE_CRT1)) && !mycrt1off) ) {\r\nivideo->sisfb_crt1off = mycrt1off;\r\nif(sisfb_reset_mode(ivideo)) {\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_OTHER;\r\n}\r\n}\r\nsisfb_command->sisfb_result[1] = ivideo->sisfb_crt1off ? 0 : 1;\r\n}\r\nbreak;\r\ndefault:\r\nsisfb_command->sisfb_result[0] = SISFB_CMD_ERR_UNKNOWN;\r\nprintk(KERN_ERR "sisfb: Unknown command 0x%x\n",\r\nsisfb_command->sisfb_cmd);\r\n}\r\n}\r\nstatic int __init sisfb_setup(char *options)\r\n{\r\nchar *this_opt;\r\nsisfb_setdefaultparms();\r\nif(!options || !(*options))\r\nreturn 0;\r\nwhile((this_opt = strsep(&options, ",")) != NULL) {\r\nif(!(*this_opt)) continue;\r\nif(!strnicmp(this_opt, "off", 3)) {\r\nsisfb_off = 1;\r\n} else if(!strnicmp(this_opt, "forcecrt2type:", 14)) {\r\nsisfb_search_crt2type(this_opt + 14);\r\n} else if(!strnicmp(this_opt, "tvmode:",7)) {\r\nsisfb_search_tvstd(this_opt + 7);\r\n} else if(!strnicmp(this_opt, "tvstandard:",11)) {\r\nsisfb_search_tvstd(this_opt + 11);\r\n} else if(!strnicmp(this_opt, "mode:", 5)) {\r\nsisfb_search_mode(this_opt + 5, false);\r\n} else if(!strnicmp(this_opt, "vesa:", 5)) {\r\nsisfb_search_vesamode(simple_strtoul(this_opt + 5, NULL, 0), false);\r\n} else if(!strnicmp(this_opt, "rate:", 5)) {\r\nsisfb_parm_rate = simple_strtoul(this_opt + 5, NULL, 0);\r\n} else if(!strnicmp(this_opt, "forcecrt1:", 10)) {\r\nsisfb_forcecrt1 = (int)simple_strtoul(this_opt + 10, NULL, 0);\r\n} else if(!strnicmp(this_opt, "mem:",4)) {\r\nsisfb_parm_mem = simple_strtoul(this_opt + 4, NULL, 0);\r\n} else if(!strnicmp(this_opt, "pdc:", 4)) {\r\nsisfb_pdc = simple_strtoul(this_opt + 4, NULL, 0);\r\n} else if(!strnicmp(this_opt, "pdc1:", 5)) {\r\nsisfb_pdca = simple_strtoul(this_opt + 5, NULL, 0);\r\n} else if(!strnicmp(this_opt, "noaccel", 7)) {\r\nsisfb_accel = 0;\r\n} else if(!strnicmp(this_opt, "accel", 5)) {\r\nsisfb_accel = -1;\r\n} else if(!strnicmp(this_opt, "noypan", 6)) {\r\nsisfb_ypan = 0;\r\n} else if(!strnicmp(this_opt, "ypan", 4)) {\r\nsisfb_ypan = -1;\r\n} else if(!strnicmp(this_opt, "nomax", 5)) {\r\nsisfb_max = 0;\r\n} else if(!strnicmp(this_opt, "max", 3)) {\r\nsisfb_max = -1;\r\n} else if(!strnicmp(this_opt, "userom:", 7)) {\r\nsisfb_userom = (int)simple_strtoul(this_opt + 7, NULL, 0);\r\n} else if(!strnicmp(this_opt, "useoem:", 7)) {\r\nsisfb_useoem = (int)simple_strtoul(this_opt + 7, NULL, 0);\r\n} else if(!strnicmp(this_opt, "nocrt2rate", 10)) {\r\nsisfb_nocrt2rate = 1;\r\n} else if(!strnicmp(this_opt, "scalelcd:", 9)) {\r\nunsigned long temp = 2;\r\ntemp = simple_strtoul(this_opt + 9, NULL, 0);\r\nif((temp == 0) || (temp == 1)) {\r\nsisfb_scalelcd = temp ^ 1;\r\n}\r\n} else if(!strnicmp(this_opt, "tvxposoffset:", 13)) {\r\nint temp = 0;\r\ntemp = (int)simple_strtol(this_opt + 13, NULL, 0);\r\nif((temp >= -32) && (temp <= 32)) {\r\nsisfb_tvxposoffset = temp;\r\n}\r\n} else if(!strnicmp(this_opt, "tvyposoffset:", 13)) {\r\nint temp = 0;\r\ntemp = (int)simple_strtol(this_opt + 13, NULL, 0);\r\nif((temp >= -32) && (temp <= 32)) {\r\nsisfb_tvyposoffset = temp;\r\n}\r\n} else if(!strnicmp(this_opt, "specialtiming:", 14)) {\r\nsisfb_search_specialtiming(this_opt + 14);\r\n} else if(!strnicmp(this_opt, "lvdshl:", 7)) {\r\nint temp = 4;\r\ntemp = simple_strtoul(this_opt + 7, NULL, 0);\r\nif((temp >= 0) && (temp <= 3)) {\r\nsisfb_lvdshl = temp;\r\n}\r\n} else if(this_opt[0] >= '0' && this_opt[0] <= '9') {\r\nsisfb_search_mode(this_opt, true);\r\n#if !defined(__i386__) && !defined(__x86_64__)\r\n} else if(!strnicmp(this_opt, "resetcard", 9)) {\r\nsisfb_resetcard = 1;\r\n} else if(!strnicmp(this_opt, "videoram:", 9)) {\r\nsisfb_videoram = simple_strtoul(this_opt + 9, NULL, 0);\r\n#endif\r\n} else {\r\nprintk(KERN_INFO "sisfb: Invalid option %s\n", this_opt);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit\r\nsisfb_check_rom(void __iomem *rom_base, struct sis_video_info *ivideo)\r\n{\r\nvoid __iomem *rom;\r\nint romptr;\r\nif((readb(rom_base) != 0x55) || (readb(rom_base + 1) != 0xaa))\r\nreturn 0;\r\nromptr = (readb(rom_base + 0x18) | (readb(rom_base + 0x19) << 8));\r\nif(romptr > (0x10000 - 8))\r\nreturn 0;\r\nrom = rom_base + romptr;\r\nif((readb(rom) != 'P') || (readb(rom + 1) != 'C') ||\r\n(readb(rom + 2) != 'I') || (readb(rom + 3) != 'R'))\r\nreturn 0;\r\nif((readb(rom + 4) | (readb(rom + 5) << 8)) != ivideo->chip_vendor)\r\nreturn 0;\r\nif((readb(rom + 6) | (readb(rom + 7) << 8)) != ivideo->chip_id)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic unsigned char * __devinit\r\nsisfb_find_rom(struct pci_dev *pdev)\r\n{\r\nstruct sis_video_info *ivideo = pci_get_drvdata(pdev);\r\nvoid __iomem *rom_base;\r\nunsigned char *myrombase = NULL;\r\nsize_t romsize;\r\nif(!ivideo->nbridge) {\r\nif((rom_base = pci_map_rom(pdev, &romsize))) {\r\nif(sisfb_check_rom(rom_base, ivideo)) {\r\nif((myrombase = vmalloc(65536))) {\r\nmemcpy_fromio(myrombase, rom_base,\r\n(romsize > 65536) ? 65536 : romsize);\r\n}\r\n}\r\npci_unmap_rom(pdev, rom_base);\r\n}\r\n}\r\nif(myrombase) return myrombase;\r\n#if defined(__i386__) || defined(__x86_64__)\r\n{\r\nu32 temp;\r\nfor (temp = 0x000c0000; temp < 0x000f0000; temp += 0x00001000) {\r\nrom_base = ioremap(temp, 65536);\r\nif (!rom_base)\r\ncontinue;\r\nif (!sisfb_check_rom(rom_base, ivideo)) {\r\niounmap(rom_base);\r\ncontinue;\r\n}\r\nif ((myrombase = vmalloc(65536)))\r\nmemcpy_fromio(myrombase, rom_base, 65536);\r\niounmap(rom_base);\r\nbreak;\r\n}\r\n}\r\n#endif\r\nreturn myrombase;\r\n}\r\nstatic void __devinit\r\nsisfb_post_map_vram(struct sis_video_info *ivideo, unsigned int *mapsize,\r\nunsigned int min)\r\n{\r\nif (*mapsize < (min << 20))\r\nreturn;\r\nivideo->video_vbase = ioremap(ivideo->video_base, (*mapsize));\r\nif(!ivideo->video_vbase) {\r\nprintk(KERN_ERR\r\n"sisfb: Unable to map maximum video RAM for size detection\n");\r\n(*mapsize) >>= 1;\r\nwhile((!(ivideo->video_vbase = ioremap(ivideo->video_base, (*mapsize))))) {\r\n(*mapsize) >>= 1;\r\nif((*mapsize) < (min << 20))\r\nbreak;\r\n}\r\nif(ivideo->video_vbase) {\r\nprintk(KERN_ERR\r\n"sisfb: Video RAM size detection limited to %dMB\n",\r\n(int)((*mapsize) >> 20));\r\n}\r\n}\r\n}\r\nstatic int __devinit\r\nsisfb_post_300_buswidth(struct sis_video_info *ivideo)\r\n{\r\nvoid __iomem *FBAddress = ivideo->video_vbase;\r\nunsigned short temp;\r\nunsigned char reg;\r\nint i, j;\r\nSiS_SetRegAND(SISSR, 0x15, 0xFB);\r\nSiS_SetRegOR(SISSR, 0x15, 0x04);\r\nSiS_SetReg(SISSR, 0x13, 0x00);\r\nSiS_SetReg(SISSR, 0x14, 0xBF);\r\nfor(i = 0; i < 2; i++) {\r\ntemp = 0x1234;\r\nfor(j = 0; j < 4; j++) {\r\nwritew(temp, FBAddress);\r\nif(readw(FBAddress) == temp)\r\nbreak;\r\nSiS_SetRegOR(SISSR, 0x3c, 0x01);\r\nreg = SiS_GetReg(SISSR, 0x05);\r\nreg = SiS_GetReg(SISSR, 0x05);\r\nSiS_SetRegAND(SISSR, 0x3c, 0xfe);\r\nreg = SiS_GetReg(SISSR, 0x05);\r\nreg = SiS_GetReg(SISSR, 0x05);\r\ntemp++;\r\n}\r\n}\r\nwritel(0x01234567L, FBAddress);\r\nwritel(0x456789ABL, (FBAddress + 4));\r\nwritel(0x89ABCDEFL, (FBAddress + 8));\r\nwritel(0xCDEF0123L, (FBAddress + 12));\r\nreg = SiS_GetReg(SISSR, 0x3b);\r\nif(reg & 0x01) {\r\nif(readl((FBAddress + 12)) == 0xCDEF0123L)\r\nreturn 4;\r\n}\r\nif(readl((FBAddress + 4)) == 0x456789ABL)\r\nreturn 2;\r\nreturn 1;\r\n}\r\nstatic int __devinit\r\nsisfb_post_300_rwtest(struct sis_video_info *ivideo, int iteration, int buswidth,\r\nint PseudoRankCapacity, int PseudoAdrPinCount,\r\nunsigned int mapsize)\r\n{\r\nvoid __iomem *FBAddr = ivideo->video_vbase;\r\nunsigned short sr14;\r\nunsigned int k, RankCapacity, PageCapacity, BankNumHigh, BankNumMid;\r\nunsigned int PhysicalAdrOtherPage, PhysicalAdrHigh, PhysicalAdrHalfPage;\r\nstatic const unsigned short SiS_DRAMType[17][5] = {\r\n{0x0C,0x0A,0x02,0x40,0x39},\r\n{0x0D,0x0A,0x01,0x40,0x48},\r\n{0x0C,0x09,0x02,0x20,0x35},\r\n{0x0D,0x09,0x01,0x20,0x44},\r\n{0x0C,0x08,0x02,0x10,0x31},\r\n{0x0D,0x08,0x01,0x10,0x40},\r\n{0x0C,0x0A,0x01,0x20,0x34},\r\n{0x0C,0x09,0x01,0x08,0x32},\r\n{0x0B,0x08,0x02,0x08,0x21},\r\n{0x0C,0x08,0x01,0x08,0x30},\r\n{0x0A,0x08,0x02,0x04,0x11},\r\n{0x0B,0x0A,0x01,0x10,0x28},\r\n{0x09,0x08,0x02,0x02,0x01},\r\n{0x0B,0x09,0x01,0x08,0x24},\r\n{0x0B,0x08,0x01,0x04,0x20},\r\n{0x0A,0x08,0x01,0x02,0x10},\r\n{0x09,0x08,0x01,0x01,0x00}\r\n};\r\nfor(k = 0; k <= 16; k++) {\r\nRankCapacity = buswidth * SiS_DRAMType[k][3];\r\nif(RankCapacity != PseudoRankCapacity)\r\ncontinue;\r\nif((SiS_DRAMType[k][2] + SiS_DRAMType[k][0]) > PseudoAdrPinCount)\r\ncontinue;\r\nBankNumHigh = RankCapacity * 16 * iteration - 1;\r\nif(iteration == 3) {\r\nBankNumMid = RankCapacity * 16 - 1;\r\n} else {\r\nBankNumMid = RankCapacity * 16 * iteration / 2 - 1;\r\n}\r\nPageCapacity = (1 << SiS_DRAMType[k][1]) * buswidth * 4;\r\nPhysicalAdrHigh = BankNumHigh;\r\nPhysicalAdrHalfPage = (PageCapacity / 2 + PhysicalAdrHigh) % PageCapacity;\r\nPhysicalAdrOtherPage = PageCapacity * SiS_DRAMType[k][2] + PhysicalAdrHigh;\r\nSiS_SetRegAND(SISSR, 0x15, 0xFB);\r\nSiS_SetRegOR(SISSR, 0x15, 0x04);\r\nsr14 = (SiS_DRAMType[k][3] * buswidth) - 1;\r\nif(buswidth == 4) sr14 |= 0x80;\r\nelse if(buswidth == 2) sr14 |= 0x40;\r\nSiS_SetReg(SISSR, 0x13, SiS_DRAMType[k][4]);\r\nSiS_SetReg(SISSR, 0x14, sr14);\r\nBankNumHigh <<= 16;\r\nBankNumMid <<= 16;\r\nif((BankNumHigh + PhysicalAdrHigh >= mapsize) ||\r\n(BankNumMid + PhysicalAdrHigh >= mapsize) ||\r\n(BankNumHigh + PhysicalAdrHalfPage >= mapsize) ||\r\n(BankNumHigh + PhysicalAdrOtherPage >= mapsize))\r\ncontinue;\r\nwritew(((unsigned short)PhysicalAdrHigh),\r\n(FBAddr + BankNumHigh + PhysicalAdrHigh));\r\nwritew(((unsigned short)BankNumMid),\r\n(FBAddr + BankNumMid + PhysicalAdrHigh));\r\nwritew(((unsigned short)PhysicalAdrHalfPage),\r\n(FBAddr + BankNumHigh + PhysicalAdrHalfPage));\r\nwritew(((unsigned short)PhysicalAdrOtherPage),\r\n(FBAddr + BankNumHigh + PhysicalAdrOtherPage));\r\nif(readw(FBAddr + BankNumHigh + PhysicalAdrHigh) == PhysicalAdrHigh)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __devinit\r\nsisfb_post_300_ramsize(struct pci_dev *pdev, unsigned int mapsize)\r\n{\r\nstruct sis_video_info *ivideo = pci_get_drvdata(pdev);\r\nint i, j, buswidth;\r\nint PseudoRankCapacity, PseudoAdrPinCount;\r\nbuswidth = sisfb_post_300_buswidth(ivideo);\r\nfor(i = 6; i >= 0; i--) {\r\nPseudoRankCapacity = 1 << i;\r\nfor(j = 4; j >= 1; j--) {\r\nPseudoAdrPinCount = 15 - j;\r\nif((PseudoRankCapacity * j) <= 64) {\r\nif(sisfb_post_300_rwtest(ivideo,\r\nj,\r\nbuswidth,\r\nPseudoRankCapacity,\r\nPseudoAdrPinCount,\r\nmapsize))\r\nreturn;\r\n}\r\n}\r\n}\r\n}\r\nstatic void __devinit\r\nsisfb_post_sis300(struct pci_dev *pdev)\r\n{\r\nstruct sis_video_info *ivideo = pci_get_drvdata(pdev);\r\nunsigned char *bios = ivideo->SiS_Pr.VirtualRomBase;\r\nu8 reg, v1, v2, v3, v4, v5, v6, v7, v8;\r\nu16 index, rindex, memtype = 0;\r\nunsigned int mapsize;\r\nif(!ivideo->SiS_Pr.UseROM)\r\nbios = NULL;\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nif(bios) {\r\nif(bios[0x52] & 0x80) {\r\nmemtype = bios[0x52];\r\n} else {\r\nmemtype = SiS_GetReg(SISSR, 0x3a);\r\n}\r\nmemtype &= 0x07;\r\n}\r\nv3 = 0x80; v6 = 0x80;\r\nif(ivideo->revision_id <= 0x13) {\r\nv1 = 0x44; v2 = 0x42;\r\nv4 = 0x44; v5 = 0x42;\r\n} else {\r\nv1 = 0x68; v2 = 0x43;\r\nv4 = 0x68; v5 = 0x43;\r\nif(bios) {\r\nindex = memtype * 5;\r\nrindex = index + 0x54;\r\nv1 = bios[rindex++];\r\nv2 = bios[rindex++];\r\nv3 = bios[rindex++];\r\nrindex = index + 0x7c;\r\nv4 = bios[rindex++];\r\nv5 = bios[rindex++];\r\nv6 = bios[rindex++];\r\n}\r\n}\r\nSiS_SetReg(SISSR, 0x28, v1);\r\nSiS_SetReg(SISSR, 0x29, v2);\r\nSiS_SetReg(SISSR, 0x2a, v3);\r\nSiS_SetReg(SISSR, 0x2e, v4);\r\nSiS_SetReg(SISSR, 0x2f, v5);\r\nSiS_SetReg(SISSR, 0x30, v6);\r\nv1 = 0x10;\r\nif(bios)\r\nv1 = bios[0xa4];\r\nSiS_SetReg(SISSR, 0x07, v1);\r\nSiS_SetReg(SISSR, 0x11, 0x0f);\r\nv1 = 0x01; v2 = 0x43; v3 = 0x1e; v4 = 0x2a;\r\nv5 = 0x06; v6 = 0x00; v7 = 0x00; v8 = 0x00;\r\nif(bios) {\r\nmemtype += 0xa5;\r\nv1 = bios[memtype];\r\nv2 = bios[memtype + 8];\r\nv3 = bios[memtype + 16];\r\nv4 = bios[memtype + 24];\r\nv5 = bios[memtype + 32];\r\nv6 = bios[memtype + 40];\r\nv7 = bios[memtype + 48];\r\nv8 = bios[memtype + 56];\r\n}\r\nif(ivideo->revision_id >= 0x80)\r\nv3 &= 0xfd;\r\nSiS_SetReg(SISSR, 0x15, v1);\r\nSiS_SetReg(SISSR, 0x16, v2);\r\nSiS_SetReg(SISSR, 0x17, v3);\r\nSiS_SetReg(SISSR, 0x18, v4);\r\nSiS_SetReg(SISSR, 0x19, v5);\r\nSiS_SetReg(SISSR, 0x1a, v6);\r\nSiS_SetReg(SISSR, 0x1b, v7);\r\nSiS_SetReg(SISSR, 0x1c, v8);\r\nSiS_SetRegAND(SISSR, 0x15, 0xfb);\r\nSiS_SetRegOR(SISSR, 0x15, 0x04);\r\nif(bios) {\r\nif(bios[0x53] & 0x02) {\r\nSiS_SetRegOR(SISSR, 0x19, 0x20);\r\n}\r\n}\r\nv1 = 0x04;\r\nif(ivideo->revision_id >= 0x80)\r\nv1 |= 0x01;\r\nSiS_SetReg(SISSR, 0x1f, v1);\r\nSiS_SetReg(SISSR, 0x20, 0xa4);\r\nv1 = 0xf6; v2 = 0x0d; v3 = 0x00;\r\nif(bios) {\r\nv1 = bios[0xe8];\r\nv2 = bios[0xe9];\r\nv3 = bios[0xea];\r\n}\r\nSiS_SetReg(SISSR, 0x23, v1);\r\nSiS_SetReg(SISSR, 0x24, v2);\r\nSiS_SetReg(SISSR, 0x25, v3);\r\nSiS_SetReg(SISSR, 0x21, 0x84);\r\nSiS_SetReg(SISSR, 0x22, 0x00);\r\nSiS_SetReg(SISCR, 0x37, 0x00);\r\nSiS_SetRegOR(SISPART1, 0x24, 0x01);\r\nSiS_SetReg(SISPART1, 0x00, 0x00);\r\nv1 = 0x40; v2 = 0x11;\r\nif(bios) {\r\nv1 = bios[0xec];\r\nv2 = bios[0xeb];\r\n}\r\nSiS_SetReg(SISPART1, 0x02, v1);\r\nif(ivideo->revision_id >= 0x80)\r\nv2 &= ~0x01;\r\nreg = SiS_GetReg(SISPART4, 0x00);\r\nif((reg == 1) || (reg == 2)) {\r\nSiS_SetReg(SISCR, 0x37, 0x02);\r\nSiS_SetReg(SISPART2, 0x00, 0x1c);\r\nv4 = 0x00; v5 = 0x00; v6 = 0x10;\r\nif(ivideo->SiS_Pr.UseROM) {\r\nv4 = bios[0xf5];\r\nv5 = bios[0xf6];\r\nv6 = bios[0xf7];\r\n}\r\nSiS_SetReg(SISPART4, 0x0d, v4);\r\nSiS_SetReg(SISPART4, 0x0e, v5);\r\nSiS_SetReg(SISPART4, 0x10, v6);\r\nSiS_SetReg(SISPART4, 0x0f, 0x3f);\r\nreg = SiS_GetReg(SISPART4, 0x01);\r\nif(reg >= 0xb0) {\r\nreg = SiS_GetReg(SISPART4, 0x23);\r\nreg &= 0x20;\r\nreg <<= 1;\r\nSiS_SetReg(SISPART4, 0x23, reg);\r\n}\r\n} else {\r\nv2 &= ~0x10;\r\n}\r\nSiS_SetReg(SISSR, 0x32, v2);\r\nSiS_SetRegAND(SISPART1, 0x24, 0xfe);\r\nreg = SiS_GetReg(SISSR, 0x16);\r\nreg &= 0xc3;\r\nSiS_SetReg(SISCR, 0x35, reg);\r\nSiS_SetReg(SISCR, 0x83, 0x00);\r\n#if !defined(__i386__) && !defined(__x86_64__)\r\nif(sisfb_videoram) {\r\nSiS_SetReg(SISSR, 0x13, 0x28);\r\nreg = ((sisfb_videoram >> 10) - 1) | 0x40;\r\nSiS_SetReg(SISSR, 0x14, reg);\r\n} else {\r\n#endif\r\nmapsize = ivideo->video_size;\r\nsisfb_post_map_vram(ivideo, &mapsize, 4);\r\nif(ivideo->video_vbase) {\r\nsisfb_post_300_ramsize(pdev, mapsize);\r\niounmap(ivideo->video_vbase);\r\n} else {\r\nprintk(KERN_DEBUG\r\n"sisfb: Failed to map memory for size detection, assuming 8MB\n");\r\nSiS_SetReg(SISSR, 0x13, 0x28);\r\nSiS_SetReg(SISSR, 0x14, 0x47);\r\n}\r\n#if !defined(__i386__) && !defined(__x86_64__)\r\n}\r\n#endif\r\nif(bios) {\r\nv1 = bios[0xe6];\r\nv2 = bios[0xe7];\r\n} else {\r\nreg = SiS_GetReg(SISSR, 0x3a);\r\nif((reg & 0x30) == 0x30) {\r\nv1 = 0x04;\r\nv2 = 0x92;\r\n} else {\r\nv1 = 0x14;\r\nv2 = 0xb2;\r\n}\r\n}\r\nSiS_SetReg(SISSR, 0x21, v1);\r\nSiS_SetReg(SISSR, 0x22, v2);\r\nsisfb_sense_crt1(ivideo);\r\nivideo->SiS_Pr.SiS_UseOEM = false;\r\nSiS_SetEnableDstn(&ivideo->SiS_Pr, false);\r\nSiS_SetEnableFstn(&ivideo->SiS_Pr, false);\r\nivideo->curFSTN = ivideo->curDSTN = 0;\r\nivideo->SiS_Pr.VideoMemorySize = 8 << 20;\r\nSiSSetMode(&ivideo->SiS_Pr, 0x2e | 0x80);\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nSiS_SetRegOR(SISSR, 0x01, 0x20);\r\nSiS_SetReg(SISCR, 0x34, 0x2e);\r\nivideo->modeprechange = 0x2e;\r\n}\r\nstatic inline int sisfb_xgi_is21(struct sis_video_info *ivideo)\r\n{\r\nreturn ivideo->chip_real_id == XGI_21;\r\n}\r\nstatic void __devinit\r\nsisfb_post_xgi_delay(struct sis_video_info *ivideo, int delay)\r\n{\r\nunsigned int i;\r\nu8 reg;\r\nfor(i = 0; i <= (delay * 10 * 36); i++) {\r\nreg = SiS_GetReg(SISSR, 0x05);\r\nreg++;\r\n}\r\n}\r\nstatic int __devinit\r\nsisfb_find_host_bridge(struct sis_video_info *ivideo, struct pci_dev *mypdev,\r\nunsigned short pcivendor)\r\n{\r\nstruct pci_dev *pdev = NULL;\r\nunsigned short temp;\r\nint ret = 0;\r\nwhile((pdev = pci_get_class(PCI_CLASS_BRIDGE_HOST, pdev))) {\r\ntemp = pdev->vendor;\r\nif(temp == pcivendor) {\r\nret = 1;\r\npci_dev_put(pdev);\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devinit\r\nsisfb_post_xgi_rwtest(struct sis_video_info *ivideo, int starta,\r\nunsigned int enda, unsigned int mapsize)\r\n{\r\nunsigned int pos;\r\nint i;\r\nwritel(0, ivideo->video_vbase);\r\nfor(i = starta; i <= enda; i++) {\r\npos = 1 << i;\r\nif(pos < mapsize)\r\nwritel(pos, ivideo->video_vbase + pos);\r\n}\r\nsisfb_post_xgi_delay(ivideo, 150);\r\nif(readl(ivideo->video_vbase) != 0)\r\nreturn 0;\r\nfor(i = starta; i <= enda; i++) {\r\npos = 1 << i;\r\nif(pos < mapsize) {\r\nif(readl(ivideo->video_vbase + pos) != pos)\r\nreturn 0;\r\n} else\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int __devinit\r\nsisfb_post_xgi_ramsize(struct sis_video_info *ivideo)\r\n{\r\nunsigned int buswidth, ranksize, channelab, mapsize;\r\nint i, j, k, l, status;\r\nu8 reg, sr14;\r\nstatic const u8 dramsr13[12 * 5] = {\r\n0x02, 0x0e, 0x0b, 0x80, 0x5d,\r\n0x02, 0x0e, 0x0a, 0x40, 0x59,\r\n0x02, 0x0d, 0x0b, 0x40, 0x4d,\r\n0x02, 0x0e, 0x09, 0x20, 0x55,\r\n0x02, 0x0d, 0x0a, 0x20, 0x49,\r\n0x02, 0x0c, 0x0b, 0x20, 0x3d,\r\n0x02, 0x0e, 0x08, 0x10, 0x51,\r\n0x02, 0x0d, 0x09, 0x10, 0x45,\r\n0x02, 0x0c, 0x0a, 0x10, 0x39,\r\n0x02, 0x0d, 0x08, 0x08, 0x41,\r\n0x02, 0x0c, 0x09, 0x08, 0x35,\r\n0x02, 0x0c, 0x08, 0x04, 0x31\r\n};\r\nstatic const u8 dramsr13_4[4 * 5] = {\r\n0x02, 0x0d, 0x09, 0x40, 0x45,\r\n0x02, 0x0c, 0x09, 0x20, 0x35,\r\n0x02, 0x0c, 0x08, 0x10, 0x31,\r\n0x02, 0x0b, 0x08, 0x08, 0x21\r\n};\r\nSiS_SetRegOR(SISSR, 0x20, (0x80 | 0x04));\r\nmapsize = ivideo->video_size;\r\nsisfb_post_map_vram(ivideo, &mapsize, 32);\r\nif(!ivideo->video_vbase) {\r\nprintk(KERN_ERR "sisfb: Unable to detect RAM size. Setting default.\n");\r\nSiS_SetReg(SISSR, 0x13, 0x35);\r\nSiS_SetReg(SISSR, 0x14, 0x41);\r\nreturn -ENOMEM;\r\n}\r\nSiS_SetReg(SISSR, 0x15, 0x00);\r\nSiS_SetReg(SISSR, 0x1c, 0x00);\r\nif(ivideo->chip == XGI_20) {\r\nchannelab = 1;\r\nreg = SiS_GetReg(SISCR, 0x97);\r\nif(!(reg & 0x01)) {\r\nbuswidth = 32;\r\nSiS_SetReg(SISSR, 0x13, 0xb1);\r\nSiS_SetReg(SISSR, 0x14, 0x52);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nsr14 = 0x02;\r\nif(sisfb_post_xgi_rwtest(ivideo, 23, 24, mapsize))\r\ngoto bail_out;\r\nSiS_SetReg(SISSR, 0x13, 0x31);\r\nSiS_SetReg(SISSR, 0x14, 0x42);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nif(sisfb_post_xgi_rwtest(ivideo, 23, 23, mapsize))\r\ngoto bail_out;\r\nbuswidth = 16;\r\nSiS_SetReg(SISSR, 0x13, 0xb1);\r\nSiS_SetReg(SISSR, 0x14, 0x41);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nsr14 = 0x01;\r\nif(sisfb_post_xgi_rwtest(ivideo, 22, 23, mapsize))\r\ngoto bail_out;\r\nelse\r\nSiS_SetReg(SISSR, 0x13, 0x31);\r\n} else {\r\nbuswidth = 16;\r\nSiS_SetReg(SISSR, 0x13, 0xb1);\r\nSiS_SetReg(SISSR, 0x14, 0x41);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nsr14 = 0x01;\r\nif(sisfb_post_xgi_rwtest(ivideo, 22, 23, mapsize))\r\ngoto bail_out;\r\nSiS_SetReg(SISSR, 0x13, 0x31);\r\nSiS_SetReg(SISSR, 0x14, 0x31);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nif(sisfb_post_xgi_rwtest(ivideo, 22, 22, mapsize))\r\ngoto bail_out;\r\nbuswidth = 8;\r\nSiS_SetReg(SISSR, 0x13, 0xb1);\r\nSiS_SetReg(SISSR, 0x14, 0x30);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nsr14 = 0x00;\r\nif(sisfb_post_xgi_rwtest(ivideo, 21, 22, mapsize))\r\ngoto bail_out;\r\nelse\r\nSiS_SetReg(SISSR, 0x13, 0x31);\r\n}\r\n} else {\r\nreg = SiS_GetReg(SISCR, 0x97);\r\nif(!(reg & 0x10)) {\r\nreg = SiS_GetReg(SISSR, 0x39);\r\nreg >>= 1;\r\n}\r\nif(reg & 0x01) {\r\nbuswidth = 32;\r\nif(ivideo->revision_id == 2) {\r\nchannelab = 2;\r\nSiS_SetReg(SISSR, 0x13, 0xa1);\r\nSiS_SetReg(SISSR, 0x14, 0x44);\r\nsr14 = 0x04;\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nif(sisfb_post_xgi_rwtest(ivideo, 23, 24, mapsize))\r\ngoto bail_out;\r\nSiS_SetReg(SISSR, 0x13, 0x21);\r\nSiS_SetReg(SISSR, 0x14, 0x34);\r\nif(sisfb_post_xgi_rwtest(ivideo, 22, 23, mapsize))\r\ngoto bail_out;\r\nchannelab = 1;\r\nSiS_SetReg(SISSR, 0x13, 0xa1);\r\nSiS_SetReg(SISSR, 0x14, 0x40);\r\nsr14 = 0x00;\r\nif(sisfb_post_xgi_rwtest(ivideo, 22, 23, mapsize))\r\ngoto bail_out;\r\nSiS_SetReg(SISSR, 0x13, 0x21);\r\nSiS_SetReg(SISSR, 0x14, 0x30);\r\n} else {\r\nchannelab = 3;\r\nSiS_SetReg(SISSR, 0x13, 0xa1);\r\nSiS_SetReg(SISSR, 0x14, 0x4c);\r\nsr14 = 0x0c;\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nif(sisfb_post_xgi_rwtest(ivideo, 23, 25, mapsize))\r\ngoto bail_out;\r\nchannelab = 2;\r\nSiS_SetReg(SISSR, 0x14, 0x48);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nsr14 = 0x08;\r\nif(sisfb_post_xgi_rwtest(ivideo, 23, 24, mapsize))\r\ngoto bail_out;\r\nSiS_SetReg(SISSR, 0x13, 0x21);\r\nSiS_SetReg(SISSR, 0x14, 0x3c);\r\nsr14 = 0x0c;\r\nif(sisfb_post_xgi_rwtest(ivideo, 23, 24, mapsize)) {\r\nchannelab = 3;\r\n} else {\r\nchannelab = 2;\r\nSiS_SetReg(SISSR, 0x14, 0x38);\r\nsr14 = 0x08;\r\n}\r\n}\r\nsisfb_post_xgi_delay(ivideo, 1);\r\n} else {\r\nbuswidth = 64;\r\nif(ivideo->revision_id == 2) {\r\nchannelab = 1;\r\nSiS_SetReg(SISSR, 0x13, 0xa1);\r\nSiS_SetReg(SISSR, 0x14, 0x52);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nsr14 = 0x02;\r\nif(sisfb_post_xgi_rwtest(ivideo, 23, 24, mapsize))\r\ngoto bail_out;\r\nSiS_SetReg(SISSR, 0x13, 0x21);\r\nSiS_SetReg(SISSR, 0x14, 0x42);\r\n} else {\r\nchannelab = 2;\r\nSiS_SetReg(SISSR, 0x13, 0xa1);\r\nSiS_SetReg(SISSR, 0x14, 0x5a);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nsr14 = 0x0a;\r\nif(sisfb_post_xgi_rwtest(ivideo, 24, 25, mapsize))\r\ngoto bail_out;\r\nSiS_SetReg(SISSR, 0x13, 0x21);\r\nSiS_SetReg(SISSR, 0x14, 0x4a);\r\n}\r\nsisfb_post_xgi_delay(ivideo, 1);\r\n}\r\n}\r\nbail_out:\r\nSiS_SetRegANDOR(SISSR, 0x14, 0xf0, sr14);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nj = (ivideo->chip == XGI_20) ? 5 : 9;\r\nk = (ivideo->chip == XGI_20) ? 12 : 4;\r\nstatus = -EIO;\r\nfor(i = 0; i < k; i++) {\r\nreg = (ivideo->chip == XGI_20) ?\r\ndramsr13[(i * 5) + 4] : dramsr13_4[(i * 5) + 4];\r\nSiS_SetRegANDOR(SISSR, 0x13, 0x80, reg);\r\nsisfb_post_xgi_delay(ivideo, 50);\r\nranksize = (ivideo->chip == XGI_20) ?\r\ndramsr13[(i * 5) + 3] : dramsr13_4[(i * 5) + 3];\r\nreg = SiS_GetReg(SISSR, 0x13);\r\nif(reg & 0x80) ranksize <<= 1;\r\nif(ivideo->chip == XGI_20) {\r\nif(buswidth == 16) ranksize <<= 1;\r\nelse if(buswidth == 32) ranksize <<= 2;\r\n} else {\r\nif(buswidth == 64) ranksize <<= 1;\r\n}\r\nreg = 0;\r\nl = channelab;\r\nif(l == 3) l = 4;\r\nif((ranksize * l) <= 256) {\r\nwhile((ranksize >>= 1)) reg += 0x10;\r\n}\r\nif(!reg) continue;\r\nSiS_SetRegANDOR(SISSR, 0x14, 0x0f, (reg & 0xf0));\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nif (sisfb_post_xgi_rwtest(ivideo, j, ((reg >> 4) + channelab - 2 + 20), mapsize)) {\r\nstatus = 0;\r\nbreak;\r\n}\r\n}\r\niounmap(ivideo->video_vbase);\r\nreturn status;\r\n}\r\nstatic void __devinit\r\nsisfb_post_xgi_setclocks(struct sis_video_info *ivideo, u8 regb)\r\n{\r\nu8 v1, v2, v3;\r\nint index;\r\nstatic const u8 cs90[8 * 3] = {\r\n0x16, 0x01, 0x01,\r\n0x3e, 0x03, 0x01,\r\n0x7c, 0x08, 0x01,\r\n0x79, 0x06, 0x01,\r\n0x29, 0x01, 0x81,\r\n0x5c, 0x23, 0x01,\r\n0x5c, 0x23, 0x01,\r\n0x5c, 0x23, 0x01\r\n};\r\nstatic const u8 csb8[8 * 3] = {\r\n0x5c, 0x23, 0x01,\r\n0x29, 0x01, 0x01,\r\n0x7c, 0x08, 0x01,\r\n0x79, 0x06, 0x01,\r\n0x29, 0x01, 0x81,\r\n0x5c, 0x23, 0x01,\r\n0x5c, 0x23, 0x01,\r\n0x5c, 0x23, 0x01\r\n};\r\nregb = 0;\r\nindex = regb * 3;\r\nv1 = cs90[index]; v2 = cs90[index + 1]; v3 = cs90[index + 2];\r\nif(ivideo->haveXGIROM) {\r\nv1 = ivideo->bios_abase[0x90 + index];\r\nv2 = ivideo->bios_abase[0x90 + index + 1];\r\nv3 = ivideo->bios_abase[0x90 + index + 2];\r\n}\r\nSiS_SetReg(SISSR, 0x28, v1);\r\nSiS_SetReg(SISSR, 0x29, v2);\r\nSiS_SetReg(SISSR, 0x2a, v3);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nindex = regb * 3;\r\nv1 = csb8[index]; v2 = csb8[index + 1]; v3 = csb8[index + 2];\r\nif(ivideo->haveXGIROM) {\r\nv1 = ivideo->bios_abase[0xb8 + index];\r\nv2 = ivideo->bios_abase[0xb8 + index + 1];\r\nv3 = ivideo->bios_abase[0xb8 + index + 2];\r\n}\r\nSiS_SetReg(SISSR, 0x2e, v1);\r\nSiS_SetReg(SISSR, 0x2f, v2);\r\nSiS_SetReg(SISSR, 0x30, v3);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\n}\r\nstatic void __devinit\r\nsisfb_post_xgi_ddr2_mrs_default(struct sis_video_info *ivideo, u8 regb)\r\n{\r\nunsigned char *bios = ivideo->bios_abase;\r\nu8 v1;\r\nSiS_SetReg(SISSR, 0x28, 0x64);\r\nSiS_SetReg(SISSR, 0x29, 0x63);\r\nsisfb_post_xgi_delay(ivideo, 15);\r\nSiS_SetReg(SISSR, 0x18, 0x00);\r\nSiS_SetReg(SISSR, 0x19, 0x20);\r\nSiS_SetReg(SISSR, 0x16, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x80);\r\nSiS_SetReg(SISSR, 0x18, 0xc5);\r\nSiS_SetReg(SISSR, 0x19, 0x23);\r\nSiS_SetReg(SISSR, 0x16, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x80);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nSiS_SetReg(SISCR, 0x97, 0x11);\r\nsisfb_post_xgi_setclocks(ivideo, regb);\r\nsisfb_post_xgi_delay(ivideo, 0x46);\r\nSiS_SetReg(SISSR, 0x18, 0xc5);\r\nSiS_SetReg(SISSR, 0x19, 0x23);\r\nSiS_SetReg(SISSR, 0x16, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x80);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nSiS_SetReg(SISSR, 0x1b, 0x04);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nSiS_SetReg(SISSR, 0x1b, 0x00);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nv1 = 0x31;\r\nif (ivideo->haveXGIROM) {\r\nv1 = bios[0xf0];\r\n}\r\nSiS_SetReg(SISSR, 0x18, v1);\r\nSiS_SetReg(SISSR, 0x19, 0x06);\r\nSiS_SetReg(SISSR, 0x16, 0x04);\r\nSiS_SetReg(SISSR, 0x16, 0x84);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\n}\r\nstatic void __devinit\r\nsisfb_post_xgi_ddr2_mrs_xg21(struct sis_video_info *ivideo)\r\n{\r\nsisfb_post_xgi_setclocks(ivideo, 1);\r\nSiS_SetReg(SISCR, 0x97, 0x11);\r\nsisfb_post_xgi_delay(ivideo, 0x46);\r\nSiS_SetReg(SISSR, 0x18, 0x00);\r\nSiS_SetReg(SISSR, 0x19, 0x80);\r\nSiS_SetReg(SISSR, 0x16, 0x05);\r\nSiS_SetReg(SISSR, 0x16, 0x85);\r\nSiS_SetReg(SISSR, 0x18, 0x00);\r\nSiS_SetReg(SISSR, 0x19, 0xc0);\r\nSiS_SetReg(SISSR, 0x16, 0x05);\r\nSiS_SetReg(SISSR, 0x16, 0x85);\r\nSiS_SetReg(SISSR, 0x18, 0x00);\r\nSiS_SetReg(SISSR, 0x19, 0x40);\r\nSiS_SetReg(SISSR, 0x16, 0x05);\r\nSiS_SetReg(SISSR, 0x16, 0x85);\r\nSiS_SetReg(SISSR, 0x18, 0x42);\r\nSiS_SetReg(SISSR, 0x19, 0x02);\r\nSiS_SetReg(SISSR, 0x16, 0x05);\r\nSiS_SetReg(SISSR, 0x16, 0x85);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nSiS_SetReg(SISSR, 0x1b, 0x04);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nSiS_SetReg(SISSR, 0x1b, 0x00);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\nSiS_SetReg(SISSR, 0x18, 0x42);\r\nSiS_SetReg(SISSR, 0x19, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x05);\r\nSiS_SetReg(SISSR, 0x16, 0x85);\r\nsisfb_post_xgi_delay(ivideo, 1);\r\n}\r\nstatic void __devinit\r\nsisfb_post_xgi_ddr2(struct sis_video_info *ivideo, u8 regb)\r\n{\r\nunsigned char *bios = ivideo->bios_abase;\r\nstatic const u8 cs158[8] = {\r\n0x88, 0xaa, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs160[8] = {\r\n0x44, 0x77, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs168[8] = {\r\n0x48, 0x78, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nu8 reg;\r\nu8 v1;\r\nu8 v2;\r\nu8 v3;\r\nSiS_SetReg(SISCR, 0xb0, 0x80);\r\nSiS_SetReg(SISCR, 0x82, 0x77);\r\nSiS_SetReg(SISCR, 0x86, 0x00);\r\nreg = SiS_GetReg(SISCR, 0x86);\r\nSiS_SetReg(SISCR, 0x86, 0x88);\r\nreg = SiS_GetReg(SISCR, 0x86);\r\nv1 = cs168[regb]; v2 = cs160[regb]; v3 = cs158[regb];\r\nif (ivideo->haveXGIROM) {\r\nv1 = bios[regb + 0x168];\r\nv2 = bios[regb + 0x160];\r\nv3 = bios[regb + 0x158];\r\n}\r\nSiS_SetReg(SISCR, 0x86, v1);\r\nSiS_SetReg(SISCR, 0x82, 0x77);\r\nSiS_SetReg(SISCR, 0x85, 0x00);\r\nreg = SiS_GetReg(SISCR, 0x85);\r\nSiS_SetReg(SISCR, 0x85, 0x88);\r\nreg = SiS_GetReg(SISCR, 0x85);\r\nSiS_SetReg(SISCR, 0x85, v2);\r\nSiS_SetReg(SISCR, 0x82, v3);\r\nSiS_SetReg(SISCR, 0x98, 0x01);\r\nSiS_SetReg(SISCR, 0x9a, 0x02);\r\nif (sisfb_xgi_is21(ivideo))\r\nsisfb_post_xgi_ddr2_mrs_xg21(ivideo);\r\nelse\r\nsisfb_post_xgi_ddr2_mrs_default(ivideo, regb);\r\n}\r\nstatic u8 __devinit\r\nsisfb_post_xgi_ramtype(struct sis_video_info *ivideo)\r\n{\r\nunsigned char *bios = ivideo->bios_abase;\r\nu8 ramtype;\r\nu8 reg;\r\nu8 v1;\r\nramtype = 0x00; v1 = 0x10;\r\nif (ivideo->haveXGIROM) {\r\nramtype = bios[0x62];\r\nv1 = bios[0x1d2];\r\n}\r\nif (!(ramtype & 0x80)) {\r\nif (sisfb_xgi_is21(ivideo)) {\r\nSiS_SetRegAND(SISCR, 0xb4, 0xfd);\r\nSiS_SetRegOR(SISCR, 0x4a, 0x80);\r\nreg = SiS_GetReg(SISCR, 0x48);\r\nSiS_SetRegOR(SISCR, 0xb4, 0x02);\r\nramtype = reg & 0x01;\r\n} else if (ivideo->chip == XGI_20) {\r\nSiS_SetReg(SISCR, 0x97, v1);\r\nreg = SiS_GetReg(SISCR, 0x97);\r\nif (reg & 0x10) {\r\nramtype = (reg & 0x01) << 1;\r\n}\r\n} else {\r\nreg = SiS_GetReg(SISSR, 0x39);\r\nramtype = reg & 0x02;\r\nif (!(ramtype)) {\r\nreg = SiS_GetReg(SISSR, 0x3a);\r\nramtype = (reg >> 1) & 0x01;\r\n}\r\n}\r\n}\r\nramtype &= 0x07;\r\nreturn ramtype;\r\n}\r\nstatic int __devinit\r\nsisfb_post_xgi(struct pci_dev *pdev)\r\n{\r\nstruct sis_video_info *ivideo = pci_get_drvdata(pdev);\r\nunsigned char *bios = ivideo->bios_abase;\r\nstruct pci_dev *mypdev = NULL;\r\nconst u8 *ptr, *ptr2;\r\nu8 v1, v2, v3, v4, v5, reg, ramtype;\r\nu32 rega, regb, regd;\r\nint i, j, k, index;\r\nstatic const u8 cs78[3] = { 0xf6, 0x0d, 0x00 };\r\nstatic const u8 cs76[2] = { 0xa3, 0xfb };\r\nstatic const u8 cs7b[3] = { 0xc0, 0x11, 0x00 };\r\nstatic const u8 cs158[8] = {\r\n0x88, 0xaa, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs160[8] = {\r\n0x44, 0x77, 0x77, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs168[8] = {\r\n0x48, 0x78, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs128[3 * 8] = {\r\n0x90, 0x28, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x77, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x77, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs148[2 * 8] = {\r\n0x55, 0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs31a[8 * 4] = {\r\n0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,\r\n0xaa, 0xaa, 0xaa, 0xaa, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs33a[8 * 4] = {\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs45a[8 * 2] = {\r\n0x00, 0x00, 0xa0, 0x00, 0xa0, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs170[7 * 8] = {\r\n0x54, 0x32, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x54, 0x43, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x0a, 0x05, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x44, 0x34, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x10, 0x0a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x11, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x05, 0x05, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs1a8[3 * 8] = {\r\n0xf0, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x05, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nstatic const u8 cs100[2 * 8] = {\r\n0xc4, 0x04, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0xc4, 0x04, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nreg = SiS_GetRegByte(SISVGAENABLE) | 0x01;\r\nSiS_SetRegByte(SISVGAENABLE, reg);\r\nreg = SiS_GetRegByte(SISMISCR) | 0x01;\r\nSiS_SetRegByte(SISMISCW, reg);\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nreg = SiS_GetReg(SISSR, 0x05);\r\nif(reg != 0xa1)\r\nreturn 0;\r\nfor(i = 0; i < 0x22; i++) {\r\nif(0x06 + i == 0x20) continue;\r\nSiS_SetReg(SISSR, 0x06 + i, 0x00);\r\n}\r\nfor(i = 0; i < 0x0b; i++) {\r\nSiS_SetReg(SISSR, 0x31 + i, 0x00);\r\n}\r\nfor(i = 0; i < 0x10; i++) {\r\nSiS_SetReg(SISCR, 0x30 + i, 0x00);\r\n}\r\nptr = cs78;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x78];\r\n}\r\nfor(i = 0; i < 3; i++) {\r\nSiS_SetReg(SISSR, 0x23 + i, ptr[i]);\r\n}\r\nptr = cs76;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x76];\r\n}\r\nfor(i = 0; i < 2; i++) {\r\nSiS_SetReg(SISSR, 0x21 + i, ptr[i]);\r\n}\r\nv1 = 0x18; v2 = 0x00;\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[0x74];\r\nv2 = bios[0x75];\r\n}\r\nSiS_SetReg(SISSR, 0x07, v1);\r\nSiS_SetReg(SISSR, 0x11, 0x0f);\r\nSiS_SetReg(SISSR, 0x1f, v2);\r\nSiS_SetReg(SISSR, 0x20, 0x80 | 0x20 | 0x04);\r\nSiS_SetReg(SISSR, 0x27, 0x74);\r\nptr = cs7b;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x7b];\r\n}\r\nfor(i = 0; i < 3; i++) {\r\nSiS_SetReg(SISSR, 0x31 + i, ptr[i]);\r\n}\r\nif(ivideo->chip == XGI_40) {\r\nif(ivideo->revision_id == 2) {\r\nSiS_SetRegANDOR(SISSR, 0x3b, 0x3f, 0xc0);\r\n}\r\nSiS_SetReg(SISCR, 0x7d, 0xfe);\r\nSiS_SetReg(SISCR, 0x7e, 0x0f);\r\n}\r\nif(ivideo->revision_id == 0) {\r\nSiS_SetRegAND(SISCR, 0x58, 0xd7);\r\nreg = SiS_GetReg(SISCR, 0xcb);\r\nif(reg & 0x20) {\r\nSiS_SetRegANDOR(SISCR, 0x58, 0xd7, (reg & 0x10) ? 0x08 : 0x20);\r\n}\r\n}\r\nreg = (ivideo->chip == XGI_40) ? 0x20 : 0x00;\r\nSiS_SetRegANDOR(SISCR, 0x38, 0x1f, reg);\r\nif(ivideo->chip == XGI_20) {\r\nSiS_SetReg(SISSR, 0x36, 0x70);\r\n} else {\r\nSiS_SetReg(SISVID, 0x00, 0x86);\r\nSiS_SetReg(SISVID, 0x32, 0x00);\r\nSiS_SetReg(SISVID, 0x30, 0x00);\r\nSiS_SetReg(SISVID, 0x32, 0x01);\r\nSiS_SetReg(SISVID, 0x30, 0x00);\r\nSiS_SetRegAND(SISVID, 0x2f, 0xdf);\r\nSiS_SetRegAND(SISCAP, 0x00, 0x3f);\r\nSiS_SetReg(SISPART1, 0x2f, 0x01);\r\nSiS_SetReg(SISPART1, 0x00, 0x00);\r\nSiS_SetReg(SISPART1, 0x02, bios[0x7e]);\r\nSiS_SetReg(SISPART1, 0x2e, 0x08);\r\nSiS_SetRegAND(SISPART1, 0x35, 0x7f);\r\nSiS_SetRegAND(SISPART1, 0x50, 0xfe);\r\nreg = SiS_GetReg(SISPART4, 0x00);\r\nif(reg == 1 || reg == 2) {\r\nSiS_SetReg(SISPART2, 0x00, 0x1c);\r\nSiS_SetReg(SISPART4, 0x0d, bios[0x7f]);\r\nSiS_SetReg(SISPART4, 0x0e, bios[0x80]);\r\nSiS_SetReg(SISPART4, 0x10, bios[0x81]);\r\nSiS_SetRegAND(SISPART4, 0x0f, 0x3f);\r\nreg = SiS_GetReg(SISPART4, 0x01);\r\nif((reg & 0xf0) >= 0xb0) {\r\nreg = SiS_GetReg(SISPART4, 0x23);\r\nif(reg & 0x20) reg |= 0x40;\r\nSiS_SetReg(SISPART4, 0x23, reg);\r\nreg = (reg & 0x20) ? 0x02 : 0x00;\r\nSiS_SetRegANDOR(SISPART1, 0x1e, 0xfd, reg);\r\n}\r\n}\r\nv1 = bios[0x77];\r\nreg = SiS_GetReg(SISSR, 0x3b);\r\nif(reg & 0x02) {\r\nreg = SiS_GetReg(SISSR, 0x3a);\r\nv2 = (reg & 0x30) >> 3;\r\nif(!(v2 & 0x04)) v2 ^= 0x02;\r\nreg = SiS_GetReg(SISSR, 0x39);\r\nif(reg & 0x80) v2 |= 0x80;\r\nv2 |= 0x01;\r\nif((mypdev = pci_get_device(PCI_VENDOR_ID_SI, 0x0730, NULL))) {\r\npci_dev_put(mypdev);\r\nif(((v2 & 0x06) == 2) || ((v2 & 0x06) == 4))\r\nv2 &= 0xf9;\r\nv2 |= 0x08;\r\nv1 &= 0xfe;\r\n} else {\r\nmypdev = pci_get_device(PCI_VENDOR_ID_SI, 0x0735, NULL);\r\nif(!mypdev)\r\nmypdev = pci_get_device(PCI_VENDOR_ID_SI, 0x0645, NULL);\r\nif(!mypdev)\r\nmypdev = pci_get_device(PCI_VENDOR_ID_SI, 0x0650, NULL);\r\nif(mypdev) {\r\npci_read_config_dword(mypdev, 0x94, &regd);\r\nregd &= 0xfffffeff;\r\npci_write_config_dword(mypdev, 0x94, regd);\r\nv1 &= 0xfe;\r\npci_dev_put(mypdev);\r\n} else if(sisfb_find_host_bridge(ivideo, pdev, PCI_VENDOR_ID_SI)) {\r\nv1 &= 0xfe;\r\n} else if(sisfb_find_host_bridge(ivideo, pdev, 0x1106) ||\r\nsisfb_find_host_bridge(ivideo, pdev, 0x1022) ||\r\nsisfb_find_host_bridge(ivideo, pdev, 0x700e) ||\r\nsisfb_find_host_bridge(ivideo, pdev, 0x10de)) {\r\nif((v2 & 0x06) == 4)\r\nv2 ^= 0x06;\r\nv2 |= 0x08;\r\n}\r\n}\r\nSiS_SetRegANDOR(SISCR, 0x5f, 0xf0, v2);\r\n}\r\nSiS_SetReg(SISSR, 0x22, v1);\r\nif(ivideo->revision_id == 2) {\r\nv1 = SiS_GetReg(SISSR, 0x3b);\r\nv2 = SiS_GetReg(SISSR, 0x3a);\r\nregd = bios[0x90 + 3] | (bios[0x90 + 4] << 8);\r\nif( (!(v1 & 0x02)) && (v2 & 0x30) && (regd < 0xcf) )\r\nSiS_SetRegANDOR(SISCR, 0x5f, 0xf1, 0x01);\r\nif((mypdev = pci_get_device(0x10de, 0x01e0, NULL))) {\r\nif(0)\r\nSiS_SetRegANDOR(SISCR, 0x5f, 0xf1, 0x01);\r\npci_dev_put(mypdev);\r\n}\r\n}\r\nv1 = 0x30;\r\nreg = SiS_GetReg(SISSR, 0x3b);\r\nv2 = SiS_GetReg(SISCR, 0x5f);\r\nif((!(reg & 0x02)) && (v2 & 0x0e))\r\nv1 |= 0x08;\r\nSiS_SetReg(SISSR, 0x27, v1);\r\nif(bios[0x64] & 0x01) {\r\nSiS_SetRegANDOR(SISCR, 0x5f, 0xf0, bios[0x64]);\r\n}\r\nv1 = bios[0x4f7];\r\npci_read_config_dword(pdev, 0x50, &regd);\r\nregd = (regd >> 20) & 0x0f;\r\nif(regd == 1) {\r\nv1 &= 0xfc;\r\nSiS_SetRegOR(SISCR, 0x5f, 0x08);\r\n}\r\nSiS_SetReg(SISCR, 0x48, v1);\r\nSiS_SetRegANDOR(SISCR, 0x47, 0x04, bios[0x4f6] & 0xfb);\r\nSiS_SetRegANDOR(SISCR, 0x49, 0xf0, bios[0x4f8] & 0x0f);\r\nSiS_SetRegANDOR(SISCR, 0x4a, 0x60, bios[0x4f9] & 0x9f);\r\nSiS_SetRegANDOR(SISCR, 0x4b, 0x08, bios[0x4fa] & 0xf7);\r\nSiS_SetRegANDOR(SISCR, 0x4c, 0x80, bios[0x4fb] & 0x7f);\r\nSiS_SetReg(SISCR, 0x70, bios[0x4fc]);\r\nSiS_SetRegANDOR(SISCR, 0x71, 0xf0, bios[0x4fd] & 0x0f);\r\nSiS_SetReg(SISCR, 0x74, 0xd0);\r\nSiS_SetRegANDOR(SISCR, 0x74, 0xcf, bios[0x4fe] & 0x30);\r\nSiS_SetRegANDOR(SISCR, 0x75, 0xe0, bios[0x4ff] & 0x1f);\r\nSiS_SetRegANDOR(SISCR, 0x76, 0xe0, bios[0x500] & 0x1f);\r\nv1 = bios[0x501];\r\nif((mypdev = pci_get_device(0x8086, 0x2530, NULL))) {\r\nv1 = 0xf0;\r\npci_dev_put(mypdev);\r\n}\r\nSiS_SetReg(SISCR, 0x77, v1);\r\n}\r\nramtype = sisfb_post_xgi_ramtype(ivideo);\r\nif (!sisfb_xgi_is21(ivideo) && ramtype) {\r\ndev_warn(&pdev->dev,\r\n"RAM type something else than expected: %d\n",\r\nramtype);\r\nregb = 0;\r\n} else {\r\nregb = ramtype;\r\n}\r\nv1 = 0xff;\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[0x140 + regb];\r\n}\r\nSiS_SetReg(SISCR, 0x6d, v1);\r\nptr = cs128;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x128];\r\n}\r\nfor(i = 0, j = 0; i < 3; i++, j += 8) {\r\nSiS_SetReg(SISCR, 0x68 + i, ptr[j + regb]);\r\n}\r\nptr = cs31a;\r\nptr2 = cs33a;\r\nif(ivideo->haveXGIROM) {\r\nindex = (ivideo->chip == XGI_20) ? 0x31a : 0x3a6;\r\nptr = (const u8 *)&bios[index];\r\nptr2 = (const u8 *)&bios[index + 0x20];\r\n}\r\nfor(i = 0; i < 2; i++) {\r\nif(i == 0) {\r\nregd = le32_to_cpu(((u32 *)ptr)[regb]);\r\nrega = 0x6b;\r\n} else {\r\nregd = le32_to_cpu(((u32 *)ptr2)[regb]);\r\nrega = 0x6e;\r\n}\r\nreg = 0x00;\r\nfor(j = 0; j < 16; j++) {\r\nreg &= 0xf3;\r\nif(regd & 0x01) reg |= 0x04;\r\nif(regd & 0x02) reg |= 0x08;\r\nregd >>= 2;\r\nSiS_SetReg(SISCR, rega, reg);\r\nreg = SiS_GetReg(SISCR, rega);\r\nreg = SiS_GetReg(SISCR, rega);\r\nreg += 0x10;\r\n}\r\n}\r\nSiS_SetRegAND(SISCR, 0x6e, 0xfc);\r\nptr = NULL;\r\nif(ivideo->haveXGIROM) {\r\nindex = (ivideo->chip == XGI_20) ? 0x35a : 0x3e6;\r\nptr = (const u8 *)&bios[index];\r\n}\r\nfor(i = 0; i < 4; i++) {\r\nSiS_SetRegANDOR(SISCR, 0x6e, 0xfc, i);\r\nreg = 0x00;\r\nfor(j = 0; j < 2; j++) {\r\nregd = 0;\r\nif(ptr) {\r\nregd = le32_to_cpu(((u32 *)ptr)[regb * 8]);\r\nptr += 4;\r\n}\r\nfor(k = 0; k < 16; k++) {\r\nreg &= 0xfc;\r\nif(regd & 0x01) reg |= 0x01;\r\nif(regd & 0x02) reg |= 0x02;\r\nregd >>= 2;\r\nSiS_SetReg(SISCR, 0x6f, reg);\r\nreg = SiS_GetReg(SISCR, 0x6f);\r\nreg = SiS_GetReg(SISCR, 0x6f);\r\nreg += 0x08;\r\n}\r\n}\r\n}\r\nptr = cs148;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x148];\r\n}\r\nfor(i = 0, j = 0; i < 2; i++, j += 8) {\r\nSiS_SetReg(SISCR, 0x80 + i, ptr[j + regb]);\r\n}\r\nSiS_SetRegAND(SISCR, 0x89, 0x8f);\r\nptr = cs45a;\r\nif(ivideo->haveXGIROM) {\r\nindex = (ivideo->chip == XGI_20) ? 0x45a : 0x4e6;\r\nptr = (const u8 *)&bios[index];\r\n}\r\nregd = le16_to_cpu(((const u16 *)ptr)[regb]);\r\nreg = 0x80;\r\nfor(i = 0; i < 5; i++) {\r\nreg &= 0xfc;\r\nif(regd & 0x01) reg |= 0x01;\r\nif(regd & 0x02) reg |= 0x02;\r\nregd >>= 2;\r\nSiS_SetReg(SISCR, 0x89, reg);\r\nreg = SiS_GetReg(SISCR, 0x89);\r\nreg = SiS_GetReg(SISCR, 0x89);\r\nreg += 0x10;\r\n}\r\nv1 = 0xb5; v2 = 0x20; v3 = 0xf0; v4 = 0x13;\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[0x118 + regb];\r\nv2 = bios[0xf8 + regb];\r\nv3 = bios[0x120 + regb];\r\nv4 = bios[0x1ca];\r\n}\r\nSiS_SetReg(SISCR, 0x45, v1 & 0x0f);\r\nSiS_SetReg(SISCR, 0x99, (v1 >> 4) & 0x07);\r\nSiS_SetRegOR(SISCR, 0x40, v1 & 0x80);\r\nSiS_SetReg(SISCR, 0x41, v2);\r\nptr = cs170;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x170];\r\n}\r\nfor(i = 0, j = 0; i < 7; i++, j += 8) {\r\nSiS_SetReg(SISCR, 0x90 + i, ptr[j + regb]);\r\n}\r\nSiS_SetReg(SISCR, 0x59, v3);\r\nptr = cs1a8;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x1a8];\r\n}\r\nfor(i = 0, j = 0; i < 3; i++, j += 8) {\r\nSiS_SetReg(SISCR, 0xc3 + i, ptr[j + regb]);\r\n}\r\nptr = cs100;\r\nif(ivideo->haveXGIROM) {\r\nptr = (const u8 *)&bios[0x100];\r\n}\r\nfor(i = 0, j = 0; i < 2; i++, j += 8) {\r\nSiS_SetReg(SISCR, 0x8a + i, ptr[j + regb]);\r\n}\r\nSiS_SetReg(SISCR, 0xcf, v4);\r\nSiS_SetReg(SISCR, 0x83, 0x09);\r\nSiS_SetReg(SISCR, 0x87, 0x00);\r\nif(ivideo->chip == XGI_40) {\r\nif( (ivideo->revision_id == 1) ||\r\n(ivideo->revision_id == 2) ) {\r\nSiS_SetReg(SISCR, 0x8c, 0x87);\r\n}\r\n}\r\nif (regb == 1)\r\nSiS_SetReg(SISSR, 0x17, 0x80);\r\nelse\r\nSiS_SetReg(SISSR, 0x17, 0x00);\r\nSiS_SetReg(SISSR, 0x1a, 0x87);\r\nif(ivideo->chip == XGI_20) {\r\nSiS_SetReg(SISSR, 0x15, 0x00);\r\nSiS_SetReg(SISSR, 0x1c, 0x00);\r\n}\r\nswitch(ramtype) {\r\ncase 0:\r\nsisfb_post_xgi_setclocks(ivideo, regb);\r\nif((ivideo->chip == XGI_20) ||\r\n(ivideo->revision_id == 1) ||\r\n(ivideo->revision_id == 2)) {\r\nv1 = cs158[regb]; v2 = cs160[regb]; v3 = cs168[regb];\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[regb + 0x158];\r\nv2 = bios[regb + 0x160];\r\nv3 = bios[regb + 0x168];\r\n}\r\nSiS_SetReg(SISCR, 0x82, v1);\r\nSiS_SetReg(SISCR, 0x85, v2);\r\nSiS_SetReg(SISCR, 0x86, v3);\r\n} else {\r\nSiS_SetReg(SISCR, 0x82, 0x88);\r\nSiS_SetReg(SISCR, 0x86, 0x00);\r\nreg = SiS_GetReg(SISCR, 0x86);\r\nSiS_SetReg(SISCR, 0x86, 0x88);\r\nreg = SiS_GetReg(SISCR, 0x86);\r\nSiS_SetReg(SISCR, 0x86, bios[regb + 0x168]);\r\nSiS_SetReg(SISCR, 0x82, 0x77);\r\nSiS_SetReg(SISCR, 0x85, 0x00);\r\nreg = SiS_GetReg(SISCR, 0x85);\r\nSiS_SetReg(SISCR, 0x85, 0x88);\r\nreg = SiS_GetReg(SISCR, 0x85);\r\nSiS_SetReg(SISCR, 0x85, bios[regb + 0x160]);\r\nSiS_SetReg(SISCR, 0x82, bios[regb + 0x158]);\r\n}\r\nif(ivideo->chip == XGI_40) {\r\nSiS_SetReg(SISCR, 0x97, 0x00);\r\n}\r\nSiS_SetReg(SISCR, 0x98, 0x01);\r\nSiS_SetReg(SISCR, 0x9a, 0x02);\r\nSiS_SetReg(SISSR, 0x18, 0x01);\r\nif((ivideo->chip == XGI_20) ||\r\n(ivideo->revision_id == 2)) {\r\nSiS_SetReg(SISSR, 0x19, 0x40);\r\n} else {\r\nSiS_SetReg(SISSR, 0x19, 0x20);\r\n}\r\nSiS_SetReg(SISSR, 0x16, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x80);\r\nif((ivideo->chip == XGI_20) || (bios[0x1cb] != 0x0c)) {\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nSiS_SetReg(SISSR, 0x18, 0x00);\r\nif((ivideo->chip == XGI_20) ||\r\n(ivideo->revision_id == 2)) {\r\nSiS_SetReg(SISSR, 0x19, 0x40);\r\n} else {\r\nSiS_SetReg(SISSR, 0x19, 0x20);\r\n}\r\n} else if((ivideo->chip == XGI_40) && (bios[0x1cb] == 0x0c)) {\r\n}\r\nSiS_SetReg(SISSR, 0x16, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x80);\r\nsisfb_post_xgi_delay(ivideo, 4);\r\nv1 = 0x31; v2 = 0x03; v3 = 0x83; v4 = 0x03; v5 = 0x83;\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[0xf0];\r\nindex = (ivideo->chip == XGI_20) ? 0x4b2 : 0x53e;\r\nv2 = bios[index];\r\nv3 = bios[index + 1];\r\nv4 = bios[index + 2];\r\nv5 = bios[index + 3];\r\n}\r\nSiS_SetReg(SISSR, 0x18, v1);\r\nSiS_SetReg(SISSR, 0x19, ((ivideo->chip == XGI_20) ? 0x02 : 0x01));\r\nSiS_SetReg(SISSR, 0x16, v2);\r\nSiS_SetReg(SISSR, 0x16, v3);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nSiS_SetReg(SISSR, 0x1b, 0x03);\r\nsisfb_post_xgi_delay(ivideo, 0x22);\r\nSiS_SetReg(SISSR, 0x18, v1);\r\nSiS_SetReg(SISSR, 0x19, 0x00);\r\nSiS_SetReg(SISSR, 0x16, v4);\r\nSiS_SetReg(SISSR, 0x16, v5);\r\nSiS_SetReg(SISSR, 0x1b, 0x00);\r\nbreak;\r\ncase 1:\r\nsisfb_post_xgi_ddr2(ivideo, regb);\r\nbreak;\r\ndefault:\r\nsisfb_post_xgi_setclocks(ivideo, regb);\r\nif((ivideo->chip == XGI_40) &&\r\n((ivideo->revision_id == 1) ||\r\n(ivideo->revision_id == 2))) {\r\nSiS_SetReg(SISCR, 0x82, bios[regb + 0x158]);\r\nSiS_SetReg(SISCR, 0x85, bios[regb + 0x160]);\r\nSiS_SetReg(SISCR, 0x86, bios[regb + 0x168]);\r\n} else {\r\nSiS_SetReg(SISCR, 0x82, 0x88);\r\nSiS_SetReg(SISCR, 0x86, 0x00);\r\nreg = SiS_GetReg(SISCR, 0x86);\r\nSiS_SetReg(SISCR, 0x86, 0x88);\r\nSiS_SetReg(SISCR, 0x82, 0x77);\r\nSiS_SetReg(SISCR, 0x85, 0x00);\r\nreg = SiS_GetReg(SISCR, 0x85);\r\nSiS_SetReg(SISCR, 0x85, 0x88);\r\nreg = SiS_GetReg(SISCR, 0x85);\r\nv1 = cs160[regb]; v2 = cs158[regb];\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[regb + 0x160];\r\nv2 = bios[regb + 0x158];\r\n}\r\nSiS_SetReg(SISCR, 0x85, v1);\r\nSiS_SetReg(SISCR, 0x82, v2);\r\n}\r\nif(ivideo->chip == XGI_40) {\r\nSiS_SetReg(SISCR, 0x97, 0x11);\r\n}\r\nif((ivideo->chip == XGI_40) && (ivideo->revision_id == 2)) {\r\nSiS_SetReg(SISCR, 0x98, 0x01);\r\n} else {\r\nSiS_SetReg(SISCR, 0x98, 0x03);\r\n}\r\nSiS_SetReg(SISCR, 0x9a, 0x02);\r\nif(ivideo->chip == XGI_40) {\r\nSiS_SetReg(SISSR, 0x18, 0x01);\r\n} else {\r\nSiS_SetReg(SISSR, 0x18, 0x00);\r\n}\r\nSiS_SetReg(SISSR, 0x19, 0x40);\r\nSiS_SetReg(SISSR, 0x16, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x80);\r\nif((ivideo->chip == XGI_40) && (bios[0x1cb] != 0x0c)) {\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nSiS_SetReg(SISSR, 0x18, 0x00);\r\nSiS_SetReg(SISSR, 0x19, 0x40);\r\nSiS_SetReg(SISSR, 0x16, 0x00);\r\nSiS_SetReg(SISSR, 0x16, 0x80);\r\n}\r\nsisfb_post_xgi_delay(ivideo, 4);\r\nv1 = 0x31;\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[0xf0];\r\n}\r\nSiS_SetReg(SISSR, 0x18, v1);\r\nSiS_SetReg(SISSR, 0x19, 0x01);\r\nif(ivideo->chip == XGI_40) {\r\nSiS_SetReg(SISSR, 0x16, bios[0x53e]);\r\nSiS_SetReg(SISSR, 0x16, bios[0x53f]);\r\n} else {\r\nSiS_SetReg(SISSR, 0x16, 0x05);\r\nSiS_SetReg(SISSR, 0x16, 0x85);\r\n}\r\nsisfb_post_xgi_delay(ivideo, 0x43);\r\nif(ivideo->chip == XGI_40) {\r\nSiS_SetReg(SISSR, 0x1b, 0x01);\r\n} else {\r\nSiS_SetReg(SISSR, 0x1b, 0x03);\r\n}\r\nsisfb_post_xgi_delay(ivideo, 0x22);\r\nSiS_SetReg(SISSR, 0x18, v1);\r\nSiS_SetReg(SISSR, 0x19, 0x00);\r\nif(ivideo->chip == XGI_40) {\r\nSiS_SetReg(SISSR, 0x16, bios[0x540]);\r\nSiS_SetReg(SISSR, 0x16, bios[0x541]);\r\n} else {\r\nSiS_SetReg(SISSR, 0x16, 0x05);\r\nSiS_SetReg(SISSR, 0x16, 0x85);\r\n}\r\nSiS_SetReg(SISSR, 0x1b, 0x00);\r\n}\r\nregb = 0;\r\nv1 = 0x03;\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[0x110 + regb];\r\n}\r\nSiS_SetReg(SISSR, 0x1b, v1);\r\nv1 = 0x00; v2 = 0x00;\r\nif(ivideo->haveXGIROM) {\r\nv1 = bios[0x62];\r\nv2 = bios[0x63];\r\n}\r\nregb = 0;\r\nregd = 1 << regb;\r\nif((v1 & 0x40) && (v2 & regd) && ivideo->haveXGIROM) {\r\nSiS_SetReg(SISSR, 0x13, bios[regb + 0xe0]);\r\nSiS_SetReg(SISSR, 0x14, bios[regb + 0xe0 + 8]);\r\n} else {\r\nint err;\r\nivideo->SiS_Pr.SiS_UseOEM = false;\r\nSiS_SetEnableDstn(&ivideo->SiS_Pr, false);\r\nSiS_SetEnableFstn(&ivideo->SiS_Pr, false);\r\nivideo->curFSTN = ivideo->curDSTN = 0;\r\nivideo->SiS_Pr.VideoMemorySize = 8 << 20;\r\nSiSSetMode(&ivideo->SiS_Pr, 0x2e | 0x80);\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nSiS_SetRegAND(SISSR, 0x21, 0xdf);\r\nerr = sisfb_post_xgi_ramsize(ivideo);\r\nSiS_SetRegOR(SISSR, 0x21, 0x20);\r\nif (err) {\r\ndev_err(&pdev->dev,\r\n"%s: RAM size detection failed: %d\n",\r\n__func__, err);\r\nreturn 0;\r\n}\r\n}\r\n#if 0\r\nprintk(KERN_DEBUG "-----------------\n");\r\nfor(i = 0; i < 0xff; i++) {\r\nreg = SiS_GetReg(SISCR, i);\r\nprintk(KERN_DEBUG "CR%02x(%x) = 0x%02x\n", i, SISCR, reg);\r\n}\r\nfor(i = 0; i < 0x40; i++) {\r\nreg = SiS_GetReg(SISSR, i);\r\nprintk(KERN_DEBUG "SR%02x(%x) = 0x%02x\n", i, SISSR, reg);\r\n}\r\nprintk(KERN_DEBUG "-----------------\n");\r\n#endif\r\nif(ivideo->chip == XGI_20) {\r\nSiS_SetRegOR(SISCR, 0x32, 0x20);\r\n} else {\r\nreg = SiS_GetReg(SISPART4, 0x00);\r\nif((reg == 1) || (reg == 2)) {\r\nsisfb_sense_crt1(ivideo);\r\n} else {\r\nSiS_SetRegOR(SISCR, 0x32, 0x20);\r\n}\r\n}\r\nivideo->SiS_Pr.SiS_UseOEM = false;\r\nSiS_SetEnableDstn(&ivideo->SiS_Pr, false);\r\nSiS_SetEnableFstn(&ivideo->SiS_Pr, false);\r\nivideo->curFSTN = ivideo->curDSTN = 0;\r\nSiSSetMode(&ivideo->SiS_Pr, 0x2e | 0x80);\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nSiS_SetRegOR(SISSR, 0x01, 0x20);\r\nSiS_SetReg(SISCR, 0x34, 0x2e);\r\nivideo->modeprechange = 0x2e;\r\nif(ivideo->chip == XGI_40) {\r\nreg = SiS_GetReg(SISCR, 0xca);\r\nv1 = SiS_GetReg(SISCR, 0xcc);\r\nif((reg & 0x10) && (!(v1 & 0x04))) {\r\nprintk(KERN_ERR\r\n"sisfb: Please connect power to the card.\n");\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nstatic int __devinit\r\nsisfb_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct sisfb_chip_info *chipinfo = &sisfb_chip_info[ent->driver_data];\r\nstruct sis_video_info *ivideo = NULL;\r\nstruct fb_info *sis_fb_info = NULL;\r\nu16 reg16;\r\nu8 reg;\r\nint i, ret;\r\nif(sisfb_off)\r\nreturn -ENXIO;\r\nsis_fb_info = framebuffer_alloc(sizeof(*ivideo), &pdev->dev);\r\nif(!sis_fb_info)\r\nreturn -ENOMEM;\r\nivideo = (struct sis_video_info *)sis_fb_info->par;\r\nivideo->memyselfandi = sis_fb_info;\r\nivideo->sisfb_id = SISFB_ID;\r\nif(card_list == NULL) {\r\nivideo->cardnumber = 0;\r\n} else {\r\nstruct sis_video_info *countvideo = card_list;\r\nivideo->cardnumber = 1;\r\nwhile((countvideo = countvideo->next) != NULL)\r\nivideo->cardnumber++;\r\n}\r\nstrncpy(ivideo->myid, chipinfo->chip_name, 30);\r\nivideo->warncount = 0;\r\nivideo->chip_id = pdev->device;\r\nivideo->chip_vendor = pdev->vendor;\r\nivideo->revision_id = pdev->revision;\r\nivideo->SiS_Pr.ChipRevision = ivideo->revision_id;\r\npci_read_config_word(pdev, PCI_COMMAND, &reg16);\r\nivideo->sisvga_enabled = reg16 & 0x01;\r\nivideo->pcibus = pdev->bus->number;\r\nivideo->pcislot = PCI_SLOT(pdev->devfn);\r\nivideo->pcifunc = PCI_FUNC(pdev->devfn);\r\nivideo->subsysvendor = pdev->subsystem_vendor;\r\nivideo->subsysdevice = pdev->subsystem_device;\r\n#ifndef MODULE\r\nif(sisfb_mode_idx == -1) {\r\nsisfb_get_vga_mode_from_kernel();\r\n}\r\n#endif\r\nivideo->chip = chipinfo->chip;\r\nivideo->chip_real_id = chipinfo->chip;\r\nivideo->sisvga_engine = chipinfo->vgaengine;\r\nivideo->hwcursor_size = chipinfo->hwcursor_size;\r\nivideo->CRT2_write_enable = chipinfo->CRT2_write_enable;\r\nivideo->mni = chipinfo->mni;\r\nivideo->detectedpdc = 0xff;\r\nivideo->detectedpdca = 0xff;\r\nivideo->detectedlcda = 0xff;\r\nivideo->sisfb_thismonitor.datavalid = false;\r\nivideo->current_base = 0;\r\nivideo->engineok = 0;\r\nivideo->sisfb_was_boot_device = 0;\r\nif(pdev->resource[PCI_ROM_RESOURCE].flags & IORESOURCE_ROM_SHADOW) {\r\nif(ivideo->sisvga_enabled)\r\nivideo->sisfb_was_boot_device = 1;\r\nelse {\r\nprintk(KERN_DEBUG "sisfb: PCI device is disabled, "\r\n"but marked as boot video device ???\n");\r\nprintk(KERN_DEBUG "sisfb: I will not accept this "\r\n"as the primary VGA device\n");\r\n}\r\n}\r\nivideo->sisfb_parm_mem = sisfb_parm_mem;\r\nivideo->sisfb_accel = sisfb_accel;\r\nivideo->sisfb_ypan = sisfb_ypan;\r\nivideo->sisfb_max = sisfb_max;\r\nivideo->sisfb_userom = sisfb_userom;\r\nivideo->sisfb_useoem = sisfb_useoem;\r\nivideo->sisfb_mode_idx = sisfb_mode_idx;\r\nivideo->sisfb_parm_rate = sisfb_parm_rate;\r\nivideo->sisfb_crt1off = sisfb_crt1off;\r\nivideo->sisfb_forcecrt1 = sisfb_forcecrt1;\r\nivideo->sisfb_crt2type = sisfb_crt2type;\r\nivideo->sisfb_crt2flags = sisfb_crt2flags;\r\nivideo->sisfb_dstn = sisfb_dstn;\r\nivideo->sisfb_fstn = sisfb_fstn;\r\nivideo->sisfb_tvplug = sisfb_tvplug;\r\nivideo->sisfb_tvstd = sisfb_tvstd;\r\nivideo->tvxpos = sisfb_tvxposoffset;\r\nivideo->tvypos = sisfb_tvyposoffset;\r\nivideo->sisfb_nocrt2rate = sisfb_nocrt2rate;\r\nivideo->refresh_rate = 0;\r\nif(ivideo->sisfb_parm_rate != -1) {\r\nivideo->refresh_rate = ivideo->sisfb_parm_rate;\r\n}\r\nivideo->SiS_Pr.UsePanelScaler = sisfb_scalelcd;\r\nivideo->SiS_Pr.CenterScreen = -1;\r\nivideo->SiS_Pr.SiS_CustomT = sisfb_specialtiming;\r\nivideo->SiS_Pr.LVDSHL = sisfb_lvdshl;\r\nivideo->SiS_Pr.SiS_Backup70xx = 0xff;\r\nivideo->SiS_Pr.SiS_CHOverScan = -1;\r\nivideo->SiS_Pr.SiS_ChSW = false;\r\nivideo->SiS_Pr.SiS_UseLCDA = false;\r\nivideo->SiS_Pr.HaveEMI = false;\r\nivideo->SiS_Pr.HaveEMILCD = false;\r\nivideo->SiS_Pr.OverruleEMI = false;\r\nivideo->SiS_Pr.SiS_SensibleSR11 = false;\r\nivideo->SiS_Pr.SiS_MyCR63 = 0x63;\r\nivideo->SiS_Pr.PDC = -1;\r\nivideo->SiS_Pr.PDCA = -1;\r\nivideo->SiS_Pr.DDCPortMixup = false;\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->chip >= SIS_330) {\r\nivideo->SiS_Pr.SiS_MyCR63 = 0x53;\r\nif(ivideo->chip >= SIS_661) {\r\nivideo->SiS_Pr.SiS_SensibleSR11 = true;\r\n}\r\n}\r\n#endif\r\nmemcpy(&ivideo->default_var, &my_default_var, sizeof(my_default_var));\r\npci_set_drvdata(pdev, ivideo);\r\nif((ivideo->nbridge = sisfb_get_northbridge(ivideo->chip))) {\r\nswitch(ivideo->nbridge->device) {\r\n#ifdef CONFIG_FB_SIS_300\r\ncase PCI_DEVICE_ID_SI_730:\r\nivideo->chip = SIS_730;\r\nstrcpy(ivideo->myid, "SiS 730");\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\ncase PCI_DEVICE_ID_SI_651:\r\nstrcpy(ivideo->myid, "SiS 651");\r\nbreak;\r\ncase PCI_DEVICE_ID_SI_740:\r\nivideo->chip = SIS_740;\r\nstrcpy(ivideo->myid, "SiS 740");\r\nbreak;\r\ncase PCI_DEVICE_ID_SI_661:\r\nivideo->chip = SIS_661;\r\nstrcpy(ivideo->myid, "SiS 661");\r\nbreak;\r\ncase PCI_DEVICE_ID_SI_741:\r\nivideo->chip = SIS_741;\r\nstrcpy(ivideo->myid, "SiS 741");\r\nbreak;\r\ncase PCI_DEVICE_ID_SI_760:\r\nivideo->chip = SIS_760;\r\nstrcpy(ivideo->myid, "SiS 760");\r\nbreak;\r\ncase PCI_DEVICE_ID_SI_761:\r\nivideo->chip = SIS_761;\r\nstrcpy(ivideo->myid, "SiS 761");\r\nbreak;\r\n#endif\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nivideo->SiS_Pr.ChipType = ivideo->chip;\r\nivideo->SiS_Pr.ivideo = (void *)ivideo;\r\n#ifdef CONFIG_FB_SIS_315\r\nif((ivideo->SiS_Pr.ChipType == SIS_315PRO) ||\r\n(ivideo->SiS_Pr.ChipType == SIS_315)) {\r\nivideo->SiS_Pr.ChipType = SIS_315H;\r\n}\r\n#endif\r\nif(!ivideo->sisvga_enabled) {\r\nif(pci_enable_device(pdev)) {\r\nif(ivideo->nbridge) pci_dev_put(ivideo->nbridge);\r\npci_set_drvdata(pdev, NULL);\r\nframebuffer_release(sis_fb_info);\r\nreturn -EIO;\r\n}\r\n}\r\nivideo->video_base = pci_resource_start(pdev, 0);\r\nivideo->video_size = pci_resource_len(pdev, 0);\r\nivideo->mmio_base = pci_resource_start(pdev, 1);\r\nivideo->mmio_size = pci_resource_len(pdev, 1);\r\nivideo->SiS_Pr.RelIO = pci_resource_start(pdev, 2) + 0x30;\r\nivideo->SiS_Pr.IOAddress = ivideo->vga_base = ivideo->SiS_Pr.RelIO;\r\nSiSRegInit(&ivideo->SiS_Pr, ivideo->SiS_Pr.IOAddress);\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->chip == SIS_630) {\r\ni = 0;\r\ndo {\r\nif(mychswtable[i].subsysVendor == ivideo->subsysvendor &&\r\nmychswtable[i].subsysCard == ivideo->subsysdevice) {\r\nivideo->SiS_Pr.SiS_ChSW = true;\r\nprintk(KERN_DEBUG "sisfb: Identified [%s %s] "\r\n"requiring Chrontel/GPIO setup\n",\r\nmychswtable[i].vendorName,\r\nmychswtable[i].cardName);\r\nivideo->lpcdev = pci_get_device(PCI_VENDOR_ID_SI, 0x0008, NULL);\r\nbreak;\r\n}\r\ni++;\r\n} while(mychswtable[i].subsysVendor != 0);\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif((ivideo->chip == SIS_760) && (ivideo->nbridge)) {\r\nivideo->lpcdev = pci_get_slot(ivideo->nbridge->bus, (2 << 3));\r\n}\r\n#endif\r\nSiS_SetReg(SISSR, 0x05, 0x86);\r\nif( (!ivideo->sisvga_enabled)\r\n#if !defined(__i386__) && !defined(__x86_64__)\r\n|| (sisfb_resetcard)\r\n#endif\r\n) {\r\nfor(i = 0x30; i <= 0x3f; i++) {\r\nSiS_SetReg(SISCR, i, 0x00);\r\n}\r\n}\r\nivideo->modeprechange = 0x03;\r\nreg = SiS_GetReg(SISCR, 0x34);\r\nif(reg & 0x7f) {\r\nivideo->modeprechange = reg & 0x7f;\r\n} else if(ivideo->sisvga_enabled) {\r\n#if defined(__i386__) || defined(__x86_64__)\r\nunsigned char __iomem *tt = ioremap(0x400, 0x100);\r\nif(tt) {\r\nivideo->modeprechange = readb(tt + 0x49);\r\niounmap(tt);\r\n}\r\n#endif\r\n}\r\nivideo->bios_abase = NULL;\r\nivideo->SiS_Pr.VirtualRomBase = NULL;\r\nivideo->SiS_Pr.UseROM = false;\r\nivideo->haveXGIROM = ivideo->SiS_Pr.SiS_XGIROM = false;\r\nif(ivideo->sisfb_userom) {\r\nivideo->SiS_Pr.VirtualRomBase = sisfb_find_rom(pdev);\r\nivideo->bios_abase = ivideo->SiS_Pr.VirtualRomBase;\r\nivideo->SiS_Pr.UseROM = (bool)(ivideo->SiS_Pr.VirtualRomBase);\r\nprintk(KERN_INFO "sisfb: Video ROM %sfound\n",\r\nivideo->SiS_Pr.UseROM ? "" : "not ");\r\nif((ivideo->SiS_Pr.UseROM) && (ivideo->chip >= XGI_20)) {\r\nivideo->SiS_Pr.UseROM = false;\r\nivideo->haveXGIROM = ivideo->SiS_Pr.SiS_XGIROM = true;\r\nif( (ivideo->revision_id == 2) &&\r\n(!(ivideo->bios_abase[0x1d1] & 0x01)) ) {\r\nivideo->SiS_Pr.DDCPortMixup = true;\r\n}\r\n}\r\n} else {\r\nprintk(KERN_INFO "sisfb: Video ROM usage disabled\n");\r\n}\r\nif(ivideo->SiS_Pr.SiS_CustomT == CUT_NONE) {\r\nsisfb_detect_custom_timing(ivideo);\r\n}\r\n#ifdef CONFIG_FB_SIS_315\r\nif (ivideo->chip == XGI_20) {\r\nSiS_SetRegOR(SISCR, 0x4a, 0x40);\r\nreg = SiS_GetReg(SISCR, 0x48);\r\nif (reg & 0x02) {\r\nivideo->chip_real_id = XGI_21;\r\ndev_info(&pdev->dev, "Z9 detected\n");\r\n}\r\n}\r\n#endif\r\nif( (!ivideo->sisvga_enabled)\r\n#if !defined(__i386__) && !defined(__x86_64__)\r\n|| (sisfb_resetcard)\r\n#endif\r\n) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nif(ivideo->chip == SIS_300) {\r\nsisfb_post_sis300(pdev);\r\nivideo->sisfb_can_post = 1;\r\n}\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nint result = 1;\r\nif(ivideo->chip == XGI_20) {\r\nresult = sisfb_post_xgi(pdev);\r\nivideo->sisfb_can_post = 1;\r\n} else if((ivideo->chip == XGI_40) && ivideo->haveXGIROM) {\r\nresult = sisfb_post_xgi(pdev);\r\nivideo->sisfb_can_post = 1;\r\n} else {\r\nprintk(KERN_INFO "sisfb: Card is not "\r\n"POSTed and sisfb can't do this either.\n");\r\n}\r\nif(!result) {\r\nprintk(KERN_ERR "sisfb: Failed to POST card\n");\r\nret = -ENODEV;\r\ngoto error_3;\r\n}\r\n}\r\n#endif\r\n}\r\nivideo->sisfb_card_posted = 1;\r\nif(sisfb_get_dram_size(ivideo)) {\r\nprintk(KERN_INFO "sisfb: Fatal error: Unable to determine VRAM size.\n");\r\nret = -ENODEV;\r\ngoto error_3;\r\n}\r\nif((ivideo->sisfb_mode_idx < 0) ||\r\n((sisbios_mode[ivideo->sisfb_mode_idx].mode_no[ivideo->mni]) != 0xFF)) {\r\nSiS_SetRegOR(SISSR, IND_SIS_PCI_ADDRESS_SET, (SIS_PCI_ADDR_ENABLE | SIS_MEM_MAP_IO_ENABLE));\r\nSiS_SetRegOR(SISSR, IND_SIS_MODULE_ENABLE, SIS_ENABLE_2D);\r\n}\r\nif(sisfb_pdc != 0xff) {\r\nif(ivideo->sisvga_engine == SIS_300_VGA)\r\nsisfb_pdc &= 0x3c;\r\nelse\r\nsisfb_pdc &= 0x1f;\r\nivideo->SiS_Pr.PDC = sisfb_pdc;\r\n}\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ivideo->sisvga_engine == SIS_315_VGA) {\r\nif(sisfb_pdca != 0xff)\r\nivideo->SiS_Pr.PDCA = sisfb_pdca & 0x1f;\r\n}\r\n#endif\r\nif(!request_mem_region(ivideo->video_base, ivideo->video_size, "sisfb FB")) {\r\nprintk(KERN_ERR "sisfb: Fatal error: Unable to reserve %dMB framebuffer memory\n",\r\n(int)(ivideo->video_size >> 20));\r\nprintk(KERN_ERR "sisfb: Is there another framebuffer driver active?\n");\r\nret = -ENODEV;\r\ngoto error_3;\r\n}\r\nif(!request_mem_region(ivideo->mmio_base, ivideo->mmio_size, "sisfb MMIO")) {\r\nprintk(KERN_ERR "sisfb: Fatal error: Unable to reserve MMIO region\n");\r\nret = -ENODEV;\r\ngoto error_2;\r\n}\r\nivideo->video_vbase = ioremap(ivideo->video_base, ivideo->video_size);\r\nivideo->SiS_Pr.VideoMemoryAddress = ivideo->video_vbase;\r\nif(!ivideo->video_vbase) {\r\nprintk(KERN_ERR "sisfb: Fatal error: Unable to map framebuffer memory\n");\r\nret = -ENODEV;\r\ngoto error_1;\r\n}\r\nivideo->mmio_vbase = ioremap(ivideo->mmio_base, ivideo->mmio_size);\r\nif(!ivideo->mmio_vbase) {\r\nprintk(KERN_ERR "sisfb: Fatal error: Unable to map MMIO region\n");\r\nret = -ENODEV;\r\nerror_0: iounmap(ivideo->video_vbase);\r\nerror_1: release_mem_region(ivideo->video_base, ivideo->video_size);\r\nerror_2: release_mem_region(ivideo->mmio_base, ivideo->mmio_size);\r\nerror_3: vfree(ivideo->bios_abase);\r\nif(ivideo->lpcdev)\r\npci_dev_put(ivideo->lpcdev);\r\nif(ivideo->nbridge)\r\npci_dev_put(ivideo->nbridge);\r\npci_set_drvdata(pdev, NULL);\r\nif(!ivideo->sisvga_enabled)\r\npci_disable_device(pdev);\r\nframebuffer_release(sis_fb_info);\r\nreturn ret;\r\n}\r\nprintk(KERN_INFO "sisfb: Video RAM at 0x%lx, mapped to 0x%lx, size %ldk\n",\r\nivideo->video_base, (unsigned long)ivideo->video_vbase, ivideo->video_size / 1024);\r\nif(ivideo->video_offset) {\r\nprintk(KERN_INFO "sisfb: Viewport offset %ldk\n",\r\nivideo->video_offset / 1024);\r\n}\r\nprintk(KERN_INFO "sisfb: MMIO at 0x%lx, mapped to 0x%lx, size %ldk\n",\r\nivideo->mmio_base, (unsigned long)ivideo->mmio_vbase, ivideo->mmio_size / 1024);\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\nivideo->cmdQueueSize = TURBO_QUEUE_AREA_SIZE;\r\n} else {\r\nif(ivideo->chip == XGI_20) {\r\nivideo->cmdQueueSize = COMMAND_QUEUE_AREA_SIZE_Z7;\r\n} else {\r\nivideo->cmdQueueSize = COMMAND_QUEUE_AREA_SIZE;\r\n}\r\n}\r\nivideo->hwcursor_vbase = ivideo->video_vbase\r\n+ ivideo->video_size\r\n- ivideo->cmdQueueSize\r\n- ivideo->hwcursor_size;\r\nivideo->caps |= HW_CURSOR_CAP;\r\nif((ivideo->havenoheap = sisfb_heap_init(ivideo))) {\r\nprintk(KERN_WARNING "sisfb: Failed to initialize offscreen memory heap\n");\r\n}\r\nivideo->SiS_Pr.VideoMemoryAddress += ivideo->video_offset;\r\nivideo->SiS_Pr.VideoMemorySize = ivideo->sisfb_mem;\r\nivideo->mtrr = -1;\r\nivideo->vbflags = 0;\r\nivideo->lcddefmodeidx = DEFAULT_LCDMODE;\r\nivideo->tvdefmodeidx = DEFAULT_TVMODE;\r\nivideo->defmodeidx = DEFAULT_MODE;\r\nivideo->newrom = 0;\r\nif(ivideo->chip < XGI_20) {\r\nif(ivideo->bios_abase) {\r\nivideo->newrom = SiSDetermineROMLayout661(&ivideo->SiS_Pr);\r\n}\r\n}\r\nif((ivideo->sisfb_mode_idx < 0) ||\r\n((sisbios_mode[ivideo->sisfb_mode_idx].mode_no[ivideo->mni]) != 0xFF)) {\r\nsisfb_sense_crt1(ivideo);\r\nsisfb_get_VB_type(ivideo);\r\nif(ivideo->vbflags2 & VB2_VIDEOBRIDGE) {\r\nsisfb_detect_VB_connect(ivideo);\r\n}\r\nivideo->currentvbflags = ivideo->vbflags & (VB_VIDEOBRIDGE | TV_STANDARD);\r\nif(ivideo->vbflags2 & VB2_VIDEOBRIDGE) {\r\nif(ivideo->sisfb_crt2type != -1) {\r\nif((ivideo->sisfb_crt2type == CRT2_LCD) &&\r\n(ivideo->vbflags & CRT2_LCD)) {\r\nivideo->currentvbflags |= CRT2_LCD;\r\n} else if(ivideo->sisfb_crt2type != CRT2_LCD) {\r\nivideo->currentvbflags |= ivideo->sisfb_crt2type;\r\n}\r\n} else {\r\nif((ivideo->sisvga_engine == SIS_300_VGA) &&\r\n(ivideo->vbflags2 & VB2_CHRONTEL)) {\r\nif(ivideo->vbflags & CRT2_LCD)\r\nivideo->currentvbflags |= CRT2_LCD;\r\nelse if(ivideo->vbflags & CRT2_TV)\r\nivideo->currentvbflags |= CRT2_TV;\r\nelse if(ivideo->vbflags & CRT2_VGA)\r\nivideo->currentvbflags |= CRT2_VGA;\r\n} else {\r\nif(ivideo->vbflags & CRT2_TV)\r\nivideo->currentvbflags |= CRT2_TV;\r\nelse if(ivideo->vbflags & CRT2_LCD)\r\nivideo->currentvbflags |= CRT2_LCD;\r\nelse if(ivideo->vbflags & CRT2_VGA)\r\nivideo->currentvbflags |= CRT2_VGA;\r\n}\r\n}\r\n}\r\nif(ivideo->vbflags & CRT2_LCD) {\r\nsisfb_detect_lcd_type(ivideo);\r\n}\r\nsisfb_save_pdc_emi(ivideo);\r\nif(!ivideo->sisfb_crt1off) {\r\nsisfb_handle_ddc(ivideo, &ivideo->sisfb_thismonitor, 0);\r\n} else {\r\nif((ivideo->vbflags2 & VB2_SISTMDSBRIDGE) &&\r\n(ivideo->vbflags & (CRT2_VGA | CRT2_LCD))) {\r\nsisfb_handle_ddc(ivideo, &ivideo->sisfb_thismonitor, 1);\r\n}\r\n}\r\nif(ivideo->sisfb_mode_idx >= 0) {\r\nint bu = ivideo->sisfb_mode_idx;\r\nivideo->sisfb_mode_idx = sisfb_validate_mode(ivideo,\r\nivideo->sisfb_mode_idx, ivideo->currentvbflags);\r\nif(bu != ivideo->sisfb_mode_idx) {\r\nprintk(KERN_ERR "Mode %dx%dx%d failed validation\n",\r\nsisbios_mode[bu].xres,\r\nsisbios_mode[bu].yres,\r\nsisbios_mode[bu].bpp);\r\n}\r\n}\r\nif(ivideo->sisfb_mode_idx < 0) {\r\nswitch(ivideo->currentvbflags & VB_DISPTYPE_DISP2) {\r\ncase CRT2_LCD:\r\nivideo->sisfb_mode_idx = ivideo->lcddefmodeidx;\r\nbreak;\r\ncase CRT2_TV:\r\nivideo->sisfb_mode_idx = ivideo->tvdefmodeidx;\r\nbreak;\r\ndefault:\r\nivideo->sisfb_mode_idx = ivideo->defmodeidx;\r\nbreak;\r\n}\r\n}\r\nivideo->mode_no = sisbios_mode[ivideo->sisfb_mode_idx].mode_no[ivideo->mni];\r\nif(ivideo->refresh_rate != 0) {\r\nsisfb_search_refresh_rate(ivideo, ivideo->refresh_rate,\r\nivideo->sisfb_mode_idx);\r\n}\r\nif(ivideo->rate_idx == 0) {\r\nivideo->rate_idx = sisbios_mode[ivideo->sisfb_mode_idx].rate_idx;\r\nivideo->refresh_rate = 60;\r\n}\r\nif(ivideo->sisfb_thismonitor.datavalid) {\r\nif(!sisfb_verify_rate(ivideo, &ivideo->sisfb_thismonitor,\r\nivideo->sisfb_mode_idx,\r\nivideo->rate_idx,\r\nivideo->refresh_rate)) {\r\nprintk(KERN_INFO "sisfb: WARNING: Refresh rate "\r\n"exceeds monitor specs!\n");\r\n}\r\n}\r\nivideo->video_bpp = sisbios_mode[ivideo->sisfb_mode_idx].bpp;\r\nivideo->video_width = sisbios_mode[ivideo->sisfb_mode_idx].xres;\r\nivideo->video_height = sisbios_mode[ivideo->sisfb_mode_idx].yres;\r\nsisfb_set_vparms(ivideo);\r\nprintk(KERN_INFO "sisfb: Default mode is %dx%dx%d (%dHz)\n",\r\nivideo->video_width, ivideo->video_height, ivideo->video_bpp,\r\nivideo->refresh_rate);\r\nivideo->default_var.xres = ivideo->default_var.xres_virtual = ivideo->video_width;\r\nivideo->default_var.yres = ivideo->default_var.yres_virtual = ivideo->video_height;\r\nivideo->default_var.bits_per_pixel = ivideo->video_bpp;\r\nsisfb_bpp_to_var(ivideo, &ivideo->default_var);\r\nivideo->default_var.pixclock = (u32) (1000000000 /\r\nsisfb_mode_rate_to_dclock(&ivideo->SiS_Pr, ivideo->mode_no, ivideo->rate_idx));\r\nif(sisfb_mode_rate_to_ddata(&ivideo->SiS_Pr, ivideo->mode_no,\r\nivideo->rate_idx, &ivideo->default_var)) {\r\nif((ivideo->default_var.vmode & FB_VMODE_MASK) == FB_VMODE_DOUBLE) {\r\nivideo->default_var.pixclock <<= 1;\r\n}\r\n}\r\nif(ivideo->sisfb_ypan) {\r\nivideo->default_var.yres_virtual =\r\nsisfb_calc_maxyres(ivideo, &ivideo->default_var);\r\nif(ivideo->default_var.yres_virtual < ivideo->default_var.yres) {\r\nivideo->default_var.yres_virtual = ivideo->default_var.yres;\r\n}\r\n}\r\nsisfb_calc_pitch(ivideo, &ivideo->default_var);\r\nivideo->accel = 0;\r\nif(ivideo->sisfb_accel) {\r\nivideo->accel = -1;\r\n#ifdef STUPID_ACCELF_TEXT_SHIT\r\nivideo->default_var.accel_flags |= FB_ACCELF_TEXT;\r\n#endif\r\n}\r\nsisfb_initaccel(ivideo);\r\n#if defined(FBINFO_HWACCEL_DISABLED) && defined(FBINFO_HWACCEL_XPAN)\r\nsis_fb_info->flags = FBINFO_DEFAULT |\r\nFBINFO_HWACCEL_YPAN |\r\nFBINFO_HWACCEL_XPAN |\r\nFBINFO_HWACCEL_COPYAREA |\r\nFBINFO_HWACCEL_FILLRECT |\r\n((ivideo->accel) ? 0 : FBINFO_HWACCEL_DISABLED);\r\n#else\r\nsis_fb_info->flags = FBINFO_FLAG_DEFAULT;\r\n#endif\r\nsis_fb_info->var = ivideo->default_var;\r\nsis_fb_info->fix = ivideo->sisfb_fix;\r\nsis_fb_info->screen_base = ivideo->video_vbase + ivideo->video_offset;\r\nsis_fb_info->fbops = &sisfb_ops;\r\nsis_fb_info->pseudo_palette = ivideo->pseudo_palette;\r\nfb_alloc_cmap(&sis_fb_info->cmap, 256 , 0);\r\nprintk(KERN_DEBUG "sisfb: Initial vbflags 0x%x\n", (int)ivideo->vbflags);\r\n#ifdef CONFIG_MTRR\r\nivideo->mtrr = mtrr_add(ivideo->video_base, ivideo->video_size,\r\nMTRR_TYPE_WRCOMB, 1);\r\nif(ivideo->mtrr < 0) {\r\nprintk(KERN_DEBUG "sisfb: Failed to add MTRRs\n");\r\n}\r\n#endif\r\nif(register_framebuffer(sis_fb_info) < 0) {\r\nprintk(KERN_ERR "sisfb: Fatal error: Failed to register framebuffer\n");\r\nret = -EINVAL;\r\niounmap(ivideo->mmio_vbase);\r\ngoto error_0;\r\n}\r\nivideo->registered = 1;\r\nivideo->next = card_list;\r\ncard_list = ivideo;\r\nprintk(KERN_INFO "sisfb: 2D acceleration is %s, y-panning %s\n",\r\nivideo->sisfb_accel ? "enabled" : "disabled",\r\nivideo->sisfb_ypan ?\r\n(ivideo->sisfb_max ? "enabled (auto-max)" :\r\n"enabled (no auto-max)") :\r\n"disabled");\r\nprintk(KERN_INFO "fb%d: %s frame buffer device version %d.%d.%d\n",\r\nsis_fb_info->node, ivideo->myid, VER_MAJOR, VER_MINOR, VER_LEVEL);\r\nprintk(KERN_INFO "sisfb: Copyright (C) 2001-2005 Thomas Winischhofer\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic void __devexit sisfb_remove(struct pci_dev *pdev)\r\n{\r\nstruct sis_video_info *ivideo = pci_get_drvdata(pdev);\r\nstruct fb_info *sis_fb_info = ivideo->memyselfandi;\r\nint registered = ivideo->registered;\r\nint modechanged = ivideo->modechanged;\r\niounmap(ivideo->mmio_vbase);\r\niounmap(ivideo->video_vbase);\r\nrelease_mem_region(ivideo->video_base, ivideo->video_size);\r\nrelease_mem_region(ivideo->mmio_base, ivideo->mmio_size);\r\nvfree(ivideo->bios_abase);\r\nif(ivideo->lpcdev)\r\npci_dev_put(ivideo->lpcdev);\r\nif(ivideo->nbridge)\r\npci_dev_put(ivideo->nbridge);\r\n#ifdef CONFIG_MTRR\r\nif(ivideo->mtrr >= 0)\r\nmtrr_del(ivideo->mtrr, ivideo->video_base, ivideo->video_size);\r\n#endif\r\npci_set_drvdata(pdev, NULL);\r\nif(!ivideo->sisvga_enabled)\r\npci_disable_device(pdev);\r\nif(ivideo->registered) {\r\nunregister_framebuffer(sis_fb_info);\r\nframebuffer_release(sis_fb_info);\r\n}\r\nif(registered && modechanged)\r\nprintk(KERN_INFO\r\n"sisfb: Restoring of text mode not supported yet\n");\r\n}\r\nstatic int __init sisfb_init(void)\r\n{\r\n#ifndef MODULE\r\nchar *options = NULL;\r\nif(fb_get_options("sisfb", &options))\r\nreturn -ENODEV;\r\nsisfb_setup(options);\r\n#endif\r\nreturn pci_register_driver(&sisfb_driver);\r\n}\r\nstatic int __init sisfb_init_module(void)\r\n{\r\nsisfb_setdefaultparms();\r\nif(rate)\r\nsisfb_parm_rate = rate;\r\nif((scalelcd == 0) || (scalelcd == 1))\r\nsisfb_scalelcd = scalelcd ^ 1;\r\nif(forcecrt2type)\r\nsisfb_search_crt2type(forcecrt2type);\r\nif(tvstandard)\r\nsisfb_search_tvstd(tvstandard);\r\nif(mode)\r\nsisfb_search_mode(mode, false);\r\nelse if(vesa != -1)\r\nsisfb_search_vesamode(vesa, false);\r\nsisfb_crt1off = (crt1off == 0) ? 1 : 0;\r\nsisfb_forcecrt1 = forcecrt1;\r\nif(forcecrt1 == 1)\r\nsisfb_crt1off = 0;\r\nelse if(forcecrt1 == 0)\r\nsisfb_crt1off = 1;\r\nif(noaccel == 1)\r\nsisfb_accel = 0;\r\nelse if(noaccel == 0)\r\nsisfb_accel = 1;\r\nif(noypan == 1)\r\nsisfb_ypan = 0;\r\nelse if(noypan == 0)\r\nsisfb_ypan = 1;\r\nif(nomax == 1)\r\nsisfb_max = 0;\r\nelse if(nomax == 0)\r\nsisfb_max = 1;\r\nif(mem)\r\nsisfb_parm_mem = mem;\r\nif(userom != -1)\r\nsisfb_userom = userom;\r\nif(useoem != -1)\r\nsisfb_useoem = useoem;\r\nif(pdc != -1)\r\nsisfb_pdc = (pdc & 0x7f);\r\nif(pdc1 != -1)\r\nsisfb_pdca = (pdc1 & 0x1f);\r\nsisfb_nocrt2rate = nocrt2rate;\r\nif(specialtiming)\r\nsisfb_search_specialtiming(specialtiming);\r\nif((lvdshl >= 0) && (lvdshl <= 3))\r\nsisfb_lvdshl = lvdshl;\r\nsisfb_tvxposoffset = tvxposoffset;\r\nsisfb_tvyposoffset = tvyposoffset;\r\n#if !defined(__i386__) && !defined(__x86_64__)\r\nsisfb_resetcard = (resetcard) ? 1 : 0;\r\nif(videoram)\r\nsisfb_videoram = videoram;\r\n#endif\r\nreturn sisfb_init();\r\n}\r\nstatic void __exit sisfb_remove_module(void)\r\n{\r\npci_unregister_driver(&sisfb_driver);\r\nprintk(KERN_DEBUG "sisfb: Module unloaded\n");\r\n}

static int db8500_cpufreq_verify_speed(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_frequency_table_verify(policy, freq_table);\r\n}\r\nstatic int db8500_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nstruct cpufreq_freqs freqs;\r\nunsigned int idx;\r\nif (target_freq < policy->cpuinfo.min_freq)\r\ntarget_freq = policy->cpuinfo.min_freq;\r\nif (target_freq > policy->cpuinfo.max_freq)\r\ntarget_freq = policy->cpuinfo.max_freq;\r\nif (cpufreq_frequency_table_target\r\n(policy, freq_table, target_freq, relation, &idx)) {\r\nreturn -EINVAL;\r\n}\r\nfreqs.old = policy->cur;\r\nfreqs.new = freq_table[idx].frequency;\r\nif (freqs.old == freqs.new)\r\nreturn 0;\r\nfor_each_cpu(freqs.cpu, policy->cpus)\r\ncpufreq_notify_transition(&freqs, CPUFREQ_PRECHANGE);\r\nif (prcmu_set_arm_opp(idx2opp[idx])) {\r\npr_err("db8500-cpufreq: Failed to set OPP level\n");\r\nreturn -EINVAL;\r\n}\r\nfor_each_cpu(freqs.cpu, policy->cpus)\r\ncpufreq_notify_transition(&freqs, CPUFREQ_POSTCHANGE);\r\nreturn 0;\r\n}\r\nstatic unsigned int db8500_cpufreq_getspeed(unsigned int cpu)\r\n{\r\nint i;\r\nfor (i = 0; prcmu_get_arm_opp() != idx2opp[i]; i++)\r\n;\r\nreturn freq_table[i].frequency;\r\n}\r\nstatic int __cpuinit db8500_cpufreq_init(struct cpufreq_policy *policy)\r\n{\r\nint i, res;\r\nBUILD_BUG_ON(ARRAY_SIZE(idx2opp) + 1 != ARRAY_SIZE(freq_table));\r\nif (!prcmu_is_u8400()) {\r\nfreq_table[1].frequency = 400000;\r\nfreq_table[2].frequency = 800000;\r\nif (prcmu_has_arm_maxopp())\r\nfreq_table[3].frequency = 1000000;\r\n}\r\npr_info("db8500-cpufreq : Available frequencies:\n");\r\nfor (i = 0; freq_table[i].frequency != CPUFREQ_TABLE_END; i++)\r\npr_info(" %d Mhz\n", freq_table[i].frequency/1000);\r\nres = cpufreq_frequency_table_cpuinfo(policy, freq_table);\r\nif (!res)\r\ncpufreq_frequency_table_get_attr(freq_table, policy->cpu);\r\nelse {\r\npr_err("db8500-cpufreq : Failed to read policy table\n");\r\nreturn res;\r\n}\r\npolicy->min = policy->cpuinfo.min_freq;\r\npolicy->max = policy->cpuinfo.max_freq;\r\npolicy->cur = db8500_cpufreq_getspeed(policy->cpu);\r\npolicy->governor = CPUFREQ_DEFAULT_GOVERNOR;\r\npolicy->cpuinfo.transition_latency = 20 * 1000;\r\ncpumask_copy(policy->cpus, &cpu_present_map);\r\npolicy->shared_type = CPUFREQ_SHARED_TYPE_ALL;\r\nreturn 0;\r\n}\r\nstatic int __init db8500_cpufreq_register(void)\r\n{\r\nif (!cpu_is_u8500v20_or_later())\r\nreturn -ENODEV;\r\npr_info("cpufreq for DB8500 started\n");\r\nreturn cpufreq_register_driver(&db8500_cpufreq_driver);\r\n}

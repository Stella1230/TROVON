static int t1pci_add_card(struct capicardparams *p, struct pci_dev *pdev)\r\n{\r\navmcard *card;\r\navmctrl_info *cinfo;\r\nint retval;\r\ncard = b1_alloc_card(1);\r\nif (!card) {\r\nprintk(KERN_WARNING "t1pci: no memory.\n");\r\nretval = -ENOMEM;\r\ngoto err;\r\n}\r\ncard->dma = avmcard_dma_alloc("t1pci", pdev, 2048+128, 2048+128);\r\nif (!card->dma) {\r\nprintk(KERN_WARNING "t1pci: no memory.\n");\r\nretval = -ENOMEM;\r\ngoto err_free;\r\n}\r\ncinfo = card->ctrlinfo;\r\nsprintf(card->name, "t1pci-%x", p->port);\r\ncard->port = p->port;\r\ncard->irq = p->irq;\r\ncard->membase = p->membase;\r\ncard->cardtype = avm_t1pci;\r\nif (!request_region(card->port, AVMB1_PORTLEN, card->name)) {\r\nprintk(KERN_WARNING "t1pci: ports 0x%03x-0x%03x in use.\n",\r\ncard->port, card->port + AVMB1_PORTLEN);\r\nretval = -EBUSY;\r\ngoto err_free_dma;\r\n}\r\ncard->mbase = ioremap(card->membase, 64);\r\nif (!card->mbase) {\r\nprintk(KERN_NOTICE "t1pci: can't remap memory at 0x%lx\n",\r\ncard->membase);\r\nretval = -EIO;\r\ngoto err_release_region;\r\n}\r\nb1dma_reset(card);\r\nretval = t1pci_detect(card);\r\nif (retval != 0) {\r\nif (retval < 6)\r\nprintk(KERN_NOTICE "t1pci: NO card at 0x%x (%d)\n",\r\ncard->port, retval);\r\nelse\r\nprintk(KERN_NOTICE "t1pci: card at 0x%x, but cable not connected or T1 has no power (%d)\n",\r\ncard->port, retval);\r\nretval = -EIO;\r\ngoto err_unmap;\r\n}\r\nb1dma_reset(card);\r\nretval = request_irq(card->irq, b1dma_interrupt, IRQF_SHARED, card->name, card);\r\nif (retval) {\r\nprintk(KERN_ERR "t1pci: unable to get IRQ %d.\n", card->irq);\r\nretval = -EBUSY;\r\ngoto err_unmap;\r\n}\r\ncinfo->capi_ctrl.owner = THIS_MODULE;\r\ncinfo->capi_ctrl.driver_name = "t1pci";\r\ncinfo->capi_ctrl.driverdata = cinfo;\r\ncinfo->capi_ctrl.register_appl = b1dma_register_appl;\r\ncinfo->capi_ctrl.release_appl = b1dma_release_appl;\r\ncinfo->capi_ctrl.send_message = b1dma_send_message;\r\ncinfo->capi_ctrl.load_firmware = b1dma_load_firmware;\r\ncinfo->capi_ctrl.reset_ctr = b1dma_reset_ctr;\r\ncinfo->capi_ctrl.procinfo = t1pci_procinfo;\r\ncinfo->capi_ctrl.proc_fops = &b1dmactl_proc_fops;\r\nstrcpy(cinfo->capi_ctrl.name, card->name);\r\nretval = attach_capi_ctr(&cinfo->capi_ctrl);\r\nif (retval) {\r\nprintk(KERN_ERR "t1pci: attach controller failed.\n");\r\nretval = -EBUSY;\r\ngoto err_free_irq;\r\n}\r\ncard->cardnr = cinfo->capi_ctrl.cnr;\r\nprintk(KERN_INFO "t1pci: AVM T1 PCI at i/o %#x, irq %d, mem %#lx\n",\r\ncard->port, card->irq, card->membase);\r\npci_set_drvdata(pdev, card);\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(card->irq, card);\r\nerr_unmap:\r\niounmap(card->mbase);\r\nerr_release_region:\r\nrelease_region(card->port, AVMB1_PORTLEN);\r\nerr_free_dma:\r\navmcard_dma_free(card->dma);\r\nerr_free:\r\nb1_free_card(card);\r\nerr:\r\nreturn retval;\r\n}\r\nstatic void t1pci_remove(struct pci_dev *pdev)\r\n{\r\navmcard *card = pci_get_drvdata(pdev);\r\navmctrl_info *cinfo = card->ctrlinfo;\r\nb1dma_reset(card);\r\ndetach_capi_ctr(&cinfo->capi_ctrl);\r\nfree_irq(card->irq, card);\r\niounmap(card->mbase);\r\nrelease_region(card->port, AVMB1_PORTLEN);\r\navmcard_dma_free(card->dma);\r\nb1_free_card(card);\r\n}\r\nstatic char *t1pci_procinfo(struct capi_ctr *ctrl)\r\n{\r\navmctrl_info *cinfo = (avmctrl_info *)(ctrl->driverdata);\r\nif (!cinfo)\r\nreturn "";\r\nsprintf(cinfo->infobuf, "%s %s 0x%x %d 0x%lx",\r\ncinfo->cardname[0] ? cinfo->cardname : "-",\r\ncinfo->version[VER_DRIVER] ? cinfo->version[VER_DRIVER] : "-",\r\ncinfo->card ? cinfo->card->port : 0x0,\r\ncinfo->card ? cinfo->card->irq : 0,\r\ncinfo->card ? cinfo->card->membase : 0\r\n);\r\nreturn cinfo->infobuf;\r\n}\r\nstatic int __devinit t1pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct capicardparams param;\r\nint retval;\r\nif (pci_enable_device(dev) < 0) {\r\nprintk(KERN_ERR "t1pci: failed to enable AVM-T1-PCI\n");\r\nreturn -ENODEV;\r\n}\r\npci_set_master(dev);\r\nparam.port = pci_resource_start(dev, 1);\r\nparam.irq = dev->irq;\r\nparam.membase = pci_resource_start(dev, 0);\r\nprintk(KERN_INFO "t1pci: PCI BIOS reports AVM-T1-PCI at i/o %#x, irq %d, mem %#x\n",\r\nparam.port, param.irq, param.membase);\r\nretval = t1pci_add_card(&param, dev);\r\nif (retval != 0) {\r\nprintk(KERN_ERR "t1pci: no AVM-T1-PCI at i/o %#x, irq %d detected, mem %#x\n",\r\nparam.port, param.irq, param.membase);\r\npci_disable_device(dev);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init t1pci_init(void)\r\n{\r\nchar *p;\r\nchar rev[32];\r\nint err;\r\nif ((p = strchr(revision, ':')) != NULL && p[1]) {\r\nstrlcpy(rev, p + 2, 32);\r\nif ((p = strchr(rev, '$')) != NULL && p > rev)\r\n*(p-1) = 0;\r\n} else\r\nstrcpy(rev, "1.0");\r\nerr = pci_register_driver(&t1pci_pci_driver);\r\nif (!err) {\r\nstrlcpy(capi_driver_t1pci.revision, rev, 32);\r\nregister_capi_driver(&capi_driver_t1pci);\r\nprintk(KERN_INFO "t1pci: revision %s\n", rev);\r\n}\r\nreturn err;\r\n}\r\nstatic void __exit t1pci_exit(void)\r\n{\r\nunregister_capi_driver(&capi_driver_t1pci);\r\npci_unregister_driver(&t1pci_pci_driver);\r\n}

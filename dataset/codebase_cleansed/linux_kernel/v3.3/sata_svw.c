static int k2_sata_check_atapi_dma(struct ata_queued_cmd *qc)\r\n{\r\nu8 cmnd = qc->scsicmd->cmnd[0];\r\nif (qc->ap->flags & K2_FLAG_NO_ATAPI_DMA)\r\nreturn -1;\r\nelse {\r\nswitch (cmnd) {\r\ncase READ_10:\r\ncase READ_12:\r\ncase READ_16:\r\ncase WRITE_10:\r\ncase WRITE_12:\r\ncase WRITE_16:\r\nreturn 0;\r\ndefault:\r\nreturn -1;\r\n}\r\n}\r\n}\r\nstatic int k2_sata_scr_read(struct ata_link *link,\r\nunsigned int sc_reg, u32 *val)\r\n{\r\nif (sc_reg > SCR_CONTROL)\r\nreturn -EINVAL;\r\n*val = readl(link->ap->ioaddr.scr_addr + (sc_reg * 4));\r\nreturn 0;\r\n}\r\nstatic int k2_sata_scr_write(struct ata_link *link,\r\nunsigned int sc_reg, u32 val)\r\n{\r\nif (sc_reg > SCR_CONTROL)\r\nreturn -EINVAL;\r\nwritel(val, link->ap->ioaddr.scr_addr + (sc_reg * 4));\r\nreturn 0;\r\n}\r\nstatic void k2_sata_tf_load(struct ata_port *ap, const struct ata_taskfile *tf)\r\n{\r\nstruct ata_ioports *ioaddr = &ap->ioaddr;\r\nunsigned int is_addr = tf->flags & ATA_TFLAG_ISADDR;\r\nif (tf->ctl != ap->last_ctl) {\r\nwriteb(tf->ctl, ioaddr->ctl_addr);\r\nap->last_ctl = tf->ctl;\r\nata_wait_idle(ap);\r\n}\r\nif (is_addr && (tf->flags & ATA_TFLAG_LBA48)) {\r\nwritew(tf->feature | (((u16)tf->hob_feature) << 8),\r\nioaddr->feature_addr);\r\nwritew(tf->nsect | (((u16)tf->hob_nsect) << 8),\r\nioaddr->nsect_addr);\r\nwritew(tf->lbal | (((u16)tf->hob_lbal) << 8),\r\nioaddr->lbal_addr);\r\nwritew(tf->lbam | (((u16)tf->hob_lbam) << 8),\r\nioaddr->lbam_addr);\r\nwritew(tf->lbah | (((u16)tf->hob_lbah) << 8),\r\nioaddr->lbah_addr);\r\n} else if (is_addr) {\r\nwritew(tf->feature, ioaddr->feature_addr);\r\nwritew(tf->nsect, ioaddr->nsect_addr);\r\nwritew(tf->lbal, ioaddr->lbal_addr);\r\nwritew(tf->lbam, ioaddr->lbam_addr);\r\nwritew(tf->lbah, ioaddr->lbah_addr);\r\n}\r\nif (tf->flags & ATA_TFLAG_DEVICE)\r\nwriteb(tf->device, ioaddr->device_addr);\r\nata_wait_idle(ap);\r\n}\r\nstatic void k2_sata_tf_read(struct ata_port *ap, struct ata_taskfile *tf)\r\n{\r\nstruct ata_ioports *ioaddr = &ap->ioaddr;\r\nu16 nsect, lbal, lbam, lbah, feature;\r\ntf->command = k2_stat_check_status(ap);\r\ntf->device = readw(ioaddr->device_addr);\r\nfeature = readw(ioaddr->error_addr);\r\nnsect = readw(ioaddr->nsect_addr);\r\nlbal = readw(ioaddr->lbal_addr);\r\nlbam = readw(ioaddr->lbam_addr);\r\nlbah = readw(ioaddr->lbah_addr);\r\ntf->feature = feature;\r\ntf->nsect = nsect;\r\ntf->lbal = lbal;\r\ntf->lbam = lbam;\r\ntf->lbah = lbah;\r\nif (tf->flags & ATA_TFLAG_LBA48) {\r\ntf->hob_feature = feature >> 8;\r\ntf->hob_nsect = nsect >> 8;\r\ntf->hob_lbal = lbal >> 8;\r\ntf->hob_lbam = lbam >> 8;\r\ntf->hob_lbah = lbah >> 8;\r\n}\r\n}\r\nstatic void k2_bmdma_setup_mmio(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nunsigned int rw = (qc->tf.flags & ATA_TFLAG_WRITE);\r\nu8 dmactl;\r\nvoid __iomem *mmio = ap->ioaddr.bmdma_addr;\r\nmb();\r\nwritel(ap->bmdma_prd_dma, mmio + ATA_DMA_TABLE_OFS);\r\ndmactl = readb(mmio + ATA_DMA_CMD);\r\ndmactl &= ~(ATA_DMA_WR | ATA_DMA_START);\r\nif (!rw)\r\ndmactl |= ATA_DMA_WR;\r\nwriteb(dmactl, mmio + ATA_DMA_CMD);\r\nif (qc->tf.protocol != ATA_PROT_DMA)\r\nap->ops->sff_exec_command(ap, &qc->tf);\r\n}\r\nstatic void k2_bmdma_start_mmio(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nvoid __iomem *mmio = ap->ioaddr.bmdma_addr;\r\nu8 dmactl;\r\ndmactl = readb(mmio + ATA_DMA_CMD);\r\nwriteb(dmactl | ATA_DMA_START, mmio + ATA_DMA_CMD);\r\nif (qc->tf.protocol == ATA_PROT_DMA)\r\nap->ops->sff_exec_command(ap, &qc->tf);\r\n}\r\nstatic u8 k2_stat_check_status(struct ata_port *ap)\r\n{\r\nreturn readl(ap->ioaddr.status_addr);\r\n}\r\nstatic int k2_sata_proc_info(struct Scsi_Host *shost, char *page, char **start,\r\noff_t offset, int count, int inout)\r\n{\r\nstruct ata_port *ap;\r\nstruct device_node *np;\r\nint len, index;\r\nap = ata_shost_to_port(shost);\r\nif (ap == NULL)\r\nreturn 0;\r\nnp = pci_device_to_OF_node(to_pci_dev(ap->host->dev));\r\nif (np == NULL)\r\nreturn 0;\r\nindex = (ap == ap->host->ports[0]) ? 0 : 1;\r\nfor (np = np->child; np != NULL; np = np->sibling) {\r\nconst u32 *reg = of_get_property(np, "reg", NULL);\r\nif (!reg)\r\ncontinue;\r\nif (index == *reg)\r\nbreak;\r\n}\r\nif (np == NULL)\r\nreturn 0;\r\nlen = sprintf(page, "devspec: %s\n", np->full_name);\r\nreturn len;\r\n}\r\nstatic void k2_sata_setup_port(struct ata_ioports *port, void __iomem *base)\r\n{\r\nport->cmd_addr = base + K2_SATA_TF_CMD_OFFSET;\r\nport->data_addr = base + K2_SATA_TF_DATA_OFFSET;\r\nport->feature_addr =\r\nport->error_addr = base + K2_SATA_TF_ERROR_OFFSET;\r\nport->nsect_addr = base + K2_SATA_TF_NSECT_OFFSET;\r\nport->lbal_addr = base + K2_SATA_TF_LBAL_OFFSET;\r\nport->lbam_addr = base + K2_SATA_TF_LBAM_OFFSET;\r\nport->lbah_addr = base + K2_SATA_TF_LBAH_OFFSET;\r\nport->device_addr = base + K2_SATA_TF_DEVICE_OFFSET;\r\nport->command_addr =\r\nport->status_addr = base + K2_SATA_TF_CMDSTAT_OFFSET;\r\nport->altstatus_addr =\r\nport->ctl_addr = base + K2_SATA_TF_CTL_OFFSET;\r\nport->bmdma_addr = base + K2_SATA_DMA_CMD_OFFSET;\r\nport->scr_addr = base + K2_SATA_SCR_STATUS_OFFSET;\r\n}\r\nstatic int k2_sata_init_one(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nconst struct ata_port_info *ppi[] =\r\n{ &k2_port_info[ent->driver_data], NULL };\r\nstruct ata_host *host;\r\nvoid __iomem *mmio_base;\r\nint n_ports, i, rc, bar_pos;\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nn_ports = 4;\r\nif (ppi[0]->flags & K2_FLAG_SATA_8_PORTS)\r\nn_ports = 8;\r\nhost = ata_host_alloc_pinfo(&pdev->dev, ppi, n_ports);\r\nif (!host)\r\nreturn -ENOMEM;\r\nbar_pos = 5;\r\nif (ppi[0]->flags & K2_FLAG_BAR_POS_3)\r\nbar_pos = 3;\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nif (pci_resource_len(pdev, bar_pos) == 0) {\r\npcim_pin_device(pdev);\r\nreturn -ENODEV;\r\n}\r\nrc = pcim_iomap_regions(pdev, 1 << bar_pos, DRV_NAME);\r\nif (rc == -EBUSY)\r\npcim_pin_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nhost->iomap = pcim_iomap_table(pdev);\r\nmmio_base = host->iomap[bar_pos];\r\nfor (i = 0; i < host->n_ports; i++) {\r\nstruct ata_port *ap = host->ports[i];\r\nunsigned int offset = i * K2_SATA_PORT_OFFSET;\r\nk2_sata_setup_port(&ap->ioaddr, mmio_base + offset);\r\nata_port_pbar_desc(ap, 5, -1, "mmio");\r\nata_port_pbar_desc(ap, 5, offset, "port");\r\n}\r\nrc = pci_set_dma_mask(pdev, ATA_DMA_MASK);\r\nif (rc)\r\nreturn rc;\r\nrc = pci_set_consistent_dma_mask(pdev, ATA_DMA_MASK);\r\nif (rc)\r\nreturn rc;\r\nwritel(readl(mmio_base + K2_SATA_SICR1_OFFSET) & ~0x00040000,\r\nmmio_base + K2_SATA_SICR1_OFFSET);\r\nwritel(0xffffffff, mmio_base + K2_SATA_SCR_ERROR_OFFSET);\r\nwritel(0x0, mmio_base + K2_SATA_SIM_OFFSET);\r\npci_set_master(pdev);\r\nreturn ata_host_activate(host, pdev->irq, ata_bmdma_interrupt,\r\nIRQF_SHARED, &k2_sata_sht);\r\n}\r\nstatic int __init k2_sata_init(void)\r\n{\r\nreturn pci_register_driver(&k2_sata_pci_driver);\r\n}\r\nstatic void __exit k2_sata_exit(void)\r\n{\r\npci_unregister_driver(&k2_sata_pci_driver);\r\n}

static int zhenhua_bitreverse(int x)\r\n{\r\nx = ((x & 0xaa) >> 1) | ((x & 0x55) << 1);\r\nx = ((x & 0xcc) >> 2) | ((x & 0x33) << 2);\r\nx = ((x & 0xf0) >> 4) | ((x & 0x0f) << 4);\r\nreturn x;\r\n}\r\nstatic void zhenhua_process_packet(struct zhenhua *zhenhua)\r\n{\r\nstruct input_dev *dev = zhenhua->dev;\r\nunsigned char *data = zhenhua->data;\r\ninput_report_abs(dev, ABS_Y, data[1]);\r\ninput_report_abs(dev, ABS_X, data[2]);\r\ninput_report_abs(dev, ABS_RZ, data[3]);\r\ninput_report_abs(dev, ABS_Z, data[4]);\r\ninput_sync(dev);\r\n}\r\nstatic irqreturn_t zhenhua_interrupt(struct serio *serio, unsigned char data, unsigned int flags)\r\n{\r\nstruct zhenhua *zhenhua = serio_get_drvdata(serio);\r\nif (data == 0xef)\r\nzhenhua->idx = 0;\r\nelse if (zhenhua->idx == 0)\r\nreturn IRQ_HANDLED;\r\nif (zhenhua->idx < ZHENHUA_MAX_LENGTH)\r\nzhenhua->data[zhenhua->idx++] = zhenhua_bitreverse(data);\r\nif (zhenhua->idx == ZHENHUA_MAX_LENGTH) {\r\nzhenhua_process_packet(zhenhua);\r\nzhenhua->idx = 0;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void zhenhua_disconnect(struct serio *serio)\r\n{\r\nstruct zhenhua *zhenhua = serio_get_drvdata(serio);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_unregister_device(zhenhua->dev);\r\nkfree(zhenhua);\r\n}\r\nstatic int zhenhua_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct zhenhua *zhenhua;\r\nstruct input_dev *input_dev;\r\nint err = -ENOMEM;\r\nzhenhua = kzalloc(sizeof(struct zhenhua), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!zhenhua || !input_dev)\r\ngoto fail1;\r\nzhenhua->dev = input_dev;\r\nsnprintf(zhenhua->phys, sizeof(zhenhua->phys), "%s/input0", serio->phys);\r\ninput_dev->name = "Zhen Hua 5-byte device";\r\ninput_dev->phys = zhenhua->phys;\r\ninput_dev->id.bustype = BUS_RS232;\r\ninput_dev->id.vendor = SERIO_ZHENHUA;\r\ninput_dev->id.product = 0x0001;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &serio->dev;\r\ninput_dev->evbit[0] = BIT(EV_ABS);\r\ninput_set_abs_params(input_dev, ABS_X, 50, 200, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 50, 200, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Z, 50, 200, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_RZ, 50, 200, 0, 0);\r\nserio_set_drvdata(serio, zhenhua);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(zhenhua->dev);\r\nif (err)\r\ngoto fail3;\r\nreturn 0;\r\nfail3: serio_close(serio);\r\nfail2: serio_set_drvdata(serio, NULL);\r\nfail1: input_free_device(input_dev);\r\nkfree(zhenhua);\r\nreturn err;\r\n}\r\nstatic int __init zhenhua_init(void)\r\n{\r\nreturn serio_register_driver(&zhenhua_drv);\r\n}\r\nstatic void __exit zhenhua_exit(void)\r\n{\r\nserio_unregister_driver(&zhenhua_drv);\r\n}

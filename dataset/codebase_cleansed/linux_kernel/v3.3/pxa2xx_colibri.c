static int colibri_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nint ret;\r\nret = gpio_request_array(colibri_pcmcia_gpios,\r\nARRAY_SIZE(colibri_pcmcia_gpios));\r\nif (ret)\r\ngoto err1;\r\ncolibri_irqs[0].irq = gpio_to_irq(colibri_pcmcia_gpios[DETECT].gpio);\r\nskt->socket.pci_irq = gpio_to_irq(colibri_pcmcia_gpios[READY].gpio);\r\nret = soc_pcmcia_request_irqs(skt, colibri_irqs,\r\nARRAY_SIZE(colibri_irqs));\r\nif (ret)\r\ngoto err2;\r\nreturn ret;\r\nerr2:\r\ngpio_free_array(colibri_pcmcia_gpios,\r\nARRAY_SIZE(colibri_pcmcia_gpios));\r\nerr1:\r\nreturn ret;\r\n}\r\nstatic void colibri_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\ngpio_free_array(colibri_pcmcia_gpios,\r\nARRAY_SIZE(colibri_pcmcia_gpios));\r\n}\r\nstatic void colibri_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nstate->detect = !!gpio_get_value(colibri_pcmcia_gpios[DETECT].gpio);\r\nstate->ready = !!gpio_get_value(colibri_pcmcia_gpios[READY].gpio);\r\nstate->bvd1 = !!gpio_get_value(colibri_pcmcia_gpios[BVD1].gpio);\r\nstate->bvd2 = !!gpio_get_value(colibri_pcmcia_gpios[BVD2].gpio);\r\nstate->wrprot = 0;\r\nstate->vs_3v = 1;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic int\r\ncolibri_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\ngpio_set_value(colibri_pcmcia_gpios[PPEN].gpio,\r\n!(state->Vcc == 33 && state->Vpp < 50));\r\ngpio_set_value(colibri_pcmcia_gpios[RESET].gpio,\r\nstate->flags & SS_RESET);\r\nreturn 0;\r\n}\r\nstatic int __init colibri_pcmcia_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_colibri() && !machine_is_colibri320())\r\nreturn -ENODEV;\r\ncolibri_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!colibri_pcmcia_device)\r\nreturn -ENOMEM;\r\nif (machine_is_colibri()) {\r\ncolibri_pcmcia_gpios[RESET].gpio = COLIBRI270_RESET_GPIO;\r\ncolibri_pcmcia_gpios[PPEN].gpio = COLIBRI270_PPEN_GPIO;\r\ncolibri_pcmcia_gpios[BVD1].gpio = COLIBRI270_BVD1_GPIO;\r\ncolibri_pcmcia_gpios[BVD2].gpio = COLIBRI270_BVD2_GPIO;\r\ncolibri_pcmcia_gpios[DETECT].gpio = COLIBRI270_DETECT_GPIO;\r\ncolibri_pcmcia_gpios[READY].gpio = COLIBRI270_READY_GPIO;\r\n} else if (machine_is_colibri320()) {\r\ncolibri_pcmcia_gpios[RESET].gpio = COLIBRI320_RESET_GPIO;\r\ncolibri_pcmcia_gpios[PPEN].gpio = COLIBRI320_PPEN_GPIO;\r\ncolibri_pcmcia_gpios[BVD1].gpio = COLIBRI320_BVD1_GPIO;\r\ncolibri_pcmcia_gpios[BVD2].gpio = COLIBRI320_BVD2_GPIO;\r\ncolibri_pcmcia_gpios[DETECT].gpio = COLIBRI320_DETECT_GPIO;\r\ncolibri_pcmcia_gpios[READY].gpio = COLIBRI320_READY_GPIO;\r\n}\r\nret = platform_device_add_data(colibri_pcmcia_device,\r\n&colibri_pcmcia_ops, sizeof(colibri_pcmcia_ops));\r\nif (!ret)\r\nret = platform_device_add(colibri_pcmcia_device);\r\nif (ret)\r\nplatform_device_put(colibri_pcmcia_device);\r\nreturn ret;\r\n}\r\nstatic void __exit colibri_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(colibri_pcmcia_device);\r\n}

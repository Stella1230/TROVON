static void\r\nixgb_raise_clock(struct ixgb_hw *hw,\r\nu32 *eecd_reg)\r\n{\r\n*eecd_reg = *eecd_reg | IXGB_EECD_SK;\r\nIXGB_WRITE_REG(hw, EECD, *eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\n}\r\nstatic void\r\nixgb_lower_clock(struct ixgb_hw *hw,\r\nu32 *eecd_reg)\r\n{\r\n*eecd_reg = *eecd_reg & ~IXGB_EECD_SK;\r\nIXGB_WRITE_REG(hw, EECD, *eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\n}\r\nstatic void\r\nixgb_shift_out_bits(struct ixgb_hw *hw,\r\nu16 data,\r\nu16 count)\r\n{\r\nu32 eecd_reg;\r\nu32 mask;\r\nmask = 0x01 << (count - 1);\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\neecd_reg &= ~(IXGB_EECD_DO | IXGB_EECD_DI);\r\ndo {\r\neecd_reg &= ~IXGB_EECD_DI;\r\nif (data & mask)\r\neecd_reg |= IXGB_EECD_DI;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\nixgb_raise_clock(hw, &eecd_reg);\r\nixgb_lower_clock(hw, &eecd_reg);\r\nmask = mask >> 1;\r\n} while (mask);\r\neecd_reg &= ~IXGB_EECD_DI;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\n}\r\nstatic u16\r\nixgb_shift_in_bits(struct ixgb_hw *hw)\r\n{\r\nu32 eecd_reg;\r\nu32 i;\r\nu16 data;\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\neecd_reg &= ~(IXGB_EECD_DO | IXGB_EECD_DI);\r\ndata = 0;\r\nfor (i = 0; i < 16; i++) {\r\ndata = data << 1;\r\nixgb_raise_clock(hw, &eecd_reg);\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\neecd_reg &= ~(IXGB_EECD_DI);\r\nif (eecd_reg & IXGB_EECD_DO)\r\ndata |= 1;\r\nixgb_lower_clock(hw, &eecd_reg);\r\n}\r\nreturn data;\r\n}\r\nstatic void\r\nixgb_setup_eeprom(struct ixgb_hw *hw)\r\n{\r\nu32 eecd_reg;\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\neecd_reg &= ~(IXGB_EECD_SK | IXGB_EECD_DI);\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\neecd_reg |= IXGB_EECD_CS;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\n}\r\nstatic void\r\nixgb_standby_eeprom(struct ixgb_hw *hw)\r\n{\r\nu32 eecd_reg;\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\neecd_reg &= ~(IXGB_EECD_CS | IXGB_EECD_SK);\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\neecd_reg |= IXGB_EECD_SK;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\neecd_reg |= IXGB_EECD_CS;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\neecd_reg &= ~IXGB_EECD_SK;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\n}\r\nstatic void\r\nixgb_clock_eeprom(struct ixgb_hw *hw)\r\n{\r\nu32 eecd_reg;\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\neecd_reg |= IXGB_EECD_SK;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\neecd_reg &= ~IXGB_EECD_SK;\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nIXGB_WRITE_FLUSH(hw);\r\nudelay(50);\r\n}\r\nstatic void\r\nixgb_cleanup_eeprom(struct ixgb_hw *hw)\r\n{\r\nu32 eecd_reg;\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\neecd_reg &= ~(IXGB_EECD_CS | IXGB_EECD_DI);\r\nIXGB_WRITE_REG(hw, EECD, eecd_reg);\r\nixgb_clock_eeprom(hw);\r\n}\r\nstatic bool\r\nixgb_wait_eeprom_command(struct ixgb_hw *hw)\r\n{\r\nu32 eecd_reg;\r\nu32 i;\r\nixgb_standby_eeprom(hw);\r\nfor (i = 0; i < 200; i++) {\r\neecd_reg = IXGB_READ_REG(hw, EECD);\r\nif (eecd_reg & IXGB_EECD_DO)\r\nreturn true;\r\nudelay(50);\r\n}\r\nASSERT(0);\r\nreturn false;\r\n}\r\nbool\r\nixgb_validate_eeprom_checksum(struct ixgb_hw *hw)\r\n{\r\nu16 checksum = 0;\r\nu16 i;\r\nfor (i = 0; i < (EEPROM_CHECKSUM_REG + 1); i++)\r\nchecksum += ixgb_read_eeprom(hw, i);\r\nif (checksum == (u16) EEPROM_SUM)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nvoid\r\nixgb_update_eeprom_checksum(struct ixgb_hw *hw)\r\n{\r\nu16 checksum = 0;\r\nu16 i;\r\nfor (i = 0; i < EEPROM_CHECKSUM_REG; i++)\r\nchecksum += ixgb_read_eeprom(hw, i);\r\nchecksum = (u16) EEPROM_SUM - checksum;\r\nixgb_write_eeprom(hw, EEPROM_CHECKSUM_REG, checksum);\r\n}\r\nvoid\r\nixgb_write_eeprom(struct ixgb_hw *hw, u16 offset, u16 data)\r\n{\r\nstruct ixgb_ee_map_type *ee_map = (struct ixgb_ee_map_type *)hw->eeprom;\r\nixgb_setup_eeprom(hw);\r\nixgb_shift_out_bits(hw, EEPROM_EWEN_OPCODE, 5);\r\nixgb_shift_out_bits(hw, 0, 4);\r\nixgb_standby_eeprom(hw);\r\nixgb_shift_out_bits(hw, EEPROM_WRITE_OPCODE, 3);\r\nixgb_shift_out_bits(hw, offset, 6);\r\nixgb_shift_out_bits(hw, data, 16);\r\nixgb_wait_eeprom_command(hw);\r\nixgb_standby_eeprom(hw);\r\nixgb_shift_out_bits(hw, EEPROM_EWDS_OPCODE, 5);\r\nixgb_shift_out_bits(hw, 0, 4);\r\nixgb_cleanup_eeprom(hw);\r\nee_map->init_ctrl_reg_1 = cpu_to_le16(EEPROM_ICW1_SIGNATURE_CLEAR);\r\n}\r\nu16\r\nixgb_read_eeprom(struct ixgb_hw *hw,\r\nu16 offset)\r\n{\r\nu16 data;\r\nixgb_setup_eeprom(hw);\r\nixgb_shift_out_bits(hw, EEPROM_READ_OPCODE, 3);\r\nixgb_shift_out_bits(hw, offset, 6);\r\ndata = ixgb_shift_in_bits(hw);\r\nixgb_standby_eeprom(hw);\r\nreturn data;\r\n}\r\nbool\r\nixgb_get_eeprom_data(struct ixgb_hw *hw)\r\n{\r\nu16 i;\r\nu16 checksum = 0;\r\nstruct ixgb_ee_map_type *ee_map;\r\nENTER();\r\nee_map = (struct ixgb_ee_map_type *)hw->eeprom;\r\npr_debug("Reading eeprom data\n");\r\nfor (i = 0; i < IXGB_EEPROM_SIZE ; i++) {\r\nu16 ee_data;\r\nee_data = ixgb_read_eeprom(hw, i);\r\nchecksum += ee_data;\r\nhw->eeprom[i] = cpu_to_le16(ee_data);\r\n}\r\nif (checksum != (u16) EEPROM_SUM) {\r\npr_debug("Checksum invalid\n");\r\nee_map->init_ctrl_reg_1 = cpu_to_le16(EEPROM_ICW1_SIGNATURE_CLEAR);\r\nreturn false;\r\n}\r\nif ((ee_map->init_ctrl_reg_1 & cpu_to_le16(EEPROM_ICW1_SIGNATURE_MASK))\r\n!= cpu_to_le16(EEPROM_ICW1_SIGNATURE_VALID)) {\r\npr_debug("Signature invalid\n");\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic bool\r\nixgb_check_and_get_eeprom_data (struct ixgb_hw* hw)\r\n{\r\nstruct ixgb_ee_map_type *ee_map = (struct ixgb_ee_map_type *)hw->eeprom;\r\nif ((ee_map->init_ctrl_reg_1 & cpu_to_le16(EEPROM_ICW1_SIGNATURE_MASK))\r\n== cpu_to_le16(EEPROM_ICW1_SIGNATURE_VALID)) {\r\nreturn true;\r\n} else {\r\nreturn ixgb_get_eeprom_data(hw);\r\n}\r\n}\r\n__le16\r\nixgb_get_eeprom_word(struct ixgb_hw *hw, u16 index)\r\n{\r\nif ((index < IXGB_EEPROM_SIZE) &&\r\n(ixgb_check_and_get_eeprom_data(hw) == true)) {\r\nreturn hw->eeprom[index];\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nixgb_get_ee_mac_addr(struct ixgb_hw *hw,\r\nu8 *mac_addr)\r\n{\r\nint i;\r\nstruct ixgb_ee_map_type *ee_map = (struct ixgb_ee_map_type *)hw->eeprom;\r\nENTER();\r\nif (ixgb_check_and_get_eeprom_data(hw) == true) {\r\nfor (i = 0; i < ETH_ALEN; i++) {\r\nmac_addr[i] = ee_map->mac_addr[i];\r\n}\r\npr_debug("eeprom mac address = %pM\n", mac_addr);\r\n}\r\n}\r\nu32\r\nixgb_get_ee_pba_number(struct ixgb_hw *hw)\r\n{\r\nif (ixgb_check_and_get_eeprom_data(hw) == true)\r\nreturn le16_to_cpu(hw->eeprom[EEPROM_PBA_1_2_REG])\r\n| (le16_to_cpu(hw->eeprom[EEPROM_PBA_3_4_REG])<<16);\r\nreturn 0;\r\n}\r\nu16\r\nixgb_get_ee_device_id(struct ixgb_hw *hw)\r\n{\r\nstruct ixgb_ee_map_type *ee_map = (struct ixgb_ee_map_type *)hw->eeprom;\r\nif (ixgb_check_and_get_eeprom_data(hw) == true)\r\nreturn le16_to_cpu(ee_map->device_id);\r\nreturn 0;\r\n}

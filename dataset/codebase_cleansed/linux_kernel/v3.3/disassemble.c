static void print_sh_insn(u32 memaddr, u16 insn)\r\n{\r\nint relmask = ~0;\r\nint nibs[4] = { (insn >> 12) & 0xf, (insn >> 8) & 0xf, (insn >> 4) & 0xf, insn & 0xf};\r\nint lastsp;\r\nstruct sh_opcode_info *op = sh_table;\r\nfor (; op->name; op++) {\r\nint n;\r\nint imm = 0;\r\nint rn = 0;\r\nint rm = 0;\r\nint rb = 0;\r\nint disp_pc;\r\nint disp_pc_addr = 0;\r\nfor (n = 0; n < 4; n++) {\r\nint i = op->nibbles[n];\r\nif (i < 16) {\r\nif (nibs[n] == i)\r\ncontinue;\r\ngoto fail;\r\n}\r\nswitch (i) {\r\ncase BRANCH_8:\r\nimm = (nibs[2] << 4) | (nibs[3]);\r\nif (imm & 0x80)\r\nimm |= ~0xff;\r\nimm = ((char)imm) * 2 + 4 ;\r\ngoto ok;\r\ncase BRANCH_12:\r\nimm = ((nibs[1]) << 8) | (nibs[2] << 4) | (nibs[3]);\r\nif (imm & 0x800)\r\nimm |= ~0xfff;\r\nimm = imm * 2 + 4;\r\ngoto ok;\r\ncase IMM_4:\r\nimm = nibs[3];\r\ngoto ok;\r\ncase IMM_4BY2:\r\nimm = nibs[3] <<1;\r\ngoto ok;\r\ncase IMM_4BY4:\r\nimm = nibs[3] <<2;\r\ngoto ok;\r\ncase IMM_8:\r\nimm = (nibs[2] << 4) | nibs[3];\r\ngoto ok;\r\ncase PCRELIMM_8BY2:\r\nimm = ((nibs[2] << 4) | nibs[3]) <<1;\r\nrelmask = ~1;\r\ngoto ok;\r\ncase PCRELIMM_8BY4:\r\nimm = ((nibs[2] << 4) | nibs[3]) <<2;\r\nrelmask = ~3;\r\ngoto ok;\r\ncase IMM_8BY2:\r\nimm = ((nibs[2] << 4) | nibs[3]) <<1;\r\ngoto ok;\r\ncase IMM_8BY4:\r\nimm = ((nibs[2] << 4) | nibs[3]) <<2;\r\ngoto ok;\r\ncase DISP_8:\r\nimm = (nibs[2] << 4) | (nibs[3]);\r\ngoto ok;\r\ncase DISP_4:\r\nimm = nibs[3];\r\ngoto ok;\r\ncase REG_N:\r\nrn = nibs[n];\r\nbreak;\r\ncase REG_M:\r\nrm = nibs[n];\r\nbreak;\r\ncase REG_NM:\r\nrn = (nibs[n] & 0xc) >> 2;\r\nrm = (nibs[n] & 0x3);\r\nbreak;\r\ncase REG_B:\r\nrb = nibs[n] & 0x07;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n}\r\nok:\r\nprintk("%-8s ", op->name);\r\nlastsp = (op->arg[0] == A_END);\r\ndisp_pc = 0;\r\nfor (n = 0; n < 6 && op->arg[n] != A_END; n++) {\r\nif (n && op->arg[1] != A_END)\r\nprintk(", ");\r\nswitch (op->arg[n]) {\r\ncase A_IMM:\r\nprintk("#%d", (char)(imm));\r\nbreak;\r\ncase A_R0:\r\nprintk("r0");\r\nbreak;\r\ncase A_REG_N:\r\nprintk("r%d", rn);\r\nbreak;\r\ncase A_INC_N:\r\nprintk("@r%d+", rn);\r\nbreak;\r\ncase A_DEC_N:\r\nprintk("@-r%d", rn);\r\nbreak;\r\ncase A_IND_N:\r\nprintk("@r%d", rn);\r\nbreak;\r\ncase A_DISP_REG_N:\r\nprintk("@(%d,r%d)", imm, rn);\r\nbreak;\r\ncase A_REG_M:\r\nprintk("r%d", rm);\r\nbreak;\r\ncase A_INC_M:\r\nprintk("@r%d+", rm);\r\nbreak;\r\ncase A_DEC_M:\r\nprintk("@-r%d", rm);\r\nbreak;\r\ncase A_IND_M:\r\nprintk("@r%d", rm);\r\nbreak;\r\ncase A_DISP_REG_M:\r\nprintk("@(%d,r%d)", imm, rm);\r\nbreak;\r\ncase A_REG_B:\r\nprintk("r%d_bank", rb);\r\nbreak;\r\ncase A_DISP_PC:\r\ndisp_pc = 1;\r\ndisp_pc_addr = imm + 4 + (memaddr & relmask);\r\nprintk("%08x <%pS>", disp_pc_addr,\r\n(void *)disp_pc_addr);\r\nbreak;\r\ncase A_IND_R0_REG_N:\r\nprintk("@(r0,r%d)", rn);\r\nbreak;\r\ncase A_IND_R0_REG_M:\r\nprintk("@(r0,r%d)", rm);\r\nbreak;\r\ncase A_DISP_GBR:\r\nprintk("@(%d,gbr)",imm);\r\nbreak;\r\ncase A_R0_GBR:\r\nprintk("@(r0,gbr)");\r\nbreak;\r\ncase A_BDISP12:\r\ncase A_BDISP8:\r\nprintk("%08x", imm + memaddr);\r\nbreak;\r\ncase A_SR:\r\nprintk("sr");\r\nbreak;\r\ncase A_GBR:\r\nprintk("gbr");\r\nbreak;\r\ncase A_VBR:\r\nprintk("vbr");\r\nbreak;\r\ncase A_SSR:\r\nprintk("ssr");\r\nbreak;\r\ncase A_SPC:\r\nprintk("spc");\r\nbreak;\r\ncase A_MACH:\r\nprintk("mach");\r\nbreak;\r\ncase A_MACL:\r\nprintk("macl");\r\nbreak;\r\ncase A_PR:\r\nprintk("pr");\r\nbreak;\r\ncase A_SGR:\r\nprintk("sgr");\r\nbreak;\r\ncase A_DBR:\r\nprintk("dbr");\r\nbreak;\r\ncase FD_REG_N:\r\nif (0)\r\ngoto d_reg_n;\r\ncase F_REG_N:\r\nprintk("fr%d", rn);\r\nbreak;\r\ncase F_REG_M:\r\nprintk("fr%d", rm);\r\nbreak;\r\ncase DX_REG_N:\r\nif (rn & 1) {\r\nprintk("xd%d", rn & ~1);\r\nbreak;\r\n}\r\nd_reg_n:\r\ncase D_REG_N:\r\nprintk("dr%d", rn);\r\nbreak;\r\ncase DX_REG_M:\r\nif (rm & 1) {\r\nprintk("xd%d", rm & ~1);\r\nbreak;\r\n}\r\ncase D_REG_M:\r\nprintk("dr%d", rm);\r\nbreak;\r\ncase FPSCR_M:\r\ncase FPSCR_N:\r\nprintk("fpscr");\r\nbreak;\r\ncase FPUL_M:\r\ncase FPUL_N:\r\nprintk("fpul");\r\nbreak;\r\ncase F_FR0:\r\nprintk("fr0");\r\nbreak;\r\ncase V_REG_N:\r\nprintk("fv%d", rn*4);\r\nbreak;\r\ncase V_REG_M:\r\nprintk("fv%d", rm*4);\r\nbreak;\r\ncase XMTRX_M4:\r\nprintk("xmtrx");\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n}\r\nif (disp_pc && strcmp(op->name, "mova") != 0) {\r\nu32 val;\r\nif (relmask == ~1)\r\n__get_user(val, (u16 *)disp_pc_addr);\r\nelse\r\n__get_user(val, (u32 *)disp_pc_addr);\r\nprintk(" ! %08x <%pS>", val, (void *)val);\r\n}\r\nreturn;\r\nfail:\r\n;\r\n}\r\nprintk(".word 0x%x%x%x%x", nibs[0], nibs[1], nibs[2], nibs[3]);\r\n}\r\nvoid show_code(struct pt_regs *regs)\r\n{\r\nunsigned short *pc = (unsigned short *)regs->pc;\r\nlong i;\r\nif (regs->pc & 0x1)\r\nreturn;\r\nprintk("Code:\n");\r\nfor (i = -3 ; i < 6 ; i++) {\r\nunsigned short insn;\r\nif (__get_user(insn, pc + i)) {\r\nprintk(" (Bad address in pc)\n");\r\nbreak;\r\n}\r\nprintk("%s%08lx: ", (i ? " ": "->"), (unsigned long)(pc + i));\r\nprint_sh_insn((unsigned long)(pc + i), insn);\r\nprintk("\n");\r\n}\r\nprintk("\n");\r\n}

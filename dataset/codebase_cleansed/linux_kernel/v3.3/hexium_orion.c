static int hexium_probe(struct saa7146_dev *dev)\r\n{\r\nstruct hexium *hexium = NULL;\r\nunion i2c_smbus_data data;\r\nint err = 0;\r\nDEB_EE("\n");\r\nif (0 == dev->revision) {\r\nreturn -EFAULT;\r\n}\r\nhexium = kzalloc(sizeof(struct hexium), GFP_KERNEL);\r\nif (NULL == hexium) {\r\npr_err("hexium_probe: not enough kernel memory\n");\r\nreturn -ENOMEM;\r\n}\r\nsaa7146_write(dev, MC1, (MASK_08 | MASK_24 | MASK_10 | MASK_26));\r\nsaa7146_write(dev, DD1_INIT, 0x01000100);\r\nsaa7146_write(dev, DD1_STREAM_B, 0x00000000);\r\nsaa7146_write(dev, MC2, (MASK_09 | MASK_25 | MASK_10 | MASK_26));\r\nhexium->i2c_adapter = (struct i2c_adapter) {\r\n.name = "hexium orion",\r\n};\r\nsaa7146_i2c_adapter_prepare(dev, &hexium->i2c_adapter, SAA7146_I2C_BUS_BIT_RATE_480);\r\nif (i2c_add_adapter(&hexium->i2c_adapter) < 0) {\r\nDEB_S("cannot register i2c-device. skipping.\n");\r\nkfree(hexium);\r\nreturn -EFAULT;\r\n}\r\nsaa7146_setgpio(dev, 0, SAA7146_GPIO_OUTHI);\r\nsaa7146_setgpio(dev, 2, SAA7146_GPIO_OUTHI);\r\nmdelay(10);\r\nif (0x17c8 == dev->pci->subsystem_vendor && 0x0101 == dev->pci->subsystem_device) {\r\npr_info("device is a Hexium Orion w/ 1 SVHS + 3 BNC inputs\n");\r\ndev->ext_priv = hexium;\r\nhexium->type = HEXIUM_ORION_1SVHS_3BNC;\r\nreturn 0;\r\n}\r\nif (0x17c8 == dev->pci->subsystem_vendor && 0x2101 == dev->pci->subsystem_device) {\r\npr_info("device is a Hexium Orion w/ 4 BNC inputs\n");\r\ndev->ext_priv = hexium;\r\nhexium->type = HEXIUM_ORION_4BNC;\r\nreturn 0;\r\n}\r\nif (0 == (err = i2c_smbus_xfer(&hexium->i2c_adapter, 0x4e, 0, I2C_SMBUS_READ, 0x00, I2C_SMBUS_BYTE_DATA, &data))) {\r\npr_info("device is a Hexium HV-PCI6/Orion (old)\n");\r\ndev->ext_priv = hexium;\r\nhexium->type = HEXIUM_HV_PCI6_ORION;\r\nreturn 0;\r\n}\r\ni2c_del_adapter(&hexium->i2c_adapter);\r\nkfree(hexium);\r\nreturn -EFAULT;\r\n}\r\nstatic int hexium_init_done(struct saa7146_dev *dev)\r\n{\r\nstruct hexium *hexium = (struct hexium *) dev->ext_priv;\r\nunion i2c_smbus_data data;\r\nint i = 0;\r\nDEB_D("hexium_init_done called\n");\r\nfor (i = 0; i < sizeof(hexium_saa7110); i++) {\r\ndata.byte = hexium_saa7110[i];\r\nif (0 != i2c_smbus_xfer(&hexium->i2c_adapter, 0x4e, 0, I2C_SMBUS_WRITE, i, I2C_SMBUS_BYTE_DATA, &data)) {\r\npr_err("failed for address 0x%02x\n", i);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int hexium_set_input(struct hexium *hexium, int input)\r\n{\r\nunion i2c_smbus_data data;\r\nint i = 0;\r\nDEB_D("\n");\r\nfor (i = 0; i < 8; i++) {\r\nint adr = hexium_input_select[input].data[i].adr;\r\ndata.byte = hexium_input_select[input].data[i].byte;\r\nif (0 != i2c_smbus_xfer(&hexium->i2c_adapter, 0x4e, 0, I2C_SMBUS_WRITE, adr, I2C_SMBUS_BYTE_DATA, &data)) {\r\nreturn -1;\r\n}\r\npr_debug("%d: 0x%02x => 0x%02x\n", input, adr, data.byte);\r\n}\r\nreturn 0;\r\n}\r\nstatic int vidioc_enum_input(struct file *file, void *fh, struct v4l2_input *i)\r\n{\r\nDEB_EE("VIDIOC_ENUMINPUT %d\n", i->index);\r\nif (i->index >= HEXIUM_INPUTS)\r\nreturn -EINVAL;\r\nmemcpy(i, &hexium_inputs[i->index], sizeof(struct v4l2_input));\r\nDEB_D("v4l2_ioctl: VIDIOC_ENUMINPUT %d\n", i->index);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_input(struct file *file, void *fh, unsigned int *input)\r\n{\r\nstruct saa7146_dev *dev = ((struct saa7146_fh *)fh)->dev;\r\nstruct hexium *hexium = (struct hexium *) dev->ext_priv;\r\n*input = hexium->cur_input;\r\nDEB_D("VIDIOC_G_INPUT: %d\n", *input);\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_input(struct file *file, void *fh, unsigned int input)\r\n{\r\nstruct saa7146_dev *dev = ((struct saa7146_fh *)fh)->dev;\r\nstruct hexium *hexium = (struct hexium *) dev->ext_priv;\r\nif (input >= HEXIUM_INPUTS)\r\nreturn -EINVAL;\r\nhexium->cur_input = input;\r\nhexium_set_input(hexium, input);\r\nreturn 0;\r\n}\r\nstatic int hexium_attach(struct saa7146_dev *dev, struct saa7146_pci_extension_data *info)\r\n{\r\nstruct hexium *hexium = (struct hexium *) dev->ext_priv;\r\nDEB_EE("\n");\r\nsaa7146_vv_init(dev, &vv_data);\r\nvv_data.ops.vidioc_enum_input = vidioc_enum_input;\r\nvv_data.ops.vidioc_g_input = vidioc_g_input;\r\nvv_data.ops.vidioc_s_input = vidioc_s_input;\r\nif (0 != saa7146_register_device(&hexium->video_dev, dev, "hexium orion", VFL_TYPE_GRABBER)) {\r\npr_err("cannot register capture v4l2 device. skipping.\n");\r\nreturn -1;\r\n}\r\npr_err("found 'hexium orion' frame grabber-%d\n", hexium_num);\r\nhexium_num++;\r\nhexium->cur_input = 0;\r\nhexium_init_done(dev);\r\nreturn 0;\r\n}\r\nstatic int hexium_detach(struct saa7146_dev *dev)\r\n{\r\nstruct hexium *hexium = (struct hexium *) dev->ext_priv;\r\nDEB_EE("dev:%p\n", dev);\r\nsaa7146_unregister_device(&hexium->video_dev, dev);\r\nsaa7146_vv_release(dev);\r\nhexium_num--;\r\ni2c_del_adapter(&hexium->i2c_adapter);\r\nkfree(hexium);\r\nreturn 0;\r\n}\r\nstatic int std_callback(struct saa7146_dev *dev, struct saa7146_standard *std)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init hexium_init_module(void)\r\n{\r\nif (0 != saa7146_register_extension(&extension)) {\r\nDEB_S("failed to register extension\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit hexium_cleanup_module(void)\r\n{\r\nsaa7146_unregister_extension(&extension);\r\n}

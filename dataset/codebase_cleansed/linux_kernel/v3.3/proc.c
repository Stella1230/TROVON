static int __init iseries_proc_create(void)\r\n{\r\nstruct proc_dir_entry *e;\r\nif (!firmware_has_feature(FW_FEATURE_ISERIES))\r\nreturn 0;\r\ne = proc_mkdir("iSeries", 0);\r\nif (!e)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int proc_titantod_show(struct seq_file *m, void *v)\r\n{\r\nunsigned long tb0, titan_tod;\r\ntb0 = get_tb();\r\ntitan_tod = HvCallXm_loadTod();\r\nseq_printf(m, "Titan\n" );\r\nseq_printf(m, " time base = %016lx\n", tb0);\r\nseq_printf(m, " titan tod = %016lx\n", titan_tod);\r\nseq_printf(m, " xProcFreq = %016x\n",\r\nxIoHriProcessorVpd[0].xProcFreq);\r\nseq_printf(m, " xTimeBaseFreq = %016x\n",\r\nxIoHriProcessorVpd[0].xTimeBaseFreq);\r\nseq_printf(m, " tb_ticks_per_jiffy = %lu\n", tb_ticks_per_jiffy);\r\nseq_printf(m, " tb_ticks_per_usec = %lu\n", tb_ticks_per_usec);\r\nif (!startTitan) {\r\nstartTitan = titan_tod;\r\nstartTb = tb0;\r\n} else {\r\nunsigned long titan_usec = (titan_tod - startTitan) >> 12;\r\nunsigned long tb_ticks = (tb0 - startTb);\r\nunsigned long titan_jiffies = titan_usec / (1000000/HZ);\r\nunsigned long titan_jiff_usec = titan_jiffies * (1000000/HZ);\r\nunsigned long titan_jiff_rem_usec =\r\ntitan_usec - titan_jiff_usec;\r\nunsigned long tb_jiffies = tb_ticks / tb_ticks_per_jiffy;\r\nunsigned long tb_jiff_ticks = tb_jiffies * tb_ticks_per_jiffy;\r\nunsigned long tb_jiff_rem_ticks = tb_ticks - tb_jiff_ticks;\r\nunsigned long tb_jiff_rem_usec =\r\ntb_jiff_rem_ticks / tb_ticks_per_usec;\r\nunsigned long new_tb_ticks_per_jiffy =\r\n(tb_ticks * (1000000/HZ))/titan_usec;\r\nseq_printf(m, " titan elapsed = %lu uSec\n", titan_usec);\r\nseq_printf(m, " tb elapsed = %lu ticks\n", tb_ticks);\r\nseq_printf(m, " titan jiffies = %lu.%04lu\n", titan_jiffies,\r\ntitan_jiff_rem_usec);\r\nseq_printf(m, " tb jiffies = %lu.%04lu\n", tb_jiffies,\r\ntb_jiff_rem_usec);\r\nseq_printf(m, " new tb_ticks_per_jiffy = %lu\n",\r\nnew_tb_ticks_per_jiffy);\r\n}\r\nreturn 0;\r\n}\r\nstatic int proc_titantod_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, proc_titantod_show, NULL);\r\n}\r\nstatic int __init iseries_proc_init(void)\r\n{\r\nif (!firmware_has_feature(FW_FEATURE_ISERIES))\r\nreturn 0;\r\nproc_create("iSeries/titanTod", S_IFREG|S_IRUGO, NULL,\r\n&proc_titantod_operations);\r\nreturn 0;\r\n}

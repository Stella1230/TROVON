static noinline size_t\r\n_lzo1x_1_do_compress(const unsigned char *in, size_t in_len,\r\nunsigned char *out, size_t *out_len, void *wrkmem)\r\n{\r\nconst unsigned char * const in_end = in + in_len;\r\nconst unsigned char * const ip_end = in + in_len - M2_MAX_LEN - 5;\r\nconst unsigned char ** const dict = wrkmem;\r\nconst unsigned char *ip = in, *ii = ip;\r\nconst unsigned char *end, *m, *m_pos;\r\nsize_t m_off, m_len, dindex;\r\nunsigned char *op = out;\r\nip += 4;\r\nfor (;;) {\r\ndindex = ((size_t)(0x21 * DX3(ip, 5, 5, 6)) >> 5) & D_MASK;\r\nm_pos = dict[dindex];\r\nif (m_pos < in)\r\ngoto literal;\r\nif (ip == m_pos || ((size_t)(ip - m_pos) > M4_MAX_OFFSET))\r\ngoto literal;\r\nm_off = ip - m_pos;\r\nif (m_off <= M2_MAX_OFFSET || m_pos[3] == ip[3])\r\ngoto try_match;\r\ndindex = (dindex & (D_MASK & 0x7ff)) ^ (D_HIGH | 0x1f);\r\nm_pos = dict[dindex];\r\nif (m_pos < in)\r\ngoto literal;\r\nif (ip == m_pos || ((size_t)(ip - m_pos) > M4_MAX_OFFSET))\r\ngoto literal;\r\nm_off = ip - m_pos;\r\nif (m_off <= M2_MAX_OFFSET || m_pos[3] == ip[3])\r\ngoto try_match;\r\ngoto literal;\r\ntry_match:\r\nif (get_unaligned((const unsigned short *)m_pos)\r\n== get_unaligned((const unsigned short *)ip)) {\r\nif (likely(m_pos[2] == ip[2]))\r\ngoto match;\r\n}\r\nliteral:\r\ndict[dindex] = ip;\r\n++ip;\r\nif (unlikely(ip >= ip_end))\r\nbreak;\r\ncontinue;\r\nmatch:\r\ndict[dindex] = ip;\r\nif (ip != ii) {\r\nsize_t t = ip - ii;\r\nif (t <= 3) {\r\nop[-2] |= t;\r\n} else if (t <= 18) {\r\n*op++ = (t - 3);\r\n} else {\r\nsize_t tt = t - 18;\r\n*op++ = 0;\r\nwhile (tt > 255) {\r\ntt -= 255;\r\n*op++ = 0;\r\n}\r\n*op++ = tt;\r\n}\r\ndo {\r\n*op++ = *ii++;\r\n} while (--t > 0);\r\n}\r\nip += 3;\r\nif (m_pos[3] != *ip++ || m_pos[4] != *ip++\r\n|| m_pos[5] != *ip++ || m_pos[6] != *ip++\r\n|| m_pos[7] != *ip++ || m_pos[8] != *ip++) {\r\n--ip;\r\nm_len = ip - ii;\r\nif (m_off <= M2_MAX_OFFSET) {\r\nm_off -= 1;\r\n*op++ = (((m_len - 1) << 5)\r\n| ((m_off & 7) << 2));\r\n*op++ = (m_off >> 3);\r\n} else if (m_off <= M3_MAX_OFFSET) {\r\nm_off -= 1;\r\n*op++ = (M3_MARKER | (m_len - 2));\r\ngoto m3_m4_offset;\r\n} else {\r\nm_off -= 0x4000;\r\n*op++ = (M4_MARKER | ((m_off & 0x4000) >> 11)\r\n| (m_len - 2));\r\ngoto m3_m4_offset;\r\n}\r\n} else {\r\nend = in_end;\r\nm = m_pos + M2_MAX_LEN + 1;\r\nwhile (ip < end && *m == *ip) {\r\nm++;\r\nip++;\r\n}\r\nm_len = ip - ii;\r\nif (m_off <= M3_MAX_OFFSET) {\r\nm_off -= 1;\r\nif (m_len <= 33) {\r\n*op++ = (M3_MARKER | (m_len - 2));\r\n} else {\r\nm_len -= 33;\r\n*op++ = M3_MARKER | 0;\r\ngoto m3_m4_len;\r\n}\r\n} else {\r\nm_off -= 0x4000;\r\nif (m_len <= M4_MAX_LEN) {\r\n*op++ = (M4_MARKER\r\n| ((m_off & 0x4000) >> 11)\r\n| (m_len - 2));\r\n} else {\r\nm_len -= M4_MAX_LEN;\r\n*op++ = (M4_MARKER\r\n| ((m_off & 0x4000) >> 11));\r\nm3_m4_len:\r\nwhile (m_len > 255) {\r\nm_len -= 255;\r\n*op++ = 0;\r\n}\r\n*op++ = (m_len);\r\n}\r\n}\r\nm3_m4_offset:\r\n*op++ = ((m_off & 63) << 2);\r\n*op++ = (m_off >> 6);\r\n}\r\nii = ip;\r\nif (unlikely(ip >= ip_end))\r\nbreak;\r\n}\r\n*out_len = op - out;\r\nreturn in_end - ii;\r\n}\r\nint lzo1x_1_compress(const unsigned char *in, size_t in_len, unsigned char *out,\r\nsize_t *out_len, void *wrkmem)\r\n{\r\nconst unsigned char *ii;\r\nunsigned char *op = out;\r\nsize_t t;\r\nif (unlikely(in_len <= M2_MAX_LEN + 5)) {\r\nt = in_len;\r\n} else {\r\nt = _lzo1x_1_do_compress(in, in_len, op, out_len, wrkmem);\r\nop += *out_len;\r\n}\r\nif (t > 0) {\r\nii = in + in_len - t;\r\nif (op == out && t <= 238) {\r\n*op++ = (17 + t);\r\n} else if (t <= 3) {\r\nop[-2] |= t;\r\n} else if (t <= 18) {\r\n*op++ = (t - 3);\r\n} else {\r\nsize_t tt = t - 18;\r\n*op++ = 0;\r\nwhile (tt > 255) {\r\ntt -= 255;\r\n*op++ = 0;\r\n}\r\n*op++ = tt;\r\n}\r\ndo {\r\n*op++ = *ii++;\r\n} while (--t > 0);\r\n}\r\n*op++ = M4_MARKER | 1;\r\n*op++ = 0;\r\n*op++ = 0;\r\n*out_len = op - out;\r\nreturn LZO_E_OK;\r\n}

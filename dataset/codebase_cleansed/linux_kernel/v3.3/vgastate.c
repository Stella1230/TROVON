static inline unsigned char vga_rcrtcs(void __iomem *regbase, unsigned short iobase,\r\nunsigned char reg)\r\n{\r\nvga_w(regbase, iobase + 0x4, reg);\r\nreturn vga_r(regbase, iobase + 0x5);\r\n}\r\nstatic inline void vga_wcrtcs(void __iomem *regbase, unsigned short iobase,\r\nunsigned char reg, unsigned char val)\r\n{\r\nvga_w(regbase, iobase + 0x4, reg);\r\nvga_w(regbase, iobase + 0x5, val);\r\n}\r\nstatic void save_vga_text(struct vgastate *state, void __iomem *fbbase)\r\n{\r\nstruct regstate *saved = (struct regstate *) state->vidstate;\r\nint i;\r\nu8 misc, attr10, gr4, gr5, gr6, seq1, seq2, seq4;\r\nunsigned short iobase;\r\nmisc = vga_r(state->vgabase, VGA_MIS_R);\r\niobase = (misc & 1) ? 0x3d0 : 0x3b0;\r\nvga_r(state->vgabase, iobase + 0xa);\r\nvga_w(state->vgabase, VGA_ATT_W, 0x00);\r\nattr10 = vga_rattr(state->vgabase, 0x10);\r\nvga_r(state->vgabase, iobase + 0xa);\r\nvga_w(state->vgabase, VGA_ATT_W, 0x20);\r\nif (attr10 & 1)\r\nreturn;\r\ngr4 = vga_rgfx(state->vgabase, VGA_GFX_PLANE_READ);\r\ngr5 = vga_rgfx(state->vgabase, VGA_GFX_MODE);\r\ngr6 = vga_rgfx(state->vgabase, VGA_GFX_MISC);\r\nseq2 = vga_rseq(state->vgabase, VGA_SEQ_PLANE_WRITE);\r\nseq4 = vga_rseq(state->vgabase, VGA_SEQ_MEMORY_MODE);\r\nseq1 = vga_rseq(state->vgabase, VGA_SEQ_CLOCK_MODE);\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 | 1 << 5);\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\r\nif (state->flags & VGA_SAVE_FONT0) {\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x4);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x2);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < 4 * 8192; i++)\r\nsaved->vga_font0[i] = vga_r(fbbase, i);\r\n}\r\nif (state->flags & VGA_SAVE_FONT1) {\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x8);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x3);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < state->memsize; i++)\r\nsaved->vga_font1[i] = vga_r(fbbase, i);\r\n}\r\nif (state->flags & VGA_SAVE_TEXT) {\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x1);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < 8192; i++)\r\nsaved->vga_text[i] = vga_r(fbbase, i);\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x2);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x1);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < 8192; i++)\r\nsaved->vga_text[8192+i] = vga_r(fbbase + 2 * 8192, i);\r\n}\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, seq2);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, seq4);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, gr4);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, gr5);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, gr6);\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 & ~(1 << 5));\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1);\r\n}\r\nstatic void restore_vga_text(struct vgastate *state, void __iomem *fbbase)\r\n{\r\nstruct regstate *saved = (struct regstate *) state->vidstate;\r\nint i;\r\nu8 gr1, gr3, gr4, gr5, gr6, gr8;\r\nu8 seq1, seq2, seq4;\r\ngr1 = vga_rgfx(state->vgabase, VGA_GFX_SR_ENABLE);\r\ngr3 = vga_rgfx(state->vgabase, VGA_GFX_DATA_ROTATE);\r\ngr4 = vga_rgfx(state->vgabase, VGA_GFX_PLANE_READ);\r\ngr5 = vga_rgfx(state->vgabase, VGA_GFX_MODE);\r\ngr6 = vga_rgfx(state->vgabase, VGA_GFX_MISC);\r\ngr8 = vga_rgfx(state->vgabase, VGA_GFX_BIT_MASK);\r\nseq2 = vga_rseq(state->vgabase, VGA_SEQ_PLANE_WRITE);\r\nseq4 = vga_rseq(state->vgabase, VGA_SEQ_MEMORY_MODE);\r\nseq1 = vga_rseq(state->vgabase, VGA_SEQ_CLOCK_MODE);\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 | 1 << 5);\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\r\nif (state->depth == 4) {\r\nvga_wgfx(state->vgabase, VGA_GFX_DATA_ROTATE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_BIT_MASK, 0xff);\r\nvga_wgfx(state->vgabase, VGA_GFX_SR_ENABLE, 0x00);\r\n}\r\nif (state->flags & VGA_SAVE_FONT0) {\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x4);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x2);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < 4 * 8192; i++)\r\nvga_w(fbbase, i, saved->vga_font0[i]);\r\n}\r\nif (state->flags & VGA_SAVE_FONT1) {\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x8);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x3);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < state->memsize; i++)\r\nvga_w(fbbase, i, saved->vga_font1[i]);\r\n}\r\nif (state->flags & VGA_SAVE_TEXT) {\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x1);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < 8192; i++)\r\nvga_w(fbbase, i, saved->vga_text[i]);\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, 0x2);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, 0x6);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, 0x1);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, 0x0);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, 0x5);\r\nfor (i = 0; i < 8192; i++)\r\nvga_w(fbbase, i, saved->vga_text[8192+i]);\r\n}\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x1);\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1 & ~(1 << 5));\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x3);\r\nvga_wgfx(state->vgabase, VGA_GFX_SR_ENABLE, gr1);\r\nvga_wgfx(state->vgabase, VGA_GFX_DATA_ROTATE, gr3);\r\nvga_wgfx(state->vgabase, VGA_GFX_PLANE_READ, gr4);\r\nvga_wgfx(state->vgabase, VGA_GFX_MODE, gr5);\r\nvga_wgfx(state->vgabase, VGA_GFX_MISC, gr6);\r\nvga_wgfx(state->vgabase, VGA_GFX_BIT_MASK, gr8);\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE, seq1);\r\nvga_wseq(state->vgabase, VGA_SEQ_PLANE_WRITE, seq2);\r\nvga_wseq(state->vgabase, VGA_SEQ_MEMORY_MODE, seq4);\r\n}\r\nstatic void save_vga_mode(struct vgastate *state)\r\n{\r\nstruct regstate *saved = (struct regstate *) state->vidstate;\r\nunsigned short iobase;\r\nint i;\r\nsaved->misc = vga_r(state->vgabase, VGA_MIS_R);\r\nif (saved->misc & 1)\r\niobase = 0x3d0;\r\nelse\r\niobase = 0x3b0;\r\nfor (i = 0; i < state->num_crtc; i++)\r\nsaved->crtc[i] = vga_rcrtcs(state->vgabase, iobase, i);\r\nvga_r(state->vgabase, iobase + 0xa);\r\nvga_w(state->vgabase, VGA_ATT_W, 0x00);\r\nfor (i = 0; i < state->num_attr; i++) {\r\nvga_r(state->vgabase, iobase + 0xa);\r\nsaved->attr[i] = vga_rattr(state->vgabase, i);\r\n}\r\nvga_r(state->vgabase, iobase + 0xa);\r\nvga_w(state->vgabase, VGA_ATT_W, 0x20);\r\nfor (i = 0; i < state->num_gfx; i++)\r\nsaved->gfx[i] = vga_rgfx(state->vgabase, i);\r\nfor (i = 0; i < state->num_seq; i++)\r\nsaved->seq[i] = vga_rseq(state->vgabase, i);\r\n}\r\nstatic void restore_vga_mode(struct vgastate *state)\r\n{\r\nstruct regstate *saved = (struct regstate *) state->vidstate;\r\nunsigned short iobase;\r\nint i;\r\nvga_w(state->vgabase, VGA_MIS_W, saved->misc);\r\nif (saved->misc & 1)\r\niobase = 0x3d0;\r\nelse\r\niobase = 0x3b0;\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE,\r\nsaved->seq[VGA_SEQ_CLOCK_MODE] | 0x20);\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x01);\r\nvga_r(state->vgabase, iobase + 0xa);\r\nvga_w(state->vgabase, VGA_ATT_W, 0x00);\r\nfor (i = 2; i < state->num_seq; i++)\r\nvga_wseq(state->vgabase, i, saved->seq[i]);\r\nvga_wcrtcs(state->vgabase, iobase, 17, saved->crtc[17] & ~0x80);\r\nfor (i = 0; i < state->num_crtc; i++)\r\nvga_wcrtcs(state->vgabase, iobase, i, saved->crtc[i]);\r\nfor (i = 0; i < state->num_gfx; i++)\r\nvga_wgfx(state->vgabase, i, saved->gfx[i]);\r\nfor (i = 0; i < state->num_attr; i++) {\r\nvga_r(state->vgabase, iobase + 0xa);\r\nvga_wattr(state->vgabase, i, saved->attr[i]);\r\n}\r\nvga_wseq(state->vgabase, VGA_SEQ_RESET, 0x03);\r\nvga_wseq(state->vgabase, VGA_SEQ_CLOCK_MODE,\r\nsaved->seq[VGA_SEQ_CLOCK_MODE] & ~(1 << 5));\r\nvga_r(state->vgabase, iobase + 0xa);\r\nvga_w(state->vgabase, VGA_ATT_W, 0x20);\r\n}\r\nstatic void save_vga_cmap(struct vgastate *state)\r\n{\r\nstruct regstate *saved = (struct regstate *) state->vidstate;\r\nint i;\r\nvga_w(state->vgabase, VGA_PEL_MSK, 0xff);\r\nvga_w(state->vgabase, VGA_PEL_IR, 0x00);\r\nfor (i = 0; i < 768; i++)\r\nsaved->vga_cmap[i] = vga_r(state->vgabase, VGA_PEL_D);\r\n}\r\nstatic void restore_vga_cmap(struct vgastate *state)\r\n{\r\nstruct regstate *saved = (struct regstate *) state->vidstate;\r\nint i;\r\nvga_w(state->vgabase, VGA_PEL_MSK, 0xff);\r\nvga_w(state->vgabase, VGA_PEL_IW, 0x00);\r\nfor (i = 0; i < 768; i++)\r\nvga_w(state->vgabase, VGA_PEL_D, saved->vga_cmap[i]);\r\n}\r\nstatic void vga_cleanup(struct vgastate *state)\r\n{\r\nif (state->vidstate != NULL) {\r\nstruct regstate *saved = (struct regstate *) state->vidstate;\r\nvfree(saved->vga_font0);\r\nvfree(saved->vga_font1);\r\nvfree(saved->vga_text);\r\nvfree(saved->vga_cmap);\r\nvfree(saved->attr);\r\nkfree(saved);\r\nstate->vidstate = NULL;\r\n}\r\n}\r\nint save_vga(struct vgastate *state)\r\n{\r\nstruct regstate *saved;\r\nsaved = kzalloc(sizeof(struct regstate), GFP_KERNEL);\r\nif (saved == NULL)\r\nreturn 1;\r\nstate->vidstate = (void *)saved;\r\nif (state->flags & VGA_SAVE_CMAP) {\r\nsaved->vga_cmap = vmalloc(768);\r\nif (!saved->vga_cmap) {\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\nsave_vga_cmap(state);\r\n}\r\nif (state->flags & VGA_SAVE_MODE) {\r\nint total;\r\nif (state->num_attr < 21)\r\nstate->num_attr = 21;\r\nif (state->num_crtc < 25)\r\nstate->num_crtc = 25;\r\nif (state->num_gfx < 9)\r\nstate->num_gfx = 9;\r\nif (state->num_seq < 5)\r\nstate->num_seq = 5;\r\ntotal = state->num_attr + state->num_crtc +\r\nstate->num_gfx + state->num_seq;\r\nsaved->attr = vmalloc(total);\r\nif (!saved->attr) {\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\nsaved->crtc = saved->attr + state->num_attr;\r\nsaved->gfx = saved->crtc + state->num_crtc;\r\nsaved->seq = saved->gfx + state->num_gfx;\r\nsave_vga_mode(state);\r\n}\r\nif (state->flags & VGA_SAVE_FONTS) {\r\nvoid __iomem *fbbase;\r\nif (state->memsize && state->memsize < 4 * 8192) {\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\nif (!state->memsize)\r\nstate->memsize = 8 * 8192;\r\nif (!state->membase)\r\nstate->membase = 0xA0000;\r\nfbbase = ioremap(state->membase, state->memsize);\r\nif (!fbbase) {\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\nif (state->flags & VGA_SAVE_FONT0) {\r\nsaved->vga_font0 = vmalloc(4 * 8192);\r\nif (!saved->vga_font0) {\r\niounmap(fbbase);\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\n}\r\nif (state->flags & VGA_SAVE_FONT1) {\r\nsaved->vga_font1 = vmalloc(state->memsize);\r\nif (!saved->vga_font1) {\r\niounmap(fbbase);\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\n}\r\nif (state->flags & VGA_SAVE_TEXT) {\r\nsaved->vga_text = vmalloc(8192 * 2);\r\nif (!saved->vga_text) {\r\niounmap(fbbase);\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\n}\r\nsave_vga_text(state, fbbase);\r\niounmap(fbbase);\r\n}\r\nreturn 0;\r\n}\r\nint restore_vga (struct vgastate *state)\r\n{\r\nif (state->vidstate == NULL)\r\nreturn 1;\r\nif (state->flags & VGA_SAVE_MODE)\r\nrestore_vga_mode(state);\r\nif (state->flags & VGA_SAVE_FONTS) {\r\nvoid __iomem *fbbase = ioremap(state->membase, state->memsize);\r\nif (!fbbase) {\r\nvga_cleanup(state);\r\nreturn 1;\r\n}\r\nrestore_vga_text(state, fbbase);\r\niounmap(fbbase);\r\n}\r\nif (state->flags & VGA_SAVE_CMAP)\r\nrestore_vga_cmap(state);\r\nvga_cleanup(state);\r\nreturn 0;\r\n}

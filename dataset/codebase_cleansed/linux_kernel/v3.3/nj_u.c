static u_char dummyrr(struct IsdnCardState *cs, int chan, u_char off)\r\n{\r\nreturn(5);\r\n}\r\nstatic void dummywr(struct IsdnCardState *cs, int chan, u_char off, u_char value)\r\n{\r\n}\r\nstatic irqreturn_t\r\nnetjet_u_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val, sval;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nif (!((sval = bytein(cs->hw.njet.base + NETJET_IRQSTAT1)) &\r\nNETJET_ISACIRQ)) {\r\nval = NETjet_ReadIC(cs, ICC_ISTA);\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "tiger: i1 %x %x", sval, val);\r\nif (val) {\r\nicc_interrupt(cs, val);\r\nNETjet_WriteIC(cs, ICC_MASK, 0xFF);\r\nNETjet_WriteIC(cs, ICC_MASK, 0x0);\r\n}\r\n}\r\nif (inl(cs->hw.njet.base + NETJET_DMA_WRITE_ADR) <\r\ninl(cs->hw.njet.base + NETJET_DMA_WRITE_IRQ))\r\nsval = 0x08;\r\nelse\r\nsval = 0x04;\r\nif (inl(cs->hw.njet.base + NETJET_DMA_READ_ADR) <\r\ninl(cs->hw.njet.base + NETJET_DMA_READ_IRQ))\r\nsval = sval | 0x02;\r\nelse\r\nsval = sval | 0x01;\r\nif (sval != cs->hw.njet.last_is0)\r\n{\r\nif (test_and_set_bit(FLG_LOCK_ATOMIC, &cs->HW_Flags)) {\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\ncs->hw.njet.irqstat0 = sval;\r\nif ((cs->hw.njet.irqstat0 & NETJET_IRQM0_READ) !=\r\n(cs->hw.njet.last_is0 & NETJET_IRQM0_READ))\r\nread_tiger(cs);\r\nif ((cs->hw.njet.irqstat0 & NETJET_IRQM0_WRITE) !=\r\n(cs->hw.njet.last_is0 & NETJET_IRQM0_WRITE))\r\nwrite_tiger(cs);\r\ntest_and_clear_bit(FLG_LOCK_ATOMIC, &cs->HW_Flags);\r\n}\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nreset_netjet_u(struct IsdnCardState *cs)\r\n{\r\ncs->hw.njet.ctrl_reg = 0xff;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\ncs->hw.njet.ctrl_reg = 0x40;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\ncs->hw.njet.auxd = 0xC0;\r\ncs->hw.njet.dmactrl = 0;\r\nbyteout(cs->hw.njet.auxa, 0);\r\nbyteout(cs->hw.njet.base + NETJET_AUXCTRL, ~NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.base + NETJET_IRQMASK1, NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.auxa, cs->hw.njet.auxd);\r\n}\r\nstatic int\r\nNETjet_U_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_netjet_u(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_RELEASE:\r\nrelease_io_netjet(cs);\r\nreturn(0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\ninittiger(cs);\r\nreset_netjet_u(cs);\r\nclear_pending_icc_ints(cs);\r\niniticc(cs);\r\ncs->writeisac(cs, ICC_MASK, 0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_TEST:\r\nreturn(0);\r\n}\r\nreturn(0);\r\n}\r\nstatic int __devinit nju_pci_probe(struct pci_dev *dev_netjet,\r\nstruct IsdnCardState *cs)\r\n{\r\nif (pci_enable_device(dev_netjet))\r\nreturn(0);\r\npci_set_master(dev_netjet);\r\ncs->irq = dev_netjet->irq;\r\nif (!cs->irq) {\r\nprintk(KERN_WARNING "NETspider-U: No IRQ for PCI card found\n");\r\nreturn(0);\r\n}\r\ncs->hw.njet.base = pci_resource_start(dev_netjet, 0);\r\nif (!cs->hw.njet.base) {\r\nprintk(KERN_WARNING "NETspider-U: No IO-Adr for PCI card found\n");\r\nreturn(0);\r\n}\r\nreturn (1);\r\n}\r\nstatic int __devinit nju_cs_init(struct IsdnCard *card,\r\nstruct IsdnCardState *cs)\r\n{\r\ncs->hw.njet.auxa = cs->hw.njet.base + NETJET_AUXDATA;\r\ncs->hw.njet.isac = cs->hw.njet.base | NETJET_ISAC_OFF;\r\nmdelay(10);\r\ncs->hw.njet.ctrl_reg = 0xff;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\ncs->hw.njet.ctrl_reg = 0x00;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\ncs->hw.njet.auxd = 0xC0;\r\ncs->hw.njet.dmactrl = 0;\r\nbyteout(cs->hw.njet.auxa, 0);\r\nbyteout(cs->hw.njet.base + NETJET_AUXCTRL, ~NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.base + NETJET_IRQMASK1, NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.auxa, cs->hw.njet.auxd);\r\nswitch ( ( ( NETjet_ReadIC( cs, ICC_RBCH ) >> 5 ) & 3 ) )\r\n{\r\ncase 3 :\r\nreturn 1;\r\ncase 0 :\r\nprintk( KERN_WARNING "NETspider-U: NETjet-S PCI card found\n" );\r\nreturn -1;\r\ndefault :\r\nprintk( KERN_WARNING "NETspider-U: No PCI card found\n" );\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int __devinit nju_cs_init_rest(struct IsdnCard *card,\r\nstruct IsdnCardState *cs)\r\n{\r\nconst int bytecnt = 256;\r\nprintk(KERN_INFO\r\n"NETspider-U: PCI card configured at %#lx IRQ %d\n",\r\ncs->hw.njet.base, cs->irq);\r\nif (!request_region(cs->hw.njet.base, bytecnt, "netspider-u isdn")) {\r\nprintk(KERN_WARNING\r\n"HiSax: NETspider-U config port %#lx-%#lx "\r\n"already in use\n",\r\ncs->hw.njet.base,\r\ncs->hw.njet.base + bytecnt);\r\nreturn (0);\r\n}\r\nsetup_icc(cs);\r\ncs->readisac = &NETjet_ReadIC;\r\ncs->writeisac = &NETjet_WriteIC;\r\ncs->readisacfifo = &NETjet_ReadICfifo;\r\ncs->writeisacfifo = &NETjet_WriteICfifo;\r\ncs->BC_Read_Reg = &dummyrr;\r\ncs->BC_Write_Reg = &dummywr;\r\ncs->BC_Send_Data = &netjet_fill_dma;\r\ncs->cardmsg = &NETjet_U_card_msg;\r\ncs->irq_func = &netjet_u_interrupt;\r\ncs->irq_flags |= IRQF_SHARED;\r\nICCVersion(cs, "NETspider-U:");\r\nreturn (1);\r\n}\r\nint __devinit\r\nsetup_netjet_u(struct IsdnCard *card)\r\n{\r\nint ret;\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\n#ifdef __BIG_ENDIAN\r\n#error "not running on big endian machines now"\r\n#endif\r\nstrcpy(tmp, NETjet_U_revision);\r\nprintk(KERN_INFO "HiSax: Traverse Tech. NETspider-U driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_NETJET_U)\r\nreturn(0);\r\ntest_and_clear_bit(FLG_LOCK_ATOMIC, &cs->HW_Flags);\r\nfor ( ;; )\r\n{\r\nif ((dev_netjet = hisax_find_pci_device(PCI_VENDOR_ID_TIGERJET,\r\nPCI_DEVICE_ID_TIGERJET_300, dev_netjet))) {\r\nret = nju_pci_probe(dev_netjet, cs);\r\nif (!ret)\r\nreturn(0);\r\n} else {\r\nprintk(KERN_WARNING "NETspider-U: No PCI card found\n");\r\nreturn(0);\r\n}\r\nret = nju_cs_init(card, cs);\r\nif (!ret)\r\nreturn (0);\r\nif (ret > 0)\r\nbreak;\r\n}\r\nreturn nju_cs_init_rest(card, cs);\r\n}

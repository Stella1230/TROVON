static void __devinit plat_ide_setup_ports(struct ide_hw *hw,\r\nvoid __iomem *base,\r\nvoid __iomem *ctrl,\r\nstruct pata_platform_info *pdata,\r\nint irq)\r\n{\r\nunsigned long port = (unsigned long)base;\r\nint i;\r\nhw->io_ports.data_addr = port;\r\nport += (1 << pdata->ioport_shift);\r\nfor (i = 1; i <= 7;\r\ni++, port += (1 << pdata->ioport_shift))\r\nhw->io_ports_array[i] = port;\r\nhw->io_ports.ctl_addr = (unsigned long)ctrl;\r\nhw->irq = irq;\r\n}\r\nstatic int __devinit plat_ide_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res_base, *res_alt, *res_irq;\r\nvoid __iomem *base, *alt_base;\r\nstruct pata_platform_info *pdata;\r\nstruct ide_host *host;\r\nint ret = 0, mmio = 0;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nstruct ide_port_info d = platform_ide_port_info;\r\npdata = pdev->dev.platform_data;\r\nres_base = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nres_alt = platform_get_resource(pdev, IORESOURCE_IO, 1);\r\nif (!res_base || !res_alt) {\r\nres_base = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nres_alt = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res_base || !res_alt) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nmmio = 1;\r\n}\r\nres_irq = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!res_irq) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nif (mmio) {\r\nbase = devm_ioremap(&pdev->dev,\r\nres_base->start, resource_size(res_base));\r\nalt_base = devm_ioremap(&pdev->dev,\r\nres_alt->start, resource_size(res_alt));\r\n} else {\r\nbase = devm_ioport_map(&pdev->dev,\r\nres_base->start, resource_size(res_base));\r\nalt_base = devm_ioport_map(&pdev->dev,\r\nres_alt->start, resource_size(res_alt));\r\n}\r\nmemset(&hw, 0, sizeof(hw));\r\nplat_ide_setup_ports(&hw, base, alt_base, pdata, res_irq->start);\r\nhw.dev = &pdev->dev;\r\nd.irq_flags = res_irq->flags & IRQF_TRIGGER_MASK;\r\nif (res_irq->flags & IORESOURCE_IRQ_SHAREABLE)\r\nd.irq_flags |= IRQF_SHARED;\r\nif (mmio)\r\nd.host_flags |= IDE_HFLAG_MMIO;\r\nret = ide_host_add(&d, hws, 1, &host);\r\nif (ret)\r\ngoto out;\r\nplatform_set_drvdata(pdev, host);\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __devexit plat_ide_remove(struct platform_device *pdev)\r\n{\r\nstruct ide_host *host = dev_get_drvdata(&pdev->dev);\r\nide_host_remove(host);\r\nreturn 0;\r\n}\r\nstatic int __init platform_ide_init(void)\r\n{\r\nreturn platform_driver_register(&platform_ide_driver);\r\n}\r\nstatic void __exit platform_ide_exit(void)\r\n{\r\nplatform_driver_unregister(&platform_ide_driver);\r\n}

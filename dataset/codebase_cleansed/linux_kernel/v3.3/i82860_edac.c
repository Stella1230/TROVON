static void i82860_get_error_info(struct mem_ctl_info *mci,\r\nstruct i82860_error_info *info)\r\n{\r\nstruct pci_dev *pdev;\r\npdev = to_pci_dev(mci->dev);\r\npci_read_config_word(pdev, I82860_ERRSTS, &info->errsts);\r\npci_read_config_dword(pdev, I82860_EAP, &info->eap);\r\npci_read_config_word(pdev, I82860_DERRCTL_STS, &info->derrsyn);\r\npci_read_config_word(pdev, I82860_ERRSTS, &info->errsts2);\r\npci_write_bits16(pdev, I82860_ERRSTS, 0x0003, 0x0003);\r\nif (!(info->errsts2 & 0x0003))\r\nreturn;\r\nif ((info->errsts ^ info->errsts2) & 0x0003) {\r\npci_read_config_dword(pdev, I82860_EAP, &info->eap);\r\npci_read_config_word(pdev, I82860_DERRCTL_STS, &info->derrsyn);\r\n}\r\n}\r\nstatic int i82860_process_error_info(struct mem_ctl_info *mci,\r\nstruct i82860_error_info *info,\r\nint handle_errors)\r\n{\r\nint row;\r\nif (!(info->errsts2 & 0x0003))\r\nreturn 0;\r\nif (!handle_errors)\r\nreturn 1;\r\nif ((info->errsts ^ info->errsts2) & 0x0003) {\r\nedac_mc_handle_ce_no_info(mci, "UE overwrote CE");\r\ninfo->errsts = info->errsts2;\r\n}\r\ninfo->eap >>= PAGE_SHIFT;\r\nrow = edac_mc_find_csrow_by_page(mci, info->eap);\r\nif (info->errsts & 0x0002)\r\nedac_mc_handle_ue(mci, info->eap, 0, row, "i82860 UE");\r\nelse\r\nedac_mc_handle_ce(mci, info->eap, 0, info->derrsyn, row, 0,\r\n"i82860 UE");\r\nreturn 1;\r\n}\r\nstatic void i82860_check(struct mem_ctl_info *mci)\r\n{\r\nstruct i82860_error_info info;\r\ndebugf1("MC%d: %s()\n", mci->mc_idx, __func__);\r\ni82860_get_error_info(mci, &info);\r\ni82860_process_error_info(mci, &info, 1);\r\n}\r\nstatic void i82860_init_csrows(struct mem_ctl_info *mci, struct pci_dev *pdev)\r\n{\r\nunsigned long last_cumul_size;\r\nu16 mchcfg_ddim;\r\nu16 value;\r\nu32 cumul_size;\r\nstruct csrow_info *csrow;\r\nint index;\r\npci_read_config_word(pdev, I82860_MCHCFG, &mchcfg_ddim);\r\nmchcfg_ddim = mchcfg_ddim & 0x180;\r\nlast_cumul_size = 0;\r\nfor (index = 0; index < mci->nr_csrows; index++) {\r\ncsrow = &mci->csrows[index];\r\npci_read_config_word(pdev, I82860_GBA + index * 2, &value);\r\ncumul_size = (value & I82860_GBA_MASK) <<\r\n(I82860_GBA_SHIFT - PAGE_SHIFT);\r\ndebugf3("%s(): (%d) cumul_size 0x%x\n", __func__, index,\r\ncumul_size);\r\nif (cumul_size == last_cumul_size)\r\ncontinue;\r\ncsrow->first_page = last_cumul_size;\r\ncsrow->last_page = cumul_size - 1;\r\ncsrow->nr_pages = cumul_size - last_cumul_size;\r\nlast_cumul_size = cumul_size;\r\ncsrow->grain = 1 << 12;\r\ncsrow->mtype = MEM_RMBS;\r\ncsrow->dtype = DEV_UNKNOWN;\r\ncsrow->edac_mode = mchcfg_ddim ? EDAC_SECDED : EDAC_NONE;\r\n}\r\n}\r\nstatic int i82860_probe1(struct pci_dev *pdev, int dev_idx)\r\n{\r\nstruct mem_ctl_info *mci;\r\nstruct i82860_error_info discard;\r\nmci = edac_mc_alloc(0, 16, 1, 0);\r\nif (!mci)\r\nreturn -ENOMEM;\r\ndebugf3("%s(): init mci\n", __func__);\r\nmci->dev = &pdev->dev;\r\nmci->mtype_cap = MEM_FLAG_DDR;\r\nmci->edac_ctl_cap = EDAC_FLAG_NONE | EDAC_FLAG_SECDED;\r\nmci->edac_cap = EDAC_FLAG_SECDED;\r\nmci->mod_name = EDAC_MOD_STR;\r\nmci->mod_ver = I82860_REVISION;\r\nmci->ctl_name = i82860_devs[dev_idx].ctl_name;\r\nmci->dev_name = pci_name(pdev);\r\nmci->edac_check = i82860_check;\r\nmci->ctl_page_to_phys = NULL;\r\ni82860_init_csrows(mci, pdev);\r\ni82860_get_error_info(mci, &discard);\r\nif (edac_mc_add_mc(mci)) {\r\ndebugf3("%s(): failed edac_mc_add_mc()\n", __func__);\r\ngoto fail;\r\n}\r\ni82860_pci = edac_pci_create_generic_ctl(&pdev->dev, EDAC_MOD_STR);\r\nif (!i82860_pci) {\r\nprintk(KERN_WARNING\r\n"%s(): Unable to create PCI control\n",\r\n__func__);\r\nprintk(KERN_WARNING\r\n"%s(): PCI error report via EDAC not setup\n",\r\n__func__);\r\n}\r\ndebugf3("%s(): success\n", __func__);\r\nreturn 0;\r\nfail:\r\nedac_mc_free(mci);\r\nreturn -ENODEV;\r\n}\r\nstatic int __devinit i82860_init_one(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint rc;\r\ndebugf0("%s()\n", __func__);\r\ni82860_printk(KERN_INFO, "i82860 init one\n");\r\nif (pci_enable_device(pdev) < 0)\r\nreturn -EIO;\r\nrc = i82860_probe1(pdev, ent->driver_data);\r\nif (rc == 0)\r\nmci_pdev = pci_dev_get(pdev);\r\nreturn rc;\r\n}\r\nstatic void __devexit i82860_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct mem_ctl_info *mci;\r\ndebugf0("%s()\n", __func__);\r\nif (i82860_pci)\r\nedac_pci_release_generic_ctl(i82860_pci);\r\nif ((mci = edac_mc_del_mc(&pdev->dev)) == NULL)\r\nreturn;\r\nedac_mc_free(mci);\r\n}\r\nstatic int __init i82860_init(void)\r\n{\r\nint pci_rc;\r\ndebugf3("%s()\n", __func__);\r\nopstate_init();\r\nif ((pci_rc = pci_register_driver(&i82860_driver)) < 0)\r\ngoto fail0;\r\nif (!mci_pdev) {\r\nmci_pdev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_82860_0, NULL);\r\nif (mci_pdev == NULL) {\r\ndebugf0("860 pci_get_device fail\n");\r\npci_rc = -ENODEV;\r\ngoto fail1;\r\n}\r\npci_rc = i82860_init_one(mci_pdev, i82860_pci_tbl);\r\nif (pci_rc < 0) {\r\ndebugf0("860 init fail\n");\r\npci_rc = -ENODEV;\r\ngoto fail1;\r\n}\r\n}\r\nreturn 0;\r\nfail1:\r\npci_unregister_driver(&i82860_driver);\r\nfail0:\r\nif (mci_pdev != NULL)\r\npci_dev_put(mci_pdev);\r\nreturn pci_rc;\r\n}\r\nstatic void __exit i82860_exit(void)\r\n{\r\ndebugf3("%s()\n", __func__);\r\npci_unregister_driver(&i82860_driver);\r\nif (mci_pdev != NULL)\r\npci_dev_put(mci_pdev);\r\n}

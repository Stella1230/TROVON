u32 xfrm_replay_seqhi(struct xfrm_state *x, __be32 net_seq)\r\n{\r\nu32 seq, seq_hi, bottom;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nif (!(x->props.flags & XFRM_STATE_ESN))\r\nreturn 0;\r\nseq = ntohl(net_seq);\r\nseq_hi = replay_esn->seq_hi;\r\nbottom = replay_esn->seq - replay_esn->replay_window + 1;\r\nif (likely(replay_esn->seq >= replay_esn->replay_window - 1)) {\r\nif (unlikely(seq < bottom))\r\nseq_hi++;\r\n} else {\r\nif (unlikely(seq >= bottom))\r\nseq_hi--;\r\n}\r\nreturn seq_hi;\r\n}\r\nstatic void xfrm_replay_notify(struct xfrm_state *x, int event)\r\n{\r\nstruct km_event c;\r\nswitch (event) {\r\ncase XFRM_REPLAY_UPDATE:\r\nif (x->replay_maxdiff &&\r\n(x->replay.seq - x->preplay.seq < x->replay_maxdiff) &&\r\n(x->replay.oseq - x->preplay.oseq < x->replay_maxdiff)) {\r\nif (x->xflags & XFRM_TIME_DEFER)\r\nevent = XFRM_REPLAY_TIMEOUT;\r\nelse\r\nreturn;\r\n}\r\nbreak;\r\ncase XFRM_REPLAY_TIMEOUT:\r\nif (memcmp(&x->replay, &x->preplay,\r\nsizeof(struct xfrm_replay_state)) == 0) {\r\nx->xflags |= XFRM_TIME_DEFER;\r\nreturn;\r\n}\r\nbreak;\r\n}\r\nmemcpy(&x->preplay, &x->replay, sizeof(struct xfrm_replay_state));\r\nc.event = XFRM_MSG_NEWAE;\r\nc.data.aevent = event;\r\nkm_state_notify(x, &c);\r\nif (x->replay_maxage &&\r\n!mod_timer(&x->rtimer, jiffies + x->replay_maxage))\r\nx->xflags &= ~XFRM_TIME_DEFER;\r\n}\r\nstatic int xfrm_replay_overflow(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint err = 0;\r\nstruct net *net = xs_net(x);\r\nif (x->type->flags & XFRM_TYPE_REPLAY_PROT) {\r\nXFRM_SKB_CB(skb)->seq.output.low = ++x->replay.oseq;\r\nif (unlikely(x->replay.oseq == 0)) {\r\nx->replay.oseq--;\r\nxfrm_audit_state_replay_overflow(x, skb);\r\nerr = -EOVERFLOW;\r\nreturn err;\r\n}\r\nif (xfrm_aevent_is_on(net))\r\nx->repl->notify(x, XFRM_REPLAY_UPDATE);\r\n}\r\nreturn err;\r\n}\r\nstatic int xfrm_replay_check(struct xfrm_state *x,\r\nstruct sk_buff *skb, __be32 net_seq)\r\n{\r\nu32 diff;\r\nu32 seq = ntohl(net_seq);\r\nif (!x->props.replay_window)\r\nreturn 0;\r\nif (unlikely(seq == 0))\r\ngoto err;\r\nif (likely(seq > x->replay.seq))\r\nreturn 0;\r\ndiff = x->replay.seq - seq;\r\nif (diff >= min_t(unsigned int, x->props.replay_window,\r\nsizeof(x->replay.bitmap) * 8)) {\r\nx->stats.replay_window++;\r\ngoto err;\r\n}\r\nif (x->replay.bitmap & (1U << diff)) {\r\nx->stats.replay++;\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nxfrm_audit_state_replay(x, skb, net_seq);\r\nreturn -EINVAL;\r\n}\r\nstatic void xfrm_replay_advance(struct xfrm_state *x, __be32 net_seq)\r\n{\r\nu32 diff;\r\nu32 seq = ntohl(net_seq);\r\nif (!x->props.replay_window)\r\nreturn;\r\nif (seq > x->replay.seq) {\r\ndiff = seq - x->replay.seq;\r\nif (diff < x->props.replay_window)\r\nx->replay.bitmap = ((x->replay.bitmap) << diff) | 1;\r\nelse\r\nx->replay.bitmap = 1;\r\nx->replay.seq = seq;\r\n} else {\r\ndiff = x->replay.seq - seq;\r\nx->replay.bitmap |= (1U << diff);\r\n}\r\nif (xfrm_aevent_is_on(xs_net(x)))\r\nxfrm_replay_notify(x, XFRM_REPLAY_UPDATE);\r\n}\r\nstatic int xfrm_replay_overflow_bmp(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint err = 0;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nstruct net *net = xs_net(x);\r\nif (x->type->flags & XFRM_TYPE_REPLAY_PROT) {\r\nXFRM_SKB_CB(skb)->seq.output.low = ++replay_esn->oseq;\r\nif (unlikely(replay_esn->oseq == 0)) {\r\nreplay_esn->oseq--;\r\nxfrm_audit_state_replay_overflow(x, skb);\r\nerr = -EOVERFLOW;\r\nreturn err;\r\n}\r\nif (xfrm_aevent_is_on(net))\r\nx->repl->notify(x, XFRM_REPLAY_UPDATE);\r\n}\r\nreturn err;\r\n}\r\nstatic int xfrm_replay_check_bmp(struct xfrm_state *x,\r\nstruct sk_buff *skb, __be32 net_seq)\r\n{\r\nunsigned int bitnr, nr;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nu32 pos;\r\nu32 seq = ntohl(net_seq);\r\nu32 diff = replay_esn->seq - seq;\r\nif (!replay_esn->replay_window)\r\nreturn 0;\r\nif (unlikely(seq == 0))\r\ngoto err;\r\nif (likely(seq > replay_esn->seq))\r\nreturn 0;\r\nif (diff >= replay_esn->replay_window) {\r\nx->stats.replay_window++;\r\ngoto err;\r\n}\r\npos = (replay_esn->seq - 1) % replay_esn->replay_window;\r\nif (pos >= diff)\r\nbitnr = (pos - diff) % replay_esn->replay_window;\r\nelse\r\nbitnr = replay_esn->replay_window - (diff - pos);\r\nnr = bitnr >> 5;\r\nbitnr = bitnr & 0x1F;\r\nif (replay_esn->bmp[nr] & (1U << bitnr))\r\ngoto err_replay;\r\nreturn 0;\r\nerr_replay:\r\nx->stats.replay++;\r\nerr:\r\nxfrm_audit_state_replay(x, skb, net_seq);\r\nreturn -EINVAL;\r\n}\r\nstatic void xfrm_replay_advance_bmp(struct xfrm_state *x, __be32 net_seq)\r\n{\r\nunsigned int bitnr, nr, i;\r\nu32 diff;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nu32 seq = ntohl(net_seq);\r\nu32 pos = (replay_esn->seq - 1) % replay_esn->replay_window;\r\nif (!replay_esn->replay_window)\r\nreturn;\r\nif (seq > replay_esn->seq) {\r\ndiff = seq - replay_esn->seq;\r\nif (diff < replay_esn->replay_window) {\r\nfor (i = 1; i < diff; i++) {\r\nbitnr = (pos + i) % replay_esn->replay_window;\r\nnr = bitnr >> 5;\r\nbitnr = bitnr & 0x1F;\r\nreplay_esn->bmp[nr] &= ~(1U << bitnr);\r\n}\r\n} else {\r\nnr = (replay_esn->replay_window - 1) >> 5;\r\nfor (i = 0; i <= nr; i++)\r\nreplay_esn->bmp[i] = 0;\r\n}\r\nbitnr = (pos + diff) % replay_esn->replay_window;\r\nreplay_esn->seq = seq;\r\n} else {\r\ndiff = replay_esn->seq - seq;\r\nif (pos >= diff)\r\nbitnr = (pos - diff) % replay_esn->replay_window;\r\nelse\r\nbitnr = replay_esn->replay_window - (diff - pos);\r\n}\r\nnr = bitnr >> 5;\r\nbitnr = bitnr & 0x1F;\r\nreplay_esn->bmp[nr] |= (1U << bitnr);\r\nif (xfrm_aevent_is_on(xs_net(x)))\r\nxfrm_replay_notify(x, XFRM_REPLAY_UPDATE);\r\n}\r\nstatic void xfrm_replay_notify_bmp(struct xfrm_state *x, int event)\r\n{\r\nstruct km_event c;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nstruct xfrm_replay_state_esn *preplay_esn = x->preplay_esn;\r\nswitch (event) {\r\ncase XFRM_REPLAY_UPDATE:\r\nif (x->replay_maxdiff &&\r\n(replay_esn->seq - preplay_esn->seq < x->replay_maxdiff) &&\r\n(replay_esn->oseq - preplay_esn->oseq < x->replay_maxdiff)) {\r\nif (x->xflags & XFRM_TIME_DEFER)\r\nevent = XFRM_REPLAY_TIMEOUT;\r\nelse\r\nreturn;\r\n}\r\nbreak;\r\ncase XFRM_REPLAY_TIMEOUT:\r\nif (memcmp(x->replay_esn, x->preplay_esn,\r\nxfrm_replay_state_esn_len(replay_esn)) == 0) {\r\nx->xflags |= XFRM_TIME_DEFER;\r\nreturn;\r\n}\r\nbreak;\r\n}\r\nmemcpy(x->preplay_esn, x->replay_esn,\r\nxfrm_replay_state_esn_len(replay_esn));\r\nc.event = XFRM_MSG_NEWAE;\r\nc.data.aevent = event;\r\nkm_state_notify(x, &c);\r\nif (x->replay_maxage &&\r\n!mod_timer(&x->rtimer, jiffies + x->replay_maxage))\r\nx->xflags &= ~XFRM_TIME_DEFER;\r\n}\r\nstatic int xfrm_replay_overflow_esn(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint err = 0;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nstruct net *net = xs_net(x);\r\nif (x->type->flags & XFRM_TYPE_REPLAY_PROT) {\r\nXFRM_SKB_CB(skb)->seq.output.low = ++replay_esn->oseq;\r\nXFRM_SKB_CB(skb)->seq.output.hi = replay_esn->oseq_hi;\r\nif (unlikely(replay_esn->oseq == 0)) {\r\nXFRM_SKB_CB(skb)->seq.output.hi = ++replay_esn->oseq_hi;\r\nif (replay_esn->oseq_hi == 0) {\r\nreplay_esn->oseq--;\r\nreplay_esn->oseq_hi--;\r\nxfrm_audit_state_replay_overflow(x, skb);\r\nerr = -EOVERFLOW;\r\nreturn err;\r\n}\r\n}\r\nif (xfrm_aevent_is_on(net))\r\nx->repl->notify(x, XFRM_REPLAY_UPDATE);\r\n}\r\nreturn err;\r\n}\r\nstatic int xfrm_replay_check_esn(struct xfrm_state *x,\r\nstruct sk_buff *skb, __be32 net_seq)\r\n{\r\nunsigned int bitnr, nr;\r\nu32 diff;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nu32 pos;\r\nu32 seq = ntohl(net_seq);\r\nu32 wsize = replay_esn->replay_window;\r\nu32 top = replay_esn->seq;\r\nu32 bottom = top - wsize + 1;\r\nif (!wsize)\r\nreturn 0;\r\nif (unlikely(seq == 0 && replay_esn->seq_hi == 0 &&\r\n(replay_esn->seq < replay_esn->replay_window - 1)))\r\ngoto err;\r\ndiff = top - seq;\r\nif (likely(top >= wsize - 1)) {\r\nif (likely(seq > top) || seq < bottom)\r\nreturn 0;\r\n} else {\r\nif (likely(seq > top && seq < bottom))\r\nreturn 0;\r\nif (seq >= bottom)\r\ndiff = ~seq + top + 1;\r\n}\r\nif (diff >= replay_esn->replay_window) {\r\nx->stats.replay_window++;\r\ngoto err;\r\n}\r\npos = (replay_esn->seq - 1) % replay_esn->replay_window;\r\nif (pos >= diff)\r\nbitnr = (pos - diff) % replay_esn->replay_window;\r\nelse\r\nbitnr = replay_esn->replay_window - (diff - pos);\r\nnr = bitnr >> 5;\r\nbitnr = bitnr & 0x1F;\r\nif (replay_esn->bmp[nr] & (1U << bitnr))\r\ngoto err_replay;\r\nreturn 0;\r\nerr_replay:\r\nx->stats.replay++;\r\nerr:\r\nxfrm_audit_state_replay(x, skb, net_seq);\r\nreturn -EINVAL;\r\n}\r\nstatic void xfrm_replay_advance_esn(struct xfrm_state *x, __be32 net_seq)\r\n{\r\nunsigned int bitnr, nr, i;\r\nint wrap;\r\nu32 diff, pos, seq, seq_hi;\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nif (!replay_esn->replay_window)\r\nreturn;\r\nseq = ntohl(net_seq);\r\npos = (replay_esn->seq - 1) % replay_esn->replay_window;\r\nseq_hi = xfrm_replay_seqhi(x, net_seq);\r\nwrap = seq_hi - replay_esn->seq_hi;\r\nif ((!wrap && seq > replay_esn->seq) || wrap > 0) {\r\nif (likely(!wrap))\r\ndiff = seq - replay_esn->seq;\r\nelse\r\ndiff = ~replay_esn->seq + seq + 1;\r\nif (diff < replay_esn->replay_window) {\r\nfor (i = 1; i < diff; i++) {\r\nbitnr = (pos + i) % replay_esn->replay_window;\r\nnr = bitnr >> 5;\r\nbitnr = bitnr & 0x1F;\r\nreplay_esn->bmp[nr] &= ~(1U << bitnr);\r\n}\r\n} else {\r\nnr = (replay_esn->replay_window - 1) >> 5;\r\nfor (i = 0; i <= nr; i++)\r\nreplay_esn->bmp[i] = 0;\r\n}\r\nbitnr = (pos + diff) % replay_esn->replay_window;\r\nreplay_esn->seq = seq;\r\nif (unlikely(wrap > 0))\r\nreplay_esn->seq_hi++;\r\n} else {\r\ndiff = replay_esn->seq - seq;\r\nif (pos >= diff)\r\nbitnr = (pos - diff) % replay_esn->replay_window;\r\nelse\r\nbitnr = replay_esn->replay_window - (diff - pos);\r\n}\r\nnr = bitnr >> 5;\r\nbitnr = bitnr & 0x1F;\r\nreplay_esn->bmp[nr] |= (1U << bitnr);\r\nif (xfrm_aevent_is_on(xs_net(x)))\r\nxfrm_replay_notify(x, XFRM_REPLAY_UPDATE);\r\n}\r\nint xfrm_init_replay(struct xfrm_state *x)\r\n{\r\nstruct xfrm_replay_state_esn *replay_esn = x->replay_esn;\r\nif (replay_esn) {\r\nif (replay_esn->replay_window >\r\nreplay_esn->bmp_len * sizeof(__u32) * 8)\r\nreturn -EINVAL;\r\nif ((x->props.flags & XFRM_STATE_ESN) && replay_esn->replay_window == 0)\r\nreturn -EINVAL;\r\nif ((x->props.flags & XFRM_STATE_ESN) && x->replay_esn)\r\nx->repl = &xfrm_replay_esn;\r\nelse\r\nx->repl = &xfrm_replay_bmp;\r\n} else\r\nx->repl = &xfrm_replay_legacy;\r\nreturn 0;\r\n}

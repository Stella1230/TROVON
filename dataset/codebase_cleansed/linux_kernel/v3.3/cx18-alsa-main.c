static inline\r\nstruct snd_cx18_card *to_snd_cx18_card(struct v4l2_device *v4l2_dev)\r\n{\r\nreturn to_cx18(v4l2_dev)->alsa;\r\n}\r\nstatic inline\r\nstruct snd_cx18_card *p_to_snd_cx18_card(struct v4l2_device **v4l2_dev)\r\n{\r\nreturn container_of(v4l2_dev, struct snd_cx18_card, v4l2_dev);\r\n}\r\nstatic void snd_cx18_card_free(struct snd_cx18_card *cxsc)\r\n{\r\nif (cxsc == NULL)\r\nreturn;\r\nif (cxsc->v4l2_dev != NULL)\r\nto_cx18(cxsc->v4l2_dev)->alsa = NULL;\r\nkfree(cxsc);\r\n}\r\nstatic void snd_cx18_card_private_free(struct snd_card *sc)\r\n{\r\nif (sc == NULL)\r\nreturn;\r\nsnd_cx18_card_free(sc->private_data);\r\nsc->private_data = NULL;\r\nsc->private_free = NULL;\r\n}\r\nstatic int snd_cx18_card_create(struct v4l2_device *v4l2_dev,\r\nstruct snd_card *sc,\r\nstruct snd_cx18_card **cxsc)\r\n{\r\n*cxsc = kzalloc(sizeof(struct snd_cx18_card), GFP_KERNEL);\r\nif (*cxsc == NULL)\r\nreturn -ENOMEM;\r\n(*cxsc)->v4l2_dev = v4l2_dev;\r\n(*cxsc)->sc = sc;\r\nsc->private_data = *cxsc;\r\nsc->private_free = snd_cx18_card_private_free;\r\nreturn 0;\r\n}\r\nstatic int snd_cx18_card_set_names(struct snd_cx18_card *cxsc)\r\n{\r\nstruct cx18 *cx = to_cx18(cxsc->v4l2_dev);\r\nstruct snd_card *sc = cxsc->sc;\r\nstrlcpy(sc->driver, "CX23418", sizeof(sc->driver));\r\nsnprintf(sc->shortname, sizeof(sc->shortname), "CX18-%d",\r\ncx->instance);\r\nsnprintf(sc->longname, sizeof(sc->longname),\r\n"CX23418 #%d %s TV/FM Radio/Line-In Capture",\r\ncx->instance, cx->card_name);\r\nreturn 0;\r\n}\r\nstatic int snd_cx18_init(struct v4l2_device *v4l2_dev)\r\n{\r\nstruct cx18 *cx = to_cx18(v4l2_dev);\r\nstruct snd_card *sc = NULL;\r\nstruct snd_cx18_card *cxsc;\r\nint ret;\r\nret = snd_card_create(SNDRV_DEFAULT_IDX1,\r\nSNDRV_DEFAULT_STR1,\r\nTHIS_MODULE, 0, &sc);\r\nif (ret) {\r\nCX18_ALSA_ERR("%s: snd_card_create() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit;\r\n}\r\nret = snd_cx18_card_create(v4l2_dev, sc, &cxsc);\r\nif (ret) {\r\nCX18_ALSA_ERR("%s: snd_cx18_card_create() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit_free;\r\n}\r\nsnd_cx18_card_set_names(cxsc);\r\nret = snd_cx18_pcm_create(cxsc);\r\nif (ret) {\r\nCX18_ALSA_ERR("%s: snd_cx18_pcm_create() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit_free;\r\n}\r\ncx->alsa = cxsc;\r\nret = snd_card_register(sc);\r\nif (ret) {\r\ncx->alsa = NULL;\r\nCX18_ALSA_ERR("%s: snd_card_register() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit_free;\r\n}\r\nreturn 0;\r\nerr_exit_free:\r\nif (sc != NULL)\r\nsnd_card_free(sc);\r\nkfree(cxsc);\r\nerr_exit:\r\nreturn ret;\r\n}\r\nint cx18_alsa_load(struct cx18 *cx)\r\n{\r\nstruct v4l2_device *v4l2_dev = &cx->v4l2_dev;\r\nstruct cx18_stream *s;\r\nif (v4l2_dev == NULL) {\r\nprintk(KERN_ERR "cx18-alsa: %s: struct v4l2_device * is NULL\n",\r\n__func__);\r\nreturn 0;\r\n}\r\ncx = to_cx18(v4l2_dev);\r\nif (cx == NULL) {\r\nprintk(KERN_ERR "cx18-alsa cx is NULL\n");\r\nreturn 0;\r\n}\r\ns = &cx->streams[CX18_ENC_STREAM_TYPE_PCM];\r\nif (s->video_dev == NULL) {\r\nCX18_DEBUG_ALSA_INFO("%s: PCM stream for card is disabled - "\r\n"skipping\n", __func__);\r\nreturn 0;\r\n}\r\nif (cx->alsa != NULL) {\r\nCX18_ALSA_ERR("%s: struct snd_cx18_card * already exists\n",\r\n__func__);\r\nreturn 0;\r\n}\r\nif (snd_cx18_init(v4l2_dev)) {\r\nCX18_ALSA_ERR("%s: failed to create struct snd_cx18_card\n",\r\n__func__);\r\n} else {\r\nCX18_DEBUG_ALSA_INFO("%s: created cx18 ALSA interface instance "\r\n"\n", __func__);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init cx18_alsa_init(void)\r\n{\r\nprintk(KERN_INFO "cx18-alsa: module loading...\n");\r\ncx18_ext_init = &cx18_alsa_load;\r\nreturn 0;\r\n}\r\nstatic void __exit snd_cx18_exit(struct snd_cx18_card *cxsc)\r\n{\r\nstruct cx18 *cx = to_cx18(cxsc->v4l2_dev);\r\nsnd_card_free(cxsc->sc);\r\ncx->alsa = NULL;\r\n}\r\nstatic int __exit cx18_alsa_exit_callback(struct device *dev, void *data)\r\n{\r\nstruct v4l2_device *v4l2_dev = dev_get_drvdata(dev);\r\nstruct snd_cx18_card *cxsc;\r\nif (v4l2_dev == NULL) {\r\nprintk(KERN_ERR "cx18-alsa: %s: struct v4l2_device * is NULL\n",\r\n__func__);\r\nreturn 0;\r\n}\r\ncxsc = to_snd_cx18_card(v4l2_dev);\r\nif (cxsc == NULL) {\r\nCX18_ALSA_WARN("%s: struct snd_cx18_card * is NULL\n",\r\n__func__);\r\nreturn 0;\r\n}\r\nsnd_cx18_exit(cxsc);\r\nreturn 0;\r\n}\r\nstatic void __exit cx18_alsa_exit(void)\r\n{\r\nstruct device_driver *drv;\r\nint ret;\r\nprintk(KERN_INFO "cx18-alsa: module unloading...\n");\r\ndrv = driver_find("cx18", &pci_bus_type);\r\nret = driver_for_each_device(drv, NULL, NULL, cx18_alsa_exit_callback);\r\nput_driver(drv);\r\ncx18_ext_init = NULL;\r\nprintk(KERN_INFO "cx18-alsa: module unload complete\n");\r\n}

static inline int clz(unsigned long x)\r\n{\r\n__asm__(\r\n" .set push \n"\r\n" .set mips32 \n"\r\n" clz %0, %1 \n"\r\n" .set pop \n"\r\n: "=r" (x)\r\n: "r" (x));\r\nreturn x;\r\n}\r\nstatic inline unsigned int irq_ffs(unsigned int pending)\r\n{\r\n#if defined(CONFIG_CPU_MIPS32) || defined(CONFIG_CPU_MIPS64)\r\nreturn -clz(pending) + 31 - CAUSEB_IP;\r\n#else\r\nunsigned int a0 = 7;\r\nunsigned int t0;\r\nt0 = s0 & 0xf000;\r\nt0 = t0 < 1;\r\nt0 = t0 << 2;\r\na0 = a0 - t0;\r\ns0 = s0 << t0;\r\nt0 = s0 & 0xc000;\r\nt0 = t0 < 1;\r\nt0 = t0 << 1;\r\na0 = a0 - t0;\r\ns0 = s0 << t0;\r\nt0 = s0 & 0x8000;\r\nt0 = t0 < 1;\r\na0 = a0 - t0;\r\nreturn a0;\r\n#endif\r\n}\r\nasmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned int pending = read_c0_cause() & read_c0_status() & ST0_IM;\r\nint irq;\r\nirq = irq_ffs(pending);\r\nif (irq > 0)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + irq);\r\nelse\r\nspurious_interrupt();\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\nmips_cpu_irq_init();\r\n}

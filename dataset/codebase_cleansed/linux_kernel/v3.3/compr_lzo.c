static void free_workspace(void)\r\n{\r\nvfree(lzo_mem);\r\nvfree(lzo_compress_buf);\r\n}\r\nstatic int __init alloc_workspace(void)\r\n{\r\nlzo_mem = vmalloc(LZO1X_MEM_COMPRESS);\r\nlzo_compress_buf = vmalloc(lzo1x_worst_compress(PAGE_SIZE));\r\nif (!lzo_mem || !lzo_compress_buf) {\r\nprintk(KERN_WARNING "Failed to allocate lzo deflate workspace\n");\r\nfree_workspace();\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int jffs2_lzo_compress(unsigned char *data_in, unsigned char *cpage_out,\r\nuint32_t *sourcelen, uint32_t *dstlen)\r\n{\r\nsize_t compress_size;\r\nint ret;\r\nmutex_lock(&deflate_mutex);\r\nret = lzo1x_1_compress(data_in, *sourcelen, lzo_compress_buf, &compress_size, lzo_mem);\r\nif (ret != LZO_E_OK)\r\ngoto fail;\r\nif (compress_size > *dstlen)\r\ngoto fail;\r\nmemcpy(cpage_out, lzo_compress_buf, compress_size);\r\nmutex_unlock(&deflate_mutex);\r\n*dstlen = compress_size;\r\nreturn 0;\r\nfail:\r\nmutex_unlock(&deflate_mutex);\r\nreturn -1;\r\n}\r\nstatic int jffs2_lzo_decompress(unsigned char *data_in, unsigned char *cpage_out,\r\nuint32_t srclen, uint32_t destlen)\r\n{\r\nsize_t dl = destlen;\r\nint ret;\r\nret = lzo1x_decompress_safe(data_in, srclen, cpage_out, &dl);\r\nif (ret != LZO_E_OK || dl != destlen)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nint __init jffs2_lzo_init(void)\r\n{\r\nint ret;\r\nret = alloc_workspace();\r\nif (ret < 0)\r\nreturn ret;\r\nret = jffs2_register_compressor(&jffs2_lzo_comp);\r\nif (ret)\r\nfree_workspace();\r\nreturn ret;\r\n}\r\nvoid jffs2_lzo_exit(void)\r\n{\r\njffs2_unregister_compressor(&jffs2_lzo_comp);\r\nfree_workspace();\r\n}

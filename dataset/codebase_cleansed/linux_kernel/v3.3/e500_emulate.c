int kvmppc_core_emulate_op(struct kvm_run *run, struct kvm_vcpu *vcpu,\r\nunsigned int inst, int *advance)\r\n{\r\nint emulated = EMULATE_DONE;\r\nint ra;\r\nint rb;\r\nswitch (get_op(inst)) {\r\ncase 31:\r\nswitch (get_xop(inst)) {\r\ncase XOP_TLBRE:\r\nemulated = kvmppc_e500_emul_tlbre(vcpu);\r\nbreak;\r\ncase XOP_TLBWE:\r\nemulated = kvmppc_e500_emul_tlbwe(vcpu);\r\nbreak;\r\ncase XOP_TLBSX:\r\nrb = get_rb(inst);\r\nemulated = kvmppc_e500_emul_tlbsx(vcpu,rb);\r\nbreak;\r\ncase XOP_TLBIVAX:\r\nra = get_ra(inst);\r\nrb = get_rb(inst);\r\nemulated = kvmppc_e500_emul_tlbivax(vcpu, ra, rb);\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nif (emulated == EMULATE_FAIL)\r\nemulated = kvmppc_booke_emulate_op(run, vcpu, inst, advance);\r\nreturn emulated;\r\n}\r\nint kvmppc_core_emulate_mtspr(struct kvm_vcpu *vcpu, int sprn, int rs)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nint emulated = EMULATE_DONE;\r\nulong spr_val = kvmppc_get_gpr(vcpu, rs);\r\nswitch (sprn) {\r\ncase SPRN_PID:\r\nkvmppc_set_pid(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_PID1:\r\nif (spr_val != 0)\r\nreturn EMULATE_FAIL;\r\nvcpu_e500->pid[1] = spr_val; break;\r\ncase SPRN_PID2:\r\nif (spr_val != 0)\r\nreturn EMULATE_FAIL;\r\nvcpu_e500->pid[2] = spr_val; break;\r\ncase SPRN_MAS0:\r\nvcpu_e500->mas0 = spr_val; break;\r\ncase SPRN_MAS1:\r\nvcpu_e500->mas1 = spr_val; break;\r\ncase SPRN_MAS2:\r\nvcpu_e500->mas2 = spr_val; break;\r\ncase SPRN_MAS3:\r\nvcpu_e500->mas3 = spr_val; break;\r\ncase SPRN_MAS4:\r\nvcpu_e500->mas4 = spr_val; break;\r\ncase SPRN_MAS6:\r\nvcpu_e500->mas6 = spr_val; break;\r\ncase SPRN_MAS7:\r\nvcpu_e500->mas7 = spr_val; break;\r\ncase SPRN_L1CSR0:\r\nvcpu_e500->l1csr0 = spr_val;\r\nvcpu_e500->l1csr0 &= ~(L1CSR0_DCFI | L1CSR0_CLFC);\r\nbreak;\r\ncase SPRN_L1CSR1:\r\nvcpu_e500->l1csr1 = spr_val; break;\r\ncase SPRN_HID0:\r\nvcpu_e500->hid0 = spr_val; break;\r\ncase SPRN_HID1:\r\nvcpu_e500->hid1 = spr_val; break;\r\ncase SPRN_MMUCSR0:\r\nemulated = kvmppc_e500_emul_mt_mmucsr0(vcpu_e500,\r\nspr_val);\r\nbreak;\r\ncase SPRN_IVOR32:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_UNAVAIL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR33:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_DATA] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR34:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_ROUND] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR35:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR] = spr_val;\r\nbreak;\r\ndefault:\r\nemulated = kvmppc_booke_emulate_mtspr(vcpu, sprn, rs);\r\n}\r\nreturn emulated;\r\n}\r\nint kvmppc_core_emulate_mfspr(struct kvm_vcpu *vcpu, int sprn, int rt)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nint emulated = EMULATE_DONE;\r\nswitch (sprn) {\r\ncase SPRN_PID:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->pid[0]); break;\r\ncase SPRN_PID1:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->pid[1]); break;\r\ncase SPRN_PID2:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->pid[2]); break;\r\ncase SPRN_MAS0:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->mas0); break;\r\ncase SPRN_MAS1:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->mas1); break;\r\ncase SPRN_MAS2:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->mas2); break;\r\ncase SPRN_MAS3:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->mas3); break;\r\ncase SPRN_MAS4:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->mas4); break;\r\ncase SPRN_MAS6:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->mas6); break;\r\ncase SPRN_MAS7:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->mas7); break;\r\ncase SPRN_TLB0CFG:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->tlb0cfg); break;\r\ncase SPRN_TLB1CFG:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->tlb1cfg); break;\r\ncase SPRN_L1CSR0:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->l1csr0); break;\r\ncase SPRN_L1CSR1:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->l1csr1); break;\r\ncase SPRN_HID0:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->hid0); break;\r\ncase SPRN_HID1:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->hid1); break;\r\ncase SPRN_SVR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu_e500->svr); break;\r\ncase SPRN_MMUCSR0:\r\nkvmppc_set_gpr(vcpu, rt, 0); break;\r\ncase SPRN_MMUCFG:\r\nkvmppc_set_gpr(vcpu, rt, mfspr(SPRN_MMUCFG)); break;\r\ncase SPRN_IVOR32:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_UNAVAIL]);\r\nbreak;\r\ncase SPRN_IVOR33:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_DATA]);\r\nbreak;\r\ncase SPRN_IVOR34:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_ROUND]);\r\nbreak;\r\ncase SPRN_IVOR35:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR]);\r\nbreak;\r\ndefault:\r\nemulated = kvmppc_booke_emulate_mfspr(vcpu, sprn, rt);\r\n}\r\nreturn emulated;\r\n}

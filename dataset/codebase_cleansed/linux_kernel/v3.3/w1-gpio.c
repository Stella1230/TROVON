static void w1_gpio_write_bit_dir(void *data, u8 bit)\r\n{\r\nstruct w1_gpio_platform_data *pdata = data;\r\nif (bit)\r\ngpio_direction_input(pdata->pin);\r\nelse\r\ngpio_direction_output(pdata->pin, 0);\r\n}\r\nstatic void w1_gpio_write_bit_val(void *data, u8 bit)\r\n{\r\nstruct w1_gpio_platform_data *pdata = data;\r\ngpio_set_value(pdata->pin, bit);\r\n}\r\nstatic u8 w1_gpio_read_bit(void *data)\r\n{\r\nstruct w1_gpio_platform_data *pdata = data;\r\nreturn gpio_get_value(pdata->pin) ? 1 : 0;\r\n}\r\nstatic int __init w1_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct w1_bus_master *master;\r\nstruct w1_gpio_platform_data *pdata = pdev->dev.platform_data;\r\nint err;\r\nif (!pdata)\r\nreturn -ENXIO;\r\nmaster = kzalloc(sizeof(struct w1_bus_master), GFP_KERNEL);\r\nif (!master)\r\nreturn -ENOMEM;\r\nerr = gpio_request(pdata->pin, "w1");\r\nif (err)\r\ngoto free_master;\r\nmaster->data = pdata;\r\nmaster->read_bit = w1_gpio_read_bit;\r\nif (pdata->is_open_drain) {\r\ngpio_direction_output(pdata->pin, 1);\r\nmaster->write_bit = w1_gpio_write_bit_val;\r\n} else {\r\ngpio_direction_input(pdata->pin);\r\nmaster->write_bit = w1_gpio_write_bit_dir;\r\n}\r\nerr = w1_add_master_device(master);\r\nif (err)\r\ngoto free_gpio;\r\nif (pdata->enable_external_pullup)\r\npdata->enable_external_pullup(1);\r\nplatform_set_drvdata(pdev, master);\r\nreturn 0;\r\nfree_gpio:\r\ngpio_free(pdata->pin);\r\nfree_master:\r\nkfree(master);\r\nreturn err;\r\n}\r\nstatic int __exit w1_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct w1_bus_master *master = platform_get_drvdata(pdev);\r\nstruct w1_gpio_platform_data *pdata = pdev->dev.platform_data;\r\nif (pdata->enable_external_pullup)\r\npdata->enable_external_pullup(0);\r\nw1_remove_master_device(master);\r\ngpio_free(pdata->pin);\r\nkfree(master);\r\nreturn 0;\r\n}\r\nstatic int w1_gpio_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct w1_gpio_platform_data *pdata = pdev->dev.platform_data;\r\nif (pdata->enable_external_pullup)\r\npdata->enable_external_pullup(0);\r\nreturn 0;\r\n}\r\nstatic int w1_gpio_resume(struct platform_device *pdev)\r\n{\r\nstruct w1_gpio_platform_data *pdata = pdev->dev.platform_data;\r\nif (pdata->enable_external_pullup)\r\npdata->enable_external_pullup(1);\r\nreturn 0;\r\n}\r\nstatic int __init w1_gpio_init(void)\r\n{\r\nreturn platform_driver_probe(&w1_gpio_driver, w1_gpio_probe);\r\n}\r\nstatic void __exit w1_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&w1_gpio_driver);\r\n}

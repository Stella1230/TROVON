static inline bool is_quirk_valid(void)\r\n{\r\nreturn (machine_is(mpc86xx_hpcn) ||\r\nmachine_is(mpc8544_ds) ||\r\nmachine_is(p2020_ds) ||\r\nmachine_is(mpc8572_ds));\r\n}\r\nstatic void __devinit early_uli5249(struct pci_dev *dev)\r\n{\r\nunsigned char temp;\r\nif (!is_quirk_valid())\r\nreturn;\r\npci_write_config_word(dev, PCI_COMMAND, PCI_COMMAND_IO |\r\nPCI_COMMAND_MEMORY | PCI_COMMAND_MASTER);\r\npci_read_config_byte(dev, 0x7c, &temp);\r\npci_write_config_byte(dev, 0x7c, 0x80);\r\npci_write_config_byte(dev, PCI_CLASS_PROG, 0x01);\r\ndev->class |= 0x1;\r\npci_write_config_byte(dev, 0x7c, temp);\r\n}\r\nstatic void __devinit quirk_uli1575(struct pci_dev *dev)\r\n{\r\nint i;\r\nif (!is_quirk_valid())\r\nreturn;\r\nfor (i = 0; i < 4; i++) {\r\nu8 val = uli_pirq_to_irq[i*2] | (uli_pirq_to_irq[i*2+1] << 4);\r\npci_write_config_byte(dev, 0x48 + i, val);\r\n}\r\npci_write_config_byte(dev, 0x86, ULI_PIRQD);\r\npci_write_config_byte(dev, 0x87, ULI_PIRQA);\r\npci_write_config_byte(dev, 0x88, ULI_PIRQB);\r\npci_write_config_byte(dev, 0x89, ULI_PIRQF);\r\npci_write_config_byte(dev, 0x8a, ULI_PIRQF);\r\npci_write_config_byte(dev, 0x8b, ULI_PIRQF);\r\npci_write_config_byte(dev, 0x8c, ULI_PIRQF);\r\npci_write_config_byte(dev, 0x8d, ULI_PIRQE);\r\npci_write_config_byte(dev, 0x8e, ULI_PIRQG);\r\npci_write_config_byte(dev, 0x8f, ULI_PIRQG);\r\npci_write_config_byte(dev, 0x74, ULI_8259_IRQ11);\r\npci_write_config_byte(dev, 0x44, 0x30 | ULI_8259_IRQ14);\r\npci_write_config_byte(dev, 0x75, ULI_8259_IRQ15);\r\n}\r\nstatic void __devinit quirk_final_uli1575(struct pci_dev *dev)\r\n{\r\nif (!is_quirk_valid())\r\nreturn;\r\noutb(0xfa, 0x4d0);\r\noutb(0x1e, 0x4d1);\r\nCMOS_WRITE(RTC_SET, RTC_CONTROL);\r\nCMOS_WRITE(RTC_24H, RTC_CONTROL);\r\nCMOS_WRITE(0, RTC_VALID);\r\noutb_p(0x7c, 0x72);\r\noutb_p(RTC_ALARM_DONT_CARE, 0x73);\r\noutb_p(0x7d, 0x72);\r\noutb_p(RTC_ALARM_DONT_CARE, 0x73);\r\n}\r\nstatic void __devinit quirk_uli5288(struct pci_dev *dev)\r\n{\r\nunsigned char c;\r\nunsigned int d;\r\nif (!is_quirk_valid())\r\nreturn;\r\npci_read_config_byte(dev, 0x83, &c);\r\npci_write_config_byte(dev, 0x83, c|0x80);\r\npci_read_config_dword(dev, PCI_CLASS_REVISION, &d);\r\nd = (d & 0xff) | (PCI_CLASS_STORAGE_SATA_AHCI << 8);\r\npci_write_config_dword(dev, PCI_CLASS_REVISION, d);\r\npci_write_config_byte(dev, 0x83, c);\r\npci_read_config_byte(dev, 0x84, &c);\r\npci_write_config_byte(dev, 0x84, c & ~0x01);\r\n}\r\nstatic void __devinit quirk_uli5229(struct pci_dev *dev)\r\n{\r\nunsigned short temp;\r\nif (!is_quirk_valid())\r\nreturn;\r\npci_write_config_word(dev, PCI_COMMAND, PCI_COMMAND_INTX_DISABLE |\r\nPCI_COMMAND_MASTER | PCI_COMMAND_IO);\r\npci_read_config_word(dev, 0x4a, &temp);\r\npci_write_config_word(dev, 0x4a, temp | 0x1000);\r\n}\r\nstatic void __devinit quirk_final_uli5249(struct pci_dev *dev)\r\n{\r\nint i;\r\nu8 *dummy;\r\nstruct pci_bus *bus = dev->bus;\r\nstruct resource *res;\r\nresource_size_t end = 0;\r\nfor (i = PCI_BRIDGE_RESOURCES; i < PCI_BRIDGE_RESOURCES+3; i++) {\r\nunsigned long flags = pci_resource_flags(dev, i);\r\nif ((flags & (IORESOURCE_MEM|IORESOURCE_PREFETCH)) == IORESOURCE_MEM)\r\nend = pci_resource_end(dev, i);\r\n}\r\npci_bus_for_each_resource(bus, res, i) {\r\nif (res && res->flags & IORESOURCE_MEM) {\r\nif (res->end == end)\r\ndummy = ioremap(res->start, 0x4);\r\nelse\r\ndummy = ioremap(res->end - 3, 0x4);\r\nif (dummy) {\r\nin_8(dummy);\r\niounmap(dummy);\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void __devinit hpcd_quirk_uli1575(struct pci_dev *dev)\r\n{\r\nu32 temp32;\r\nif (!machine_is(mpc86xx_hpcd))\r\nreturn;\r\npci_read_config_dword(dev, 0x48, &temp32);\r\npci_write_config_dword(dev, 0x48, (temp32 | 1<<26));\r\npci_read_config_dword(dev, 0x90, &temp32);\r\npci_write_config_dword(dev, 0x90, (temp32 | 1<<22));\r\n}\r\nstatic void __devinit hpcd_quirk_uli5288(struct pci_dev *dev)\r\n{\r\nunsigned char c;\r\nif (!machine_is(mpc86xx_hpcd))\r\nreturn;\r\npci_read_config_byte(dev, 0x83, &c);\r\nc |= 0x80;\r\npci_write_config_byte(dev, 0x83, c);\r\npci_write_config_byte(dev, PCI_CLASS_PROG, 0x01);\r\npci_write_config_byte(dev, PCI_CLASS_DEVICE, 0x06);\r\npci_read_config_byte(dev, 0x83, &c);\r\nc &= 0x7f;\r\npci_write_config_byte(dev, 0x83, c);\r\n}\r\nstatic void __devinit hpcd_quirk_uli5229(struct pci_dev *dev)\r\n{\r\nunsigned char c;\r\nif (!machine_is(mpc86xx_hpcd))\r\nreturn;\r\npci_read_config_byte(dev, 0x4b, &c);\r\nc |= 0x10;\r\npci_write_config_byte(dev, 0x4b, c);\r\n}\r\nstatic void __devinit hpcd_final_uli5288(struct pci_dev *dev)\r\n{\r\nstruct pci_controller *hose = pci_bus_to_host(dev->bus);\r\nstruct device_node *hosenode = hose ? hose->dn : NULL;\r\nstruct of_irq oirq;\r\nint virq, pin = 2;\r\nu32 laddr[3];\r\nif (!machine_is(mpc86xx_hpcd))\r\nreturn;\r\nif (!hosenode)\r\nreturn;\r\nladdr[0] = (hose->first_busno << 16) | (PCI_DEVFN(31, 0) << 8);\r\nladdr[1] = laddr[2] = 0;\r\nof_irq_map_raw(hosenode, &pin, 1, laddr, &oirq);\r\nvirq = irq_create_of_mapping(oirq.controller, oirq.specifier,\r\noirq.size);\r\ndev->irq = virq;\r\n}\r\nint uli_exclude_device(struct pci_controller *hose,\r\nu_char bus, u_char devfn)\r\n{\r\nif (bus == (hose->first_busno + 2)) {\r\nif ((PCI_SLOT(devfn) == 29) && (PCI_FUNC(devfn) == 1))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif ((PCI_SLOT(devfn) == 29) && (PCI_FUNC(devfn) == 2))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

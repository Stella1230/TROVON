static void wpadev_setup(struct net_device *dev)\r\n{\r\ndev->type = ARPHRD_IEEE80211;\r\ndev->hard_header_len = ETH_HLEN;\r\ndev->mtu = 2048;\r\ndev->addr_len = ETH_ALEN;\r\ndev->tx_queue_len = 1000;\r\nmemset(dev->broadcast,0xFF, ETH_ALEN);\r\ndev->flags = IFF_BROADCAST|IFF_MULTICAST;\r\n}\r\nstatic int wpa_init_wpadev(PSDevice pDevice)\r\n{\r\nPSDevice wpadev_priv;\r\nstruct net_device *dev = pDevice->dev;\r\nint ret=0;\r\npDevice->wpadev = alloc_netdev(sizeof(PSDevice), "vntwpa", wpadev_setup);\r\nif (pDevice->wpadev == NULL)\r\nreturn -ENOMEM;\r\nwpadev_priv = netdev_priv(pDevice->wpadev);\r\n*wpadev_priv = *pDevice;\r\nmemcpy(pDevice->wpadev->dev_addr, dev->dev_addr, ETH_ALEN);\r\npDevice->wpadev->base_addr = dev->base_addr;\r\npDevice->wpadev->irq = dev->irq;\r\npDevice->wpadev->mem_start = dev->mem_start;\r\npDevice->wpadev->mem_end = dev->mem_end;\r\nret = register_netdev(pDevice->wpadev);\r\nif (ret) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "%s: register_netdev(WPA) failed!\n",\r\ndev->name);\r\nfree_netdev(pDevice->wpadev);\r\nreturn -1;\r\n}\r\nif (pDevice->skb == NULL) {\r\npDevice->skb = dev_alloc_skb((int)pDevice->rx_buf_sz);\r\nif (pDevice->skb == NULL)\r\nreturn -ENOMEM;\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "%s: Registered netdev %s for WPA management\n",\r\ndev->name, pDevice->wpadev->name);\r\nreturn 0;\r\n}\r\nstatic int wpa_release_wpadev(PSDevice pDevice)\r\n{\r\nif (pDevice->skb) {\r\ndev_kfree_skb(pDevice->skb);\r\npDevice->skb = NULL;\r\n}\r\nif (pDevice->wpadev) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "%s: Netdevice %s unregistered\n",\r\npDevice->dev->name, pDevice->wpadev->name);\r\nunregister_netdev(pDevice->wpadev);\r\nfree_netdev(pDevice->wpadev);\r\npDevice->wpadev = NULL;\r\n}\r\nreturn 0;\r\n}\r\nint wpa_set_wpadev(PSDevice pDevice, int val)\r\n{\r\nif (val)\r\nreturn wpa_init_wpadev(pDevice);\r\nelse\r\nreturn wpa_release_wpadev(pDevice);\r\n}\r\nint wpa_set_keys(PSDevice pDevice, void *ctx, BOOL fcpfkernel)\r\n{\r\nstruct viawget_wpa_param *param=ctx;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nDWORD dwKeyIndex = 0;\r\nBYTE abyKey[MAX_KEY_LEN];\r\nBYTE abySeq[MAX_KEY_LEN];\r\nQWORD KeyRSC;\r\nBYTE byKeyDecMode = KEY_CTL_WEP;\r\nint ret = 0;\r\nint uu, ii;\r\nif (param->u.wpa_key.alg_name > WPA_ALG_CCMP)\r\nreturn -EINVAL;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "param->u.wpa_key.alg_name = %d \n", param->u.wpa_key.alg_name);\r\nif (param->u.wpa_key.alg_name == WPA_ALG_NONE) {\r\npDevice->eEncryptionStatus = Ndis802_11EncryptionDisabled;\r\npDevice->bEncryptionEnable = FALSE;\r\npDevice->byKeyIndex = 0;\r\npDevice->bTransmitKey = FALSE;\r\nfor (uu=0; uu<MAX_KEY_TABLE; uu++) {\r\nMACvDisableKeyEntry(pDevice, uu);\r\n}\r\nreturn ret;\r\n}\r\nif (param->u.wpa_key.key && param->u.wpa_key.key_len > sizeof(abyKey))\r\nreturn -EINVAL;\r\nspin_unlock_irq(&pDevice->lock);\r\nif(param->u.wpa_key.key && fcpfkernel) {\r\nmemcpy(&abyKey[0], param->u.wpa_key.key, param->u.wpa_key.key_len);\r\n}\r\nelse {\r\nif (param->u.wpa_key.key &&\r\ncopy_from_user(&abyKey[0], param->u.wpa_key.key, param->u.wpa_key.key_len)) {\r\nspin_lock_irq(&pDevice->lock);\r\nreturn -EINVAL;\r\n}\r\n}\r\nspin_lock_irq(&pDevice->lock);\r\ndwKeyIndex = (DWORD)(param->u.wpa_key.key_index);\r\nif (param->u.wpa_key.alg_name == WPA_ALG_WEP) {\r\nif (dwKeyIndex > 3) {\r\nreturn -EINVAL;\r\n}\r\nelse {\r\nif (param->u.wpa_key.set_tx) {\r\npDevice->byKeyIndex = (BYTE)dwKeyIndex;\r\npDevice->bTransmitKey = TRUE;\r\ndwKeyIndex |= (1 << 31);\r\n}\r\nKeybSetDefaultKey( pDevice,\r\n&(pDevice->sKey),\r\ndwKeyIndex & ~(BIT30 | USE_KEYRSC),\r\nparam->u.wpa_key.key_len,\r\nNULL,\r\nabyKey,\r\nKEY_CTL_WEP\r\n);\r\n}\r\npDevice->eEncryptionStatus = Ndis802_11Encryption1Enabled;\r\npDevice->bEncryptionEnable = TRUE;\r\nreturn ret;\r\n}\r\nif (param->u.wpa_key.seq && param->u.wpa_key.seq_len > sizeof(abySeq))\r\nreturn -EINVAL;\r\nspin_unlock_irq(&pDevice->lock);\r\nif(param->u.wpa_key.seq && fcpfkernel) {\r\nmemcpy(&abySeq[0], param->u.wpa_key.seq, param->u.wpa_key.seq_len);\r\n}\r\nelse {\r\nif (param->u.wpa_key.seq &&\r\ncopy_from_user(&abySeq[0], param->u.wpa_key.seq, param->u.wpa_key.seq_len)) {\r\nspin_lock_irq(&pDevice->lock);\r\nreturn -EINVAL;\r\n}\r\n}\r\nspin_lock_irq(&pDevice->lock);\r\nif (param->u.wpa_key.seq_len > 0) {\r\nfor (ii = 0 ; ii < param->u.wpa_key.seq_len ; ii++) {\r\nif (ii < 4)\r\nLODWORD(KeyRSC) |= (abySeq[ii] << (ii * 8));\r\nelse\r\nHIDWORD(KeyRSC) |= (abySeq[ii] << ((ii-4) * 8));\r\n}\r\ndwKeyIndex |= 1 << 29;\r\n}\r\nif (param->u.wpa_key.key_index >= MAX_GROUP_KEY) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "return dwKeyIndex > 3\n");\r\nreturn -EINVAL;\r\n}\r\nif (param->u.wpa_key.alg_name == WPA_ALG_TKIP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption2Enabled;\r\n}\r\nif (param->u.wpa_key.alg_name == WPA_ALG_CCMP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption3Enabled;\r\n}\r\nif (param->u.wpa_key.set_tx)\r\ndwKeyIndex |= (1 << 31);\r\nif (pDevice->eEncryptionStatus == Ndis802_11Encryption3Enabled)\r\nbyKeyDecMode = KEY_CTL_CCMP;\r\nelse if (pDevice->eEncryptionStatus == Ndis802_11Encryption2Enabled)\r\nbyKeyDecMode = KEY_CTL_TKIP;\r\nelse\r\nbyKeyDecMode = KEY_CTL_WEP;\r\nif (pDevice->eEncryptionStatus == Ndis802_11Encryption3Enabled) {\r\nif (param->u.wpa_key.key_len == MAX_KEY_LEN)\r\nbyKeyDecMode = KEY_CTL_TKIP;\r\nelse if (param->u.wpa_key.key_len == WLAN_WEP40_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\nelse if (param->u.wpa_key.key_len == WLAN_WEP104_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\n} else if (pDevice->eEncryptionStatus == Ndis802_11Encryption2Enabled) {\r\nif (param->u.wpa_key.key_len == WLAN_WEP40_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\nelse if (param->u.wpa_key.key_len == WLAN_WEP104_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\n}\r\nif ((byKeyDecMode == KEY_CTL_TKIP) &&\r\n(param->u.wpa_key.key_len != MAX_KEY_LEN)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "return- TKIP Key must be 256 bits!\n");\r\nreturn -EINVAL;\r\n}\r\nif ((byKeyDecMode == KEY_CTL_CCMP) &&\r\n(param->u.wpa_key.key_len != AES_KEY_LEN)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "return - AES Key must be 128 bits\n");\r\nreturn -EINVAL;\r\n}\r\nif (is_broadcast_ether_addr(&param->addr[0]) || (param->addr == NULL)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Groupe Key Assign.\n");\r\nif ((KeybSetAllGroupKey(pDevice,\r\n&(pDevice->sKey),\r\ndwKeyIndex,\r\nparam->u.wpa_key.key_len,\r\n(PQWORD) &(KeyRSC),\r\n(PBYTE)abyKey,\r\nbyKeyDecMode\r\n) == TRUE) &&\r\n(KeybSetDefaultKey(pDevice,\r\n&(pDevice->sKey),\r\ndwKeyIndex,\r\nparam->u.wpa_key.key_len,\r\n(PQWORD) &(KeyRSC),\r\n(PBYTE)abyKey,\r\nbyKeyDecMode\r\n) == TRUE) ) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "GROUP Key Assign.\n");\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Pairwise Key Assign.\n");\r\nif (byKeyDecMode == KEY_CTL_WEP) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Pairwise Key can't be WEP\n");\r\nreturn -EINVAL;\r\n}\r\ndwKeyIndex |= (1 << 30);\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA) {\r\nreturn -EINVAL;\r\n}\r\nif (KeybSetKey(pDevice,\r\n&(pDevice->sKey),\r\n&param->addr[0],\r\ndwKeyIndex,\r\nparam->u.wpa_key.key_len,\r\n(PQWORD) &(KeyRSC),\r\n(PBYTE)abyKey,\r\nbyKeyDecMode\r\n) == TRUE) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Pairwise Key Set\n");\r\n} else {\r\nif (!compare_ether_addr(&param->addr[0], pDevice->abyBSSID)) {\r\nreturn -EINVAL;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\n}\r\nif ((ret == 0) && ((param->u.wpa_key.set_tx) != 0)) {\r\npDevice->byKeyIndex = (BYTE)param->u.wpa_key.key_index;\r\npDevice->bTransmitKey = TRUE;\r\n}\r\npDevice->bEncryptionEnable = TRUE;\r\nreturn ret;\r\n}\r\nstatic int wpa_set_wpa(PSDevice pDevice,\r\nstruct viawget_wpa_param *param)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nint ret = 0;\r\npMgmt->eAuthenMode = WMAC_AUTH_OPEN;\r\npMgmt->bShareKeyAlgorithm = FALSE;\r\nreturn ret;\r\n}\r\nstatic int wpa_set_disassociate(PSDevice pDevice,\r\nstruct viawget_wpa_param *param)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nint ret = 0;\r\nspin_lock_irq(&pDevice->lock);\r\nif (pDevice->bLinkPass) {\r\nif (!memcmp(param->addr, pMgmt->abyCurrBSSID, 6))\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_DISASSOCIATE, NULL);\r\n}\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn ret;\r\n}\r\nstatic int wpa_set_scan(PSDevice pDevice,\r\nstruct viawget_wpa_param *param)\r\n{\r\nint ret = 0;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nPWLAN_IE_SSID pItemSSID;\r\nprintk("wpa_set_scan-->desired [ssid=%s,ssid_len=%d]\n",\r\nparam->u.scan_req.ssid,param->u.scan_req.ssid_len);\r\nmemset(pMgmt->abyDesireSSID, 0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyDesireSSID;\r\npItemSSID->byElementID = WLAN_EID_SSID;\r\nmemcpy(pItemSSID->abySSID, param->u.scan_req.ssid, param->u.scan_req.ssid_len);\r\npItemSSID->len = param->u.scan_req.ssid_len;\r\nspin_lock_irq(&pDevice->lock);\r\nBSSvClearBSSList((void *) pDevice, pDevice->bLinkPass);\r\nbScheduleCommand((void *) pDevice,\r\nWLAN_CMD_BSSID_SCAN,\r\npMgmt->abyDesireSSID);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn ret;\r\n}\r\nstatic int wpa_get_bssid(PSDevice pDevice,\r\nstruct viawget_wpa_param *param)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nint ret = 0;\r\nmemcpy(param->u.wpa_associate.bssid, pMgmt->abyCurrBSSID , 6);\r\nreturn ret;\r\n}\r\nstatic int wpa_get_ssid(PSDevice pDevice,\r\nstruct viawget_wpa_param *param)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nPWLAN_IE_SSID pItemSSID;\r\nint ret = 0;\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyCurrSSID;\r\nmemcpy(param->u.wpa_associate.ssid, pItemSSID->abySSID , pItemSSID->len);\r\nparam->u.wpa_associate.ssid_len = pItemSSID->len;\r\nreturn ret;\r\n}\r\nstatic int wpa_get_scan(PSDevice pDevice,\r\nstruct viawget_wpa_param *param)\r\n{\r\nstruct viawget_scan_result *scan_buf;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nPWLAN_IE_SSID pItemSSID;\r\nPKnownBSS pBSS;\r\nPBYTE pBuf;\r\nint ret = 0;\r\nu16 count = 0;\r\nu16 ii, jj;\r\nlong ldBm;\r\nPBYTE ptempBSS;\r\nptempBSS = kmalloc(sizeof(KnownBSS), (int)GFP_ATOMIC);\r\nif (ptempBSS == NULL) {\r\nprintk("bubble sort kmalloc memory fail@@@\n");\r\nret = -ENOMEM;\r\nreturn ret;\r\n}\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\nfor (jj = 0; jj < MAX_BSS_NUM - ii - 1; jj++) {\r\nif ((pMgmt->sBSSList[jj].bActive != TRUE) ||\r\n((pMgmt->sBSSList[jj].uRSSI>pMgmt->sBSSList[jj+1].uRSSI) &&(pMgmt->sBSSList[jj+1].bActive!=FALSE))) {\r\nmemcpy(ptempBSS,&pMgmt->sBSSList[jj],sizeof(KnownBSS));\r\nmemcpy(&pMgmt->sBSSList[jj],&pMgmt->sBSSList[jj+1],sizeof(KnownBSS));\r\nmemcpy(&pMgmt->sBSSList[jj+1],ptempBSS,sizeof(KnownBSS));\r\n}\r\n}\r\n}\r\nkfree(ptempBSS);\r\ncount = 0;\r\npBSS = &(pMgmt->sBSSList[0]);\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\npBSS = &(pMgmt->sBSSList[ii]);\r\nif (!pBSS->bActive)\r\ncontinue;\r\ncount++;\r\n}\r\npBuf = kcalloc(count, sizeof(struct viawget_scan_result), (int)GFP_ATOMIC);\r\nif (pBuf == NULL) {\r\nret = -ENOMEM;\r\nreturn ret;\r\n}\r\nscan_buf = (struct viawget_scan_result *)pBuf;\r\npBSS = &(pMgmt->sBSSList[0]);\r\nfor (ii = 0, jj = 0; ii < MAX_BSS_NUM ; ii++) {\r\npBSS = &(pMgmt->sBSSList[ii]);\r\nif (pBSS->bActive) {\r\nif (jj >= count)\r\nbreak;\r\nmemcpy(scan_buf->bssid, pBSS->abyBSSID, WLAN_BSSID_LEN);\r\npItemSSID = (PWLAN_IE_SSID)pBSS->abySSID;\r\nmemcpy(scan_buf->ssid, pItemSSID->abySSID, pItemSSID->len);\r\nscan_buf->ssid_len = pItemSSID->len;\r\nscan_buf->freq = frequency_list[pBSS->uChannel-1];\r\nscan_buf->caps = pBSS->wCapInfo;\r\nRFvRSSITodBm(pDevice, (BYTE)(pBSS->uRSSI), &ldBm);\r\nif(-ldBm<50){\r\nscan_buf->qual = 100;\r\n}else if(-ldBm > 90) {\r\nscan_buf->qual = 0;\r\n}else {\r\nscan_buf->qual=(40-(-ldBm-50))*100/40;\r\n}\r\nscan_buf->noise = 0;\r\nscan_buf->level = ldBm;\r\nif (pBSS->wWPALen != 0) {\r\nscan_buf->wpa_ie_len = pBSS->wWPALen;\r\nmemcpy(scan_buf->wpa_ie, pBSS->byWPAIE, pBSS->wWPALen);\r\n}\r\nif (pBSS->wRSNLen != 0) {\r\nscan_buf->rsn_ie_len = pBSS->wRSNLen;\r\nmemcpy(scan_buf->rsn_ie, pBSS->byRSNIE, pBSS->wRSNLen);\r\n}\r\nscan_buf = (struct viawget_scan_result *)((PBYTE)scan_buf + sizeof(struct viawget_scan_result));\r\njj ++;\r\n}\r\n}\r\nif (jj < count)\r\ncount = jj;\r\nif (copy_to_user(param->u.scan_results.buf, pBuf, sizeof(struct viawget_scan_result) * count)) {\r\nret = -EFAULT;\r\n}\r\nparam->u.scan_results.scan_count = count;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " param->u.scan_results.scan_count = %d\n", count)\r\nkfree(pBuf);\r\nreturn ret;\r\n}\r\nstatic int wpa_set_associate(PSDevice pDevice,\r\nstruct viawget_wpa_param *param)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nPWLAN_IE_SSID pItemSSID;\r\nBYTE abyNullAddr[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00};\r\nBYTE abyWPAIE[64];\r\nint ret = 0;\r\nBOOL bwepEnabled=FALSE;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "pairwise_suite = %d\n", param->u.wpa_associate.pairwise_suite);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "group_suite = %d\n", param->u.wpa_associate.group_suite);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "key_mgmt_suite = %d\n", param->u.wpa_associate.key_mgmt_suite);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "auth_alg = %d\n", param->u.wpa_associate.auth_alg);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "mode = %d\n", param->u.wpa_associate.mode);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wpa_ie_len = %d\n", param->u.wpa_associate.wpa_ie_len);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Roaming dBm = %d\n", param->u.wpa_associate.roam_dbm);\r\nif (param->u.wpa_associate.wpa_ie) {\r\nif (param->u.wpa_associate.wpa_ie_len > sizeof(abyWPAIE))\r\nreturn -EINVAL;\r\nif (copy_from_user(&abyWPAIE[0], param->u.wpa_associate.wpa_ie,\r\nparam->u.wpa_associate.wpa_ie_len))\r\nreturn -EFAULT;\r\n}\r\nif (param->u.wpa_associate.mode == 1)\r\npMgmt->eConfigMode = WMAC_CONFIG_IBSS_STA;\r\nelse\r\npMgmt->eConfigMode = WMAC_CONFIG_ESS_STA;\r\nif (memcmp(param->u.wpa_associate.bssid, &abyNullAddr[0], 6) != 0)\r\nmemcpy(pMgmt->abyDesireBSSID, param->u.wpa_associate.bssid, 6);\r\nmemset(pMgmt->abyDesireSSID, 0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyDesireSSID;\r\npItemSSID->byElementID = WLAN_EID_SSID;\r\npItemSSID->len = param->u.wpa_associate.ssid_len;\r\nmemcpy(pItemSSID->abySSID, param->u.wpa_associate.ssid, pItemSSID->len);\r\nif (param->u.wpa_associate.wpa_ie_len == 0) {\r\nif (param->u.wpa_associate.auth_alg & AUTH_ALG_SHARED_KEY)\r\npMgmt->eAuthenMode = WMAC_AUTH_SHAREKEY;\r\nelse\r\npMgmt->eAuthenMode = WMAC_AUTH_OPEN;\r\n} else if (abyWPAIE[0] == RSN_INFO_ELEM) {\r\nif (param->u.wpa_associate.key_mgmt_suite == KEY_MGMT_PSK)\r\npMgmt->eAuthenMode = WMAC_AUTH_WPA2PSK;\r\nelse\r\npMgmt->eAuthenMode = WMAC_AUTH_WPA2;\r\n} else {\r\nif (param->u.wpa_associate.key_mgmt_suite == KEY_MGMT_WPA_NONE)\r\npMgmt->eAuthenMode = WMAC_AUTH_WPANONE;\r\nelse if (param->u.wpa_associate.key_mgmt_suite == KEY_MGMT_PSK)\r\npMgmt->eAuthenMode = WMAC_AUTH_WPAPSK;\r\nelse\r\npMgmt->eAuthenMode = WMAC_AUTH_WPA;\r\n}\r\nswitch (param->u.wpa_associate.pairwise_suite) {\r\ncase CIPHER_CCMP:\r\npDevice->eEncryptionStatus = Ndis802_11Encryption3Enabled;\r\nbreak;\r\ncase CIPHER_TKIP:\r\npDevice->eEncryptionStatus = Ndis802_11Encryption2Enabled;\r\nbreak;\r\ncase CIPHER_WEP40:\r\ncase CIPHER_WEP104:\r\npDevice->eEncryptionStatus = Ndis802_11Encryption1Enabled;\r\nbwepEnabled = TRUE;\r\nbreak;\r\ncase CIPHER_NONE:\r\nif (param->u.wpa_associate.group_suite == CIPHER_CCMP)\r\npDevice->eEncryptionStatus = Ndis802_11Encryption3Enabled;\r\nelse\r\npDevice->eEncryptionStatus = Ndis802_11Encryption2Enabled;\r\nbreak;\r\ndefault:\r\npDevice->eEncryptionStatus = Ndis802_11EncryptionDisabled;\r\n}\r\npMgmt->Roam_dbm = param->u.wpa_associate.roam_dbm;\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_SHAREKEY) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption1Enabled;\r\npMgmt->bShareKeyAlgorithm = TRUE;\r\n}\r\nelse if (pMgmt->eAuthenMode == WMAC_AUTH_OPEN) {\r\nif(bwepEnabled==TRUE) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption1Enabled;\r\n}\r\nelse {\r\npDevice->eEncryptionStatus = Ndis802_11EncryptionDisabled;\r\n}\r\n}\r\npDevice->eOldEncryptionStatus = pDevice->eEncryptionStatus;\r\nif (pDevice->eEncryptionStatus != Ndis802_11EncryptionDisabled)\r\npDevice->bEncryptionEnable = TRUE;\r\nelse\r\npDevice->bEncryptionEnable = FALSE;\r\nif ((pMgmt->eAuthenMode == WMAC_AUTH_SHAREKEY) ||\r\n((pMgmt->eAuthenMode == WMAC_AUTH_OPEN) && (bwepEnabled==TRUE))) {\r\n}\r\nelse\r\nKeyvInitTable(pDevice,&pDevice->sKey);\r\nspin_lock_irq(&pDevice->lock);\r\npDevice->bLinkPass = FALSE;\r\nControlvMaskByte(pDevice,MESSAGE_REQUEST_MACREG,MAC_REG_PAPEDELAY,LEDSTS_STS,LEDSTS_SLOW);\r\nmemset(pMgmt->abyCurrBSSID, 0, 6);\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\nnetif_stop_queue(pDevice->dev);\r\n{\r\nPKnownBSS pCurr = NULL;\r\npCurr = BSSpSearchBSSList(pDevice,\r\npMgmt->abyDesireBSSID,\r\npMgmt->abyDesireSSID,\r\npDevice->eConfigPHYMode\r\n);\r\nif (pCurr == NULL){\r\nprintk("wpa_set_associate---->hidden mode site survey before associate.......\n");\r\nbScheduleCommand((void *) pDevice,\r\nWLAN_CMD_BSSID_SCAN,\r\npMgmt->abyDesireSSID);\r\n}\r\n}\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_SSID, NULL);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn ret;\r\n}\r\nint wpa_ioctl(PSDevice pDevice, struct iw_point *p)\r\n{\r\nstruct viawget_wpa_param *param;\r\nint ret = 0;\r\nint wpa_ioctl = 0;\r\nif (p->length < sizeof(struct viawget_wpa_param) ||\r\np->length > VIAWGET_WPA_MAX_BUF_SIZE || !p->pointer)\r\nreturn -EINVAL;\r\nparam = kmalloc((int)p->length, (int)GFP_KERNEL);\r\nif (param == NULL)\r\nreturn -ENOMEM;\r\nif (copy_from_user(param, p->pointer, p->length)) {\r\nret = -EFAULT;\r\ngoto out;\r\n}\r\nswitch (param->cmd) {\r\ncase VIAWGET_SET_WPA:\r\nret = wpa_set_wpa(pDevice, param);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_SET_WPA \n");\r\nbreak;\r\ncase VIAWGET_SET_KEY:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_SET_KEY \n");\r\nspin_lock_irq(&pDevice->lock);\r\nret = wpa_set_keys(pDevice, param, FALSE);\r\nspin_unlock_irq(&pDevice->lock);\r\nbreak;\r\ncase VIAWGET_SET_SCAN:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_SET_SCAN \n");\r\nret = wpa_set_scan(pDevice, param);\r\nbreak;\r\ncase VIAWGET_GET_SCAN:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_GET_SCAN\n");\r\nret = wpa_get_scan(pDevice, param);\r\nwpa_ioctl = 1;\r\nbreak;\r\ncase VIAWGET_GET_SSID:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_GET_SSID \n");\r\nret = wpa_get_ssid(pDevice, param);\r\nwpa_ioctl = 1;\r\nbreak;\r\ncase VIAWGET_GET_BSSID:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_GET_BSSID \n");\r\nret = wpa_get_bssid(pDevice, param);\r\nwpa_ioctl = 1;\r\nbreak;\r\ncase VIAWGET_SET_ASSOCIATE:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_SET_ASSOCIATE \n");\r\nret = wpa_set_associate(pDevice, param);\r\nbreak;\r\ncase VIAWGET_SET_DISASSOCIATE:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_SET_DISASSOCIATE \n");\r\nret = wpa_set_disassociate(pDevice, param);\r\nbreak;\r\ncase VIAWGET_SET_DROP_UNENCRYPT:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_SET_DROP_UNENCRYPT \n");\r\nbreak;\r\ncase VIAWGET_SET_DEAUTHENTICATE:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "VIAWGET_SET_DEAUTHENTICATE \n");\r\nbreak;\r\ndefault:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wpa_ioctl: unknown cmd=%d\n",\r\nparam->cmd);\r\nreturn -EOPNOTSUPP;\r\nbreak;\r\n}\r\nif ((ret == 0) && wpa_ioctl) {\r\nif (copy_to_user(p->pointer, param, p->length)) {\r\nret = -EFAULT;\r\ngoto out;\r\n}\r\n}\r\nout:\r\nkfree(param);\r\nreturn ret;\r\n}

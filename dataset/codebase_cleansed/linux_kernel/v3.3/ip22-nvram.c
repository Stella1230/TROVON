static inline void eeprom_cmd(unsigned int *ctrl, unsigned cmd, unsigned reg)\r\n{\r\nunsigned short ser_cmd;\r\nint i;\r\nser_cmd = cmd | (reg << (16 - BITS_IN_COMMAND));\r\nfor (i = 0; i < BITS_IN_COMMAND; i++) {\r\nif (ser_cmd & (1<<15))\r\n__raw_writel(__raw_readl(ctrl) | EEPROM_DATO, ctrl);\r\nelse\r\n__raw_writel(__raw_readl(ctrl) & ~EEPROM_DATO, ctrl);\r\n__raw_writel(__raw_readl(ctrl) & ~EEPROM_ECLK, ctrl);\r\ndelay();\r\n__raw_writel(__raw_readl(ctrl) | EEPROM_ECLK, ctrl);\r\ndelay();\r\nser_cmd <<= 1;\r\n}\r\n__raw_writel(__raw_readl(ctrl) & ~EEPROM_DATO, ctrl);\r\n}\r\nunsigned short ip22_eeprom_read(unsigned int *ctrl, int reg)\r\n{\r\nunsigned short res = 0;\r\nint i;\r\n__raw_writel(__raw_readl(ctrl) & ~EEPROM_EPROT, ctrl);\r\neeprom_cs_on(ctrl);\r\neeprom_cmd(ctrl, EEPROM_READ, reg);\r\nfor (i = 0; i < 16; i++) {\r\n__raw_writel(__raw_readl(ctrl) & ~EEPROM_ECLK, ctrl);\r\ndelay();\r\n__raw_writel(__raw_readl(ctrl) | EEPROM_ECLK, ctrl);\r\ndelay();\r\nres <<= 1;\r\nif (__raw_readl(ctrl) & EEPROM_DATI)\r\nres |= 1;\r\n}\r\neeprom_cs_off(ctrl);\r\nreturn res;\r\n}\r\nunsigned short ip22_nvram_read(int reg)\r\n{\r\nif (ip22_is_fullhouse())\r\nreturn ip22_eeprom_read(&hpc3c0->eeprom, reg);\r\nelse {\r\nunsigned short tmp;\r\nreg <<= 1;\r\ntmp = hpc3c0->bbram[reg++] & 0xff;\r\nreturn (tmp << 8) | (hpc3c0->bbram[reg] & 0xff);\r\n}\r\n}

static inline void SCSI_DMA_SETADR(unsigned long adr)\r\n{\r\nst_dma.dma_lo = (unsigned char)adr;\r\nMFPDELAY();\r\nadr >>= 8;\r\nst_dma.dma_md = (unsigned char)adr;\r\nMFPDELAY();\r\nadr >>= 8;\r\nst_dma.dma_hi = (unsigned char)adr;\r\nMFPDELAY();\r\n}\r\nstatic inline unsigned long SCSI_DMA_GETADR(void)\r\n{\r\nunsigned long adr;\r\nadr = st_dma.dma_lo;\r\nMFPDELAY();\r\nadr |= (st_dma.dma_md & 0xff) << 8;\r\nMFPDELAY();\r\nadr |= (st_dma.dma_hi & 0xff) << 16;\r\nMFPDELAY();\r\nreturn adr;\r\n}\r\nstatic inline void ENABLE_IRQ(void)\r\n{\r\nif (IS_A_TT())\r\natari_enable_irq(IRQ_TT_MFP_SCSI);\r\nelse\r\natari_enable_irq(IRQ_MFP_FSCSI);\r\n}\r\nstatic inline void DISABLE_IRQ(void)\r\n{\r\nif (IS_A_TT())\r\natari_disable_irq(IRQ_TT_MFP_SCSI);\r\nelse\r\natari_disable_irq(IRQ_MFP_FSCSI);\r\n}\r\nstatic int scsi_dma_is_ignored_buserr(unsigned char dma_stat)\r\n{\r\nint i;\r\nunsigned long addr = SCSI_DMA_READ_P(dma_addr), end_addr;\r\nif (dma_stat & 0x01) {\r\nfor (i = 0; i < m68k_num_memory; ++i) {\r\nend_addr = m68k_memory[i].addr + m68k_memory[i].size;\r\nif (end_addr <= addr && addr <= end_addr + 4)\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t scsi_tt_intr(int irq, void *dummy)\r\n{\r\n#ifdef REAL_DMA\r\nint dma_stat;\r\ndma_stat = tt_scsi_dma.dma_ctrl;\r\nINT_PRINTK("scsi%d: NCR5380 interrupt, DMA status = %02x\n",\r\natari_scsi_host->host_no, dma_stat & 0xff);\r\nif (dma_stat & 0x80) {\r\nif (!scsi_dma_is_ignored_buserr(dma_stat)) {\r\nprintk(KERN_ERR "SCSI DMA caused bus error near 0x%08lx\n",\r\nSCSI_DMA_READ_P(dma_addr));\r\nprintk(KERN_CRIT "SCSI DMA bus error -- bad DMA programming!");\r\n}\r\n}\r\nif ((dma_stat & 0x02) && !(dma_stat & 0x40)) {\r\natari_dma_residual = HOSTDATA_DMALEN - (SCSI_DMA_READ_P(dma_addr) - atari_dma_startaddr);\r\nDMA_PRINTK("SCSI DMA: There are %ld residual bytes.\n",\r\natari_dma_residual);\r\nif ((signed int)atari_dma_residual < 0)\r\natari_dma_residual = 0;\r\nif ((dma_stat & 1) == 0) {\r\natari_scsi_fetch_restbytes();\r\n} else {\r\nif (atari_dma_residual & 0x1ff) {\r\nDMA_PRINTK("SCSI DMA: DMA bug corrected, "\r\n"difference %ld bytes\n",\r\n512 - (atari_dma_residual & 0x1ff));\r\natari_dma_residual = (atari_dma_residual + 511) & ~0x1ff;\r\n}\r\n}\r\ntt_scsi_dma.dma_ctrl = 0;\r\n}\r\nif (dma_stat & 0x40) {\r\natari_dma_residual = 0;\r\nif ((dma_stat & 1) == 0)\r\natari_scsi_fetch_restbytes();\r\ntt_scsi_dma.dma_ctrl = 0;\r\n}\r\n#endif\r\nNCR5380_intr(irq, dummy);\r\n#if 0\r\natari_enable_irq(IRQ_TT_MFP_SCSI);\r\n#endif\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t scsi_falcon_intr(int irq, void *dummy)\r\n{\r\n#ifdef REAL_DMA\r\nint dma_stat;\r\nst_dma.dma_mode_status = 0x90;\r\ndma_stat = st_dma.dma_mode_status;\r\nif (!(dma_stat & 0x01)) {\r\nprintk(KERN_CRIT "SCSI DMA error near 0x%08lx!\n", SCSI_DMA_GETADR());\r\n}\r\nif (atari_dma_active && (dma_stat & 0x02)) {\r\nunsigned long transferred;\r\ntransferred = SCSI_DMA_GETADR() - atari_dma_startaddr;\r\nif (transferred & 15)\r\nprintk(KERN_ERR "SCSI DMA error: %ld bytes lost in "\r\n"ST-DMA fifo\n", transferred & 15);\r\natari_dma_residual = HOSTDATA_DMALEN - transferred;\r\nDMA_PRINTK("SCSI DMA: There are %ld residual bytes.\n",\r\natari_dma_residual);\r\n} else\r\natari_dma_residual = 0;\r\natari_dma_active = 0;\r\nif (atari_dma_orig_addr) {\r\nmemcpy(atari_dma_orig_addr, phys_to_virt(atari_dma_startaddr),\r\nHOSTDATA_DMALEN - atari_dma_residual);\r\natari_dma_orig_addr = NULL;\r\n}\r\n#endif\r\nNCR5380_intr(irq, dummy);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void atari_scsi_fetch_restbytes(void)\r\n{\r\nint nr;\r\nchar *src, *dst;\r\nunsigned long phys_dst;\r\nphys_dst = SCSI_DMA_READ_P(dma_addr);\r\nnr = phys_dst & 3;\r\nif (nr) {\r\nphys_dst ^= nr;\r\nDMA_PRINTK("SCSI DMA: there are %d rest bytes for phys addr 0x%08lx",\r\nnr, phys_dst);\r\ndst = phys_to_virt(phys_dst);\r\nDMA_PRINTK(" = virt addr %p\n", dst);\r\nfor (src = (char *)&tt_scsi_dma.dma_restdata; nr != 0; --nr)\r\n*dst++ = *src++;\r\n}\r\n}\r\nstatic void falcon_release_lock_if_possible(struct NCR5380_hostdata *hostdata)\r\n{\r\nunsigned long flags;\r\nif (IS_A_TT())\r\nreturn;\r\nlocal_irq_save(flags);\r\nif (falcon_got_lock && !hostdata->disconnected_queue &&\r\n!hostdata->issue_queue && !hostdata->connected) {\r\nif (falcon_dont_release) {\r\n#if 0\r\nprintk("WARNING: Lock release not allowed. Ignored\n");\r\n#endif\r\nlocal_irq_restore(flags);\r\nreturn;\r\n}\r\nfalcon_got_lock = 0;\r\nstdma_release();\r\nwake_up(&falcon_fairness_wait);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void falcon_get_lock(void)\r\n{\r\nunsigned long flags;\r\nif (IS_A_TT())\r\nreturn;\r\nlocal_irq_save(flags);\r\nwhile (!in_irq() && falcon_got_lock && stdma_others_waiting())\r\nsleep_on(&falcon_fairness_wait);\r\nwhile (!falcon_got_lock) {\r\nif (in_irq())\r\npanic("Falcon SCSI hasn't ST-DMA lock in interrupt");\r\nif (!falcon_trying_lock) {\r\nfalcon_trying_lock = 1;\r\nstdma_lock(scsi_falcon_intr, NULL);\r\nfalcon_got_lock = 1;\r\nfalcon_trying_lock = 0;\r\nwake_up(&falcon_try_wait);\r\n} else {\r\nsleep_on(&falcon_try_wait);\r\n}\r\n}\r\nlocal_irq_restore(flags);\r\nif (!falcon_got_lock)\r\npanic("Falcon SCSI: someone stole the lock :-(\n");\r\n}\r\nint __init atari_scsi_detect(struct scsi_host_template *host)\r\n{\r\nstatic int called = 0;\r\nstruct Scsi_Host *instance;\r\nif (!MACH_IS_ATARI ||\r\n(!ATARIHW_PRESENT(ST_SCSI) && !ATARIHW_PRESENT(TT_SCSI)) ||\r\ncalled)\r\nreturn 0;\r\nhost->proc_name = "Atari";\r\natari_scsi_reg_read = IS_A_TT() ? atari_scsi_tt_reg_read :\r\natari_scsi_falcon_reg_read;\r\natari_scsi_reg_write = IS_A_TT() ? atari_scsi_tt_reg_write :\r\natari_scsi_falcon_reg_write;\r\nhost->can_queue =\r\n(setup_can_queue > 0) ? setup_can_queue :\r\nIS_A_TT() ? ATARI_TT_CAN_QUEUE : ATARI_FALCON_CAN_QUEUE;\r\nhost->cmd_per_lun =\r\n(setup_cmd_per_lun > 0) ? setup_cmd_per_lun :\r\nIS_A_TT() ? ATARI_TT_CMD_PER_LUN : ATARI_FALCON_CMD_PER_LUN;\r\nhost->sg_tablesize =\r\n!IS_A_TT() ? ATARI_FALCON_SG_TABLESIZE :\r\n(setup_sg_tablesize >= 0) ? setup_sg_tablesize : ATARI_TT_SG_TABLESIZE;\r\nif (setup_hostid >= 0)\r\nhost->this_id = setup_hostid;\r\nelse {\r\nhost->this_id = 7;\r\nif (ATARIHW_PRESENT(TT_CLK) && nvram_check_checksum()) {\r\nunsigned char b = nvram_read_byte( 14 );\r\nif (b & 0x80)\r\nhost->this_id = b & 7;\r\n}\r\n}\r\n#ifdef SUPPORT_TAGS\r\nif (setup_use_tagged_queuing < 0)\r\nsetup_use_tagged_queuing = DEFAULT_USE_TAGGED_QUEUING;\r\n#endif\r\n#ifdef REAL_DMA\r\nif (MACH_IS_ATARI && ATARIHW_PRESENT(ST_SCSI) &&\r\n!ATARIHW_PRESENT(EXTD_DMA) && m68k_num_memory > 1) {\r\natari_dma_buffer = atari_stram_alloc(STRAM_BUFFER_SIZE, "SCSI");\r\nif (!atari_dma_buffer) {\r\nprintk(KERN_ERR "atari_scsi_detect: can't allocate ST-RAM "\r\n"double buffer\n");\r\nreturn 0;\r\n}\r\natari_dma_phys_buffer = virt_to_phys(atari_dma_buffer);\r\natari_dma_orig_addr = 0;\r\n}\r\n#endif\r\ninstance = scsi_register(host, sizeof(struct NCR5380_hostdata));\r\nif (instance == NULL) {\r\natari_stram_free(atari_dma_buffer);\r\natari_dma_buffer = 0;\r\nreturn 0;\r\n}\r\natari_scsi_host = instance;\r\ninstance->irq = 0;\r\n#ifdef CONFIG_ATARI_SCSI_RESET_BOOT\r\natari_scsi_reset_boot();\r\n#endif\r\nNCR5380_init(instance, 0);\r\nif (IS_A_TT()) {\r\nif (request_irq(IRQ_TT_MFP_SCSI, scsi_tt_intr, IRQ_TYPE_SLOW,\r\n"SCSI NCR5380", instance)) {\r\nprintk(KERN_ERR "atari_scsi_detect: cannot allocate irq %d, aborting",IRQ_TT_MFP_SCSI);\r\nscsi_unregister(atari_scsi_host);\r\natari_stram_free(atari_dma_buffer);\r\natari_dma_buffer = 0;\r\nreturn 0;\r\n}\r\ntt_mfp.active_edge |= 0x80;\r\n#ifdef REAL_DMA\r\ntt_scsi_dma.dma_ctrl = 0;\r\natari_dma_residual = 0;\r\nif (MACH_IS_MEDUSA) {\r\natari_read_overruns = 4;\r\n}\r\n#endif\r\n} else {\r\n#ifdef REAL_DMA\r\natari_dma_residual = 0;\r\natari_dma_active = 0;\r\natari_dma_stram_mask = (ATARIHW_PRESENT(EXTD_DMA) ? 0x00000000\r\n: 0xff000000);\r\n#endif\r\n}\r\nprintk(KERN_INFO "scsi%d: options CAN_QUEUE=%d CMD_PER_LUN=%d SCAT-GAT=%d "\r\n#ifdef SUPPORT_TAGS\r\n"TAGGED-QUEUING=%s "\r\n#endif\r\n"HOSTID=%d",\r\ninstance->host_no, instance->hostt->can_queue,\r\ninstance->hostt->cmd_per_lun,\r\ninstance->hostt->sg_tablesize,\r\n#ifdef SUPPORT_TAGS\r\nsetup_use_tagged_queuing ? "yes" : "no",\r\n#endif\r\ninstance->hostt->this_id );\r\nNCR5380_print_options(instance);\r\nprintk("\n");\r\ncalled = 1;\r\nreturn 1;\r\n}\r\nint atari_scsi_release(struct Scsi_Host *sh)\r\n{\r\nif (IS_A_TT())\r\nfree_irq(IRQ_TT_MFP_SCSI, sh);\r\nif (atari_dma_buffer)\r\natari_stram_free(atari_dma_buffer);\r\nNCR5380_exit(sh);\r\nreturn 1;\r\n}\r\nvoid __init atari_scsi_setup(char *str, int *ints)\r\n{\r\nif (ints[0] < 1) {\r\nprintk("atari_scsi_setup: no arguments!\n");\r\nreturn;\r\n}\r\nif (ints[0] >= 1) {\r\nif (ints[1] > 0)\r\nsetup_can_queue = ints[1];\r\n}\r\nif (ints[0] >= 2) {\r\nif (ints[2] > 0)\r\nsetup_cmd_per_lun = ints[2];\r\n}\r\nif (ints[0] >= 3) {\r\nif (ints[3] >= 0) {\r\nsetup_sg_tablesize = ints[3];\r\nif (setup_sg_tablesize > SG_ALL)\r\nsetup_sg_tablesize = SG_ALL;\r\n}\r\n}\r\nif (ints[0] >= 4) {\r\nif (ints[4] >= 0 && ints[4] <= 7)\r\nsetup_hostid = ints[4];\r\nelse if (ints[4] > 7)\r\nprintk("atari_scsi_setup: invalid host ID %d !\n", ints[4]);\r\n}\r\n#ifdef SUPPORT_TAGS\r\nif (ints[0] >= 5) {\r\nif (ints[5] >= 0)\r\nsetup_use_tagged_queuing = !!ints[5];\r\n}\r\n#endif\r\n}\r\nint atari_scsi_bus_reset(Scsi_Cmnd *cmd)\r\n{\r\nint rv;\r\nstruct NCR5380_hostdata *hostdata =\r\n(struct NCR5380_hostdata *)cmd->device->host->hostdata;\r\nif (IS_A_TT()) {\r\natari_turnoff_irq(IRQ_TT_MFP_SCSI);\r\n#ifdef REAL_DMA\r\ntt_scsi_dma.dma_ctrl = 0;\r\n#endif\r\n} else {\r\natari_turnoff_irq(IRQ_MFP_FSCSI);\r\n#ifdef REAL_DMA\r\nst_dma.dma_mode_status = 0x90;\r\natari_dma_active = 0;\r\natari_dma_orig_addr = NULL;\r\n#endif\r\n}\r\nrv = NCR5380_bus_reset(cmd);\r\nif (IS_A_TT()) {\r\natari_turnon_irq(IRQ_TT_MFP_SCSI);\r\n} else {\r\natari_turnon_irq(IRQ_MFP_FSCSI);\r\n}\r\nif ((rv & SCSI_RESET_ACTION) == SCSI_RESET_SUCCESS)\r\nfalcon_release_lock_if_possible(hostdata);\r\nreturn rv;\r\n}\r\nstatic void __init atari_scsi_reset_boot(void)\r\n{\r\nunsigned long end;\r\nprintk("Atari SCSI: resetting the SCSI bus...");\r\nNCR5380_write(TARGET_COMMAND_REG,\r\nPHASE_SR_TO_TCR(NCR5380_read(STATUS_REG)));\r\nNCR5380_write(INITIATOR_COMMAND_REG, ICR_BASE | ICR_ASSERT_RST);\r\nudelay(50);\r\nNCR5380_write(INITIATOR_COMMAND_REG, ICR_BASE);\r\nNCR5380_read(RESET_PARITY_INTERRUPT_REG);\r\nend = jiffies + AFTER_RESET_DELAY;\r\nwhile (time_before(jiffies, end))\r\nbarrier();\r\nprintk(" done\n");\r\n}\r\nconst char *atari_scsi_info(struct Scsi_Host *host)\r\n{\r\nstatic const char string[] = "Atari native SCSI";\r\nreturn string;\r\n}\r\nunsigned long atari_scsi_dma_setup(struct Scsi_Host *instance, void *data,\r\nunsigned long count, int dir)\r\n{\r\nunsigned long addr = virt_to_phys(data);\r\nDMA_PRINTK("scsi%d: setting up dma, data = %p, phys = %lx, count = %ld, "\r\n"dir = %d\n", instance->host_no, data, addr, count, dir);\r\nif (!IS_A_TT() && !STRAM_ADDR(addr)) {\r\nif (dir)\r\nmemcpy(atari_dma_buffer, data, count);\r\nelse\r\natari_dma_orig_addr = data;\r\naddr = atari_dma_phys_buffer;\r\n}\r\natari_dma_startaddr = addr;\r\ndma_cache_maintenance(addr, count, dir);\r\nif (count == 0)\r\nprintk(KERN_NOTICE "SCSI warning: DMA programmed for 0 bytes !\n");\r\nif (IS_A_TT()) {\r\ntt_scsi_dma.dma_ctrl = dir;\r\nSCSI_DMA_WRITE_P(dma_addr, addr);\r\nSCSI_DMA_WRITE_P(dma_cnt, count);\r\ntt_scsi_dma.dma_ctrl = dir | 2;\r\n} else {\r\nSCSI_DMA_SETADR(addr);\r\ndir <<= 8;\r\nst_dma.dma_mode_status = 0x90 | dir;\r\nst_dma.dma_mode_status = 0x90 | (dir ^ 0x100);\r\nst_dma.dma_mode_status = 0x90 | dir;\r\nudelay(40);\r\nst_dma.fdc_acces_seccount = (count + (dir ? 511 : 0)) >> 9;\r\nudelay(40);\r\nst_dma.dma_mode_status = 0x10 | dir;\r\nudelay(40);\r\natari_dma_active = 1;\r\n}\r\nreturn count;\r\n}\r\nstatic long atari_scsi_dma_residual(struct Scsi_Host *instance)\r\n{\r\nreturn atari_dma_residual;\r\n}\r\nstatic int falcon_classify_cmd(Scsi_Cmnd *cmd)\r\n{\r\nunsigned char opcode = cmd->cmnd[0];\r\nif (opcode == READ_DEFECT_DATA || opcode == READ_LONG ||\r\nopcode == READ_BUFFER)\r\nreturn CMD_SURELY_BYTE_MODE;\r\nelse if (opcode == READ_6 || opcode == READ_10 ||\r\nopcode == 0xa8 || opcode == READ_REVERSE ||\r\nopcode == RECOVER_BUFFERED_DATA) {\r\nif (cmd->device->type == TYPE_TAPE && !(cmd->cmnd[1] & 1))\r\nreturn CMD_SURELY_BYTE_MODE;\r\nelse\r\nreturn CMD_SURELY_BLOCK_MODE;\r\n} else\r\nreturn CMD_MODE_UNKNOWN;\r\n}\r\nstatic unsigned long atari_dma_xfer_len(unsigned long wanted_len,\r\nScsi_Cmnd *cmd, int write_flag)\r\n{\r\nunsigned long possible_len, limit;\r\nif (IS_A_TT())\r\nreturn wanted_len;\r\nif (write_flag) {\r\npossible_len = wanted_len;\r\n} else {\r\nif (wanted_len & 0x1ff)\r\npossible_len = 0;\r\nelse {\r\nswitch (falcon_classify_cmd(cmd)) {\r\ncase CMD_SURELY_BLOCK_MODE:\r\npossible_len = wanted_len;\r\nbreak;\r\ncase CMD_SURELY_BYTE_MODE:\r\npossible_len = 0;\r\nbreak;\r\ncase CMD_MODE_UNKNOWN:\r\ndefault:\r\npossible_len = (wanted_len < 1024) ? 0 : wanted_len;\r\nbreak;\r\n}\r\n}\r\n}\r\nlimit = (atari_dma_buffer && !STRAM_ADDR(virt_to_phys(cmd->SCp.ptr))) ?\r\nSTRAM_BUFFER_SIZE : 255*512;\r\nif (possible_len > limit)\r\npossible_len = limit;\r\nif (possible_len != wanted_len)\r\nDMA_PRINTK("Sorry, must cut DMA transfer size to %ld bytes "\r\n"instead of %ld\n", possible_len, wanted_len);\r\nreturn possible_len;\r\n}\r\nstatic unsigned char atari_scsi_tt_reg_read(unsigned char reg)\r\n{\r\nreturn tt_scsi_regp[reg * 2];\r\n}\r\nstatic void atari_scsi_tt_reg_write(unsigned char reg, unsigned char value)\r\n{\r\ntt_scsi_regp[reg * 2] = value;\r\n}\r\nstatic unsigned char atari_scsi_falcon_reg_read(unsigned char reg)\r\n{\r\ndma_wd.dma_mode_status= (u_short)(0x88 + reg);\r\nreturn (u_char)dma_wd.fdc_acces_seccount;\r\n}\r\nstatic void atari_scsi_falcon_reg_write(unsigned char reg, unsigned char value)\r\n{\r\ndma_wd.dma_mode_status = (u_short)(0x88 + reg);\r\ndma_wd.fdc_acces_seccount = (u_short)value;\r\n}

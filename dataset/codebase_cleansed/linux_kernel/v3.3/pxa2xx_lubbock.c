static int\r\nlubbock_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nstruct sa1111_pcmcia_socket *s = to_skt(skt);\r\nunsigned int pa_dwr_mask, pa_dwr_set, misc_mask, misc_set;\r\nint ret = 0;\r\npa_dwr_mask = pa_dwr_set = misc_mask = misc_set = 0;\r\nagain:\r\nswitch (skt->nr) {\r\ncase 0:\r\npa_dwr_mask = GPIO_A0 | GPIO_A1 | GPIO_A2 | GPIO_A3;\r\nswitch (state->Vcc) {\r\ncase 0:\r\nbreak;\r\ncase 33:\r\npa_dwr_set |= GPIO_A3;\r\nbreak;\r\ncase 50:\r\npa_dwr_set |= GPIO_A2;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s(): unrecognized Vcc %u\n",\r\n__func__, state->Vcc);\r\nret = -1;\r\n}\r\nswitch (state->Vpp) {\r\ncase 0:\r\nbreak;\r\ncase 120:\r\npa_dwr_set |= GPIO_A1;\r\nbreak;\r\ndefault:\r\nif (state->Vpp == state->Vcc)\r\npa_dwr_set |= GPIO_A0;\r\nelse {\r\nprintk(KERN_ERR "%s(): unrecognized Vpp %u\n",\r\n__func__, state->Vpp);\r\nret = -1;\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase 1:\r\nmisc_mask = (1 << 15) | (1 << 14);\r\nswitch (state->Vcc) {\r\ncase 0:\r\nbreak;\r\ncase 33:\r\nmisc_set |= 1 << 15;\r\nbreak;\r\ncase 50:\r\nmisc_set |= 1 << 14;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s(): unrecognized Vcc %u\n",\r\n__func__, state->Vcc);\r\nret = -1;\r\nbreak;\r\n}\r\nif (state->Vpp != state->Vcc && state->Vpp != 0) {\r\nprintk(KERN_ERR "%s(): CF slot cannot support Vpp %u\n",\r\n__func__, state->Vpp);\r\nret = -1;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nret = -1;\r\n}\r\nif (ret == 0)\r\nret = sa1111_pcmcia_configure_socket(skt, state);\r\nif (ret == 0) {\r\nlubbock_set_misc_wr(misc_mask, misc_set);\r\nsa1111_set_io(s->dev, pa_dwr_mask, pa_dwr_set);\r\n}\r\n#if 1\r\nif (ret == 0 && state->Vcc == 33) {\r\nstruct pcmcia_state new_state;\r\nmdelay(3);\r\nsa1111_pcmcia_socket_state(skt, &new_state);\r\nif (!new_state.vs_3v && !new_state.vs_Xv) {\r\nlubbock_set_misc_wr(misc_mask, 0);\r\nsa1111_set_io(s->dev, pa_dwr_mask, 0);\r\nmdelay(100);\r\n((socket_state_t *)state)->Vcc = 50;\r\n((socket_state_t *)state)->Vpp = 50;\r\ngoto again;\r\n}\r\n}\r\n#endif\r\nreturn ret;\r\n}\r\nint pcmcia_lubbock_init(struct sa1111_dev *sadev)\r\n{\r\nint ret = -ENODEV;\r\nif (machine_is_lubbock()) {\r\nsa1111_set_io_dir(sadev, GPIO_A0|GPIO_A1|GPIO_A2|GPIO_A3, 0, 0);\r\nsa1111_set_io(sadev, GPIO_A0|GPIO_A1|GPIO_A2|GPIO_A3, 0);\r\nsa1111_set_sleep_io(sadev, GPIO_A0|GPIO_A1|GPIO_A2|GPIO_A3, 0);\r\nlubbock_set_misc_wr((1 << 15) | (1 << 14), 0);\r\npxa2xx_drv_pcmcia_ops(&lubbock_pcmcia_ops);\r\npxa2xx_configure_sockets(&sadev->dev);\r\nret = sa1111_pcmcia_add(sadev, &lubbock_pcmcia_ops,\r\npxa2xx_drv_pcmcia_add_one);\r\n}\r\nreturn ret;\r\n}

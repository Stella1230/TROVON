static void pnx833x_wdt_start(void)\r\n{\r\nPNX833X_REG(PNX833X_RESET + PNX833X_RESET_CONFIG) |= 0x1;\r\nPNX833X_REG(PNX833X_CONFIG +\r\nPNX833X_CONFIG_CPU_WATCHDOG_COMPARE) = pnx833x_wdt_timeout;\r\nPNX833X_REG(PNX833X_CONFIG +\r\nPNX833X_CONFIG_CPU_COUNTERS_CONTROL) |= 0x1;\r\nprintk(KERN_INFO PFX "Started watchdog timer.\n");\r\n}\r\nstatic void pnx833x_wdt_stop(void)\r\n{\r\nPNX833X_REG(PNX833X_RESET + PNX833X_CONFIG) &= 0xFFFFFFFE;\r\nPNX833X_REG(PNX833X_CONFIG +\r\nPNX833X_CONFIG_CPU_COUNTERS_CONTROL) &= 0xFFFFFFFE;\r\nprintk(KERN_INFO PFX "Stopped watchdog timer.\n");\r\n}\r\nstatic void pnx833x_wdt_ping(void)\r\n{\r\nPNX833X_REG(PNX833X_CONFIG +\r\nPNX833X_CONFIG_CPU_WATCHDOG_COMPARE) = pnx833x_wdt_timeout;\r\n}\r\nstatic int pnx833x_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &pnx833x_wdt_alive))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nif (!start_enabled)\r\npnx833x_wdt_start();\r\npnx833x_wdt_ping();\r\nprintk(KERN_INFO "Started watchdog timer.\n");\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int pnx833x_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (!nowayout)\r\npnx833x_wdt_stop();\r\nclear_bit(0, &pnx833x_wdt_alive);\r\nreturn 0;\r\n}\r\nstatic ssize_t pnx833x_wdt_write(struct file *file, const char *data, size_t len, loff_t *ppos)\r\n{\r\nif (len)\r\npnx833x_wdt_ping();\r\nreturn len;\r\n}\r\nstatic long pnx833x_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint options, new_timeout = 0;\r\nuint32_t timeout, timeout_left = 0;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_KEEPALIVEPING | WDIOF_SETTIMEOUT,\r\n.firmware_version = 0,\r\n.identity = "Hardware Watchdog for PNX833x",\r\n};\r\nswitch (cmd) {\r\ndefault:\r\nreturn -ENOTTY;\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user((struct watchdog_info *)arg,\r\n&ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, (int *)arg);\r\ncase WDIOC_SETOPTIONS:\r\nif (get_user(options, (int *)arg))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD)\r\npnx833x_wdt_stop();\r\nif (options & WDIOS_ENABLECARD)\r\npnx833x_wdt_start();\r\nreturn 0;\r\ncase WDIOC_KEEPALIVE:\r\npnx833x_wdt_ping();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\n{\r\nif (get_user(new_timeout, (int *)arg))\r\nreturn -EFAULT;\r\npnx833x_wdt_timeout = new_timeout;\r\nPNX833X_REG(PNX833X_CONFIG +\r\nPNX833X_CONFIG_CPU_WATCHDOG_COMPARE) = new_timeout;\r\nreturn put_user(new_timeout, (int *)arg);\r\n}\r\ncase WDIOC_GETTIMEOUT:\r\ntimeout = PNX833X_REG(PNX833X_CONFIG +\r\nPNX833X_CONFIG_CPU_WATCHDOG_COMPARE);\r\nreturn put_user(timeout, (int *)arg);\r\ncase WDIOC_GETTIMELEFT:\r\ntimeout_left = PNX833X_REG(PNX833X_CONFIG +\r\nPNX833X_CONFIG_CPU_WATCHDOG);\r\nreturn put_user(timeout_left, (int *)arg);\r\n}\r\n}\r\nstatic int pnx833x_wdt_notify_sys(struct notifier_block *this,\r\nunsigned long code, void *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\npnx833x_wdt_stop();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nint ret, cause;\r\ncause = PNX833X_REG(PNX833X_RESET);\r\nif (cause & 0x80000000) {\r\nprintk(KERN_INFO PFX "The system was previously reset due to "\r\n"the watchdog firing - please investigate...\n");\r\n}\r\nret = register_reboot_notifier(&pnx833x_wdt_notifier);\r\nif (ret) {\r\nprintk(KERN_ERR PFX\r\n"cannot register reboot notifier (err=%d)\n", ret);\r\nreturn ret;\r\n}\r\nret = misc_register(&pnx833x_wdt_miscdev);\r\nif (ret) {\r\nprintk(KERN_ERR PFX\r\n"cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, ret);\r\nunregister_reboot_notifier(&pnx833x_wdt_notifier);\r\nreturn ret;\r\n}\r\nprintk(banner);\r\nif (start_enabled)\r\npnx833x_wdt_start();\r\nreturn 0;\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nmisc_deregister(&pnx833x_wdt_miscdev);\r\nunregister_reboot_notifier(&pnx833x_wdt_notifier);\r\n}

int pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nif (ltqpci_plat_dev_init)\r\nreturn ltqpci_plat_dev_init(dev);\r\nreturn 0;\r\n}\r\nstatic u32 ltq_calc_bar11mask(void)\r\n{\r\nu32 mem, bar11mask;\r\nmem = num_physpages * PAGE_SIZE;\r\nbar11mask = (0x0ffffff0 & ~((1 << (fls(mem) - 1)) - 1)) | 8;\r\nreturn bar11mask;\r\n}\r\nstatic void ltq_pci_setup_gpio(int gpio)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ltq_pci_gpio_map); i++) {\r\nif (gpio & (1 << i)) {\r\nltq_gpio_request(ltq_pci_gpio_map[i].pin,\r\nltq_pci_gpio_map[i].alt0,\r\nltq_pci_gpio_map[i].alt1,\r\nltq_pci_gpio_map[i].dir,\r\nltq_pci_gpio_map[i].name);\r\n}\r\n}\r\nltq_gpio_request(21, 0, 0, 1, "pci-reset");\r\nltq_pci_req_mask = (gpio >> PCI_REQ_SHIFT) & PCI_REQ_MASK;\r\n}\r\nstatic int __devinit ltq_pci_startup(struct ltq_pci_data *conf)\r\n{\r\nu32 temp_buffer;\r\nif (ltq_is_ar9()) {\r\nltq_cgu_w32(ltq_cgu_r32(LTQ_CGU_IFCCR) & ~0x1f00000, LTQ_CGU_IFCCR);\r\nltq_cgu_w32(ltq_cgu_r32(LTQ_CGU_IFCCR) | 0xe00000, LTQ_CGU_IFCCR);\r\n} else {\r\nltq_cgu_w32(ltq_cgu_r32(LTQ_CGU_IFCCR) & ~0xf00000, LTQ_CGU_IFCCR);\r\nltq_cgu_w32(ltq_cgu_r32(LTQ_CGU_IFCCR) | 0x800000, LTQ_CGU_IFCCR);\r\n}\r\nif (conf->clock) {\r\nltq_cgu_w32(ltq_cgu_r32(LTQ_CGU_IFCCR) & ~(1 << 16),\r\nLTQ_CGU_IFCCR);\r\nltq_cgu_w32((1 << 30), LTQ_CGU_PCICR);\r\n} else {\r\nltq_cgu_w32(ltq_cgu_r32(LTQ_CGU_IFCCR) | (1 << 16),\r\nLTQ_CGU_IFCCR);\r\nltq_cgu_w32((1 << 31) | (1 << 30), LTQ_CGU_PCICR);\r\n}\r\nltq_pci_setup_gpio(conf->gpio);\r\nltq_pci_w32(0xa, PCI_CR_CLK_CTRL);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_PCI_MOD) & ~(1 << 24), PCI_CR_PCI_MOD);\r\nwmb();\r\nltq_pci_cfg_w32(ltq_pci_cfg_r32(PCI_CS_STS_CMD) | 7, PCI_CS_STS_CMD);\r\ntemp_buffer = ltq_pci_r32(PCI_CR_PC_ARB);\r\ntemp_buffer &= (~(ltq_pci_req_mask << 16));\r\ntemp_buffer |= (1 << INTERNAL_ARB_ENABLE_BIT);\r\ntemp_buffer &= (~(3 << PCI_MASTER0_REQ_MASK_2BITS));\r\ntemp_buffer &= (~(3 << PCI_MASTER1_REQ_MASK_2BITS));\r\ntemp_buffer &= (~(3 << PCI_MASTER2_REQ_MASK_2BITS));\r\nltq_pci_w32(temp_buffer, PCI_CR_PC_ARB);\r\nwmb();\r\nltq_pci_w32(0x18000000, PCI_CR_FCI_ADDR_MAP0);\r\nltq_pci_w32(0x18400000, PCI_CR_FCI_ADDR_MAP1);\r\nltq_pci_w32(0x18800000, PCI_CR_FCI_ADDR_MAP2);\r\nltq_pci_w32(0x18c00000, PCI_CR_FCI_ADDR_MAP3);\r\nltq_pci_w32(0x19000000, PCI_CR_FCI_ADDR_MAP4);\r\nltq_pci_w32(0x19400000, PCI_CR_FCI_ADDR_MAP5);\r\nltq_pci_w32(0x19800000, PCI_CR_FCI_ADDR_MAP6);\r\nltq_pci_w32(0x19c00000, PCI_CR_FCI_ADDR_MAP7);\r\nltq_pci_w32(0x1ae00000, PCI_CR_FCI_ADDR_MAP11hg);\r\nltq_pci_w32(ltq_calc_bar11mask(), PCI_CR_BAR11MASK);\r\nltq_pci_w32(0, PCI_CR_PCI_ADDR_MAP11);\r\nltq_pci_w32(0, PCI_CS_BASE_ADDR1);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_PCI_EOI) | 3, PCI_CR_PCI_EOI);\r\nwmb();\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_BAR12MASK) | 0x80000000,\r\nPCI_CR_BAR12MASK);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_BAR13MASK) | 0x80000000,\r\nPCI_CR_BAR13MASK);\r\nltq_pci_w32(0x303, PCI_CR_FCI_BURST_LENGTH);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_PCI_MOD) | (1 << 24), PCI_CR_PCI_MOD);\r\nwmb();\r\nltq_ebu_w32(ltq_ebu_r32(LTQ_EBU_PCC_CON) | 0xc, LTQ_EBU_PCC_CON);\r\nltq_ebu_w32(ltq_ebu_r32(LTQ_EBU_PCC_IEN) | 0x10, LTQ_EBU_PCC_IEN);\r\n__gpio_set_value(21, 0);\r\nwmb();\r\nmdelay(1);\r\n__gpio_set_value(21, 1);\r\nreturn 0;\r\n}\r\nint __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nif (ltq_pci_irq_map[slot])\r\nreturn ltq_pci_irq_map[slot];\r\nprintk(KERN_ERR "lq_pci: trying to map irq for unknown slot %d\n",\r\nslot);\r\nreturn 0;\r\n}\r\nstatic int __devinit ltq_pci_probe(struct platform_device *pdev)\r\n{\r\nstruct ltq_pci_data *ltq_pci_data =\r\n(struct ltq_pci_data *) pdev->dev.platform_data;\r\npci_probe_only = 0;\r\nltq_pci_irq_map = ltq_pci_data->irq;\r\nltq_pci_membase = ioremap_nocache(PCI_CR_BASE_ADDR, PCI_CR_SIZE);\r\nltq_pci_mapped_cfg =\r\nioremap_nocache(LTQ_PCI_CFG_BASE, LTQ_PCI_CFG_BASE);\r\nltq_pci_controller.io_map_base =\r\n(unsigned long)ioremap(LTQ_PCI_IO_BASE, LTQ_PCI_IO_SIZE - 1);\r\nltq_pci_startup(ltq_pci_data);\r\nregister_pci_controller(&ltq_pci_controller);\r\nreturn 0;\r\n}\r\nint __init pcibios_init(void)\r\n{\r\nint ret = platform_driver_register(&ltq_pci_driver);\r\nif (ret)\r\nprintk(KERN_INFO "ltq_pci: Error registering platfom driver!");\r\nreturn ret;\r\n}

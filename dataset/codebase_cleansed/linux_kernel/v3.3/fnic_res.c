int fnic_get_vnic_config(struct fnic *fnic)\r\n{\r\nstruct vnic_fc_config *c = &fnic->config;\r\nint err;\r\n#define GET_CONFIG(m) \\r\ndo { \\r\nerr = vnic_dev_spec(fnic->vdev, \\r\noffsetof(struct vnic_fc_config, m), \\r\nsizeof(c->m), &c->m); \\r\nif (err) { \\r\nshost_printk(KERN_ERR, fnic->lport->host, \\r\n"Error getting %s, %d\n", #m, \\r\nerr); \\r\nreturn err; \\r\n} \\r\n} while (0);\r\nGET_CONFIG(node_wwn);\r\nGET_CONFIG(port_wwn);\r\nGET_CONFIG(wq_enet_desc_count);\r\nGET_CONFIG(wq_copy_desc_count);\r\nGET_CONFIG(rq_desc_count);\r\nGET_CONFIG(maxdatafieldsize);\r\nGET_CONFIG(ed_tov);\r\nGET_CONFIG(ra_tov);\r\nGET_CONFIG(intr_timer);\r\nGET_CONFIG(intr_timer_type);\r\nGET_CONFIG(flags);\r\nGET_CONFIG(flogi_retries);\r\nGET_CONFIG(flogi_timeout);\r\nGET_CONFIG(plogi_retries);\r\nGET_CONFIG(plogi_timeout);\r\nGET_CONFIG(io_throttle_count);\r\nGET_CONFIG(link_down_timeout);\r\nGET_CONFIG(port_down_timeout);\r\nGET_CONFIG(port_down_io_retries);\r\nGET_CONFIG(luns_per_tgt);\r\nc->wq_enet_desc_count =\r\nmin_t(u32, VNIC_FNIC_WQ_DESCS_MAX,\r\nmax_t(u32, VNIC_FNIC_WQ_DESCS_MIN,\r\nc->wq_enet_desc_count));\r\nc->wq_enet_desc_count = ALIGN(c->wq_enet_desc_count, 16);\r\nc->wq_copy_desc_count =\r\nmin_t(u32, VNIC_FNIC_WQ_COPY_DESCS_MAX,\r\nmax_t(u32, VNIC_FNIC_WQ_COPY_DESCS_MIN,\r\nc->wq_copy_desc_count));\r\nc->wq_copy_desc_count = ALIGN(c->wq_copy_desc_count, 16);\r\nc->rq_desc_count =\r\nmin_t(u32, VNIC_FNIC_RQ_DESCS_MAX,\r\nmax_t(u32, VNIC_FNIC_RQ_DESCS_MIN,\r\nc->rq_desc_count));\r\nc->rq_desc_count = ALIGN(c->rq_desc_count, 16);\r\nc->maxdatafieldsize =\r\nmin_t(u16, VNIC_FNIC_MAXDATAFIELDSIZE_MAX,\r\nmax_t(u16, VNIC_FNIC_MAXDATAFIELDSIZE_MIN,\r\nc->maxdatafieldsize));\r\nc->ed_tov =\r\nmin_t(u32, VNIC_FNIC_EDTOV_MAX,\r\nmax_t(u32, VNIC_FNIC_EDTOV_MIN,\r\nc->ed_tov));\r\nc->ra_tov =\r\nmin_t(u32, VNIC_FNIC_RATOV_MAX,\r\nmax_t(u32, VNIC_FNIC_RATOV_MIN,\r\nc->ra_tov));\r\nc->flogi_retries =\r\nmin_t(u32, VNIC_FNIC_FLOGI_RETRIES_MAX, c->flogi_retries);\r\nc->flogi_timeout =\r\nmin_t(u32, VNIC_FNIC_FLOGI_TIMEOUT_MAX,\r\nmax_t(u32, VNIC_FNIC_FLOGI_TIMEOUT_MIN,\r\nc->flogi_timeout));\r\nc->plogi_retries =\r\nmin_t(u32, VNIC_FNIC_PLOGI_RETRIES_MAX, c->plogi_retries);\r\nc->plogi_timeout =\r\nmin_t(u32, VNIC_FNIC_PLOGI_TIMEOUT_MAX,\r\nmax_t(u32, VNIC_FNIC_PLOGI_TIMEOUT_MIN,\r\nc->plogi_timeout));\r\nc->io_throttle_count =\r\nmin_t(u32, VNIC_FNIC_IO_THROTTLE_COUNT_MAX,\r\nmax_t(u32, VNIC_FNIC_IO_THROTTLE_COUNT_MIN,\r\nc->io_throttle_count));\r\nc->link_down_timeout =\r\nmin_t(u32, VNIC_FNIC_LINK_DOWN_TIMEOUT_MAX,\r\nc->link_down_timeout);\r\nc->port_down_timeout =\r\nmin_t(u32, VNIC_FNIC_PORT_DOWN_TIMEOUT_MAX,\r\nc->port_down_timeout);\r\nc->port_down_io_retries =\r\nmin_t(u32, VNIC_FNIC_PORT_DOWN_IO_RETRIES_MAX,\r\nc->port_down_io_retries);\r\nc->luns_per_tgt =\r\nmin_t(u32, VNIC_FNIC_LUNS_PER_TARGET_MAX,\r\nmax_t(u32, VNIC_FNIC_LUNS_PER_TARGET_MIN,\r\nc->luns_per_tgt));\r\nc->intr_timer = min_t(u16, VNIC_INTR_TIMER_MAX, c->intr_timer);\r\nc->intr_timer_type = c->intr_timer_type;\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC MAC addr %pM "\r\n"wq/wq_copy/rq %d/%d/%d\n",\r\nfnic->ctlr.ctl_src_addr,\r\nc->wq_enet_desc_count, c->wq_copy_desc_count,\r\nc->rq_desc_count);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC node wwn %llx port wwn %llx\n",\r\nc->node_wwn, c->port_wwn);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC ed_tov %d ra_tov %d\n",\r\nc->ed_tov, c->ra_tov);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC mtu %d intr timer %d\n",\r\nc->maxdatafieldsize, c->intr_timer);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC flags 0x%x luns per tgt %d\n",\r\nc->flags, c->luns_per_tgt);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC flogi_retries %d flogi timeout %d\n",\r\nc->flogi_retries, c->flogi_timeout);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC plogi retries %d plogi timeout %d\n",\r\nc->plogi_retries, c->plogi_timeout);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC io throttle count %d link dn timeout %d\n",\r\nc->io_throttle_count, c->link_down_timeout);\r\nshost_printk(KERN_INFO, fnic->lport->host,\r\n"vNIC port dn io retries %d port dn timeout %d\n",\r\nc->port_down_io_retries, c->port_down_timeout);\r\nreturn 0;\r\n}\r\nint fnic_set_nic_config(struct fnic *fnic, u8 rss_default_cpu,\r\nu8 rss_hash_type,\r\nu8 rss_hash_bits, u8 rss_base_cpu, u8 rss_enable,\r\nu8 tso_ipid_split_en, u8 ig_vlan_strip_en)\r\n{\r\nu64 a0, a1;\r\nu32 nic_cfg;\r\nint wait = 1000;\r\nvnic_set_nic_cfg(&nic_cfg, rss_default_cpu,\r\nrss_hash_type, rss_hash_bits, rss_base_cpu,\r\nrss_enable, tso_ipid_split_en, ig_vlan_strip_en);\r\na0 = nic_cfg;\r\na1 = 0;\r\nreturn vnic_dev_cmd(fnic->vdev, CMD_NIC_CFG, &a0, &a1, wait);\r\n}\r\nvoid fnic_get_res_counts(struct fnic *fnic)\r\n{\r\nfnic->wq_count = vnic_dev_get_res_count(fnic->vdev, RES_TYPE_WQ);\r\nfnic->raw_wq_count = fnic->wq_count - 1;\r\nfnic->wq_copy_count = fnic->wq_count - fnic->raw_wq_count;\r\nfnic->rq_count = vnic_dev_get_res_count(fnic->vdev, RES_TYPE_RQ);\r\nfnic->cq_count = vnic_dev_get_res_count(fnic->vdev, RES_TYPE_CQ);\r\nfnic->intr_count = vnic_dev_get_res_count(fnic->vdev,\r\nRES_TYPE_INTR_CTRL);\r\n}\r\nvoid fnic_free_vnic_resources(struct fnic *fnic)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < fnic->raw_wq_count; i++)\r\nvnic_wq_free(&fnic->wq[i]);\r\nfor (i = 0; i < fnic->wq_copy_count; i++)\r\nvnic_wq_copy_free(&fnic->wq_copy[i]);\r\nfor (i = 0; i < fnic->rq_count; i++)\r\nvnic_rq_free(&fnic->rq[i]);\r\nfor (i = 0; i < fnic->cq_count; i++)\r\nvnic_cq_free(&fnic->cq[i]);\r\nfor (i = 0; i < fnic->intr_count; i++)\r\nvnic_intr_free(&fnic->intr[i]);\r\n}\r\nint fnic_alloc_vnic_resources(struct fnic *fnic)\r\n{\r\nenum vnic_dev_intr_mode intr_mode;\r\nunsigned int mask_on_assertion;\r\nunsigned int interrupt_offset;\r\nunsigned int error_interrupt_enable;\r\nunsigned int error_interrupt_offset;\r\nunsigned int i, cq_index;\r\nunsigned int wq_copy_cq_desc_count;\r\nint err;\r\nintr_mode = vnic_dev_get_intr_mode(fnic->vdev);\r\nshost_printk(KERN_INFO, fnic->lport->host, "vNIC interrupt mode: %s\n",\r\nintr_mode == VNIC_DEV_INTR_MODE_INTX ? "legacy PCI INTx" :\r\nintr_mode == VNIC_DEV_INTR_MODE_MSI ? "MSI" :\r\nintr_mode == VNIC_DEV_INTR_MODE_MSIX ?\r\n"MSI-X" : "unknown");\r\nshost_printk(KERN_INFO, fnic->lport->host, "vNIC resources avail: "\r\n"wq %d cp_wq %d raw_wq %d rq %d cq %d intr %d\n",\r\nfnic->wq_count, fnic->wq_copy_count, fnic->raw_wq_count,\r\nfnic->rq_count, fnic->cq_count, fnic->intr_count);\r\nfor (i = 0; i < fnic->raw_wq_count; i++) {\r\nerr = vnic_wq_alloc(fnic->vdev, &fnic->wq[i], i,\r\nfnic->config.wq_enet_desc_count,\r\nsizeof(struct wq_enet_desc));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < fnic->wq_copy_count; i++) {\r\nerr = vnic_wq_copy_alloc(fnic->vdev, &fnic->wq_copy[i],\r\n(fnic->raw_wq_count + i),\r\nfnic->config.wq_copy_desc_count,\r\nsizeof(struct fcpio_host_req));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < fnic->rq_count; i++) {\r\nerr = vnic_rq_alloc(fnic->vdev, &fnic->rq[i], i,\r\nfnic->config.rq_desc_count,\r\nsizeof(struct rq_enet_desc));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < fnic->rq_count; i++) {\r\ncq_index = i;\r\nerr = vnic_cq_alloc(fnic->vdev,\r\n&fnic->cq[cq_index], cq_index,\r\nfnic->config.rq_desc_count,\r\nsizeof(struct cq_enet_rq_desc));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < fnic->raw_wq_count; i++) {\r\ncq_index = fnic->rq_count + i;\r\nerr = vnic_cq_alloc(fnic->vdev, &fnic->cq[cq_index], cq_index,\r\nfnic->config.wq_enet_desc_count,\r\nsizeof(struct cq_enet_wq_desc));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nwq_copy_cq_desc_count = (fnic->config.wq_copy_desc_count * 3);\r\nfor (i = 0; i < fnic->wq_copy_count; i++) {\r\ncq_index = fnic->raw_wq_count + fnic->rq_count + i;\r\nerr = vnic_cq_alloc(fnic->vdev, &fnic->cq[cq_index],\r\ncq_index,\r\nwq_copy_cq_desc_count,\r\nsizeof(struct fcpio_fw_req));\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfor (i = 0; i < fnic->intr_count; i++) {\r\nerr = vnic_intr_alloc(fnic->vdev, &fnic->intr[i], i);\r\nif (err)\r\ngoto err_out_cleanup;\r\n}\r\nfnic->legacy_pba = vnic_dev_get_res(fnic->vdev,\r\nRES_TYPE_INTR_PBA_LEGACY, 0);\r\nif (!fnic->legacy_pba && intr_mode == VNIC_DEV_INTR_MODE_INTX) {\r\nshost_printk(KERN_ERR, fnic->lport->host,\r\n"Failed to hook legacy pba resource\n");\r\nerr = -ENODEV;\r\ngoto err_out_cleanup;\r\n}\r\nswitch (intr_mode) {\r\ncase VNIC_DEV_INTR_MODE_INTX:\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\nerror_interrupt_enable = 1;\r\nerror_interrupt_offset = fnic->err_intr_offset;\r\nbreak;\r\ndefault:\r\nerror_interrupt_enable = 0;\r\nerror_interrupt_offset = 0;\r\nbreak;\r\n}\r\nfor (i = 0; i < fnic->rq_count; i++) {\r\ncq_index = i;\r\nvnic_rq_init(&fnic->rq[i],\r\ncq_index,\r\nerror_interrupt_enable,\r\nerror_interrupt_offset);\r\n}\r\nfor (i = 0; i < fnic->raw_wq_count; i++) {\r\ncq_index = i + fnic->rq_count;\r\nvnic_wq_init(&fnic->wq[i],\r\ncq_index,\r\nerror_interrupt_enable,\r\nerror_interrupt_offset);\r\n}\r\nfor (i = 0; i < fnic->wq_copy_count; i++) {\r\nvnic_wq_copy_init(&fnic->wq_copy[i],\r\n0 ,\r\nerror_interrupt_enable,\r\nerror_interrupt_offset);\r\n}\r\nfor (i = 0; i < fnic->cq_count; i++) {\r\nswitch (intr_mode) {\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\ninterrupt_offset = i;\r\nbreak;\r\ndefault:\r\ninterrupt_offset = 0;\r\nbreak;\r\n}\r\nvnic_cq_init(&fnic->cq[i],\r\n0 ,\r\n1 ,\r\n0 ,\r\n0 ,\r\n1 ,\r\n1 ,\r\n1 ,\r\n0 ,\r\ninterrupt_offset,\r\n0 );\r\n}\r\nswitch (intr_mode) {\r\ncase VNIC_DEV_INTR_MODE_MSI:\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\nmask_on_assertion = 1;\r\nbreak;\r\ndefault:\r\nmask_on_assertion = 0;\r\nbreak;\r\n}\r\nfor (i = 0; i < fnic->intr_count; i++) {\r\nvnic_intr_init(&fnic->intr[i],\r\nfnic->config.intr_timer,\r\nfnic->config.intr_timer_type,\r\nmask_on_assertion);\r\n}\r\nerr = vnic_dev_stats_dump(fnic->vdev, &fnic->stats);\r\nif (err) {\r\nshost_printk(KERN_ERR, fnic->lport->host,\r\n"vnic_dev_stats_dump failed - x%x\n", err);\r\ngoto err_out_cleanup;\r\n}\r\nvnic_dev_stats_clear(fnic->vdev);\r\nreturn 0;\r\nerr_out_cleanup:\r\nfnic_free_vnic_resources(fnic);\r\nreturn err;\r\n}

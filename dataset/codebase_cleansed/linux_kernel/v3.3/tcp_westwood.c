static void tcp_westwood_init(struct sock *sk)\r\n{\r\nstruct westwood *w = inet_csk_ca(sk);\r\nw->bk = 0;\r\nw->bw_ns_est = 0;\r\nw->bw_est = 0;\r\nw->accounted = 0;\r\nw->cumul_ack = 0;\r\nw->reset_rtt_min = 1;\r\nw->rtt_min = w->rtt = TCP_WESTWOOD_INIT_RTT;\r\nw->rtt_win_sx = tcp_time_stamp;\r\nw->snd_una = tcp_sk(sk)->snd_una;\r\nw->first_ack = 1;\r\n}\r\nstatic inline u32 westwood_do_filter(u32 a, u32 b)\r\n{\r\nreturn ((7 * a) + b) >> 3;\r\n}\r\nstatic void westwood_filter(struct westwood *w, u32 delta)\r\n{\r\nif (w->bw_ns_est == 0 && w->bw_est == 0) {\r\nw->bw_ns_est = w->bk / delta;\r\nw->bw_est = w->bw_ns_est;\r\n} else {\r\nw->bw_ns_est = westwood_do_filter(w->bw_ns_est, w->bk / delta);\r\nw->bw_est = westwood_do_filter(w->bw_est, w->bw_ns_est);\r\n}\r\n}\r\nstatic void tcp_westwood_pkts_acked(struct sock *sk, u32 cnt, s32 rtt)\r\n{\r\nstruct westwood *w = inet_csk_ca(sk);\r\nif (rtt > 0)\r\nw->rtt = usecs_to_jiffies(rtt);\r\n}\r\nstatic void westwood_update_window(struct sock *sk)\r\n{\r\nstruct westwood *w = inet_csk_ca(sk);\r\ns32 delta = tcp_time_stamp - w->rtt_win_sx;\r\nif (w->first_ack) {\r\nw->snd_una = tcp_sk(sk)->snd_una;\r\nw->first_ack = 0;\r\n}\r\nif (w->rtt && delta > max_t(u32, w->rtt, TCP_WESTWOOD_RTT_MIN)) {\r\nwestwood_filter(w, delta);\r\nw->bk = 0;\r\nw->rtt_win_sx = tcp_time_stamp;\r\n}\r\n}\r\nstatic inline void update_rtt_min(struct westwood *w)\r\n{\r\nif (w->reset_rtt_min) {\r\nw->rtt_min = w->rtt;\r\nw->reset_rtt_min = 0;\r\n} else\r\nw->rtt_min = min(w->rtt, w->rtt_min);\r\n}\r\nstatic inline void westwood_fast_bw(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct westwood *w = inet_csk_ca(sk);\r\nwestwood_update_window(sk);\r\nw->bk += tp->snd_una - w->snd_una;\r\nw->snd_una = tp->snd_una;\r\nupdate_rtt_min(w);\r\n}\r\nstatic inline u32 westwood_acked_count(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct westwood *w = inet_csk_ca(sk);\r\nw->cumul_ack = tp->snd_una - w->snd_una;\r\nif (!w->cumul_ack) {\r\nw->accounted += tp->mss_cache;\r\nw->cumul_ack = tp->mss_cache;\r\n}\r\nif (w->cumul_ack > tp->mss_cache) {\r\nif (w->accounted >= w->cumul_ack) {\r\nw->accounted -= w->cumul_ack;\r\nw->cumul_ack = tp->mss_cache;\r\n} else {\r\nw->cumul_ack -= w->accounted;\r\nw->accounted = 0;\r\n}\r\n}\r\nw->snd_una = tp->snd_una;\r\nreturn w->cumul_ack;\r\n}\r\nstatic u32 tcp_westwood_bw_rttmin(const struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nconst struct westwood *w = inet_csk_ca(sk);\r\nreturn max_t(u32, (w->bw_est * w->rtt_min) / tp->mss_cache, 2);\r\n}\r\nstatic void tcp_westwood_event(struct sock *sk, enum tcp_ca_event event)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct westwood *w = inet_csk_ca(sk);\r\nswitch (event) {\r\ncase CA_EVENT_FAST_ACK:\r\nwestwood_fast_bw(sk);\r\nbreak;\r\ncase CA_EVENT_COMPLETE_CWR:\r\ntp->snd_cwnd = tp->snd_ssthresh = tcp_westwood_bw_rttmin(sk);\r\nbreak;\r\ncase CA_EVENT_FRTO:\r\ntp->snd_ssthresh = tcp_westwood_bw_rttmin(sk);\r\nw->reset_rtt_min = 1;\r\nbreak;\r\ncase CA_EVENT_SLOW_ACK:\r\nwestwood_update_window(sk);\r\nw->bk += westwood_acked_count(sk);\r\nupdate_rtt_min(w);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void tcp_westwood_info(struct sock *sk, u32 ext,\r\nstruct sk_buff *skb)\r\n{\r\nconst struct westwood *ca = inet_csk_ca(sk);\r\nif (ext & (1 << (INET_DIAG_VEGASINFO - 1))) {\r\nstruct tcpvegas_info info = {\r\n.tcpv_enabled = 1,\r\n.tcpv_rtt = jiffies_to_usecs(ca->rtt),\r\n.tcpv_minrtt = jiffies_to_usecs(ca->rtt_min),\r\n};\r\nnla_put(skb, INET_DIAG_VEGASINFO, sizeof(info), &info);\r\n}\r\n}\r\nstatic int __init tcp_westwood_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct westwood) > ICSK_CA_PRIV_SIZE);\r\nreturn tcp_register_congestion_control(&tcp_westwood);\r\n}\r\nstatic void __exit tcp_westwood_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&tcp_westwood);\r\n}

static irqreturn_t g2_dma_interrupt(int irq, void *dev_id)\r\n{\r\nint i;\r\nfor (i = 0; i < G2_NR_DMA_CHANNELS; i++) {\r\nif (g2_dma->status[i].status & 0x20000000) {\r\nunsigned int bytes = g2_bytes_remaining(i);\r\nif (likely(bytes == 0)) {\r\nstruct dma_info *info = dev_id;\r\nstruct dma_channel *chan = info->channels + i;\r\nwake_up(&chan->wait_queue);\r\nreturn IRQ_HANDLED;\r\n}\r\n}\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic int g2_enable_dma(struct dma_channel *chan)\r\n{\r\nunsigned int chan_nr = chan->chan;\r\ng2_dma->channel[chan_nr].chan_enable = 1;\r\ng2_dma->channel[chan_nr].xfer_enable = 1;\r\nreturn 0;\r\n}\r\nstatic int g2_disable_dma(struct dma_channel *chan)\r\n{\r\nunsigned int chan_nr = chan->chan;\r\ng2_dma->channel[chan_nr].chan_enable = 0;\r\ng2_dma->channel[chan_nr].xfer_enable = 0;\r\nreturn 0;\r\n}\r\nstatic int g2_xfer_dma(struct dma_channel *chan)\r\n{\r\nunsigned int chan_nr = chan->chan;\r\nif (chan->sar & 31) {\r\nprintk("g2dma: unaligned source 0x%lx\n", chan->sar);\r\nreturn -EINVAL;\r\n}\r\nif (chan->dar & 31) {\r\nprintk("g2dma: unaligned dest 0x%lx\n", chan->dar);\r\nreturn -EINVAL;\r\n}\r\nif (chan->count & 31)\r\nchan->count = (chan->count + (32 - 1)) & ~(32 - 1);\r\nchan->dar += 0xa0800000;\r\nchan->mode = !chan->mode;\r\nflush_icache_range((unsigned long)chan->sar, chan->count);\r\ng2_disable_dma(chan);\r\ng2_dma->channel[chan_nr].g2_addr = chan->dar & 0x1fffffe0;\r\ng2_dma->channel[chan_nr].root_addr = chan->sar & 0x1fffffe0;\r\ng2_dma->channel[chan_nr].size = (chan->count & ~31) | 0x80000000;\r\ng2_dma->channel[chan_nr].direction = chan->mode;\r\ng2_dma->channel[chan_nr].ctrl = 5;\r\ng2_enable_dma(chan);\r\npr_debug("count, sar, dar, mode, ctrl, chan, xfer: %ld, 0x%08lx, "\r\n"0x%08lx, %ld, %ld, %ld, %ld\n",\r\ng2_dma->channel[chan_nr].size,\r\ng2_dma->channel[chan_nr].root_addr,\r\ng2_dma->channel[chan_nr].g2_addr,\r\ng2_dma->channel[chan_nr].direction,\r\ng2_dma->channel[chan_nr].ctrl,\r\ng2_dma->channel[chan_nr].chan_enable,\r\ng2_dma->channel[chan_nr].xfer_enable);\r\nreturn 0;\r\n}\r\nstatic int g2_get_residue(struct dma_channel *chan)\r\n{\r\nreturn g2_bytes_remaining(chan->chan);\r\n}\r\nstatic int __init g2_dma_init(void)\r\n{\r\nint ret;\r\nret = request_irq(HW_EVENT_G2_DMA, g2_dma_interrupt, 0,\r\n"g2 DMA handler", &g2_dma_info);\r\nif (unlikely(ret))\r\nreturn -EINVAL;\r\ng2_dma->wait_state = 27;\r\ng2_dma->magic = 0x4659404f;\r\nret = register_dmac(&g2_dma_info);\r\nif (unlikely(ret != 0))\r\nfree_irq(HW_EVENT_G2_DMA, 0);\r\nreturn ret;\r\n}\r\nstatic void __exit g2_dma_exit(void)\r\n{\r\nfree_irq(HW_EVENT_G2_DMA, 0);\r\nunregister_dmac(&g2_dma_info);\r\n}

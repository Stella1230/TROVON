static\r\nsize_t i2400mu_rx_size_grow(struct i2400mu *i2400mu)\r\n{\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nsize_t rx_size;\r\nconst size_t max_pkt_size = 512;\r\nrx_size = 2 * i2400mu->rx_size;\r\nif (rx_size % max_pkt_size == 0) {\r\nrx_size -= 8;\r\nd_printf(1, dev,\r\n"RX: expected size grew to %zu [adjusted -8] "\r\n"from %zu\n",\r\nrx_size, i2400mu->rx_size);\r\n} else\r\nd_printf(1, dev,\r\n"RX: expected size grew to %zu from %zu\n",\r\nrx_size, i2400mu->rx_size);\r\nreturn rx_size;\r\n}\r\nstatic\r\nvoid i2400mu_rx_size_maybe_shrink(struct i2400mu *i2400mu)\r\n{\r\nconst size_t max_pkt_size = 512;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nif (unlikely(i2400mu->rx_size_cnt >= 100\r\n&& i2400mu->rx_size_auto_shrink)) {\r\nsize_t avg_rx_size =\r\ni2400mu->rx_size_acc / i2400mu->rx_size_cnt;\r\nsize_t new_rx_size = i2400mu->rx_size / 2;\r\nif (avg_rx_size < new_rx_size) {\r\nif (new_rx_size % max_pkt_size == 0) {\r\nnew_rx_size -= 8;\r\nd_printf(1, dev,\r\n"RX: expected size shrank to %zu "\r\n"[adjusted -8] from %zu\n",\r\nnew_rx_size, i2400mu->rx_size);\r\n} else\r\nd_printf(1, dev,\r\n"RX: expected size shrank to %zu "\r\n"from %zu\n",\r\nnew_rx_size, i2400mu->rx_size);\r\ni2400mu->rx_size = new_rx_size;\r\ni2400mu->rx_size_cnt = 0;\r\ni2400mu->rx_size_acc = i2400mu->rx_size;\r\n}\r\n}\r\n}\r\nstatic\r\nstruct sk_buff *i2400mu_rx(struct i2400mu *i2400mu, struct sk_buff *rx_skb)\r\n{\r\nint result = 0;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nint usb_pipe, read_size, rx_size, do_autopm;\r\nstruct usb_endpoint_descriptor *epd;\r\nconst size_t max_pkt_size = 512;\r\nd_fnstart(4, dev, "(i2400mu %p)\n", i2400mu);\r\ndo_autopm = atomic_read(&i2400mu->do_autopm);\r\nresult = do_autopm ?\r\nusb_autopm_get_interface(i2400mu->usb_iface) : 0;\r\nif (result < 0) {\r\ndev_err(dev, "RX: can't get autopm: %d\n", result);\r\ndo_autopm = 0;\r\n}\r\nepd = usb_get_epd(i2400mu->usb_iface, i2400mu->endpoint_cfg.bulk_in);\r\nusb_pipe = usb_rcvbulkpipe(i2400mu->usb_dev, epd->bEndpointAddress);\r\nretry:\r\nrx_size = skb_end_pointer(rx_skb) - rx_skb->data - rx_skb->len;\r\nif (unlikely(rx_size % max_pkt_size == 0)) {\r\nrx_size -= 8;\r\nd_printf(1, dev, "RX: rx_size adapted to %d [-8]\n", rx_size);\r\n}\r\nresult = usb_bulk_msg(\r\ni2400mu->usb_dev, usb_pipe, rx_skb->data + rx_skb->len,\r\nrx_size, &read_size, 200);\r\nusb_mark_last_busy(i2400mu->usb_dev);\r\nswitch (result) {\r\ncase 0:\r\nif (read_size == 0)\r\ngoto retry;\r\nskb_put(rx_skb, read_size);\r\nbreak;\r\ncase -EPIPE:\r\nif (edc_inc(&i2400mu->urb_edc,\r\n10 * EDC_MAX_ERRORS, EDC_ERROR_TIMEFRAME)) {\r\ndev_err(dev, "BM-CMD: too many stalls in "\r\n"URB; resetting device\n");\r\ngoto do_reset;\r\n}\r\nusb_clear_halt(i2400mu->usb_dev, usb_pipe);\r\nmsleep(10);\r\ngoto retry;\r\ncase -EINVAL:\r\ncase -ENODEV:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ncase -ECONNRESET:\r\nbreak;\r\ncase -EOVERFLOW: {\r\nstruct sk_buff *new_skb;\r\nrx_size = i2400mu_rx_size_grow(i2400mu);\r\nif (rx_size <= (1 << 16))\r\ni2400mu->rx_size = rx_size;\r\nelse if (printk_ratelimit()) {\r\ndev_err(dev, "BUG? rx_size up to %d\n", rx_size);\r\nresult = -EINVAL;\r\ngoto out;\r\n}\r\nskb_put(rx_skb, read_size);\r\nnew_skb = skb_copy_expand(rx_skb, 0, rx_size - rx_skb->len,\r\nGFP_KERNEL);\r\nif (new_skb == NULL) {\r\nif (printk_ratelimit())\r\ndev_err(dev, "RX: Can't reallocate skb to %d; "\r\n"RX dropped\n", rx_size);\r\nkfree_skb(rx_skb);\r\nrx_skb = NULL;\r\ngoto out;\r\n}\r\nkfree_skb(rx_skb);\r\nrx_skb = new_skb;\r\ni2400mu->rx_size_cnt = 0;\r\ni2400mu->rx_size_acc = i2400mu->rx_size;\r\nd_printf(1, dev, "RX: size changed to %d, received %d, "\r\n"copied %d, capacity %ld\n",\r\nrx_size, read_size, rx_skb->len,\r\n(long) (skb_end_pointer(new_skb) - new_skb->head));\r\ngoto retry;\r\n}\r\ncase -ETIMEDOUT:\r\ndev_err(dev, "RX: timeout: %d\n", result);\r\nresult = 0;\r\nbreak;\r\ndefault:\r\nif (edc_inc(&i2400mu->urb_edc,\r\nEDC_MAX_ERRORS, EDC_ERROR_TIMEFRAME))\r\ngoto error_reset;\r\ndev_err(dev, "RX: error receiving URB: %d, retrying\n", result);\r\ngoto retry;\r\n}\r\nout:\r\nif (do_autopm)\r\nusb_autopm_put_interface(i2400mu->usb_iface);\r\nd_fnend(4, dev, "(i2400mu %p) = %p\n", i2400mu, rx_skb);\r\nreturn rx_skb;\r\nerror_reset:\r\ndev_err(dev, "RX: maximum errors in URB exceeded; "\r\n"resetting device\n");\r\ndo_reset:\r\nusb_queue_reset_device(i2400mu->usb_iface);\r\nrx_skb = ERR_PTR(result);\r\ngoto out;\r\n}\r\nstatic\r\nint i2400mu_rxd(void *_i2400mu)\r\n{\r\nint result = 0;\r\nstruct i2400mu *i2400mu = _i2400mu;\r\nstruct i2400m *i2400m = &i2400mu->i2400m;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nstruct net_device *net_dev = i2400m->wimax_dev.net_dev;\r\nsize_t pending;\r\nint rx_size;\r\nstruct sk_buff *rx_skb;\r\nunsigned long flags;\r\nd_fnstart(4, dev, "(i2400mu %p)\n", i2400mu);\r\nspin_lock_irqsave(&i2400m->rx_lock, flags);\r\nBUG_ON(i2400mu->rx_kthread != NULL);\r\ni2400mu->rx_kthread = current;\r\nspin_unlock_irqrestore(&i2400m->rx_lock, flags);\r\nwhile (1) {\r\nd_printf(2, dev, "RX: waiting for messages\n");\r\npending = 0;\r\nwait_event_interruptible(\r\ni2400mu->rx_wq,\r\n(kthread_should_stop()\r\n|| (pending = atomic_read(&i2400mu->rx_pending_count)))\r\n);\r\nif (kthread_should_stop())\r\nbreak;\r\nif (pending == 0)\r\ncontinue;\r\nrx_size = i2400mu->rx_size;\r\nd_printf(2, dev, "RX: reading up to %d bytes\n", rx_size);\r\nrx_skb = __netdev_alloc_skb(net_dev, rx_size, GFP_KERNEL);\r\nif (rx_skb == NULL) {\r\ndev_err(dev, "RX: can't allocate skb [%d bytes]\n",\r\nrx_size);\r\nmsleep(50);\r\ncontinue;\r\n}\r\nrx_skb = i2400mu_rx(i2400mu, rx_skb);\r\nresult = PTR_ERR(rx_skb);\r\nif (IS_ERR(rx_skb))\r\ngoto out;\r\natomic_dec(&i2400mu->rx_pending_count);\r\nif (rx_skb == NULL || rx_skb->len == 0) {\r\nkfree_skb(rx_skb);\r\ncontinue;\r\n}\r\ni2400mu->rx_size_cnt++;\r\ni2400mu->rx_size_acc += rx_skb->len;\r\nresult = i2400m_rx(i2400m, rx_skb);\r\nif (result == -EIO\r\n&& edc_inc(&i2400mu->urb_edc,\r\nEDC_MAX_ERRORS, EDC_ERROR_TIMEFRAME)) {\r\ngoto error_reset;\r\n}\r\ni2400mu_rx_size_maybe_shrink(i2400mu);\r\n}\r\nresult = 0;\r\nout:\r\nspin_lock_irqsave(&i2400m->rx_lock, flags);\r\ni2400mu->rx_kthread = NULL;\r\nspin_unlock_irqrestore(&i2400m->rx_lock, flags);\r\nd_fnend(4, dev, "(i2400mu %p) = %d\n", i2400mu, result);\r\nreturn result;\r\nerror_reset:\r\ndev_err(dev, "RX: maximum errors in received buffer exceeded; "\r\n"resetting device\n");\r\nusb_queue_reset_device(i2400mu->usb_iface);\r\ngoto out;\r\n}\r\nvoid i2400mu_rx_kick(struct i2400mu *i2400mu)\r\n{\r\nstruct i2400m *i2400m = &i2400mu->i2400m;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nd_fnstart(3, dev, "(i2400mu %p)\n", i2400m);\r\natomic_inc(&i2400mu->rx_pending_count);\r\nwake_up_all(&i2400mu->rx_wq);\r\nd_fnend(3, dev, "(i2400m %p) = void\n", i2400m);\r\n}\r\nint i2400mu_rx_setup(struct i2400mu *i2400mu)\r\n{\r\nint result = 0;\r\nstruct i2400m *i2400m = &i2400mu->i2400m;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nstruct wimax_dev *wimax_dev = &i2400m->wimax_dev;\r\nstruct task_struct *kthread;\r\nkthread = kthread_run(i2400mu_rxd, i2400mu, "%s-rx",\r\nwimax_dev->name);\r\nif (IS_ERR(kthread)) {\r\nresult = PTR_ERR(kthread);\r\ndev_err(dev, "RX: cannot start thread: %d\n", result);\r\n}\r\nreturn result;\r\n}\r\nvoid i2400mu_rx_release(struct i2400mu *i2400mu)\r\n{\r\nunsigned long flags;\r\nstruct i2400m *i2400m = &i2400mu->i2400m;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct task_struct *kthread;\r\nspin_lock_irqsave(&i2400m->rx_lock, flags);\r\nkthread = i2400mu->rx_kthread;\r\ni2400mu->rx_kthread = NULL;\r\nspin_unlock_irqrestore(&i2400m->rx_lock, flags);\r\nif (kthread)\r\nkthread_stop(kthread);\r\nelse\r\nd_printf(1, dev, "RX: kthread had already exited\n");\r\n}

asmlinkage long\r\nsys_mmap2(unsigned long addr, unsigned long len, unsigned long prot,\r\nunsigned long flags, unsigned long fd, unsigned long pgoff)\r\n{\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd, pgoff);\r\n}\r\nasmlinkage long\r\nsys_mmap(unsigned long addr, unsigned long len, unsigned long prot,\r\nunsigned long flags, unsigned long fd, off_t offset)\r\n{\r\nif (unlikely(offset & ~PAGE_MASK))\r\nreturn -EINVAL;\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd, offset >> PAGE_SHIFT);\r\n}\r\nasmlinkage long\r\nscore_fork(struct pt_regs *regs)\r\n{\r\nreturn do_fork(SIGCHLD, regs->regs[0], regs, 0, NULL, NULL);\r\n}\r\nasmlinkage long\r\nscore_clone(struct pt_regs *regs)\r\n{\r\nunsigned long clone_flags;\r\nunsigned long newsp;\r\nint __user *parent_tidptr, *child_tidptr;\r\nclone_flags = regs->regs[4];\r\nnewsp = regs->regs[5];\r\nif (!newsp)\r\nnewsp = regs->regs[0];\r\nparent_tidptr = (int __user *)regs->regs[6];\r\nchild_tidptr = (int __user *)regs->regs[8];\r\nreturn do_fork(clone_flags, newsp, regs, 0,\r\nparent_tidptr, child_tidptr);\r\n}\r\nasmlinkage long\r\nscore_vfork(struct pt_regs *regs)\r\n{\r\nreturn do_fork(CLONE_VFORK | CLONE_VM | SIGCHLD,\r\nregs->regs[0], regs, 0, NULL, NULL);\r\n}\r\nasmlinkage long\r\nscore_execve(struct pt_regs *regs)\r\n{\r\nint error;\r\nchar *filename;\r\nfilename = getname((char __user*)regs->regs[4]);\r\nerror = PTR_ERR(filename);\r\nif (IS_ERR(filename))\r\nreturn error;\r\nerror = do_execve(filename,\r\n(const char __user *const __user *)regs->regs[5],\r\n(const char __user *const __user *)regs->regs[6],\r\nregs);\r\nputname(filename);\r\nreturn error;\r\n}\r\nint kernel_execve(const char *filename,\r\nconst char *const argv[],\r\nconst char *const envp[])\r\n{\r\nregister unsigned long __r4 asm("r4") = (unsigned long) filename;\r\nregister unsigned long __r5 asm("r5") = (unsigned long) argv;\r\nregister unsigned long __r6 asm("r6") = (unsigned long) envp;\r\nregister unsigned long __r7 asm("r7");\r\n__asm__ __volatile__ (" \n"\r\n"ldi r27, %5 \n"\r\n"syscall \n"\r\n"mv %0, r4 \n"\r\n"mv %1, r7 \n"\r\n: "=&r" (__r4), "=r" (__r7)\r\n: "r" (__r4), "r" (__r5), "r" (__r6), "i" (__NR_execve)\r\n: "r8", "r9", "r10", "r11", "r22", "r23", "r24", "r25",\r\n"r26", "r27", "memory");\r\nif (__r7 == 0)\r\nreturn __r4;\r\nreturn -__r4;\r\n}

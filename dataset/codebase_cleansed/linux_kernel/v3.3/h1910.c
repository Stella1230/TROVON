static void h1910_hwcontrol(struct mtd_info *mtd, int cmd,\r\nunsigned int ctrl)\r\n{\r\nstruct nand_chip *chip = mtd->priv;\r\nif (cmd != NAND_CMD_NONE)\r\nwriteb(cmd, chip->IO_ADDR_W | ((ctrl & 0x6) << 1));\r\n}\r\nstatic int __init h1910_init(void)\r\n{\r\nstruct nand_chip *this;\r\nvoid __iomem *nandaddr;\r\nif (!machine_is_h1900())\r\nreturn -ENODEV;\r\nnandaddr = ioremap(0x08000000, 0x1000);\r\nif (!nandaddr) {\r\nprintk("Failed to ioremap nand flash.\n");\r\nreturn -ENOMEM;\r\n}\r\nh1910_nand_mtd = kmalloc(sizeof(struct mtd_info) + sizeof(struct nand_chip), GFP_KERNEL);\r\nif (!h1910_nand_mtd) {\r\nprintk("Unable to allocate h1910 NAND MTD device structure.\n");\r\niounmap((void *)nandaddr);\r\nreturn -ENOMEM;\r\n}\r\nthis = (struct nand_chip *)(&h1910_nand_mtd[1]);\r\nmemset(h1910_nand_mtd, 0, sizeof(struct mtd_info));\r\nmemset(this, 0, sizeof(struct nand_chip));\r\nh1910_nand_mtd->priv = this;\r\nh1910_nand_mtd->owner = THIS_MODULE;\r\nGPSR(37) = GPIO_bit(37);\r\nthis->IO_ADDR_R = nandaddr;\r\nthis->IO_ADDR_W = nandaddr;\r\nthis->cmd_ctrl = h1910_hwcontrol;\r\nthis->dev_ready = NULL;\r\nthis->chip_delay = 50;\r\nthis->ecc.mode = NAND_ECC_SOFT;\r\nthis->options = NAND_NO_AUTOINCR;\r\nif (nand_scan(h1910_nand_mtd, 1)) {\r\nprintk(KERN_NOTICE "No NAND device - returning -ENXIO\n");\r\nkfree(h1910_nand_mtd);\r\niounmap((void *)nandaddr);\r\nreturn -ENXIO;\r\n}\r\nmtd_device_parse_register(h1910_nand_mtd, NULL, 0,\r\npartition_info, NUM_PARTITIONS);\r\nreturn 0;\r\n}\r\nstatic void __exit h1910_cleanup(void)\r\n{\r\nstruct nand_chip *this = (struct nand_chip *)&h1910_nand_mtd[1];\r\nnand_release(h1910_nand_mtd);\r\niounmap((void *)this->IO_ADDR_W);\r\nkfree(h1910_nand_mtd);\r\n}

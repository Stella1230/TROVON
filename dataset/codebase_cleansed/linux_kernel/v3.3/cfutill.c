struct cflayer *cfutill_create(u8 channel_id, struct dev_info *dev_info)\r\n{\r\nstruct cfsrvl *util = kzalloc(sizeof(struct cfsrvl), GFP_ATOMIC);\r\nif (!util)\r\nreturn NULL;\r\ncaif_assert(offsetof(struct cfsrvl, layer) == 0);\r\ncfsrvl_init(util, channel_id, dev_info, true);\r\nutil->layer.receive = cfutill_receive;\r\nutil->layer.transmit = cfutill_transmit;\r\nsnprintf(util->layer.name, CAIF_LAYER_NAME_SZ - 1, "util1");\r\nreturn &util->layer;\r\n}\r\nstatic int cfutill_receive(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nu8 cmd = -1;\r\nstruct cfsrvl *service = container_obj(layr);\r\ncaif_assert(layr != NULL);\r\ncaif_assert(layr->up != NULL);\r\ncaif_assert(layr->up->receive != NULL);\r\ncaif_assert(layr->up->ctrlcmd != NULL);\r\nif (cfpkt_extr_head(pkt, &cmd, 1) < 0) {\r\npr_err("Packet is erroneous!\n");\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\nswitch (cmd) {\r\ncase UTIL_PAYLOAD:\r\nreturn layr->up->receive(layr->up, pkt);\r\ncase UTIL_FLOW_OFF:\r\nlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_OFF_IND, 0);\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ncase UTIL_FLOW_ON:\r\nlayr->ctrlcmd(layr, CAIF_CTRLCMD_FLOW_ON_IND, 0);\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ncase UTIL_REMOTE_SHUTDOWN:\r\npr_err("REMOTE SHUTDOWN REQUEST RECEIVED\n");\r\nlayr->ctrlcmd(layr, CAIF_CTRLCMD_REMOTE_SHUTDOWN_IND, 0);\r\nservice->open = false;\r\ncfpkt_destroy(pkt);\r\nreturn 0;\r\ndefault:\r\ncfpkt_destroy(pkt);\r\npr_warn("Unknown service control %d (0x%x)\n", cmd, cmd);\r\nreturn -EPROTO;\r\n}\r\n}\r\nstatic int cfutill_transmit(struct cflayer *layr, struct cfpkt *pkt)\r\n{\r\nu8 zero = 0;\r\nstruct caif_payload_info *info;\r\nint ret;\r\nstruct cfsrvl *service = container_obj(layr);\r\ncaif_assert(layr != NULL);\r\ncaif_assert(layr->dn != NULL);\r\ncaif_assert(layr->dn->transmit != NULL);\r\nif (!cfsrvl_ready(service, &ret))\r\nreturn ret;\r\ncfpkt_add_head(pkt, &zero, 1);\r\ninfo = cfpkt_info(pkt);\r\ninfo->channel_id = service->layer.id;\r\ninfo->hdr_len = 1;\r\ninfo->dev_info = &service->dev_info;\r\nreturn layr->dn->transmit(layr->dn, pkt);\r\n}

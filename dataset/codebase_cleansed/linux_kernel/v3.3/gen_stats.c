static inline int\r\ngnet_stats_copy(struct gnet_dump *d, int type, void *buf, int size)\r\n{\r\nNLA_PUT(d->skb, type, size, buf);\r\nreturn 0;\r\nnla_put_failure:\r\nspin_unlock_bh(d->lock);\r\nreturn -1;\r\n}\r\nint\r\ngnet_stats_start_copy_compat(struct sk_buff *skb, int type, int tc_stats_type,\r\nint xstats_type, spinlock_t *lock, struct gnet_dump *d)\r\n__acquires(lock)\r\n{\r\nmemset(d, 0, sizeof(*d));\r\nspin_lock_bh(lock);\r\nd->lock = lock;\r\nif (type)\r\nd->tail = (struct nlattr *)skb_tail_pointer(skb);\r\nd->skb = skb;\r\nd->compat_tc_stats = tc_stats_type;\r\nd->compat_xstats = xstats_type;\r\nif (d->tail)\r\nreturn gnet_stats_copy(d, type, NULL, 0);\r\nreturn 0;\r\n}\r\nint\r\ngnet_stats_start_copy(struct sk_buff *skb, int type, spinlock_t *lock,\r\nstruct gnet_dump *d)\r\n{\r\nreturn gnet_stats_start_copy_compat(skb, type, 0, 0, lock, d);\r\n}\r\nint\r\ngnet_stats_copy_basic(struct gnet_dump *d, struct gnet_stats_basic_packed *b)\r\n{\r\nif (d->compat_tc_stats) {\r\nd->tc_stats.bytes = b->bytes;\r\nd->tc_stats.packets = b->packets;\r\n}\r\nif (d->tail) {\r\nstruct gnet_stats_basic sb;\r\nmemset(&sb, 0, sizeof(sb));\r\nsb.bytes = b->bytes;\r\nsb.packets = b->packets;\r\nreturn gnet_stats_copy(d, TCA_STATS_BASIC, &sb, sizeof(sb));\r\n}\r\nreturn 0;\r\n}\r\nint\r\ngnet_stats_copy_rate_est(struct gnet_dump *d,\r\nconst struct gnet_stats_basic_packed *b,\r\nstruct gnet_stats_rate_est *r)\r\n{\r\nif (b && !gen_estimator_active(b, r))\r\nreturn 0;\r\nif (d->compat_tc_stats) {\r\nd->tc_stats.bps = r->bps;\r\nd->tc_stats.pps = r->pps;\r\n}\r\nif (d->tail)\r\nreturn gnet_stats_copy(d, TCA_STATS_RATE_EST, r, sizeof(*r));\r\nreturn 0;\r\n}\r\nint\r\ngnet_stats_copy_queue(struct gnet_dump *d, struct gnet_stats_queue *q)\r\n{\r\nif (d->compat_tc_stats) {\r\nd->tc_stats.drops = q->drops;\r\nd->tc_stats.qlen = q->qlen;\r\nd->tc_stats.backlog = q->backlog;\r\nd->tc_stats.overlimits = q->overlimits;\r\n}\r\nif (d->tail)\r\nreturn gnet_stats_copy(d, TCA_STATS_QUEUE, q, sizeof(*q));\r\nreturn 0;\r\n}\r\nint\r\ngnet_stats_copy_app(struct gnet_dump *d, void *st, int len)\r\n{\r\nif (d->compat_xstats) {\r\nd->xstats = st;\r\nd->xstats_len = len;\r\n}\r\nif (d->tail)\r\nreturn gnet_stats_copy(d, TCA_STATS_APP, st, len);\r\nreturn 0;\r\n}\r\nint\r\ngnet_stats_finish_copy(struct gnet_dump *d)\r\n{\r\nif (d->tail)\r\nd->tail->nla_len = skb_tail_pointer(d->skb) - (u8 *)d->tail;\r\nif (d->compat_tc_stats)\r\nif (gnet_stats_copy(d, d->compat_tc_stats, &d->tc_stats,\r\nsizeof(d->tc_stats)) < 0)\r\nreturn -1;\r\nif (d->compat_xstats && d->xstats) {\r\nif (gnet_stats_copy(d, d->compat_xstats, d->xstats,\r\nd->xstats_len) < 0)\r\nreturn -1;\r\n}\r\nspin_unlock_bh(d->lock);\r\nreturn 0;\r\n}

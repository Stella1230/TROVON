static irqreturn_t hub_eint_handler(int irq, void *arg)\r\n{\r\nstruct hubdev_info *hubdev_info;\r\nstruct ia64_sal_retval ret_stuff;\r\nnasid_t nasid;\r\nret_stuff.status = 0;\r\nret_stuff.v0 = 0;\r\nhubdev_info = (struct hubdev_info *)arg;\r\nnasid = hubdev_info->hdi_nasid;\r\nif (is_shub1()) {\r\nSAL_CALL_NOLOCK(ret_stuff, SN_SAL_HUB_ERROR_INTERRUPT,\r\n(u64) nasid, 0, 0, 0, 0, 0, 0);\r\nif ((int)ret_stuff.v0)\r\npanic("%s: Fatal %s Error", __func__,\r\n((nasid & 1) ? "TIO" : "HUBII"));\r\nif (!(nasid & 1))\r\n(void)hubiio_crb_error_handler(hubdev_info);\r\n} else\r\nif (nasid & 1) {\r\nSAL_CALL_NOLOCK(ret_stuff, SN_SAL_HUB_ERROR_INTERRUPT,\r\n(u64) nasid, 0, 0, 0, 0, 0, 0);\r\nif ((int)ret_stuff.v0)\r\npanic("%s: Fatal TIO Error", __func__);\r\n} else\r\nbte_error_handler((unsigned long)NODEPDA(nasid_to_cnodeid(nasid)));\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid hubiio_crb_free(struct hubdev_info *hubdev_info, int crbnum)\r\n{\r\nii_icrb0_b_u_t icrbb;\r\nicrbb.ii_icrb0_b_regval = REMOTE_HUB_L(hubdev_info->hdi_nasid,\r\nIIO_ICRB_B(crbnum));\r\nicrbb.b_mark = 0;\r\nREMOTE_HUB_S(hubdev_info->hdi_nasid, IIO_ICRB_B(crbnum),\r\nicrbb.ii_icrb0_b_regval);\r\nREMOTE_HUB_S(hubdev_info->hdi_nasid, IIO_ICDR, (IIO_ICDR_PND | crbnum));\r\nwhile (REMOTE_HUB_L(hubdev_info->hdi_nasid, IIO_ICDR) & IIO_ICDR_PND)\r\ncpu_relax();\r\n}\r\nvoid hubiio_crb_error_handler(struct hubdev_info *hubdev_info)\r\n{\r\nnasid_t nasid;\r\nii_icrb0_a_u_t icrba;\r\nii_icrb0_b_u_t icrbb;\r\nii_icrb0_c_u_t icrbc;\r\nii_icrb0_d_u_t icrbd;\r\nii_icrb0_e_u_t icrbe;\r\nint i;\r\nint num_errors = 0;\r\nioerror_t ioerror;\r\nnasid = hubdev_info->hdi_nasid;\r\nfor (i = 0; i < IIO_NUM_CRBS; i++) {\r\nicrbb.ii_icrb0_b_regval = REMOTE_HUB_L(nasid, IIO_ICRB_B(i));\r\nif (icrbb.b_mark == 0) {\r\ncontinue;\r\n}\r\nicrba.ii_icrb0_a_regval = REMOTE_HUB_L(nasid, IIO_ICRB_A(i));\r\nIOERROR_INIT(&ioerror);\r\nicrbc.ii_icrb0_c_regval = REMOTE_HUB_L(nasid, IIO_ICRB_C(i));\r\nicrbd.ii_icrb0_d_regval = REMOTE_HUB_L(nasid, IIO_ICRB_D(i));\r\nicrbe.ii_icrb0_e_regval = REMOTE_HUB_L(nasid, IIO_ICRB_E(i));\r\nIOERROR_SETVALUE(&ioerror, errortype, icrbb.b_ecode);\r\nif (icrbd.d_bteop ||\r\n((icrbb.b_initiator == IIO_ICRB_INIT_BTE0 ||\r\nicrbb.b_initiator == IIO_ICRB_INIT_BTE1) &&\r\n(icrbb.b_imsgtype == IIO_ICRB_IMSGT_BTE ||\r\nicrbb.b_imsgtype == IIO_ICRB_IMSGT_SN1NET))) {\r\nint bte_num;\r\nif (icrbd.d_bteop)\r\nbte_num = icrbc.c_btenum;\r\nelse\r\nbte_num = (icrbb.b_initiator & 0x4) >> 2;\r\nhubiio_crb_free(hubdev_info, i);\r\nbte_crb_error_handler(nasid_to_cnodeid(nasid), bte_num,\r\ni, &ioerror, icrbd.d_bteop);\r\nnum_errors++;\r\ncontinue;\r\n}\r\n}\r\n}\r\nvoid hub_error_init(struct hubdev_info *hubdev_info)\r\n{\r\nif (request_irq(SGI_II_ERROR, hub_eint_handler, IRQF_SHARED,\r\n"SN_hub_error", hubdev_info)) {\r\nprintk(KERN_ERR "hub_error_init: Failed to request_irq for 0x%p\n",\r\nhubdev_info);\r\nreturn;\r\n}\r\nsn_set_err_irq_affinity(SGI_II_ERROR);\r\n}\r\nvoid ice_error_init(struct hubdev_info *hubdev_info)\r\n{\r\nif (request_irq\r\n(SGI_TIO_ERROR, (void *)hub_eint_handler, IRQF_SHARED, "SN_TIO_error",\r\n(void *)hubdev_info)) {\r\nprintk("ice_error_init: request_irq() error hubdev_info 0x%p\n",\r\nhubdev_info);\r\nreturn;\r\n}\r\nsn_set_err_irq_affinity(SGI_TIO_ERROR);\r\n}

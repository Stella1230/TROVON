static int perf_ibs_init(struct perf_event *event)\r\n{\r\nif (perf_ibs.type != event->attr.type)\r\nreturn -ENOENT;\r\nreturn 0;\r\n}\r\nstatic int perf_ibs_add(struct perf_event *event, int flags)\r\n{\r\nreturn 0;\r\n}\r\nstatic void perf_ibs_del(struct perf_event *event, int flags)\r\n{\r\n}\r\nstatic __init int perf_event_ibs_init(void)\r\n{\r\nif (!ibs_caps)\r\nreturn -ENODEV;\r\nperf_pmu_register(&perf_ibs, "ibs", -1);\r\nprintk(KERN_INFO "perf: AMD IBS detected (0x%08x)\n", ibs_caps);\r\nreturn 0;\r\n}\r\nstatic __init int perf_event_ibs_init(void) { return 0; }\r\nstatic __init u32 __get_ibs_caps(void)\r\n{\r\nu32 caps;\r\nunsigned int max_level;\r\nif (!boot_cpu_has(X86_FEATURE_IBS))\r\nreturn 0;\r\nmax_level = cpuid_eax(0x80000000);\r\nif (max_level < IBS_CPUID_FEATURES)\r\nreturn IBS_CAPS_DEFAULT;\r\ncaps = cpuid_eax(IBS_CPUID_FEATURES);\r\nif (!(caps & IBS_CAPS_AVAIL))\r\nreturn IBS_CAPS_DEFAULT;\r\nreturn caps;\r\n}\r\nu32 get_ibs_caps(void)\r\n{\r\nreturn ibs_caps;\r\n}\r\nstatic inline int get_eilvt(int offset)\r\n{\r\nreturn !setup_APIC_eilvt(offset, 0, APIC_EILVT_MSG_NMI, 1);\r\n}\r\nstatic inline int put_eilvt(int offset)\r\n{\r\nreturn !setup_APIC_eilvt(offset, 0, 0, 1);\r\n}\r\nstatic inline int ibs_eilvt_valid(void)\r\n{\r\nint offset;\r\nu64 val;\r\nint valid = 0;\r\npreempt_disable();\r\nrdmsrl(MSR_AMD64_IBSCTL, val);\r\noffset = val & IBSCTL_LVT_OFFSET_MASK;\r\nif (!(val & IBSCTL_LVT_OFFSET_VALID)) {\r\npr_err(FW_BUG "cpu %d, invalid IBS interrupt offset %d (MSR%08X=0x%016llx)\n",\r\nsmp_processor_id(), offset, MSR_AMD64_IBSCTL, val);\r\ngoto out;\r\n}\r\nif (!get_eilvt(offset)) {\r\npr_err(FW_BUG "cpu %d, IBS interrupt offset %d not available (MSR%08X=0x%016llx)\n",\r\nsmp_processor_id(), offset, MSR_AMD64_IBSCTL, val);\r\ngoto out;\r\n}\r\nvalid = 1;\r\nout:\r\npreempt_enable();\r\nreturn valid;\r\n}\r\nstatic int setup_ibs_ctl(int ibs_eilvt_off)\r\n{\r\nstruct pci_dev *cpu_cfg;\r\nint nodes;\r\nu32 value = 0;\r\nnodes = 0;\r\ncpu_cfg = NULL;\r\ndo {\r\ncpu_cfg = pci_get_device(PCI_VENDOR_ID_AMD,\r\nPCI_DEVICE_ID_AMD_10H_NB_MISC,\r\ncpu_cfg);\r\nif (!cpu_cfg)\r\nbreak;\r\n++nodes;\r\npci_write_config_dword(cpu_cfg, IBSCTL, ibs_eilvt_off\r\n| IBSCTL_LVT_OFFSET_VALID);\r\npci_read_config_dword(cpu_cfg, IBSCTL, &value);\r\nif (value != (ibs_eilvt_off | IBSCTL_LVT_OFFSET_VALID)) {\r\npci_dev_put(cpu_cfg);\r\nprintk(KERN_DEBUG "Failed to setup IBS LVT offset, "\r\n"IBSCTL = 0x%08x\n", value);\r\nreturn -EINVAL;\r\n}\r\n} while (1);\r\nif (!nodes) {\r\nprintk(KERN_DEBUG "No CPU node configured for IBS\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int force_ibs_eilvt_setup(void)\r\n{\r\nint offset;\r\nint ret;\r\npreempt_disable();\r\nfor (offset = 1; offset < APIC_EILVT_NR_MAX; offset++) {\r\nif (get_eilvt(offset))\r\nbreak;\r\n}\r\npreempt_enable();\r\nif (offset == APIC_EILVT_NR_MAX) {\r\nprintk(KERN_DEBUG "No EILVT entry available\n");\r\nreturn -EBUSY;\r\n}\r\nret = setup_ibs_ctl(offset);\r\nif (ret)\r\ngoto out;\r\nif (!ibs_eilvt_valid()) {\r\nret = -EFAULT;\r\ngoto out;\r\n}\r\npr_info("IBS: LVT offset %d assigned\n", offset);\r\nreturn 0;\r\nout:\r\npreempt_disable();\r\nput_eilvt(offset);\r\npreempt_enable();\r\nreturn ret;\r\n}\r\nstatic inline int get_ibs_lvt_offset(void)\r\n{\r\nu64 val;\r\nrdmsrl(MSR_AMD64_IBSCTL, val);\r\nif (!(val & IBSCTL_LVT_OFFSET_VALID))\r\nreturn -EINVAL;\r\nreturn val & IBSCTL_LVT_OFFSET_MASK;\r\n}\r\nstatic void setup_APIC_ibs(void *dummy)\r\n{\r\nint offset;\r\noffset = get_ibs_lvt_offset();\r\nif (offset < 0)\r\ngoto failed;\r\nif (!setup_APIC_eilvt(offset, 0, APIC_EILVT_MSG_NMI, 0))\r\nreturn;\r\nfailed:\r\npr_warn("perf: IBS APIC setup failed on cpu #%d\n",\r\nsmp_processor_id());\r\n}\r\nstatic void clear_APIC_ibs(void *dummy)\r\n{\r\nint offset;\r\noffset = get_ibs_lvt_offset();\r\nif (offset >= 0)\r\nsetup_APIC_eilvt(offset, 0, APIC_EILVT_MSG_FIX, 1);\r\n}\r\nstatic int __cpuinit\r\nperf_ibs_cpu_notifier(struct notifier_block *self, unsigned long action, void *hcpu)\r\n{\r\nswitch (action & ~CPU_TASKS_FROZEN) {\r\ncase CPU_STARTING:\r\nsetup_APIC_ibs(NULL);\r\nbreak;\r\ncase CPU_DYING:\r\nclear_APIC_ibs(NULL);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic __init int amd_ibs_init(void)\r\n{\r\nu32 caps;\r\nint ret = -EINVAL;\r\ncaps = __get_ibs_caps();\r\nif (!caps)\r\nreturn -ENODEV;\r\nif (boot_cpu_data.x86 == 0x10)\r\nforce_ibs_eilvt_setup();\r\nif (!ibs_eilvt_valid())\r\ngoto out;\r\nget_online_cpus();\r\nibs_caps = caps;\r\nsmp_mb();\r\nperf_cpu_notifier(perf_ibs_cpu_notifier);\r\nsmp_call_function(setup_APIC_ibs, NULL, 1);\r\nput_online_cpus();\r\nret = perf_event_ibs_init();\r\nout:\r\nif (ret)\r\npr_err("Failed to setup IBS, %d\n", ret);\r\nreturn ret;\r\n}

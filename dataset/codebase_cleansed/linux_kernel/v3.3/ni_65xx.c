static inline unsigned Port_Data(unsigned port)\r\n{\r\nreturn 0x40 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Port_Select(unsigned port)\r\n{\r\nreturn 0x41 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Rising_Edge_Detection_Enable(unsigned port)\r\n{\r\nreturn 0x42 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Falling_Edge_Detection_Enable(unsigned port)\r\n{\r\nreturn 0x43 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Filter_Enable(unsigned port)\r\n{\r\nreturn 0x44 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline const struct ni_65xx_board *board(struct comedi_device *dev)\r\n{\r\nreturn dev->board_ptr;\r\n}\r\nstatic inline unsigned ni_65xx_port_by_channel(unsigned channel)\r\n{\r\nreturn channel / ni_65xx_channels_per_port;\r\n}\r\nstatic inline unsigned ni_65xx_total_num_ports(const struct ni_65xx_board\r\n*board)\r\n{\r\nreturn board->num_dio_ports + board->num_di_ports + board->num_do_ports;\r\n}\r\nstatic inline struct ni_65xx_private *private(struct comedi_device *dev)\r\n{\r\nreturn dev->private;\r\n}\r\nstatic inline struct ni_65xx_subdevice_private *sprivate(struct comedi_subdevice\r\n*subdev)\r\n{\r\nreturn subdev->private;\r\n}\r\nstatic struct ni_65xx_subdevice_private *ni_65xx_alloc_subdevice_private(void)\r\n{\r\nstruct ni_65xx_subdevice_private *subdev_private =\r\nkzalloc(sizeof(struct ni_65xx_subdevice_private), GFP_KERNEL);\r\nif (subdev_private == NULL)\r\nreturn NULL;\r\nreturn subdev_private;\r\n}\r\nstatic int ni_65xx_config_filter(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nconst unsigned chan = CR_CHAN(insn->chanspec);\r\nconst unsigned port =\r\nsprivate(s)->base_port + ni_65xx_port_by_channel(chan);\r\nif (data[0] != INSN_CONFIG_FILTER)\r\nreturn -EINVAL;\r\nif (data[1]) {\r\nstatic const unsigned filter_resolution_ns = 200;\r\nstatic const unsigned max_filter_interval = 0xfffff;\r\nunsigned interval =\r\n(data[1] +\r\n(filter_resolution_ns / 2)) / filter_resolution_ns;\r\nif (interval > max_filter_interval)\r\ninterval = max_filter_interval;\r\ndata[1] = interval * filter_resolution_ns;\r\nif (interval != private(dev)->filter_interval) {\r\nwriteb(interval,\r\nprivate(dev)->mite->daq_io_addr +\r\nFilter_Interval);\r\nprivate(dev)->filter_interval = interval;\r\n}\r\nprivate(dev)->filter_enable[port] |=\r\n1 << (chan % ni_65xx_channels_per_port);\r\n} else {\r\nprivate(dev)->filter_enable[port] &=\r\n~(1 << (chan % ni_65xx_channels_per_port));\r\n}\r\nwriteb(private(dev)->filter_enable[port],\r\nprivate(dev)->mite->daq_io_addr + Filter_Enable(port));\r\nreturn 2;\r\n}\r\nstatic int ni_65xx_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned port;\r\nif (insn->n < 1)\r\nreturn -EINVAL;\r\nport = sprivate(s)->base_port +\r\nni_65xx_port_by_channel(CR_CHAN(insn->chanspec));\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_FILTER:\r\nreturn ni_65xx_config_filter(dev, s, insn, data);\r\nbreak;\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\nif (s->type != COMEDI_SUBD_DIO)\r\nreturn -EINVAL;\r\nprivate(dev)->dio_direction[port] = COMEDI_OUTPUT;\r\nwriteb(0, private(dev)->mite->daq_io_addr + Port_Select(port));\r\nreturn 1;\r\nbreak;\r\ncase INSN_CONFIG_DIO_INPUT:\r\nif (s->type != COMEDI_SUBD_DIO)\r\nreturn -EINVAL;\r\nprivate(dev)->dio_direction[port] = COMEDI_INPUT;\r\nwriteb(1, private(dev)->mite->daq_io_addr + Port_Select(port));\r\nreturn 1;\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\nif (s->type != COMEDI_SUBD_DIO)\r\nreturn -EINVAL;\r\ndata[1] = private(dev)->dio_direction[port];\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ni_65xx_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned base_bitfield_channel;\r\nconst unsigned max_ports_per_bitfield = 5;\r\nunsigned read_bits = 0;\r\nunsigned j;\r\nif (insn->n != 2)\r\nreturn -EINVAL;\r\nbase_bitfield_channel = CR_CHAN(insn->chanspec);\r\nfor (j = 0; j < max_ports_per_bitfield; ++j) {\r\nconst unsigned port_offset =\r\nni_65xx_port_by_channel(base_bitfield_channel) + j;\r\nconst unsigned port =\r\nsprivate(s)->base_port + port_offset;\r\nunsigned base_port_channel;\r\nunsigned port_mask, port_data, port_read_bits;\r\nint bitshift;\r\nif (port >= ni_65xx_total_num_ports(board(dev)))\r\nbreak;\r\nbase_port_channel = port_offset * ni_65xx_channels_per_port;\r\nport_mask = data[0];\r\nport_data = data[1];\r\nbitshift = base_port_channel - base_bitfield_channel;\r\nif (bitshift >= 32 || bitshift <= -32)\r\nbreak;\r\nif (bitshift > 0) {\r\nport_mask >>= bitshift;\r\nport_data >>= bitshift;\r\n} else {\r\nport_mask <<= -bitshift;\r\nport_data <<= -bitshift;\r\n}\r\nport_mask &= 0xff;\r\nport_data &= 0xff;\r\nif (port_mask) {\r\nunsigned bits;\r\nprivate(dev)->output_bits[port] &= ~port_mask;\r\nprivate(dev)->output_bits[port] |=\r\nport_data & port_mask;\r\nbits = private(dev)->output_bits[port];\r\nif (board(dev)->invert_outputs)\r\nbits = ~bits;\r\nwriteb(bits,\r\nprivate(dev)->mite->daq_io_addr +\r\nPort_Data(port));\r\n}\r\nport_read_bits =\r\nreadb(private(dev)->mite->daq_io_addr + Port_Data(port));\r\nif (s->type == COMEDI_SUBD_DO && board(dev)->invert_outputs) {\r\nport_read_bits ^= 0xFF;\r\n}\r\nif (bitshift > 0)\r\nport_read_bits <<= bitshift;\r\nelse\r\nport_read_bits >>= -bitshift;\r\nread_bits |= port_read_bits;\r\n}\r\ndata[1] = read_bits;\r\nreturn insn->n;\r\n}\r\nstatic irqreturn_t ni_65xx_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct comedi_subdevice *s = dev->subdevices + 2;\r\nunsigned int status;\r\nstatus = readb(private(dev)->mite->daq_io_addr + Change_Status);\r\nif ((status & MasterInterruptStatus) == 0)\r\nreturn IRQ_NONE;\r\nif ((status & EdgeStatus) == 0)\r\nreturn IRQ_NONE;\r\nwriteb(ClrEdge | ClrOverflow,\r\nprivate(dev)->mite->daq_io_addr + Clear_Register);\r\ncomedi_buf_put(s->async, 0);\r\ns->async->events |= COMEDI_CB_EOS;\r\ncomedi_event(dev, s);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ni_65xx_intr_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nint tmp;\r\ntmp = cmd->start_src;\r\ncmd->start_src &= TRIG_NOW;\r\nif (!cmd->start_src || tmp != cmd->start_src)\r\nerr++;\r\ntmp = cmd->scan_begin_src;\r\ncmd->scan_begin_src &= TRIG_OTHER;\r\nif (!cmd->scan_begin_src || tmp != cmd->scan_begin_src)\r\nerr++;\r\ntmp = cmd->convert_src;\r\ncmd->convert_src &= TRIG_FOLLOW;\r\nif (!cmd->convert_src || tmp != cmd->convert_src)\r\nerr++;\r\ntmp = cmd->scan_end_src;\r\ncmd->scan_end_src &= TRIG_COUNT;\r\nif (!cmd->scan_end_src || tmp != cmd->scan_end_src)\r\nerr++;\r\ntmp = cmd->stop_src;\r\ncmd->stop_src &= TRIG_COUNT;\r\nif (!cmd->stop_src || tmp != cmd->stop_src)\r\nerr++;\r\nif (err)\r\nreturn 1;\r\nif (err)\r\nreturn 2;\r\nif (cmd->start_arg != 0) {\r\ncmd->start_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->scan_begin_arg != 0) {\r\ncmd->scan_begin_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->convert_arg != 0) {\r\ncmd->convert_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->scan_end_arg != 1) {\r\ncmd->scan_end_arg = 1;\r\nerr++;\r\n}\r\nif (cmd->stop_arg != 0) {\r\ncmd->stop_arg = 0;\r\nerr++;\r\n}\r\nif (err)\r\nreturn 3;\r\nif (err)\r\nreturn 4;\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_intr_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nwriteb(ClrEdge | ClrOverflow,\r\nprivate(dev)->mite->daq_io_addr + Clear_Register);\r\nwriteb(FallingEdgeIntEnable | RisingEdgeIntEnable |\r\nMasterInterruptEnable | EdgeIntEnable,\r\nprivate(dev)->mite->daq_io_addr + Master_Interrupt_Control);\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_intr_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nwriteb(0x00,\r\nprivate(dev)->mite->daq_io_addr + Master_Interrupt_Control);\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_intr_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (insn->n < 1)\r\nreturn -EINVAL;\r\ndata[1] = 0;\r\nreturn 2;\r\n}\r\nstatic int ni_65xx_intr_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nif (insn->n < 1)\r\nreturn -EINVAL;\r\nif (data[0] != INSN_CONFIG_CHANGE_NOTIFY)\r\nreturn -EINVAL;\r\nwriteb(data[1],\r\nprivate(dev)->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0));\r\nwriteb(data[1] >> 8,\r\nprivate(dev)->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0x10));\r\nwriteb(data[1] >> 16,\r\nprivate(dev)->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0x20));\r\nwriteb(data[1] >> 24,\r\nprivate(dev)->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0x30));\r\nwriteb(data[2],\r\nprivate(dev)->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0));\r\nwriteb(data[2] >> 8,\r\nprivate(dev)->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0x10));\r\nwriteb(data[2] >> 16,\r\nprivate(dev)->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0x20));\r\nwriteb(data[2] >> 24,\r\nprivate(dev)->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0x30));\r\nreturn 2;\r\n}\r\nstatic int ni_65xx_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nunsigned i;\r\nint ret;\r\nprintk(KERN_INFO "comedi%d: ni_65xx:", dev->minor);\r\nret = alloc_private(dev, sizeof(struct ni_65xx_private));\r\nif (ret < 0)\r\nreturn ret;\r\nret = ni_65xx_find_device(dev, it->options[0], it->options[1]);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mite_setup(private(dev)->mite);\r\nif (ret < 0) {\r\nprintk(KERN_WARNING "error setting up mite\n");\r\nreturn ret;\r\n}\r\ndev->board_name = board(dev)->name;\r\ndev->irq = mite_irq(private(dev)->mite);\r\nprintk(KERN_INFO " %s", dev->board_name);\r\nprintk(KERN_INFO " ID=0x%02x",\r\nreadb(private(dev)->mite->daq_io_addr + ID_Register));\r\nret = alloc_subdevices(dev, 4);\r\nif (ret < 0)\r\nreturn ret;\r\ns = dev->subdevices + 0;\r\nif (board(dev)->num_di_ports) {\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan =\r\nboard(dev)->num_di_ports * ni_65xx_channels_per_port;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_config = ni_65xx_dio_insn_config;\r\ns->insn_bits = ni_65xx_dio_insn_bits;\r\ns->private = ni_65xx_alloc_subdevice_private();\r\nif (s->private == NULL)\r\nreturn -ENOMEM;\r\nsprivate(s)->base_port = 0;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 1;\r\nif (board(dev)->num_do_ports) {\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan =\r\nboard(dev)->num_do_ports * ni_65xx_channels_per_port;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_bits = ni_65xx_dio_insn_bits;\r\ns->private = ni_65xx_alloc_subdevice_private();\r\nif (s->private == NULL)\r\nreturn -ENOMEM;\r\nsprivate(s)->base_port = board(dev)->num_di_ports;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 2;\r\nif (board(dev)->num_dio_ports) {\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan =\r\nboard(dev)->num_dio_ports * ni_65xx_channels_per_port;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_config = ni_65xx_dio_insn_config;\r\ns->insn_bits = ni_65xx_dio_insn_bits;\r\ns->private = ni_65xx_alloc_subdevice_private();\r\nif (s->private == NULL)\r\nreturn -ENOMEM;\r\nsprivate(s)->base_port = 0;\r\nfor (i = 0; i < board(dev)->num_dio_ports; ++i) {\r\nwriteb(0x1,\r\nprivate(dev)->mite->daq_io_addr +\r\nPort_Select(i));\r\n}\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 3;\r\ndev->read_subdev = s;\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE | SDF_CMD_READ;\r\ns->n_chan = 1;\r\ns->range_table = &range_unknown;\r\ns->maxdata = 1;\r\ns->do_cmdtest = ni_65xx_intr_cmdtest;\r\ns->do_cmd = ni_65xx_intr_cmd;\r\ns->cancel = ni_65xx_intr_cancel;\r\ns->insn_bits = ni_65xx_intr_insn_bits;\r\ns->insn_config = ni_65xx_intr_insn_config;\r\nfor (i = 0; i < ni_65xx_total_num_ports(board(dev)); ++i) {\r\nwriteb(0x00,\r\nprivate(dev)->mite->daq_io_addr + Filter_Enable(i));\r\nif (board(dev)->invert_outputs)\r\nwriteb(0x01,\r\nprivate(dev)->mite->daq_io_addr + Port_Data(i));\r\nelse\r\nwriteb(0x00,\r\nprivate(dev)->mite->daq_io_addr + Port_Data(i));\r\n}\r\nwriteb(ClrEdge | ClrOverflow,\r\nprivate(dev)->mite->daq_io_addr + Clear_Register);\r\nwriteb(0x00,\r\nprivate(dev)->mite->daq_io_addr + Master_Interrupt_Control);\r\nwriteb(0x00000000, private(dev)->mite->daq_io_addr + Filter_Interval);\r\nret = request_irq(dev->irq, ni_65xx_interrupt, IRQF_SHARED,\r\n"ni_65xx", dev);\r\nif (ret < 0) {\r\ndev->irq = 0;\r\nprintk(KERN_WARNING " irq not available");\r\n}\r\nprintk("\n");\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_detach(struct comedi_device *dev)\r\n{\r\nif (private(dev) && private(dev)->mite\r\n&& private(dev)->mite->daq_io_addr) {\r\nwriteb(0x00,\r\nprivate(dev)->mite->daq_io_addr +\r\nMaster_Interrupt_Control);\r\n}\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nif (private(dev)) {\r\nunsigned i;\r\nfor (i = 0; i < dev->n_subdevices; ++i) {\r\nkfree(dev->subdevices[i].private);\r\ndev->subdevices[i].private = NULL;\r\n}\r\nif (private(dev)->mite)\r\nmite_unsetup(private(dev)->mite);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_find_device(struct comedi_device *dev, int bus, int slot)\r\n{\r\nstruct mite_struct *mite;\r\nint i;\r\nfor (mite = mite_devices; mite; mite = mite->next) {\r\nif (mite->used)\r\ncontinue;\r\nif (bus || slot) {\r\nif (bus != mite->pcidev->bus->number ||\r\nslot != PCI_SLOT(mite->pcidev->devfn))\r\ncontinue;\r\n}\r\nfor (i = 0; i < n_ni_65xx_boards; i++) {\r\nif (mite_device_id(mite) == ni_65xx_boards[i].dev_id) {\r\ndev->board_ptr = ni_65xx_boards + i;\r\nprivate(dev)->mite = mite;\r\nreturn 0;\r\n}\r\n}\r\n}\r\nprintk(KERN_WARNING "no device found\n");\r\nmite_list_devices();\r\nreturn -EIO;\r\n}\r\nstatic int __devinit driver_ni_65xx_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_ni_65xx.driver_name);\r\n}\r\nstatic void __devexit driver_ni_65xx_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_ni_65xx_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_ni_65xx);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_ni_65xx_pci_driver.name = (char *)driver_ni_65xx.driver_name;\r\nreturn pci_register_driver(&driver_ni_65xx_pci_driver);\r\n}\r\nstatic void __exit driver_ni_65xx_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_ni_65xx_pci_driver);\r\ncomedi_driver_unregister(&driver_ni_65xx);\r\n}

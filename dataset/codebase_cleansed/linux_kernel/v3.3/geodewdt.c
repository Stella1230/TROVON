static void geodewdt_ping(void)\r\n{\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, 0);\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_COUNTER, 0);\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, MFGPT_SETUP_CNTEN);\r\n}\r\nstatic void geodewdt_disable(void)\r\n{\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, 0);\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_COUNTER, 0);\r\n}\r\nstatic int geodewdt_set_heartbeat(int val)\r\n{\r\nif (val < 1 || val > GEODEWDT_MAX_SECONDS)\r\nreturn -EINVAL;\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, 0);\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_CMP2, val * GEODEWDT_HZ);\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_COUNTER, 0);\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, MFGPT_SETUP_CNTEN);\r\ntimeout = val;\r\nreturn 0;\r\n}\r\nstatic int geodewdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(WDT_FLAGS_OPEN, &wdt_flags))\r\nreturn -EBUSY;\r\nif (!test_and_clear_bit(WDT_FLAGS_ORPHAN, &wdt_flags))\r\n__module_get(THIS_MODULE);\r\ngeodewdt_ping();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int geodewdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (safe_close) {\r\ngeodewdt_disable();\r\nmodule_put(THIS_MODULE);\r\n} else {\r\nprintk(KERN_CRIT "Unexpected close - watchdog is not stopping.\n");\r\ngeodewdt_ping();\r\nset_bit(WDT_FLAGS_ORPHAN, &wdt_flags);\r\n}\r\nclear_bit(WDT_FLAGS_OPEN, &wdt_flags);\r\nsafe_close = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t geodewdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nsafe_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nsafe_close = 1;\r\n}\r\n}\r\ngeodewdt_ping();\r\n}\r\nreturn len;\r\n}\r\nstatic long geodewdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nint interval;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING\r\n| WDIOF_MAGICCLOSE,\r\n.firmware_version = 1,\r\n.identity = WATCHDOG_NAME,\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint options, ret = -EINVAL;\r\nif (get_user(options, p))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD) {\r\ngeodewdt_disable();\r\nret = 0;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\ngeodewdt_ping();\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\ngeodewdt_ping();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(interval, p))\r\nreturn -EFAULT;\r\nif (geodewdt_set_heartbeat(interval))\r\nreturn -EINVAL;\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(timeout, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit geodewdt_probe(struct platform_device *dev)\r\n{\r\nint ret;\r\nwdt_timer = cs5535_mfgpt_alloc_timer(MFGPT_TIMER_ANY, MFGPT_DOMAIN_WORKING);\r\nif (!wdt_timer) {\r\nprintk(KERN_ERR "geodewdt: No timers were available\n");\r\nreturn -ENODEV;\r\n}\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP,\r\nGEODEWDT_SCALE | (3 << 8));\r\ncs5535_mfgpt_toggle_event(wdt_timer, MFGPT_CMP2, MFGPT_EVENT_RESET, 1);\r\ncs5535_mfgpt_write(wdt_timer, MFGPT_REG_CMP2,\r\ntimeout * GEODEWDT_HZ);\r\nret = misc_register(&geodewdt_miscdev);\r\nreturn ret;\r\n}\r\nstatic int __devexit geodewdt_remove(struct platform_device *dev)\r\n{\r\nmisc_deregister(&geodewdt_miscdev);\r\nreturn 0;\r\n}\r\nstatic void geodewdt_shutdown(struct platform_device *dev)\r\n{\r\ngeodewdt_disable();\r\n}\r\nstatic int __init geodewdt_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&geodewdt_driver);\r\nif (ret)\r\nreturn ret;\r\ngeodewdt_platform_device = platform_device_register_simple(DRV_NAME,\r\n-1, NULL, 0);\r\nif (IS_ERR(geodewdt_platform_device)) {\r\nret = PTR_ERR(geodewdt_platform_device);\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nplatform_driver_unregister(&geodewdt_driver);\r\nreturn ret;\r\n}\r\nstatic void __exit geodewdt_exit(void)\r\n{\r\nplatform_device_unregister(geodewdt_platform_device);\r\nplatform_driver_unregister(&geodewdt_driver);\r\n}

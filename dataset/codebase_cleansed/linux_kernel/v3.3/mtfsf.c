int\r\nmtfsf(unsigned int FM, u32 *frB)\r\n{\r\nu32 mask;\r\nu32 fpscr;\r\nif (FM == 0)\r\nreturn 0;\r\nif (FM == 0xff)\r\nmask = 0x9fffffff;\r\nelse {\r\nmask = 0;\r\nif (FM & (1 << 0))\r\nmask |= 0x90000000;\r\nif (FM & (1 << 1))\r\nmask |= 0x0f000000;\r\nif (FM & (1 << 2))\r\nmask |= 0x00f00000;\r\nif (FM & (1 << 3))\r\nmask |= 0x000f0000;\r\nif (FM & (1 << 4))\r\nmask |= 0x0000f000;\r\nif (FM & (1 << 5))\r\nmask |= 0x00000f00;\r\nif (FM & (1 << 6))\r\nmask |= 0x000000f0;\r\nif (FM & (1 << 7))\r\nmask |= 0x0000000f;\r\n}\r\n__FPU_FPSCR &= ~(mask);\r\n__FPU_FPSCR |= (frB[1] & mask);\r\n__FPU_FPSCR &= ~(FPSCR_VX);\r\nif (__FPU_FPSCR & (FPSCR_VXSNAN | FPSCR_VXISI | FPSCR_VXIDI |\r\nFPSCR_VXZDZ | FPSCR_VXIMZ | FPSCR_VXVC |\r\nFPSCR_VXSOFT | FPSCR_VXSQRT | FPSCR_VXCVI))\r\n__FPU_FPSCR |= FPSCR_VX;\r\nfpscr = __FPU_FPSCR;\r\nfpscr &= ~(FPSCR_FEX);\r\nif (((fpscr & FPSCR_VX) && (fpscr & FPSCR_VE)) ||\r\n((fpscr & FPSCR_OX) && (fpscr & FPSCR_OE)) ||\r\n((fpscr & FPSCR_UX) && (fpscr & FPSCR_UE)) ||\r\n((fpscr & FPSCR_ZX) && (fpscr & FPSCR_ZE)) ||\r\n((fpscr & FPSCR_XX) && (fpscr & FPSCR_XE)))\r\nfpscr |= FPSCR_FEX;\r\n__FPU_FPSCR = fpscr;\r\n#ifdef DEBUG\r\nprintk("%s: %02x %p: %08lx\n", __func__, FM, frB, __FPU_FPSCR);\r\n#endif\r\nreturn 0;\r\n}

void pq2_restart(char *cmd)\r\n{\r\nlocal_irq_disable();\r\nsetbits32(&cpm2_immr->im_clkrst.car_rmr, RMR_CSRE);\r\nmtmsr(mfmsr() & ~(MSR_ME | MSR_EE | MSR_IR | MSR_DR));\r\nin_8(&cpm2_immr->im_clkrst.res[0]);\r\npanic("Restart failed\n");\r\n}\r\nstatic int pq2_pci_exclude_device(struct pci_controller *hose,\r\nu_char bus, u8 devfn)\r\n{\r\nif (bus == 0 && PCI_SLOT(devfn) == 0)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nelse\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic void __init pq2_pci_add_bridge(struct device_node *np)\r\n{\r\nstruct pci_controller *hose;\r\nstruct resource r;\r\nif (of_address_to_resource(np, 0, &r) || r.end - r.start < 0x10b)\r\ngoto err;\r\npci_add_flags(PCI_REASSIGN_ALL_BUS);\r\nhose = pcibios_alloc_controller(np);\r\nif (!hose)\r\nreturn;\r\nhose->dn = np;\r\nsetup_indirect_pci(hose, r.start + 0x100, r.start + 0x104, 0);\r\npci_process_bridge_OF_ranges(hose, np, 1);\r\nreturn;\r\nerr:\r\nprintk(KERN_ERR "No valid PCI reg property in device tree\n");\r\n}\r\nvoid __init pq2_init_pci(void)\r\n{\r\nstruct device_node *np = NULL;\r\nppc_md.pci_exclude_device = pq2_pci_exclude_device;\r\nwhile ((np = of_find_compatible_node(np, NULL, "fsl,pq2-pci")))\r\npq2_pci_add_bridge(np);\r\n}

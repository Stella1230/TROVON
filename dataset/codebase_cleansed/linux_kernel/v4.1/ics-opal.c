static int ics_opal_mangle_server(int server)\r\n{\r\nreturn server << 2;\r\n}\r\nstatic int ics_opal_unmangle_server(int server)\r\n{\r\nreturn server >> 2;\r\n}\r\nstatic void ics_opal_unmask_irq(struct irq_data *d)\r\n{\r\nunsigned int hw_irq = (unsigned int)irqd_to_hwirq(d);\r\nint64_t rc;\r\nint server;\r\npr_devel("ics-hal: unmask virq %d [hw 0x%x]\n", d->irq, hw_irq);\r\nif (hw_irq == XICS_IPI || hw_irq == XICS_IRQ_SPURIOUS)\r\nreturn;\r\nserver = xics_get_irq_server(d->irq, d->affinity, 0);\r\nserver = ics_opal_mangle_server(server);\r\nrc = opal_set_xive(hw_irq, server, DEFAULT_PRIORITY);\r\nif (rc != OPAL_SUCCESS)\r\npr_err("%s: opal_set_xive(irq=%d [hw 0x%x] server=%x)"\r\n" error %lld\n",\r\n__func__, d->irq, hw_irq, server, rc);\r\n}\r\nstatic unsigned int ics_opal_startup(struct irq_data *d)\r\n{\r\n#ifdef CONFIG_PCI_MSI\r\nif (d->msi_desc)\r\npci_msi_unmask_irq(d);\r\n#endif\r\nics_opal_unmask_irq(d);\r\nreturn 0;\r\n}\r\nstatic void ics_opal_mask_real_irq(unsigned int hw_irq)\r\n{\r\nint server = ics_opal_mangle_server(xics_default_server);\r\nint64_t rc;\r\nif (hw_irq == XICS_IPI)\r\nreturn;\r\nrc = opal_set_xive(hw_irq, server, 0xff);\r\nif (rc != OPAL_SUCCESS)\r\npr_err("%s: opal_set_xive(0xff) irq=%u returned %lld\n",\r\n__func__, hw_irq, rc);\r\n}\r\nstatic void ics_opal_mask_irq(struct irq_data *d)\r\n{\r\nunsigned int hw_irq = (unsigned int)irqd_to_hwirq(d);\r\npr_devel("ics-hal: mask virq %d [hw 0x%x]\n", d->irq, hw_irq);\r\nif (hw_irq == XICS_IPI || hw_irq == XICS_IRQ_SPURIOUS)\r\nreturn;\r\nics_opal_mask_real_irq(hw_irq);\r\n}\r\nstatic int ics_opal_set_affinity(struct irq_data *d,\r\nconst struct cpumask *cpumask,\r\nbool force)\r\n{\r\nunsigned int hw_irq = (unsigned int)irqd_to_hwirq(d);\r\n__be16 oserver;\r\nint16_t server;\r\nint8_t priority;\r\nint64_t rc;\r\nint wanted_server;\r\nif (hw_irq == XICS_IPI || hw_irq == XICS_IRQ_SPURIOUS)\r\nreturn -1;\r\nrc = opal_get_xive(hw_irq, &oserver, &priority);\r\nif (rc != OPAL_SUCCESS) {\r\npr_err("%s: opal_get_xive(irq=%d [hw 0x%x]) error %lld\n",\r\n__func__, d->irq, hw_irq, rc);\r\nreturn -1;\r\n}\r\nserver = be16_to_cpu(oserver);\r\nwanted_server = xics_get_irq_server(d->irq, cpumask, 1);\r\nif (wanted_server < 0) {\r\npr_warning("%s: No online cpus in the mask %*pb for irq %d\n",\r\n__func__, cpumask_pr_args(cpumask), d->irq);\r\nreturn -1;\r\n}\r\nserver = ics_opal_mangle_server(wanted_server);\r\npr_devel("ics-hal: set-affinity irq %d [hw 0x%x] server: 0x%x/0x%x\n",\r\nd->irq, hw_irq, wanted_server, server);\r\nrc = opal_set_xive(hw_irq, server, priority);\r\nif (rc != OPAL_SUCCESS) {\r\npr_err("%s: opal_set_xive(irq=%d [hw 0x%x] server=%x)"\r\n" error %lld\n",\r\n__func__, d->irq, hw_irq, server, rc);\r\nreturn -1;\r\n}\r\nreturn IRQ_SET_MASK_OK;\r\n}\r\nstatic int ics_opal_host_match(struct ics *ics, struct device_node *node)\r\n{\r\nreturn 1;\r\n}\r\nstatic int ics_opal_map(struct ics *ics, unsigned int virq)\r\n{\r\nunsigned int hw_irq = (unsigned int)virq_to_hw(virq);\r\nint64_t rc;\r\n__be16 server;\r\nint8_t priority;\r\nif (WARN_ON(hw_irq == XICS_IPI || hw_irq == XICS_IRQ_SPURIOUS))\r\nreturn -EINVAL;\r\nrc = opal_get_xive(hw_irq, &server, &priority);\r\nif (rc != OPAL_SUCCESS)\r\nreturn -ENXIO;\r\nirq_set_chip_and_handler(virq, &ics_opal_irq_chip, handle_fasteoi_irq);\r\nirq_set_chip_data(virq, &ics_hal);\r\nreturn 0;\r\n}\r\nstatic void ics_opal_mask_unknown(struct ics *ics, unsigned long vec)\r\n{\r\nint64_t rc;\r\n__be16 server;\r\nint8_t priority;\r\nrc = opal_get_xive(vec, &server, &priority);\r\nif (rc != OPAL_SUCCESS)\r\nreturn;\r\nics_opal_mask_real_irq(vec);\r\n}\r\nstatic long ics_opal_get_server(struct ics *ics, unsigned long vec)\r\n{\r\nint64_t rc;\r\n__be16 server;\r\nint8_t priority;\r\nrc = opal_get_xive(vec, &server, &priority);\r\nif (rc != OPAL_SUCCESS)\r\nreturn -1;\r\nreturn ics_opal_unmangle_server(be16_to_cpu(server));\r\n}\r\nint __init ics_opal_init(void)\r\n{\r\nif (!firmware_has_feature(FW_FEATURE_OPAL))\r\nreturn -ENODEV;\r\nics_opal_irq_chip.irq_eoi = icp_ops->eoi;\r\nxics_register_ics(&ics_hal);\r\npr_info("ICS OPAL backend registered\n");\r\nreturn 0;\r\n}

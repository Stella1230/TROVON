static ssize_t available_uuids_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct int3400_thermal_priv *priv = platform_get_drvdata(pdev);\r\nint i;\r\nint length = 0;\r\nfor (i = 0; i < INT3400_THERMAL_MAXIMUM_UUID; i++) {\r\nif (priv->uuid_bitmap & (1 << i))\r\nif (PAGE_SIZE - length > 0)\r\nlength += snprintf(&buf[length],\r\nPAGE_SIZE - length,\r\n"%s\n",\r\nint3400_thermal_uuids[i]);\r\n}\r\nreturn length;\r\n}\r\nstatic ssize_t current_uuid_show(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct int3400_thermal_priv *priv = platform_get_drvdata(pdev);\r\nif (priv->uuid_bitmap & (1 << priv->current_uuid_index))\r\nreturn sprintf(buf, "%s\n",\r\nint3400_thermal_uuids[priv->current_uuid_index]);\r\nelse\r\nreturn sprintf(buf, "INVALID\n");\r\n}\r\nstatic ssize_t current_uuid_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct int3400_thermal_priv *priv = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0; i < INT3400_THERMAL_MAXIMUM_UUID; ++i) {\r\nif ((priv->uuid_bitmap & (1 << i)) &&\r\n!(strncmp(buf, int3400_thermal_uuids[i],\r\nsizeof(int3400_thermal_uuids[i]) - 1))) {\r\npriv->current_uuid_index = i;\r\nreturn count;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int int3400_thermal_get_uuids(struct int3400_thermal_priv *priv)\r\n{\r\nstruct acpi_buffer buf = { ACPI_ALLOCATE_BUFFER, NULL};\r\nunion acpi_object *obja, *objb;\r\nint i, j;\r\nint result = 0;\r\nacpi_status status;\r\nstatus = acpi_evaluate_object(priv->adev->handle, "IDSP", NULL, &buf);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nobja = (union acpi_object *)buf.pointer;\r\nif (obja->type != ACPI_TYPE_PACKAGE) {\r\nresult = -EINVAL;\r\ngoto end;\r\n}\r\nfor (i = 0; i < obja->package.count; i++) {\r\nobjb = &obja->package.elements[i];\r\nif (objb->type != ACPI_TYPE_BUFFER) {\r\nresult = -EINVAL;\r\ngoto end;\r\n}\r\nif (objb->buffer.length != 16) {\r\nresult = -EINVAL;\r\ngoto end;\r\n}\r\nfor (j = 0; j < INT3400_THERMAL_MAXIMUM_UUID; j++) {\r\nu8 uuid[16];\r\nacpi_str_to_uuid(int3400_thermal_uuids[j], uuid);\r\nif (!strncmp(uuid, objb->buffer.pointer, 16)) {\r\npriv->uuid_bitmap |= (1 << j);\r\nbreak;\r\n}\r\n}\r\n}\r\nend:\r\nkfree(buf.pointer);\r\nreturn result;\r\n}\r\nstatic int int3400_thermal_run_osc(acpi_handle handle,\r\nenum int3400_thermal_uuid uuid, bool enable)\r\n{\r\nu32 ret, buf[2];\r\nacpi_status status;\r\nint result = 0;\r\nstruct acpi_osc_context context = {\r\n.uuid_str = int3400_thermal_uuids[uuid],\r\n.rev = 1,\r\n.cap.length = 8,\r\n};\r\nbuf[OSC_QUERY_DWORD] = 0;\r\nbuf[OSC_SUPPORT_DWORD] = enable;\r\ncontext.cap.pointer = buf;\r\nstatus = acpi_run_osc(handle, &context);\r\nif (ACPI_SUCCESS(status)) {\r\nret = *((u32 *)(context.ret.pointer + 4));\r\nif (ret != enable)\r\nresult = -EPERM;\r\n} else\r\nresult = -EPERM;\r\nkfree(context.ret.pointer);\r\nreturn result;\r\n}\r\nstatic int int3400_thermal_get_temp(struct thermal_zone_device *thermal,\r\nunsigned long *temp)\r\n{\r\n*temp = 20 * 1000;\r\nreturn 0;\r\n}\r\nstatic int int3400_thermal_get_mode(struct thermal_zone_device *thermal,\r\nenum thermal_device_mode *mode)\r\n{\r\nstruct int3400_thermal_priv *priv = thermal->devdata;\r\nif (!priv)\r\nreturn -EINVAL;\r\n*mode = priv->mode;\r\nreturn 0;\r\n}\r\nstatic int int3400_thermal_set_mode(struct thermal_zone_device *thermal,\r\nenum thermal_device_mode mode)\r\n{\r\nstruct int3400_thermal_priv *priv = thermal->devdata;\r\nbool enable;\r\nint result = 0;\r\nif (!priv)\r\nreturn -EINVAL;\r\nif (mode == THERMAL_DEVICE_ENABLED)\r\nenable = true;\r\nelse if (mode == THERMAL_DEVICE_DISABLED)\r\nenable = false;\r\nelse\r\nreturn -EINVAL;\r\nif (enable != priv->mode) {\r\npriv->mode = enable;\r\nresult = int3400_thermal_run_osc(priv->adev->handle,\r\npriv->current_uuid_index,\r\nenable);\r\n}\r\nreturn result;\r\n}\r\nstatic int int3400_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct acpi_device *adev = ACPI_COMPANION(&pdev->dev);\r\nstruct int3400_thermal_priv *priv;\r\nint result;\r\nif (!adev)\r\nreturn -ENODEV;\r\npriv = kzalloc(sizeof(struct int3400_thermal_priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->adev = adev;\r\nresult = int3400_thermal_get_uuids(priv);\r\nif (result)\r\ngoto free_priv;\r\nresult = acpi_parse_art(priv->adev->handle, &priv->art_count,\r\n&priv->arts, true);\r\nif (result)\r\ndev_dbg(&pdev->dev, "_ART table parsing error\n");\r\nresult = acpi_parse_trt(priv->adev->handle, &priv->trt_count,\r\n&priv->trts, true);\r\nif (result)\r\ndev_dbg(&pdev->dev, "_TRT table parsing error\n");\r\nplatform_set_drvdata(pdev, priv);\r\nif (priv->uuid_bitmap & 1 << INT3400_THERMAL_PASSIVE_1) {\r\nint3400_thermal_ops.get_mode = int3400_thermal_get_mode;\r\nint3400_thermal_ops.set_mode = int3400_thermal_set_mode;\r\n}\r\npriv->thermal = thermal_zone_device_register("INT3400 Thermal", 0, 0,\r\npriv, &int3400_thermal_ops,\r\n&int3400_thermal_params, 0, 0);\r\nif (IS_ERR(priv->thermal)) {\r\nresult = PTR_ERR(priv->thermal);\r\ngoto free_art_trt;\r\n}\r\npriv->rel_misc_dev_res = acpi_thermal_rel_misc_device_add(\r\npriv->adev->handle);\r\nresult = sysfs_create_group(&pdev->dev.kobj, &uuid_attribute_group);\r\nif (result)\r\ngoto free_zone;\r\nreturn 0;\r\nfree_zone:\r\nthermal_zone_device_unregister(priv->thermal);\r\nfree_art_trt:\r\nkfree(priv->trts);\r\nkfree(priv->arts);\r\nfree_priv:\r\nkfree(priv);\r\nreturn result;\r\n}\r\nstatic int int3400_thermal_remove(struct platform_device *pdev)\r\n{\r\nstruct int3400_thermal_priv *priv = platform_get_drvdata(pdev);\r\nif (!priv->rel_misc_dev_res)\r\nacpi_thermal_rel_misc_device_remove(priv->adev->handle);\r\nsysfs_remove_group(&pdev->dev.kobj, &uuid_attribute_group);\r\nthermal_zone_device_unregister(priv->thermal);\r\nkfree(priv->trts);\r\nkfree(priv->arts);\r\nkfree(priv);\r\nreturn 0;\r\n}

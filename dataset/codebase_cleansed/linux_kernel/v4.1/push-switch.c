static ssize_t switch_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct push_switch_platform_info *psw_info = dev->platform_data;\r\nreturn sprintf(buf, "%s\n", psw_info->name);\r\n}\r\nstatic void switch_timer(unsigned long data)\r\n{\r\nstruct push_switch *psw = (struct push_switch *)data;\r\nschedule_work(&psw->work);\r\n}\r\nstatic void switch_work_handler(struct work_struct *work)\r\n{\r\nstruct push_switch *psw = container_of(work, struct push_switch, work);\r\nstruct platform_device *pdev = psw->pdev;\r\npsw->state = 0;\r\nkobject_uevent(&pdev->dev.kobj, KOBJ_CHANGE);\r\n}\r\nstatic int switch_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct push_switch_platform_info *psw_info;\r\nstruct push_switch *psw;\r\nint ret, irq;\r\npsw = kzalloc(sizeof(struct push_switch), GFP_KERNEL);\r\nif (unlikely(!psw))\r\nreturn -ENOMEM;\r\nirq = platform_get_irq(pdev, 0);\r\nif (unlikely(irq < 0)) {\r\nret = -ENODEV;\r\ngoto err;\r\n}\r\npsw_info = pdev->dev.platform_data;\r\nBUG_ON(!psw_info);\r\nret = request_irq(irq, psw_info->irq_handler,\r\npsw_info->irq_flags,\r\npsw_info->name ? psw_info->name : DRV_NAME, pdev);\r\nif (unlikely(ret < 0))\r\ngoto err;\r\nif (psw_info->name) {\r\nret = device_create_file(&pdev->dev, &dev_attr_switch);\r\nif (unlikely(ret)) {\r\ndev_err(&pdev->dev, "Failed creating device attrs\n");\r\nret = -EINVAL;\r\ngoto err_irq;\r\n}\r\n}\r\nINIT_WORK(&psw->work, switch_work_handler);\r\ninit_timer(&psw->debounce);\r\npsw->debounce.function = switch_timer;\r\npsw->debounce.data = (unsigned long)psw;\r\npsw->pdev = pdev;\r\nplatform_set_drvdata(pdev, psw);\r\nreturn 0;\r\nerr_irq:\r\nfree_irq(irq, pdev);\r\nerr:\r\nkfree(psw);\r\nreturn ret;\r\n}\r\nstatic int switch_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct push_switch *psw = platform_get_drvdata(pdev);\r\nstruct push_switch_platform_info *psw_info = pdev->dev.platform_data;\r\nint irq = platform_get_irq(pdev, 0);\r\nif (psw_info->name)\r\ndevice_remove_file(&pdev->dev, &dev_attr_switch);\r\nplatform_set_drvdata(pdev, NULL);\r\nflush_work(&psw->work);\r\ndel_timer_sync(&psw->debounce);\r\nfree_irq(irq, pdev);\r\nkfree(psw);\r\nreturn 0;\r\n}\r\nstatic int __init switch_init(void)\r\n{\r\nprintk(KERN_NOTICE DRV_NAME ": version %s loaded\n", DRV_VERSION);\r\nreturn platform_driver_register(&switch_driver);\r\n}\r\nstatic void __exit switch_exit(void)\r\n{\r\nplatform_driver_unregister(&switch_driver);\r\n}

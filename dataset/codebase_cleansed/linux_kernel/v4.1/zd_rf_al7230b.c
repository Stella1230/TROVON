static int zd1211b_al7230b_finalize(struct zd_chip *chip)\r\n{\r\nint r;\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR80, 0x30 }, { ZD_CR81, 0x30 }, { ZD_CR79, 0x58 },\r\n{ ZD_CR12, 0xf0 }, { ZD_CR77, 0x1b }, { ZD_CR78, 0x58 },\r\n{ ZD_CR203, 0x04 },\r\n{ },\r\n{ ZD_CR240, 0x80 },\r\n};\r\nr = zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\nif (r)\r\nreturn r;\r\nif (chip->new_phy_layout) {\r\nr = zd_iowrite16_locked(chip, 0xe5, ZD_CR9);\r\nif (r)\r\nreturn r;\r\n}\r\nreturn zd_iowrite16_locked(chip, 0x04, ZD_CR203);\r\n}\r\nstatic int zd1211_al7230b_init_hw(struct zd_rf *rf)\r\n{\r\nint r;\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs_1[] = {\r\n{ ZD_CR240, 0x57 },\r\n{ },\r\n{ ZD_CR15, 0x20 }, { ZD_CR23, 0x40 }, { ZD_CR24, 0x20 },\r\n{ ZD_CR26, 0x11 }, { ZD_CR28, 0x3e }, { ZD_CR29, 0x00 },\r\n{ ZD_CR44, 0x33 },\r\n{ ZD_CR106, 0x22 },\r\n{ ZD_CR107, 0x1a }, { ZD_CR109, 0x09 }, { ZD_CR110, 0x27 },\r\n{ ZD_CR111, 0x2b }, { ZD_CR112, 0x2b }, { ZD_CR119, 0x0a },\r\n{ ZD_CR122, 0xfc },\r\n{ ZD_CR10, 0x89 },\r\n{ ZD_CR17, 0x28 },\r\n{ ZD_CR26, 0x93 }, { ZD_CR34, 0x30 },\r\n{ ZD_CR35, 0x3e },\r\n{ ZD_CR41, 0x24 }, { ZD_CR44, 0x32 },\r\n{ ZD_CR46, 0x96 },\r\n{ ZD_CR47, 0x1e }, { ZD_CR79, 0x58 }, { ZD_CR80, 0x30 },\r\n{ ZD_CR81, 0x30 }, { ZD_CR87, 0x0a }, { ZD_CR89, 0x04 },\r\n{ ZD_CR92, 0x0a }, { ZD_CR99, 0x28 },\r\n{ ZD_CR100, 0x02 },\r\n{ ZD_CR101, 0x13 }, { ZD_CR102, 0x27 },\r\n{ ZD_CR106, 0x22 },\r\n{ ZD_CR107, 0x3f },\r\n{ ZD_CR109, 0x09 },\r\n{ ZD_CR110, 0x1f },\r\n{ ZD_CR111, 0x1f }, { ZD_CR112, 0x1f }, { ZD_CR113, 0x27 },\r\n{ ZD_CR114, 0x27 },\r\n{ ZD_CR115, 0x24 },\r\n{ ZD_CR116, 0x3f },\r\n{ ZD_CR117, 0xfa },\r\n{ ZD_CR118, 0xfc }, { ZD_CR119, 0x10 }, { ZD_CR120, 0x4f },\r\n{ ZD_CR121, 0x77 }, { ZD_CR137, 0x88 },\r\n{ ZD_CR138, 0xa8 },\r\n{ ZD_CR252, 0x34 },\r\n{ ZD_CR253, 0x34 },\r\n{ ZD_CR251, 0x2f },\r\n};\r\nstatic const struct zd_ioreq16 ioreqs_2[] = {\r\n{ ZD_CR251, 0x3f },\r\n{ ZD_CR128, 0x14 }, { ZD_CR129, 0x12 }, { ZD_CR130, 0x10 },\r\n{ ZD_CR38, 0x38 }, { ZD_CR136, 0xdf },\r\n};\r\nr = zd_iowrite16a_locked(chip, ioreqs_1, ARRAY_SIZE(ioreqs_1));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, chan_rv[0], ARRAY_SIZE(chan_rv[0]));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, std_rv, ARRAY_SIZE(std_rv));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv_init1, ARRAY_SIZE(rv_init1));\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs_2, ARRAY_SIZE(ioreqs_2));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv_init2, ARRAY_SIZE(rv_init2));\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16_locked(chip, 0x06, ZD_CR203);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16_locked(chip, 0x80, ZD_CR240);\r\nif (r)\r\nreturn r;\r\nreturn 0;\r\n}\r\nstatic int zd1211b_al7230b_init_hw(struct zd_rf *rf)\r\n{\r\nint r;\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs_1[] = {\r\n{ ZD_CR240, 0x57 }, { ZD_CR9, 0x9 },\r\n{ },\r\n{ ZD_CR10, 0x8b }, { ZD_CR15, 0x20 },\r\n{ ZD_CR17, 0x2B },\r\n{ ZD_CR20, 0x10 },\r\n{ ZD_CR23, 0x40 }, { ZD_CR24, 0x20 }, { ZD_CR26, 0x93 },\r\n{ ZD_CR28, 0x3e }, { ZD_CR29, 0x00 },\r\n{ ZD_CR33, 0x28 },\r\n{ ZD_CR34, 0x30 },\r\n{ ZD_CR35, 0x3e },\r\n{ ZD_CR41, 0x24 }, { ZD_CR44, 0x32 },\r\n{ ZD_CR46, 0x99 },\r\n{ ZD_CR47, 0x1e },\r\n{ ZD_CR48, 0x00 }, { ZD_CR49, 0x00 }, { ZD_CR51, 0x01 },\r\n{ ZD_CR52, 0x80 }, { ZD_CR53, 0x7e }, { ZD_CR65, 0x00 },\r\n{ ZD_CR66, 0x00 }, { ZD_CR67, 0x00 }, { ZD_CR68, 0x00 },\r\n{ ZD_CR69, 0x28 },\r\n{ ZD_CR79, 0x58 }, { ZD_CR80, 0x30 }, { ZD_CR81, 0x30 },\r\n{ ZD_CR87, 0x0A }, { ZD_CR89, 0x04 },\r\n{ ZD_CR90, 0x58 },\r\n{ ZD_CR91, 0x00 },\r\n{ ZD_CR92, 0x0a },\r\n{ ZD_CR98, 0x8d },\r\n{ ZD_CR99, 0x00 }, { ZD_CR100, 0x02 }, { ZD_CR101, 0x13 },\r\n{ ZD_CR102, 0x27 },\r\n{ ZD_CR106, 0x20 },\r\n{ ZD_CR109, 0x13 },\r\n{ ZD_CR112, 0x1f },\r\n};\r\nstatic const struct zd_ioreq16 ioreqs_new_phy[] = {\r\n{ ZD_CR107, 0x28 },\r\n{ ZD_CR110, 0x1f },\r\n{ ZD_CR111, 0x1f },\r\n{ ZD_CR116, 0x2a }, { ZD_CR118, 0xfa }, { ZD_CR119, 0x12 },\r\n{ ZD_CR121, 0x6c },\r\n};\r\nstatic const struct zd_ioreq16 ioreqs_old_phy[] = {\r\n{ ZD_CR107, 0x24 },\r\n{ ZD_CR110, 0x13 },\r\n{ ZD_CR111, 0x13 },\r\n{ ZD_CR116, 0x24 }, { ZD_CR118, 0xfc }, { ZD_CR119, 0x11 },\r\n{ ZD_CR121, 0x6a },\r\n};\r\nstatic const struct zd_ioreq16 ioreqs_2[] = {\r\n{ ZD_CR113, 0x27 }, { ZD_CR114, 0x27 }, { ZD_CR115, 0x24 },\r\n{ ZD_CR117, 0xfa }, { ZD_CR120, 0x4f },\r\n{ ZD_CR122, 0xfc },\r\n{ ZD_CR123, 0x57 },\r\n{ ZD_CR125, 0xad },\r\n{ ZD_CR126, 0x6c },\r\n{ ZD_CR127, 0x03 },\r\n{ ZD_CR130, 0x10 },\r\n{ ZD_CR131, 0x00 },\r\n{ ZD_CR137, 0x50 },\r\n{ ZD_CR138, 0xa8 },\r\n{ ZD_CR144, 0xac },\r\n{ ZD_CR148, 0x40 },\r\n{ ZD_CR149, 0x40 },\r\n{ ZD_CR150, 0x1a },\r\n{ ZD_CR252, 0x34 }, { ZD_CR253, 0x34 },\r\n{ ZD_CR251, 0x2f },\r\n};\r\nstatic const struct zd_ioreq16 ioreqs_3[] = {\r\n{ ZD_CR251, 0x7f },\r\n{ ZD_CR128, 0x14 }, { ZD_CR129, 0x12 }, { ZD_CR130, 0x10 },\r\n{ ZD_CR38, 0x38 }, { ZD_CR136, 0xdf },\r\n};\r\nr = zd_iowrite16a_locked(chip, ioreqs_1, ARRAY_SIZE(ioreqs_1));\r\nif (r)\r\nreturn r;\r\nif (chip->new_phy_layout)\r\nr = zd_iowrite16a_locked(chip, ioreqs_new_phy,\r\nARRAY_SIZE(ioreqs_new_phy));\r\nelse\r\nr = zd_iowrite16a_locked(chip, ioreqs_old_phy,\r\nARRAY_SIZE(ioreqs_old_phy));\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs_2, ARRAY_SIZE(ioreqs_2));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, chan_rv[0], ARRAY_SIZE(chan_rv[0]));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, std_rv, ARRAY_SIZE(std_rv));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv_init1, ARRAY_SIZE(rv_init1));\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs_3, ARRAY_SIZE(ioreqs_3));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv_init2, ARRAY_SIZE(rv_init2));\r\nif (r)\r\nreturn r;\r\nreturn zd1211b_al7230b_finalize(chip);\r\n}\r\nstatic int zd1211_al7230b_set_channel(struct zd_rf *rf, u8 channel)\r\n{\r\nint r;\r\nconst u32 *rv = chan_rv[channel-1];\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR251, 0x3f },\r\n{ ZD_CR203, 0x06 }, { ZD_CR240, 0x08 },\r\n};\r\nr = zd_iowrite16_locked(chip, 0x57, ZD_CR240);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16_locked(chip, 0x2f, ZD_CR251);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, std_rv, ARRAY_SIZE(std_rv));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwrite_cr_locked(chip, 0x3c9000);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwrite_cr_locked(chip, 0xf15d58);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs_sw, ARRAY_SIZE(ioreqs_sw));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv, 2);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwrite_cr_locked(chip, 0x3c9000);\r\nif (r)\r\nreturn r;\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int zd1211b_al7230b_set_channel(struct zd_rf *rf, u8 channel)\r\n{\r\nint r;\r\nconst u32 *rv = chan_rv[channel-1];\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nr = zd_iowrite16_locked(chip, 0x57, ZD_CR240);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16_locked(chip, 0xe4, ZD_CR9);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16_locked(chip, 0x2f, ZD_CR251);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, std_rv, ARRAY_SIZE(std_rv));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwrite_cr_locked(chip, 0x3c9000);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwrite_cr_locked(chip, 0xf15d58);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs_sw, ARRAY_SIZE(ioreqs_sw));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv, 2);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwrite_cr_locked(chip, 0x3c9000);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16_locked(chip, 0x7f, ZD_CR251);\r\nif (r)\r\nreturn r;\r\nreturn zd1211b_al7230b_finalize(chip);\r\n}\r\nstatic int zd1211_al7230b_switch_radio_on(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x00 },\r\n{ ZD_CR251, 0x3f },\r\n};\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int zd1211b_al7230b_switch_radio_on(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x00 },\r\n{ ZD_CR251, 0x7f },\r\n};\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int al7230b_switch_radio_off(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x04 },\r\n{ ZD_CR251, 0x2f },\r\n};\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int zd1211b_al7230b_patch_6m(struct zd_rf *rf, u8 channel)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstruct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR128, 0x14 }, { ZD_CR129, 0x12 },\r\n};\r\nif (channel == 1) {\r\nioreqs[0].value = 0x0e;\r\nioreqs[1].value = 0x10;\r\n} else if (channel == 11) {\r\nioreqs[0].value = 0x10;\r\nioreqs[1].value = 0x10;\r\n}\r\ndev_dbg_f(zd_chip_dev(chip), "patching for channel %d\n", channel);\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nint zd_rf_init_al7230b(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nif (zd_chip_is_zd1211b(chip)) {\r\nrf->init_hw = zd1211b_al7230b_init_hw;\r\nrf->switch_radio_on = zd1211b_al7230b_switch_radio_on;\r\nrf->set_channel = zd1211b_al7230b_set_channel;\r\nrf->patch_6m_band_edge = zd1211b_al7230b_patch_6m;\r\n} else {\r\nrf->init_hw = zd1211_al7230b_init_hw;\r\nrf->switch_radio_on = zd1211_al7230b_switch_radio_on;\r\nrf->set_channel = zd1211_al7230b_set_channel;\r\nrf->patch_6m_band_edge = zd_rf_generic_patch_6m;\r\nrf->patch_cck_gain = 1;\r\n}\r\nrf->switch_radio_off = al7230b_switch_radio_off;\r\nreturn 0;\r\n}

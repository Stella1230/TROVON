static void *tty_chan_init(char *str, int device, const struct chan_opts *opts)\r\n{\r\nstruct tty_chan *data;\r\nif (*str != ':') {\r\nprintk(UM_KERN_ERR "tty_init : channel type 'tty' must specify "\r\n"a device\n");\r\nreturn NULL;\r\n}\r\nstr++;\r\ndata = uml_kmalloc(sizeof(*data), UM_GFP_KERNEL);\r\nif (data == NULL)\r\nreturn NULL;\r\n*data = ((struct tty_chan) { .dev = str,\r\n.raw = opts->raw });\r\nreturn data;\r\n}\r\nstatic int tty_open(int input, int output, int primary, void *d,\r\nchar **dev_out)\r\n{\r\nstruct tty_chan *data = d;\r\nint fd, err, mode = 0;\r\nif (input && output)\r\nmode = O_RDWR;\r\nelse if (input)\r\nmode = O_RDONLY;\r\nelse if (output)\r\nmode = O_WRONLY;\r\nfd = open(data->dev, mode);\r\nif (fd < 0)\r\nreturn -errno;\r\nif (data->raw) {\r\nCATCH_EINTR(err = tcgetattr(fd, &data->tt));\r\nif (err)\r\nreturn err;\r\nerr = raw(fd);\r\nif (err)\r\nreturn err;\r\n}\r\n*dev_out = data->dev;\r\nreturn fd;\r\n}

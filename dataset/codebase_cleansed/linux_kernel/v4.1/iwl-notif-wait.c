void iwl_notification_wait_init(struct iwl_notif_wait_data *notif_wait)\r\n{\r\nspin_lock_init(&notif_wait->notif_wait_lock);\r\nINIT_LIST_HEAD(&notif_wait->notif_waits);\r\ninit_waitqueue_head(&notif_wait->notif_waitq);\r\n}\r\nvoid iwl_notification_wait_notify(struct iwl_notif_wait_data *notif_wait,\r\nstruct iwl_rx_packet *pkt)\r\n{\r\nbool triggered = false;\r\nif (!list_empty(&notif_wait->notif_waits)) {\r\nstruct iwl_notification_wait *w;\r\nspin_lock(&notif_wait->notif_wait_lock);\r\nlist_for_each_entry(w, &notif_wait->notif_waits, list) {\r\nint i;\r\nbool found = false;\r\nif (w->triggered || w->aborted)\r\ncontinue;\r\nfor (i = 0; i < w->n_cmds; i++) {\r\nif (w->cmds[i] == pkt->hdr.cmd) {\r\nfound = true;\r\nbreak;\r\n}\r\n}\r\nif (!found)\r\ncontinue;\r\nif (!w->fn || w->fn(notif_wait, pkt, w->fn_data)) {\r\nw->triggered = true;\r\ntriggered = true;\r\n}\r\n}\r\nspin_unlock(&notif_wait->notif_wait_lock);\r\n}\r\nif (triggered)\r\nwake_up_all(&notif_wait->notif_waitq);\r\n}\r\nvoid iwl_abort_notification_waits(struct iwl_notif_wait_data *notif_wait)\r\n{\r\nstruct iwl_notification_wait *wait_entry;\r\nspin_lock(&notif_wait->notif_wait_lock);\r\nlist_for_each_entry(wait_entry, &notif_wait->notif_waits, list)\r\nwait_entry->aborted = true;\r\nspin_unlock(&notif_wait->notif_wait_lock);\r\nwake_up_all(&notif_wait->notif_waitq);\r\n}\r\nvoid\r\niwl_init_notification_wait(struct iwl_notif_wait_data *notif_wait,\r\nstruct iwl_notification_wait *wait_entry,\r\nconst u8 *cmds, int n_cmds,\r\nbool (*fn)(struct iwl_notif_wait_data *notif_wait,\r\nstruct iwl_rx_packet *pkt, void *data),\r\nvoid *fn_data)\r\n{\r\nif (WARN_ON(n_cmds > MAX_NOTIF_CMDS))\r\nn_cmds = MAX_NOTIF_CMDS;\r\nwait_entry->fn = fn;\r\nwait_entry->fn_data = fn_data;\r\nwait_entry->n_cmds = n_cmds;\r\nmemcpy(wait_entry->cmds, cmds, n_cmds);\r\nwait_entry->triggered = false;\r\nwait_entry->aborted = false;\r\nspin_lock_bh(&notif_wait->notif_wait_lock);\r\nlist_add(&wait_entry->list, &notif_wait->notif_waits);\r\nspin_unlock_bh(&notif_wait->notif_wait_lock);\r\n}\r\nint iwl_wait_notification(struct iwl_notif_wait_data *notif_wait,\r\nstruct iwl_notification_wait *wait_entry,\r\nunsigned long timeout)\r\n{\r\nint ret;\r\nret = wait_event_timeout(notif_wait->notif_waitq,\r\nwait_entry->triggered || wait_entry->aborted,\r\ntimeout);\r\nspin_lock_bh(&notif_wait->notif_wait_lock);\r\nlist_del(&wait_entry->list);\r\nspin_unlock_bh(&notif_wait->notif_wait_lock);\r\nif (wait_entry->aborted)\r\nreturn -EIO;\r\nif (ret <= 0)\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nvoid iwl_remove_notification(struct iwl_notif_wait_data *notif_wait,\r\nstruct iwl_notification_wait *wait_entry)\r\n{\r\nspin_lock_bh(&notif_wait->notif_wait_lock);\r\nlist_del(&wait_entry->list);\r\nspin_unlock_bh(&notif_wait->notif_wait_lock);\r\n}

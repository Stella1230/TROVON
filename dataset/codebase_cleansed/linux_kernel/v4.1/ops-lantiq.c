static int ltq_pci_config_access(unsigned char access_type, struct pci_bus *bus,\r\nunsigned int devfn, unsigned int where, u32 *data)\r\n{\r\nunsigned long cfg_base;\r\nunsigned long flags;\r\nu32 temp;\r\nif ((bus->number != 0) || ((devfn & 0xf8) > 0x78)\r\n|| ((devfn & 0xf8) == 0) || ((devfn & 0xf8) == 0x68))\r\nreturn 1;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\ncfg_base = (unsigned long) ltq_pci_mapped_cfg;\r\ncfg_base |= (bus->number << LTQ_PCI_CFG_BUSNUM_SHF) | (devfn <<\r\nLTQ_PCI_CFG_FUNNUM_SHF) | (where & ~0x3);\r\nif (access_type == PCI_ACCESS_WRITE) {\r\nltq_w32(swab32(*data), ((u32 *)cfg_base));\r\n} else {\r\n*data = ltq_r32(((u32 *)(cfg_base)));\r\n*data = swab32(*data);\r\n}\r\nwmb();\r\ncfg_base = (unsigned long) ltq_pci_mapped_cfg;\r\ncfg_base |= (0x0 << LTQ_PCI_CFG_FUNNUM_SHF) + 4;\r\ntemp = ltq_r32(((u32 *)(cfg_base)));\r\ntemp = swab32(temp);\r\ncfg_base = (unsigned long) ltq_pci_mapped_cfg;\r\ncfg_base |= (0x68 << LTQ_PCI_CFG_FUNNUM_SHF) + 4;\r\nltq_w32(temp, ((u32 *)cfg_base));\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\nif (((*data) == 0xffffffff) && (access_type == PCI_ACCESS_READ))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint ltq_pci_read_config_dword(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nu32 data = 0;\r\nif (ltq_pci_config_access(PCI_ACCESS_READ, bus, devfn, where, &data))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (size == 1)\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nelse if (size == 2)\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nelse\r\n*val = data;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nint ltq_pci_write_config_dword(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nu32 data = 0;\r\nif (size == 4) {\r\ndata = val;\r\n} else {\r\nif (ltq_pci_config_access(PCI_ACCESS_READ, bus,\r\ndevfn, where, &data))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (size == 1)\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse if (size == 2)\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\n}\r\nif (ltq_pci_config_access(PCI_ACCESS_WRITE, bus, devfn, where, &data))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

static int vde_user_init(void *data, void *dev)\r\n{\r\nstruct vde_data *pri = data;\r\nVDECONN *conn = NULL;\r\nint err = -EINVAL;\r\npri->dev = dev;\r\nconn = vde_open(pri->vde_switch, pri->descr, pri->args);\r\nif (conn == NULL) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "vde_user_init: vde_open failed, "\r\n"errno = %d\n", errno);\r\nreturn err;\r\n}\r\nprintk(UM_KERN_INFO "vde backend - connection opened\n");\r\npri->conn = conn;\r\nreturn 0;\r\n}\r\nstatic int vde_user_open(void *data)\r\n{\r\nstruct vde_data *pri = data;\r\nif (pri->conn != NULL)\r\nreturn vde_datafd(pri->conn);\r\nprintk(UM_KERN_WARNING "vde_open - we have no VDECONN to open");\r\nreturn -EINVAL;\r\n}\r\nstatic void vde_remove(void *data)\r\n{\r\nstruct vde_data *pri = data;\r\nif (pri->conn != NULL) {\r\nprintk(UM_KERN_INFO "vde backend - closing connection\n");\r\nvde_close(pri->conn);\r\npri->conn = NULL;\r\nkfree(pri->args);\r\npri->args = NULL;\r\nreturn;\r\n}\r\nprintk(UM_KERN_WARNING "vde_remove - we have no VDECONN to remove");\r\n}\r\nvoid vde_init_libstuff(struct vde_data *vpri, struct vde_init *init)\r\n{\r\nstruct vde_open_args *args;\r\nvpri->args = uml_kmalloc(sizeof(struct vde_open_args), UM_GFP_KERNEL);\r\nif (vpri->args == NULL) {\r\nprintk(UM_KERN_ERR "vde_init_libstuff - vde_open_args "\r\n"allocation failed");\r\nreturn;\r\n}\r\nargs = vpri->args;\r\nargs->port = init->port;\r\nargs->group = init->group;\r\nargs->mode = init->mode ? init->mode : 0700;\r\nargs->port ? printk("port %d", args->port) :\r\nprintk("undefined port");\r\n}\r\nint vde_user_read(void *conn, void *buf, int len)\r\n{\r\nVDECONN *vconn = conn;\r\nint rv;\r\nif (vconn == NULL)\r\nreturn 0;\r\nrv = vde_recv(vconn, buf, len, 0);\r\nif (rv < 0) {\r\nif (errno == EAGAIN)\r\nreturn 0;\r\nreturn -errno;\r\n}\r\nelse if (rv == 0)\r\nreturn -ENOTCONN;\r\nreturn rv;\r\n}\r\nint vde_user_write(void *conn, void *buf, int len)\r\n{\r\nVDECONN *vconn = conn;\r\nif (vconn == NULL)\r\nreturn 0;\r\nreturn vde_send(vconn, buf, len, 0);\r\n}

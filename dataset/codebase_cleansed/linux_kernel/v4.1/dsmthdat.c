void acpi_ds_method_data_init(struct acpi_walk_state *walk_state)\r\n{\r\nu32 i;\r\nACPI_FUNCTION_TRACE(ds_method_data_init);\r\nfor (i = 0; i < ACPI_METHOD_NUM_ARGS; i++) {\r\nACPI_MOVE_32_TO_32(&walk_state->arguments[i].name,\r\nNAMEOF_ARG_NTE);\r\nwalk_state->arguments[i].name.integer |= (i << 24);\r\nwalk_state->arguments[i].descriptor_type = ACPI_DESC_TYPE_NAMED;\r\nwalk_state->arguments[i].type = ACPI_TYPE_ANY;\r\nwalk_state->arguments[i].flags = ANOBJ_METHOD_ARG;\r\n}\r\nfor (i = 0; i < ACPI_METHOD_NUM_LOCALS; i++) {\r\nACPI_MOVE_32_TO_32(&walk_state->local_variables[i].name,\r\nNAMEOF_LOCAL_NTE);\r\nwalk_state->local_variables[i].name.integer |= (i << 24);\r\nwalk_state->local_variables[i].descriptor_type =\r\nACPI_DESC_TYPE_NAMED;\r\nwalk_state->local_variables[i].type = ACPI_TYPE_ANY;\r\nwalk_state->local_variables[i].flags = ANOBJ_METHOD_LOCAL;\r\n}\r\nreturn_VOID;\r\n}\r\nvoid acpi_ds_method_data_delete_all(struct acpi_walk_state *walk_state)\r\n{\r\nu32 index;\r\nACPI_FUNCTION_TRACE(ds_method_data_delete_all);\r\nfor (index = 0; index < ACPI_METHOD_NUM_LOCALS; index++) {\r\nif (walk_state->local_variables[index].object) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Deleting Local%u=%p\n",\r\nindex,\r\nwalk_state->local_variables[index].\r\nobject));\r\nacpi_ns_detach_object(&walk_state->\r\nlocal_variables[index]);\r\n}\r\n}\r\nfor (index = 0; index < ACPI_METHOD_NUM_ARGS; index++) {\r\nif (walk_state->arguments[index].object) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Deleting Arg%u=%p\n",\r\nindex,\r\nwalk_state->arguments[index].object));\r\nacpi_ns_detach_object(&walk_state->arguments[index]);\r\n}\r\n}\r\nreturn_VOID;\r\n}\r\nacpi_status\r\nacpi_ds_method_data_init_args(union acpi_operand_object **params,\r\nu32 max_param_count,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nu32 index = 0;\r\nACPI_FUNCTION_TRACE_PTR(ds_method_data_init_args, params);\r\nif (!params) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"No param list passed to method\n"));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nwhile ((index < ACPI_METHOD_NUM_ARGS) &&\r\n(index < max_param_count) && params[index]) {\r\nstatus = acpi_ds_method_data_set_value(ACPI_REFCLASS_ARG, index,\r\nparams[index],\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nindex++;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "%u args passed to method\n", index));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ds_method_data_get_node(u8 type,\r\nu32 index,\r\nstruct acpi_walk_state *walk_state,\r\nstruct acpi_namespace_node **node)\r\n{\r\nACPI_FUNCTION_TRACE(ds_method_data_get_node);\r\nswitch (type) {\r\ncase ACPI_REFCLASS_LOCAL:\r\nif (index > ACPI_METHOD_MAX_LOCAL) {\r\nACPI_ERROR((AE_INFO,\r\n"Local index %u is invalid (max %u)",\r\nindex, ACPI_METHOD_MAX_LOCAL));\r\nreturn_ACPI_STATUS(AE_AML_INVALID_INDEX);\r\n}\r\n*node = &walk_state->local_variables[index];\r\nbreak;\r\ncase ACPI_REFCLASS_ARG:\r\nif (index > ACPI_METHOD_MAX_ARG) {\r\nACPI_ERROR((AE_INFO,\r\n"Arg index %u is invalid (max %u)",\r\nindex, ACPI_METHOD_MAX_ARG));\r\nreturn_ACPI_STATUS(AE_AML_INVALID_INDEX);\r\n}\r\n*node = &walk_state->arguments[index];\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Type %u is invalid", type));\r\nreturn_ACPI_STATUS(AE_TYPE);\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nstatic acpi_status\r\nacpi_ds_method_data_set_value(u8 type,\r\nu32 index,\r\nunion acpi_operand_object *object,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nACPI_FUNCTION_TRACE(ds_method_data_set_value);\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"NewObj %p Type %2.2X, Refs=%u [%s]\n", object,\r\ntype, object->common.reference_count,\r\nacpi_ut_get_type_name(object->common.type)));\r\nstatus = acpi_ds_method_data_get_node(type, index, walk_state, &node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_ut_add_reference(object);\r\nnode->object = object;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_method_data_get_value(u8 type,\r\nu32 index,\r\nstruct acpi_walk_state *walk_state,\r\nunion acpi_operand_object **dest_desc)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_operand_object *object;\r\nACPI_FUNCTION_TRACE(ds_method_data_get_value);\r\nif (!dest_desc) {\r\nACPI_ERROR((AE_INFO, "Null object descriptor pointer"));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus = acpi_ds_method_data_get_node(type, index, walk_state, &node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nobject = node->object;\r\nif (!object) {\r\nif (acpi_gbl_enable_interpreter_slack) {\r\nobject = acpi_ut_create_integer_object((u64) 0);\r\nif (!object) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nnode->object = object;\r\n}\r\nelse\r\nswitch (type) {\r\ncase ACPI_REFCLASS_ARG:\r\nACPI_ERROR((AE_INFO,\r\n"Uninitialized Arg[%u] at node %p",\r\nindex, node));\r\nreturn_ACPI_STATUS(AE_AML_UNINITIALIZED_ARG);\r\ncase ACPI_REFCLASS_LOCAL:\r\nreturn_ACPI_STATUS(AE_AML_UNINITIALIZED_LOCAL);\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Not a Arg/Local opcode: 0x%X",\r\ntype));\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\n}\r\n*dest_desc = object;\r\nacpi_ut_add_reference(object);\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nstatic void\r\nacpi_ds_method_data_delete_value(u8 type,\r\nu32 index, struct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_operand_object *object;\r\nACPI_FUNCTION_TRACE(ds_method_data_delete_value);\r\nstatus = acpi_ds_method_data_get_node(type, index, walk_state, &node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_VOID;\r\n}\r\nobject = acpi_ns_get_attached_object(node);\r\nnode->object = NULL;\r\nif ((object) &&\r\n(ACPI_GET_DESCRIPTOR_TYPE(object) == ACPI_DESC_TYPE_OPERAND)) {\r\nacpi_ut_remove_reference(object);\r\n}\r\nreturn_VOID;\r\n}\r\nacpi_status\r\nacpi_ds_store_object_to_local(u8 type,\r\nu32 index,\r\nunion acpi_operand_object *obj_desc,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_operand_object *current_obj_desc;\r\nunion acpi_operand_object *new_obj_desc;\r\nACPI_FUNCTION_TRACE(ds_store_object_to_local);\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Type=%2.2X Index=%u Obj=%p\n",\r\ntype, index, obj_desc));\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus = acpi_ds_method_data_get_node(type, index, walk_state, &node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\ncurrent_obj_desc = acpi_ns_get_attached_object(node);\r\nif (current_obj_desc == obj_desc) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Obj=%p already installed!\n",\r\nobj_desc));\r\nreturn_ACPI_STATUS(status);\r\n}\r\nnew_obj_desc = obj_desc;\r\nif (obj_desc->common.reference_count > 1) {\r\nstatus =\r\nacpi_ut_copy_iobject_to_iobject(obj_desc, &new_obj_desc,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nif (current_obj_desc) {\r\nif (type == ACPI_REFCLASS_ARG) {\r\nif ((ACPI_GET_DESCRIPTOR_TYPE(current_obj_desc) ==\r\nACPI_DESC_TYPE_OPERAND)\r\n&& (current_obj_desc->common.type ==\r\nACPI_TYPE_LOCAL_REFERENCE)\r\n&& (current_obj_desc->reference.class ==\r\nACPI_REFCLASS_REFOF)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Arg (%p) is an ObjRef(Node), storing in node %p\n",\r\nnew_obj_desc,\r\ncurrent_obj_desc));\r\nstatus =\r\nacpi_ex_store_object_to_node(new_obj_desc,\r\ncurrent_obj_desc->\r\nreference.\r\nobject,\r\nwalk_state,\r\nACPI_NO_IMPLICIT_CONVERSION);\r\nif (new_obj_desc != obj_desc) {\r\nacpi_ut_remove_reference(new_obj_desc);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nacpi_ds_method_data_delete_value(type, index, walk_state);\r\n}\r\nstatus =\r\nacpi_ds_method_data_set_value(type, index, new_obj_desc,\r\nwalk_state);\r\nif (new_obj_desc != obj_desc) {\r\nacpi_ut_remove_reference(new_obj_desc);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_object_type\r\nacpi_ds_method_data_get_type(u16 opcode,\r\nu32 index, struct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_operand_object *object;\r\nACPI_FUNCTION_TRACE(ds_method_data_get_type);\r\nstatus = acpi_ds_method_data_get_node(opcode, index, walk_state, &node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_VALUE((ACPI_TYPE_NOT_FOUND));\r\n}\r\nobject = acpi_ns_get_attached_object(node);\r\nif (!object) {\r\nreturn_VALUE(ACPI_TYPE_ANY);\r\n}\r\nreturn_VALUE(object->type);\r\n}

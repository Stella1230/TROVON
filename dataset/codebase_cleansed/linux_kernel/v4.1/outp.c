int\r\n_nvkm_output_fini(struct nvkm_object *object, bool suspend)\r\n{\r\nstruct nvkm_output *outp = (void *)object;\r\nnv_ofuncs(outp->conn)->fini(nv_object(outp->conn), suspend);\r\nreturn nvkm_object_fini(&outp->base, suspend);\r\n}\r\nint\r\n_nvkm_output_init(struct nvkm_object *object)\r\n{\r\nstruct nvkm_output *outp = (void *)object;\r\nint ret = nvkm_object_init(&outp->base);\r\nif (ret == 0)\r\nnv_ofuncs(outp->conn)->init(nv_object(outp->conn));\r\nreturn 0;\r\n}\r\nvoid\r\n_nvkm_output_dtor(struct nvkm_object *object)\r\n{\r\nstruct nvkm_output *outp = (void *)object;\r\nlist_del(&outp->head);\r\nnvkm_object_ref(NULL, (void *)&outp->conn);\r\nnvkm_object_destroy(&outp->base);\r\n}\r\nint\r\nnvkm_output_create_(struct nvkm_object *parent,\r\nstruct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass,\r\nstruct dcb_output *dcbE, int index,\r\nint length, void **pobject)\r\n{\r\nstruct nvkm_disp *disp = nvkm_disp(parent);\r\nstruct nvkm_bios *bios = nvkm_bios(parent);\r\nstruct nvkm_i2c *i2c = nvkm_i2c(parent);\r\nstruct nvbios_connE connE;\r\nstruct nvkm_output *outp;\r\nu8 ver, hdr;\r\nu32 data;\r\nint ret;\r\nret = nvkm_object_create_(parent, engine, oclass, 0, length, pobject);\r\noutp = *pobject;\r\nif (ret)\r\nreturn ret;\r\noutp->info = *dcbE;\r\noutp->index = index;\r\noutp->or = ffs(outp->info.or) - 1;\r\nDBG("type %02x loc %d or %d link %d con %x edid %x bus %d head %x\n",\r\ndcbE->type, dcbE->location, dcbE->or, dcbE->type >= 2 ?\r\ndcbE->sorconf.link : 0, dcbE->connector, dcbE->i2c_index,\r\ndcbE->bus, dcbE->heads);\r\nif (outp->info.type != DCB_OUTPUT_DP)\r\noutp->port = i2c->find(i2c, NV_I2C_PORT(outp->info.i2c_index));\r\nelse\r\noutp->port = i2c->find(i2c, NV_I2C_AUX(outp->info.i2c_index));\r\noutp->edid = outp->port;\r\ndata = nvbios_connEp(bios, outp->info.connector, &ver, &hdr, &connE);\r\nif (!data) {\r\nDBG("vbios connector data not found\n");\r\nmemset(&connE, 0x00, sizeof(connE));\r\nconnE.type = DCB_CONNECTOR_NONE;\r\n}\r\nret = nvkm_object_ctor(parent, NULL, nvkm_connector_oclass,\r\n&connE, outp->info.connector,\r\n(struct nvkm_object **)&outp->conn);\r\nif (ret < 0) {\r\nERR("error %d creating connector, disabling\n", ret);\r\nreturn ret;\r\n}\r\nlist_add_tail(&outp->head, &disp->outp);\r\nreturn 0;\r\n}\r\nint\r\n_nvkm_output_ctor(struct nvkm_object *parent,\r\nstruct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *dcbE, u32 index,\r\nstruct nvkm_object **pobject)\r\n{\r\nstruct nvkm_output *outp;\r\nint ret;\r\nret = nvkm_output_create(parent, engine, oclass, dcbE, index, &outp);\r\n*pobject = nv_object(outp);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}

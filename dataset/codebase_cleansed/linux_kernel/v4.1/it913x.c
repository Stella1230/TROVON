static int it913x_init(struct dvb_frontend *fe)\r\n{\r\nstruct it913x_dev *dev = fe->tuner_priv;\r\nint ret;\r\nunsigned int utmp;\r\nu8 iqik_m_cal, nv_val, buf[2];\r\nstatic const u8 nv[] = {48, 32, 24, 16, 12, 8, 6, 4, 2};\r\nunsigned long timeout;\r\ndev_dbg(&dev->client->dev, "role %u\n", dev->role);\r\nret = regmap_write(dev->regmap, 0x80ec4c, 0x68);\r\nif (ret)\r\ngoto err;\r\nusleep_range(10000, 100000);\r\nret = regmap_read(dev->regmap, 0x80ec86, &utmp);\r\nif (ret)\r\ngoto err;\r\nswitch (utmp) {\r\ncase 0:\r\ndev->clk_mode = utmp;\r\ndev->xtal = 2000;\r\ndev->fdiv = 3;\r\niqik_m_cal = 16;\r\nbreak;\r\ncase 1:\r\ndev->clk_mode = utmp;\r\ndev->xtal = 640;\r\ndev->fdiv = 1;\r\niqik_m_cal = 6;\r\nbreak;\r\ndefault:\r\ndev_err(&dev->client->dev, "unknown clock identifier %d\n", utmp);\r\ngoto err;\r\n}\r\nret = regmap_read(dev->regmap, 0x80ed03, &utmp);\r\nif (ret)\r\ngoto err;\r\nelse if (utmp < ARRAY_SIZE(nv))\r\nnv_val = nv[utmp];\r\nelse\r\nnv_val = 2;\r\n#define TIMEOUT 50\r\ntimeout = jiffies + msecs_to_jiffies(TIMEOUT);\r\nwhile (!time_after(jiffies, timeout)) {\r\nret = regmap_bulk_read(dev->regmap, 0x80ed23, buf, 2);\r\nif (ret)\r\ngoto err;\r\nutmp = (buf[1] << 8) | (buf[0] << 0);\r\nif (utmp)\r\nbreak;\r\n}\r\ndev_dbg(&dev->client->dev, "r_fbc_m_bdry took %u ms, val %u\n",\r\njiffies_to_msecs(jiffies) -\r\n(jiffies_to_msecs(timeout) - TIMEOUT), utmp);\r\ndev->fn_min = dev->xtal * utmp;\r\ndev->fn_min /= (dev->fdiv * nv_val);\r\ndev->fn_min *= 1000;\r\ndev_dbg(&dev->client->dev, "fn_min %u\n", dev->fn_min);\r\nif (dev->chip_ver == 1) {\r\n#define TIMEOUT 50\r\ntimeout = jiffies + msecs_to_jiffies(TIMEOUT);\r\nwhile (!time_after(jiffies, timeout)) {\r\nret = regmap_read(dev->regmap, 0x80ec82, &utmp);\r\nif (ret)\r\ngoto err;\r\nif (utmp)\r\nbreak;\r\n}\r\ndev_dbg(&dev->client->dev, "p_tsm_init_mode took %u ms, val %u\n",\r\njiffies_to_msecs(jiffies) -\r\n(jiffies_to_msecs(timeout) - TIMEOUT), utmp);\r\n} else {\r\nmsleep(50);\r\n}\r\nret = regmap_write(dev->regmap, 0x80ed81, iqik_m_cal);\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80ec57, 0x00);\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80ec58, 0x00);\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80ec40, 0x01);\r\nif (ret)\r\ngoto err;\r\ndev->active = true;\r\nreturn 0;\r\nerr:\r\ndev_dbg(&dev->client->dev, "failed %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int it913x_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct it913x_dev *dev = fe->tuner_priv;\r\nint ret, len;\r\ndev_dbg(&dev->client->dev, "role %u\n", dev->role);\r\ndev->active = false;\r\nret = regmap_bulk_write(dev->regmap, 0x80ec40, "\x00", 1);\r\nif (ret)\r\ngoto err;\r\nif (dev->role == IT913X_ROLE_DUAL_MASTER)\r\nlen = 4;\r\nelse\r\nlen = 15;\r\ndev_dbg(&dev->client->dev, "role %u, len %d\n", dev->role, len);\r\nret = regmap_bulk_write(dev->regmap, 0x80ec02,\r\n"\x3f\x1f\x3f\x3e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",\r\nlen);\r\nif (ret)\r\ngoto err;\r\nret = regmap_bulk_write(dev->regmap, 0x80ec12, "\x00\x00\x00\x00", 4);\r\nif (ret)\r\ngoto err;\r\nret = regmap_bulk_write(dev->regmap, 0x80ec17,\r\n"\x00\x00\x00\x00\x00\x00\x00\x00\x00", 9);\r\nif (ret)\r\ngoto err;\r\nret = regmap_bulk_write(dev->regmap, 0x80ec22,\r\n"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 10);\r\nif (ret)\r\ngoto err;\r\nret = regmap_bulk_write(dev->regmap, 0x80ec20, "\x00", 1);\r\nif (ret)\r\ngoto err;\r\nret = regmap_bulk_write(dev->regmap, 0x80ec3f, "\x01", 1);\r\nif (ret)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndev_dbg(&dev->client->dev, "failed %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int it913x_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct it913x_dev *dev = fe->tuner_priv;\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nint ret;\r\nunsigned int utmp;\r\nu32 pre_lo_freq, t_cal_freq;\r\nu16 iqik_m_cal, n_div;\r\nu8 u8tmp, n, l_band, lna_band;\r\ndev_dbg(&dev->client->dev, "role=%u, frequency %u, bandwidth_hz %u\n",\r\ndev->role, c->frequency, c->bandwidth_hz);\r\nif (!dev->active) {\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nif (c->frequency <= 74000000) {\r\nn_div = 48;\r\nn = 0;\r\n} else if (c->frequency <= 111000000) {\r\nn_div = 32;\r\nn = 1;\r\n} else if (c->frequency <= 148000000) {\r\nn_div = 24;\r\nn = 2;\r\n} else if (c->frequency <= 222000000) {\r\nn_div = 16;\r\nn = 3;\r\n} else if (c->frequency <= 296000000) {\r\nn_div = 12;\r\nn = 4;\r\n} else if (c->frequency <= 445000000) {\r\nn_div = 8;\r\nn = 5;\r\n} else if (c->frequency <= dev->fn_min) {\r\nn_div = 6;\r\nn = 6;\r\n} else if (c->frequency <= 950000000) {\r\nn_div = 4;\r\nn = 7;\r\n} else {\r\nn_div = 2;\r\nn = 0;\r\n}\r\nret = regmap_read(dev->regmap, 0x80ed81, &utmp);\r\nif (ret)\r\ngoto err;\r\niqik_m_cal = utmp * n_div;\r\nif (utmp < 0x20) {\r\nif (dev->clk_mode == 0)\r\niqik_m_cal = (iqik_m_cal * 9) >> 5;\r\nelse\r\niqik_m_cal >>= 1;\r\n} else {\r\niqik_m_cal = 0x40 - iqik_m_cal;\r\nif (dev->clk_mode == 0)\r\niqik_m_cal = ~((iqik_m_cal * 9) >> 5);\r\nelse\r\niqik_m_cal = ~(iqik_m_cal >> 1);\r\n}\r\nt_cal_freq = (c->frequency / 1000) * n_div * dev->fdiv;\r\npre_lo_freq = t_cal_freq / dev->xtal;\r\nutmp = pre_lo_freq * dev->xtal;\r\nif ((t_cal_freq - utmp) >= (dev->xtal >> 1))\r\npre_lo_freq++;\r\npre_lo_freq += (u32) n << 13;\r\nt_cal_freq = pre_lo_freq + (u32)iqik_m_cal;\r\ndev_dbg(&dev->client->dev, "t_cal_freq %u, pre_lo_freq %u\n",\r\nt_cal_freq, pre_lo_freq);\r\nif (c->frequency <= 440000000) {\r\nl_band = 0;\r\nlna_band = 0;\r\n} else if (c->frequency <= 484000000) {\r\nl_band = 1;\r\nlna_band = 1;\r\n} else if (c->frequency <= 533000000) {\r\nl_band = 1;\r\nlna_band = 2;\r\n} else if (c->frequency <= 587000000) {\r\nl_band = 1;\r\nlna_band = 3;\r\n} else if (c->frequency <= 645000000) {\r\nl_band = 1;\r\nlna_band = 4;\r\n} else if (c->frequency <= 710000000) {\r\nl_band = 1;\r\nlna_band = 5;\r\n} else if (c->frequency <= 782000000) {\r\nl_band = 1;\r\nlna_band = 6;\r\n} else if (c->frequency <= 860000000) {\r\nl_band = 1;\r\nlna_band = 7;\r\n} else if (c->frequency <= 1492000000) {\r\nl_band = 1;\r\nlna_band = 0;\r\n} else if (c->frequency <= 1685000000) {\r\nl_band = 1;\r\nlna_band = 1;\r\n} else {\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nret = regmap_write(dev->regmap, 0x80ee06, lna_band);\r\nif (ret)\r\ngoto err;\r\nif (c->bandwidth_hz <= 5000000)\r\nu8tmp = 0;\r\nelse if (c->bandwidth_hz <= 6000000)\r\nu8tmp = 2;\r\nelse if (c->bandwidth_hz <= 7000000)\r\nu8tmp = 4;\r\nelse\r\nu8tmp = 6;\r\nret = regmap_write(dev->regmap, 0x80ec56, u8tmp);\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80ec4c, 0xa0 | (l_band << 3));\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80ec4d, (t_cal_freq >> 0) & 0xff);\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80ec4e, (t_cal_freq >> 8) & 0xff);\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80011e, (pre_lo_freq >> 0) & 0xff);\r\nif (ret)\r\ngoto err;\r\nret = regmap_write(dev->regmap, 0x80011f, (pre_lo_freq >> 8) & 0xff);\r\nif (ret)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndev_dbg(&dev->client->dev, "failed %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int it913x_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct it913x_config *cfg = client->dev.platform_data;\r\nstruct dvb_frontend *fe = cfg->fe;\r\nstruct it913x_dev *dev;\r\nint ret;\r\nchar *chip_ver_str;\r\nstatic const struct regmap_config regmap_config = {\r\n.reg_bits = 24,\r\n.val_bits = 8,\r\n};\r\ndev = kzalloc(sizeof(struct it913x_dev), GFP_KERNEL);\r\nif (dev == NULL) {\r\nret = -ENOMEM;\r\ndev_err(&client->dev, "kzalloc() failed\n");\r\ngoto err;\r\n}\r\ndev->client = client;\r\ndev->fe = cfg->fe;\r\ndev->chip_ver = cfg->chip_ver;\r\ndev->role = cfg->role;\r\ndev->regmap = regmap_init_i2c(client, &regmap_config);\r\nif (IS_ERR(dev->regmap)) {\r\nret = PTR_ERR(dev->regmap);\r\ngoto err_kfree;\r\n}\r\nfe->tuner_priv = dev;\r\nmemcpy(&fe->ops.tuner_ops, &it913x_tuner_ops,\r\nsizeof(struct dvb_tuner_ops));\r\ni2c_set_clientdata(client, dev);\r\nif (dev->chip_ver == 1)\r\nchip_ver_str = "AX";\r\nelse if (dev->chip_ver == 2)\r\nchip_ver_str = "BX";\r\nelse\r\nchip_ver_str = "??";\r\ndev_info(&dev->client->dev, "ITE IT913X %s successfully attached\n",\r\nchip_ver_str);\r\ndev_dbg(&dev->client->dev, "chip_ver %u, role %u\n",\r\ndev->chip_ver, dev->role);\r\nreturn 0;\r\nerr_kfree:\r\nkfree(dev);\r\nerr:\r\ndev_dbg(&client->dev, "failed %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int it913x_remove(struct i2c_client *client)\r\n{\r\nstruct it913x_dev *dev = i2c_get_clientdata(client);\r\nstruct dvb_frontend *fe = dev->fe;\r\ndev_dbg(&client->dev, "\n");\r\nmemset(&fe->ops.tuner_ops, 0, sizeof(struct dvb_tuner_ops));\r\nfe->tuner_priv = NULL;\r\nregmap_exit(dev->regmap);\r\nkfree(dev);\r\nreturn 0;\r\n}

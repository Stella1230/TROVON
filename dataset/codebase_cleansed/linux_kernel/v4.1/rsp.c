static void nci_core_reset_rsp_packet(struct nci_dev *ndev, struct sk_buff *skb)\r\n{\r\nstruct nci_core_reset_rsp *rsp = (void *) skb->data;\r\npr_debug("status 0x%x\n", rsp->status);\r\nif (rsp->status == NCI_STATUS_OK) {\r\nndev->nci_ver = rsp->nci_ver;\r\npr_debug("nci_ver 0x%x, config_status 0x%x\n",\r\nrsp->nci_ver, rsp->config_status);\r\n}\r\nnci_req_complete(ndev, rsp->status);\r\n}\r\nstatic void nci_core_init_rsp_packet(struct nci_dev *ndev, struct sk_buff *skb)\r\n{\r\nstruct nci_core_init_rsp_1 *rsp_1 = (void *) skb->data;\r\nstruct nci_core_init_rsp_2 *rsp_2;\r\npr_debug("status 0x%x\n", rsp_1->status);\r\nif (rsp_1->status != NCI_STATUS_OK)\r\ngoto exit;\r\nndev->nfcc_features = __le32_to_cpu(rsp_1->nfcc_features);\r\nndev->num_supported_rf_interfaces = rsp_1->num_supported_rf_interfaces;\r\nif (ndev->num_supported_rf_interfaces >\r\nNCI_MAX_SUPPORTED_RF_INTERFACES) {\r\nndev->num_supported_rf_interfaces =\r\nNCI_MAX_SUPPORTED_RF_INTERFACES;\r\n}\r\nmemcpy(ndev->supported_rf_interfaces,\r\nrsp_1->supported_rf_interfaces,\r\nndev->num_supported_rf_interfaces);\r\nrsp_2 = (void *) (skb->data + 6 + rsp_1->num_supported_rf_interfaces);\r\nndev->max_logical_connections = rsp_2->max_logical_connections;\r\nndev->max_routing_table_size =\r\n__le16_to_cpu(rsp_2->max_routing_table_size);\r\nndev->max_ctrl_pkt_payload_len =\r\nrsp_2->max_ctrl_pkt_payload_len;\r\nndev->max_size_for_large_params =\r\n__le16_to_cpu(rsp_2->max_size_for_large_params);\r\nndev->manufact_id =\r\nrsp_2->manufact_id;\r\nndev->manufact_specific_info =\r\n__le32_to_cpu(rsp_2->manufact_specific_info);\r\npr_debug("nfcc_features 0x%x\n",\r\nndev->nfcc_features);\r\npr_debug("num_supported_rf_interfaces %d\n",\r\nndev->num_supported_rf_interfaces);\r\npr_debug("supported_rf_interfaces[0] 0x%x\n",\r\nndev->supported_rf_interfaces[0]);\r\npr_debug("supported_rf_interfaces[1] 0x%x\n",\r\nndev->supported_rf_interfaces[1]);\r\npr_debug("supported_rf_interfaces[2] 0x%x\n",\r\nndev->supported_rf_interfaces[2]);\r\npr_debug("supported_rf_interfaces[3] 0x%x\n",\r\nndev->supported_rf_interfaces[3]);\r\npr_debug("max_logical_connections %d\n",\r\nndev->max_logical_connections);\r\npr_debug("max_routing_table_size %d\n",\r\nndev->max_routing_table_size);\r\npr_debug("max_ctrl_pkt_payload_len %d\n",\r\nndev->max_ctrl_pkt_payload_len);\r\npr_debug("max_size_for_large_params %d\n",\r\nndev->max_size_for_large_params);\r\npr_debug("manufact_id 0x%x\n",\r\nndev->manufact_id);\r\npr_debug("manufact_specific_info 0x%x\n",\r\nndev->manufact_specific_info);\r\nexit:\r\nnci_req_complete(ndev, rsp_1->status);\r\n}\r\nstatic void nci_core_set_config_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct nci_core_set_config_rsp *rsp = (void *) skb->data;\r\npr_debug("status 0x%x\n", rsp->status);\r\nnci_req_complete(ndev, rsp->status);\r\n}\r\nstatic void nci_rf_disc_map_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\n__u8 status = skb->data[0];\r\npr_debug("status 0x%x\n", status);\r\nnci_req_complete(ndev, status);\r\n}\r\nstatic void nci_rf_disc_rsp_packet(struct nci_dev *ndev, struct sk_buff *skb)\r\n{\r\nstruct nci_conn_info *conn_info;\r\n__u8 status = skb->data[0];\r\npr_debug("status 0x%x\n", status);\r\nif (status == NCI_STATUS_OK) {\r\natomic_set(&ndev->state, NCI_DISCOVERY);\r\nconn_info = ndev->rf_conn_info;\r\nif (!conn_info) {\r\nconn_info = devm_kzalloc(&ndev->nfc_dev->dev,\r\nsizeof(struct nci_conn_info),\r\nGFP_KERNEL);\r\nif (!conn_info) {\r\nstatus = NCI_STATUS_REJECTED;\r\ngoto exit;\r\n}\r\nconn_info->conn_id = NCI_STATIC_RF_CONN_ID;\r\nINIT_LIST_HEAD(&conn_info->list);\r\nlist_add(&conn_info->list, &ndev->conn_info_list);\r\nndev->rf_conn_info = conn_info;\r\n}\r\n}\r\nexit:\r\nnci_req_complete(ndev, status);\r\n}\r\nstatic void nci_rf_disc_select_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\n__u8 status = skb->data[0];\r\npr_debug("status 0x%x\n", status);\r\nif (status != NCI_STATUS_OK)\r\nnci_req_complete(ndev, status);\r\n}\r\nstatic void nci_rf_deactivate_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\n__u8 status = skb->data[0];\r\npr_debug("status 0x%x\n", status);\r\nif ((status != NCI_STATUS_OK) ||\r\n(atomic_read(&ndev->state) != NCI_POLL_ACTIVE)) {\r\nnci_clear_target_list(ndev);\r\natomic_set(&ndev->state, NCI_IDLE);\r\nnci_req_complete(ndev, status);\r\n}\r\n}\r\nstatic void nci_nfcee_discover_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct nci_nfcee_discover_rsp *discover_rsp;\r\nif (skb->len != 2) {\r\nnci_req_complete(ndev, NCI_STATUS_NFCEE_PROTOCOL_ERROR);\r\nreturn;\r\n}\r\ndiscover_rsp = (struct nci_nfcee_discover_rsp *)skb->data;\r\nif (discover_rsp->status != NCI_STATUS_OK ||\r\ndiscover_rsp->num_nfcee == 0)\r\nnci_req_complete(ndev, discover_rsp->status);\r\n}\r\nstatic void nci_nfcee_mode_set_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\n__u8 status = skb->data[0];\r\npr_debug("status 0x%x\n", status);\r\nnci_req_complete(ndev, status);\r\n}\r\nstatic void nci_core_conn_create_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\n__u8 status = skb->data[0];\r\nstruct nci_conn_info *conn_info;\r\nstruct nci_core_conn_create_rsp *rsp;\r\npr_debug("status 0x%x\n", status);\r\nif (status == NCI_STATUS_OK) {\r\nrsp = (struct nci_core_conn_create_rsp *)skb->data;\r\nconn_info = devm_kzalloc(&ndev->nfc_dev->dev,\r\nsizeof(*conn_info), GFP_KERNEL);\r\nif (!conn_info) {\r\nstatus = NCI_STATUS_REJECTED;\r\ngoto exit;\r\n}\r\nconn_info->id = ndev->cur_id;\r\nconn_info->conn_id = rsp->conn_id;\r\nINIT_LIST_HEAD(&conn_info->list);\r\nlist_add(&conn_info->list, &ndev->conn_info_list);\r\nif (ndev->cur_id == ndev->hci_dev->nfcee_id)\r\nndev->hci_dev->conn_info = conn_info;\r\nconn_info->conn_id = rsp->conn_id;\r\nconn_info->max_pkt_payload_len = rsp->max_ctrl_pkt_payload_len;\r\natomic_set(&conn_info->credits_cnt, rsp->credits_cnt);\r\n}\r\nexit:\r\nnci_req_complete(ndev, status);\r\n}\r\nstatic void nci_core_conn_close_rsp_packet(struct nci_dev *ndev,\r\nstruct sk_buff *skb)\r\n{\r\nstruct nci_conn_info *conn_info;\r\n__u8 status = skb->data[0];\r\npr_debug("status 0x%x\n", status);\r\nif (status == NCI_STATUS_OK) {\r\nconn_info = nci_get_conn_info_by_conn_id(ndev, ndev->cur_id);\r\nif (conn_info) {\r\nlist_del(&conn_info->list);\r\ndevm_kfree(&ndev->nfc_dev->dev, conn_info);\r\n}\r\n}\r\nnci_req_complete(ndev, status);\r\n}\r\nvoid nci_rsp_packet(struct nci_dev *ndev, struct sk_buff *skb)\r\n{\r\n__u16 rsp_opcode = nci_opcode(skb->data);\r\ndel_timer(&ndev->cmd_timer);\r\npr_debug("NCI RX: MT=rsp, PBF=%d, GID=0x%x, OID=0x%x, plen=%d\n",\r\nnci_pbf(skb->data),\r\nnci_opcode_gid(rsp_opcode),\r\nnci_opcode_oid(rsp_opcode),\r\nnci_plen(skb->data));\r\nskb_pull(skb, NCI_CTRL_HDR_SIZE);\r\nswitch (rsp_opcode) {\r\ncase NCI_OP_CORE_RESET_RSP:\r\nnci_core_reset_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_CORE_INIT_RSP:\r\nnci_core_init_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_CORE_SET_CONFIG_RSP:\r\nnci_core_set_config_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_CORE_CONN_CREATE_RSP:\r\nnci_core_conn_create_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_CORE_CONN_CLOSE_RSP:\r\nnci_core_conn_close_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_RF_DISCOVER_MAP_RSP:\r\nnci_rf_disc_map_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_RF_DISCOVER_RSP:\r\nnci_rf_disc_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_RF_DISCOVER_SELECT_RSP:\r\nnci_rf_disc_select_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_RF_DEACTIVATE_RSP:\r\nnci_rf_deactivate_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_NFCEE_DISCOVER_RSP:\r\nnci_nfcee_discover_rsp_packet(ndev, skb);\r\nbreak;\r\ncase NCI_OP_NFCEE_MODE_SET_RSP:\r\nnci_nfcee_mode_set_rsp_packet(ndev, skb);\r\nbreak;\r\ndefault:\r\npr_err("unknown rsp opcode 0x%x\n", rsp_opcode);\r\nbreak;\r\n}\r\nkfree_skb(skb);\r\natomic_set(&ndev->cmd_cnt, 1);\r\nif (!skb_queue_empty(&ndev->cmd_q))\r\nqueue_work(ndev->cmd_wq, &ndev->cmd_work);\r\n}

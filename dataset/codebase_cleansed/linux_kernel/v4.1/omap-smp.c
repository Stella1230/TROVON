void __iomem *omap4_get_scu_base(void)\r\n{\r\nreturn scu_base;\r\n}\r\nstatic void omap4_secondary_init(unsigned int cpu)\r\n{\r\nif (cpu_is_omap443x() && (omap_type() != OMAP2_DEVICE_TYPE_GP))\r\nomap_secure_dispatcher(OMAP4_PPA_CPU_ACTRL_SMP_INDEX,\r\n4, 0, 0, 0, 0, 0);\r\nif (soc_is_omap54xx() || soc_is_dra7xx())\r\nset_cntfreq();\r\nspin_lock(&boot_lock);\r\nspin_unlock(&boot_lock);\r\n}\r\nstatic int omap4_boot_secondary(unsigned int cpu, struct task_struct *idle)\r\n{\r\nstatic struct clockdomain *cpu1_clkdm;\r\nstatic bool booted;\r\nstatic struct powerdomain *cpu1_pwrdm;\r\nvoid __iomem *base = omap_get_wakeupgen_base();\r\nspin_lock(&boot_lock);\r\nif (omap_secure_apis_support())\r\nomap_modify_auxcoreboot0(0x200, 0xfffffdff);\r\nelse\r\nwritel_relaxed(0x20, base + OMAP_AUX_CORE_BOOT_0);\r\nif (!cpu1_clkdm && !cpu1_pwrdm) {\r\ncpu1_clkdm = clkdm_lookup("mpu1_clkdm");\r\ncpu1_pwrdm = pwrdm_lookup("cpu1_pwrdm");\r\n}\r\nif (booted && cpu1_pwrdm && cpu1_clkdm) {\r\nif (IS_PM44XX_ERRATUM(PM_OMAP4_ROM_SMP_BOOT_ERRATUM_GICD)) {\r\nlocal_irq_disable();\r\ngic_dist_disable();\r\n}\r\nclkdm_wakeup(cpu1_clkdm);\r\nomap_set_pwrdm_state(cpu1_pwrdm, PWRDM_POWER_ON);\r\nclkdm_allow_idle(cpu1_clkdm);\r\nif (IS_PM44XX_ERRATUM(PM_OMAP4_ROM_SMP_BOOT_ERRATUM_GICD)) {\r\nwhile (gic_dist_disabled()) {\r\nudelay(1);\r\ncpu_relax();\r\n}\r\ngic_timer_retrigger();\r\nlocal_irq_enable();\r\n}\r\n} else {\r\ndsb_sev();\r\nbooted = true;\r\n}\r\narch_send_wakeup_ipi_mask(cpumask_of(cpu));\r\nspin_unlock(&boot_lock);\r\nreturn 0;\r\n}\r\nstatic void __init omap4_smp_init_cpus(void)\r\n{\r\nunsigned int i = 0, ncores = 1, cpu_id;\r\ncpu_id = read_cpuid_id() & CPU_MASK;\r\nif (cpu_id == CPU_CORTEX_A9) {\r\nscu_base = OMAP2_L4_IO_ADDRESS(scu_a9_get_base());\r\nBUG_ON(!scu_base);\r\nncores = scu_get_core_count(scu_base);\r\n} else if (cpu_id == CPU_CORTEX_A15) {\r\nncores = OMAP5_CORE_COUNT;\r\n}\r\nif (ncores > nr_cpu_ids) {\r\npr_warn("SMP: %u cores greater than maximum (%u), clipping\n",\r\nncores, nr_cpu_ids);\r\nncores = nr_cpu_ids;\r\n}\r\nfor (i = 0; i < ncores; i++)\r\nset_cpu_possible(i, true);\r\n}\r\nstatic void __init omap4_smp_prepare_cpus(unsigned int max_cpus)\r\n{\r\nvoid *startup_addr = omap4_secondary_startup;\r\nvoid __iomem *base = omap_get_wakeupgen_base();\r\nif (scu_base)\r\nscu_enable(scu_base);\r\nif (cpu_is_omap446x())\r\nstartup_addr = omap4460_secondary_startup;\r\nif (omap_secure_apis_support())\r\nomap_auxcoreboot_addr(virt_to_phys(startup_addr));\r\nelse\r\nif ((__boot_cpu_mode & MODE_MASK) == HYP_MODE)\r\nwritel_relaxed(virt_to_phys(omap5_secondary_hyp_startup),\r\nbase + OMAP_AUX_CORE_BOOT_1);\r\nelse\r\nwritel_relaxed(virt_to_phys(omap5_secondary_startup),\r\nbase + OMAP_AUX_CORE_BOOT_1);\r\n}

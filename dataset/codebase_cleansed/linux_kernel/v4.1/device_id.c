static int diag210_to_senseid(struct senseid *senseid, struct diag210 *diag)\r\n{\r\nstatic struct {\r\nint class, type, cu_type;\r\n} vm_devices[] = {\r\n{ 0x08, 0x01, 0x3480 },\r\n{ 0x08, 0x02, 0x3430 },\r\n{ 0x08, 0x10, 0x3420 },\r\n{ 0x08, 0x42, 0x3424 },\r\n{ 0x08, 0x44, 0x9348 },\r\n{ 0x08, 0x81, 0x3490 },\r\n{ 0x08, 0x82, 0x3422 },\r\n{ 0x10, 0x41, 0x1403 },\r\n{ 0x10, 0x42, 0x3211 },\r\n{ 0x10, 0x43, 0x3203 },\r\n{ 0x10, 0x45, 0x3800 },\r\n{ 0x10, 0x47, 0x3262 },\r\n{ 0x10, 0x48, 0x3820 },\r\n{ 0x10, 0x49, 0x3800 },\r\n{ 0x10, 0x4a, 0x4245 },\r\n{ 0x10, 0x4b, 0x4248 },\r\n{ 0x10, 0x4d, 0x3800 },\r\n{ 0x10, 0x4e, 0x3820 },\r\n{ 0x10, 0x4f, 0x3820 },\r\n{ 0x10, 0x82, 0x2540 },\r\n{ 0x10, 0x84, 0x3525 },\r\n{ 0x20, 0x81, 0x2501 },\r\n{ 0x20, 0x82, 0x2540 },\r\n{ 0x20, 0x84, 0x3505 },\r\n{ 0x40, 0x01, 0x3278 },\r\n{ 0x40, 0x04, 0x3277 },\r\n{ 0x40, 0x80, 0x2250 },\r\n{ 0x40, 0xc0, 0x5080 },\r\n{ 0x80, 0x00, 0x3215 },\r\n};\r\nint i;\r\nif (diag->vrdcvcla == 0x02 && diag->vrdcvtyp == 0x20) {\r\nsenseid->cu_type = 0x3088;\r\nsenseid->cu_model = 0x60;\r\nsenseid->reserved = 0xff;\r\nreturn 0;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(vm_devices); i++) {\r\nif (diag->vrdcvcla == vm_devices[i].class &&\r\ndiag->vrdcvtyp == vm_devices[i].type) {\r\nsenseid->cu_type = vm_devices[i].cu_type;\r\nsenseid->reserved = 0xff;\r\nreturn 0;\r\n}\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int diag210_get_dev_info(struct ccw_device *cdev)\r\n{\r\nstruct ccw_dev_id *dev_id = &cdev->private->dev_id;\r\nstruct senseid *senseid = &cdev->private->senseid;\r\nstruct diag210 diag_data;\r\nint rc;\r\nif (dev_id->ssid != 0)\r\nreturn -ENODEV;\r\nmemset(&diag_data, 0, sizeof(diag_data));\r\ndiag_data.vrdcdvno = dev_id->devno;\r\ndiag_data.vrdclen = sizeof(diag_data);\r\nrc = diag210(&diag_data);\r\nCIO_TRACE_EVENT(4, "diag210");\r\nCIO_HEX_EVENT(4, &rc, sizeof(rc));\r\nCIO_HEX_EVENT(4, &diag_data, sizeof(diag_data));\r\nif (rc != 0 && rc != 2)\r\ngoto err_failed;\r\nif (diag210_to_senseid(senseid, &diag_data))\r\ngoto err_unknown;\r\nreturn 0;\r\nerr_unknown:\r\nCIO_MSG_EVENT(0, "snsid: device 0.%x.%04x: unknown diag210 data\n",\r\ndev_id->ssid, dev_id->devno);\r\nreturn -ENODEV;\r\nerr_failed:\r\nCIO_MSG_EVENT(0, "snsid: device 0.%x.%04x: diag210 failed (rc=%d)\n",\r\ndev_id->ssid, dev_id->devno, rc);\r\nreturn -ENODEV;\r\n}\r\nstatic void snsid_init(struct ccw_device *cdev)\r\n{\r\ncdev->private->flags.esid = 0;\r\nmemset(&cdev->private->senseid, 0, sizeof(cdev->private->senseid));\r\ncdev->private->senseid.cu_type = 0xffff;\r\n}\r\nstatic int snsid_check(struct ccw_device *cdev, void *data)\r\n{\r\nstruct cmd_scsw *scsw = &cdev->private->irb.scsw.cmd;\r\nint len = sizeof(struct senseid) - scsw->count;\r\nif (len < SENSE_ID_MIN_LEN)\r\ngoto out_restart;\r\nif (cdev->private->senseid.cu_type == 0xffff)\r\ngoto out_restart;\r\nif (cdev->private->senseid.reserved != 0xff)\r\nreturn -EOPNOTSUPP;\r\nif (len > SENSE_ID_BASIC_LEN)\r\ncdev->private->flags.esid = 1;\r\nreturn 0;\r\nout_restart:\r\nsnsid_init(cdev);\r\nreturn -EAGAIN;\r\n}\r\nstatic void snsid_callback(struct ccw_device *cdev, void *data, int rc)\r\n{\r\nstruct ccw_dev_id *id = &cdev->private->dev_id;\r\nstruct senseid *senseid = &cdev->private->senseid;\r\nint vm = 0;\r\nif (rc && MACHINE_IS_VM) {\r\nsnsid_init(cdev);\r\nif (diag210_get_dev_info(cdev) == 0) {\r\nrc = 0;\r\nvm = 1;\r\n}\r\n}\r\nCIO_MSG_EVENT(2, "snsid: device 0.%x.%04x: rc=%d %04x/%02x "\r\n"%04x/%02x%s\n", id->ssid, id->devno, rc,\r\nsenseid->cu_type, senseid->cu_model, senseid->dev_type,\r\nsenseid->dev_model, vm ? " (diag210)" : "");\r\nccw_device_sense_id_done(cdev, rc);\r\n}\r\nvoid ccw_device_sense_id_start(struct ccw_device *cdev)\r\n{\r\nstruct subchannel *sch = to_subchannel(cdev->dev.parent);\r\nstruct ccw_request *req = &cdev->private->req;\r\nstruct ccw1 *cp = cdev->private->iccws;\r\nCIO_TRACE_EVENT(4, "snsid");\r\nCIO_HEX_EVENT(4, &cdev->private->dev_id, sizeof(cdev->private->dev_id));\r\nsnsid_init(cdev);\r\ncp->cmd_code = CCW_CMD_SENSE_ID;\r\ncp->cda = (u32) (addr_t) &cdev->private->senseid;\r\ncp->count = sizeof(struct senseid);\r\ncp->flags = CCW_FLAG_SLI;\r\nmemset(req, 0, sizeof(*req));\r\nreq->cp = cp;\r\nreq->timeout = SENSE_ID_TIMEOUT;\r\nreq->maxretries = SENSE_ID_RETRIES;\r\nreq->lpm = sch->schib.pmcw.pam & sch->opm;\r\nreq->check = snsid_check;\r\nreq->callback = snsid_callback;\r\nccw_request_start(cdev);\r\n}

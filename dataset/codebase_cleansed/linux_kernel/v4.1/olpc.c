static int is_simulated(unsigned int bus, unsigned int devfn)\r\n{\r\nreturn (!bus && ((PCI_SLOT(devfn) == NB_SLOT) ||\r\n(PCI_SLOT(devfn) == SB_SLOT)));\r\n}\r\nstatic uint32_t *hdr_addr(const uint32_t *hdr, int reg)\r\n{\r\nuint32_t addr;\r\naddr = (uint32_t)hdr + reg + (bar_probing ? -0x10 : 0x20);\r\nbar_probing = 0;\r\nreturn (uint32_t *)addr;\r\n}\r\nstatic int pci_olpc_read(unsigned int seg, unsigned int bus,\r\nunsigned int devfn, int reg, int len, uint32_t *value)\r\n{\r\nuint32_t *addr;\r\nWARN_ON(seg);\r\nif (!is_simulated(bus, devfn))\r\nreturn pci_direct_conf1.read(seg, bus, devfn, reg, len, value);\r\nif (reg >= 0x70)\r\naddr = &zero_loc;\r\nelse {\r\nswitch (devfn) {\r\ncase 0x8:\r\naddr = hdr_addr(is_lx ? lxnb_hdr : gxnb_hdr, reg);\r\nbreak;\r\ncase 0x9:\r\naddr = hdr_addr(is_lx ? lxfb_hdr : gxfb_hdr, reg);\r\nbreak;\r\ncase 0xa:\r\naddr = is_lx ? hdr_addr(aes_hdr, reg) : &ff_loc;\r\nbreak;\r\ncase 0x78:\r\naddr = hdr_addr(isa_hdr, reg);\r\nbreak;\r\ncase 0x7b:\r\naddr = hdr_addr(ac97_hdr, reg);\r\nbreak;\r\ncase 0x7c:\r\naddr = hdr_addr(ohci_hdr, reg);\r\nbreak;\r\ncase 0x7d:\r\naddr = hdr_addr(ehci_hdr, reg);\r\nbreak;\r\ndefault:\r\naddr = &ff_loc;\r\nbreak;\r\n}\r\n}\r\nswitch (len) {\r\ncase 1:\r\n*value = *(uint8_t *)addr;\r\nbreak;\r\ncase 2:\r\n*value = *(uint16_t *)addr;\r\nbreak;\r\ncase 4:\r\n*value = *addr;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nreturn 0;\r\n}\r\nstatic int pci_olpc_write(unsigned int seg, unsigned int bus,\r\nunsigned int devfn, int reg, int len, uint32_t value)\r\n{\r\nWARN_ON(seg);\r\nif (!is_simulated(bus, devfn))\r\nreturn pci_direct_conf1.write(seg, bus, devfn, reg, len, value);\r\nif ((reg >= 0x10) && (reg < 0x2c)) {\r\nif (value == ~0)\r\nbar_probing = 1;\r\n} else {\r\nif ((reg != PCI_ROM_ADDRESS) && (reg != PCI_COMMAND_MASTER) &&\r\n(reg != PCI_LATENCY_TIMER) &&\r\n(reg != PCI_CACHE_LINE_SIZE) && (reg != 0x44))\r\nprintk(KERN_WARNING "OLPC PCI: Config write to devfn"\r\n" %x reg %x value %x\n", devfn, reg, value);\r\n}\r\nreturn 0;\r\n}\r\nint __init pci_olpc_init(void)\r\n{\r\nprintk(KERN_INFO "PCI: Using configuration type OLPC XO-1\n");\r\nraw_pci_ops = &pci_olpc_conf;\r\nis_lx = is_geode_lx();\r\nreturn 0;\r\n}

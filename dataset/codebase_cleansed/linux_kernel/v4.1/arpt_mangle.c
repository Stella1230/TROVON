static unsigned int\r\ntarget(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct arpt_mangle *mangle = par->targinfo;\r\nconst struct arphdr *arp;\r\nunsigned char *arpptr;\r\nint pln, hln;\r\nif (!skb_make_writable(skb, skb->len))\r\nreturn NF_DROP;\r\narp = arp_hdr(skb);\r\narpptr = skb_network_header(skb) + sizeof(*arp);\r\npln = arp->ar_pln;\r\nhln = arp->ar_hln;\r\nif (mangle->flags & ARPT_MANGLE_SDEV) {\r\nif (ARPT_DEV_ADDR_LEN_MAX < hln ||\r\n(arpptr + hln > skb_tail_pointer(skb)))\r\nreturn NF_DROP;\r\nmemcpy(arpptr, mangle->src_devaddr, hln);\r\n}\r\narpptr += hln;\r\nif (mangle->flags & ARPT_MANGLE_SIP) {\r\nif (ARPT_MANGLE_ADDR_LEN_MAX < pln ||\r\n(arpptr + pln > skb_tail_pointer(skb)))\r\nreturn NF_DROP;\r\nmemcpy(arpptr, &mangle->u_s.src_ip, pln);\r\n}\r\narpptr += pln;\r\nif (mangle->flags & ARPT_MANGLE_TDEV) {\r\nif (ARPT_DEV_ADDR_LEN_MAX < hln ||\r\n(arpptr + hln > skb_tail_pointer(skb)))\r\nreturn NF_DROP;\r\nmemcpy(arpptr, mangle->tgt_devaddr, hln);\r\n}\r\narpptr += hln;\r\nif (mangle->flags & ARPT_MANGLE_TIP) {\r\nif (ARPT_MANGLE_ADDR_LEN_MAX < pln ||\r\n(arpptr + pln > skb_tail_pointer(skb)))\r\nreturn NF_DROP;\r\nmemcpy(arpptr, &mangle->u_t.tgt_ip, pln);\r\n}\r\nreturn mangle->target;\r\n}\r\nstatic int checkentry(const struct xt_tgchk_param *par)\r\n{\r\nconst struct arpt_mangle *mangle = par->targinfo;\r\nif (mangle->flags & ~ARPT_MANGLE_MASK ||\r\n!(mangle->flags & ARPT_MANGLE_MASK))\r\nreturn -EINVAL;\r\nif (mangle->target != NF_DROP && mangle->target != NF_ACCEPT &&\r\nmangle->target != XT_CONTINUE)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init arpt_mangle_init(void)\r\n{\r\nreturn xt_register_target(&arpt_mangle_reg);\r\n}\r\nstatic void __exit arpt_mangle_fini(void)\r\n{\r\nxt_unregister_target(&arpt_mangle_reg);\r\n}

void __init txx9_7segled_init(unsigned int num,\r\nvoid (*putc)(unsigned int pos, unsigned char val))\r\n{\r\ntx_7segled_num = num;\r\ntx_7segled_putc = putc;\r\n}\r\nint txx9_7segled_putc(unsigned int pos, char c)\r\n{\r\nif (pos >= tx_7segled_num)\r\nreturn -EINVAL;\r\nc = map_to_seg7(&txx9_seg7map, c);\r\nif (c < 0)\r\nreturn c;\r\ntx_7segled_putc(pos, c);\r\nreturn 0;\r\n}\r\nstatic ssize_t ascii_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nunsigned int ch = dev->id;\r\ntxx9_7segled_putc(ch, buf[0]);\r\nreturn size;\r\n}\r\nstatic ssize_t raw_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nunsigned int ch = dev->id;\r\ntx_7segled_putc(ch, buf[0]);\r\nreturn size;\r\n}\r\nstatic ssize_t map_seg7_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nmemcpy(buf, &txx9_seg7map, sizeof(txx9_seg7map));\r\nreturn sizeof(txx9_seg7map);\r\n}\r\nstatic ssize_t map_seg7_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nif (size != sizeof(txx9_seg7map))\r\nreturn -EINVAL;\r\nmemcpy(&txx9_seg7map, buf, size);\r\nreturn size;\r\n}\r\nstatic void tx_7segled_release(struct device *dev)\r\n{\r\nkfree(dev);\r\n}\r\nstatic int __init tx_7segled_init_sysfs(void)\r\n{\r\nint error, i;\r\nif (!tx_7segled_num)\r\nreturn -ENODEV;\r\nerror = subsys_system_register(&tx_7segled_subsys, NULL);\r\nif (error)\r\nreturn error;\r\nerror = device_create_file(tx_7segled_subsys.dev_root, &dev_attr_map_seg7);\r\nif (error)\r\nreturn error;\r\nfor (i = 0; i < tx_7segled_num; i++) {\r\nstruct device *dev;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev) {\r\nerror = -ENODEV;\r\nbreak;\r\n}\r\ndev->id = i;\r\ndev->bus = &tx_7segled_subsys;\r\ndev->release = &tx_7segled_release;\r\nerror = device_register(dev);\r\nif (error) {\r\nput_device(dev);\r\nreturn error;\r\n}\r\ndevice_create_file(dev, &dev_attr_ascii);\r\ndevice_create_file(dev, &dev_attr_raw);\r\n}\r\nreturn error;\r\n}

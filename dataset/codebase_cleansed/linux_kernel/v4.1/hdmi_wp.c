void hdmi_wp_dump(struct hdmi_wp_data *wp, struct seq_file *s)\r\n{\r\n#define DUMPREG(r) seq_printf(s, "%-35s %08x\n", #r, hdmi_read_reg(wp->base, r))\r\nDUMPREG(HDMI_WP_REVISION);\r\nDUMPREG(HDMI_WP_SYSCONFIG);\r\nDUMPREG(HDMI_WP_IRQSTATUS_RAW);\r\nDUMPREG(HDMI_WP_IRQSTATUS);\r\nDUMPREG(HDMI_WP_IRQENABLE_SET);\r\nDUMPREG(HDMI_WP_IRQENABLE_CLR);\r\nDUMPREG(HDMI_WP_IRQWAKEEN);\r\nDUMPREG(HDMI_WP_PWR_CTRL);\r\nDUMPREG(HDMI_WP_DEBOUNCE);\r\nDUMPREG(HDMI_WP_VIDEO_CFG);\r\nDUMPREG(HDMI_WP_VIDEO_SIZE);\r\nDUMPREG(HDMI_WP_VIDEO_TIMING_H);\r\nDUMPREG(HDMI_WP_VIDEO_TIMING_V);\r\nDUMPREG(HDMI_WP_CLK);\r\nDUMPREG(HDMI_WP_AUDIO_CFG);\r\nDUMPREG(HDMI_WP_AUDIO_CFG2);\r\nDUMPREG(HDMI_WP_AUDIO_CTRL);\r\nDUMPREG(HDMI_WP_AUDIO_DATA);\r\n}\r\nu32 hdmi_wp_get_irqstatus(struct hdmi_wp_data *wp)\r\n{\r\nreturn hdmi_read_reg(wp->base, HDMI_WP_IRQSTATUS);\r\n}\r\nvoid hdmi_wp_set_irqstatus(struct hdmi_wp_data *wp, u32 irqstatus)\r\n{\r\nhdmi_write_reg(wp->base, HDMI_WP_IRQSTATUS, irqstatus);\r\nhdmi_read_reg(wp->base, HDMI_WP_IRQSTATUS);\r\n}\r\nvoid hdmi_wp_set_irqenable(struct hdmi_wp_data *wp, u32 mask)\r\n{\r\nhdmi_write_reg(wp->base, HDMI_WP_IRQENABLE_SET, mask);\r\n}\r\nvoid hdmi_wp_clear_irqenable(struct hdmi_wp_data *wp, u32 mask)\r\n{\r\nhdmi_write_reg(wp->base, HDMI_WP_IRQENABLE_CLR, mask);\r\n}\r\nint hdmi_wp_set_phy_pwr(struct hdmi_wp_data *wp, enum hdmi_phy_pwr val)\r\n{\r\nif (REG_GET(wp->base, HDMI_WP_PWR_CTRL, 5, 4) == val)\r\nreturn 0;\r\nREG_FLD_MOD(wp->base, HDMI_WP_PWR_CTRL, val, 7, 6);\r\nif (hdmi_wait_for_bit_change(wp->base, HDMI_WP_PWR_CTRL, 5, 4, val)\r\n!= val) {\r\nDSSERR("Failed to set PHY power mode to %d\n", val);\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nint hdmi_wp_set_pll_pwr(struct hdmi_wp_data *wp, enum hdmi_pll_pwr val)\r\n{\r\nREG_FLD_MOD(wp->base, HDMI_WP_PWR_CTRL, val, 3, 2);\r\nif (hdmi_wait_for_bit_change(wp->base, HDMI_WP_PWR_CTRL, 1, 0, val)\r\n!= val) {\r\nDSSERR("Failed to set PLL_PWR_STATUS\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nint hdmi_wp_video_start(struct hdmi_wp_data *wp)\r\n{\r\nREG_FLD_MOD(wp->base, HDMI_WP_VIDEO_CFG, true, 31, 31);\r\nreturn 0;\r\n}\r\nvoid hdmi_wp_video_stop(struct hdmi_wp_data *wp)\r\n{\r\nREG_FLD_MOD(wp->base, HDMI_WP_VIDEO_CFG, false, 31, 31);\r\n}\r\nvoid hdmi_wp_video_config_format(struct hdmi_wp_data *wp,\r\nstruct hdmi_video_format *video_fmt)\r\n{\r\nu32 l = 0;\r\nREG_FLD_MOD(wp->base, HDMI_WP_VIDEO_CFG, video_fmt->packing_mode,\r\n10, 8);\r\nl |= FLD_VAL(video_fmt->y_res, 31, 16);\r\nl |= FLD_VAL(video_fmt->x_res, 15, 0);\r\nhdmi_write_reg(wp->base, HDMI_WP_VIDEO_SIZE, l);\r\n}\r\nvoid hdmi_wp_video_config_interface(struct hdmi_wp_data *wp,\r\nstruct omap_video_timings *timings)\r\n{\r\nu32 r;\r\nbool vsync_pol, hsync_pol;\r\nDSSDBG("Enter hdmi_wp_video_config_interface\n");\r\nvsync_pol = timings->vsync_level == OMAPDSS_SIG_ACTIVE_HIGH;\r\nhsync_pol = timings->hsync_level == OMAPDSS_SIG_ACTIVE_HIGH;\r\nr = hdmi_read_reg(wp->base, HDMI_WP_VIDEO_CFG);\r\nr = FLD_MOD(r, vsync_pol, 7, 7);\r\nr = FLD_MOD(r, hsync_pol, 6, 6);\r\nr = FLD_MOD(r, timings->interlace, 3, 3);\r\nr = FLD_MOD(r, 1, 1, 0);\r\nhdmi_write_reg(wp->base, HDMI_WP_VIDEO_CFG, r);\r\n}\r\nvoid hdmi_wp_video_config_timing(struct hdmi_wp_data *wp,\r\nstruct omap_video_timings *timings)\r\n{\r\nu32 timing_h = 0;\r\nu32 timing_v = 0;\r\nDSSDBG("Enter hdmi_wp_video_config_timing\n");\r\ntiming_h |= FLD_VAL(timings->hbp, 31, 20);\r\ntiming_h |= FLD_VAL(timings->hfp, 19, 8);\r\ntiming_h |= FLD_VAL(timings->hsw, 7, 0);\r\nhdmi_write_reg(wp->base, HDMI_WP_VIDEO_TIMING_H, timing_h);\r\ntiming_v |= FLD_VAL(timings->vbp, 31, 20);\r\ntiming_v |= FLD_VAL(timings->vfp, 19, 8);\r\ntiming_v |= FLD_VAL(timings->vsw, 7, 0);\r\nhdmi_write_reg(wp->base, HDMI_WP_VIDEO_TIMING_V, timing_v);\r\n}\r\nvoid hdmi_wp_init_vid_fmt_timings(struct hdmi_video_format *video_fmt,\r\nstruct omap_video_timings *timings, struct hdmi_config *param)\r\n{\r\nDSSDBG("Enter hdmi_wp_video_init_format\n");\r\nvideo_fmt->packing_mode = HDMI_PACK_10b_RGB_YUV444;\r\nvideo_fmt->y_res = param->timings.y_res;\r\nvideo_fmt->x_res = param->timings.x_res;\r\nif (param->timings.interlace)\r\nvideo_fmt->y_res /= 2;\r\ntimings->hbp = param->timings.hbp;\r\ntimings->hfp = param->timings.hfp;\r\ntimings->hsw = param->timings.hsw;\r\ntimings->vbp = param->timings.vbp;\r\ntimings->vfp = param->timings.vfp;\r\ntimings->vsw = param->timings.vsw;\r\ntimings->vsync_level = param->timings.vsync_level;\r\ntimings->hsync_level = param->timings.hsync_level;\r\ntimings->interlace = param->timings.interlace;\r\n}\r\nvoid hdmi_wp_audio_config_format(struct hdmi_wp_data *wp,\r\nstruct hdmi_audio_format *aud_fmt)\r\n{\r\nu32 r;\r\nDSSDBG("Enter hdmi_wp_audio_config_format\n");\r\nr = hdmi_read_reg(wp->base, HDMI_WP_AUDIO_CFG);\r\nif (omapdss_get_version() == OMAPDSS_VER_OMAP4430_ES1 ||\r\nomapdss_get_version() == OMAPDSS_VER_OMAP4430_ES2 ||\r\nomapdss_get_version() == OMAPDSS_VER_OMAP4) {\r\nr = FLD_MOD(r, aud_fmt->stereo_channels, 26, 24);\r\nr = FLD_MOD(r, aud_fmt->active_chnnls_msk, 23, 16);\r\n}\r\nr = FLD_MOD(r, aud_fmt->en_sig_blk_strt_end, 5, 5);\r\nr = FLD_MOD(r, aud_fmt->type, 4, 4);\r\nr = FLD_MOD(r, aud_fmt->justification, 3, 3);\r\nr = FLD_MOD(r, aud_fmt->sample_order, 2, 2);\r\nr = FLD_MOD(r, aud_fmt->samples_per_word, 1, 1);\r\nr = FLD_MOD(r, aud_fmt->sample_size, 0, 0);\r\nhdmi_write_reg(wp->base, HDMI_WP_AUDIO_CFG, r);\r\n}\r\nvoid hdmi_wp_audio_config_dma(struct hdmi_wp_data *wp,\r\nstruct hdmi_audio_dma *aud_dma)\r\n{\r\nu32 r;\r\nDSSDBG("Enter hdmi_wp_audio_config_dma\n");\r\nr = hdmi_read_reg(wp->base, HDMI_WP_AUDIO_CFG2);\r\nr = FLD_MOD(r, aud_dma->transfer_size, 15, 8);\r\nr = FLD_MOD(r, aud_dma->block_size, 7, 0);\r\nhdmi_write_reg(wp->base, HDMI_WP_AUDIO_CFG2, r);\r\nr = hdmi_read_reg(wp->base, HDMI_WP_AUDIO_CTRL);\r\nr = FLD_MOD(r, aud_dma->mode, 9, 9);\r\nr = FLD_MOD(r, aud_dma->fifo_threshold, 8, 0);\r\nhdmi_write_reg(wp->base, HDMI_WP_AUDIO_CTRL, r);\r\n}\r\nint hdmi_wp_audio_enable(struct hdmi_wp_data *wp, bool enable)\r\n{\r\nREG_FLD_MOD(wp->base, HDMI_WP_AUDIO_CTRL, enable, 31, 31);\r\nreturn 0;\r\n}\r\nint hdmi_wp_audio_core_req_enable(struct hdmi_wp_data *wp, bool enable)\r\n{\r\nREG_FLD_MOD(wp->base, HDMI_WP_AUDIO_CTRL, enable, 30, 30);\r\nreturn 0;\r\n}\r\nint hdmi_wp_init(struct platform_device *pdev, struct hdmi_wp_data *wp)\r\n{\r\nstruct resource *res;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "wp");\r\nif (!res) {\r\nDSSERR("can't get WP mem resource\n");\r\nreturn -EINVAL;\r\n}\r\nwp->phys_base = res->start;\r\nwp->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(wp->base)) {\r\nDSSERR("can't ioremap HDMI WP\n");\r\nreturn PTR_ERR(wp->base);\r\n}\r\nreturn 0;\r\n}\r\nphys_addr_t hdmi_wp_get_audio_dma_addr(struct hdmi_wp_data *wp)\r\n{\r\nreturn wp->phys_base + HDMI_WP_AUDIO_DATA;\r\n}

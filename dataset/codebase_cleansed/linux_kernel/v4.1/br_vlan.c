static void __vlan_add_pvid(struct net_port_vlans *v, u16 vid)\r\n{\r\nif (v->pvid == vid)\r\nreturn;\r\nsmp_wmb();\r\nv->pvid = vid;\r\n}\r\nstatic void __vlan_delete_pvid(struct net_port_vlans *v, u16 vid)\r\n{\r\nif (v->pvid != vid)\r\nreturn;\r\nsmp_wmb();\r\nv->pvid = 0;\r\n}\r\nstatic void __vlan_add_flags(struct net_port_vlans *v, u16 vid, u16 flags)\r\n{\r\nif (flags & BRIDGE_VLAN_INFO_PVID)\r\n__vlan_add_pvid(v, vid);\r\nelse\r\n__vlan_delete_pvid(v, vid);\r\nif (flags & BRIDGE_VLAN_INFO_UNTAGGED)\r\nset_bit(vid, v->untagged_bitmap);\r\nelse\r\nclear_bit(vid, v->untagged_bitmap);\r\n}\r\nstatic int __vlan_add(struct net_port_vlans *v, u16 vid, u16 flags)\r\n{\r\nstruct net_bridge_port *p = NULL;\r\nstruct net_bridge *br;\r\nstruct net_device *dev;\r\nint err;\r\nif (test_bit(vid, v->vlan_bitmap)) {\r\n__vlan_add_flags(v, vid, flags);\r\nreturn 0;\r\n}\r\nif (v->port_idx) {\r\np = v->parent.port;\r\nbr = p->br;\r\ndev = p->dev;\r\n} else {\r\nbr = v->parent.br;\r\ndev = br->dev;\r\n}\r\nif (p) {\r\nerr = vlan_vid_add(dev, br->vlan_proto, vid);\r\nif (err)\r\nreturn err;\r\n}\r\nerr = br_fdb_insert(br, p, dev->dev_addr, vid);\r\nif (err) {\r\nbr_err(br, "failed insert local address into bridge "\r\n"forwarding table\n");\r\ngoto out_filt;\r\n}\r\nset_bit(vid, v->vlan_bitmap);\r\nv->num_vlans++;\r\n__vlan_add_flags(v, vid, flags);\r\nreturn 0;\r\nout_filt:\r\nif (p)\r\nvlan_vid_del(dev, br->vlan_proto, vid);\r\nreturn err;\r\n}\r\nstatic int __vlan_del(struct net_port_vlans *v, u16 vid)\r\n{\r\nif (!test_bit(vid, v->vlan_bitmap))\r\nreturn -EINVAL;\r\n__vlan_delete_pvid(v, vid);\r\nclear_bit(vid, v->untagged_bitmap);\r\nif (v->port_idx) {\r\nstruct net_bridge_port *p = v->parent.port;\r\nvlan_vid_del(p->dev, p->br->vlan_proto, vid);\r\n}\r\nclear_bit(vid, v->vlan_bitmap);\r\nv->num_vlans--;\r\nif (bitmap_empty(v->vlan_bitmap, VLAN_N_VID)) {\r\nif (v->port_idx)\r\nRCU_INIT_POINTER(v->parent.port->vlan_info, NULL);\r\nelse\r\nRCU_INIT_POINTER(v->parent.br->vlan_info, NULL);\r\nkfree_rcu(v, rcu);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __vlan_flush(struct net_port_vlans *v)\r\n{\r\nsmp_wmb();\r\nv->pvid = 0;\r\nbitmap_zero(v->vlan_bitmap, VLAN_N_VID);\r\nif (v->port_idx)\r\nRCU_INIT_POINTER(v->parent.port->vlan_info, NULL);\r\nelse\r\nRCU_INIT_POINTER(v->parent.br->vlan_info, NULL);\r\nkfree_rcu(v, rcu);\r\n}\r\nstruct sk_buff *br_handle_vlan(struct net_bridge *br,\r\nconst struct net_port_vlans *pv,\r\nstruct sk_buff *skb)\r\n{\r\nu16 vid;\r\nif (!BR_INPUT_SKB_CB(skb)->vlan_filtered)\r\ngoto out;\r\nif (!pv) {\r\nif ((br->dev->flags & IFF_PROMISC) && skb->dev == br->dev) {\r\ngoto out;\r\n} else {\r\nkfree_skb(skb);\r\nreturn NULL;\r\n}\r\n}\r\nbr_vlan_get_tag(skb, &vid);\r\nif (test_bit(vid, pv->untagged_bitmap))\r\nskb->vlan_tci = 0;\r\nout:\r\nreturn skb;\r\n}\r\nbool br_allowed_ingress(struct net_bridge *br, struct net_port_vlans *v,\r\nstruct sk_buff *skb, u16 *vid)\r\n{\r\nbool tagged;\r\n__be16 proto;\r\nif (!br->vlan_enabled) {\r\nBR_INPUT_SKB_CB(skb)->vlan_filtered = false;\r\nreturn true;\r\n}\r\nif (!v)\r\ngoto drop;\r\nBR_INPUT_SKB_CB(skb)->vlan_filtered = true;\r\nproto = br->vlan_proto;\r\nif (unlikely(!skb_vlan_tag_present(skb) &&\r\nskb->protocol == proto)) {\r\nskb = skb_vlan_untag(skb);\r\nif (unlikely(!skb))\r\nreturn false;\r\n}\r\nif (!br_vlan_get_tag(skb, vid)) {\r\nif (skb->vlan_proto != proto) {\r\nskb_push(skb, ETH_HLEN);\r\nskb = vlan_insert_tag_set_proto(skb, skb->vlan_proto,\r\nskb_vlan_tag_get(skb));\r\nif (unlikely(!skb))\r\nreturn false;\r\nskb_pull(skb, ETH_HLEN);\r\nskb_reset_mac_len(skb);\r\n*vid = 0;\r\ntagged = false;\r\n} else {\r\ntagged = true;\r\n}\r\n} else {\r\ntagged = false;\r\n}\r\nif (!*vid) {\r\nu16 pvid = br_get_pvid(v);\r\nif (!pvid)\r\ngoto drop;\r\n*vid = pvid;\r\nif (likely(!tagged))\r\n__vlan_hwaccel_put_tag(skb, proto, pvid);\r\nelse\r\nskb->vlan_tci |= pvid;\r\nreturn true;\r\n}\r\nif (test_bit(*vid, v->vlan_bitmap))\r\nreturn true;\r\ndrop:\r\nkfree_skb(skb);\r\nreturn false;\r\n}\r\nbool br_allowed_egress(struct net_bridge *br,\r\nconst struct net_port_vlans *v,\r\nconst struct sk_buff *skb)\r\n{\r\nu16 vid;\r\nif (!BR_INPUT_SKB_CB(skb)->vlan_filtered)\r\nreturn true;\r\nif (!v)\r\nreturn false;\r\nbr_vlan_get_tag(skb, &vid);\r\nif (test_bit(vid, v->vlan_bitmap))\r\nreturn true;\r\nreturn false;\r\n}\r\nbool br_should_learn(struct net_bridge_port *p, struct sk_buff *skb, u16 *vid)\r\n{\r\nstruct net_bridge *br = p->br;\r\nstruct net_port_vlans *v;\r\nif (!br->vlan_enabled)\r\nreturn true;\r\nv = rcu_dereference(p->vlan_info);\r\nif (!v)\r\nreturn false;\r\nif (!br_vlan_get_tag(skb, vid) && skb->vlan_proto != br->vlan_proto)\r\n*vid = 0;\r\nif (!*vid) {\r\n*vid = br_get_pvid(v);\r\nif (!*vid)\r\nreturn false;\r\nreturn true;\r\n}\r\nif (test_bit(*vid, v->vlan_bitmap))\r\nreturn true;\r\nreturn false;\r\n}\r\nint br_vlan_add(struct net_bridge *br, u16 vid, u16 flags)\r\n{\r\nstruct net_port_vlans *pv = NULL;\r\nint err;\r\nASSERT_RTNL();\r\npv = rtnl_dereference(br->vlan_info);\r\nif (pv)\r\nreturn __vlan_add(pv, vid, flags);\r\npv = kzalloc(sizeof(*pv), GFP_KERNEL);\r\nif (!pv)\r\nreturn -ENOMEM;\r\npv->parent.br = br;\r\nerr = __vlan_add(pv, vid, flags);\r\nif (err)\r\ngoto out;\r\nrcu_assign_pointer(br->vlan_info, pv);\r\nreturn 0;\r\nout:\r\nkfree(pv);\r\nreturn err;\r\n}\r\nint br_vlan_delete(struct net_bridge *br, u16 vid)\r\n{\r\nstruct net_port_vlans *pv;\r\nASSERT_RTNL();\r\npv = rtnl_dereference(br->vlan_info);\r\nif (!pv)\r\nreturn -EINVAL;\r\nbr_fdb_find_delete_local(br, NULL, br->dev->dev_addr, vid);\r\n__vlan_del(pv, vid);\r\nreturn 0;\r\n}\r\nvoid br_vlan_flush(struct net_bridge *br)\r\n{\r\nstruct net_port_vlans *pv;\r\nASSERT_RTNL();\r\npv = rtnl_dereference(br->vlan_info);\r\nif (!pv)\r\nreturn;\r\n__vlan_flush(pv);\r\n}\r\nbool br_vlan_find(struct net_bridge *br, u16 vid)\r\n{\r\nstruct net_port_vlans *pv;\r\nbool found = false;\r\nrcu_read_lock();\r\npv = rcu_dereference(br->vlan_info);\r\nif (!pv)\r\ngoto out;\r\nif (test_bit(vid, pv->vlan_bitmap))\r\nfound = true;\r\nout:\r\nrcu_read_unlock();\r\nreturn found;\r\n}\r\nstatic void recalculate_group_addr(struct net_bridge *br)\r\n{\r\nif (br->group_addr_set)\r\nreturn;\r\nspin_lock_bh(&br->lock);\r\nif (!br->vlan_enabled || br->vlan_proto == htons(ETH_P_8021Q)) {\r\nbr->group_addr[5] = 0x00;\r\n} else {\r\nbr->group_addr[5] = 0x08;\r\n}\r\nspin_unlock_bh(&br->lock);\r\n}\r\nvoid br_recalculate_fwd_mask(struct net_bridge *br)\r\n{\r\nif (!br->vlan_enabled || br->vlan_proto == htons(ETH_P_8021Q))\r\nbr->group_fwd_mask_required = BR_GROUPFWD_DEFAULT;\r\nelse\r\nbr->group_fwd_mask_required = BR_GROUPFWD_8021AD &\r\n~(1u << br->group_addr[5]);\r\n}\r\nint br_vlan_filter_toggle(struct net_bridge *br, unsigned long val)\r\n{\r\nif (!rtnl_trylock())\r\nreturn restart_syscall();\r\nif (br->vlan_enabled == val)\r\ngoto unlock;\r\nbr->vlan_enabled = val;\r\nbr_manage_promisc(br);\r\nrecalculate_group_addr(br);\r\nbr_recalculate_fwd_mask(br);\r\nunlock:\r\nrtnl_unlock();\r\nreturn 0;\r\n}\r\nint br_vlan_set_proto(struct net_bridge *br, unsigned long val)\r\n{\r\nint err = 0;\r\nstruct net_bridge_port *p;\r\nstruct net_port_vlans *pv;\r\n__be16 proto, oldproto;\r\nu16 vid, errvid;\r\nif (val != ETH_P_8021Q && val != ETH_P_8021AD)\r\nreturn -EPROTONOSUPPORT;\r\nif (!rtnl_trylock())\r\nreturn restart_syscall();\r\nproto = htons(val);\r\nif (br->vlan_proto == proto)\r\ngoto unlock;\r\nlist_for_each_entry(p, &br->port_list, list) {\r\npv = rtnl_dereference(p->vlan_info);\r\nif (!pv)\r\ncontinue;\r\nfor_each_set_bit(vid, pv->vlan_bitmap, VLAN_N_VID) {\r\nerr = vlan_vid_add(p->dev, proto, vid);\r\nif (err)\r\ngoto err_filt;\r\n}\r\n}\r\noldproto = br->vlan_proto;\r\nbr->vlan_proto = proto;\r\nrecalculate_group_addr(br);\r\nbr_recalculate_fwd_mask(br);\r\nlist_for_each_entry(p, &br->port_list, list) {\r\npv = rtnl_dereference(p->vlan_info);\r\nif (!pv)\r\ncontinue;\r\nfor_each_set_bit(vid, pv->vlan_bitmap, VLAN_N_VID)\r\nvlan_vid_del(p->dev, oldproto, vid);\r\n}\r\nunlock:\r\nrtnl_unlock();\r\nreturn err;\r\nerr_filt:\r\nerrvid = vid;\r\nfor_each_set_bit(vid, pv->vlan_bitmap, errvid)\r\nvlan_vid_del(p->dev, proto, vid);\r\nlist_for_each_entry_continue_reverse(p, &br->port_list, list) {\r\npv = rtnl_dereference(p->vlan_info);\r\nif (!pv)\r\ncontinue;\r\nfor_each_set_bit(vid, pv->vlan_bitmap, VLAN_N_VID)\r\nvlan_vid_del(p->dev, proto, vid);\r\n}\r\ngoto unlock;\r\n}\r\nstatic bool vlan_default_pvid(struct net_port_vlans *pv, u16 vid)\r\n{\r\nreturn pv && vid == pv->pvid && test_bit(vid, pv->untagged_bitmap);\r\n}\r\nstatic void br_vlan_disable_default_pvid(struct net_bridge *br)\r\n{\r\nstruct net_bridge_port *p;\r\nu16 pvid = br->default_pvid;\r\nif (vlan_default_pvid(br_get_vlan_info(br), pvid))\r\nbr_vlan_delete(br, pvid);\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif (vlan_default_pvid(nbp_get_vlan_info(p), pvid))\r\nnbp_vlan_delete(p, pvid);\r\n}\r\nbr->default_pvid = 0;\r\n}\r\nstatic int __br_vlan_set_default_pvid(struct net_bridge *br, u16 pvid)\r\n{\r\nstruct net_bridge_port *p;\r\nu16 old_pvid;\r\nint err = 0;\r\nunsigned long *changed;\r\nchanged = kcalloc(BITS_TO_LONGS(BR_MAX_PORTS), sizeof(unsigned long),\r\nGFP_KERNEL);\r\nif (!changed)\r\nreturn -ENOMEM;\r\nold_pvid = br->default_pvid;\r\nif ((!old_pvid || vlan_default_pvid(br_get_vlan_info(br), old_pvid)) &&\r\n!br_vlan_find(br, pvid)) {\r\nerr = br_vlan_add(br, pvid,\r\nBRIDGE_VLAN_INFO_PVID |\r\nBRIDGE_VLAN_INFO_UNTAGGED);\r\nif (err)\r\ngoto out;\r\nbr_vlan_delete(br, old_pvid);\r\nset_bit(0, changed);\r\n}\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif ((old_pvid &&\r\n!vlan_default_pvid(nbp_get_vlan_info(p), old_pvid)) ||\r\nnbp_vlan_find(p, pvid))\r\ncontinue;\r\nerr = nbp_vlan_add(p, pvid,\r\nBRIDGE_VLAN_INFO_PVID |\r\nBRIDGE_VLAN_INFO_UNTAGGED);\r\nif (err)\r\ngoto err_port;\r\nnbp_vlan_delete(p, old_pvid);\r\nset_bit(p->port_no, changed);\r\n}\r\nbr->default_pvid = pvid;\r\nout:\r\nkfree(changed);\r\nreturn err;\r\nerr_port:\r\nlist_for_each_entry_continue_reverse(p, &br->port_list, list) {\r\nif (!test_bit(p->port_no, changed))\r\ncontinue;\r\nif (old_pvid)\r\nnbp_vlan_add(p, old_pvid,\r\nBRIDGE_VLAN_INFO_PVID |\r\nBRIDGE_VLAN_INFO_UNTAGGED);\r\nnbp_vlan_delete(p, pvid);\r\n}\r\nif (test_bit(0, changed)) {\r\nif (old_pvid)\r\nbr_vlan_add(br, old_pvid,\r\nBRIDGE_VLAN_INFO_PVID |\r\nBRIDGE_VLAN_INFO_UNTAGGED);\r\nbr_vlan_delete(br, pvid);\r\n}\r\ngoto out;\r\n}\r\nint br_vlan_set_default_pvid(struct net_bridge *br, unsigned long val)\r\n{\r\nu16 pvid = val;\r\nint err = 0;\r\nif (val >= VLAN_VID_MASK)\r\nreturn -EINVAL;\r\nif (!rtnl_trylock())\r\nreturn restart_syscall();\r\nif (pvid == br->default_pvid)\r\ngoto unlock;\r\nif (br->vlan_enabled) {\r\npr_info_once("Please disable vlan filtering to change default_pvid\n");\r\nerr = -EPERM;\r\ngoto unlock;\r\n}\r\nif (!pvid)\r\nbr_vlan_disable_default_pvid(br);\r\nelse\r\nerr = __br_vlan_set_default_pvid(br, pvid);\r\nunlock:\r\nrtnl_unlock();\r\nreturn err;\r\n}\r\nint br_vlan_init(struct net_bridge *br)\r\n{\r\nbr->vlan_proto = htons(ETH_P_8021Q);\r\nbr->default_pvid = 1;\r\nreturn br_vlan_add(br, 1,\r\nBRIDGE_VLAN_INFO_PVID | BRIDGE_VLAN_INFO_UNTAGGED);\r\n}\r\nint nbp_vlan_add(struct net_bridge_port *port, u16 vid, u16 flags)\r\n{\r\nstruct net_port_vlans *pv = NULL;\r\nint err;\r\nASSERT_RTNL();\r\npv = rtnl_dereference(port->vlan_info);\r\nif (pv)\r\nreturn __vlan_add(pv, vid, flags);\r\npv = kzalloc(sizeof(*pv), GFP_KERNEL);\r\nif (!pv) {\r\nerr = -ENOMEM;\r\ngoto clean_up;\r\n}\r\npv->port_idx = port->port_no;\r\npv->parent.port = port;\r\nerr = __vlan_add(pv, vid, flags);\r\nif (err)\r\ngoto clean_up;\r\nrcu_assign_pointer(port->vlan_info, pv);\r\nreturn 0;\r\nclean_up:\r\nkfree(pv);\r\nreturn err;\r\n}\r\nint nbp_vlan_delete(struct net_bridge_port *port, u16 vid)\r\n{\r\nstruct net_port_vlans *pv;\r\nASSERT_RTNL();\r\npv = rtnl_dereference(port->vlan_info);\r\nif (!pv)\r\nreturn -EINVAL;\r\nbr_fdb_find_delete_local(port->br, port, port->dev->dev_addr, vid);\r\nreturn __vlan_del(pv, vid);\r\n}\r\nvoid nbp_vlan_flush(struct net_bridge_port *port)\r\n{\r\nstruct net_port_vlans *pv;\r\nu16 vid;\r\nASSERT_RTNL();\r\npv = rtnl_dereference(port->vlan_info);\r\nif (!pv)\r\nreturn;\r\nfor_each_set_bit(vid, pv->vlan_bitmap, VLAN_N_VID)\r\nvlan_vid_del(port->dev, port->br->vlan_proto, vid);\r\n__vlan_flush(pv);\r\n}\r\nbool nbp_vlan_find(struct net_bridge_port *port, u16 vid)\r\n{\r\nstruct net_port_vlans *pv;\r\nbool found = false;\r\nrcu_read_lock();\r\npv = rcu_dereference(port->vlan_info);\r\nif (!pv)\r\ngoto out;\r\nif (test_bit(vid, pv->vlan_bitmap))\r\nfound = true;\r\nout:\r\nrcu_read_unlock();\r\nreturn found;\r\n}\r\nint nbp_vlan_init(struct net_bridge_port *p)\r\n{\r\nreturn p->br->default_pvid ?\r\nnbp_vlan_add(p, p->br->default_pvid,\r\nBRIDGE_VLAN_INFO_PVID |\r\nBRIDGE_VLAN_INFO_UNTAGGED) :\r\n0;\r\n}

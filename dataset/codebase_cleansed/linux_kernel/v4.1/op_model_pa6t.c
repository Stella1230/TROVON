static inline u64 ctr_read(unsigned int i)\r\n{\r\nswitch (i) {\r\ncase 0:\r\nreturn mfspr(SPRN_PA6T_PMC0);\r\ncase 1:\r\nreturn mfspr(SPRN_PA6T_PMC1);\r\ncase 2:\r\nreturn mfspr(SPRN_PA6T_PMC2);\r\ncase 3:\r\nreturn mfspr(SPRN_PA6T_PMC3);\r\ncase 4:\r\nreturn mfspr(SPRN_PA6T_PMC4);\r\ncase 5:\r\nreturn mfspr(SPRN_PA6T_PMC5);\r\ndefault:\r\nprintk(KERN_ERR "ctr_read called with bad arg %u\n", i);\r\nreturn 0;\r\n}\r\n}\r\nstatic inline void ctr_write(unsigned int i, u64 val)\r\n{\r\nswitch (i) {\r\ncase 0:\r\nmtspr(SPRN_PA6T_PMC0, val);\r\nbreak;\r\ncase 1:\r\nmtspr(SPRN_PA6T_PMC1, val);\r\nbreak;\r\ncase 2:\r\nmtspr(SPRN_PA6T_PMC2, val);\r\nbreak;\r\ncase 3:\r\nmtspr(SPRN_PA6T_PMC3, val);\r\nbreak;\r\ncase 4:\r\nmtspr(SPRN_PA6T_PMC4, val);\r\nbreak;\r\ncase 5:\r\nmtspr(SPRN_PA6T_PMC5, val);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "ctr_write called with bad arg %u\n", i);\r\nbreak;\r\n}\r\n}\r\nstatic int pa6t_reg_setup(struct op_counter_config *ctr,\r\nstruct op_system_config *sys,\r\nint num_ctrs)\r\n{\r\nint pmc;\r\nfor (pmc = 0; pmc < cur_cpu_spec->num_pmcs; pmc++)\r\nif (!ctr[pmc].enabled) {\r\nsys->mmcr0 &= ~(0x1UL << pmc);\r\nsys->mmcr0 &= ~(0x1UL << (pmc+12));\r\npr_debug("turned off counter %u\n", pmc);\r\n}\r\nif (sys->enable_kernel)\r\nsys->mmcr0 |= PA6T_MMCR0_SUPEN | PA6T_MMCR0_HYPEN;\r\nelse\r\nsys->mmcr0 &= ~(PA6T_MMCR0_SUPEN | PA6T_MMCR0_HYPEN);\r\nif (sys->enable_user)\r\nsys->mmcr0 |= PA6T_MMCR0_PREN;\r\nelse\r\nsys->mmcr0 &= ~PA6T_MMCR0_PREN;\r\nmmcr0_val = sys->mmcr0;\r\nmmcr1_val = sys->mmcr1;\r\npr_debug("mmcr0_val inited to %016lx\n", sys->mmcr0);\r\npr_debug("mmcr1_val inited to %016lx\n", sys->mmcr1);\r\nfor (pmc = 0; pmc < cur_cpu_spec->num_pmcs; pmc++) {\r\nreset_value[pmc] = (0x1UL << 39) - ctr[pmc].count;\r\npr_debug("reset_value for pmc%u inited to 0x%llx\n",\r\npmc, reset_value[pmc]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pa6t_cpu_setup(struct op_counter_config *ctr)\r\n{\r\nu64 mmcr0 = mmcr0_val;\r\nu64 mmcr1 = mmcr1_val;\r\nmmcr0 &= ~(0x3FUL);\r\nmtspr(SPRN_PA6T_MMCR0, mmcr0);\r\nmtspr(SPRN_PA6T_MMCR1, mmcr1);\r\npr_debug("setup on cpu %d, mmcr0 %016lx\n", smp_processor_id(),\r\nmfspr(SPRN_PA6T_MMCR0));\r\npr_debug("setup on cpu %d, mmcr1 %016lx\n", smp_processor_id(),\r\nmfspr(SPRN_PA6T_MMCR1));\r\nreturn 0;\r\n}\r\nstatic int pa6t_start(struct op_counter_config *ctr)\r\n{\r\nint i;\r\nu64 mmcr0 = mmcr0_val | PA6T_MMCR0_HANDDIS;\r\nfor (i = 0; i < cur_cpu_spec->num_pmcs; i++)\r\nif (ctr[i].enabled)\r\nctr_write(i, reset_value[i]);\r\nelse\r\nctr_write(i, 0UL);\r\nmtspr(SPRN_PA6T_MMCR0, mmcr0);\r\noprofile_running = 1;\r\npr_debug("start on cpu %d, mmcr0 %llx\n", smp_processor_id(), mmcr0);\r\nreturn 0;\r\n}\r\nstatic void pa6t_stop(void)\r\n{\r\nu64 mmcr0;\r\nmmcr0 = mfspr(SPRN_PA6T_MMCR0);\r\nmmcr0 |= PA6T_MMCR0_FCM0;\r\nmtspr(SPRN_PA6T_MMCR0, mmcr0);\r\noprofile_running = 0;\r\npr_debug("stop on cpu %d, mmcr0 %llx\n", smp_processor_id(), mmcr0);\r\n}\r\nstatic void pa6t_handle_interrupt(struct pt_regs *regs,\r\nstruct op_counter_config *ctr)\r\n{\r\nunsigned long pc = mfspr(SPRN_PA6T_SIAR);\r\nint is_kernel = is_kernel_addr(pc);\r\nu64 val;\r\nint i;\r\nu64 mmcr0;\r\nmmcr0 = mfspr(SPRN_PA6T_MMCR0);\r\nmtspr(SPRN_PA6T_MMCR0, mmcr0 | PA6T_MMCR0_HANDDIS);\r\nfor (i = 0; i < cur_cpu_spec->num_pmcs; i++) {\r\nval = ctr_read(i);\r\nif (val & (0x1UL << 39)) {\r\nif (oprofile_running && ctr[i].enabled) {\r\nif (mmcr0 & PA6T_MMCR0_SIARLOG)\r\noprofile_add_ext_sample(pc, regs, i, is_kernel);\r\nctr_write(i, reset_value[i]);\r\n} else {\r\nctr_write(i, 0UL);\r\n}\r\n}\r\n}\r\nmmcr0 = mmcr0_val | PA6T_MMCR0_HANDDIS;\r\nmtspr(SPRN_PA6T_MMCR0, mmcr0);\r\n}

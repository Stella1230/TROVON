static void\r\nbfa_fcs_itnim_sm_offline(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_FCS_ONLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli_send);\r\nitnim->prli_retries = 0;\r\nbfa_fcs_itnim_send_prli(itnim, NULL);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_INITIATOR:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_prli_send(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_FRMSENT:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_INITIATOR:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\r\nbfa_fcxp_walloc_cancel(itnim->fcs->bfa, &itnim->fcxp_wqe);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcxp_walloc_cancel(itnim->fcs->bfa, &itnim->fcxp_wqe);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcxp_walloc_cancel(itnim->fcs->bfa, &itnim->fcxp_wqe);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_prli(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_RSP_OK:\r\nif (itnim->rport->scsi_function == BFA_RPORT_INITIATOR)\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\r\nelse\r\nbfa_sm_set_state(itnim,\r\nbfa_fcs_itnim_sm_hal_rport_online);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_RSP_ERROR:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli_retry);\r\nbfa_timer_start(itnim->fcs->bfa, &itnim->timer,\r\nbfa_fcs_itnim_timeout, itnim,\r\nBFA_FCS_RETRY_TIMEOUT);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_RSP_NOT_SUPP:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcxp_discard(itnim->fcxp);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_INITIATOR:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\r\nbfa_fcxp_discard(itnim->fcxp);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcxp_discard(itnim->fcxp);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_hal_rport_online(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_HAL_ONLINE:\r\nif (!itnim->bfa_itnim)\r\nitnim->bfa_itnim = bfa_itnim_create(itnim->fcs->bfa,\r\nitnim->rport->bfa_rport, itnim);\r\nif (itnim->bfa_itnim) {\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_hcb_online);\r\nbfa_itnim_online(itnim->bfa_itnim, itnim->seq_rec);\r\n} else {\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_DELETE);\r\n}\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_prli_retry(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_TIMEOUT:\r\nif (itnim->prli_retries < BFA_FCS_RPORT_MAX_RETRIES) {\r\nitnim->prli_retries++;\r\nbfa_trc(itnim->fcs, itnim->prli_retries);\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli_send);\r\nbfa_fcs_itnim_send_prli(itnim, NULL);\r\n} else {\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_LOGO_IMP);\r\n}\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_timer_stop(&itnim->timer);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_INITIATOR:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\r\nbfa_timer_stop(&itnim->timer);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_timer_stop(&itnim->timer);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_hcb_online(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nstruct bfad_s *bfad = (struct bfad_s *)itnim->fcs->bfad;\r\nchar lpwwn_buf[BFA_STRING_32];\r\nchar rpwwn_buf[BFA_STRING_32];\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_HCB_ONLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_online);\r\nbfa_fcb_itnim_online(itnim->itnim_drv);\r\nwwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(itnim->rport->port));\r\nwwn2str(rpwwn_buf, itnim->rport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Target (WWN = %s) is online for initiator (WWN = %s)\n",\r\nrpwwn_buf, lpwwn_buf);\r\nbfa_fcs_itnim_aen_post(itnim, BFA_ITNIM_AEN_ONLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_hcb_offline);\r\nbfa_itnim_offline(itnim->bfa_itnim);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_online(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nstruct bfad_s *bfad = (struct bfad_s *)itnim->fcs->bfad;\r\nchar lpwwn_buf[BFA_STRING_32];\r\nchar rpwwn_buf[BFA_STRING_32];\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_hcb_offline);\r\nbfa_fcb_itnim_offline(itnim->itnim_drv);\r\nbfa_itnim_offline(itnim->bfa_itnim);\r\nwwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(itnim->rport->port));\r\nwwn2str(rpwwn_buf, itnim->rport->pwwn);\r\nif (bfa_fcs_lport_is_online(itnim->rport->port) == BFA_TRUE) {\r\nBFA_LOG(KERN_ERR, bfad, bfa_log_level,\r\n"Target (WWN = %s) connectivity lost for "\r\n"initiator (WWN = %s)\n", rpwwn_buf, lpwwn_buf);\r\nbfa_fcs_itnim_aen_post(itnim, BFA_ITNIM_AEN_DISCONNECT);\r\n} else {\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Target (WWN = %s) offlined by initiator (WWN = %s)\n",\r\nrpwwn_buf, lpwwn_buf);\r\nbfa_fcs_itnim_aen_post(itnim, BFA_ITNIM_AEN_OFFLINE);\r\n}\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_hcb_offline(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_HCB_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_sm_initiator(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_fcs_itnim_event event)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_trc(itnim->fcs, event);\r\nswitch (event) {\r\ncase BFA_FCS_ITNIM_SM_OFFLINE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_FCS_ONLINE:\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_RSP_ERROR:\r\ncase BFA_FCS_ITNIM_SM_INITIATOR:\r\nbreak;\r\ncase BFA_FCS_ITNIM_SM_DELETE:\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nbfa_fcs_itnim_free(itnim);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(itnim->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_aen_post(struct bfa_fcs_itnim_s *itnim,\r\nenum bfa_itnim_aen_event event)\r\n{\r\nstruct bfa_fcs_rport_s *rport = itnim->rport;\r\nstruct bfad_s *bfad = (struct bfad_s *)itnim->fcs->bfad;\r\nstruct bfa_aen_entry_s *aen_entry;\r\nif (BFA_FCS_PID_IS_WKA(rport->pid))\r\nreturn;\r\nbfad_get_aen_entry(bfad, aen_entry);\r\nif (!aen_entry)\r\nreturn;\r\naen_entry->aen_data.itnim.vf_id = rport->port->fabric->vf_id;\r\naen_entry->aen_data.itnim.ppwwn = bfa_fcs_lport_get_pwwn(\r\nbfa_fcs_get_base_port(itnim->fcs));\r\naen_entry->aen_data.itnim.lpwwn = bfa_fcs_lport_get_pwwn(rport->port);\r\naen_entry->aen_data.itnim.rpwwn = rport->pwwn;\r\nbfad_im_post_vendor_event(aen_entry, bfad, ++rport->fcs->fcs_aen_seq,\r\nBFA_AEN_CAT_ITNIM, event);\r\n}\r\nstatic void\r\nbfa_fcs_itnim_send_prli(void *itnim_cbarg, struct bfa_fcxp_s *fcxp_alloced)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = itnim_cbarg;\r\nstruct bfa_fcs_rport_s *rport = itnim->rport;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcxp_s *fcxp;\r\nint len;\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nfcxp = fcxp_alloced ? fcxp_alloced :\r\nbfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\r\nif (!fcxp) {\r\nitnim->stats.fcxp_alloc_wait++;\r\nbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &itnim->fcxp_wqe,\r\nbfa_fcs_itnim_send_prli, itnim, BFA_TRUE);\r\nreturn;\r\n}\r\nitnim->fcxp = fcxp;\r\nlen = fc_prli_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nitnim->rport->pid, bfa_fcs_lport_get_fcid(port), 0);\r\nbfa_fcxp_send(fcxp, rport->bfa_rport, port->fabric->vf_id, port->lp_tag,\r\nBFA_FALSE, FC_CLASS_3, len, &fchs,\r\nbfa_fcs_itnim_prli_response, (void *)itnim,\r\nFC_MAX_PDUSZ, FC_ELS_TOV);\r\nitnim->stats.prli_sent++;\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_FRMSENT);\r\n}\r\nstatic void\r\nbfa_fcs_itnim_prli_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rsp_fchs)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cbarg;\r\nstruct fc_els_cmd_s *els_cmd;\r\nstruct fc_prli_s *prli_resp;\r\nstruct fc_ls_rjt_s *ls_rjt;\r\nstruct fc_prli_params_s *sparams;\r\nbfa_trc(itnim->fcs, req_status);\r\nif (req_status != BFA_STATUS_OK) {\r\nitnim->stats.prli_rsp_err++;\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_ERROR);\r\nreturn;\r\n}\r\nels_cmd = (struct fc_els_cmd_s *) BFA_FCXP_RSP_PLD(fcxp);\r\nif (els_cmd->els_code == FC_ELS_ACC) {\r\nprli_resp = (struct fc_prli_s *) els_cmd;\r\nif (fc_prli_rsp_parse(prli_resp, rsp_len) != FC_PARSE_OK) {\r\nbfa_trc(itnim->fcs, rsp_len);\r\nif (prli_resp->parampage.servparams.initiator) {\r\nbfa_trc(itnim->fcs, prli_resp->parampage.type);\r\nitnim->rport->scsi_function =\r\nBFA_RPORT_INITIATOR;\r\nitnim->stats.prli_rsp_acc++;\r\nitnim->stats.initiator++;\r\nbfa_sm_send_event(itnim,\r\nBFA_FCS_ITNIM_SM_RSP_OK);\r\nreturn;\r\n}\r\nitnim->stats.prli_rsp_parse_err++;\r\nreturn;\r\n}\r\nitnim->rport->scsi_function = BFA_RPORT_TARGET;\r\nsparams = &prli_resp->parampage.servparams;\r\nitnim->seq_rec = sparams->retry;\r\nitnim->rec_support = sparams->rec_support;\r\nitnim->task_retry_id = sparams->task_retry_id;\r\nitnim->conf_comp = sparams->confirm;\r\nitnim->stats.prli_rsp_acc++;\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_OK);\r\n} else {\r\nls_rjt = (struct fc_ls_rjt_s *) BFA_FCXP_RSP_PLD(fcxp);\r\nbfa_trc(itnim->fcs, ls_rjt->reason_code);\r\nbfa_trc(itnim->fcs, ls_rjt->reason_code_expl);\r\nitnim->stats.prli_rsp_rjt++;\r\nif (ls_rjt->reason_code == FC_LS_RJT_RSN_CMD_NOT_SUPP) {\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_NOT_SUPP);\r\nreturn;\r\n}\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_ERROR);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_itnim_timeout(void *arg)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) arg;\r\nitnim->stats.timeout++;\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_TIMEOUT);\r\n}\r\nstatic void\r\nbfa_fcs_itnim_free(struct bfa_fcs_itnim_s *itnim)\r\n{\r\nif (itnim->bfa_itnim) {\r\nbfa_itnim_delete(itnim->bfa_itnim);\r\nitnim->bfa_itnim = NULL;\r\n}\r\nbfa_fcb_itnim_free(itnim->fcs->bfad, itnim->itnim_drv);\r\n}\r\nstruct bfa_fcs_itnim_s *\r\nbfa_fcs_itnim_create(struct bfa_fcs_rport_s *rport)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct bfa_fcs_itnim_s *itnim;\r\nstruct bfad_itnim_s *itnim_drv;\r\nbfa_fcb_itnim_alloc(port->fcs->bfad, &itnim, &itnim_drv);\r\nif (itnim == NULL) {\r\nbfa_trc(port->fcs, rport->pwwn);\r\nreturn NULL;\r\n}\r\nitnim->rport = rport;\r\nitnim->fcs = rport->fcs;\r\nitnim->itnim_drv = itnim_drv;\r\nitnim->bfa_itnim = NULL;\r\nitnim->seq_rec = BFA_FALSE;\r\nitnim->rec_support = BFA_FALSE;\r\nitnim->conf_comp = BFA_FALSE;\r\nitnim->task_retry_id = BFA_FALSE;\r\nbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\r\nreturn itnim;\r\n}\r\nvoid\r\nbfa_fcs_itnim_delete(struct bfa_fcs_itnim_s *itnim)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pid);\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_DELETE);\r\n}\r\nvoid\r\nbfa_fcs_itnim_brp_online(struct bfa_fcs_itnim_s *itnim)\r\n{\r\nitnim->stats.onlines++;\r\nif (!BFA_FCS_PID_IS_WKA(itnim->rport->pid))\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_HAL_ONLINE);\r\n}\r\nvoid\r\nbfa_fcs_itnim_rport_offline(struct bfa_fcs_itnim_s *itnim)\r\n{\r\nitnim->stats.offlines++;\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_OFFLINE);\r\n}\r\nvoid\r\nbfa_fcs_itnim_is_initiator(struct bfa_fcs_itnim_s *itnim)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pid);\r\nitnim->stats.initiator++;\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_INITIATOR);\r\n}\r\nbfa_status_t\r\nbfa_fcs_itnim_get_online_state(struct bfa_fcs_itnim_s *itnim)\r\n{\r\nbfa_trc(itnim->fcs, itnim->rport->pid);\r\nswitch (bfa_sm_to_state(itnim_sm_table, itnim->sm)) {\r\ncase BFA_ITNIM_ONLINE:\r\ncase BFA_ITNIM_INITIATIOR:\r\nreturn BFA_STATUS_OK;\r\ndefault:\r\nreturn BFA_STATUS_NO_FCPIM_NEXUS;\r\n}\r\n}\r\nvoid\r\nbfa_cb_itnim_online(void *cbarg)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cbarg;\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_HCB_ONLINE);\r\n}\r\nvoid\r\nbfa_cb_itnim_offline(void *cb_arg)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_HCB_OFFLINE);\r\n}\r\nvoid\r\nbfa_cb_itnim_tov_begin(void *cb_arg)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\n}\r\nvoid\r\nbfa_cb_itnim_tov(void *cb_arg)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\r\nstruct bfad_itnim_s *itnim_drv = itnim->itnim_drv;\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nitnim_drv->state = ITNIM_STATE_TIMEOUT;\r\n}\r\nvoid\r\nbfa_cb_itnim_sler(void *cb_arg)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\r\nitnim->stats.sler++;\r\nbfa_trc(itnim->fcs, itnim->rport->pwwn);\r\nbfa_sm_send_event(itnim->rport, RPSM_EVENT_LOGO_IMP);\r\n}\r\nstruct bfa_fcs_itnim_s *\r\nbfa_fcs_itnim_lookup(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\r\n{\r\nstruct bfa_fcs_rport_s *rport;\r\nrport = bfa_fcs_rport_lookup(port, rpwwn);\r\nif (!rport)\r\nreturn NULL;\r\nWARN_ON(rport->itnim == NULL);\r\nreturn rport->itnim;\r\n}\r\nbfa_status_t\r\nbfa_fcs_itnim_attr_get(struct bfa_fcs_lport_s *port, wwn_t rpwwn,\r\nstruct bfa_itnim_attr_s *attr)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = NULL;\r\nitnim = bfa_fcs_itnim_lookup(port, rpwwn);\r\nif (itnim == NULL)\r\nreturn BFA_STATUS_NO_FCPIM_NEXUS;\r\nattr->state = bfa_sm_to_state(itnim_sm_table, itnim->sm);\r\nattr->retry = itnim->seq_rec;\r\nattr->rec_support = itnim->rec_support;\r\nattr->conf_comp = itnim->conf_comp;\r\nattr->task_retry_id = itnim->task_retry_id;\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcs_itnim_stats_get(struct bfa_fcs_lport_s *port, wwn_t rpwwn,\r\nstruct bfa_itnim_stats_s *stats)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = NULL;\r\nWARN_ON(port == NULL);\r\nitnim = bfa_fcs_itnim_lookup(port, rpwwn);\r\nif (itnim == NULL)\r\nreturn BFA_STATUS_NO_FCPIM_NEXUS;\r\nmemcpy(stats, &itnim->stats, sizeof(struct bfa_itnim_stats_s));\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcs_itnim_stats_clear(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\r\n{\r\nstruct bfa_fcs_itnim_s *itnim = NULL;\r\nWARN_ON(port == NULL);\r\nitnim = bfa_fcs_itnim_lookup(port, rpwwn);\r\nif (itnim == NULL)\r\nreturn BFA_STATUS_NO_FCPIM_NEXUS;\r\nmemset(&itnim->stats, 0, sizeof(struct bfa_itnim_stats_s));\r\nreturn BFA_STATUS_OK;\r\n}\r\nvoid\r\nbfa_fcs_fcpim_uf_recv(struct bfa_fcs_itnim_s *itnim,\r\nstruct fchs_s *fchs, u16 len)\r\n{\r\nstruct fc_els_cmd_s *els_cmd;\r\nbfa_trc(itnim->fcs, fchs->type);\r\nif (fchs->type != FC_TYPE_ELS)\r\nreturn;\r\nels_cmd = (struct fc_els_cmd_s *) (fchs + 1);\r\nbfa_trc(itnim->fcs, els_cmd->els_code);\r\nswitch (els_cmd->els_code) {\r\ncase FC_ELS_PRLO:\r\nbfa_fcs_rport_prlo(itnim->rport, fchs->ox_id);\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\n}

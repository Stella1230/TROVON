static void atmel_start_clock(struct atmel_ehci_priv *atmel_ehci)\r\n{\r\nif (atmel_ehci->clocked)\r\nreturn;\r\nclk_prepare_enable(atmel_ehci->uclk);\r\nclk_prepare_enable(atmel_ehci->iclk);\r\natmel_ehci->clocked = true;\r\n}\r\nstatic void atmel_stop_clock(struct atmel_ehci_priv *atmel_ehci)\r\n{\r\nif (!atmel_ehci->clocked)\r\nreturn;\r\nclk_disable_unprepare(atmel_ehci->iclk);\r\nclk_disable_unprepare(atmel_ehci->uclk);\r\natmel_ehci->clocked = false;\r\n}\r\nstatic void atmel_start_ehci(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct atmel_ehci_priv *atmel_ehci = hcd_to_atmel_ehci_priv(hcd);\r\ndev_dbg(&pdev->dev, "start\n");\r\natmel_start_clock(atmel_ehci);\r\n}\r\nstatic void atmel_stop_ehci(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct atmel_ehci_priv *atmel_ehci = hcd_to_atmel_ehci_priv(hcd);\r\ndev_dbg(&pdev->dev, "stop\n");\r\natmel_stop_clock(atmel_ehci);\r\n}\r\nstatic int ehci_atmel_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nconst struct hc_driver *driver = &ehci_atmel_hc_driver;\r\nstruct resource *res;\r\nstruct ehci_hcd *ehci;\r\nstruct atmel_ehci_priv *atmel_ehci;\r\nint irq;\r\nint retval;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\npr_debug("Initializing Atmel-SoC USB Host Controller\n");\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0) {\r\ndev_err(&pdev->dev,\r\n"Found HC with no IRQ. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nretval = -ENODEV;\r\ngoto fail_create_hcd;\r\n}\r\nretval = dma_coerce_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(32));\r\nif (retval)\r\ngoto fail_create_hcd;\r\nhcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd) {\r\nretval = -ENOMEM;\r\ngoto fail_create_hcd;\r\n}\r\natmel_ehci = hcd_to_atmel_ehci_priv(hcd);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhcd->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(hcd->regs)) {\r\nretval = PTR_ERR(hcd->regs);\r\ngoto fail_request_resource;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\natmel_ehci->iclk = devm_clk_get(&pdev->dev, "ehci_clk");\r\nif (IS_ERR(atmel_ehci->iclk)) {\r\ndev_err(&pdev->dev, "Error getting interface clock\n");\r\nretval = -ENOENT;\r\ngoto fail_request_resource;\r\n}\r\natmel_ehci->uclk = devm_clk_get(&pdev->dev, "usb_clk");\r\nif (IS_ERR(atmel_ehci->uclk)) {\r\ndev_err(&pdev->dev, "failed to get uclk\n");\r\nretval = PTR_ERR(atmel_ehci->uclk);\r\ngoto fail_request_resource;\r\n}\r\nehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs;\r\natmel_start_ehci(pdev);\r\nretval = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (retval)\r\ngoto fail_add_hcd;\r\ndevice_wakeup_enable(hcd->self.controller);\r\nreturn retval;\r\nfail_add_hcd:\r\natmel_stop_ehci(pdev);\r\nfail_request_resource:\r\nusb_put_hcd(hcd);\r\nfail_create_hcd:\r\ndev_err(&pdev->dev, "init %s fail, %d\n",\r\ndev_name(&pdev->dev), retval);\r\nreturn retval;\r\n}\r\nstatic int ehci_atmel_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\natmel_stop_ehci(pdev);\r\nreturn 0;\r\n}\r\nstatic int ehci_atmel_drv_suspend(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct atmel_ehci_priv *atmel_ehci = hcd_to_atmel_ehci_priv(hcd);\r\nint ret;\r\nret = ehci_suspend(hcd, false);\r\nif (ret)\r\nreturn ret;\r\natmel_stop_clock(atmel_ehci);\r\nreturn 0;\r\n}\r\nstatic int ehci_atmel_drv_resume(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct atmel_ehci_priv *atmel_ehci = hcd_to_atmel_ehci_priv(hcd);\r\natmel_start_clock(atmel_ehci);\r\nreturn ehci_resume(hcd, false);\r\n}\r\nstatic int __init ehci_atmel_init(void)\r\n{\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\npr_info("%s: " DRIVER_DESC "\n", hcd_name);\r\nehci_init_driver(&ehci_atmel_hc_driver, &ehci_atmel_drv_overrides);\r\nreturn platform_driver_register(&ehci_atmel_driver);\r\n}\r\nstatic void __exit ehci_atmel_cleanup(void)\r\n{\r\nplatform_driver_unregister(&ehci_atmel_driver);\r\n}

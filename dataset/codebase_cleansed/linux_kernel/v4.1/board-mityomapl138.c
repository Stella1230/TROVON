static void mityomapl138_cpufreq_init(const char *partnum)\r\n{\r\nint i, ret;\r\nfor (i = 0; partnum && i < ARRAY_SIZE(mityomapl138_pn_info); i++) {\r\nif (!strncmp(partnum, mityomapl138_pn_info[i].part_no,\r\nstrlen(mityomapl138_pn_info[i].part_no))) {\r\nda850_max_speed = mityomapl138_pn_info[i].max_freq;\r\nbreak;\r\n}\r\n}\r\nret = da850_register_cpufreq("pll0_sysclk3");\r\nif (ret)\r\npr_warn("cpufreq registration failed: %d\n", ret);\r\n}\r\nstatic void mityomapl138_cpufreq_init(const char *partnum) { }\r\nstatic void read_factory_config(struct memory_accessor *a, void *context)\r\n{\r\nint ret;\r\nconst char *partnum = NULL;\r\nstruct davinci_soc_info *soc_info = &davinci_soc_info;\r\nret = a->read(a, (char *)&factory_config, 0, sizeof(factory_config));\r\nif (ret != sizeof(struct factory_config)) {\r\npr_warn("Read Factory Config Failed: %d\n", ret);\r\ngoto bad_config;\r\n}\r\nif (factory_config.magic != FACTORY_CONFIG_MAGIC) {\r\npr_warn("Factory Config Magic Wrong (%X)\n",\r\nfactory_config.magic);\r\ngoto bad_config;\r\n}\r\nif (factory_config.version != FACTORY_CONFIG_VERSION) {\r\npr_warn("Factory Config Version Wrong (%X)\n",\r\nfactory_config.version);\r\ngoto bad_config;\r\n}\r\npr_info("Found MAC = %pM\n", factory_config.mac);\r\nif (is_valid_ether_addr(factory_config.mac))\r\nmemcpy(soc_info->emac_pdata->mac_addr,\r\nfactory_config.mac, ETH_ALEN);\r\nelse\r\npr_warn("Invalid MAC found in factory config block\n");\r\npartnum = factory_config.partnum;\r\npr_info("Part Number = %s\n", partnum);\r\nbad_config:\r\nmityomapl138_cpufreq_init(partnum);\r\n}\r\nstatic int __init pmic_tps65023_init(void)\r\n{\r\nreturn i2c_register_board_info(1, mityomap_tps65023_info,\r\nARRAY_SIZE(mityomap_tps65023_info));\r\n}\r\nstatic void __init mityomapl138_setup_nand(void)\r\n{\r\nplatform_add_devices(mityomapl138_devices,\r\nARRAY_SIZE(mityomapl138_devices));\r\nif (davinci_aemif_setup(&mityomapl138_nandflash_device))\r\npr_warn("%s: Cannot configure AEMIF\n", __func__);\r\n}\r\nstatic void __init mityomapl138_config_emac(void)\r\n{\r\nvoid __iomem *cfg_chip3_base;\r\nint ret;\r\nu32 val;\r\nstruct davinci_soc_info *soc_info = &davinci_soc_info;\r\nsoc_info->emac_pdata->rmii_en = 0;\r\ncfg_chip3_base = DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP3_REG);\r\nval = __raw_readl(cfg_chip3_base);\r\nif (soc_info->emac_pdata->rmii_en) {\r\nval |= BIT(8);\r\nret = davinci_cfg_reg_list(mityomap_rmii_pins);\r\npr_info("RMII PHY configured\n");\r\n} else {\r\nval &= ~BIT(8);\r\nret = davinci_cfg_reg_list(mityomap_mii_pins);\r\npr_info("MII PHY configured\n");\r\n}\r\nif (ret) {\r\npr_warn("mii/rmii mux setup failed: %d\n", ret);\r\nreturn;\r\n}\r\n__raw_writel(val, cfg_chip3_base);\r\nsoc_info->emac_pdata->phy_id = MITYOMAPL138_PHY_ID;\r\nret = da8xx_register_emac();\r\nif (ret)\r\npr_warn("emac registration failed: %d\n", ret);\r\n}\r\nstatic void __init mityomapl138_init(void)\r\n{\r\nint ret;\r\nret = da850_register_edma(NULL);\r\nif (ret)\r\npr_warn("edma registration failed: %d\n", ret);\r\nret = da8xx_register_watchdog();\r\nif (ret)\r\npr_warn("watchdog registration failed: %d\n", ret);\r\ndavinci_serial_init(da8xx_serial_device);\r\nret = da8xx_register_i2c(0, &mityomap_i2c_0_pdata);\r\nif (ret)\r\npr_warn("i2c0 registration failed: %d\n", ret);\r\nret = pmic_tps65023_init();\r\nif (ret)\r\npr_warn("TPS65023 PMIC init failed: %d\n", ret);\r\nmityomapl138_setup_nand();\r\nret = spi_register_board_info(mityomapl138_spi_flash_info,\r\nARRAY_SIZE(mityomapl138_spi_flash_info));\r\nif (ret)\r\npr_warn("spi info registration failed: %d\n", ret);\r\nret = da8xx_register_spi_bus(1,\r\nARRAY_SIZE(mityomapl138_spi_flash_info));\r\nif (ret)\r\npr_warn("spi 1 registration failed: %d\n", ret);\r\nmityomapl138_config_emac();\r\nret = da8xx_register_rtc();\r\nif (ret)\r\npr_warn("rtc setup failed: %d\n", ret);\r\nret = da8xx_register_cpuidle();\r\nif (ret)\r\npr_warn("cpuidle registration failed: %d\n", ret);\r\nret = da850_register_pm(&da850_pm_device);\r\nif (ret)\r\npr_warn("suspend registration failed: %d\n", ret);\r\n}\r\nstatic int __init mityomapl138_console_init(void)\r\n{\r\nif (!machine_is_mityomapl138())\r\nreturn 0;\r\nreturn add_preferred_console("ttyS", 1, "115200");\r\n}\r\nstatic void __init mityomapl138_map_io(void)\r\n{\r\nda850_init();\r\n}

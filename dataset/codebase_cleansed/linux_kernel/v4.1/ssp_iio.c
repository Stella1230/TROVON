int ssp_common_buffer_postenable(struct iio_dev *indio_dev)\r\n{\r\nstruct ssp_sensor_data *spd = iio_priv(indio_dev);\r\nstruct ssp_data *data = dev_get_drvdata(indio_dev->dev.parent->parent);\r\nspd->buffer = kmalloc(indio_dev->scan_bytes, GFP_KERNEL | GFP_DMA);\r\nif (!spd->buffer)\r\nreturn -ENOMEM;\r\nreturn ssp_enable_sensor(data, spd->type,\r\nssp_get_sensor_delay(data, spd->type));\r\n}\r\nint ssp_common_buffer_postdisable(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct ssp_sensor_data *spd = iio_priv(indio_dev);\r\nstruct ssp_data *data = dev_get_drvdata(indio_dev->dev.parent->parent);\r\nret = ssp_disable_sensor(data, spd->type);\r\nif (ret < 0)\r\nreturn ret;\r\nkfree(spd->buffer);\r\nreturn ret;\r\n}\r\nint ssp_common_process_data(struct iio_dev *indio_dev, void *buf,\r\nunsigned int len, int64_t timestamp)\r\n{\r\n__le32 time;\r\nint64_t calculated_time;\r\nstruct ssp_sensor_data *spd = iio_priv(indio_dev);\r\nif (indio_dev->scan_bytes == 0)\r\nreturn 0;\r\nmemcpy(spd->buffer, buf, len);\r\nif (indio_dev->scan_timestamp) {\r\nmemcpy(&time, &((char *)buf)[len], SSP_TIME_SIZE);\r\ncalculated_time =\r\ntimestamp + (int64_t)le32_to_cpu(time) * 1000000;\r\n}\r\nreturn iio_push_to_buffers_with_timestamp(indio_dev, spd->buffer,\r\ncalculated_time);\r\n}

static inline struct cros_ec_device *to_ec_dev(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nreturn i2c_get_clientdata(client);\r\n}\r\nstatic int cros_ec_cmd_xfer_i2c(struct cros_ec_device *ec_dev,\r\nstruct cros_ec_command *msg)\r\n{\r\nstruct i2c_client *client = ec_dev->priv;\r\nint ret = -ENOMEM;\r\nint i;\r\nint len;\r\nint packet_len;\r\nu8 *out_buf = NULL;\r\nu8 *in_buf = NULL;\r\nu8 sum;\r\nstruct i2c_msg i2c_msg[2];\r\ni2c_msg[0].addr = client->addr;\r\ni2c_msg[0].flags = 0;\r\ni2c_msg[1].addr = client->addr;\r\ni2c_msg[1].flags = I2C_M_RD;\r\npacket_len = msg->insize + 3;\r\nin_buf = kzalloc(packet_len, GFP_KERNEL);\r\nif (!in_buf)\r\ngoto done;\r\ni2c_msg[1].len = packet_len;\r\ni2c_msg[1].buf = (char *)in_buf;\r\npacket_len = msg->outsize + 4;\r\nout_buf = kzalloc(packet_len, GFP_KERNEL);\r\nif (!out_buf)\r\ngoto done;\r\ni2c_msg[0].len = packet_len;\r\ni2c_msg[0].buf = (char *)out_buf;\r\nout_buf[0] = EC_CMD_VERSION0 + msg->version;\r\nout_buf[1] = msg->command;\r\nout_buf[2] = msg->outsize;\r\nsum = out_buf[0] + out_buf[1] + out_buf[2];\r\nfor (i = 0; i < msg->outsize; i++) {\r\nout_buf[3 + i] = msg->outdata[i];\r\nsum += out_buf[3 + i];\r\n}\r\nout_buf[3 + msg->outsize] = sum;\r\nret = i2c_transfer(client->adapter, i2c_msg, 2);\r\nif (ret < 0) {\r\ndev_err(ec_dev->dev, "i2c transfer failed: %d\n", ret);\r\ngoto done;\r\n} else if (ret != 2) {\r\ndev_err(ec_dev->dev, "failed to get response: %d\n", ret);\r\nret = -EIO;\r\ngoto done;\r\n}\r\nmsg->result = i2c_msg[1].buf[0];\r\nret = cros_ec_check_result(ec_dev, msg);\r\nif (ret)\r\ngoto done;\r\nlen = in_buf[1];\r\nif (len > msg->insize) {\r\ndev_err(ec_dev->dev, "packet too long (%d bytes, expected %d)",\r\nlen, msg->insize);\r\nret = -ENOSPC;\r\ngoto done;\r\n}\r\nsum = in_buf[0] + in_buf[1];\r\nfor (i = 0; i < len; i++) {\r\nmsg->indata[i] = in_buf[2 + i];\r\nsum += in_buf[2 + i];\r\n}\r\ndev_dbg(ec_dev->dev, "packet: %*ph, sum = %02x\n",\r\ni2c_msg[1].len, in_buf, sum);\r\nif (sum != in_buf[2 + len]) {\r\ndev_err(ec_dev->dev, "bad packet checksum\n");\r\nret = -EBADMSG;\r\ngoto done;\r\n}\r\nret = len;\r\ndone:\r\nkfree(in_buf);\r\nkfree(out_buf);\r\nreturn ret;\r\n}\r\nstatic int cros_ec_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *dev_id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct cros_ec_device *ec_dev = NULL;\r\nint err;\r\nec_dev = devm_kzalloc(dev, sizeof(*ec_dev), GFP_KERNEL);\r\nif (!ec_dev)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, ec_dev);\r\nec_dev->dev = dev;\r\nec_dev->priv = client;\r\nec_dev->irq = client->irq;\r\nec_dev->cmd_xfer = cros_ec_cmd_xfer_i2c;\r\nec_dev->ec_name = client->name;\r\nec_dev->phys_name = client->adapter->name;\r\nec_dev->parent = &client->dev;\r\nerr = cros_ec_register(ec_dev);\r\nif (err) {\r\ndev_err(dev, "cannot register EC\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cros_ec_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct cros_ec_device *ec_dev = i2c_get_clientdata(client);\r\ncros_ec_remove(ec_dev);\r\nreturn 0;\r\n}\r\nstatic int cros_ec_i2c_suspend(struct device *dev)\r\n{\r\nstruct cros_ec_device *ec_dev = to_ec_dev(dev);\r\nreturn cros_ec_suspend(ec_dev);\r\n}\r\nstatic int cros_ec_i2c_resume(struct device *dev)\r\n{\r\nstruct cros_ec_device *ec_dev = to_ec_dev(dev);\r\nreturn cros_ec_resume(ec_dev);\r\n}

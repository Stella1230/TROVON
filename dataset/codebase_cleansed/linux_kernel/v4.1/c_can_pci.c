static u16 c_can_pci_read_reg_aligned_to_16bit(const struct c_can_priv *priv,\r\nenum reg index)\r\n{\r\nreturn readw(priv->base + priv->regs[index]);\r\n}\r\nstatic void c_can_pci_write_reg_aligned_to_16bit(const struct c_can_priv *priv,\r\nenum reg index, u16 val)\r\n{\r\nwritew(val, priv->base + priv->regs[index]);\r\n}\r\nstatic u16 c_can_pci_read_reg_aligned_to_32bit(const struct c_can_priv *priv,\r\nenum reg index)\r\n{\r\nreturn readw(priv->base + 2 * priv->regs[index]);\r\n}\r\nstatic void c_can_pci_write_reg_aligned_to_32bit(const struct c_can_priv *priv,\r\nenum reg index, u16 val)\r\n{\r\nwritew(val, priv->base + 2 * priv->regs[index]);\r\n}\r\nstatic u16 c_can_pci_read_reg_32bit(const struct c_can_priv *priv,\r\nenum reg index)\r\n{\r\nreturn (u16)ioread32(priv->base + 2 * priv->regs[index]);\r\n}\r\nstatic void c_can_pci_write_reg_32bit(const struct c_can_priv *priv,\r\nenum reg index, u16 val)\r\n{\r\niowrite32((u32)val, priv->base + 2 * priv->regs[index]);\r\n}\r\nstatic u32 c_can_pci_read_reg32(const struct c_can_priv *priv, enum reg index)\r\n{\r\nu32 val;\r\nval = priv->read_reg(priv, index);\r\nval |= ((u32) priv->read_reg(priv, index + 1)) << 16;\r\nreturn val;\r\n}\r\nstatic void c_can_pci_write_reg32(const struct c_can_priv *priv, enum reg index,\r\nu32 val)\r\n{\r\npriv->write_reg(priv, index + 1, val >> 16);\r\npriv->write_reg(priv, index, val);\r\n}\r\nstatic void c_can_pci_reset_pch(const struct c_can_priv *priv, bool enable)\r\n{\r\nif (enable) {\r\nu32 __iomem *addr = priv->base + PCH_PCI_SOFT_RESET;\r\niowrite32(1, addr);\r\niowrite32(0, addr);\r\n}\r\n}\r\nstatic int c_can_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct c_can_pci_data *c_can_pci_data = (void *)ent->driver_data;\r\nstruct c_can_priv *priv;\r\nstruct net_device *dev;\r\nvoid __iomem *addr;\r\nint ret;\r\nret = pci_enable_device(pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "pci_enable_device FAILED\n");\r\ngoto out;\r\n}\r\nret = pci_request_regions(pdev, KBUILD_MODNAME);\r\nif (ret) {\r\ndev_err(&pdev->dev, "pci_request_regions FAILED\n");\r\ngoto out_disable_device;\r\n}\r\nret = pci_enable_msi(pdev);\r\nif (!ret) {\r\ndev_info(&pdev->dev, "MSI enabled\n");\r\npci_set_master(pdev);\r\n}\r\naddr = pci_iomap(pdev, c_can_pci_data->bar,\r\npci_resource_len(pdev, c_can_pci_data->bar));\r\nif (!addr) {\r\ndev_err(&pdev->dev,\r\n"device has no PCI memory resources, "\r\n"failing adapter\n");\r\nret = -ENOMEM;\r\ngoto out_release_regions;\r\n}\r\ndev = alloc_c_can_dev();\r\nif (!dev) {\r\nret = -ENOMEM;\r\ngoto out_iounmap;\r\n}\r\npriv = netdev_priv(dev);\r\npci_set_drvdata(pdev, dev);\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\ndev->irq = pdev->irq;\r\npriv->base = addr;\r\nif (!c_can_pci_data->freq) {\r\ndev_err(&pdev->dev, "no clock frequency defined\n");\r\nret = -ENODEV;\r\ngoto out_free_c_can;\r\n} else {\r\npriv->can.clock.freq = c_can_pci_data->freq;\r\n}\r\nswitch (c_can_pci_data->type) {\r\ncase BOSCH_C_CAN:\r\npriv->regs = reg_map_c_can;\r\nbreak;\r\ncase BOSCH_D_CAN:\r\npriv->regs = reg_map_d_can;\r\npriv->can.ctrlmode_supported |= CAN_CTRLMODE_3_SAMPLES;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto out_free_c_can;\r\n}\r\npriv->type = c_can_pci_data->type;\r\nswitch (c_can_pci_data->reg_align) {\r\ncase C_CAN_REG_ALIGN_32:\r\npriv->read_reg = c_can_pci_read_reg_aligned_to_32bit;\r\npriv->write_reg = c_can_pci_write_reg_aligned_to_32bit;\r\nbreak;\r\ncase C_CAN_REG_ALIGN_16:\r\npriv->read_reg = c_can_pci_read_reg_aligned_to_16bit;\r\npriv->write_reg = c_can_pci_write_reg_aligned_to_16bit;\r\nbreak;\r\ncase C_CAN_REG_32:\r\npriv->read_reg = c_can_pci_read_reg_32bit;\r\npriv->write_reg = c_can_pci_write_reg_32bit;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto out_free_c_can;\r\n}\r\npriv->read_reg32 = c_can_pci_read_reg32;\r\npriv->write_reg32 = c_can_pci_write_reg32;\r\npriv->raminit = c_can_pci_data->init;\r\nret = register_c_can_dev(dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "registering %s failed (err=%d)\n",\r\nKBUILD_MODNAME, ret);\r\ngoto out_free_c_can;\r\n}\r\ndev_dbg(&pdev->dev, "%s device registered (regs=%p, irq=%d)\n",\r\nKBUILD_MODNAME, priv->regs, dev->irq);\r\nreturn 0;\r\nout_free_c_can:\r\nfree_c_can_dev(dev);\r\nout_iounmap:\r\npci_iounmap(pdev, addr);\r\nout_release_regions:\r\npci_disable_msi(pdev);\r\npci_clear_master(pdev);\r\npci_release_regions(pdev);\r\nout_disable_device:\r\npci_disable_device(pdev);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void c_can_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct c_can_priv *priv = netdev_priv(dev);\r\nunregister_c_can_dev(dev);\r\nfree_c_can_dev(dev);\r\npci_iounmap(pdev, priv->base);\r\npci_disable_msi(pdev);\r\npci_clear_master(pdev);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}

static unsigned long clk_fixed_rate_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nreturn to_clk_fixed_rate(hw)->fixed_rate;\r\n}\r\nstatic unsigned long clk_fixed_rate_recalc_accuracy(struct clk_hw *hw,\r\nunsigned long parent_accuracy)\r\n{\r\nreturn to_clk_fixed_rate(hw)->fixed_accuracy;\r\n}\r\nstruct clk *clk_register_fixed_rate_with_accuracy(struct device *dev,\r\nconst char *name, const char *parent_name, unsigned long flags,\r\nunsigned long fixed_rate, unsigned long fixed_accuracy)\r\n{\r\nstruct clk_fixed_rate *fixed;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nfixed = kzalloc(sizeof(struct clk_fixed_rate), GFP_KERNEL);\r\nif (!fixed) {\r\npr_err("%s: could not allocate fixed clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninit.name = name;\r\ninit.ops = &clk_fixed_rate_ops;\r\ninit.flags = flags | CLK_IS_BASIC;\r\ninit.parent_names = (parent_name ? &parent_name: NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\nfixed->fixed_rate = fixed_rate;\r\nfixed->fixed_accuracy = fixed_accuracy;\r\nfixed->hw.init = &init;\r\nclk = clk_register(dev, &fixed->hw);\r\nif (IS_ERR(clk))\r\nkfree(fixed);\r\nreturn clk;\r\n}\r\nstruct clk *clk_register_fixed_rate(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags,\r\nunsigned long fixed_rate)\r\n{\r\nreturn clk_register_fixed_rate_with_accuracy(dev, name, parent_name,\r\nflags, fixed_rate, 0);\r\n}\r\nvoid of_fixed_clk_setup(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nconst char *clk_name = node->name;\r\nu32 rate;\r\nu32 accuracy = 0;\r\nif (of_property_read_u32(node, "clock-frequency", &rate))\r\nreturn;\r\nof_property_read_u32(node, "clock-accuracy", &accuracy);\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nclk = clk_register_fixed_rate_with_accuracy(NULL, clk_name, NULL,\r\nCLK_IS_ROOT, rate,\r\naccuracy);\r\nif (!IS_ERR(clk))\r\nof_clk_add_provider(node, of_clk_src_simple_get, clk);\r\n}

static int __init ima_template_setup(char *str)\r\n{\r\nstruct ima_template_desc *template_desc;\r\nint template_len = strlen(str);\r\nif (ima_template)\r\nreturn 1;\r\ntemplate_desc = lookup_template_desc(str);\r\nif (!template_desc) {\r\npr_err("template %s not found, using %s\n",\r\nstr, CONFIG_IMA_DEFAULT_TEMPLATE);\r\nreturn 1;\r\n}\r\nif (template_len == 3 && strcmp(str, IMA_TEMPLATE_IMA_NAME) == 0 &&\r\nima_hash_algo != HASH_ALGO_SHA1 && ima_hash_algo != HASH_ALGO_MD5) {\r\npr_err("template does not support hash alg\n");\r\nreturn 1;\r\n}\r\nima_template = template_desc;\r\nreturn 1;\r\n}\r\nstatic int __init ima_template_fmt_setup(char *str)\r\n{\r\nint num_templates = ARRAY_SIZE(defined_templates);\r\nif (ima_template)\r\nreturn 1;\r\nif (template_desc_init_fields(str, NULL, NULL) < 0) {\r\npr_err("format string '%s' not valid, using template %s\n",\r\nstr, CONFIG_IMA_DEFAULT_TEMPLATE);\r\nreturn 1;\r\n}\r\ndefined_templates[num_templates - 1].fmt = str;\r\nima_template = defined_templates + num_templates - 1;\r\nreturn 1;\r\n}\r\nstatic struct ima_template_desc *lookup_template_desc(const char *name)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(defined_templates); i++) {\r\nif (strcmp(defined_templates[i].name, name) == 0)\r\nreturn defined_templates + i;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct ima_template_field *lookup_template_field(const char *field_id)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(supported_fields); i++)\r\nif (strncmp(supported_fields[i].field_id, field_id,\r\nIMA_TEMPLATE_FIELD_ID_MAX_LEN) == 0)\r\nreturn &supported_fields[i];\r\nreturn NULL;\r\n}\r\nstatic int template_fmt_size(const char *template_fmt)\r\n{\r\nchar c;\r\nint template_fmt_len = strlen(template_fmt);\r\nint i = 0, j = 0;\r\nwhile (i < template_fmt_len) {\r\nc = template_fmt[i];\r\nif (c == '|')\r\nj++;\r\ni++;\r\n}\r\nreturn j + 1;\r\n}\r\nstatic int template_desc_init_fields(const char *template_fmt,\r\nstruct ima_template_field ***fields,\r\nint *num_fields)\r\n{\r\nconst char *template_fmt_ptr;\r\nstruct ima_template_field *found_fields[IMA_TEMPLATE_NUM_FIELDS_MAX];\r\nint template_num_fields = template_fmt_size(template_fmt);\r\nint i, len;\r\nif (template_num_fields > IMA_TEMPLATE_NUM_FIELDS_MAX) {\r\npr_err("format string '%s' contains too many fields\n",\r\ntemplate_fmt);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0, template_fmt_ptr = template_fmt; i < template_num_fields;\r\ni++, template_fmt_ptr += len + 1) {\r\nchar tmp_field_id[IMA_TEMPLATE_FIELD_ID_MAX_LEN + 1];\r\nlen = strchrnul(template_fmt_ptr, '|') - template_fmt_ptr;\r\nif (len == 0 || len > IMA_TEMPLATE_FIELD_ID_MAX_LEN) {\r\npr_err("Invalid field with length %d\n", len);\r\nreturn -EINVAL;\r\n}\r\nmemcpy(tmp_field_id, template_fmt_ptr, len);\r\ntmp_field_id[len] = '\0';\r\nfound_fields[i] = lookup_template_field(tmp_field_id);\r\nif (!found_fields[i]) {\r\npr_err("field '%s' not found\n", tmp_field_id);\r\nreturn -ENOENT;\r\n}\r\n}\r\nif (fields && num_fields) {\r\n*fields = kmalloc_array(i, sizeof(*fields), GFP_KERNEL);\r\nif (*fields == NULL)\r\nreturn -ENOMEM;\r\nmemcpy(*fields, found_fields, i * sizeof(*fields));\r\n*num_fields = i;\r\n}\r\nreturn 0;\r\n}\r\nstruct ima_template_desc *ima_template_desc_current(void)\r\n{\r\nif (!ima_template)\r\nima_template =\r\nlookup_template_desc(CONFIG_IMA_DEFAULT_TEMPLATE);\r\nreturn ima_template;\r\n}\r\nint __init ima_init_template(void)\r\n{\r\nstruct ima_template_desc *template = ima_template_desc_current();\r\nint result;\r\nresult = template_desc_init_fields(template->fmt,\r\n&(template->fields),\r\n&(template->num_fields));\r\nif (result < 0)\r\npr_err("template %s init failed, result: %d\n",\r\n(strlen(template->name) ?\r\ntemplate->name : template->fmt), result);\r\nreturn result;\r\n}

void __init dove_map_io(void)\r\n{\r\niotable_init(dove_io_desc, ARRAY_SIZE(dove_io_desc));\r\n}\r\nstatic struct clk __init *dove_register_gate(const char *name,\r\nconst char *parent, u8 bit_idx)\r\n{\r\nreturn clk_register_gate(NULL, name, parent, 0,\r\n(void __iomem *)CLOCK_GATING_CONTROL,\r\nbit_idx, 0, &gating_lock);\r\n}\r\nstatic void __init dove_clk_init(void)\r\n{\r\nstruct clk *usb0, *usb1, *sata, *pex0, *pex1, *sdio0, *sdio1;\r\nstruct clk *nand, *camera, *i2s0, *i2s1, *crypto, *ac97, *pdma;\r\nstruct clk *xor0, *xor1, *ge, *gephy;\r\ntclk = clk_register_fixed_rate(NULL, "tclk", NULL, CLK_IS_ROOT,\r\ndove_tclk);\r\nusb0 = dove_register_gate("usb0", "tclk", CLOCK_GATING_BIT_USB0);\r\nusb1 = dove_register_gate("usb1", "tclk", CLOCK_GATING_BIT_USB1);\r\nsata = dove_register_gate("sata", "tclk", CLOCK_GATING_BIT_SATA);\r\npex0 = dove_register_gate("pex0", "tclk", CLOCK_GATING_BIT_PCIE0);\r\npex1 = dove_register_gate("pex1", "tclk", CLOCK_GATING_BIT_PCIE1);\r\nsdio0 = dove_register_gate("sdio0", "tclk", CLOCK_GATING_BIT_SDIO0);\r\nsdio1 = dove_register_gate("sdio1", "tclk", CLOCK_GATING_BIT_SDIO1);\r\nnand = dove_register_gate("nand", "tclk", CLOCK_GATING_BIT_NAND);\r\ncamera = dove_register_gate("camera", "tclk", CLOCK_GATING_BIT_CAMERA);\r\ni2s0 = dove_register_gate("i2s0", "tclk", CLOCK_GATING_BIT_I2S0);\r\ni2s1 = dove_register_gate("i2s1", "tclk", CLOCK_GATING_BIT_I2S1);\r\ncrypto = dove_register_gate("crypto", "tclk", CLOCK_GATING_BIT_CRYPTO);\r\nac97 = dove_register_gate("ac97", "tclk", CLOCK_GATING_BIT_AC97);\r\npdma = dove_register_gate("pdma", "tclk", CLOCK_GATING_BIT_PDMA);\r\nxor0 = dove_register_gate("xor0", "tclk", CLOCK_GATING_BIT_XOR0);\r\nxor1 = dove_register_gate("xor1", "tclk", CLOCK_GATING_BIT_XOR1);\r\ngephy = dove_register_gate("gephy", "tclk", CLOCK_GATING_BIT_GIGA_PHY);\r\nge = dove_register_gate("ge", "gephy", CLOCK_GATING_BIT_GBE);\r\norion_clkdev_add(NULL, "orion_spi.0", tclk);\r\norion_clkdev_add(NULL, "orion_spi.1", tclk);\r\norion_clkdev_add(NULL, "orion_wdt", tclk);\r\norion_clkdev_add(NULL, "mv64xxx_i2c.0", tclk);\r\norion_clkdev_add(NULL, "orion-ehci.0", usb0);\r\norion_clkdev_add(NULL, "orion-ehci.1", usb1);\r\norion_clkdev_add(NULL, "mv643xx_eth_port.0", ge);\r\norion_clkdev_add(NULL, "sata_mv.0", sata);\r\norion_clkdev_add("0", "pcie", pex0);\r\norion_clkdev_add("1", "pcie", pex1);\r\norion_clkdev_add(NULL, "sdhci-dove.0", sdio0);\r\norion_clkdev_add(NULL, "sdhci-dove.1", sdio1);\r\norion_clkdev_add(NULL, "orion_nand", nand);\r\norion_clkdev_add(NULL, "cafe1000-ccic.0", camera);\r\norion_clkdev_add(NULL, "mvebu-audio.0", i2s0);\r\norion_clkdev_add(NULL, "mvebu-audio.1", i2s1);\r\norion_clkdev_add(NULL, "mv_crypto", crypto);\r\norion_clkdev_add(NULL, "dove-ac97", ac97);\r\norion_clkdev_add(NULL, "dove-pdma", pdma);\r\norion_clkdev_add(NULL, MV_XOR_NAME ".0", xor0);\r\norion_clkdev_add(NULL, MV_XOR_NAME ".1", xor1);\r\n}\r\nvoid __init dove_ehci0_init(void)\r\n{\r\norion_ehci_init(DOVE_USB0_PHYS_BASE, IRQ_DOVE_USB0, EHCI_PHY_NA);\r\n}\r\nvoid __init dove_ehci1_init(void)\r\n{\r\norion_ehci_1_init(DOVE_USB1_PHYS_BASE, IRQ_DOVE_USB1);\r\n}\r\nvoid __init dove_ge00_init(struct mv643xx_eth_platform_data *eth_data)\r\n{\r\norion_ge00_init(eth_data, DOVE_GE00_PHYS_BASE,\r\nIRQ_DOVE_GE00_SUM, IRQ_DOVE_GE00_ERR,\r\n1600);\r\n}\r\nstatic void __init dove_rtc_init(void)\r\n{\r\norion_rtc_init(DOVE_RTC_PHYS_BASE, IRQ_DOVE_RTC);\r\n}\r\nvoid __init dove_sata_init(struct mv_sata_platform_data *sata_data)\r\n{\r\norion_sata_init(sata_data, DOVE_SATA_PHYS_BASE, IRQ_DOVE_SATA);\r\n}\r\nvoid __init dove_uart0_init(void)\r\n{\r\norion_uart0_init(DOVE_UART0_VIRT_BASE, DOVE_UART0_PHYS_BASE,\r\nIRQ_DOVE_UART_0, tclk);\r\n}\r\nvoid __init dove_uart1_init(void)\r\n{\r\norion_uart1_init(DOVE_UART1_VIRT_BASE, DOVE_UART1_PHYS_BASE,\r\nIRQ_DOVE_UART_1, tclk);\r\n}\r\nvoid __init dove_uart2_init(void)\r\n{\r\norion_uart2_init(DOVE_UART2_VIRT_BASE, DOVE_UART2_PHYS_BASE,\r\nIRQ_DOVE_UART_2, tclk);\r\n}\r\nvoid __init dove_uart3_init(void)\r\n{\r\norion_uart3_init(DOVE_UART3_VIRT_BASE, DOVE_UART3_PHYS_BASE,\r\nIRQ_DOVE_UART_3, tclk);\r\n}\r\nvoid __init dove_spi0_init(void)\r\n{\r\norion_spi_init(DOVE_SPI0_PHYS_BASE);\r\n}\r\nvoid __init dove_spi1_init(void)\r\n{\r\norion_spi_1_init(DOVE_SPI1_PHYS_BASE);\r\n}\r\nvoid __init dove_i2c_init(void)\r\n{\r\norion_i2c_init(DOVE_I2C_PHYS_BASE, IRQ_DOVE_I2C, 10);\r\n}\r\nvoid __init dove_init_early(void)\r\n{\r\norion_time_set_base(TIMER_VIRT_BASE);\r\nmvebu_mbus_init("marvell,dove-mbus",\r\nBRIDGE_WINS_BASE, BRIDGE_WINS_SZ,\r\nDOVE_MC_WINS_BASE, DOVE_MC_WINS_SZ);\r\n}\r\nstatic int __init dove_find_tclk(void)\r\n{\r\nreturn 166666667;\r\n}\r\nvoid __init dove_timer_init(void)\r\n{\r\ndove_tclk = dove_find_tclk();\r\norion_time_init(BRIDGE_VIRT_BASE, BRIDGE_INT_TIMER1_CLR,\r\nIRQ_DOVE_BRIDGE, dove_tclk);\r\n}\r\nstatic void __init dove_xor0_init(void)\r\n{\r\norion_xor0_init(DOVE_XOR0_PHYS_BASE, DOVE_XOR0_HIGH_PHYS_BASE,\r\nIRQ_DOVE_XOR_00, IRQ_DOVE_XOR_01);\r\n}\r\nstatic void __init dove_xor1_init(void)\r\n{\r\norion_xor1_init(DOVE_XOR1_PHYS_BASE, DOVE_XOR1_HIGH_PHYS_BASE,\r\nIRQ_DOVE_XOR_10, IRQ_DOVE_XOR_11);\r\n}\r\nvoid __init dove_sdio0_init(void)\r\n{\r\nplatform_device_register(&dove_sdio0);\r\n}\r\nvoid __init dove_sdio1_init(void)\r\n{\r\nplatform_device_register(&dove_sdio1);\r\n}\r\nvoid __init dove_setup_cpu_wins(void)\r\n{\r\nmvebu_mbus_add_window_remap_by_id(DOVE_MBUS_PCIE0_IO_TARGET,\r\nDOVE_MBUS_PCIE0_IO_ATTR,\r\nDOVE_PCIE0_IO_PHYS_BASE,\r\nDOVE_PCIE0_IO_SIZE,\r\nDOVE_PCIE0_IO_BUS_BASE);\r\nmvebu_mbus_add_window_remap_by_id(DOVE_MBUS_PCIE1_IO_TARGET,\r\nDOVE_MBUS_PCIE1_IO_ATTR,\r\nDOVE_PCIE1_IO_PHYS_BASE,\r\nDOVE_PCIE1_IO_SIZE,\r\nDOVE_PCIE1_IO_BUS_BASE);\r\nmvebu_mbus_add_window_by_id(DOVE_MBUS_PCIE0_MEM_TARGET,\r\nDOVE_MBUS_PCIE0_MEM_ATTR,\r\nDOVE_PCIE0_MEM_PHYS_BASE,\r\nDOVE_PCIE0_MEM_SIZE);\r\nmvebu_mbus_add_window_by_id(DOVE_MBUS_PCIE1_MEM_TARGET,\r\nDOVE_MBUS_PCIE1_MEM_ATTR,\r\nDOVE_PCIE1_MEM_PHYS_BASE,\r\nDOVE_PCIE1_MEM_SIZE);\r\nmvebu_mbus_add_window_by_id(DOVE_MBUS_CESA_TARGET,\r\nDOVE_MBUS_CESA_ATTR,\r\nDOVE_CESA_PHYS_BASE,\r\nDOVE_CESA_SIZE);\r\nmvebu_mbus_add_window_by_id(DOVE_MBUS_BOOTROM_TARGET,\r\nDOVE_MBUS_BOOTROM_ATTR,\r\nDOVE_BOOTROM_PHYS_BASE,\r\nDOVE_BOOTROM_SIZE);\r\nmvebu_mbus_add_window_by_id(DOVE_MBUS_SCRATCHPAD_TARGET,\r\nDOVE_MBUS_SCRATCHPAD_ATTR,\r\nDOVE_SCRATCHPAD_PHYS_BASE,\r\nDOVE_SCRATCHPAD_SIZE);\r\n}\r\nvoid __init dove_init(void)\r\n{\r\npr_info("Dove 88AP510 SoC, TCLK = %d MHz.\n",\r\n(dove_tclk + 499999) / 1000000);\r\n#ifdef CONFIG_CACHE_TAUROS2\r\ntauros2_init(0);\r\n#endif\r\ndove_setup_cpu_wins();\r\ndove_clk_init();\r\ndove_rtc_init();\r\ndove_xor0_init();\r\ndove_xor1_init();\r\n}\r\nvoid dove_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nwritel(SOFT_RESET_OUT_EN, RSTOUTn_MASK);\r\nwritel(SOFT_RESET, SYSTEM_SOFT_RESET);\r\nwhile (1)\r\n;\r\n}

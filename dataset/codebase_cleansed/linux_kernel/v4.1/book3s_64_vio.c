static long kvmppc_stt_npages(unsigned long window_size)\r\n{\r\nreturn ALIGN((window_size >> SPAPR_TCE_SHIFT)\r\n* sizeof(u64), PAGE_SIZE) / PAGE_SIZE;\r\n}\r\nstatic void release_spapr_tce_table(struct kvmppc_spapr_tce_table *stt)\r\n{\r\nstruct kvm *kvm = stt->kvm;\r\nint i;\r\nmutex_lock(&kvm->lock);\r\nlist_del(&stt->list);\r\nfor (i = 0; i < kvmppc_stt_npages(stt->window_size); i++)\r\n__free_page(stt->pages[i]);\r\nkfree(stt);\r\nmutex_unlock(&kvm->lock);\r\nkvm_put_kvm(kvm);\r\n}\r\nstatic int kvm_spapr_tce_fault(struct vm_area_struct *vma, struct vm_fault *vmf)\r\n{\r\nstruct kvmppc_spapr_tce_table *stt = vma->vm_file->private_data;\r\nstruct page *page;\r\nif (vmf->pgoff >= kvmppc_stt_npages(stt->window_size))\r\nreturn VM_FAULT_SIGBUS;\r\npage = stt->pages[vmf->pgoff];\r\nget_page(page);\r\nvmf->page = page;\r\nreturn 0;\r\n}\r\nstatic int kvm_spapr_tce_mmap(struct file *file, struct vm_area_struct *vma)\r\n{\r\nvma->vm_ops = &kvm_spapr_tce_vm_ops;\r\nreturn 0;\r\n}\r\nstatic int kvm_spapr_tce_release(struct inode *inode, struct file *filp)\r\n{\r\nstruct kvmppc_spapr_tce_table *stt = filp->private_data;\r\nrelease_spapr_tce_table(stt);\r\nreturn 0;\r\n}\r\nlong kvm_vm_ioctl_create_spapr_tce(struct kvm *kvm,\r\nstruct kvm_create_spapr_tce *args)\r\n{\r\nstruct kvmppc_spapr_tce_table *stt = NULL;\r\nlong npages;\r\nint ret = -ENOMEM;\r\nint i;\r\nlist_for_each_entry(stt, &kvm->arch.spapr_tce_tables, list) {\r\nif (stt->liobn == args->liobn)\r\nreturn -EBUSY;\r\n}\r\nnpages = kvmppc_stt_npages(args->window_size);\r\nstt = kzalloc(sizeof(*stt) + npages * sizeof(struct page *),\r\nGFP_KERNEL);\r\nif (!stt)\r\ngoto fail;\r\nstt->liobn = args->liobn;\r\nstt->window_size = args->window_size;\r\nstt->kvm = kvm;\r\nfor (i = 0; i < npages; i++) {\r\nstt->pages[i] = alloc_page(GFP_KERNEL | __GFP_ZERO);\r\nif (!stt->pages[i])\r\ngoto fail;\r\n}\r\nkvm_get_kvm(kvm);\r\nmutex_lock(&kvm->lock);\r\nlist_add(&stt->list, &kvm->arch.spapr_tce_tables);\r\nmutex_unlock(&kvm->lock);\r\nreturn anon_inode_getfd("kvm-spapr-tce", &kvm_spapr_tce_fops,\r\nstt, O_RDWR | O_CLOEXEC);\r\nfail:\r\nif (stt) {\r\nfor (i = 0; i < npages; i++)\r\nif (stt->pages[i])\r\n__free_page(stt->pages[i]);\r\nkfree(stt);\r\n}\r\nreturn ret;\r\n}

static int imx_spdif_audio_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *spdif_np, *np = pdev->dev.of_node;\r\nstruct imx_spdif_data *data;\r\nint ret = 0;\r\nspdif_np = of_parse_phandle(np, "spdif-controller", 0);\r\nif (!spdif_np) {\r\ndev_err(&pdev->dev, "failed to find spdif-controller\n");\r\nret = -EINVAL;\r\ngoto end;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data) {\r\nret = -ENOMEM;\r\ngoto end;\r\n}\r\ndata->dai.name = "S/PDIF PCM";\r\ndata->dai.stream_name = "S/PDIF PCM";\r\ndata->dai.codec_dai_name = "snd-soc-dummy-dai";\r\ndata->dai.codec_name = "snd-soc-dummy";\r\ndata->dai.cpu_of_node = spdif_np;\r\ndata->dai.platform_of_node = spdif_np;\r\ndata->dai.playback_only = true;\r\ndata->dai.capture_only = true;\r\nif (of_property_read_bool(np, "spdif-out"))\r\ndata->dai.capture_only = false;\r\nif (of_property_read_bool(np, "spdif-in"))\r\ndata->dai.playback_only = false;\r\nif (data->dai.playback_only && data->dai.capture_only) {\r\ndev_err(&pdev->dev, "no enabled S/PDIF DAI link\n");\r\ngoto end;\r\n}\r\ndata->card.dev = &pdev->dev;\r\ndata->card.dai_link = &data->dai;\r\ndata->card.num_links = 1;\r\ndata->card.owner = THIS_MODULE;\r\nret = snd_soc_of_parse_card_name(&data->card, "model");\r\nif (ret)\r\ngoto end;\r\nret = devm_snd_soc_register_card(&pdev->dev, &data->card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "snd_soc_register_card failed: %d\n", ret);\r\ngoto end;\r\n}\r\nplatform_set_drvdata(pdev, data);\r\nend:\r\nof_node_put(spdif_np);\r\nreturn ret;\r\n}

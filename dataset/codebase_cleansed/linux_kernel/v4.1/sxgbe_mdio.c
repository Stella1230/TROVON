static int sxgbe_mdio_busy_wait(void __iomem *ioaddr, unsigned int mii_data)\r\n{\r\nunsigned long fin_time = jiffies + 3 * HZ;\r\nwhile (!time_after(jiffies, fin_time)) {\r\nif (!(readl(ioaddr + mii_data) & SXGBE_MII_BUSY))\r\nreturn 0;\r\ncpu_relax();\r\n}\r\nreturn -EBUSY;\r\n}\r\nstatic void sxgbe_mdio_ctrl_data(struct sxgbe_priv_data *sp, u32 cmd,\r\nu16 phydata)\r\n{\r\nu32 reg = phydata;\r\nreg |= (cmd << 16) | SXGBE_SMA_SKIP_ADDRFRM |\r\n((sp->clk_csr & 0x7) << 19) | SXGBE_MII_BUSY;\r\nwritel(reg, sp->ioaddr + sp->hw->mii.data);\r\n}\r\nstatic void sxgbe_mdio_c45(struct sxgbe_priv_data *sp, u32 cmd, int phyaddr,\r\nint phyreg, u16 phydata)\r\n{\r\nu32 reg;\r\nreg = ((phyreg >> 16) & 0x1f) << 21;\r\nreg |= (phyaddr << 16) | (phyreg & 0xffff);\r\nwritel(reg, sp->ioaddr + sp->hw->mii.addr);\r\nsxgbe_mdio_ctrl_data(sp, cmd, phydata);\r\n}\r\nstatic void sxgbe_mdio_c22(struct sxgbe_priv_data *sp, u32 cmd, int phyaddr,\r\nint phyreg, u16 phydata)\r\n{\r\nu32 reg;\r\nwritel(1 << phyaddr, sp->ioaddr + SXGBE_MDIO_CLAUSE22_PORT_REG);\r\nreg = (phyaddr << 16) | (phyreg & 0x1f);\r\nwritel(reg, sp->ioaddr + sp->hw->mii.addr);\r\nsxgbe_mdio_ctrl_data(sp, cmd, phydata);\r\n}\r\nstatic int sxgbe_mdio_access(struct sxgbe_priv_data *sp, u32 cmd, int phyaddr,\r\nint phyreg, u16 phydata)\r\n{\r\nconst struct mii_regs *mii = &sp->hw->mii;\r\nint rc;\r\nrc = sxgbe_mdio_busy_wait(sp->ioaddr, mii->data);\r\nif (rc < 0)\r\nreturn rc;\r\nif (phyreg & MII_ADDR_C45) {\r\nsxgbe_mdio_c45(sp, cmd, phyaddr, phyreg, phydata);\r\n} else {\r\nif (phyaddr >= 4)\r\nreturn -ENODEV;\r\nsxgbe_mdio_c22(sp, cmd, phyaddr, phyreg, phydata);\r\n}\r\nreturn sxgbe_mdio_busy_wait(sp->ioaddr, mii->data);\r\n}\r\nstatic int sxgbe_mdio_read(struct mii_bus *bus, int phyaddr, int phyreg)\r\n{\r\nstruct net_device *ndev = bus->priv;\r\nstruct sxgbe_priv_data *priv = netdev_priv(ndev);\r\nint rc;\r\nrc = sxgbe_mdio_access(priv, SXGBE_SMA_READ_CMD, phyaddr, phyreg, 0);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn readl(priv->ioaddr + priv->hw->mii.data) & 0xffff;\r\n}\r\nstatic int sxgbe_mdio_write(struct mii_bus *bus, int phyaddr, int phyreg,\r\nu16 phydata)\r\n{\r\nstruct net_device *ndev = bus->priv;\r\nstruct sxgbe_priv_data *priv = netdev_priv(ndev);\r\nreturn sxgbe_mdio_access(priv, SXGBE_SMA_WRITE_CMD, phyaddr, phyreg,\r\nphydata);\r\n}\r\nint sxgbe_mdio_register(struct net_device *ndev)\r\n{\r\nstruct mii_bus *mdio_bus;\r\nstruct sxgbe_priv_data *priv = netdev_priv(ndev);\r\nstruct sxgbe_mdio_bus_data *mdio_data = priv->plat->mdio_bus_data;\r\nint err, phy_addr;\r\nint *irqlist;\r\nbool phy_found = false;\r\nbool act;\r\nmdio_bus = mdiobus_alloc();\r\nif (!mdio_bus) {\r\nnetdev_err(ndev, "%s: mii bus allocation failed\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nif (mdio_data->irqs)\r\nirqlist = mdio_data->irqs;\r\nelse\r\nirqlist = priv->mii_irq;\r\nmdio_bus->name = "sxgbe";\r\nmdio_bus->read = &sxgbe_mdio_read;\r\nmdio_bus->write = &sxgbe_mdio_write;\r\nsnprintf(mdio_bus->id, MII_BUS_ID_SIZE, "%s-%x",\r\nmdio_bus->name, priv->plat->bus_id);\r\nmdio_bus->priv = ndev;\r\nmdio_bus->phy_mask = mdio_data->phy_mask;\r\nmdio_bus->parent = priv->device;\r\nerr = mdiobus_register(mdio_bus);\r\nif (err != 0) {\r\nnetdev_err(ndev, "mdiobus register failed\n");\r\ngoto mdiobus_err;\r\n}\r\nfor (phy_addr = 0; phy_addr < PHY_MAX_ADDR; phy_addr++) {\r\nstruct phy_device *phy = mdio_bus->phy_map[phy_addr];\r\nif (phy) {\r\nchar irq_num[4];\r\nchar *irq_str;\r\nif ((mdio_data->irqs == NULL) &&\r\n(mdio_data->probed_phy_irq > 0)) {\r\nirqlist[phy_addr] = mdio_data->probed_phy_irq;\r\nphy->irq = mdio_data->probed_phy_irq;\r\n}\r\nif (priv->plat->phy_addr == -1)\r\npriv->plat->phy_addr = phy_addr;\r\nact = (priv->plat->phy_addr == phy_addr);\r\nswitch (phy->irq) {\r\ncase PHY_POLL:\r\nirq_str = "POLL";\r\nbreak;\r\ncase PHY_IGNORE_INTERRUPT:\r\nirq_str = "IGNORE";\r\nbreak;\r\ndefault:\r\nsprintf(irq_num, "%d", phy->irq);\r\nirq_str = irq_num;\r\nbreak;\r\n}\r\nnetdev_info(ndev, "PHY ID %08x at %d IRQ %s (%s)%s\n",\r\nphy->phy_id, phy_addr, irq_str,\r\ndev_name(&phy->dev), act ? " active" : "");\r\nphy_found = true;\r\n}\r\n}\r\nif (!phy_found) {\r\nnetdev_err(ndev, "PHY not found\n");\r\ngoto phyfound_err;\r\n}\r\npriv->mii = mdio_bus;\r\nreturn 0;\r\nphyfound_err:\r\nerr = -ENODEV;\r\nmdiobus_unregister(mdio_bus);\r\nmdiobus_err:\r\nmdiobus_free(mdio_bus);\r\nreturn err;\r\n}\r\nint sxgbe_mdio_unregister(struct net_device *ndev)\r\n{\r\nstruct sxgbe_priv_data *priv = netdev_priv(ndev);\r\nif (!priv->mii)\r\nreturn 0;\r\nmdiobus_unregister(priv->mii);\r\npriv->mii->priv = NULL;\r\nmdiobus_free(priv->mii);\r\npriv->mii = NULL;\r\nreturn 0;\r\n}

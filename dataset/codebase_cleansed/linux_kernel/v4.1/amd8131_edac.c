static void edac_pci_read_dword(struct pci_dev *dev, int reg, u32 *val32)\r\n{\r\nint ret;\r\nret = pci_read_config_dword(dev, reg, val32);\r\nif (ret != 0)\r\nprintk(KERN_ERR AMD8131_EDAC_MOD_STR\r\n" PCI Access Read Error at 0x%x\n", reg);\r\n}\r\nstatic void edac_pci_write_dword(struct pci_dev *dev, int reg, u32 val32)\r\n{\r\nint ret;\r\nret = pci_write_config_dword(dev, reg, val32);\r\nif (ret != 0)\r\nprintk(KERN_ERR AMD8131_EDAC_MOD_STR\r\n" PCI Access Write Error at 0x%x\n", reg);\r\n}\r\nstatic void amd8131_pcix_init(struct amd8131_dev_info *dev_info)\r\n{\r\nu32 val32;\r\nstruct pci_dev *dev = dev_info->dev;\r\nedac_pci_read_dword(dev, REG_MEM_LIM, &val32);\r\nif (val32 & MEM_LIMIT_MASK)\r\nedac_pci_write_dword(dev, REG_MEM_LIM, val32);\r\nedac_pci_read_dword(dev, REG_INT_CTLR, &val32);\r\nif (val32 & INT_CTLR_DTS)\r\nedac_pci_write_dword(dev, REG_INT_CTLR, val32);\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_A, &val32);\r\nif (val32 & LNK_CTRL_CRCERR_A)\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_A, val32);\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_B, &val32);\r\nif (val32 & LNK_CTRL_CRCERR_B)\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_B, val32);\r\nedac_pci_read_dword(dev, REG_INT_CTLR, &val32);\r\nval32 |= INT_CTLR_PERR | INT_CTLR_SERR | INT_CTLR_DTSE;\r\nedac_pci_write_dword(dev, REG_INT_CTLR, val32);\r\nedac_pci_read_dword(dev, REG_STS_CMD, &val32);\r\nval32 |= STS_CMD_SERREN;\r\nedac_pci_write_dword(dev, REG_STS_CMD, val32);\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_A, &val32);\r\nval32 |= LNK_CTRL_CRCFEN;\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_A, val32);\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_B, &val32);\r\nval32 |= LNK_CTRL_CRCFEN;\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_B, val32);\r\n}\r\nstatic void amd8131_pcix_exit(struct amd8131_dev_info *dev_info)\r\n{\r\nu32 val32;\r\nstruct pci_dev *dev = dev_info->dev;\r\nedac_pci_read_dword(dev, REG_INT_CTLR, &val32);\r\nval32 &= ~(INT_CTLR_PERR | INT_CTLR_SERR | INT_CTLR_DTSE);\r\nedac_pci_write_dword(dev, REG_INT_CTLR, val32);\r\nedac_pci_read_dword(dev, REG_STS_CMD, &val32);\r\nval32 &= ~STS_CMD_SERREN;\r\nedac_pci_write_dword(dev, REG_STS_CMD, val32);\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_A, &val32);\r\nval32 &= ~LNK_CTRL_CRCFEN;\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_A, val32);\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_B, &val32);\r\nval32 &= ~LNK_CTRL_CRCFEN;\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_B, val32);\r\n}\r\nstatic void amd8131_pcix_check(struct edac_pci_ctl_info *edac_dev)\r\n{\r\nstruct amd8131_dev_info *dev_info = edac_dev->pvt_info;\r\nstruct pci_dev *dev = dev_info->dev;\r\nu32 val32;\r\nedac_pci_read_dword(dev, REG_MEM_LIM, &val32);\r\nif (val32 & MEM_LIMIT_MASK) {\r\nprintk(KERN_INFO "Error(s) in mem limit register "\r\n"on %s bridge\n", dev_info->ctl_name);\r\nprintk(KERN_INFO "DPE: %d, RSE: %d, RMA: %d\n"\r\n"RTA: %d, STA: %d, MDPE: %d\n",\r\nval32 & MEM_LIMIT_DPE,\r\nval32 & MEM_LIMIT_RSE,\r\nval32 & MEM_LIMIT_RMA,\r\nval32 & MEM_LIMIT_RTA,\r\nval32 & MEM_LIMIT_STA,\r\nval32 & MEM_LIMIT_MDPE);\r\nval32 |= MEM_LIMIT_MASK;\r\nedac_pci_write_dword(dev, REG_MEM_LIM, val32);\r\nedac_pci_handle_npe(edac_dev, edac_dev->ctl_name);\r\n}\r\nedac_pci_read_dword(dev, REG_INT_CTLR, &val32);\r\nif (val32 & INT_CTLR_DTS) {\r\nprintk(KERN_INFO "Error(s) in interrupt and control register "\r\n"on %s bridge\n", dev_info->ctl_name);\r\nprintk(KERN_INFO "DTS: %d\n", val32 & INT_CTLR_DTS);\r\nval32 |= INT_CTLR_DTS;\r\nedac_pci_write_dword(dev, REG_INT_CTLR, val32);\r\nedac_pci_handle_npe(edac_dev, edac_dev->ctl_name);\r\n}\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_A, &val32);\r\nif (val32 & LNK_CTRL_CRCERR_A) {\r\nprintk(KERN_INFO "Error(s) in link conf and control register "\r\n"on %s bridge\n", dev_info->ctl_name);\r\nprintk(KERN_INFO "CRCERR: %d\n", val32 & LNK_CTRL_CRCERR_A);\r\nval32 |= LNK_CTRL_CRCERR_A;\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_A, val32);\r\nedac_pci_handle_npe(edac_dev, edac_dev->ctl_name);\r\n}\r\nedac_pci_read_dword(dev, REG_LNK_CTRL_B, &val32);\r\nif (val32 & LNK_CTRL_CRCERR_B) {\r\nprintk(KERN_INFO "Error(s) in link conf and control register "\r\n"on %s bridge\n", dev_info->ctl_name);\r\nprintk(KERN_INFO "CRCERR: %d\n", val32 & LNK_CTRL_CRCERR_B);\r\nval32 |= LNK_CTRL_CRCERR_B;\r\nedac_pci_write_dword(dev, REG_LNK_CTRL_B, val32);\r\nedac_pci_handle_npe(edac_dev, edac_dev->ctl_name);\r\n}\r\n}\r\nstatic int amd8131_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct amd8131_dev_info *dev_info;\r\nfor (dev_info = amd8131_chipset.devices; dev_info->inst != NO_BRIDGE;\r\ndev_info++)\r\nif (dev_info->devfn == dev->devfn)\r\nbreak;\r\nif (dev_info->inst == NO_BRIDGE)\r\nreturn -ENODEV;\r\ndev_info->dev = pci_dev_get(dev);\r\nif (pci_enable_device(dev_info->dev)) {\r\npci_dev_put(dev_info->dev);\r\nprintk(KERN_ERR "failed to enable:"\r\n"vendor %x, device %x, devfn %x, name %s\n",\r\nPCI_VENDOR_ID_AMD, amd8131_chipset.err_dev,\r\ndev_info->devfn, dev_info->ctl_name);\r\nreturn -ENODEV;\r\n}\r\ndev_info->edac_idx = edac_pci_alloc_index();\r\ndev_info->edac_dev = edac_pci_alloc_ctl_info(0, dev_info->ctl_name);\r\nif (!dev_info->edac_dev)\r\nreturn -ENOMEM;\r\ndev_info->edac_dev->pvt_info = dev_info;\r\ndev_info->edac_dev->dev = &dev_info->dev->dev;\r\ndev_info->edac_dev->mod_name = AMD8131_EDAC_MOD_STR;\r\ndev_info->edac_dev->ctl_name = dev_info->ctl_name;\r\ndev_info->edac_dev->dev_name = dev_name(&dev_info->dev->dev);\r\nif (edac_op_state == EDAC_OPSTATE_POLL)\r\ndev_info->edac_dev->edac_check = amd8131_chipset.check;\r\nif (amd8131_chipset.init)\r\namd8131_chipset.init(dev_info);\r\nif (edac_pci_add_device(dev_info->edac_dev, dev_info->edac_idx) > 0) {\r\nprintk(KERN_ERR "failed edac_pci_add_device() for %s\n",\r\ndev_info->ctl_name);\r\nedac_pci_free_ctl_info(dev_info->edac_dev);\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_INFO "added one device on AMD8131 "\r\n"vendor %x, device %x, devfn %x, name %s\n",\r\nPCI_VENDOR_ID_AMD, amd8131_chipset.err_dev,\r\ndev_info->devfn, dev_info->ctl_name);\r\nreturn 0;\r\n}\r\nstatic void amd8131_remove(struct pci_dev *dev)\r\n{\r\nstruct amd8131_dev_info *dev_info;\r\nfor (dev_info = amd8131_chipset.devices; dev_info->inst != NO_BRIDGE;\r\ndev_info++)\r\nif (dev_info->devfn == dev->devfn)\r\nbreak;\r\nif (dev_info->inst == NO_BRIDGE)\r\nreturn;\r\nif (dev_info->edac_dev) {\r\nedac_pci_del_device(dev_info->edac_dev->dev);\r\nedac_pci_free_ctl_info(dev_info->edac_dev);\r\n}\r\nif (amd8131_chipset.exit)\r\namd8131_chipset.exit(dev_info);\r\npci_dev_put(dev_info->dev);\r\n}\r\nstatic int __init amd8131_edac_init(void)\r\n{\r\nprintk(KERN_INFO "AMD8131 EDAC driver " AMD8131_EDAC_REVISION "\n");\r\nprintk(KERN_INFO "\t(c) 2008 Wind River Systems, Inc.\n");\r\nedac_op_state = EDAC_OPSTATE_POLL;\r\nreturn pci_register_driver(&amd8131_edac_driver);\r\n}\r\nstatic void __exit amd8131_edac_exit(void)\r\n{\r\npci_unregister_driver(&amd8131_edac_driver);\r\n}

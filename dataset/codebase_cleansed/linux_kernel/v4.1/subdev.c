struct nvkm_subdev *\r\nnvkm_subdev(void *obj, int idx)\r\n{\r\nstruct nvkm_object *object = nv_object(obj);\r\nwhile (object && !nv_iclass(object, NV_SUBDEV_CLASS))\r\nobject = object->parent;\r\nif (object == NULL || nv_subidx(nv_subdev(object)) != idx)\r\nobject = nv_device(obj)->subdev[idx];\r\nreturn object ? nv_subdev(object) : NULL;\r\n}\r\nvoid\r\nnvkm_subdev_reset(struct nvkm_object *subdev)\r\n{\r\nnv_trace(subdev, "resetting...\n");\r\nnv_ofuncs(subdev)->fini(subdev, false);\r\nnv_debug(subdev, "reset\n");\r\n}\r\nint\r\nnvkm_subdev_init(struct nvkm_subdev *subdev)\r\n{\r\nint ret = nvkm_object_init(&subdev->object);\r\nif (ret)\r\nreturn ret;\r\nnvkm_subdev_reset(&subdev->object);\r\nreturn 0;\r\n}\r\nint\r\n_nvkm_subdev_init(struct nvkm_object *object)\r\n{\r\nreturn nvkm_subdev_init(nv_subdev(object));\r\n}\r\nint\r\nnvkm_subdev_fini(struct nvkm_subdev *subdev, bool suspend)\r\n{\r\nif (subdev->unit) {\r\nnv_mask(subdev, 0x000200, subdev->unit, 0x00000000);\r\nnv_mask(subdev, 0x000200, subdev->unit, subdev->unit);\r\n}\r\nreturn nvkm_object_fini(&subdev->object, suspend);\r\n}\r\nint\r\n_nvkm_subdev_fini(struct nvkm_object *object, bool suspend)\r\n{\r\nreturn nvkm_subdev_fini(nv_subdev(object), suspend);\r\n}\r\nvoid\r\nnvkm_subdev_destroy(struct nvkm_subdev *subdev)\r\n{\r\nint subidx = nv_hclass(subdev) & 0xff;\r\nnv_device(subdev)->subdev[subidx] = NULL;\r\nnvkm_object_destroy(&subdev->object);\r\n}\r\nvoid\r\n_nvkm_subdev_dtor(struct nvkm_object *object)\r\n{\r\nnvkm_subdev_destroy(nv_subdev(object));\r\n}\r\nint\r\nnvkm_subdev_create_(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, u32 pclass,\r\nconst char *subname, const char *sysname,\r\nint size, void **pobject)\r\n{\r\nstruct nvkm_subdev *subdev;\r\nint ret;\r\nret = nvkm_object_create_(parent, engine, oclass, pclass |\r\nNV_SUBDEV_CLASS, size, pobject);\r\nsubdev = *pobject;\r\nif (ret)\r\nreturn ret;\r\n__mutex_init(&subdev->mutex, subname, &oclass->lock_class_key);\r\nsubdev->name = subname;\r\nif (parent) {\r\nstruct nvkm_device *device = nv_device(parent);\r\nsubdev->debug = nvkm_dbgopt(device->dbgopt, subname);\r\nsubdev->mmio = nv_subdev(device)->mmio;\r\n}\r\nreturn 0;\r\n}

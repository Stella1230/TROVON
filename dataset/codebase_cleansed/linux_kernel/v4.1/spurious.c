bool irq_wait_for_poll(struct irq_desc *desc)\r\n{\r\nif (WARN_ONCE(irq_poll_cpu == smp_processor_id(),\r\n"irq poll in progress on cpu %d for irq %d\n",\r\nsmp_processor_id(), desc->irq_data.irq))\r\nreturn false;\r\n#ifdef CONFIG_SMP\r\ndo {\r\nraw_spin_unlock(&desc->lock);\r\nwhile (irqd_irq_inprogress(&desc->irq_data))\r\ncpu_relax();\r\nraw_spin_lock(&desc->lock);\r\n} while (irqd_irq_inprogress(&desc->irq_data));\r\nreturn !irqd_irq_disabled(&desc->irq_data) && desc->action;\r\n#else\r\nreturn false;\r\n#endif\r\n}\r\nstatic int try_one_irq(int irq, struct irq_desc *desc, bool force)\r\n{\r\nirqreturn_t ret = IRQ_NONE;\r\nstruct irqaction *action;\r\nraw_spin_lock(&desc->lock);\r\nif (irq_settings_is_per_cpu(desc) ||\r\nirq_settings_is_nested_thread(desc) ||\r\nirq_settings_is_polled(desc))\r\ngoto out;\r\nif (irqd_irq_disabled(&desc->irq_data) && !force)\r\ngoto out;\r\naction = desc->action;\r\nif (!action || !(action->flags & IRQF_SHARED) ||\r\n(action->flags & __IRQF_TIMER))\r\ngoto out;\r\nif (irqd_irq_inprogress(&desc->irq_data)) {\r\ndesc->istate |= IRQS_PENDING;\r\ngoto out;\r\n}\r\ndesc->istate |= IRQS_POLL_INPROGRESS;\r\ndo {\r\nif (handle_irq_event(desc) == IRQ_HANDLED)\r\nret = IRQ_HANDLED;\r\naction = desc->action;\r\n} while ((desc->istate & IRQS_PENDING) && action);\r\ndesc->istate &= ~IRQS_POLL_INPROGRESS;\r\nout:\r\nraw_spin_unlock(&desc->lock);\r\nreturn ret == IRQ_HANDLED;\r\n}\r\nstatic int misrouted_irq(int irq)\r\n{\r\nstruct irq_desc *desc;\r\nint i, ok = 0;\r\nif (atomic_inc_return(&irq_poll_active) != 1)\r\ngoto out;\r\nirq_poll_cpu = smp_processor_id();\r\nfor_each_irq_desc(i, desc) {\r\nif (!i)\r\ncontinue;\r\nif (i == irq)\r\ncontinue;\r\nif (try_one_irq(i, desc, false))\r\nok = 1;\r\n}\r\nout:\r\natomic_dec(&irq_poll_active);\r\nreturn ok;\r\n}\r\nstatic void poll_spurious_irqs(unsigned long dummy)\r\n{\r\nstruct irq_desc *desc;\r\nint i;\r\nif (atomic_inc_return(&irq_poll_active) != 1)\r\ngoto out;\r\nirq_poll_cpu = smp_processor_id();\r\nfor_each_irq_desc(i, desc) {\r\nunsigned int state;\r\nif (!i)\r\ncontinue;\r\nstate = desc->istate;\r\nbarrier();\r\nif (!(state & IRQS_SPURIOUS_DISABLED))\r\ncontinue;\r\nlocal_irq_disable();\r\ntry_one_irq(i, desc, true);\r\nlocal_irq_enable();\r\n}\r\nout:\r\natomic_dec(&irq_poll_active);\r\nmod_timer(&poll_spurious_irq_timer,\r\njiffies + POLL_SPURIOUS_IRQ_INTERVAL);\r\n}\r\nstatic inline int bad_action_ret(irqreturn_t action_ret)\r\n{\r\nif (likely(action_ret <= (IRQ_HANDLED | IRQ_WAKE_THREAD)))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void\r\n__report_bad_irq(unsigned int irq, struct irq_desc *desc,\r\nirqreturn_t action_ret)\r\n{\r\nstruct irqaction *action;\r\nunsigned long flags;\r\nif (bad_action_ret(action_ret)) {\r\nprintk(KERN_ERR "irq event %d: bogus return value %x\n",\r\nirq, action_ret);\r\n} else {\r\nprintk(KERN_ERR "irq %d: nobody cared (try booting with "\r\n"the \"irqpoll\" option)\n", irq);\r\n}\r\ndump_stack();\r\nprintk(KERN_ERR "handlers:\n");\r\nraw_spin_lock_irqsave(&desc->lock, flags);\r\naction = desc->action;\r\nwhile (action) {\r\nprintk(KERN_ERR "[<%p>] %pf", action->handler, action->handler);\r\nif (action->thread_fn)\r\nprintk(KERN_CONT " threaded [<%p>] %pf",\r\naction->thread_fn, action->thread_fn);\r\nprintk(KERN_CONT "\n");\r\naction = action->next;\r\n}\r\nraw_spin_unlock_irqrestore(&desc->lock, flags);\r\n}\r\nstatic void\r\nreport_bad_irq(unsigned int irq, struct irq_desc *desc, irqreturn_t action_ret)\r\n{\r\nstatic int count = 100;\r\nif (count > 0) {\r\ncount--;\r\n__report_bad_irq(irq, desc, action_ret);\r\n}\r\n}\r\nstatic inline int\r\ntry_misrouted_irq(unsigned int irq, struct irq_desc *desc,\r\nirqreturn_t action_ret)\r\n{\r\nstruct irqaction *action;\r\nif (!irqfixup)\r\nreturn 0;\r\nif (action_ret == IRQ_NONE)\r\nreturn 1;\r\nif (irqfixup < 2)\r\nreturn 0;\r\nif (!irq)\r\nreturn 1;\r\naction = desc->action;\r\nbarrier();\r\nreturn action && (action->flags & IRQF_IRQPOLL);\r\n}\r\nvoid note_interrupt(unsigned int irq, struct irq_desc *desc,\r\nirqreturn_t action_ret)\r\n{\r\nif (desc->istate & IRQS_POLL_INPROGRESS ||\r\nirq_settings_is_polled(desc))\r\nreturn;\r\nif (bad_action_ret(action_ret)) {\r\nreport_bad_irq(irq, desc, action_ret);\r\nreturn;\r\n}\r\nif (action_ret & IRQ_WAKE_THREAD) {\r\nif (action_ret == IRQ_WAKE_THREAD) {\r\nint handled;\r\nif (!(desc->threads_handled_last & SPURIOUS_DEFERRED)) {\r\ndesc->threads_handled_last |= SPURIOUS_DEFERRED;\r\nreturn;\r\n}\r\nhandled = atomic_read(&desc->threads_handled);\r\nhandled |= SPURIOUS_DEFERRED;\r\nif (handled != desc->threads_handled_last) {\r\naction_ret = IRQ_HANDLED;\r\ndesc->threads_handled_last = handled;\r\n} else {\r\naction_ret = IRQ_NONE;\r\n}\r\n} else {\r\ndesc->threads_handled_last &= ~SPURIOUS_DEFERRED;\r\n}\r\n}\r\nif (unlikely(action_ret == IRQ_NONE)) {\r\nif (time_after(jiffies, desc->last_unhandled + HZ/10))\r\ndesc->irqs_unhandled = 1;\r\nelse\r\ndesc->irqs_unhandled++;\r\ndesc->last_unhandled = jiffies;\r\n}\r\nif (unlikely(try_misrouted_irq(irq, desc, action_ret))) {\r\nint ok = misrouted_irq(irq);\r\nif (action_ret == IRQ_NONE)\r\ndesc->irqs_unhandled -= ok;\r\n}\r\ndesc->irq_count++;\r\nif (likely(desc->irq_count < 100000))\r\nreturn;\r\ndesc->irq_count = 0;\r\nif (unlikely(desc->irqs_unhandled > 99900)) {\r\n__report_bad_irq(irq, desc, action_ret);\r\nprintk(KERN_EMERG "Disabling IRQ #%d\n", irq);\r\ndesc->istate |= IRQS_SPURIOUS_DISABLED;\r\ndesc->depth++;\r\nirq_disable(desc);\r\nmod_timer(&poll_spurious_irq_timer,\r\njiffies + POLL_SPURIOUS_IRQ_INTERVAL);\r\n}\r\ndesc->irqs_unhandled = 0;\r\n}\r\nint noirqdebug_setup(char *str)\r\n{\r\nnoirqdebug = 1;\r\nprintk(KERN_INFO "IRQ lockup detection disabled\n");\r\nreturn 1;\r\n}\r\nstatic int __init irqfixup_setup(char *str)\r\n{\r\nirqfixup = 1;\r\nprintk(KERN_WARNING "Misrouted IRQ fixup support enabled.\n");\r\nprintk(KERN_WARNING "This may impact system performance.\n");\r\nreturn 1;\r\n}\r\nstatic int __init irqpoll_setup(char *str)\r\n{\r\nirqfixup = 2;\r\nprintk(KERN_WARNING "Misrouted IRQ fixup and polling support "\r\n"enabled\n");\r\nprintk(KERN_WARNING "This may significantly impact system "\r\n"performance\n");\r\nreturn 1;\r\n}

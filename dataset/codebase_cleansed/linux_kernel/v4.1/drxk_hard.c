static bool is_dvbt(struct drxk_state *state)\r\n{\r\nreturn state->m_operation_mode == OM_DVBT;\r\n}\r\nstatic bool is_qam(struct drxk_state *state)\r\n{\r\nreturn state->m_operation_mode == OM_QAM_ITU_A ||\r\nstate->m_operation_mode == OM_QAM_ITU_B ||\r\nstate->m_operation_mode == OM_QAM_ITU_C;\r\n}\r\nstatic inline u32 MulDiv32(u32 a, u32 b, u32 c)\r\n{\r\nu64 tmp64;\r\ntmp64 = (u64) a * (u64) b;\r\ndo_div(tmp64, c);\r\nreturn (u32) tmp64;\r\n}\r\nstatic inline u32 Frac28a(u32 a, u32 c)\r\n{\r\nint i = 0;\r\nu32 Q1 = 0;\r\nu32 R0 = 0;\r\nR0 = (a % c) << 4;\r\nQ1 = a / c;\r\nfor (i = 0; i < 7; i++) {\r\nQ1 = (Q1 << 4) | (R0 / c);\r\nR0 = (R0 % c) << 4;\r\n}\r\nif ((R0 >> 3) >= c)\r\nQ1++;\r\nreturn Q1;\r\n}\r\nstatic inline u32 log10times100(u32 value)\r\n{\r\nreturn (100L * intlog10(value)) >> 24;\r\n}\r\nstatic int drxk_i2c_lock(struct drxk_state *state)\r\n{\r\ni2c_lock_adapter(state->i2c);\r\nstate->drxk_i2c_exclusive_lock = true;\r\nreturn 0;\r\n}\r\nstatic void drxk_i2c_unlock(struct drxk_state *state)\r\n{\r\nif (!state->drxk_i2c_exclusive_lock)\r\nreturn;\r\ni2c_unlock_adapter(state->i2c);\r\nstate->drxk_i2c_exclusive_lock = false;\r\n}\r\nstatic int drxk_i2c_transfer(struct drxk_state *state, struct i2c_msg *msgs,\r\nunsigned len)\r\n{\r\nif (state->drxk_i2c_exclusive_lock)\r\nreturn __i2c_transfer(state->i2c, msgs, len);\r\nelse\r\nreturn i2c_transfer(state->i2c, msgs, len);\r\n}\r\nstatic int i2c_read1(struct drxk_state *state, u8 adr, u8 *val)\r\n{\r\nstruct i2c_msg msgs[1] = { {.addr = adr, .flags = I2C_M_RD,\r\n.buf = val, .len = 1}\r\n};\r\nreturn drxk_i2c_transfer(state, msgs, 1);\r\n}\r\nstatic int i2c_write(struct drxk_state *state, u8 adr, u8 *data, int len)\r\n{\r\nint status;\r\nstruct i2c_msg msg = {\r\n.addr = adr, .flags = 0, .buf = data, .len = len };\r\ndprintk(3, ":");\r\nif (debug > 2) {\r\nint i;\r\nfor (i = 0; i < len; i++)\r\npr_cont(" %02x", data[i]);\r\npr_cont("\n");\r\n}\r\nstatus = drxk_i2c_transfer(state, &msg, 1);\r\nif (status >= 0 && status != 1)\r\nstatus = -EIO;\r\nif (status < 0)\r\npr_err("i2c write error at addr 0x%02x\n", adr);\r\nreturn status;\r\n}\r\nstatic int i2c_read(struct drxk_state *state,\r\nu8 adr, u8 *msg, int len, u8 *answ, int alen)\r\n{\r\nint status;\r\nstruct i2c_msg msgs[2] = {\r\n{.addr = adr, .flags = 0,\r\n.buf = msg, .len = len},\r\n{.addr = adr, .flags = I2C_M_RD,\r\n.buf = answ, .len = alen}\r\n};\r\nstatus = drxk_i2c_transfer(state, msgs, 2);\r\nif (status != 2) {\r\nif (debug > 2)\r\npr_cont(": ERROR!\n");\r\nif (status >= 0)\r\nstatus = -EIO;\r\npr_err("i2c read error at addr 0x%02x\n", adr);\r\nreturn status;\r\n}\r\nif (debug > 2) {\r\nint i;\r\ndprintk(2, ": read from");\r\nfor (i = 0; i < len; i++)\r\npr_cont(" %02x", msg[i]);\r\npr_cont(", value = ");\r\nfor (i = 0; i < alen; i++)\r\npr_cont(" %02x", answ[i]);\r\npr_cont("\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int read16_flags(struct drxk_state *state, u32 reg, u16 *data, u8 flags)\r\n{\r\nint status;\r\nu8 adr = state->demod_address, mm1[4], mm2[2], len;\r\nif (state->single_master)\r\nflags |= 0xC0;\r\nif (DRXDAP_FASI_LONG_FORMAT(reg) || (flags != 0)) {\r\nmm1[0] = (((reg << 1) & 0xFF) | 0x01);\r\nmm1[1] = ((reg >> 16) & 0xFF);\r\nmm1[2] = ((reg >> 24) & 0xFF) | flags;\r\nmm1[3] = ((reg >> 7) & 0xFF);\r\nlen = 4;\r\n} else {\r\nmm1[0] = ((reg << 1) & 0xFF);\r\nmm1[1] = (((reg >> 16) & 0x0F) | ((reg >> 18) & 0xF0));\r\nlen = 2;\r\n}\r\ndprintk(2, "(0x%08x, 0x%02x)\n", reg, flags);\r\nstatus = i2c_read(state, adr, mm1, len, mm2, 2);\r\nif (status < 0)\r\nreturn status;\r\nif (data)\r\n*data = mm2[0] | (mm2[1] << 8);\r\nreturn 0;\r\n}\r\nstatic int read16(struct drxk_state *state, u32 reg, u16 *data)\r\n{\r\nreturn read16_flags(state, reg, data, 0);\r\n}\r\nstatic int read32_flags(struct drxk_state *state, u32 reg, u32 *data, u8 flags)\r\n{\r\nint status;\r\nu8 adr = state->demod_address, mm1[4], mm2[4], len;\r\nif (state->single_master)\r\nflags |= 0xC0;\r\nif (DRXDAP_FASI_LONG_FORMAT(reg) || (flags != 0)) {\r\nmm1[0] = (((reg << 1) & 0xFF) | 0x01);\r\nmm1[1] = ((reg >> 16) & 0xFF);\r\nmm1[2] = ((reg >> 24) & 0xFF) | flags;\r\nmm1[3] = ((reg >> 7) & 0xFF);\r\nlen = 4;\r\n} else {\r\nmm1[0] = ((reg << 1) & 0xFF);\r\nmm1[1] = (((reg >> 16) & 0x0F) | ((reg >> 18) & 0xF0));\r\nlen = 2;\r\n}\r\ndprintk(2, "(0x%08x, 0x%02x)\n", reg, flags);\r\nstatus = i2c_read(state, adr, mm1, len, mm2, 4);\r\nif (status < 0)\r\nreturn status;\r\nif (data)\r\n*data = mm2[0] | (mm2[1] << 8) |\r\n(mm2[2] << 16) | (mm2[3] << 24);\r\nreturn 0;\r\n}\r\nstatic int read32(struct drxk_state *state, u32 reg, u32 *data)\r\n{\r\nreturn read32_flags(state, reg, data, 0);\r\n}\r\nstatic int write16_flags(struct drxk_state *state, u32 reg, u16 data, u8 flags)\r\n{\r\nu8 adr = state->demod_address, mm[6], len;\r\nif (state->single_master)\r\nflags |= 0xC0;\r\nif (DRXDAP_FASI_LONG_FORMAT(reg) || (flags != 0)) {\r\nmm[0] = (((reg << 1) & 0xFF) | 0x01);\r\nmm[1] = ((reg >> 16) & 0xFF);\r\nmm[2] = ((reg >> 24) & 0xFF) | flags;\r\nmm[3] = ((reg >> 7) & 0xFF);\r\nlen = 4;\r\n} else {\r\nmm[0] = ((reg << 1) & 0xFF);\r\nmm[1] = (((reg >> 16) & 0x0F) | ((reg >> 18) & 0xF0));\r\nlen = 2;\r\n}\r\nmm[len] = data & 0xff;\r\nmm[len + 1] = (data >> 8) & 0xff;\r\ndprintk(2, "(0x%08x, 0x%04x, 0x%02x)\n", reg, data, flags);\r\nreturn i2c_write(state, adr, mm, len + 2);\r\n}\r\nstatic int write16(struct drxk_state *state, u32 reg, u16 data)\r\n{\r\nreturn write16_flags(state, reg, data, 0);\r\n}\r\nstatic int write32_flags(struct drxk_state *state, u32 reg, u32 data, u8 flags)\r\n{\r\nu8 adr = state->demod_address, mm[8], len;\r\nif (state->single_master)\r\nflags |= 0xC0;\r\nif (DRXDAP_FASI_LONG_FORMAT(reg) || (flags != 0)) {\r\nmm[0] = (((reg << 1) & 0xFF) | 0x01);\r\nmm[1] = ((reg >> 16) & 0xFF);\r\nmm[2] = ((reg >> 24) & 0xFF) | flags;\r\nmm[3] = ((reg >> 7) & 0xFF);\r\nlen = 4;\r\n} else {\r\nmm[0] = ((reg << 1) & 0xFF);\r\nmm[1] = (((reg >> 16) & 0x0F) | ((reg >> 18) & 0xF0));\r\nlen = 2;\r\n}\r\nmm[len] = data & 0xff;\r\nmm[len + 1] = (data >> 8) & 0xff;\r\nmm[len + 2] = (data >> 16) & 0xff;\r\nmm[len + 3] = (data >> 24) & 0xff;\r\ndprintk(2, "(0x%08x, 0x%08x, 0x%02x)\n", reg, data, flags);\r\nreturn i2c_write(state, adr, mm, len + 4);\r\n}\r\nstatic int write32(struct drxk_state *state, u32 reg, u32 data)\r\n{\r\nreturn write32_flags(state, reg, data, 0);\r\n}\r\nstatic int write_block(struct drxk_state *state, u32 address,\r\nconst int block_size, const u8 p_block[])\r\n{\r\nint status = 0, blk_size = block_size;\r\nu8 flags = 0;\r\nif (state->single_master)\r\nflags |= 0xC0;\r\nwhile (blk_size > 0) {\r\nint chunk = blk_size > state->m_chunk_size ?\r\nstate->m_chunk_size : blk_size;\r\nu8 *adr_buf = &state->chunk[0];\r\nu32 adr_length = 0;\r\nif (DRXDAP_FASI_LONG_FORMAT(address) || (flags != 0)) {\r\nadr_buf[0] = (((address << 1) & 0xFF) | 0x01);\r\nadr_buf[1] = ((address >> 16) & 0xFF);\r\nadr_buf[2] = ((address >> 24) & 0xFF);\r\nadr_buf[3] = ((address >> 7) & 0xFF);\r\nadr_buf[2] |= flags;\r\nadr_length = 4;\r\nif (chunk == state->m_chunk_size)\r\nchunk -= 2;\r\n} else {\r\nadr_buf[0] = ((address << 1) & 0xFF);\r\nadr_buf[1] = (((address >> 16) & 0x0F) |\r\n((address >> 18) & 0xF0));\r\nadr_length = 2;\r\n}\r\nmemcpy(&state->chunk[adr_length], p_block, chunk);\r\ndprintk(2, "(0x%08x, 0x%02x)\n", address, flags);\r\nif (debug > 1) {\r\nint i;\r\nif (p_block)\r\nfor (i = 0; i < chunk; i++)\r\npr_cont(" %02x", p_block[i]);\r\npr_cont("\n");\r\n}\r\nstatus = i2c_write(state, state->demod_address,\r\n&state->chunk[0], chunk + adr_length);\r\nif (status < 0) {\r\npr_err("%s: i2c write error at addr 0x%02x\n",\r\n__func__, address);\r\nbreak;\r\n}\r\np_block += chunk;\r\naddress += (chunk >> 1);\r\nblk_size -= chunk;\r\n}\r\nreturn status;\r\n}\r\nstatic int power_up_device(struct drxk_state *state)\r\n{\r\nint status;\r\nu8 data = 0;\r\nu16 retry_count = 0;\r\ndprintk(1, "\n");\r\nstatus = i2c_read1(state, state->demod_address, &data);\r\nif (status < 0) {\r\ndo {\r\ndata = 0;\r\nstatus = i2c_write(state, state->demod_address,\r\n&data, 1);\r\nusleep_range(10000, 11000);\r\nretry_count++;\r\nif (status < 0)\r\ncontinue;\r\nstatus = i2c_read1(state, state->demod_address,\r\n&data);\r\n} while (status < 0 &&\r\n(retry_count < DRXK_MAX_RETRIES_POWERUP));\r\nif (status < 0 && retry_count >= DRXK_MAX_RETRIES_POWERUP)\r\ngoto error;\r\n}\r\nstatus = write16(state, SIO_CC_PWD_MODE__A, SIO_CC_PWD_MODE_LEVEL_NONE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_PLL_LOCK__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_current_power_mode = DRX_POWER_UP;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int init_state(struct drxk_state *state)\r\n{\r\nu32 ul_vsb_if_agc_mode = DRXK_AGC_CTRL_AUTO;\r\nu32 ul_vsb_if_agc_output_level = 0;\r\nu32 ul_vsb_if_agc_min_level = 0;\r\nu32 ul_vsb_if_agc_max_level = 0x7FFF;\r\nu32 ul_vsb_if_agc_speed = 3;\r\nu32 ul_vsb_rf_agc_mode = DRXK_AGC_CTRL_AUTO;\r\nu32 ul_vsb_rf_agc_output_level = 0;\r\nu32 ul_vsb_rf_agc_min_level = 0;\r\nu32 ul_vsb_rf_agc_max_level = 0x7FFF;\r\nu32 ul_vsb_rf_agc_speed = 3;\r\nu32 ul_vsb_rf_agc_top = 9500;\r\nu32 ul_vsb_rf_agc_cut_off_current = 4000;\r\nu32 ul_atv_if_agc_mode = DRXK_AGC_CTRL_AUTO;\r\nu32 ul_atv_if_agc_output_level = 0;\r\nu32 ul_atv_if_agc_min_level = 0;\r\nu32 ul_atv_if_agc_max_level = 0;\r\nu32 ul_atv_if_agc_speed = 3;\r\nu32 ul_atv_rf_agc_mode = DRXK_AGC_CTRL_OFF;\r\nu32 ul_atv_rf_agc_output_level = 0;\r\nu32 ul_atv_rf_agc_min_level = 0;\r\nu32 ul_atv_rf_agc_max_level = 0;\r\nu32 ul_atv_rf_agc_top = 9500;\r\nu32 ul_atv_rf_agc_cut_off_current = 4000;\r\nu32 ul_atv_rf_agc_speed = 3;\r\nu32 ulQual83 = DEFAULT_MER_83;\r\nu32 ulQual93 = DEFAULT_MER_93;\r\nu32 ul_mpeg_lock_time_out = DEFAULT_DRXK_MPEG_LOCK_TIMEOUT;\r\nu32 ul_demod_lock_time_out = DEFAULT_DRXK_DEMOD_LOCK_TIMEOUT;\r\nu32 ul_gpio_cfg = 0x0113;\r\nu32 ul_invert_ts_clock = 0;\r\nu32 ul_ts_data_strength = DRXK_MPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH;\r\nu32 ul_dvbt_bitrate = 50000000;\r\nu32 ul_dvbc_bitrate = DRXK_QAM_SYMBOLRATE_MAX * 8;\r\nu32 ul_insert_rs_byte = 0;\r\nu32 ul_rf_mirror = 1;\r\nu32 ul_power_down = 0;\r\ndprintk(1, "\n");\r\nstate->m_has_lna = false;\r\nstate->m_has_dvbt = false;\r\nstate->m_has_dvbc = false;\r\nstate->m_has_atv = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_audio = false;\r\nif (!state->m_chunk_size)\r\nstate->m_chunk_size = 124;\r\nstate->m_osc_clock_freq = 0;\r\nstate->m_smart_ant_inverted = false;\r\nstate->m_b_p_down_open_bridge = false;\r\nstate->m_sys_clock_freq = 151875;\r\nstate->m_hi_cfg_timing_div = ((state->m_sys_clock_freq / 1000) *\r\nHI_I2C_DELAY) / 1000;\r\nif (state->m_hi_cfg_timing_div > SIO_HI_RA_RAM_PAR_2_CFG_DIV__M)\r\nstate->m_hi_cfg_timing_div = SIO_HI_RA_RAM_PAR_2_CFG_DIV__M;\r\nstate->m_hi_cfg_wake_up_key = (state->demod_address << 1);\r\nstate->m_hi_cfg_ctrl = SIO_HI_RA_RAM_PAR_5_CFG_SLV0_SLAVE;\r\nstate->m_b_power_down = (ul_power_down != 0);\r\nstate->m_drxk_a3_patch_code = false;\r\nstate->m_vsb_if_agc_cfg.ctrl_mode = ul_vsb_if_agc_mode;\r\nstate->m_vsb_if_agc_cfg.output_level = ul_vsb_if_agc_output_level;\r\nstate->m_vsb_if_agc_cfg.min_output_level = ul_vsb_if_agc_min_level;\r\nstate->m_vsb_if_agc_cfg.max_output_level = ul_vsb_if_agc_max_level;\r\nstate->m_vsb_if_agc_cfg.speed = ul_vsb_if_agc_speed;\r\nstate->m_vsb_pga_cfg = 140;\r\nstate->m_vsb_rf_agc_cfg.ctrl_mode = ul_vsb_rf_agc_mode;\r\nstate->m_vsb_rf_agc_cfg.output_level = ul_vsb_rf_agc_output_level;\r\nstate->m_vsb_rf_agc_cfg.min_output_level = ul_vsb_rf_agc_min_level;\r\nstate->m_vsb_rf_agc_cfg.max_output_level = ul_vsb_rf_agc_max_level;\r\nstate->m_vsb_rf_agc_cfg.speed = ul_vsb_rf_agc_speed;\r\nstate->m_vsb_rf_agc_cfg.top = ul_vsb_rf_agc_top;\r\nstate->m_vsb_rf_agc_cfg.cut_off_current = ul_vsb_rf_agc_cut_off_current;\r\nstate->m_vsb_pre_saw_cfg.reference = 0x07;\r\nstate->m_vsb_pre_saw_cfg.use_pre_saw = true;\r\nstate->m_Quality83percent = DEFAULT_MER_83;\r\nstate->m_Quality93percent = DEFAULT_MER_93;\r\nif (ulQual93 <= 500 && ulQual83 < ulQual93) {\r\nstate->m_Quality83percent = ulQual83;\r\nstate->m_Quality93percent = ulQual93;\r\n}\r\nstate->m_atv_if_agc_cfg.ctrl_mode = ul_atv_if_agc_mode;\r\nstate->m_atv_if_agc_cfg.output_level = ul_atv_if_agc_output_level;\r\nstate->m_atv_if_agc_cfg.min_output_level = ul_atv_if_agc_min_level;\r\nstate->m_atv_if_agc_cfg.max_output_level = ul_atv_if_agc_max_level;\r\nstate->m_atv_if_agc_cfg.speed = ul_atv_if_agc_speed;\r\nstate->m_atv_rf_agc_cfg.ctrl_mode = ul_atv_rf_agc_mode;\r\nstate->m_atv_rf_agc_cfg.output_level = ul_atv_rf_agc_output_level;\r\nstate->m_atv_rf_agc_cfg.min_output_level = ul_atv_rf_agc_min_level;\r\nstate->m_atv_rf_agc_cfg.max_output_level = ul_atv_rf_agc_max_level;\r\nstate->m_atv_rf_agc_cfg.speed = ul_atv_rf_agc_speed;\r\nstate->m_atv_rf_agc_cfg.top = ul_atv_rf_agc_top;\r\nstate->m_atv_rf_agc_cfg.cut_off_current = ul_atv_rf_agc_cut_off_current;\r\nstate->m_atv_pre_saw_cfg.reference = 0x04;\r\nstate->m_atv_pre_saw_cfg.use_pre_saw = true;\r\nstate->m_dvbt_rf_agc_cfg.ctrl_mode = DRXK_AGC_CTRL_OFF;\r\nstate->m_dvbt_rf_agc_cfg.output_level = 0;\r\nstate->m_dvbt_rf_agc_cfg.min_output_level = 0;\r\nstate->m_dvbt_rf_agc_cfg.max_output_level = 0xFFFF;\r\nstate->m_dvbt_rf_agc_cfg.top = 0x2100;\r\nstate->m_dvbt_rf_agc_cfg.cut_off_current = 4000;\r\nstate->m_dvbt_rf_agc_cfg.speed = 1;\r\nstate->m_dvbt_if_agc_cfg.ctrl_mode = DRXK_AGC_CTRL_AUTO;\r\nstate->m_dvbt_if_agc_cfg.output_level = 0;\r\nstate->m_dvbt_if_agc_cfg.min_output_level = 0;\r\nstate->m_dvbt_if_agc_cfg.max_output_level = 9000;\r\nstate->m_dvbt_if_agc_cfg.top = 13424;\r\nstate->m_dvbt_if_agc_cfg.cut_off_current = 0;\r\nstate->m_dvbt_if_agc_cfg.speed = 3;\r\nstate->m_dvbt_if_agc_cfg.fast_clip_ctrl_delay = 30;\r\nstate->m_dvbt_if_agc_cfg.ingain_tgt_max = 30000;\r\nstate->m_dvbt_pre_saw_cfg.reference = 4;\r\nstate->m_dvbt_pre_saw_cfg.use_pre_saw = false;\r\nstate->m_qam_rf_agc_cfg.ctrl_mode = DRXK_AGC_CTRL_OFF;\r\nstate->m_qam_rf_agc_cfg.output_level = 0;\r\nstate->m_qam_rf_agc_cfg.min_output_level = 6023;\r\nstate->m_qam_rf_agc_cfg.max_output_level = 27000;\r\nstate->m_qam_rf_agc_cfg.top = 0x2380;\r\nstate->m_qam_rf_agc_cfg.cut_off_current = 4000;\r\nstate->m_qam_rf_agc_cfg.speed = 3;\r\nstate->m_qam_if_agc_cfg.ctrl_mode = DRXK_AGC_CTRL_AUTO;\r\nstate->m_qam_if_agc_cfg.output_level = 0;\r\nstate->m_qam_if_agc_cfg.min_output_level = 0;\r\nstate->m_qam_if_agc_cfg.max_output_level = 9000;\r\nstate->m_qam_if_agc_cfg.top = 0x0511;\r\nstate->m_qam_if_agc_cfg.cut_off_current = 0;\r\nstate->m_qam_if_agc_cfg.speed = 3;\r\nstate->m_qam_if_agc_cfg.ingain_tgt_max = 5119;\r\nstate->m_qam_if_agc_cfg.fast_clip_ctrl_delay = 50;\r\nstate->m_qam_pga_cfg = 140;\r\nstate->m_qam_pre_saw_cfg.reference = 4;\r\nstate->m_qam_pre_saw_cfg.use_pre_saw = false;\r\nstate->m_operation_mode = OM_NONE;\r\nstate->m_drxk_state = DRXK_UNINITIALIZED;\r\nstate->m_enable_mpeg_output = true;\r\nstate->m_insert_rs_byte = false;\r\nstate->m_invert_data = false;\r\nstate->m_invert_err = false;\r\nstate->m_invert_str = false;\r\nstate->m_invert_val = false;\r\nstate->m_invert_clk = (ul_invert_ts_clock != 0);\r\nstate->m_dvbt_bitrate = ul_dvbt_bitrate;\r\nstate->m_dvbc_bitrate = ul_dvbc_bitrate;\r\nstate->m_ts_data_strength = (ul_ts_data_strength & 0x07);\r\nstate->m_mpeg_ts_static_bitrate = 19392658;\r\nstate->m_disable_te_ihandling = false;\r\nif (ul_insert_rs_byte)\r\nstate->m_insert_rs_byte = true;\r\nstate->m_mpeg_lock_time_out = DEFAULT_DRXK_MPEG_LOCK_TIMEOUT;\r\nif (ul_mpeg_lock_time_out < 10000)\r\nstate->m_mpeg_lock_time_out = ul_mpeg_lock_time_out;\r\nstate->m_demod_lock_time_out = DEFAULT_DRXK_DEMOD_LOCK_TIMEOUT;\r\nif (ul_demod_lock_time_out < 10000)\r\nstate->m_demod_lock_time_out = ul_demod_lock_time_out;\r\nstate->m_constellation = DRX_CONSTELLATION_AUTO;\r\nstate->m_qam_interleave_mode = DRXK_QAM_I12_J17;\r\nstate->m_fec_rs_plen = 204 * 8;\r\nstate->m_fec_rs_prescale = 1;\r\nstate->m_sqi_speed = DRXK_DVBT_SQI_SPEED_MEDIUM;\r\nstate->m_agcfast_clip_ctrl_delay = 0;\r\nstate->m_gpio_cfg = ul_gpio_cfg;\r\nstate->m_b_power_down = false;\r\nstate->m_current_power_mode = DRX_POWER_DOWN;\r\nstate->m_rfmirror = (ul_rf_mirror == 0);\r\nstate->m_if_agc_pol = false;\r\nreturn 0;\r\n}\r\nstatic int drxx_open(struct drxk_state *state)\r\n{\r\nint status = 0;\r\nu32 jtag = 0;\r\nu16 bid = 0;\r\nu16 key = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_GPIO__A,\r\nSCU_RAM_GPIO_HW_LOCK_IND_DISABLE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SIO_TOP_COMM_KEY__A, &key);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read32(state, SIO_TOP_JTAGID_LO__A, &jtag);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SIO_PDR_UIO_IN_HI__A, &bid);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, key);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int get_device_capabilities(struct drxk_state *state)\r\n{\r\nu16 sio_pdr_ohw_cfg = 0;\r\nu32 sio_top_jtagid_lo = 0;\r\nint status;\r\nconst char *spin = "";\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_GPIO__A,\r\nSCU_RAM_GPIO_HW_LOCK_IND_DISABLE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SIO_PDR_OHW_CFG__A, &sio_pdr_ohw_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nswitch ((sio_pdr_ohw_cfg & SIO_PDR_OHW_CFG_FREF_SEL__M)) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nstate->m_osc_clock_freq = 27000;\r\nbreak;\r\ncase 2:\r\nstate->m_osc_clock_freq = 20250;\r\nbreak;\r\ncase 3:\r\nstate->m_osc_clock_freq = 20250;\r\nbreak;\r\ndefault:\r\npr_err("Clock Frequency is unknown\n");\r\nreturn -EINVAL;\r\n}\r\nstatus = read32(state, SIO_TOP_JTAGID_LO__A, &sio_top_jtagid_lo);\r\nif (status < 0)\r\ngoto error;\r\npr_info("status = 0x%08x\n", sio_top_jtagid_lo);\r\nswitch ((sio_top_jtagid_lo >> 29) & 0xF) {\r\ncase 0:\r\nstate->m_device_spin = DRXK_SPIN_A1;\r\nspin = "A1";\r\nbreak;\r\ncase 2:\r\nstate->m_device_spin = DRXK_SPIN_A2;\r\nspin = "A2";\r\nbreak;\r\ncase 3:\r\nstate->m_device_spin = DRXK_SPIN_A3;\r\nspin = "A3";\r\nbreak;\r\ndefault:\r\nstate->m_device_spin = DRXK_SPIN_UNKNOWN;\r\nstatus = -EINVAL;\r\npr_err("Spin %d unknown\n", (sio_top_jtagid_lo >> 29) & 0xF);\r\ngoto error2;\r\n}\r\nswitch ((sio_top_jtagid_lo >> 12) & 0xFF) {\r\ncase 0x13:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = false;\r\nstate->m_has_audio = false;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = true;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = false;\r\nstate->m_has_gpio1 = false;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ncase 0x15:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = true;\r\nstate->m_has_audio = false;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = false;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = true;\r\nstate->m_has_gpio1 = true;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ncase 0x16:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = true;\r\nstate->m_has_audio = false;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = false;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = true;\r\nstate->m_has_gpio1 = true;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ncase 0x18:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = true;\r\nstate->m_has_audio = true;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = false;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = true;\r\nstate->m_has_gpio1 = true;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ncase 0x21:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = true;\r\nstate->m_has_audio = true;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = true;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = true;\r\nstate->m_has_gpio1 = true;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ncase 0x23:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = true;\r\nstate->m_has_audio = true;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = true;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = true;\r\nstate->m_has_gpio1 = true;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ncase 0x25:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = true;\r\nstate->m_has_audio = true;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = true;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = true;\r\nstate->m_has_gpio1 = true;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ncase 0x26:\r\nstate->m_has_lna = false;\r\nstate->m_has_oob = false;\r\nstate->m_has_atv = true;\r\nstate->m_has_audio = false;\r\nstate->m_has_dvbt = true;\r\nstate->m_has_dvbc = true;\r\nstate->m_has_sawsw = true;\r\nstate->m_has_gpio2 = true;\r\nstate->m_has_gpio1 = true;\r\nstate->m_has_irqn = false;\r\nbreak;\r\ndefault:\r\npr_err("DeviceID 0x%02x not supported\n",\r\n((sio_top_jtagid_lo >> 12) & 0xFF));\r\nstatus = -EINVAL;\r\ngoto error2;\r\n}\r\npr_info("detected a drx-39%02xk, spin %s, xtal %d.%03d MHz\n",\r\n((sio_top_jtagid_lo >> 12) & 0xFF), spin,\r\nstate->m_osc_clock_freq / 1000,\r\nstate->m_osc_clock_freq % 1000);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nerror2:\r\nreturn status;\r\n}\r\nstatic int hi_command(struct drxk_state *state, u16 cmd, u16 *p_result)\r\n{\r\nint status;\r\nbool powerdown_cmd;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SIO_HI_RA_RAM_CMD__A, cmd);\r\nif (status < 0)\r\ngoto error;\r\nif (cmd == SIO_HI_RA_RAM_CMD_RESET)\r\nusleep_range(1000, 2000);\r\npowerdown_cmd =\r\n(bool) ((cmd == SIO_HI_RA_RAM_CMD_CONFIG) &&\r\n((state->m_hi_cfg_ctrl) &\r\nSIO_HI_RA_RAM_PAR_5_CFG_SLEEP__M) ==\r\nSIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ);\r\nif (!powerdown_cmd) {\r\nu32 retry_count = 0;\r\nu16 wait_cmd;\r\ndo {\r\nusleep_range(1000, 2000);\r\nretry_count += 1;\r\nstatus = read16(state, SIO_HI_RA_RAM_CMD__A,\r\n&wait_cmd);\r\n} while ((status < 0) && (retry_count < DRXK_MAX_RETRIES)\r\n&& (wait_cmd != 0));\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SIO_HI_RA_RAM_RES__A, p_result);\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int hi_cfg_command(struct drxk_state *state)\r\n{\r\nint status;\r\ndprintk(1, "\n");\r\nmutex_lock(&state->mutex);\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_6__A,\r\nstate->m_hi_cfg_timeout);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_5__A,\r\nstate->m_hi_cfg_ctrl);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_4__A,\r\nstate->m_hi_cfg_wake_up_key);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_3__A,\r\nstate->m_hi_cfg_bridge_delay);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_2__A,\r\nstate->m_hi_cfg_timing_div);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_1__A,\r\nSIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY);\r\nif (status < 0)\r\ngoto error;\r\nstatus = hi_command(state, SIO_HI_RA_RAM_CMD_CONFIG, NULL);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_hi_cfg_ctrl &= ~SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ;\r\nerror:\r\nmutex_unlock(&state->mutex);\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int init_hi(struct drxk_state *state)\r\n{\r\ndprintk(1, "\n");\r\nstate->m_hi_cfg_wake_up_key = (state->demod_address << 1);\r\nstate->m_hi_cfg_timeout = 0x96FF;\r\nstate->m_hi_cfg_ctrl = SIO_HI_RA_RAM_PAR_5_CFG_SLV0_SLAVE;\r\nreturn hi_cfg_command(state);\r\n}\r\nstatic int mpegts_configure_pins(struct drxk_state *state, bool mpeg_enable)\r\n{\r\nint status = -1;\r\nu16 sio_pdr_mclk_cfg = 0;\r\nu16 sio_pdr_mdx_cfg = 0;\r\nu16 err_cfg = 0;\r\ndprintk(1, ": mpeg %s, %s mode\n",\r\nmpeg_enable ? "enable" : "disable",\r\nstate->m_enable_parallel ? "parallel" : "serial");\r\nstatus = write16(state, SCU_RAM_GPIO__A,\r\nSCU_RAM_GPIO_HW_LOCK_IND_DISABLE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY);\r\nif (status < 0)\r\ngoto error;\r\nif (!mpeg_enable) {\r\nstatus = write16(state, SIO_PDR_MSTRT_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MERR_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MCLK_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MVAL_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD0_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD1_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD2_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD3_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD4_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD5_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD6_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD7_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\n} else {\r\nsio_pdr_mdx_cfg =\r\n((state->m_ts_data_strength <<\r\nSIO_PDR_MD0_CFG_DRIVE__B) | 0x0003);\r\nsio_pdr_mclk_cfg = ((state->m_ts_clockk_strength <<\r\nSIO_PDR_MCLK_CFG_DRIVE__B) |\r\n0x0003);\r\nstatus = write16(state, SIO_PDR_MSTRT_CFG__A, sio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\nif (state->enable_merr_cfg)\r\nerr_cfg = sio_pdr_mdx_cfg;\r\nstatus = write16(state, SIO_PDR_MERR_CFG__A, err_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MVAL_CFG__A, err_cfg);\r\nif (status < 0)\r\ngoto error;\r\nif (state->m_enable_parallel) {\r\nstatus = write16(state, SIO_PDR_MD1_CFG__A,\r\nsio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD2_CFG__A,\r\nsio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD3_CFG__A,\r\nsio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD4_CFG__A,\r\nsio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD5_CFG__A,\r\nsio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD6_CFG__A,\r\nsio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD7_CFG__A,\r\nsio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\n} else {\r\nsio_pdr_mdx_cfg = ((state->m_ts_data_strength <<\r\nSIO_PDR_MD0_CFG_DRIVE__B)\r\n| 0x0003);\r\nstatus = write16(state, SIO_PDR_MD1_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD2_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD3_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD4_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD5_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD6_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD7_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = write16(state, SIO_PDR_MCLK_CFG__A, sio_pdr_mclk_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_PDR_MD0_CFG__A, sio_pdr_mdx_cfg);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = write16(state, SIO_PDR_MON_CFG__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, 0x0000);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int mpegts_disable(struct drxk_state *state)\r\n{\r\ndprintk(1, "\n");\r\nreturn mpegts_configure_pins(state, false);\r\n}\r\nstatic int bl_chain_cmd(struct drxk_state *state,\r\nu16 rom_offset, u16 nr_of_elements, u32 time_out)\r\n{\r\nu16 bl_status = 0;\r\nint status;\r\nunsigned long end;\r\ndprintk(1, "\n");\r\nmutex_lock(&state->mutex);\r\nstatus = write16(state, SIO_BL_MODE__A, SIO_BL_MODE_CHAIN);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_CHAIN_ADDR__A, rom_offset);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_CHAIN_LEN__A, nr_of_elements);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_ENABLE__A, SIO_BL_ENABLE_ON);\r\nif (status < 0)\r\ngoto error;\r\nend = jiffies + msecs_to_jiffies(time_out);\r\ndo {\r\nusleep_range(1000, 2000);\r\nstatus = read16(state, SIO_BL_STATUS__A, &bl_status);\r\nif (status < 0)\r\ngoto error;\r\n} while ((bl_status == 0x1) &&\r\n((time_is_after_jiffies(end))));\r\nif (bl_status == 0x1) {\r\npr_err("SIO not ready\n");\r\nstatus = -EINVAL;\r\ngoto error2;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nerror2:\r\nmutex_unlock(&state->mutex);\r\nreturn status;\r\n}\r\nstatic int download_microcode(struct drxk_state *state,\r\nconst u8 p_mc_image[], u32 length)\r\n{\r\nconst u8 *p_src = p_mc_image;\r\nu32 address;\r\nu16 n_blocks;\r\nu16 block_size;\r\nu32 offset = 0;\r\nu32 i;\r\nint status = 0;\r\ndprintk(1, "\n");\r\n#if 0\r\ndrain = (p_src[0] << 8) | p_src[1];\r\n#endif\r\np_src += sizeof(u16);\r\noffset += sizeof(u16);\r\nn_blocks = (p_src[0] << 8) | p_src[1];\r\np_src += sizeof(u16);\r\noffset += sizeof(u16);\r\nfor (i = 0; i < n_blocks; i += 1) {\r\naddress = (p_src[0] << 24) | (p_src[1] << 16) |\r\n(p_src[2] << 8) | p_src[3];\r\np_src += sizeof(u32);\r\noffset += sizeof(u32);\r\nblock_size = ((p_src[0] << 8) | p_src[1]) * sizeof(u16);\r\np_src += sizeof(u16);\r\noffset += sizeof(u16);\r\n#if 0\r\nflags = (p_src[0] << 8) | p_src[1];\r\n#endif\r\np_src += sizeof(u16);\r\noffset += sizeof(u16);\r\n#if 0\r\nblock_crc = (p_src[0] << 8) | p_src[1];\r\n#endif\r\np_src += sizeof(u16);\r\noffset += sizeof(u16);\r\nif (offset + block_size > length) {\r\npr_err("Firmware is corrupted.\n");\r\nreturn -EINVAL;\r\n}\r\nstatus = write_block(state, address, block_size, p_src);\r\nif (status < 0) {\r\npr_err("Error %d while loading firmware\n", status);\r\nbreak;\r\n}\r\np_src += block_size;\r\noffset += block_size;\r\n}\r\nreturn status;\r\n}\r\nstatic int dvbt_enable_ofdm_token_ring(struct drxk_state *state, bool enable)\r\n{\r\nint status;\r\nu16 data = 0;\r\nu16 desired_ctrl = SIO_OFDM_SH_OFDM_RING_ENABLE_ON;\r\nu16 desired_status = SIO_OFDM_SH_OFDM_RING_STATUS_ENABLED;\r\nunsigned long end;\r\ndprintk(1, "\n");\r\nif (!enable) {\r\ndesired_ctrl = SIO_OFDM_SH_OFDM_RING_ENABLE_OFF;\r\ndesired_status = SIO_OFDM_SH_OFDM_RING_STATUS_DOWN;\r\n}\r\nstatus = read16(state, SIO_OFDM_SH_OFDM_RING_STATUS__A, &data);\r\nif (status >= 0 && data == desired_status) {\r\nreturn status;\r\n}\r\nstatus = write16(state, SIO_OFDM_SH_OFDM_RING_ENABLE__A, desired_ctrl);\r\nend = jiffies + msecs_to_jiffies(DRXK_OFDM_TR_SHUTDOWN_TIMEOUT);\r\ndo {\r\nstatus = read16(state, SIO_OFDM_SH_OFDM_RING_STATUS__A, &data);\r\nif ((status >= 0 && data == desired_status)\r\n|| time_is_after_jiffies(end))\r\nbreak;\r\nusleep_range(1000, 2000);\r\n} while (1);\r\nif (data != desired_status) {\r\npr_err("SIO not ready\n");\r\nreturn -EINVAL;\r\n}\r\nreturn status;\r\n}\r\nstatic int mpegts_stop(struct drxk_state *state)\r\n{\r\nint status = 0;\r\nu16 fec_oc_snc_mode = 0;\r\nu16 fec_oc_ipr_mode = 0;\r\ndprintk(1, "\n");\r\nstatus = read16(state, FEC_OC_SNC_MODE__A, &fec_oc_snc_mode);\r\nif (status < 0)\r\ngoto error;\r\nfec_oc_snc_mode |= FEC_OC_SNC_MODE_SHUTDOWN__M;\r\nstatus = write16(state, FEC_OC_SNC_MODE__A, fec_oc_snc_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, FEC_OC_IPR_MODE__A, &fec_oc_ipr_mode);\r\nif (status < 0)\r\ngoto error;\r\nfec_oc_ipr_mode |= FEC_OC_IPR_MODE_MCLK_DIS_DAT_ABS__M;\r\nstatus = write16(state, FEC_OC_IPR_MODE__A, fec_oc_ipr_mode);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int scu_command(struct drxk_state *state,\r\nu16 cmd, u8 parameter_len,\r\nu16 *parameter, u8 result_len, u16 *result)\r\n{\r\n#if (SCU_RAM_PARAM_0__A - SCU_RAM_PARAM_15__A) != 15\r\n#error DRXK register mapping no longer compatible with this routine!\r\n#endif\r\nu16 cur_cmd = 0;\r\nint status = -EINVAL;\r\nunsigned long end;\r\nu8 buffer[34];\r\nint cnt = 0, ii;\r\nconst char *p;\r\nchar errname[30];\r\ndprintk(1, "\n");\r\nif ((cmd == 0) || ((parameter_len > 0) && (parameter == NULL)) ||\r\n((result_len > 0) && (result == NULL))) {\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nmutex_lock(&state->mutex);\r\nfor (ii = parameter_len - 1; ii >= 0; ii -= 1) {\r\nbuffer[cnt++] = (parameter[ii] & 0xFF);\r\nbuffer[cnt++] = ((parameter[ii] >> 8) & 0xFF);\r\n}\r\nbuffer[cnt++] = (cmd & 0xFF);\r\nbuffer[cnt++] = ((cmd >> 8) & 0xFF);\r\nwrite_block(state, SCU_RAM_PARAM_0__A -\r\n(parameter_len - 1), cnt, buffer);\r\nend = jiffies + msecs_to_jiffies(DRXK_MAX_WAITTIME);\r\ndo {\r\nusleep_range(1000, 2000);\r\nstatus = read16(state, SCU_RAM_COMMAND__A, &cur_cmd);\r\nif (status < 0)\r\ngoto error;\r\n} while (!(cur_cmd == DRX_SCU_READY) && (time_is_after_jiffies(end)));\r\nif (cur_cmd != DRX_SCU_READY) {\r\npr_err("SCU not ready\n");\r\nstatus = -EIO;\r\ngoto error2;\r\n}\r\nif ((result_len > 0) && (result != NULL)) {\r\ns16 err;\r\nint ii;\r\nfor (ii = result_len - 1; ii >= 0; ii -= 1) {\r\nstatus = read16(state, SCU_RAM_PARAM_0__A - ii,\r\n&result[ii]);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nerr = (s16)result[0];\r\nif (err >= 0)\r\ngoto error;\r\nswitch (err) {\r\ncase SCU_RESULT_UNKCMD:\r\np = "SCU_RESULT_UNKCMD";\r\nbreak;\r\ncase SCU_RESULT_UNKSTD:\r\np = "SCU_RESULT_UNKSTD";\r\nbreak;\r\ncase SCU_RESULT_SIZE:\r\np = "SCU_RESULT_SIZE";\r\nbreak;\r\ncase SCU_RESULT_INVPAR:\r\np = "SCU_RESULT_INVPAR";\r\nbreak;\r\ndefault:\r\nsprintf(errname, "ERROR: %d\n", err);\r\np = errname;\r\n}\r\npr_err("%s while sending cmd 0x%04x with params:", p, cmd);\r\nprint_hex_dump_bytes("drxk: ", DUMP_PREFIX_NONE, buffer, cnt);\r\nstatus = -EINVAL;\r\ngoto error2;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nerror2:\r\nmutex_unlock(&state->mutex);\r\nreturn status;\r\n}\r\nstatic int set_iqm_af(struct drxk_state *state, bool active)\r\n{\r\nu16 data = 0;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = read16(state, IQM_AF_STDBY__A, &data);\r\nif (status < 0)\r\ngoto error;\r\nif (!active) {\r\ndata |= (IQM_AF_STDBY_STDBY_ADC_STANDBY\r\n| IQM_AF_STDBY_STDBY_AMP_STANDBY\r\n| IQM_AF_STDBY_STDBY_PD_STANDBY\r\n| IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY\r\n| IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY);\r\n} else {\r\ndata &= ((~IQM_AF_STDBY_STDBY_ADC_STANDBY)\r\n& (~IQM_AF_STDBY_STDBY_AMP_STANDBY)\r\n& (~IQM_AF_STDBY_STDBY_PD_STANDBY)\r\n& (~IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY)\r\n& (~IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY)\r\n);\r\n}\r\nstatus = write16(state, IQM_AF_STDBY__A, data);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int ctrl_power_mode(struct drxk_state *state, enum drx_power_mode *mode)\r\n{\r\nint status = 0;\r\nu16 sio_cc_pwd_mode = 0;\r\ndprintk(1, "\n");\r\nif (mode == NULL)\r\nreturn -EINVAL;\r\nswitch (*mode) {\r\ncase DRX_POWER_UP:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_NONE;\r\nbreak;\r\ncase DRXK_POWER_DOWN_OFDM:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_OFDM;\r\nbreak;\r\ncase DRXK_POWER_DOWN_CORE:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_CLOCK;\r\nbreak;\r\ncase DRXK_POWER_DOWN_PLL:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_PLL;\r\nbreak;\r\ncase DRX_POWER_DOWN:\r\nsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_OSC;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (state->m_current_power_mode == *mode)\r\nreturn 0;\r\nif (state->m_current_power_mode != DRX_POWER_UP) {\r\nstatus = power_up_device(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = dvbt_enable_ofdm_token_ring(state, true);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nif (*mode == DRX_POWER_UP) {\r\n} else {\r\nswitch (state->m_operation_mode) {\r\ncase OM_DVBT:\r\nstatus = mpegts_stop(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = power_down_dvbt(state, false);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase OM_QAM_ITU_A:\r\ncase OM_QAM_ITU_C:\r\nstatus = mpegts_stop(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = power_down_qam(state);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nstatus = dvbt_enable_ofdm_token_ring(state, false);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_PWD_MODE__A, sio_cc_pwd_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY);\r\nif (status < 0)\r\ngoto error;\r\nif (*mode != DRXK_POWER_DOWN_OFDM) {\r\nstate->m_hi_cfg_ctrl |=\r\nSIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ;\r\nstatus = hi_cfg_command(state);\r\nif (status < 0)\r\ngoto error;\r\n}\r\n}\r\nstate->m_current_power_mode = *mode;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int power_down_dvbt(struct drxk_state *state, bool set_power_mode)\r\n{\r\nenum drx_power_mode power_mode = DRXK_POWER_DOWN_OFDM;\r\nu16 cmd_result = 0;\r\nu16 data = 0;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = read16(state, SCU_COMM_EXEC__A, &data);\r\nif (status < 0)\r\ngoto error;\r\nif (data == SCU_COMM_EXEC_ACTIVE) {\r\nstatus = scu_command(state,\r\nSCU_RAM_COMMAND_STANDARD_OFDM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_STOP,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\nstatus = scu_command(state,\r\nSCU_RAM_COMMAND_STANDARD_OFDM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_RESET,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = write16(state, OFDM_SC_COMM_EXEC__A, OFDM_SC_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_LC_COMM_EXEC__A, OFDM_LC_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_COMM_EXEC__A, IQM_COMM_EXEC_B_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_iqm_af(state, false);\r\nif (status < 0)\r\ngoto error;\r\nif (set_power_mode) {\r\nstatus = ctrl_power_mode(state, &power_mode);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int setoperation_mode(struct drxk_state *state,\r\nenum operation_mode o_mode)\r\n{\r\nint status = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_GPIO__A,\r\nSCU_RAM_GPIO_HW_LOCK_IND_DISABLE);\r\nif (status < 0)\r\ngoto error;\r\nif (state->m_operation_mode == o_mode)\r\nreturn 0;\r\nswitch (state->m_operation_mode) {\r\ncase OM_NONE:\r\nbreak;\r\ncase OM_DVBT:\r\nstatus = mpegts_stop(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = power_down_dvbt(state, true);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_operation_mode = OM_NONE;\r\nbreak;\r\ncase OM_QAM_ITU_A:\r\ncase OM_QAM_ITU_C:\r\nstatus = mpegts_stop(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = power_down_qam(state);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_operation_mode = OM_NONE;\r\nbreak;\r\ncase OM_QAM_ITU_B:\r\ndefault:\r\nstatus = -EINVAL;\r\ngoto error;\r\n}\r\nswitch (o_mode) {\r\ncase OM_DVBT:\r\ndprintk(1, ": DVB-T\n");\r\nstate->m_operation_mode = o_mode;\r\nstatus = set_dvbt_standard(state, o_mode);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase OM_QAM_ITU_A:\r\ncase OM_QAM_ITU_C:\r\ndprintk(1, ": DVB-C Annex %c\n",\r\n(state->m_operation_mode == OM_QAM_ITU_A) ? 'A' : 'C');\r\nstate->m_operation_mode = o_mode;\r\nstatus = set_qam_standard(state, o_mode);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase OM_QAM_ITU_B:\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int start(struct drxk_state *state, s32 offset_freq,\r\ns32 intermediate_frequency)\r\n{\r\nint status = -EINVAL;\r\nu16 i_freqk_hz;\r\ns32 offsetk_hz = offset_freq / 1000;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state != DRXK_STOPPED &&\r\nstate->m_drxk_state != DRXK_DTV_STARTED)\r\ngoto error;\r\nstate->m_b_mirror_freq_spect = (state->props.inversion == INVERSION_ON);\r\nif (intermediate_frequency < 0) {\r\nstate->m_b_mirror_freq_spect = !state->m_b_mirror_freq_spect;\r\nintermediate_frequency = -intermediate_frequency;\r\n}\r\nswitch (state->m_operation_mode) {\r\ncase OM_QAM_ITU_A:\r\ncase OM_QAM_ITU_C:\r\ni_freqk_hz = (intermediate_frequency / 1000);\r\nstatus = set_qam(state, i_freqk_hz, offsetk_hz);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_drxk_state = DRXK_DTV_STARTED;\r\nbreak;\r\ncase OM_DVBT:\r\ni_freqk_hz = (intermediate_frequency / 1000);\r\nstatus = mpegts_stop(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_dvbt(state, i_freqk_hz, offsetk_hz);\r\nif (status < 0)\r\ngoto error;\r\nstatus = dvbt_start(state);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_drxk_state = DRXK_DTV_STARTED;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int shut_down(struct drxk_state *state)\r\n{\r\ndprintk(1, "\n");\r\nmpegts_stop(state);\r\nreturn 0;\r\n}\r\nstatic int get_lock_status(struct drxk_state *state, u32 *p_lock_status)\r\n{\r\nint status = -EINVAL;\r\ndprintk(1, "\n");\r\nif (p_lock_status == NULL)\r\ngoto error;\r\n*p_lock_status = NOT_LOCKED;\r\nswitch (state->m_operation_mode) {\r\ncase OM_QAM_ITU_A:\r\ncase OM_QAM_ITU_B:\r\ncase OM_QAM_ITU_C:\r\nstatus = get_qam_lock_status(state, p_lock_status);\r\nbreak;\r\ncase OM_DVBT:\r\nstatus = get_dvbt_lock_status(state, p_lock_status);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int mpegts_start(struct drxk_state *state)\r\n{\r\nint status;\r\nu16 fec_oc_snc_mode = 0;\r\nstatus = read16(state, FEC_OC_SNC_MODE__A, &fec_oc_snc_mode);\r\nif (status < 0)\r\ngoto error;\r\nfec_oc_snc_mode &= ~FEC_OC_SNC_MODE_SHUTDOWN__M;\r\nstatus = write16(state, FEC_OC_SNC_MODE__A, fec_oc_snc_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_SNC_UNLOCK__A, 1);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int mpegts_dto_init(struct drxk_state *state)\r\n{\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = write16(state, FEC_OC_RCN_CTL_STEP_LO__A, 0x0000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_RCN_CTL_STEP_HI__A, 0x000C);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_RCN_GAIN__A, 0x000A);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_AVR_PARM_A__A, 0x0008);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_AVR_PARM_B__A, 0x0006);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_TMD_HI_MARGIN__A, 0x0680);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_TMD_LO_MARGIN__A, 0x0080);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_TMD_COUNT__A, 0x03F4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_OCR_INVERT__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_SNC_LWM__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_SNC_HWM__A, 12);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int mpegts_dto_setup(struct drxk_state *state,\r\nenum operation_mode o_mode)\r\n{\r\nint status;\r\nu16 fec_oc_reg_mode = 0;\r\nu16 fec_oc_reg_ipr_mode = 0;\r\nu16 fec_oc_dto_mode = 0;\r\nu16 fec_oc_fct_mode = 0;\r\nu16 fec_oc_dto_period = 2;\r\nu16 fec_oc_dto_burst_len = 188;\r\nu32 fec_oc_rcn_ctl_rate = 0;\r\nu16 fec_oc_tmd_mode = 0;\r\nu16 fec_oc_tmd_int_upd_rate = 0;\r\nu32 max_bit_rate = 0;\r\nbool static_clk = false;\r\ndprintk(1, "\n");\r\nstatus = read16(state, FEC_OC_MODE__A, &fec_oc_reg_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, FEC_OC_IPR_MODE__A, &fec_oc_reg_ipr_mode);\r\nif (status < 0)\r\ngoto error;\r\nfec_oc_reg_mode &= (~FEC_OC_MODE_PARITY__M);\r\nfec_oc_reg_ipr_mode &= (~FEC_OC_IPR_MODE_MVAL_DIS_PAR__M);\r\nif (state->m_insert_rs_byte) {\r\nfec_oc_reg_mode |= FEC_OC_MODE_PARITY__M;\r\nfec_oc_reg_ipr_mode |= FEC_OC_IPR_MODE_MVAL_DIS_PAR__M;\r\nfec_oc_dto_burst_len = 204;\r\n}\r\nfec_oc_reg_ipr_mode &= (~(FEC_OC_IPR_MODE_SERIAL__M));\r\nif (!state->m_enable_parallel) {\r\nfec_oc_reg_ipr_mode |= FEC_OC_IPR_MODE_SERIAL__M;\r\n}\r\nswitch (o_mode) {\r\ncase OM_DVBT:\r\nmax_bit_rate = state->m_dvbt_bitrate;\r\nfec_oc_tmd_mode = 3;\r\nfec_oc_rcn_ctl_rate = 0xC00000;\r\nstatic_clk = state->m_dvbt_static_clk;\r\nbreak;\r\ncase OM_QAM_ITU_A:\r\ncase OM_QAM_ITU_C:\r\nfec_oc_tmd_mode = 0x0004;\r\nfec_oc_rcn_ctl_rate = 0xD2B4EE;\r\nmax_bit_rate = state->m_dvbc_bitrate;\r\nstatic_clk = state->m_dvbc_static_clk;\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nif (static_clk) {\r\nu32 bit_rate = 0;\r\nfec_oc_dto_mode = (FEC_OC_DTO_MODE_DYNAMIC__M |\r\nFEC_OC_DTO_MODE_OFFSET_ENABLE__M);\r\nfec_oc_fct_mode = (FEC_OC_FCT_MODE_RAT_ENA__M |\r\nFEC_OC_FCT_MODE_VIRT_ENA__M);\r\nbit_rate = max_bit_rate;\r\nif (bit_rate > 75900000UL) {\r\nbit_rate = 75900000UL;\r\n}\r\nfec_oc_dto_period = (u16) (((state->m_sys_clock_freq)\r\n* 1000) / bit_rate);\r\nif (fec_oc_dto_period <= 2)\r\nfec_oc_dto_period = 0;\r\nelse\r\nfec_oc_dto_period -= 2;\r\nfec_oc_tmd_int_upd_rate = 8;\r\n} else {\r\nfec_oc_dto_mode = FEC_OC_DTO_MODE_DYNAMIC__M;\r\nfec_oc_fct_mode = FEC_OC_FCT_MODE__PRE;\r\nfec_oc_tmd_int_upd_rate = 5;\r\n}\r\nstatus = write16(state, FEC_OC_DTO_BURST_LEN__A, fec_oc_dto_burst_len);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_DTO_PERIOD__A, fec_oc_dto_period);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_DTO_MODE__A, fec_oc_dto_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_FCT_MODE__A, fec_oc_fct_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_MODE__A, fec_oc_reg_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_IPR_MODE__A, fec_oc_reg_ipr_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write32(state, FEC_OC_RCN_CTL_RATE_LO__A, fec_oc_rcn_ctl_rate);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_TMD_INT_UPD_RATE__A,\r\nfec_oc_tmd_int_upd_rate);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_TMD_MODE__A, fec_oc_tmd_mode);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int mpegts_configure_polarity(struct drxk_state *state)\r\n{\r\nu16 fec_oc_reg_ipr_invert = 0;\r\nu16 invert_data_mask =\r\nFEC_OC_IPR_INVERT_MD7__M | FEC_OC_IPR_INVERT_MD6__M |\r\nFEC_OC_IPR_INVERT_MD5__M | FEC_OC_IPR_INVERT_MD4__M |\r\nFEC_OC_IPR_INVERT_MD3__M | FEC_OC_IPR_INVERT_MD2__M |\r\nFEC_OC_IPR_INVERT_MD1__M | FEC_OC_IPR_INVERT_MD0__M;\r\ndprintk(1, "\n");\r\nfec_oc_reg_ipr_invert &= (~(invert_data_mask));\r\nif (state->m_invert_data)\r\nfec_oc_reg_ipr_invert |= invert_data_mask;\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MERR__M));\r\nif (state->m_invert_err)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MERR__M;\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MSTRT__M));\r\nif (state->m_invert_str)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MSTRT__M;\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MVAL__M));\r\nif (state->m_invert_val)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MVAL__M;\r\nfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MCLK__M));\r\nif (state->m_invert_clk)\r\nfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MCLK__M;\r\nreturn write16(state, FEC_OC_IPR_INVERT__A, fec_oc_reg_ipr_invert);\r\n}\r\nstatic int set_agc_rf(struct drxk_state *state,\r\nstruct s_cfg_agc *p_agc_cfg, bool is_dtv)\r\n{\r\nint status = -EINVAL;\r\nu16 data = 0;\r\nstruct s_cfg_agc *p_if_agc_settings;\r\ndprintk(1, "\n");\r\nif (p_agc_cfg == NULL)\r\ngoto error;\r\nswitch (p_agc_cfg->ctrl_mode) {\r\ncase DRXK_AGC_CTRL_AUTO:\r\nstatus = read16(state, IQM_AF_STDBY__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY;\r\nstatus = write16(state, IQM_AF_STDBY__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_CONFIG__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~SCU_RAM_AGC_CONFIG_DISABLE_RF_AGC__M;\r\nif (state->m_rf_agc_pol)\r\ndata |= SCU_RAM_AGC_CONFIG_INV_RF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_CONFIG_INV_RF_POL__M;\r\nstatus = write16(state, SCU_RAM_AGC_CONFIG__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_KI_RED__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~SCU_RAM_AGC_KI_RED_RAGC_RED__M;\r\ndata |= (~(p_agc_cfg->speed <<\r\nSCU_RAM_AGC_KI_RED_RAGC_RED__B)\r\n& SCU_RAM_AGC_KI_RED_RAGC_RED__M);\r\nstatus = write16(state, SCU_RAM_AGC_KI_RED__A, data);\r\nif (status < 0)\r\ngoto error;\r\nif (is_dvbt(state))\r\np_if_agc_settings = &state->m_dvbt_if_agc_cfg;\r\nelse if (is_qam(state))\r\np_if_agc_settings = &state->m_qam_if_agc_cfg;\r\nelse\r\np_if_agc_settings = &state->m_atv_if_agc_cfg;\r\nif (p_if_agc_settings == NULL) {\r\nstatus = -EINVAL;\r\ngoto error;\r\n}\r\nif (p_if_agc_settings->ctrl_mode == DRXK_AGC_CTRL_AUTO) {\r\nstatus = write16(state,\r\nSCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A,\r\np_agc_cfg->top);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = write16(state, SCU_RAM_AGC_RF_IACCU_HI_CO__A,\r\np_agc_cfg->cut_off_current);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_RF_MAX__A,\r\np_agc_cfg->max_output_level);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase DRXK_AGC_CTRL_USER:\r\nstatus = read16(state, IQM_AF_STDBY__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY;\r\nstatus = write16(state, IQM_AF_STDBY__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_CONFIG__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata |= SCU_RAM_AGC_CONFIG_DISABLE_RF_AGC__M;\r\nif (state->m_rf_agc_pol)\r\ndata |= SCU_RAM_AGC_CONFIG_INV_RF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_CONFIG_INV_RF_POL__M;\r\nstatus = write16(state, SCU_RAM_AGC_CONFIG__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_RF_IACCU_HI_CO__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_RF_IACCU_HI__A,\r\np_agc_cfg->output_level);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase DRXK_AGC_CTRL_OFF:\r\nstatus = read16(state, IQM_AF_STDBY__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata |= IQM_AF_STDBY_STDBY_TAGC_RF_STANDBY;\r\nstatus = write16(state, IQM_AF_STDBY__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_CONFIG__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata |= SCU_RAM_AGC_CONFIG_DISABLE_RF_AGC__M;\r\nstatus = write16(state, SCU_RAM_AGC_CONFIG__A, data);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_agc_if(struct drxk_state *state,\r\nstruct s_cfg_agc *p_agc_cfg, bool is_dtv)\r\n{\r\nu16 data = 0;\r\nint status = 0;\r\nstruct s_cfg_agc *p_rf_agc_settings;\r\ndprintk(1, "\n");\r\nswitch (p_agc_cfg->ctrl_mode) {\r\ncase DRXK_AGC_CTRL_AUTO:\r\nstatus = read16(state, IQM_AF_STDBY__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY;\r\nstatus = write16(state, IQM_AF_STDBY__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_CONFIG__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~SCU_RAM_AGC_CONFIG_DISABLE_IF_AGC__M;\r\nif (state->m_if_agc_pol)\r\ndata |= SCU_RAM_AGC_CONFIG_INV_IF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_CONFIG_INV_IF_POL__M;\r\nstatus = write16(state, SCU_RAM_AGC_CONFIG__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_KI_RED__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~SCU_RAM_AGC_KI_RED_IAGC_RED__M;\r\ndata |= (~(p_agc_cfg->speed <<\r\nSCU_RAM_AGC_KI_RED_IAGC_RED__B)\r\n& SCU_RAM_AGC_KI_RED_IAGC_RED__M);\r\nstatus = write16(state, SCU_RAM_AGC_KI_RED__A, data);\r\nif (status < 0)\r\ngoto error;\r\nif (is_qam(state))\r\np_rf_agc_settings = &state->m_qam_rf_agc_cfg;\r\nelse\r\np_rf_agc_settings = &state->m_atv_rf_agc_cfg;\r\nif (p_rf_agc_settings == NULL)\r\nreturn -1;\r\nstatus = write16(state, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A,\r\np_rf_agc_settings->top);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase DRXK_AGC_CTRL_USER:\r\nstatus = read16(state, IQM_AF_STDBY__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata &= ~IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY;\r\nstatus = write16(state, IQM_AF_STDBY__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_CONFIG__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata |= SCU_RAM_AGC_CONFIG_DISABLE_IF_AGC__M;\r\nif (state->m_if_agc_pol)\r\ndata |= SCU_RAM_AGC_CONFIG_INV_IF_POL__M;\r\nelse\r\ndata &= ~SCU_RAM_AGC_CONFIG_INV_IF_POL__M;\r\nstatus = write16(state, SCU_RAM_AGC_CONFIG__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A,\r\np_agc_cfg->output_level);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase DRXK_AGC_CTRL_OFF:\r\nstatus = read16(state, IQM_AF_STDBY__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata |= IQM_AF_STDBY_STDBY_TAGC_IF_STANDBY;\r\nstatus = write16(state, IQM_AF_STDBY__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_CONFIG__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata |= SCU_RAM_AGC_CONFIG_DISABLE_IF_AGC__M;\r\nstatus = write16(state, SCU_RAM_AGC_CONFIG__A, data);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\n}\r\nstatus = write16(state, SCU_RAM_AGC_INGAIN_TGT_MIN__A, p_agc_cfg->top);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int get_qam_signal_to_noise(struct drxk_state *state,\r\ns32 *p_signal_to_noise)\r\n{\r\nint status = 0;\r\nu16 qam_sl_err_power = 0;\r\nu32 qam_sl_sig_power = 0;\r\nu32 qam_sl_mer = 0;\r\ndprintk(1, "\n");\r\nstatus = read16(state, QAM_SL_ERR_POWER__A, &qam_sl_err_power);\r\nif (status < 0) {\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn -EINVAL;\r\n}\r\nswitch (state->props.modulation) {\r\ncase QAM_16:\r\nqam_sl_sig_power = DRXK_QAM_SL_SIG_POWER_QAM16 << 2;\r\nbreak;\r\ncase QAM_32:\r\nqam_sl_sig_power = DRXK_QAM_SL_SIG_POWER_QAM32 << 2;\r\nbreak;\r\ncase QAM_64:\r\nqam_sl_sig_power = DRXK_QAM_SL_SIG_POWER_QAM64 << 2;\r\nbreak;\r\ncase QAM_128:\r\nqam_sl_sig_power = DRXK_QAM_SL_SIG_POWER_QAM128 << 2;\r\nbreak;\r\ndefault:\r\ncase QAM_256:\r\nqam_sl_sig_power = DRXK_QAM_SL_SIG_POWER_QAM256 << 2;\r\nbreak;\r\n}\r\nif (qam_sl_err_power > 0) {\r\nqam_sl_mer = log10times100(qam_sl_sig_power) -\r\nlog10times100((u32) qam_sl_err_power);\r\n}\r\n*p_signal_to_noise = qam_sl_mer;\r\nreturn status;\r\n}\r\nstatic int get_dvbt_signal_to_noise(struct drxk_state *state,\r\ns32 *p_signal_to_noise)\r\n{\r\nint status;\r\nu16 reg_data = 0;\r\nu32 eq_reg_td_sqr_err_i = 0;\r\nu32 eq_reg_td_sqr_err_q = 0;\r\nu16 eq_reg_td_sqr_err_exp = 0;\r\nu16 eq_reg_td_tps_pwr_ofs = 0;\r\nu16 eq_reg_td_req_smb_cnt = 0;\r\nu32 tps_cnt = 0;\r\nu32 sqr_err_iq = 0;\r\nu32 a = 0;\r\nu32 b = 0;\r\nu32 c = 0;\r\nu32 i_mer = 0;\r\nu16 transmission_params = 0;\r\ndprintk(1, "\n");\r\nstatus = read16(state, OFDM_EQ_TOP_TD_TPS_PWR_OFS__A,\r\n&eq_reg_td_tps_pwr_ofs);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, OFDM_EQ_TOP_TD_REQ_SMB_CNT__A,\r\n&eq_reg_td_req_smb_cnt);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, OFDM_EQ_TOP_TD_SQR_ERR_EXP__A,\r\n&eq_reg_td_sqr_err_exp);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, OFDM_EQ_TOP_TD_SQR_ERR_I__A,\r\n&reg_data);\r\nif (status < 0)\r\ngoto error;\r\neq_reg_td_sqr_err_i = (u32) reg_data;\r\nif ((eq_reg_td_sqr_err_exp > 11) &&\r\n(eq_reg_td_sqr_err_i < 0x00000FFFUL)) {\r\neq_reg_td_sqr_err_i += 0x00010000UL;\r\n}\r\nstatus = read16(state, OFDM_EQ_TOP_TD_SQR_ERR_Q__A, &reg_data);\r\nif (status < 0)\r\ngoto error;\r\neq_reg_td_sqr_err_q = (u32) reg_data;\r\nif ((eq_reg_td_sqr_err_exp > 11) &&\r\n(eq_reg_td_sqr_err_q < 0x00000FFFUL))\r\neq_reg_td_sqr_err_q += 0x00010000UL;\r\nstatus = read16(state, OFDM_SC_RA_RAM_OP_PARAM__A,\r\n&transmission_params);\r\nif (status < 0)\r\ngoto error;\r\nif ((eq_reg_td_tps_pwr_ofs == 0) || (eq_reg_td_req_smb_cnt == 0))\r\ni_mer = 0;\r\nelse if ((eq_reg_td_sqr_err_i + eq_reg_td_sqr_err_q) == 0) {\r\ni_mer = 0;\r\n} else {\r\nsqr_err_iq = (eq_reg_td_sqr_err_i + eq_reg_td_sqr_err_q) <<\r\neq_reg_td_sqr_err_exp;\r\nif ((transmission_params &\r\nOFDM_SC_RA_RAM_OP_PARAM_MODE__M)\r\n== OFDM_SC_RA_RAM_OP_PARAM_MODE_2K)\r\ntps_cnt = 17;\r\nelse\r\ntps_cnt = 68;\r\na = log10times100(eq_reg_td_tps_pwr_ofs *\r\neq_reg_td_tps_pwr_ofs);\r\nb = log10times100(eq_reg_td_req_smb_cnt * tps_cnt);\r\nc = log10times100(sqr_err_iq);\r\ni_mer = a + b - c;\r\n}\r\n*p_signal_to_noise = i_mer;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int get_signal_to_noise(struct drxk_state *state, s32 *p_signal_to_noise)\r\n{\r\ndprintk(1, "\n");\r\n*p_signal_to_noise = 0;\r\nswitch (state->m_operation_mode) {\r\ncase OM_DVBT:\r\nreturn get_dvbt_signal_to_noise(state, p_signal_to_noise);\r\ncase OM_QAM_ITU_A:\r\ncase OM_QAM_ITU_C:\r\nreturn get_qam_signal_to_noise(state, p_signal_to_noise);\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ConfigureI2CBridge(struct drxk_state *state, bool b_enable_bridge)\r\n{\r\nint status = -EINVAL;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn 0;\r\nif (state->m_drxk_state == DRXK_POWERED_DOWN)\r\ngoto error;\r\nif (state->no_i2c_bridge)\r\nreturn 0;\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_1__A,\r\nSIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY);\r\nif (status < 0)\r\ngoto error;\r\nif (b_enable_bridge) {\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_2__A,\r\nSIO_HI_RA_RAM_PAR_2_BRD_CFG_CLOSED);\r\nif (status < 0)\r\ngoto error;\r\n} else {\r\nstatus = write16(state, SIO_HI_RA_RAM_PAR_2__A,\r\nSIO_HI_RA_RAM_PAR_2_BRD_CFG_OPEN);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = hi_command(state, SIO_HI_RA_RAM_CMD_BRDCTRL, NULL);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_pre_saw(struct drxk_state *state,\r\nstruct s_cfg_pre_saw *p_pre_saw_cfg)\r\n{\r\nint status = -EINVAL;\r\ndprintk(1, "\n");\r\nif ((p_pre_saw_cfg == NULL)\r\n|| (p_pre_saw_cfg->reference > IQM_AF_PDREF__M))\r\ngoto error;\r\nstatus = write16(state, IQM_AF_PDREF__A, p_pre_saw_cfg->reference);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int bl_direct_cmd(struct drxk_state *state, u32 target_addr,\r\nu16 rom_offset, u16 nr_of_elements, u32 time_out)\r\n{\r\nu16 bl_status = 0;\r\nu16 offset = (u16) ((target_addr >> 0) & 0x00FFFF);\r\nu16 blockbank = (u16) ((target_addr >> 16) & 0x000FFF);\r\nint status;\r\nunsigned long end;\r\ndprintk(1, "\n");\r\nmutex_lock(&state->mutex);\r\nstatus = write16(state, SIO_BL_MODE__A, SIO_BL_MODE_DIRECT);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_TGT_HDR__A, blockbank);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_TGT_ADDR__A, offset);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_SRC_ADDR__A, rom_offset);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_SRC_LEN__A, nr_of_elements);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_ENABLE__A, SIO_BL_ENABLE_ON);\r\nif (status < 0)\r\ngoto error;\r\nend = jiffies + msecs_to_jiffies(time_out);\r\ndo {\r\nstatus = read16(state, SIO_BL_STATUS__A, &bl_status);\r\nif (status < 0)\r\ngoto error;\r\n} while ((bl_status == 0x1) && time_is_after_jiffies(end));\r\nif (bl_status == 0x1) {\r\npr_err("SIO not ready\n");\r\nstatus = -EINVAL;\r\ngoto error2;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nerror2:\r\nmutex_unlock(&state->mutex);\r\nreturn status;\r\n}\r\nstatic int adc_sync_measurement(struct drxk_state *state, u16 *count)\r\n{\r\nu16 data = 0;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = write16(state, IQM_AF_COMM_EXEC__A, IQM_AF_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_START_LOCK__A, 1);\r\nif (status < 0)\r\ngoto error;\r\n*count = 0;\r\nstatus = read16(state, IQM_AF_PHASE0__A, &data);\r\nif (status < 0)\r\ngoto error;\r\nif (data == 127)\r\n*count = *count + 1;\r\nstatus = read16(state, IQM_AF_PHASE1__A, &data);\r\nif (status < 0)\r\ngoto error;\r\nif (data == 127)\r\n*count = *count + 1;\r\nstatus = read16(state, IQM_AF_PHASE2__A, &data);\r\nif (status < 0)\r\ngoto error;\r\nif (data == 127)\r\n*count = *count + 1;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int adc_synchronization(struct drxk_state *state)\r\n{\r\nu16 count = 0;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = adc_sync_measurement(state, &count);\r\nif (status < 0)\r\ngoto error;\r\nif (count == 1) {\r\nu16 clk_neg = 0;\r\nstatus = read16(state, IQM_AF_CLKNEG__A, &clk_neg);\r\nif (status < 0)\r\ngoto error;\r\nif ((clk_neg & IQM_AF_CLKNEG_CLKNEGDATA__M) ==\r\nIQM_AF_CLKNEG_CLKNEGDATA_CLK_ADC_DATA_POS) {\r\nclk_neg &= (~(IQM_AF_CLKNEG_CLKNEGDATA__M));\r\nclk_neg |=\r\nIQM_AF_CLKNEG_CLKNEGDATA_CLK_ADC_DATA_NEG;\r\n} else {\r\nclk_neg &= (~(IQM_AF_CLKNEG_CLKNEGDATA__M));\r\nclk_neg |=\r\nIQM_AF_CLKNEG_CLKNEGDATA_CLK_ADC_DATA_POS;\r\n}\r\nstatus = write16(state, IQM_AF_CLKNEG__A, clk_neg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = adc_sync_measurement(state, &count);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nif (count < 2)\r\nstatus = -EINVAL;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_frequency_shifter(struct drxk_state *state,\r\nu16 intermediate_freqk_hz,\r\ns32 tuner_freq_offset, bool is_dtv)\r\n{\r\nbool select_pos_image = false;\r\nu32 rf_freq_residual = tuner_freq_offset;\r\nu32 fm_frequency_shift = 0;\r\nbool tuner_mirror = !state->m_b_mirror_freq_spect;\r\nu32 adc_freq;\r\nbool adc_flip;\r\nint status;\r\nu32 if_freq_actual;\r\nu32 sampling_frequency = (u32) (state->m_sys_clock_freq / 3);\r\nu32 frequency_shift;\r\nbool image_to_select;\r\ndprintk(1, "\n");\r\nif (is_dtv) {\r\nif ((state->m_operation_mode == OM_QAM_ITU_A) ||\r\n(state->m_operation_mode == OM_QAM_ITU_C) ||\r\n(state->m_operation_mode == OM_DVBT))\r\nselect_pos_image = true;\r\nelse\r\nselect_pos_image = false;\r\n}\r\nif (tuner_mirror)\r\nif_freq_actual = intermediate_freqk_hz +\r\nrf_freq_residual + fm_frequency_shift;\r\nelse\r\nif_freq_actual = intermediate_freqk_hz -\r\nrf_freq_residual - fm_frequency_shift;\r\nif (if_freq_actual > sampling_frequency / 2) {\r\nadc_freq = sampling_frequency - if_freq_actual;\r\nadc_flip = true;\r\n} else {\r\nadc_freq = if_freq_actual;\r\nadc_flip = false;\r\n}\r\nfrequency_shift = adc_freq;\r\nimage_to_select = state->m_rfmirror ^ tuner_mirror ^\r\nadc_flip ^ select_pos_image;\r\nstate->m_iqm_fs_rate_ofs =\r\nFrac28a((frequency_shift), sampling_frequency);\r\nif (image_to_select)\r\nstate->m_iqm_fs_rate_ofs = ~state->m_iqm_fs_rate_ofs + 1;\r\nstatus = write32(state, IQM_FS_RATE_OFS_LO__A,\r\nstate->m_iqm_fs_rate_ofs);\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int init_agc(struct drxk_state *state, bool is_dtv)\r\n{\r\nu16 ingain_tgt = 0;\r\nu16 ingain_tgt_min = 0;\r\nu16 ingain_tgt_max = 0;\r\nu16 clp_cyclen = 0;\r\nu16 clp_sum_min = 0;\r\nu16 clp_dir_to = 0;\r\nu16 sns_sum_min = 0;\r\nu16 sns_sum_max = 0;\r\nu16 clp_sum_max = 0;\r\nu16 sns_dir_to = 0;\r\nu16 ki_innergain_min = 0;\r\nu16 if_iaccu_hi_tgt = 0;\r\nu16 if_iaccu_hi_tgt_min = 0;\r\nu16 if_iaccu_hi_tgt_max = 0;\r\nu16 data = 0;\r\nu16 fast_clp_ctrl_delay = 0;\r\nu16 clp_ctrl_mode = 0;\r\nint status = 0;\r\ndprintk(1, "\n");\r\nsns_sum_max = 1023;\r\nif_iaccu_hi_tgt_min = 2047;\r\nclp_cyclen = 500;\r\nclp_sum_max = 1023;\r\nif (!is_qam(state)) {\r\npr_err("%s: mode %d is not DVB-C\n",\r\n__func__, state->m_operation_mode);\r\nreturn -EINVAL;\r\n}\r\nclp_sum_min = 8;\r\nclp_dir_to = (u16) -9;\r\nclp_ctrl_mode = 0;\r\nsns_sum_min = 8;\r\nsns_dir_to = (u16) -9;\r\nki_innergain_min = (u16) -1030;\r\nif_iaccu_hi_tgt_max = 0x2380;\r\nif_iaccu_hi_tgt = 0x2380;\r\ningain_tgt_min = 0x0511;\r\ningain_tgt = 0x0511;\r\ningain_tgt_max = 5119;\r\nfast_clp_ctrl_delay = state->m_qam_if_agc_cfg.fast_clip_ctrl_delay;\r\nstatus = write16(state, SCU_RAM_AGC_FAST_CLP_CTRL_DELAY__A,\r\nfast_clp_ctrl_delay);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_CTRL_MODE__A, clp_ctrl_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_INGAIN_TGT__A, ingain_tgt);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_INGAIN_TGT_MIN__A, ingain_tgt_min);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_INGAIN_TGT_MAX__A, ingain_tgt_max);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_IF_IACCU_HI_TGT_MIN__A,\r\nif_iaccu_hi_tgt_min);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A,\r\nif_iaccu_hi_tgt_max);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_IF_IACCU_HI__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_IF_IACCU_LO__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_RF_IACCU_HI__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_RF_IACCU_LO__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_SUM_MAX__A, clp_sum_max);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_SUM_MAX__A, sns_sum_max);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_KI_INNERGAIN_MIN__A,\r\nki_innergain_min);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_IF_IACCU_HI_TGT__A,\r\nif_iaccu_hi_tgt);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_CYCLEN__A, clp_cyclen);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_RF_SNS_DEV_MAX__A, 1023);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_RF_SNS_DEV_MIN__A, (u16) -1023);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_FAST_SNS_CTRL_DELAY__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_KI_MAXMINGAIN_TH__A, 20);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_SUM_MIN__A, clp_sum_min);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_SUM_MIN__A, sns_sum_min);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_DIR_TO__A, clp_dir_to);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_DIR_TO__A, sns_dir_to);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_KI_MINGAIN__A, 0x7fff);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_KI_MAXGAIN__A, 0x0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_KI_MIN__A, 0x0117);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_KI_MAX__A, 0x0657);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_SUM__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_CYCCNT__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_DIR_WD__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_CLP_DIR_STP__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_SUM__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_CYCCNT__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_DIR_WD__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_DIR_STP__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_SNS_CYCLEN__A, 500);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_KI_CYCLEN__A, 500);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SCU_RAM_AGC_KI__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata = 0x0657;\r\ndata &= ~SCU_RAM_AGC_KI_RF__M;\r\ndata |= (DRXK_KI_RAGC_QAM << SCU_RAM_AGC_KI_RF__B);\r\ndata &= ~SCU_RAM_AGC_KI_IF__M;\r\ndata |= (DRXK_KI_IAGC_QAM << SCU_RAM_AGC_KI_IF__B);\r\nstatus = write16(state, SCU_RAM_AGC_KI__A, data);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbtqam_get_acc_pkt_err(struct drxk_state *state, u16 *packet_err)\r\n{\r\nint status;\r\ndprintk(1, "\n");\r\nif (packet_err == NULL)\r\nstatus = write16(state, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, 0);\r\nelse\r\nstatus = read16(state, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A,\r\npacket_err);\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbt_sc_command(struct drxk_state *state,\r\nu16 cmd, u16 subcmd,\r\nu16 param0, u16 param1, u16 param2,\r\nu16 param3, u16 param4)\r\n{\r\nu16 cur_cmd = 0;\r\nu16 err_code = 0;\r\nu16 retry_cnt = 0;\r\nu16 sc_exec = 0;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = read16(state, OFDM_SC_COMM_EXEC__A, &sc_exec);\r\nif (sc_exec != 1) {\r\nstatus = -EINVAL;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nretry_cnt = 0;\r\ndo {\r\nusleep_range(1000, 2000);\r\nstatus = read16(state, OFDM_SC_RA_RAM_CMD__A, &cur_cmd);\r\nretry_cnt++;\r\n} while ((cur_cmd != 0) && (retry_cnt < DRXK_MAX_RETRIES));\r\nif (retry_cnt >= DRXK_MAX_RETRIES && (status < 0))\r\ngoto error;\r\nswitch (cmd) {\r\ncase OFDM_SC_RA_RAM_CMD_PROC_START:\r\ncase OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM:\r\ncase OFDM_SC_RA_RAM_CMD_PROGRAM_PARAM:\r\nstatus = write16(state, OFDM_SC_RA_RAM_CMD_ADDR__A, subcmd);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (cmd) {\r\ncase OFDM_SC_RA_RAM_CMD_PROC_START:\r\ncase OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM:\r\ncase OFDM_SC_RA_RAM_CMD_PROGRAM_PARAM:\r\nstatus = write16(state, OFDM_SC_RA_RAM_PARAM1__A, param1);\r\ncase OFDM_SC_RA_RAM_CMD_SET_ECHO_TIMING:\r\ncase OFDM_SC_RA_RAM_CMD_USER_IO:\r\nstatus = write16(state, OFDM_SC_RA_RAM_PARAM0__A, param0);\r\ncase OFDM_SC_RA_RAM_CMD_GET_OP_PARAM:\r\ncase OFDM_SC_RA_RAM_CMD_NULL:\r\nstatus = write16(state, OFDM_SC_RA_RAM_CMD__A, cmd);\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nretry_cnt = 0;\r\ndo {\r\nusleep_range(1000, 2000);\r\nstatus = read16(state, OFDM_SC_RA_RAM_CMD__A, &cur_cmd);\r\nretry_cnt++;\r\n} while ((cur_cmd != 0) && (retry_cnt < DRXK_MAX_RETRIES));\r\nif (retry_cnt >= DRXK_MAX_RETRIES && (status < 0))\r\ngoto error;\r\nstatus = read16(state, OFDM_SC_RA_RAM_CMD_ADDR__A, &err_code);\r\nif (err_code == 0xFFFF) {\r\nstatus = -EINVAL;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nswitch (cmd) {\r\ncase OFDM_SC_RA_RAM_CMD_USER_IO:\r\ncase OFDM_SC_RA_RAM_CMD_GET_OP_PARAM:\r\nstatus = read16(state, OFDM_SC_RA_RAM_PARAM0__A, &(param0));\r\ncase OFDM_SC_RA_RAM_CMD_SET_ECHO_TIMING:\r\ncase OFDM_SC_RA_RAM_CMD_SET_TIMER:\r\ncase OFDM_SC_RA_RAM_CMD_PROC_START:\r\ncase OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM:\r\ncase OFDM_SC_RA_RAM_CMD_PROGRAM_PARAM:\r\ncase OFDM_SC_RA_RAM_CMD_NULL:\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\nbreak;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int power_up_dvbt(struct drxk_state *state)\r\n{\r\nenum drx_power_mode power_mode = DRX_POWER_UP;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = ctrl_power_mode(state, &power_mode);\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbt_ctrl_set_inc_enable(struct drxk_state *state, bool *enabled)\r\n{\r\nint status;\r\ndprintk(1, "\n");\r\nif (*enabled)\r\nstatus = write16(state, IQM_CF_BYPASSDET__A, 0);\r\nelse\r\nstatus = write16(state, IQM_CF_BYPASSDET__A, 1);\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbt_ctrl_set_fr_enable(struct drxk_state *state, bool *enabled)\r\n{\r\nint status;\r\ndprintk(1, "\n");\r\nif (*enabled) {\r\nstatus = write16(state, OFDM_SC_RA_RAM_FR_THRES_8K__A,\r\nDEFAULT_FR_THRES_8K);\r\n} else {\r\nstatus = write16(state, OFDM_SC_RA_RAM_FR_THRES_8K__A, 0);\r\n}\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbt_ctrl_set_echo_threshold(struct drxk_state *state,\r\nstruct drxk_cfg_dvbt_echo_thres_t *echo_thres)\r\n{\r\nu16 data = 0;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = read16(state, OFDM_SC_RA_RAM_ECHO_THRES__A, &data);\r\nif (status < 0)\r\ngoto error;\r\nswitch (echo_thres->fft_mode) {\r\ncase DRX_FFTMODE_2K:\r\ndata &= ~OFDM_SC_RA_RAM_ECHO_THRES_2K__M;\r\ndata |= ((echo_thres->threshold <<\r\nOFDM_SC_RA_RAM_ECHO_THRES_2K__B)\r\n& (OFDM_SC_RA_RAM_ECHO_THRES_2K__M));\r\nbreak;\r\ncase DRX_FFTMODE_8K:\r\ndata &= ~OFDM_SC_RA_RAM_ECHO_THRES_8K__M;\r\ndata |= ((echo_thres->threshold <<\r\nOFDM_SC_RA_RAM_ECHO_THRES_8K__B)\r\n& (OFDM_SC_RA_RAM_ECHO_THRES_8K__M));\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nstatus = write16(state, OFDM_SC_RA_RAM_ECHO_THRES__A, data);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbt_ctrl_set_sqi_speed(struct drxk_state *state,\r\nenum drxk_cfg_dvbt_sqi_speed *speed)\r\n{\r\nint status = -EINVAL;\r\ndprintk(1, "\n");\r\nswitch (*speed) {\r\ncase DRXK_DVBT_SQI_SPEED_FAST:\r\ncase DRXK_DVBT_SQI_SPEED_MEDIUM:\r\ncase DRXK_DVBT_SQI_SPEED_SLOW:\r\nbreak;\r\ndefault:\r\ngoto error;\r\n}\r\nstatus = write16(state, SCU_RAM_FEC_PRE_RS_BER_FILTER_SH__A,\r\n(u16) *speed);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbt_activate_presets(struct drxk_state *state)\r\n{\r\nint status;\r\nbool setincenable = false;\r\nbool setfrenable = true;\r\nstruct drxk_cfg_dvbt_echo_thres_t echo_thres2k = { 0, DRX_FFTMODE_2K };\r\nstruct drxk_cfg_dvbt_echo_thres_t echo_thres8k = { 0, DRX_FFTMODE_8K };\r\ndprintk(1, "\n");\r\nstatus = dvbt_ctrl_set_inc_enable(state, &setincenable);\r\nif (status < 0)\r\ngoto error;\r\nstatus = dvbt_ctrl_set_fr_enable(state, &setfrenable);\r\nif (status < 0)\r\ngoto error;\r\nstatus = dvbt_ctrl_set_echo_threshold(state, &echo_thres2k);\r\nif (status < 0)\r\ngoto error;\r\nstatus = dvbt_ctrl_set_echo_threshold(state, &echo_thres8k);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_AGC_INGAIN_TGT_MAX__A,\r\nstate->m_dvbt_if_agc_cfg.ingain_tgt_max);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_dvbt_standard(struct drxk_state *state,\r\nenum operation_mode o_mode)\r\n{\r\nu16 cmd_result = 0;\r\nu16 data = 0;\r\nint status;\r\ndprintk(1, "\n");\r\npower_up_dvbt(state);\r\nswitch_antenna_to_dvbt(state);\r\nstatus = scu_command(state,\r\nSCU_RAM_COMMAND_STANDARD_OFDM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_RESET,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\nstatus = scu_command(state, SCU_RAM_COMMAND_STANDARD_OFDM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_SET_ENV,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_COMM_EXEC__A, OFDM_SC_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_LC_COMM_EXEC__A, OFDM_LC_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_COMM_EXEC__A, IQM_COMM_EXEC_B_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_UPD_SEL__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_CLP_LEN__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_SNS_LEN__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_AMUX__A, IQM_AF_AMUX_SIGNAL2ADC);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_iqm_af(state, true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_AGC_RF__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_INC_LCT__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_DET_LCT__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_WND_LEN__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_RC_STRETCH__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_OUT_ENA__A, 0x4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_DS_ENA__A, 0x4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_SCALE__A, 1600);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_SCALE_SH__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_CLP_TH__A, 448);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_DATATH__A, 495);\r\nif (status < 0)\r\ngoto error;\r\nstatus = bl_chain_cmd(state, DRXK_BL_ROM_OFFSET_TAPS_DVBT,\r\nDRXK_BLCC_NR_ELEMENTS_TAPS, DRXK_BLC_TIMEOUT);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_PKDTH__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_POW_MEAS_LEN__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_COMM_INT_MSK__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_COMM_EXEC__A, IQM_COMM_EXEC_B_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = adc_synchronization(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_pre_saw(state, &state->m_dvbt_pre_saw_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_HOLD);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_agc_rf(state, &state->m_dvbt_rf_agc_cfg, true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_agc_if(state, &state->m_dvbt_if_agc_cfg, true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, OFDM_SC_RA_RAM_CONFIG__A, &data);\r\nif (status < 0)\r\ngoto error;\r\ndata |= OFDM_SC_RA_RAM_CONFIG_NE_FIX_ENABLE__M;\r\nstatus = write16(state, OFDM_SC_RA_RAM_CONFIG__A, data);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nif (!state->m_drxk_a3_rom_code) {\r\nstatus = write16(state, SCU_RAM_AGC_FAST_CLP_CTRL_DELAY__A,\r\nstate->m_dvbt_if_agc_cfg.fast_clip_ctrl_delay);\r\nif (status < 0)\r\ngoto error;\r\n}\r\n#ifdef COMPILE_FOR_NONRT\r\nstatus = write16(state, OFDM_SC_RA_RAM_BE_OPT_DELAY__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_BE_OPT_INIT_DELAY__A, 2);\r\nif (status < 0)\r\ngoto error;\r\n#endif\r\nstatus = write16(state, FEC_DI_INPUT_CTL__A, 1);\r\nif (status < 0)\r\ngoto error;\r\n#ifdef COMPILE_FOR_NONRT\r\nstatus = write16(state, FEC_RS_MEASUREMENT_PERIOD__A, 0x400);\r\nif (status < 0)\r\ngoto error;\r\n#else\r\nstatus = write16(state, FEC_RS_MEASUREMENT_PERIOD__A, 0x1000);\r\nif (status < 0)\r\ngoto error;\r\n#endif\r\nstatus = write16(state, FEC_RS_MEASUREMENT_PRESCALE__A, 0x0001);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_dto_setup(state, OM_DVBT);\r\nif (status < 0)\r\ngoto error;\r\nstatus = dvbt_activate_presets(state);\r\nif (status < 0)\r\ngoto error;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int dvbt_start(struct drxk_state *state)\r\n{\r\nu16 param1;\r\nint status;\r\ndprintk(1, "\n");\r\nparam1 = OFDM_SC_RA_RAM_LOCKTRACK_MIN;\r\nstatus = dvbt_sc_command(state, OFDM_SC_RA_RAM_CMD_PROC_START, 0,\r\nOFDM_SC_RA_RAM_SW_EVENT_RUN_NMASK__M, param1,\r\n0, 0, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_start(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_COMM_EXEC__A, FEC_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_dvbt(struct drxk_state *state, u16 intermediate_freqk_hz,\r\ns32 tuner_freq_offset)\r\n{\r\nu16 cmd_result = 0;\r\nu16 transmission_params = 0;\r\nu16 operation_mode = 0;\r\nu32 iqm_rc_rate_ofs = 0;\r\nu32 bandwidth = 0;\r\nu16 param1;\r\nint status;\r\ndprintk(1, "IF =%d, TFO = %d\n",\r\nintermediate_freqk_hz, tuner_freq_offset);\r\nstatus = scu_command(state, SCU_RAM_COMMAND_STANDARD_OFDM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_STOP,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_HOLD);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_COMM_EXEC__A, OFDM_SC_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_LC_COMM_EXEC__A, OFDM_LC_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_CP_COMM_EXEC__A, OFDM_CP_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nswitch (state->props.transmission_mode) {\r\ncase TRANSMISSION_MODE_AUTO:\r\ndefault:\r\noperation_mode |= OFDM_SC_RA_RAM_OP_AUTO_MODE__M;\r\ncase TRANSMISSION_MODE_8K:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_MODE_8K;\r\nbreak;\r\ncase TRANSMISSION_MODE_2K:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_MODE_2K;\r\nbreak;\r\n}\r\nswitch (state->props.guard_interval) {\r\ndefault:\r\ncase GUARD_INTERVAL_AUTO:\r\noperation_mode |= OFDM_SC_RA_RAM_OP_AUTO_GUARD__M;\r\ncase GUARD_INTERVAL_1_4:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_GUARD_4;\r\nbreak;\r\ncase GUARD_INTERVAL_1_32:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_GUARD_32;\r\nbreak;\r\ncase GUARD_INTERVAL_1_16:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_GUARD_16;\r\nbreak;\r\ncase GUARD_INTERVAL_1_8:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_GUARD_8;\r\nbreak;\r\n}\r\nswitch (state->props.hierarchy) {\r\ncase HIERARCHY_AUTO:\r\ncase HIERARCHY_NONE:\r\ndefault:\r\noperation_mode |= OFDM_SC_RA_RAM_OP_AUTO_HIER__M;\r\ncase HIERARCHY_1:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_HIER_A1;\r\nbreak;\r\ncase HIERARCHY_2:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_HIER_A2;\r\nbreak;\r\ncase HIERARCHY_4:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_HIER_A4;\r\nbreak;\r\n}\r\nswitch (state->props.modulation) {\r\ncase QAM_AUTO:\r\ndefault:\r\noperation_mode |= OFDM_SC_RA_RAM_OP_AUTO_CONST__M;\r\ncase QAM_64:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_CONST_QAM64;\r\nbreak;\r\ncase QPSK:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_CONST_QPSK;\r\nbreak;\r\ncase QAM_16:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_CONST_QAM16;\r\nbreak;\r\n}\r\n#if 0\r\nswitch (channel->priority) {\r\ncase DRX_PRIORITY_LOW:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_PRIO_LO;\r\nWR16(dev_addr, OFDM_EC_SB_PRIOR__A,\r\nOFDM_EC_SB_PRIOR_LO);\r\nbreak;\r\ncase DRX_PRIORITY_HIGH:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_PRIO_HI;\r\nWR16(dev_addr, OFDM_EC_SB_PRIOR__A,\r\nOFDM_EC_SB_PRIOR_HI));\r\nbreak;\r\ncase DRX_PRIORITY_UNKNOWN:\r\ndefault:\r\nstatus = -EINVAL;\r\ngoto error;\r\n}\r\n#else\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_PRIO_HI;\r\nstatus = write16(state, OFDM_EC_SB_PRIOR__A, OFDM_EC_SB_PRIOR_HI);\r\nif (status < 0)\r\ngoto error;\r\n#endif\r\nswitch (state->props.code_rate_HP) {\r\ncase FEC_AUTO:\r\ndefault:\r\noperation_mode |= OFDM_SC_RA_RAM_OP_AUTO_RATE__M;\r\ncase FEC_2_3:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_RATE_2_3;\r\nbreak;\r\ncase FEC_1_2:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_RATE_1_2;\r\nbreak;\r\ncase FEC_3_4:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_RATE_3_4;\r\nbreak;\r\ncase FEC_5_6:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_RATE_5_6;\r\nbreak;\r\ncase FEC_7_8:\r\ntransmission_params |= OFDM_SC_RA_RAM_OP_PARAM_RATE_7_8;\r\nbreak;\r\n}\r\nswitch (state->props.bandwidth_hz) {\r\ncase 0:\r\nstate->props.bandwidth_hz = 8000000;\r\ncase 8000000:\r\nbandwidth = DRXK_BANDWIDTH_8MHZ_IN_HZ;\r\nstatus = write16(state, OFDM_SC_RA_RAM_SRMM_FIX_FACT_8K__A,\r\n3052);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_8K_PER_LEFT__A,\r\n7);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_8K_PER_RIGHT__A,\r\n7);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_2K_PER_LEFT__A,\r\n7);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_2K_PER_RIGHT__A,\r\n1);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase 7000000:\r\nbandwidth = DRXK_BANDWIDTH_7MHZ_IN_HZ;\r\nstatus = write16(state, OFDM_SC_RA_RAM_SRMM_FIX_FACT_8K__A,\r\n3491);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_8K_PER_LEFT__A,\r\n8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_8K_PER_RIGHT__A,\r\n8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_2K_PER_LEFT__A,\r\n4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_2K_PER_RIGHT__A,\r\n1);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ncase 6000000:\r\nbandwidth = DRXK_BANDWIDTH_6MHZ_IN_HZ;\r\nstatus = write16(state, OFDM_SC_RA_RAM_SRMM_FIX_FACT_8K__A,\r\n4073);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_8K_PER_LEFT__A,\r\n19);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_8K_PER_RIGHT__A,\r\n19);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_2K_PER_LEFT__A,\r\n14);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_RA_RAM_NI_INIT_2K_PER_RIGHT__A,\r\n1);\r\nif (status < 0)\r\ngoto error;\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\ngoto error;\r\n}\r\nif (iqm_rc_rate_ofs == 0) {\r\niqm_rc_rate_ofs = Frac28a((u32)\r\n((state->m_sys_clock_freq *\r\n1000) / 3), bandwidth);\r\nif ((iqm_rc_rate_ofs & 0x7fL) >= 0x40)\r\niqm_rc_rate_ofs += 0x80L;\r\niqm_rc_rate_ofs = iqm_rc_rate_ofs >> 7;\r\niqm_rc_rate_ofs = iqm_rc_rate_ofs - (1 << 23);\r\n}\r\niqm_rc_rate_ofs &=\r\n((((u32) IQM_RC_RATE_OFS_HI__M) <<\r\nIQM_RC_RATE_OFS_LO__W) | IQM_RC_RATE_OFS_LO__M);\r\nstatus = write32(state, IQM_RC_RATE_OFS_LO__A, iqm_rc_rate_ofs);\r\nif (status < 0)\r\ngoto error;\r\n#if 0\r\nstatus = dvbt_set_frequency_shift(demod, channel, tuner_offset);\r\nif (status < 0)\r\ngoto error;\r\n#endif\r\nstatus = set_frequency_shifter(state, intermediate_freqk_hz,\r\ntuner_freq_offset, true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_COMM_STATE__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, OFDM_SC_COMM_EXEC__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = scu_command(state, SCU_RAM_COMMAND_STANDARD_OFDM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_START,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\nparam1 = (OFDM_SC_RA_RAM_OP_AUTO_MODE__M |\r\nOFDM_SC_RA_RAM_OP_AUTO_GUARD__M |\r\nOFDM_SC_RA_RAM_OP_AUTO_CONST__M |\r\nOFDM_SC_RA_RAM_OP_AUTO_HIER__M |\r\nOFDM_SC_RA_RAM_OP_AUTO_RATE__M);\r\nstatus = dvbt_sc_command(state, OFDM_SC_RA_RAM_CMD_SET_PREF_PARAM,\r\n0, transmission_params, param1, 0, 0, 0);\r\nif (status < 0)\r\ngoto error;\r\nif (!state->m_drxk_a3_rom_code)\r\nstatus = dvbt_ctrl_set_sqi_speed(state, &state->m_sqi_speed);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int get_dvbt_lock_status(struct drxk_state *state, u32 *p_lock_status)\r\n{\r\nint status;\r\nconst u16 mpeg_lock_mask = (OFDM_SC_RA_RAM_LOCK_MPEG__M |\r\nOFDM_SC_RA_RAM_LOCK_FEC__M);\r\nconst u16 fec_lock_mask = (OFDM_SC_RA_RAM_LOCK_FEC__M);\r\nconst u16 demod_lock_mask = OFDM_SC_RA_RAM_LOCK_DEMOD__M;\r\nu16 sc_ra_ram_lock = 0;\r\nu16 sc_comm_exec = 0;\r\ndprintk(1, "\n");\r\n*p_lock_status = NOT_LOCKED;\r\nstatus = read16(state, OFDM_SC_COMM_EXEC__A, &sc_comm_exec);\r\nif (status < 0)\r\ngoto end;\r\nif (sc_comm_exec == OFDM_SC_COMM_EXEC_STOP)\r\ngoto end;\r\nstatus = read16(state, OFDM_SC_RA_RAM_LOCK__A, &sc_ra_ram_lock);\r\nif (status < 0)\r\ngoto end;\r\nif ((sc_ra_ram_lock & mpeg_lock_mask) == mpeg_lock_mask)\r\n*p_lock_status = MPEG_LOCK;\r\nelse if ((sc_ra_ram_lock & fec_lock_mask) == fec_lock_mask)\r\n*p_lock_status = FEC_LOCK;\r\nelse if ((sc_ra_ram_lock & demod_lock_mask) == demod_lock_mask)\r\n*p_lock_status = DEMOD_LOCK;\r\nelse if (sc_ra_ram_lock & OFDM_SC_RA_RAM_LOCK_NODVBT__M)\r\n*p_lock_status = NEVER_LOCK;\r\nend:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int power_up_qam(struct drxk_state *state)\r\n{\r\nenum drx_power_mode power_mode = DRXK_POWER_DOWN_OFDM;\r\nint status;\r\ndprintk(1, "\n");\r\nstatus = ctrl_power_mode(state, &power_mode);\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int power_down_qam(struct drxk_state *state)\r\n{\r\nu16 data = 0;\r\nu16 cmd_result;\r\nint status = 0;\r\ndprintk(1, "\n");\r\nstatus = read16(state, SCU_COMM_EXEC__A, &data);\r\nif (status < 0)\r\ngoto error;\r\nif (data == SCU_COMM_EXEC_ACTIVE) {\r\nstatus = write16(state, QAM_COMM_EXEC__A, QAM_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = scu_command(state, SCU_RAM_COMMAND_STANDARD_QAM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_STOP,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = set_iqm_af(state, false);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam_measurement(struct drxk_state *state,\r\nenum e_drxk_constellation modulation,\r\nu32 symbol_rate)\r\n{\r\nu32 fec_bits_desired = 0;\r\nu32 fec_rs_period_total = 0;\r\nu16 fec_rs_prescale = 0;\r\nu16 fec_rs_period = 0;\r\nint status = 0;\r\ndprintk(1, "\n");\r\nfec_rs_prescale = 1;\r\nswitch (modulation) {\r\ncase DRX_CONSTELLATION_QAM16:\r\nfec_bits_desired = 4 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM32:\r\nfec_bits_desired = 5 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM64:\r\nfec_bits_desired = 6 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM128:\r\nfec_bits_desired = 7 * symbol_rate;\r\nbreak;\r\ncase DRX_CONSTELLATION_QAM256:\r\nfec_bits_desired = 8 * symbol_rate;\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nfec_bits_desired /= 1000;\r\nfec_bits_desired *= 500;\r\nfec_rs_period_total = (fec_bits_desired / 1632UL) + 1;\r\nfec_rs_prescale = 1 + (u16) (fec_rs_period_total >> 16);\r\nif (fec_rs_prescale == 0) {\r\nstatus = -EINVAL;\r\nif (status < 0)\r\ngoto error;\r\n}\r\nfec_rs_period =\r\n((u16) fec_rs_period_total +\r\n(fec_rs_prescale >> 1)) / fec_rs_prescale;\r\nstatus = write16(state, FEC_RS_MEASUREMENT_PERIOD__A, fec_rs_period);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_RS_MEASUREMENT_PRESCALE__A,\r\nfec_rs_prescale);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_OC_SNC_FAIL_PERIOD__A, fec_rs_period);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam16(struct drxk_state *state)\r\n{\r\nint status = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD0__A, 13517);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD1__A, 13517);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD2__A, 13517);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD3__A, 13517);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD4__A, 13517);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD5__A, 13517);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN0__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN1__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN2__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN3__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN4__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN5__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_HWM__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_AWM__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_LWM__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_SL_SIG_POWER__A,\r\nDRXK_QAM_SL_SIG_POWER_QAM16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_FINE__A, 15);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_COARSE__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_COARSE__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_COARSE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_MEDIUM__A, 20);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_COARSE__A, 80);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_MEDIUM__A, 20);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_COARSE__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_FINE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_MEDIUM__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_COARSE__A, 32);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_COARSE__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RTH__A, 140);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FTH__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_CTH__A, 95);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_PTH__A, 120);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_QTH__A, 230);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MTH__A, 105);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RATE_LIM__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_COUNT_LIM__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FREQ_LIM__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, (u16) 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, (u16) 220);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, (u16) 25);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, (u16) 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16) -24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16) -65);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16) -127);\r\nif (status < 0)\r\ngoto error;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam32(struct drxk_state *state)\r\n{\r\nint status = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD0__A, 6707);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD1__A, 6707);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD2__A, 6707);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD3__A, 6707);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD4__A, 6707);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD5__A, 6707);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN0__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN1__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN2__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN3__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN4__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN5__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_HWM__A, 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_AWM__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_LWM__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_SL_SIG_POWER__A,\r\nDRXK_QAM_SL_SIG_POWER_QAM32);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_FINE__A, 15);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_COARSE__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_COARSE__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_COARSE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_MEDIUM__A, 20);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_COARSE__A, 80);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_MEDIUM__A, 20);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_COARSE__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_FINE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_MEDIUM__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_COARSE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_COARSE__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RTH__A, 90);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FTH__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_CTH__A, 80);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_PTH__A, 100);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_QTH__A, 170);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MTH__A, 100);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RATE_LIM__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_COUNT_LIM__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FREQ_LIM__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, (u16) 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, (u16) 140);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, (u16) -8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, (u16) -16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16) -26);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16) -56);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16) -86);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam64(struct drxk_state *state)\r\n{\r\nint status = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD0__A, 13336);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD1__A, 12618);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD2__A, 11988);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD3__A, 13809);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD4__A, 13809);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD5__A, 15609);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN0__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN1__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN2__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN3__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN4__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN5__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_HWM__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_AWM__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_LWM__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_SL_SIG_POWER__A,\r\nDRXK_QAM_SL_SIG_POWER_QAM64);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_FINE__A, 15);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_COARSE__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_COARSE__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_COARSE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_MEDIUM__A, 30);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_COARSE__A, 100);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_MEDIUM__A, 30);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_COARSE__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_FINE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_MEDIUM__A, 25);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_COARSE__A, 48);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_COARSE__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RTH__A, 100);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FTH__A, 60);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_CTH__A, 80);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_PTH__A, 110);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_QTH__A, 200);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MTH__A, 95);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RATE_LIM__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_COUNT_LIM__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FREQ_LIM__A, 15);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, (u16) 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, (u16) 141);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, (u16) 7);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, (u16) 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16) -15);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16) -45);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16) -80);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam128(struct drxk_state *state)\r\n{\r\nint status = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD0__A, 6564);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD1__A, 6598);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD2__A, 6394);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD3__A, 6409);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD4__A, 6656);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD5__A, 7238);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN0__A, 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN1__A, 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN2__A, 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN3__A, 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN4__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN5__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_HWM__A, 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_AWM__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_LWM__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_SL_SIG_POWER__A,\r\nDRXK_QAM_SL_SIG_POWER_QAM128);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_FINE__A, 15);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_COARSE__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_COARSE__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_COARSE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_MEDIUM__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_COARSE__A, 120);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_MEDIUM__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_COARSE__A, 60);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_FINE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_MEDIUM__A, 25);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_COARSE__A, 64);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_COARSE__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RTH__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FTH__A, 60);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_CTH__A, 80);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_PTH__A, 100);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_QTH__A, 140);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MTH__A, 100);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RATE_LIM__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_COUNT_LIM__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FREQ_LIM__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, (u16) 8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, (u16) 65);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, (u16) 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, (u16) 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16) -1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16) -12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16) -23);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam256(struct drxk_state *state)\r\n{\r\nint status = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD0__A, 11502);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD1__A, 12084);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD2__A, 12543);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD3__A, 12931);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD4__A, 13629);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_EQ_CMA_RAD5__A, 15385);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN0__A, 8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN1__A, 8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN2__A, 8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN3__A, 8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN4__A, 6);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_DQ_QUAL_FUN5__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_HWM__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_AWM__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SYNC_LWM__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_SL_SIG_POWER__A,\r\nDRXK_QAM_SL_SIG_POWER_QAM256);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_FINE__A, 15);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CA_COARSE__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EP_COARSE__A, 24);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_FINE__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_EI_COARSE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_MEDIUM__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CP_COARSE__A, 250);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_MEDIUM__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CI_COARSE__A, 125);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_FINE__A, 16);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_MEDIUM__A, 25);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF_COARSE__A, 48);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_FINE__A, 5);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_LC_CF1_COARSE__A, 10);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RTH__A, 50);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FTH__A, 60);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_CTH__A, 80);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_PTH__A, 100);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_QTH__A, 150);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MTH__A, 110);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RATE_LIM__A, 40);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_COUNT_LIM__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_FREQ_LIM__A, 12);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, (u16) 8);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, (u16) 74);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, (u16) 18);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, (u16) 13);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16) 7);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16) 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16) -8);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int qam_reset_qam(struct drxk_state *state)\r\n{\r\nint status;\r\nu16 cmd_result;\r\ndprintk(1, "\n");\r\nstatus = write16(state, QAM_COMM_EXEC__A, QAM_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = scu_command(state, SCU_RAM_COMMAND_STANDARD_QAM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_RESET,\r\n0, NULL, 1, &cmd_result);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int qam_set_symbolrate(struct drxk_state *state)\r\n{\r\nu32 adc_frequency = 0;\r\nu32 symb_freq = 0;\r\nu32 iqm_rc_rate = 0;\r\nu16 ratesel = 0;\r\nu32 lc_symb_rate = 0;\r\nint status;\r\ndprintk(1, "\n");\r\nadc_frequency = (state->m_sys_clock_freq * 1000) / 3;\r\nratesel = 0;\r\nif (state->props.symbol_rate <= 1188750)\r\nratesel = 3;\r\nelse if (state->props.symbol_rate <= 2377500)\r\nratesel = 2;\r\nelse if (state->props.symbol_rate <= 4755000)\r\nratesel = 1;\r\nstatus = write16(state, IQM_FD_RATESEL__A, ratesel);\r\nif (status < 0)\r\ngoto error;\r\nsymb_freq = state->props.symbol_rate * (1 << ratesel);\r\nif (symb_freq == 0) {\r\nstatus = -EINVAL;\r\ngoto error;\r\n}\r\niqm_rc_rate = (adc_frequency / symb_freq) * (1 << 21) +\r\n(Frac28a((adc_frequency % symb_freq), symb_freq) >> 7) -\r\n(1 << 23);\r\nstatus = write32(state, IQM_RC_RATE_OFS_LO__A, iqm_rc_rate);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_iqm_rc_rate = iqm_rc_rate;\r\nsymb_freq = state->props.symbol_rate;\r\nif (adc_frequency == 0) {\r\nstatus = -EINVAL;\r\ngoto error;\r\n}\r\nlc_symb_rate = (symb_freq / adc_frequency) * (1 << 12) +\r\n(Frac28a((symb_freq % adc_frequency), adc_frequency) >>\r\n16);\r\nif (lc_symb_rate > 511)\r\nlc_symb_rate = 511;\r\nstatus = write16(state, QAM_LC_SYMBOL_FREQ__A, (u16) lc_symb_rate);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int get_qam_lock_status(struct drxk_state *state, u32 *p_lock_status)\r\n{\r\nint status;\r\nu16 result[2] = { 0, 0 };\r\ndprintk(1, "\n");\r\n*p_lock_status = NOT_LOCKED;\r\nstatus = scu_command(state,\r\nSCU_RAM_COMMAND_STANDARD_QAM |\r\nSCU_RAM_COMMAND_CMD_DEMOD_GET_LOCK, 0, NULL, 2,\r\nresult);\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nif (result[1] < SCU_RAM_QAM_LOCKED_LOCKED_DEMOD_LOCKED) {\r\n} else if (result[1] < SCU_RAM_QAM_LOCKED_LOCKED_LOCKED) {\r\n*p_lock_status = DEMOD_LOCK;\r\n} else if (result[1] < SCU_RAM_QAM_LOCKED_LOCKED_NEVER_LOCK) {\r\n*p_lock_status = MPEG_LOCK;\r\n} else {\r\n*p_lock_status = NEVER_LOCK;\r\n}\r\nreturn status;\r\n}\r\nstatic int qam_demodulator_command(struct drxk_state *state,\r\nint number_of_parameters)\r\n{\r\nint status;\r\nu16 cmd_result;\r\nu16 set_param_parameters[4] = { 0, 0, 0, 0 };\r\nset_param_parameters[0] = state->m_constellation;\r\nset_param_parameters[1] = DRXK_QAM_I12_J17;\r\nif (number_of_parameters == 2) {\r\nu16 set_env_parameters[1] = { 0 };\r\nif (state->m_operation_mode == OM_QAM_ITU_C)\r\nset_env_parameters[0] = QAM_TOP_ANNEX_C;\r\nelse\r\nset_env_parameters[0] = QAM_TOP_ANNEX_A;\r\nstatus = scu_command(state,\r\nSCU_RAM_COMMAND_STANDARD_QAM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_SET_ENV,\r\n1, set_env_parameters, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\nstatus = scu_command(state,\r\nSCU_RAM_COMMAND_STANDARD_QAM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM,\r\nnumber_of_parameters, set_param_parameters,\r\n1, &cmd_result);\r\n} else if (number_of_parameters == 4) {\r\nif (state->m_operation_mode == OM_QAM_ITU_C)\r\nset_param_parameters[2] = QAM_TOP_ANNEX_C;\r\nelse\r\nset_param_parameters[2] = QAM_TOP_ANNEX_A;\r\nset_param_parameters[3] |= (QAM_MIRROR_AUTO_ON);\r\nstatus = scu_command(state,\r\nSCU_RAM_COMMAND_STANDARD_QAM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM,\r\nnumber_of_parameters, set_param_parameters,\r\n1, &cmd_result);\r\n} else {\r\npr_warn("Unknown QAM demodulator parameter count %d\n",\r\nnumber_of_parameters);\r\nstatus = -EINVAL;\r\n}\r\nerror:\r\nif (status < 0)\r\npr_warn("Warning %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam(struct drxk_state *state, u16 intermediate_freqk_hz,\r\ns32 tuner_freq_offset)\r\n{\r\nint status;\r\nu16 cmd_result;\r\nint qam_demod_param_count = state->qam_demod_parameter_count;\r\ndprintk(1, "\n");\r\nstatus = write16(state, FEC_DI_COMM_EXEC__A, FEC_DI_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_RS_COMM_EXEC__A, FEC_RS_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = qam_reset_qam(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = qam_set_symbolrate(state);\r\nif (status < 0)\r\ngoto error;\r\nswitch (state->props.modulation) {\r\ncase QAM_256:\r\nstate->m_constellation = DRX_CONSTELLATION_QAM256;\r\nbreak;\r\ncase QAM_AUTO:\r\ncase QAM_64:\r\nstate->m_constellation = DRX_CONSTELLATION_QAM64;\r\nbreak;\r\ncase QAM_16:\r\nstate->m_constellation = DRX_CONSTELLATION_QAM16;\r\nbreak;\r\ncase QAM_32:\r\nstate->m_constellation = DRX_CONSTELLATION_QAM32;\r\nbreak;\r\ncase QAM_128:\r\nstate->m_constellation = DRX_CONSTELLATION_QAM128;\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\nbreak;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nif (state->qam_demod_parameter_count == 4\r\n|| !state->qam_demod_parameter_count) {\r\nqam_demod_param_count = 4;\r\nstatus = qam_demodulator_command(state, qam_demod_param_count);\r\n}\r\nif (state->qam_demod_parameter_count == 2\r\n|| (!state->qam_demod_parameter_count && status < 0)) {\r\nqam_demod_param_count = 2;\r\nstatus = qam_demodulator_command(state, qam_demod_param_count);\r\n}\r\nif (status < 0) {\r\ndprintk(1, "Could not set demodulator parameters.\n");\r\ndprintk(1,\r\n"Make sure qam_demod_parameter_count (%d) is correct for your firmware (%s).\n",\r\nstate->qam_demod_parameter_count,\r\nstate->microcode_name);\r\ngoto error;\r\n} else if (!state->qam_demod_parameter_count) {\r\ndprintk(1,\r\n"Auto-probing the QAM command parameters was successful - using %d parameters.\n",\r\nqam_demod_param_count);\r\nstate->qam_demod_parameter_count = qam_demod_param_count;\r\n}\r\n#if 0\r\nstatus = set_frequency(channel, tuner_freq_offset));\r\nif (status < 0)\r\ngoto error;\r\n#endif\r\nstatus = set_frequency_shifter(state, intermediate_freqk_hz,\r\ntuner_freq_offset, true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_qam_measurement(state, state->m_constellation,\r\nstate->props.symbol_rate);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_SCALE_SH__A, IQM_CF_SCALE_SH__PRE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_TIMEOUT__A, QAM_SY_TIMEOUT__PRE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_RATE_LIMIT__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_LPF_FACTORP__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_LPF_FACTORI__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_MODE__A, 7);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB0__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB1__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB2__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB3__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB4__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB5__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB6__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB8__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB9__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB10__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB12__A, 2);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB15__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB16__A, 3);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB20__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_LC_QUAL_TAB25__A, 4);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_SY_SP_INV__A,\r\nQAM_SY_SP_INV_SPECTRUM_INV_DIS);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_HOLD);\r\nif (status < 0)\r\ngoto error;\r\nswitch (state->props.modulation) {\r\ncase QAM_16:\r\nstatus = set_qam16(state);\r\nbreak;\r\ncase QAM_32:\r\nstatus = set_qam32(state);\r\nbreak;\r\ncase QAM_AUTO:\r\ncase QAM_64:\r\nstatus = set_qam64(state);\r\nbreak;\r\ncase QAM_128:\r\nstatus = set_qam128(state);\r\nbreak;\r\ncase QAM_256:\r\nstatus = set_qam256(state);\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\nbreak;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_dto_setup(state, state->m_operation_mode);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_start(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_COMM_EXEC__A, FEC_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, QAM_COMM_EXEC__A, QAM_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_COMM_EXEC__A, IQM_COMM_EXEC_B_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = scu_command(state, SCU_RAM_COMMAND_STANDARD_QAM\r\n| SCU_RAM_COMMAND_CMD_DEMOD_START,\r\n0, NULL, 1, &cmd_result);\r\nif (status < 0)\r\ngoto error;\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int set_qam_standard(struct drxk_state *state,\r\nenum operation_mode o_mode)\r\n{\r\nint status;\r\n#ifdef DRXK_QAM_TAPS\r\n#define DRXK_QAMA_TAPS_SELECT\r\n#include "drxk_filters.h"\r\n#undef DRXK_QAMA_TAPS_SELECT\r\n#endif\r\ndprintk(1, "\n");\r\nswitch_antenna_to_qam(state);\r\nstatus = power_up_qam(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = qam_reset_qam(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_COMM_EXEC__A, IQM_COMM_EXEC_B_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_AMUX__A, IQM_AF_AMUX_SIGNAL2ADC);\r\nif (status < 0)\r\ngoto error;\r\nswitch (o_mode) {\r\ncase OM_QAM_ITU_A:\r\nstatus = bl_chain_cmd(state, DRXK_BL_ROM_OFFSET_TAPS_ITU_A,\r\nDRXK_BLCC_NR_ELEMENTS_TAPS,\r\nDRXK_BLC_TIMEOUT);\r\nbreak;\r\ncase OM_QAM_ITU_C:\r\nstatus = bl_direct_cmd(state, IQM_CF_TAP_RE0__A,\r\nDRXK_BL_ROM_OFFSET_TAPS_ITU_C,\r\nDRXK_BLDC_NR_ELEMENTS_TAPS,\r\nDRXK_BLC_TIMEOUT);\r\nif (status < 0)\r\ngoto error;\r\nstatus = bl_direct_cmd(state,\r\nIQM_CF_TAP_IM0__A,\r\nDRXK_BL_ROM_OFFSET_TAPS_ITU_C,\r\nDRXK_BLDC_NR_ELEMENTS_TAPS,\r\nDRXK_BLC_TIMEOUT);\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_OUT_ENA__A, 1 << IQM_CF_OUT_ENA_QAM__B);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_SYMMETRIC__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_MIDTAP__A,\r\n((1 << IQM_CF_MIDTAP_RE__B) | (1 << IQM_CF_MIDTAP_IM__B)));\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_RC_STRETCH__A, 21);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_CLP_LEN__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_CLP_TH__A, 448);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_SNS_LEN__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_POW_MEAS_LEN__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_FS_ADJ_SEL__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_RC_ADJ_SEL__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_ADJ_SEL__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_UPD_SEL__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_CLP_VAL__A, 500);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_DATATH__A, 1000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_BYPASSDET__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_DET_LCT__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_WND_LEN__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_CF_PKDTH__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_INC_BYPASS__A, 1);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_iqm_af(state, true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, IQM_AF_START_LOCK__A, 0x01);\r\nif (status < 0)\r\ngoto error;\r\nstatus = adc_synchronization(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_RAM_QAM_FSM_STEP_PERIOD__A, 2000);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_HOLD);\r\nif (status < 0)\r\ngoto error;\r\nstatus = init_agc(state, true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_pre_saw(state, &(state->m_qam_pre_saw_cfg));\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_agc_rf(state, &(state->m_qam_rf_agc_cfg), true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = set_agc_if(state, &(state->m_qam_if_agc_cfg), true);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int write_gpio(struct drxk_state *state)\r\n{\r\nint status;\r\nu16 value = 0;\r\ndprintk(1, "\n");\r\nstatus = write16(state, SCU_RAM_GPIO__A,\r\nSCU_RAM_GPIO_HW_LOCK_IND_DISABLE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY);\r\nif (status < 0)\r\ngoto error;\r\nif (state->m_has_sawsw) {\r\nif (state->uio_mask & 0x0001) {\r\nstatus = write16(state, SIO_PDR_SMA_TX_CFG__A,\r\nstate->m_gpio_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SIO_PDR_UIO_OUT_LO__A, &value);\r\nif (status < 0)\r\ngoto error;\r\nif ((state->m_gpio & 0x0001) == 0)\r\nvalue &= 0x7FFF;\r\nelse\r\nvalue |= 0x8000;\r\nstatus = write16(state, SIO_PDR_UIO_OUT_LO__A, value);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nif (state->uio_mask & 0x0002) {\r\nstatus = write16(state, SIO_PDR_SMA_RX_CFG__A,\r\nstate->m_gpio_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SIO_PDR_UIO_OUT_LO__A, &value);\r\nif (status < 0)\r\ngoto error;\r\nif ((state->m_gpio & 0x0002) == 0)\r\nvalue &= 0xBFFF;\r\nelse\r\nvalue |= 0x4000;\r\nstatus = write16(state, SIO_PDR_UIO_OUT_LO__A, value);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nif (state->uio_mask & 0x0004) {\r\nstatus = write16(state, SIO_PDR_GPIO_CFG__A,\r\nstate->m_gpio_cfg);\r\nif (status < 0)\r\ngoto error;\r\nstatus = read16(state, SIO_PDR_UIO_OUT_LO__A, &value);\r\nif (status < 0)\r\ngoto error;\r\nif ((state->m_gpio & 0x0004) == 0)\r\nvalue &= 0xFFFB;\r\nelse\r\nvalue |= 0x0004;\r\nstatus = write16(state, SIO_PDR_UIO_OUT_LO__A, value);\r\nif (status < 0)\r\ngoto error;\r\n}\r\n}\r\nstatus = write16(state, SIO_TOP_COMM_KEY__A, 0x0000);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int switch_antenna_to_qam(struct drxk_state *state)\r\n{\r\nint status = 0;\r\nbool gpio_state;\r\ndprintk(1, "\n");\r\nif (!state->antenna_gpio)\r\nreturn 0;\r\ngpio_state = state->m_gpio & state->antenna_gpio;\r\nif (state->antenna_dvbt ^ gpio_state) {\r\nif (state->antenna_dvbt)\r\nstate->m_gpio &= ~state->antenna_gpio;\r\nelse\r\nstate->m_gpio |= state->antenna_gpio;\r\nstatus = write_gpio(state);\r\n}\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int switch_antenna_to_dvbt(struct drxk_state *state)\r\n{\r\nint status = 0;\r\nbool gpio_state;\r\ndprintk(1, "\n");\r\nif (!state->antenna_gpio)\r\nreturn 0;\r\ngpio_state = state->m_gpio & state->antenna_gpio;\r\nif (!(state->antenna_dvbt ^ gpio_state)) {\r\nif (state->antenna_dvbt)\r\nstate->m_gpio |= state->antenna_gpio;\r\nelse\r\nstate->m_gpio &= ~state->antenna_gpio;\r\nstatus = write_gpio(state);\r\n}\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int power_down_device(struct drxk_state *state)\r\n{\r\nint status;\r\ndprintk(1, "\n");\r\nif (state->m_b_p_down_open_bridge) {\r\nstatus = ConfigureI2CBridge(state, true);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = dvbt_enable_ofdm_token_ring(state, false);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_PWD_MODE__A,\r\nSIO_CC_PWD_MODE_LEVEL_CLOCK);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_hi_cfg_ctrl |= SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ;\r\nstatus = hi_cfg_command(state);\r\nerror:\r\nif (status < 0)\r\npr_err("Error %d on %s\n", status, __func__);\r\nreturn status;\r\n}\r\nstatic int init_drxk(struct drxk_state *state)\r\n{\r\nint status = 0, n = 0;\r\nenum drx_power_mode power_mode = DRXK_POWER_DOWN_OFDM;\r\nu16 driver_version;\r\ndprintk(1, "\n");\r\nif ((state->m_drxk_state == DRXK_UNINITIALIZED)) {\r\ndrxk_i2c_lock(state);\r\nstatus = power_up_device(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = drxx_open(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_SOFT_RST__A,\r\nSIO_CC_SOFT_RST_OFDM__M\r\n| SIO_CC_SOFT_RST_SYS__M\r\n| SIO_CC_SOFT_RST_OSC__M);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY);\r\nif (status < 0)\r\ngoto error;\r\nusleep_range(1000, 2000);\r\nstate->m_drxk_a3_patch_code = true;\r\nstatus = get_device_capabilities(state);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_hi_cfg_bridge_delay =\r\n(u16) ((state->m_osc_clock_freq / 1000) *\r\nHI_I2C_BRIDGE_DELAY) / 1000;\r\nif (state->m_hi_cfg_bridge_delay >\r\nSIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M) {\r\nstate->m_hi_cfg_bridge_delay =\r\nSIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M;\r\n}\r\nstate->m_hi_cfg_bridge_delay +=\r\nstate->m_hi_cfg_bridge_delay <<\r\nSIO_HI_RA_RAM_PAR_3_CFG_DBL_SCL__B;\r\nstatus = init_hi(state);\r\nif (status < 0)\r\ngoto error;\r\n#if NOA1ROM\r\nif (!(state->m_DRXK_A1_ROM_CODE)\r\n&& !(state->m_DRXK_A2_ROM_CODE))\r\n#endif\r\n{\r\nstatus = write16(state, SCU_RAM_GPIO__A,\r\nSCU_RAM_GPIO_HW_LOCK_IND_DISABLE);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = mpegts_disable(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, AUD_COMM_EXEC__A, AUD_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_OFDM_SH_OFDM_RING_ENABLE__A,\r\nSIO_OFDM_SH_OFDM_RING_ENABLE_ON);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SIO_BL_COMM_EXEC__A,\r\nSIO_BL_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = bl_chain_cmd(state, 0, 6, 100);\r\nif (status < 0)\r\ngoto error;\r\nif (state->fw) {\r\nstatus = download_microcode(state, state->fw->data,\r\nstate->fw->size);\r\nif (status < 0)\r\ngoto error;\r\n}\r\nstatus = write16(state, SIO_OFDM_SH_OFDM_RING_ENABLE__A,\r\nSIO_OFDM_SH_OFDM_RING_ENABLE_OFF);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE);\r\nif (status < 0)\r\ngoto error;\r\nstatus = drxx_open(state);\r\nif (status < 0)\r\ngoto error;\r\nmsleep(30);\r\npower_mode = DRXK_POWER_DOWN_OFDM;\r\nstatus = ctrl_power_mode(state, &power_mode);\r\nif (status < 0)\r\ngoto error;\r\ndriver_version =\r\n(((DRXK_VERSION_MAJOR / 100) % 10) << 12) +\r\n(((DRXK_VERSION_MAJOR / 10) % 10) << 8) +\r\n((DRXK_VERSION_MAJOR % 10) << 4) +\r\n(DRXK_VERSION_MINOR % 10);\r\nstatus = write16(state, SCU_RAM_DRIVER_VER_HI__A,\r\ndriver_version);\r\nif (status < 0)\r\ngoto error;\r\ndriver_version =\r\n(((DRXK_VERSION_PATCH / 1000) % 10) << 12) +\r\n(((DRXK_VERSION_PATCH / 100) % 10) << 8) +\r\n(((DRXK_VERSION_PATCH / 10) % 10) << 4) +\r\n(DRXK_VERSION_PATCH % 10);\r\nstatus = write16(state, SCU_RAM_DRIVER_VER_LO__A,\r\ndriver_version);\r\nif (status < 0)\r\ngoto error;\r\npr_info("DRXK driver version %d.%d.%d\n",\r\nDRXK_VERSION_MAJOR, DRXK_VERSION_MINOR,\r\nDRXK_VERSION_PATCH);\r\nstatus = write16(state, SCU_RAM_DRIVER_DEBUG__A, 0);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write16(state, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_dto_init(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_stop(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_configure_polarity(state);\r\nif (status < 0)\r\ngoto error;\r\nstatus = mpegts_configure_pins(state, state->m_enable_mpeg_output);\r\nif (status < 0)\r\ngoto error;\r\nstatus = write_gpio(state);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_drxk_state = DRXK_STOPPED;\r\nif (state->m_b_power_down) {\r\nstatus = power_down_device(state);\r\nif (status < 0)\r\ngoto error;\r\nstate->m_drxk_state = DRXK_POWERED_DOWN;\r\n} else\r\nstate->m_drxk_state = DRXK_STOPPED;\r\nn = 0;\r\nif (state->m_has_dvbc) {\r\nstate->frontend.ops.delsys[n++] = SYS_DVBC_ANNEX_A;\r\nstate->frontend.ops.delsys[n++] = SYS_DVBC_ANNEX_C;\r\nstrlcat(state->frontend.ops.info.name, " DVB-C",\r\nsizeof(state->frontend.ops.info.name));\r\n}\r\nif (state->m_has_dvbt) {\r\nstate->frontend.ops.delsys[n++] = SYS_DVBT;\r\nstrlcat(state->frontend.ops.info.name, " DVB-T",\r\nsizeof(state->frontend.ops.info.name));\r\n}\r\ndrxk_i2c_unlock(state);\r\n}\r\nerror:\r\nif (status < 0) {\r\nstate->m_drxk_state = DRXK_NO_DEV;\r\ndrxk_i2c_unlock(state);\r\npr_err("Error %d on %s\n", status, __func__);\r\n}\r\nreturn status;\r\n}\r\nstatic void load_firmware_cb(const struct firmware *fw,\r\nvoid *context)\r\n{\r\nstruct drxk_state *state = context;\r\ndprintk(1, ": %s\n", fw ? "firmware loaded" : "firmware not loaded");\r\nif (!fw) {\r\npr_err("Could not load firmware file %s.\n",\r\nstate->microcode_name);\r\npr_info("Copy %s to your hotplug directory!\n",\r\nstate->microcode_name);\r\nstate->microcode_name = NULL;\r\n}\r\nstate->fw = fw;\r\ninit_drxk(state);\r\n}\r\nstatic void drxk_release(struct dvb_frontend *fe)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\ndprintk(1, "\n");\r\nrelease_firmware(state->fw);\r\nkfree(state);\r\n}\r\nstatic int drxk_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn 0;\r\nshut_down(state);\r\nreturn 0;\r\n}\r\nstatic int drxk_gate_ctrl(struct dvb_frontend *fe, int enable)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\ndprintk(1, ": %s\n", enable ? "enable" : "disable");\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nreturn ConfigureI2CBridge(state, enable ? true : false);\r\n}\r\nstatic int drxk_set_parameters(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nu32 delsys = p->delivery_system, old_delsys;\r\nstruct drxk_state *state = fe->demodulator_priv;\r\nu32 IF;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn -EAGAIN;\r\nif (!fe->ops.tuner_ops.get_if_frequency) {\r\npr_err("Error: get_if_frequency() not defined at tuner. Can't work without it!\n");\r\nreturn -EINVAL;\r\n}\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nif (fe->ops.tuner_ops.set_params)\r\nfe->ops.tuner_ops.set_params(fe);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nold_delsys = state->props.delivery_system;\r\nstate->props = *p;\r\nif (old_delsys != delsys) {\r\nshut_down(state);\r\nswitch (delsys) {\r\ncase SYS_DVBC_ANNEX_A:\r\ncase SYS_DVBC_ANNEX_C:\r\nif (!state->m_has_dvbc)\r\nreturn -EINVAL;\r\nstate->m_itut_annex_c = (delsys == SYS_DVBC_ANNEX_C) ?\r\ntrue : false;\r\nif (state->m_itut_annex_c)\r\nsetoperation_mode(state, OM_QAM_ITU_C);\r\nelse\r\nsetoperation_mode(state, OM_QAM_ITU_A);\r\nbreak;\r\ncase SYS_DVBT:\r\nif (!state->m_has_dvbt)\r\nreturn -EINVAL;\r\nsetoperation_mode(state, OM_DVBT);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nfe->ops.tuner_ops.get_if_frequency(fe, &IF);\r\nstart(state, 0, IF);\r\np->strength.stat[0].scale = FE_SCALE_RELATIVE;\r\np->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nreturn 0;\r\n}\r\nstatic int get_strength(struct drxk_state *state, u64 *strength)\r\n{\r\nint status;\r\nstruct s_cfg_agc rf_agc, if_agc;\r\nu32 total_gain = 0;\r\nu32 atten = 0;\r\nu32 agc_range = 0;\r\nu16 scu_lvl = 0;\r\nu16 scu_coc = 0;\r\nu16 tuner_rf_gain = 50;\r\nu16 tuner_if_gain = 40;\r\n*strength = 0;\r\nif (is_dvbt(state)) {\r\nrf_agc = state->m_dvbt_rf_agc_cfg;\r\nif_agc = state->m_dvbt_if_agc_cfg;\r\n} else if (is_qam(state)) {\r\nrf_agc = state->m_qam_rf_agc_cfg;\r\nif_agc = state->m_qam_if_agc_cfg;\r\n} else {\r\nrf_agc = state->m_atv_rf_agc_cfg;\r\nif_agc = state->m_atv_if_agc_cfg;\r\n}\r\nif (rf_agc.ctrl_mode == DRXK_AGC_CTRL_AUTO) {\r\nstatus = read16(state, SCU_RAM_AGC_RF_IACCU_HI__A, &scu_lvl);\r\nif (status < 0)\r\nreturn status;\r\nread16(state, SCU_RAM_AGC_RF_IACCU_HI_CO__A, &scu_coc);\r\nif (status < 0)\r\nreturn status;\r\nif (((u32) scu_lvl + (u32) scu_coc) < 0xffff)\r\nrf_agc.output_level = scu_lvl + scu_coc;\r\nelse\r\nrf_agc.output_level = 0xffff;\r\ntotal_gain += tuner_rf_gain;\r\nif (rf_agc.output_level < rf_agc.min_output_level)\r\nrf_agc.output_level = rf_agc.min_output_level;\r\nif (rf_agc.output_level > rf_agc.max_output_level)\r\nrf_agc.output_level = rf_agc.max_output_level;\r\nagc_range = (u32) (rf_agc.max_output_level - rf_agc.min_output_level);\r\nif (agc_range > 0) {\r\natten += 100UL *\r\n((u32)(tuner_rf_gain)) *\r\n((u32)(rf_agc.output_level - rf_agc.min_output_level))\r\n/ agc_range;\r\n}\r\n}\r\nif (if_agc.ctrl_mode == DRXK_AGC_CTRL_AUTO) {\r\nstatus = read16(state, SCU_RAM_AGC_IF_IACCU_HI__A,\r\n&if_agc.output_level);\r\nif (status < 0)\r\nreturn status;\r\nstatus = read16(state, SCU_RAM_AGC_INGAIN_TGT_MIN__A,\r\n&if_agc.top);\r\nif (status < 0)\r\nreturn status;\r\ntotal_gain += (u32) tuner_if_gain;\r\nif (if_agc.output_level < if_agc.min_output_level)\r\nif_agc.output_level = if_agc.min_output_level;\r\nif (if_agc.output_level > if_agc.max_output_level)\r\nif_agc.output_level = if_agc.max_output_level;\r\nagc_range = (u32)(if_agc.max_output_level - if_agc.min_output_level);\r\nif (agc_range > 0) {\r\natten += 100UL *\r\n((u32)(tuner_if_gain)) *\r\n((u32)(if_agc.output_level - if_agc.min_output_level))\r\n/ agc_range;\r\n}\r\n}\r\nif (total_gain > 0)\r\n*strength = (65535UL * atten / total_gain / 100);\r\nelse\r\n*strength = 65535;\r\nreturn 0;\r\n}\r\nstatic int drxk_get_stats(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct drxk_state *state = fe->demodulator_priv;\r\nint status;\r\nu32 stat;\r\nu16 reg16;\r\nu32 post_bit_count;\r\nu32 post_bit_err_count;\r\nu32 post_bit_error_scale;\r\nu32 pre_bit_err_count;\r\nu32 pre_bit_count;\r\nu32 pkt_count;\r\nu32 pkt_error_count;\r\ns32 cnr;\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn -EAGAIN;\r\nstate->fe_status = 0;\r\nget_lock_status(state, &stat);\r\nif (stat == MPEG_LOCK)\r\nstate->fe_status |= 0x1f;\r\nif (stat == FEC_LOCK)\r\nstate->fe_status |= 0x0f;\r\nif (stat == DEMOD_LOCK)\r\nstate->fe_status |= 0x07;\r\nget_strength(state, &c->strength.stat[0].uvalue);\r\nc->strength.stat[0].scale = FE_SCALE_RELATIVE;\r\nif (stat >= DEMOD_LOCK) {\r\nget_signal_to_noise(state, &cnr);\r\nc->cnr.stat[0].svalue = cnr * 100;\r\nc->cnr.stat[0].scale = FE_SCALE_DECIBEL;\r\n} else {\r\nc->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\n}\r\nif (stat < FEC_LOCK) {\r\nc->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nc->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nc->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nc->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nc->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nc->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\nreturn 0;\r\n}\r\nstatus = read16(state, OFDM_EC_VD_ERR_BIT_CNT__A, &reg16);\r\nif (status < 0)\r\ngoto error;\r\npre_bit_err_count = reg16;\r\nstatus = read16(state, OFDM_EC_VD_IN_BIT_CNT__A , &reg16);\r\nif (status < 0)\r\ngoto error;\r\npre_bit_count = reg16;\r\nstatus = read16(state, FEC_RS_NR_BIT_ERRORS__A, &reg16);\r\nif (status < 0)\r\ngoto error;\r\npost_bit_err_count = reg16;\r\nstatus = read16(state, FEC_RS_MEASUREMENT_PRESCALE__A, &reg16);\r\nif (status < 0)\r\ngoto error;\r\npost_bit_error_scale = reg16;\r\nstatus = read16(state, FEC_RS_MEASUREMENT_PERIOD__A, &reg16);\r\nif (status < 0)\r\ngoto error;\r\npkt_count = reg16;\r\nstatus = read16(state, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, &reg16);\r\nif (status < 0)\r\ngoto error;\r\npkt_error_count = reg16;\r\nwrite16(state, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, 0);\r\npost_bit_err_count *= post_bit_error_scale;\r\npost_bit_count = pkt_count * 204 * 8;\r\nc->block_error.stat[0].scale = FE_SCALE_COUNTER;\r\nc->block_error.stat[0].uvalue += pkt_error_count;\r\nc->block_count.stat[0].scale = FE_SCALE_COUNTER;\r\nc->block_count.stat[0].uvalue += pkt_count;\r\nc->pre_bit_error.stat[0].scale = FE_SCALE_COUNTER;\r\nc->pre_bit_error.stat[0].uvalue += pre_bit_err_count;\r\nc->pre_bit_count.stat[0].scale = FE_SCALE_COUNTER;\r\nc->pre_bit_count.stat[0].uvalue += pre_bit_count;\r\nc->post_bit_error.stat[0].scale = FE_SCALE_COUNTER;\r\nc->post_bit_error.stat[0].uvalue += post_bit_err_count;\r\nc->post_bit_count.stat[0].scale = FE_SCALE_COUNTER;\r\nc->post_bit_count.stat[0].uvalue += post_bit_count;\r\nerror:\r\nreturn status;\r\n}\r\nstatic int drxk_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\nint rc;\r\ndprintk(1, "\n");\r\nrc = drxk_get_stats(fe);\r\nif (rc < 0)\r\nreturn rc;\r\n*status = state->fe_status;\r\nreturn 0;\r\n}\r\nstatic int drxk_read_signal_strength(struct dvb_frontend *fe,\r\nu16 *strength)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn -EAGAIN;\r\n*strength = c->strength.stat[0].uvalue;\r\nreturn 0;\r\n}\r\nstatic int drxk_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\ns32 snr2;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn -EAGAIN;\r\nget_signal_to_noise(state, &snr2);\r\nif (snr2 < 0)\r\nsnr2 = 0;\r\n*snr = snr2 & 0xffff;\r\nreturn 0;\r\n}\r\nstatic int drxk_read_ucblocks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\nu16 err;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn -EAGAIN;\r\ndvbtqam_get_acc_pkt_err(state, &err);\r\n*ucblocks = (u32) err;\r\nreturn 0;\r\n}\r\nstatic int drxk_get_tune_settings(struct dvb_frontend *fe,\r\nstruct dvb_frontend_tune_settings *sets)\r\n{\r\nstruct drxk_state *state = fe->demodulator_priv;\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\ndprintk(1, "\n");\r\nif (state->m_drxk_state == DRXK_NO_DEV)\r\nreturn -ENODEV;\r\nif (state->m_drxk_state == DRXK_UNINITIALIZED)\r\nreturn -EAGAIN;\r\nswitch (p->delivery_system) {\r\ncase SYS_DVBC_ANNEX_A:\r\ncase SYS_DVBC_ANNEX_C:\r\ncase SYS_DVBT:\r\nsets->min_delay_ms = 3000;\r\nsets->max_drift = 0;\r\nsets->step_size = 0;\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstruct dvb_frontend *drxk_attach(const struct drxk_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct dtv_frontend_properties *p;\r\nstruct drxk_state *state = NULL;\r\nu8 adr = config->adr;\r\nint status;\r\ndprintk(1, "\n");\r\nstate = kzalloc(sizeof(struct drxk_state), GFP_KERNEL);\r\nif (!state)\r\nreturn NULL;\r\nstate->i2c = i2c;\r\nstate->demod_address = adr;\r\nstate->single_master = config->single_master;\r\nstate->microcode_name = config->microcode_name;\r\nstate->qam_demod_parameter_count = config->qam_demod_parameter_count;\r\nstate->no_i2c_bridge = config->no_i2c_bridge;\r\nstate->antenna_gpio = config->antenna_gpio;\r\nstate->antenna_dvbt = config->antenna_dvbt;\r\nstate->m_chunk_size = config->chunk_size;\r\nstate->enable_merr_cfg = config->enable_merr_cfg;\r\nif (config->dynamic_clk) {\r\nstate->m_dvbt_static_clk = false;\r\nstate->m_dvbc_static_clk = false;\r\n} else {\r\nstate->m_dvbt_static_clk = true;\r\nstate->m_dvbc_static_clk = true;\r\n}\r\nif (config->mpeg_out_clk_strength)\r\nstate->m_ts_clockk_strength = config->mpeg_out_clk_strength & 0x07;\r\nelse\r\nstate->m_ts_clockk_strength = 0x06;\r\nif (config->parallel_ts)\r\nstate->m_enable_parallel = true;\r\nelse\r\nstate->m_enable_parallel = false;\r\nstate->uio_mask = config->antenna_gpio;\r\nif (!state->antenna_dvbt && state->antenna_gpio)\r\nstate->m_gpio |= state->antenna_gpio;\r\nelse\r\nstate->m_gpio &= ~state->antenna_gpio;\r\nmutex_init(&state->mutex);\r\nmemcpy(&state->frontend.ops, &drxk_ops, sizeof(drxk_ops));\r\nstate->frontend.demodulator_priv = state;\r\ninit_state(state);\r\nif (state->microcode_name) {\r\nconst struct firmware *fw = NULL;\r\nstatus = request_firmware(&fw, state->microcode_name,\r\nstate->i2c->dev.parent);\r\nif (status < 0)\r\nfw = NULL;\r\nload_firmware_cb(fw, state);\r\n} else if (init_drxk(state) < 0)\r\ngoto error;\r\np = &state->frontend.dtv_property_cache;\r\np->strength.len = 1;\r\np->cnr.len = 1;\r\np->block_error.len = 1;\r\np->block_count.len = 1;\r\np->pre_bit_error.len = 1;\r\np->pre_bit_count.len = 1;\r\np->post_bit_error.len = 1;\r\np->post_bit_count.len = 1;\r\np->strength.stat[0].scale = FE_SCALE_RELATIVE;\r\np->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\np->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\r\npr_info("frontend initialized.\n");\r\nreturn &state->frontend;\r\nerror:\r\npr_err("not found\n");\r\nkfree(state);\r\nreturn NULL;\r\n}

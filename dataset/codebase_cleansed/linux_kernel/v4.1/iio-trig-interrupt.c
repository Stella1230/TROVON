static irqreturn_t iio_interrupt_trigger_poll(int irq, void *private)\r\n{\r\niio_trigger_poll(private);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int iio_interrupt_trigger_probe(struct platform_device *pdev)\r\n{\r\nstruct iio_interrupt_trigger_info *trig_info;\r\nstruct iio_trigger *trig;\r\nunsigned long irqflags;\r\nstruct resource *irq_res;\r\nint irq, ret = 0;\r\nirq_res = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (irq_res == NULL)\r\nreturn -ENODEV;\r\nirqflags = (irq_res->flags & IRQF_TRIGGER_MASK) | IRQF_SHARED;\r\nirq = irq_res->start;\r\ntrig = iio_trigger_alloc("irqtrig%d", irq);\r\nif (!trig) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\ntrig_info = kzalloc(sizeof(*trig_info), GFP_KERNEL);\r\nif (!trig_info) {\r\nret = -ENOMEM;\r\ngoto error_put_trigger;\r\n}\r\niio_trigger_set_drvdata(trig, trig_info);\r\ntrig_info->irq = irq;\r\ntrig->ops = &iio_interrupt_trigger_ops;\r\nret = request_irq(irq, iio_interrupt_trigger_poll,\r\nirqflags, trig->name, trig);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"request IRQ-%d failed", irq);\r\ngoto error_free_trig_info;\r\n}\r\nret = iio_trigger_register(trig);\r\nif (ret)\r\ngoto error_release_irq;\r\nplatform_set_drvdata(pdev, trig);\r\nreturn 0;\r\nerror_release_irq:\r\nfree_irq(irq, trig);\r\nerror_free_trig_info:\r\nkfree(trig_info);\r\nerror_put_trigger:\r\niio_trigger_put(trig);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int iio_interrupt_trigger_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_trigger *trig;\r\nstruct iio_interrupt_trigger_info *trig_info;\r\ntrig = platform_get_drvdata(pdev);\r\ntrig_info = iio_trigger_get_drvdata(trig);\r\niio_trigger_unregister(trig);\r\nfree_irq(trig_info->irq, trig);\r\nkfree(trig_info);\r\niio_trigger_put(trig);\r\nreturn 0;\r\n}

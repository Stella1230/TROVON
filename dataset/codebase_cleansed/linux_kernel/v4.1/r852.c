static inline uint8_t r852_read_reg(struct r852_device *dev, int address)\r\n{\r\nuint8_t reg = readb(dev->mmio + address);\r\nreturn reg;\r\n}\r\nstatic inline void r852_write_reg(struct r852_device *dev,\r\nint address, uint8_t value)\r\n{\r\nwriteb(value, dev->mmio + address);\r\nmmiowb();\r\n}\r\nstatic inline uint32_t r852_read_reg_dword(struct r852_device *dev, int address)\r\n{\r\nuint32_t reg = le32_to_cpu(readl(dev->mmio + address));\r\nreturn reg;\r\n}\r\nstatic inline void r852_write_reg_dword(struct r852_device *dev,\r\nint address, uint32_t value)\r\n{\r\nwritel(cpu_to_le32(value), dev->mmio + address);\r\nmmiowb();\r\n}\r\nstatic inline struct r852_device *r852_get_dev(struct mtd_info *mtd)\r\n{\r\nstruct nand_chip *chip = mtd->priv;\r\nreturn chip->priv;\r\n}\r\nstatic void r852_dma_test(struct r852_device *dev)\r\n{\r\ndev->dma_usable = (r852_read_reg(dev, R852_DMA_CAP) &\r\n(R852_DMA1 | R852_DMA2)) == (R852_DMA1 | R852_DMA2);\r\nif (!dev->dma_usable)\r\nmessage("Non dma capable device detected, dma disabled");\r\nif (!r852_enable_dma) {\r\nmessage("disabling dma on user request");\r\ndev->dma_usable = 0;\r\n}\r\n}\r\nstatic void r852_dma_enable(struct r852_device *dev)\r\n{\r\nuint8_t dma_reg, dma_irq_reg;\r\ndma_reg = r852_read_reg_dword(dev, R852_DMA_SETTINGS);\r\ndma_reg &= ~(R852_DMA_READ | R852_DMA_INTERNAL | R852_DMA_MEMORY);\r\nif (dev->dma_dir)\r\ndma_reg |= R852_DMA_READ;\r\nif (dev->dma_state == DMA_INTERNAL) {\r\ndma_reg |= R852_DMA_INTERNAL;\r\nr852_write_reg_dword(dev, R852_DMA_ADDR,\r\ncpu_to_le32(dev->phys_bounce_buffer));\r\n} else {\r\ndma_reg |= R852_DMA_MEMORY;\r\nr852_write_reg_dword(dev, R852_DMA_ADDR,\r\ncpu_to_le32(dev->phys_dma_addr));\r\n}\r\nr852_read_reg_dword(dev, R852_DMA_ADDR);\r\nr852_write_reg_dword(dev, R852_DMA_SETTINGS, dma_reg);\r\ndma_irq_reg = r852_read_reg_dword(dev, R852_DMA_IRQ_ENABLE);\r\nr852_write_reg_dword(dev, R852_DMA_IRQ_ENABLE,\r\ndma_irq_reg |\r\nR852_DMA_IRQ_INTERNAL |\r\nR852_DMA_IRQ_ERROR |\r\nR852_DMA_IRQ_MEMORY);\r\n}\r\nstatic void r852_dma_done(struct r852_device *dev, int error)\r\n{\r\nWARN_ON(dev->dma_stage == 0);\r\nr852_write_reg_dword(dev, R852_DMA_IRQ_STA,\r\nr852_read_reg_dword(dev, R852_DMA_IRQ_STA));\r\nr852_write_reg_dword(dev, R852_DMA_SETTINGS, 0);\r\nr852_write_reg_dword(dev, R852_DMA_IRQ_ENABLE, 0);\r\nr852_write_reg_dword(dev, R852_DMA_ADDR,\r\ncpu_to_le32(dev->phys_bounce_buffer));\r\nr852_read_reg_dword(dev, R852_DMA_ADDR);\r\ndev->dma_error = error;\r\ndev->dma_stage = 0;\r\nif (dev->phys_dma_addr && dev->phys_dma_addr != dev->phys_bounce_buffer)\r\npci_unmap_single(dev->pci_dev, dev->phys_dma_addr, R852_DMA_LEN,\r\ndev->dma_dir ? PCI_DMA_FROMDEVICE : PCI_DMA_TODEVICE);\r\n}\r\nstatic int r852_dma_wait(struct r852_device *dev)\r\n{\r\nlong timeout = wait_for_completion_timeout(&dev->dma_done,\r\nmsecs_to_jiffies(1000));\r\nif (!timeout) {\r\ndbg("timeout waiting for DMA interrupt");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic void r852_do_dma(struct r852_device *dev, uint8_t *buf, int do_read)\r\n{\r\nint bounce = 0;\r\nunsigned long flags;\r\nint error;\r\ndev->dma_error = 0;\r\ndev->dma_dir = do_read;\r\ndev->dma_stage = 1;\r\nreinit_completion(&dev->dma_done);\r\ndbg_verbose("doing dma %s ", do_read ? "read" : "write");\r\ndev->dma_state = do_read ? DMA_INTERNAL : DMA_MEMORY;\r\nif ((unsigned long)buf & (R852_DMA_LEN-1))\r\nbounce = 1;\r\nif (!bounce) {\r\ndev->phys_dma_addr = pci_map_single(dev->pci_dev, (void *)buf,\r\nR852_DMA_LEN,\r\n(do_read ? PCI_DMA_FROMDEVICE : PCI_DMA_TODEVICE));\r\nif (pci_dma_mapping_error(dev->pci_dev, dev->phys_dma_addr))\r\nbounce = 1;\r\n}\r\nif (bounce) {\r\ndbg_verbose("dma: using bounce buffer");\r\ndev->phys_dma_addr = dev->phys_bounce_buffer;\r\nif (!do_read)\r\nmemcpy(dev->bounce_buffer, buf, R852_DMA_LEN);\r\n}\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nr852_dma_enable(dev);\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nerror = r852_dma_wait(dev);\r\nif (error) {\r\nr852_dma_done(dev, error);\r\nreturn;\r\n}\r\nif (do_read && bounce)\r\nmemcpy((void *)buf, dev->bounce_buffer, R852_DMA_LEN);\r\n}\r\nstatic void r852_write_buf(struct mtd_info *mtd, const uint8_t *buf, int len)\r\n{\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nuint32_t reg;\r\nif (dev->card_unstable)\r\nreturn;\r\nif (len == R852_DMA_LEN && dev->dma_usable) {\r\nr852_do_dma(dev, (uint8_t *)buf, 0);\r\nreturn;\r\n}\r\nwhile (len >= 4) {\r\nreg = buf[0] | buf[1] << 8 | buf[2] << 16 | buf[3] << 24;\r\nr852_write_reg_dword(dev, R852_DATALINE, reg);\r\nbuf += 4;\r\nlen -= 4;\r\n}\r\nwhile (len > 0) {\r\nr852_write_reg(dev, R852_DATALINE, *buf++);\r\nlen--;\r\n}\r\n}\r\nstatic void r852_read_buf(struct mtd_info *mtd, uint8_t *buf, int len)\r\n{\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nuint32_t reg;\r\nif (dev->card_unstable) {\r\nmemset(buf, 0, len);\r\nreturn;\r\n}\r\nif (len == R852_DMA_LEN && dev->dma_usable) {\r\nr852_do_dma(dev, buf, 1);\r\nreturn;\r\n}\r\nwhile (len >= 4) {\r\nreg = r852_read_reg_dword(dev, R852_DATALINE);\r\n*buf++ = reg & 0xFF;\r\n*buf++ = (reg >> 8) & 0xFF;\r\n*buf++ = (reg >> 16) & 0xFF;\r\n*buf++ = (reg >> 24) & 0xFF;\r\nlen -= 4;\r\n}\r\nwhile (len--)\r\n*buf++ = r852_read_reg(dev, R852_DATALINE);\r\n}\r\nstatic uint8_t r852_read_byte(struct mtd_info *mtd)\r\n{\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nif (dev->card_unstable)\r\nreturn 0;\r\nreturn r852_read_reg(dev, R852_DATALINE);\r\n}\r\nstatic void r852_cmdctl(struct mtd_info *mtd, int dat, unsigned int ctrl)\r\n{\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nif (dev->card_unstable)\r\nreturn;\r\nif (ctrl & NAND_CTRL_CHANGE) {\r\ndev->ctlreg &= ~(R852_CTL_DATA | R852_CTL_COMMAND |\r\nR852_CTL_ON | R852_CTL_CARDENABLE);\r\nif (ctrl & NAND_ALE)\r\ndev->ctlreg |= R852_CTL_DATA;\r\nif (ctrl & NAND_CLE)\r\ndev->ctlreg |= R852_CTL_COMMAND;\r\nif (ctrl & NAND_NCE)\r\ndev->ctlreg |= (R852_CTL_CARDENABLE | R852_CTL_ON);\r\nelse\r\ndev->ctlreg &= ~R852_CTL_WRITE;\r\nif (dat == NAND_CMD_ERASE1)\r\ndev->ctlreg |= R852_CTL_WRITE;\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg);\r\n}\r\nif (dat == NAND_CMD_SEQIN && (dev->ctlreg & R852_CTL_COMMAND)) {\r\ndev->ctlreg |= R852_CTL_WRITE;\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg);\r\n}\r\nif (dat != NAND_CMD_NONE)\r\nr852_write_reg(dev, R852_DATALINE, dat);\r\n}\r\nstatic int r852_wait(struct mtd_info *mtd, struct nand_chip *chip)\r\n{\r\nstruct r852_device *dev = chip->priv;\r\nunsigned long timeout;\r\nint status;\r\ntimeout = jiffies + (chip->state == FL_ERASING ?\r\nmsecs_to_jiffies(400) : msecs_to_jiffies(20));\r\nwhile (time_before(jiffies, timeout))\r\nif (chip->dev_ready(mtd))\r\nbreak;\r\nchip->cmdfunc(mtd, NAND_CMD_STATUS, -1, -1);\r\nstatus = (int)chip->read_byte(mtd);\r\nif (dev->dma_error) {\r\nstatus |= NAND_STATUS_FAIL;\r\ndev->dma_error = 0;\r\n}\r\nreturn status;\r\n}\r\nstatic int r852_ready(struct mtd_info *mtd)\r\n{\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nreturn !(r852_read_reg(dev, R852_CARD_STA) & R852_CARD_STA_BUSY);\r\n}\r\nstatic void r852_ecc_hwctl(struct mtd_info *mtd, int mode)\r\n{\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nif (dev->card_unstable)\r\nreturn;\r\nswitch (mode) {\r\ncase NAND_ECC_READ:\r\ncase NAND_ECC_WRITE:\r\ndev->ctlreg |= R852_CTL_ECC_ENABLE;\r\nr852_write_reg(dev, R852_CTL,\r\ndev->ctlreg | R852_CTL_ECC_ACCESS);\r\nr852_read_reg_dword(dev, R852_DATALINE);\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg);\r\nreturn;\r\ncase NAND_ECC_READSYN:\r\ndev->ctlreg &= ~R852_CTL_ECC_ENABLE;\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg);\r\n}\r\n}\r\nstatic int r852_ecc_calculate(struct mtd_info *mtd, const uint8_t *dat,\r\nuint8_t *ecc_code)\r\n{\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nstruct sm_oob *oob = (struct sm_oob *)ecc_code;\r\nuint32_t ecc1, ecc2;\r\nif (dev->card_unstable)\r\nreturn 0;\r\ndev->ctlreg &= ~R852_CTL_ECC_ENABLE;\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg | R852_CTL_ECC_ACCESS);\r\necc1 = r852_read_reg_dword(dev, R852_DATALINE);\r\necc2 = r852_read_reg_dword(dev, R852_DATALINE);\r\noob->ecc1[0] = (ecc1) & 0xFF;\r\noob->ecc1[1] = (ecc1 >> 8) & 0xFF;\r\noob->ecc1[2] = (ecc1 >> 16) & 0xFF;\r\noob->ecc2[0] = (ecc2) & 0xFF;\r\noob->ecc2[1] = (ecc2 >> 8) & 0xFF;\r\noob->ecc2[2] = (ecc2 >> 16) & 0xFF;\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg);\r\nreturn 0;\r\n}\r\nstatic int r852_ecc_correct(struct mtd_info *mtd, uint8_t *dat,\r\nuint8_t *read_ecc, uint8_t *calc_ecc)\r\n{\r\nuint16_t ecc_reg;\r\nuint8_t ecc_status, err_byte;\r\nint i, error = 0;\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nif (dev->card_unstable)\r\nreturn 0;\r\nif (dev->dma_error) {\r\ndev->dma_error = 0;\r\nreturn -1;\r\n}\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg | R852_CTL_ECC_ACCESS);\r\necc_reg = r852_read_reg_dword(dev, R852_DATALINE);\r\nr852_write_reg(dev, R852_CTL, dev->ctlreg);\r\nfor (i = 0 ; i <= 1 ; i++) {\r\necc_status = (ecc_reg >> 8) & 0xFF;\r\nif (ecc_status & R852_ECC_FAIL) {\r\ndbg("ecc: unrecoverable error, in half %d", i);\r\nerror = -1;\r\ngoto exit;\r\n}\r\nif (ecc_status & R852_ECC_CORRECTABLE) {\r\nerr_byte = ecc_reg & 0xFF;\r\ndbg("ecc: recoverable error, "\r\n"in half %d, byte %d, bit %d", i,\r\nerr_byte, ecc_status & R852_ECC_ERR_BIT_MSK);\r\ndat[err_byte] ^=\r\n1 << (ecc_status & R852_ECC_ERR_BIT_MSK);\r\nerror++;\r\n}\r\ndat += 256;\r\necc_reg >>= 16;\r\n}\r\nexit:\r\nreturn error;\r\n}\r\nstatic int r852_read_oob(struct mtd_info *mtd, struct nand_chip *chip,\r\nint page)\r\n{\r\nchip->cmdfunc(mtd, NAND_CMD_READOOB, 0, page);\r\nchip->read_buf(mtd, chip->oob_poi, mtd->oobsize);\r\nreturn 0;\r\n}\r\nstatic void r852_engine_enable(struct r852_device *dev)\r\n{\r\nif (r852_read_reg_dword(dev, R852_HW) & R852_HW_UNKNOWN) {\r\nr852_write_reg(dev, R852_CTL, R852_CTL_RESET | R852_CTL_ON);\r\nr852_write_reg_dword(dev, R852_HW, R852_HW_ENABLED);\r\n} else {\r\nr852_write_reg_dword(dev, R852_HW, R852_HW_ENABLED);\r\nr852_write_reg(dev, R852_CTL, R852_CTL_RESET | R852_CTL_ON);\r\n}\r\nmsleep(300);\r\nr852_write_reg(dev, R852_CTL, 0);\r\n}\r\nstatic void r852_engine_disable(struct r852_device *dev)\r\n{\r\nr852_write_reg_dword(dev, R852_HW, 0);\r\nr852_write_reg(dev, R852_CTL, R852_CTL_RESET);\r\n}\r\nstatic void r852_card_update_present(struct r852_device *dev)\r\n{\r\nunsigned long flags;\r\nuint8_t reg;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nreg = r852_read_reg(dev, R852_CARD_STA);\r\ndev->card_detected = !!(reg & R852_CARD_STA_PRESENT);\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\n}\r\nstatic void r852_update_card_detect(struct r852_device *dev)\r\n{\r\nint card_detect_reg = r852_read_reg(dev, R852_CARD_IRQ_ENABLE);\r\ndev->card_unstable = 0;\r\ncard_detect_reg &= ~(R852_CARD_IRQ_REMOVE | R852_CARD_IRQ_INSERT);\r\ncard_detect_reg |= R852_CARD_IRQ_GENABLE;\r\ncard_detect_reg |= dev->card_detected ?\r\nR852_CARD_IRQ_REMOVE : R852_CARD_IRQ_INSERT;\r\nr852_write_reg(dev, R852_CARD_IRQ_ENABLE, card_detect_reg);\r\n}\r\nstatic ssize_t r852_media_type_show(struct device *sys_dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct mtd_info *mtd = container_of(sys_dev, struct mtd_info, dev);\r\nstruct r852_device *dev = r852_get_dev(mtd);\r\nchar *data = dev->sm ? "smartmedia" : "xd";\r\nstrcpy(buf, data);\r\nreturn strlen(data);\r\n}\r\nstatic void r852_update_media_status(struct r852_device *dev)\r\n{\r\nuint8_t reg;\r\nunsigned long flags;\r\nint readonly;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nif (!dev->card_detected) {\r\nmessage("card removed");\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nreturn ;\r\n}\r\nreadonly = r852_read_reg(dev, R852_CARD_STA) & R852_CARD_STA_RO;\r\nreg = r852_read_reg(dev, R852_DMA_CAP);\r\ndev->sm = (reg & (R852_DMA1 | R852_DMA2)) && (reg & R852_SMBIT);\r\nmessage("detected %s %s card in slot",\r\ndev->sm ? "SmartMedia" : "xD",\r\nreadonly ? "readonly" : "writeable");\r\ndev->readonly = readonly;\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\n}\r\nstatic int r852_register_nand_device(struct r852_device *dev)\r\n{\r\ndev->mtd = kzalloc(sizeof(struct mtd_info), GFP_KERNEL);\r\nif (!dev->mtd)\r\ngoto error1;\r\nWARN_ON(dev->card_registred);\r\ndev->mtd->owner = THIS_MODULE;\r\ndev->mtd->priv = dev->chip;\r\ndev->mtd->dev.parent = &dev->pci_dev->dev;\r\nif (dev->readonly)\r\ndev->chip->options |= NAND_ROM;\r\nr852_engine_enable(dev);\r\nif (sm_register_device(dev->mtd, dev->sm))\r\ngoto error2;\r\nif (device_create_file(&dev->mtd->dev, &dev_attr_media_type))\r\nmessage("can't create media type sysfs attribute");\r\ndev->card_registred = 1;\r\nreturn 0;\r\nerror2:\r\nkfree(dev->mtd);\r\nerror1:\r\ndev->card_detected = 0;\r\nreturn -1;\r\n}\r\nstatic void r852_unregister_nand_device(struct r852_device *dev)\r\n{\r\nif (!dev->card_registred)\r\nreturn;\r\ndevice_remove_file(&dev->mtd->dev, &dev_attr_media_type);\r\nnand_release(dev->mtd);\r\nr852_engine_disable(dev);\r\ndev->card_registred = 0;\r\nkfree(dev->mtd);\r\ndev->mtd = NULL;\r\n}\r\nstatic void r852_card_detect_work(struct work_struct *work)\r\n{\r\nstruct r852_device *dev =\r\ncontainer_of(work, struct r852_device, card_detect_work.work);\r\nr852_card_update_present(dev);\r\nr852_update_card_detect(dev);\r\ndev->card_unstable = 0;\r\nif (dev->card_detected == dev->card_registred)\r\ngoto exit;\r\nr852_update_media_status(dev);\r\nif (dev->card_detected)\r\nr852_register_nand_device(dev);\r\nelse\r\nr852_unregister_nand_device(dev);\r\nexit:\r\nr852_update_card_detect(dev);\r\n}\r\nstatic void r852_disable_irqs(struct r852_device *dev)\r\n{\r\nuint8_t reg;\r\nreg = r852_read_reg(dev, R852_CARD_IRQ_ENABLE);\r\nr852_write_reg(dev, R852_CARD_IRQ_ENABLE, reg & ~R852_CARD_IRQ_MASK);\r\nreg = r852_read_reg_dword(dev, R852_DMA_IRQ_ENABLE);\r\nr852_write_reg_dword(dev, R852_DMA_IRQ_ENABLE,\r\nreg & ~R852_DMA_IRQ_MASK);\r\nr852_write_reg(dev, R852_CARD_IRQ_STA, R852_CARD_IRQ_MASK);\r\nr852_write_reg_dword(dev, R852_DMA_IRQ_STA, R852_DMA_IRQ_MASK);\r\n}\r\nstatic irqreturn_t r852_irq(int irq, void *data)\r\n{\r\nstruct r852_device *dev = (struct r852_device *)data;\r\nuint8_t card_status, dma_status;\r\nunsigned long flags;\r\nirqreturn_t ret = IRQ_NONE;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\ncard_status = r852_read_reg(dev, R852_CARD_IRQ_STA);\r\nr852_write_reg(dev, R852_CARD_IRQ_STA, card_status);\r\nif (card_status & (R852_CARD_IRQ_INSERT|R852_CARD_IRQ_REMOVE)) {\r\nret = IRQ_HANDLED;\r\ndev->card_detected = !!(card_status & R852_CARD_IRQ_INSERT);\r\nWARN_ON(dev->card_unstable);\r\nr852_disable_irqs(dev);\r\nif (dev->card_unstable)\r\ngoto out;\r\ndev->card_unstable = 1;\r\nqueue_delayed_work(dev->card_workqueue,\r\n&dev->card_detect_work, msecs_to_jiffies(100));\r\ngoto out;\r\n}\r\ndma_status = r852_read_reg_dword(dev, R852_DMA_IRQ_STA);\r\nr852_write_reg_dword(dev, R852_DMA_IRQ_STA, dma_status);\r\nif (dma_status & R852_DMA_IRQ_MASK) {\r\nret = IRQ_HANDLED;\r\nif (dma_status & R852_DMA_IRQ_ERROR) {\r\ndbg("received dma error IRQ");\r\nr852_dma_done(dev, -EIO);\r\ncomplete(&dev->dma_done);\r\ngoto out;\r\n}\r\nWARN_ON_ONCE(dev->dma_stage == 0);\r\nif (dev->dma_stage == 0)\r\ngoto out;\r\nif (dev->dma_state == DMA_INTERNAL &&\r\n(dma_status & R852_DMA_IRQ_INTERNAL)) {\r\ndev->dma_state = DMA_MEMORY;\r\ndev->dma_stage++;\r\n}\r\nif (dev->dma_state == DMA_MEMORY &&\r\n(dma_status & R852_DMA_IRQ_MEMORY)) {\r\ndev->dma_state = DMA_INTERNAL;\r\ndev->dma_stage++;\r\n}\r\nif (dev->dma_stage == 2)\r\nr852_dma_enable(dev);\r\nif (dev->dma_stage == 3) {\r\nr852_dma_done(dev, 0);\r\ncomplete(&dev->dma_done);\r\n}\r\ngoto out;\r\n}\r\nif (dma_status)\r\ndbg("bad dma IRQ status = %x", dma_status);\r\nif (card_status & ~R852_CARD_STA_CD)\r\ndbg("strange card status = %x", card_status);\r\nout:\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nreturn ret;\r\n}\r\nstatic int r852_probe(struct pci_dev *pci_dev, const struct pci_device_id *id)\r\n{\r\nint error;\r\nstruct nand_chip *chip;\r\nstruct r852_device *dev;\r\nerror = pci_enable_device(pci_dev);\r\nif (error)\r\ngoto error1;\r\npci_set_master(pci_dev);\r\nerror = pci_set_dma_mask(pci_dev, DMA_BIT_MASK(32));\r\nif (error)\r\ngoto error2;\r\nerror = pci_request_regions(pci_dev, DRV_NAME);\r\nif (error)\r\ngoto error3;\r\nerror = -ENOMEM;\r\nchip = kzalloc(sizeof(struct nand_chip), GFP_KERNEL);\r\nif (!chip)\r\ngoto error4;\r\nchip->cmd_ctrl = r852_cmdctl;\r\nchip->waitfunc = r852_wait;\r\nchip->dev_ready = r852_ready;\r\nchip->read_byte = r852_read_byte;\r\nchip->read_buf = r852_read_buf;\r\nchip->write_buf = r852_write_buf;\r\nchip->ecc.mode = NAND_ECC_HW_SYNDROME;\r\nchip->ecc.size = R852_DMA_LEN;\r\nchip->ecc.bytes = SM_OOB_SIZE;\r\nchip->ecc.strength = 2;\r\nchip->ecc.hwctl = r852_ecc_hwctl;\r\nchip->ecc.calculate = r852_ecc_calculate;\r\nchip->ecc.correct = r852_ecc_correct;\r\nchip->ecc.read_oob = r852_read_oob;\r\ndev = kzalloc(sizeof(struct r852_device), GFP_KERNEL);\r\nif (!dev)\r\ngoto error5;\r\nchip->priv = dev;\r\ndev->chip = chip;\r\ndev->pci_dev = pci_dev;\r\npci_set_drvdata(pci_dev, dev);\r\ndev->bounce_buffer = pci_alloc_consistent(pci_dev, R852_DMA_LEN,\r\n&dev->phys_bounce_buffer);\r\nif (!dev->bounce_buffer)\r\ngoto error6;\r\nerror = -ENODEV;\r\ndev->mmio = pci_ioremap_bar(pci_dev, 0);\r\nif (!dev->mmio)\r\ngoto error7;\r\nerror = -ENOMEM;\r\ndev->tmp_buffer = kzalloc(SM_SECTOR_SIZE, GFP_KERNEL);\r\nif (!dev->tmp_buffer)\r\ngoto error8;\r\ninit_completion(&dev->dma_done);\r\ndev->card_workqueue = create_freezable_workqueue(DRV_NAME);\r\nif (!dev->card_workqueue)\r\ngoto error9;\r\nINIT_DELAYED_WORK(&dev->card_detect_work, r852_card_detect_work);\r\nr852_engine_disable(dev);\r\nr852_disable_irqs(dev);\r\nr852_dma_test(dev);\r\ndev->irq = pci_dev->irq;\r\nspin_lock_init(&dev->irqlock);\r\ndev->card_detected = 0;\r\nr852_card_update_present(dev);\r\nerror = -ENODEV;\r\nif (request_irq(pci_dev->irq, &r852_irq, IRQF_SHARED,\r\nDRV_NAME, dev))\r\ngoto error10;\r\nqueue_delayed_work(dev->card_workqueue,\r\n&dev->card_detect_work, 0);\r\nprintk(KERN_NOTICE DRV_NAME ": driver loaded successfully\n");\r\nreturn 0;\r\nerror10:\r\ndestroy_workqueue(dev->card_workqueue);\r\nerror9:\r\nkfree(dev->tmp_buffer);\r\nerror8:\r\npci_iounmap(pci_dev, dev->mmio);\r\nerror7:\r\npci_free_consistent(pci_dev, R852_DMA_LEN,\r\ndev->bounce_buffer, dev->phys_bounce_buffer);\r\nerror6:\r\nkfree(dev);\r\nerror5:\r\nkfree(chip);\r\nerror4:\r\npci_release_regions(pci_dev);\r\nerror3:\r\nerror2:\r\npci_disable_device(pci_dev);\r\nerror1:\r\nreturn error;\r\n}\r\nstatic void r852_remove(struct pci_dev *pci_dev)\r\n{\r\nstruct r852_device *dev = pci_get_drvdata(pci_dev);\r\ncancel_delayed_work_sync(&dev->card_detect_work);\r\ndestroy_workqueue(dev->card_workqueue);\r\nr852_unregister_nand_device(dev);\r\nr852_disable_irqs(dev);\r\nsynchronize_irq(dev->irq);\r\nfree_irq(dev->irq, dev);\r\nkfree(dev->tmp_buffer);\r\npci_iounmap(pci_dev, dev->mmio);\r\npci_free_consistent(pci_dev, R852_DMA_LEN,\r\ndev->bounce_buffer, dev->phys_bounce_buffer);\r\nkfree(dev->chip);\r\nkfree(dev);\r\npci_release_regions(pci_dev);\r\npci_disable_device(pci_dev);\r\n}\r\nstatic void r852_shutdown(struct pci_dev *pci_dev)\r\n{\r\nstruct r852_device *dev = pci_get_drvdata(pci_dev);\r\ncancel_delayed_work_sync(&dev->card_detect_work);\r\nr852_disable_irqs(dev);\r\nsynchronize_irq(dev->irq);\r\npci_disable_device(pci_dev);\r\n}\r\nstatic int r852_suspend(struct device *device)\r\n{\r\nstruct r852_device *dev = pci_get_drvdata(to_pci_dev(device));\r\nif (dev->ctlreg & R852_CTL_CARDENABLE)\r\nreturn -EBUSY;\r\ncancel_delayed_work_sync(&dev->card_detect_work);\r\nr852_disable_irqs(dev);\r\nr852_engine_disable(dev);\r\ndev->card_unstable = 0;\r\nreturn 0;\r\n}\r\nstatic int r852_resume(struct device *device)\r\n{\r\nstruct r852_device *dev = pci_get_drvdata(to_pci_dev(device));\r\nr852_disable_irqs(dev);\r\nr852_card_update_present(dev);\r\nr852_engine_disable(dev);\r\nif (dev->card_detected != dev->card_registred) {\r\ndbg("card was %s during low power state",\r\ndev->card_detected ? "added" : "removed");\r\nqueue_delayed_work(dev->card_workqueue,\r\n&dev->card_detect_work, msecs_to_jiffies(1000));\r\nreturn 0;\r\n}\r\nif (dev->card_registred) {\r\nr852_engine_enable(dev);\r\ndev->chip->select_chip(dev->mtd, 0);\r\ndev->chip->cmdfunc(dev->mtd, NAND_CMD_RESET, -1, -1);\r\ndev->chip->select_chip(dev->mtd, -1);\r\n}\r\nr852_update_card_detect(dev);\r\nreturn 0;\r\n}

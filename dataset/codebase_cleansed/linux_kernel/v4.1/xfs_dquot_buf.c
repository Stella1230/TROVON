int\r\nxfs_calc_dquots_per_chunk(\r\nunsigned int nbblks)\r\n{\r\nunsigned int ndquots;\r\nASSERT(nbblks > 0);\r\nndquots = BBTOB(nbblks);\r\ndo_div(ndquots, sizeof(xfs_dqblk_t));\r\nreturn ndquots;\r\n}\r\nint\r\nxfs_dqcheck(\r\nstruct xfs_mount *mp,\r\nxfs_disk_dquot_t *ddq,\r\nxfs_dqid_t id,\r\nuint type,\r\nuint flags,\r\nchar *str)\r\n{\r\nxfs_dqblk_t *d = (xfs_dqblk_t *)ddq;\r\nint errs = 0;\r\nif (ddq->d_magic != cpu_to_be16(XFS_DQUOT_MAGIC)) {\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_alert(mp,\r\n"%s : XFS dquot ID 0x%x, magic 0x%x != 0x%x",\r\nstr, id, be16_to_cpu(ddq->d_magic), XFS_DQUOT_MAGIC);\r\nerrs++;\r\n}\r\nif (ddq->d_version != XFS_DQUOT_VERSION) {\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_alert(mp,\r\n"%s : XFS dquot ID 0x%x, version 0x%x != 0x%x",\r\nstr, id, ddq->d_version, XFS_DQUOT_VERSION);\r\nerrs++;\r\n}\r\nif (ddq->d_flags != XFS_DQ_USER &&\r\nddq->d_flags != XFS_DQ_PROJ &&\r\nddq->d_flags != XFS_DQ_GROUP) {\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_alert(mp,\r\n"%s : XFS dquot ID 0x%x, unknown flags 0x%x",\r\nstr, id, ddq->d_flags);\r\nerrs++;\r\n}\r\nif (id != -1 && id != be32_to_cpu(ddq->d_id)) {\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_alert(mp,\r\n"%s : ondisk-dquot 0x%p, ID mismatch: "\r\n"0x%x expected, found id 0x%x",\r\nstr, ddq, id, be32_to_cpu(ddq->d_id));\r\nerrs++;\r\n}\r\nif (!errs && ddq->d_id) {\r\nif (ddq->d_blk_softlimit &&\r\nbe64_to_cpu(ddq->d_bcount) >\r\nbe64_to_cpu(ddq->d_blk_softlimit)) {\r\nif (!ddq->d_btimer) {\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_alert(mp,\r\n"%s : Dquot ID 0x%x (0x%p) BLK TIMER NOT STARTED",\r\nstr, (int)be32_to_cpu(ddq->d_id), ddq);\r\nerrs++;\r\n}\r\n}\r\nif (ddq->d_ino_softlimit &&\r\nbe64_to_cpu(ddq->d_icount) >\r\nbe64_to_cpu(ddq->d_ino_softlimit)) {\r\nif (!ddq->d_itimer) {\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_alert(mp,\r\n"%s : Dquot ID 0x%x (0x%p) INODE TIMER NOT STARTED",\r\nstr, (int)be32_to_cpu(ddq->d_id), ddq);\r\nerrs++;\r\n}\r\n}\r\nif (ddq->d_rtb_softlimit &&\r\nbe64_to_cpu(ddq->d_rtbcount) >\r\nbe64_to_cpu(ddq->d_rtb_softlimit)) {\r\nif (!ddq->d_rtbtimer) {\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_alert(mp,\r\n"%s : Dquot ID 0x%x (0x%p) RTBLK TIMER NOT STARTED",\r\nstr, (int)be32_to_cpu(ddq->d_id), ddq);\r\nerrs++;\r\n}\r\n}\r\n}\r\nif (!errs || !(flags & XFS_QMOPT_DQREPAIR))\r\nreturn errs;\r\nif (flags & XFS_QMOPT_DOWARN)\r\nxfs_notice(mp, "Re-initializing dquot ID 0x%x", id);\r\nASSERT(id != -1);\r\nASSERT(flags & XFS_QMOPT_DQREPAIR);\r\nmemset(d, 0, sizeof(xfs_dqblk_t));\r\nd->dd_diskdq.d_magic = cpu_to_be16(XFS_DQUOT_MAGIC);\r\nd->dd_diskdq.d_version = XFS_DQUOT_VERSION;\r\nd->dd_diskdq.d_flags = type;\r\nd->dd_diskdq.d_id = cpu_to_be32(id);\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nuuid_copy(&d->dd_uuid, &mp->m_sb.sb_uuid);\r\nxfs_update_cksum((char *)d, sizeof(struct xfs_dqblk),\r\nXFS_DQUOT_CRC_OFF);\r\n}\r\nreturn errs;\r\n}\r\nSTATIC bool\r\nxfs_dquot_buf_verify_crc(\r\nstruct xfs_mount *mp,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dqblk *d = (struct xfs_dqblk *)bp->b_addr;\r\nint ndquots;\r\nint i;\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn true;\r\nif (mp->m_quotainfo)\r\nndquots = mp->m_quotainfo->qi_dqperchunk;\r\nelse\r\nndquots = xfs_calc_dquots_per_chunk(\r\nXFS_BB_TO_FSB(mp, bp->b_length));\r\nfor (i = 0; i < ndquots; i++, d++) {\r\nif (!xfs_verify_cksum((char *)d, sizeof(struct xfs_dqblk),\r\nXFS_DQUOT_CRC_OFF))\r\nreturn false;\r\nif (!uuid_equal(&d->dd_uuid, &mp->m_sb.sb_uuid))\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nSTATIC bool\r\nxfs_dquot_buf_verify(\r\nstruct xfs_mount *mp,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dqblk *d = (struct xfs_dqblk *)bp->b_addr;\r\nxfs_dqid_t id = 0;\r\nint ndquots;\r\nint i;\r\nif (mp->m_quotainfo)\r\nndquots = mp->m_quotainfo->qi_dqperchunk;\r\nelse\r\nndquots = xfs_calc_dquots_per_chunk(bp->b_length);\r\nfor (i = 0; i < ndquots; i++) {\r\nstruct xfs_disk_dquot *ddq;\r\nint error;\r\nddq = &d[i].dd_diskdq;\r\nif (i == 0)\r\nid = be32_to_cpu(ddq->d_id);\r\nerror = xfs_dqcheck(mp, ddq, id + i, 0, XFS_QMOPT_DOWARN,\r\n"xfs_dquot_buf_verify");\r\nif (error)\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic void\r\nxfs_dquot_buf_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nif (!xfs_dquot_buf_verify_crc(mp, bp))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_dquot_buf_verify(mp, bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error)\r\nxfs_verifier_error(bp);\r\n}\r\nstatic void\r\nxfs_dquot_buf_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nif (!xfs_dquot_buf_verify(mp, bp)) {\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\n}

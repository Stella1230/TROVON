static const uint32_t *sti_cursor_get_formats(struct sti_layer *layer)\r\n{\r\nreturn cursor_supported_formats;\r\n}\r\nstatic unsigned int sti_cursor_get_nb_formats(struct sti_layer *layer)\r\n{\r\nreturn ARRAY_SIZE(cursor_supported_formats);\r\n}\r\nstatic void sti_cursor_argb8888_to_clut8(struct sti_layer *layer)\r\n{\r\nstruct sti_cursor *cursor = to_sti_cursor(layer);\r\nu32 *src = layer->vaddr;\r\nu8 *dst = cursor->pixmap.base;\r\nunsigned int i, j;\r\nu32 a, r, g, b;\r\nfor (i = 0; i < cursor->height; i++) {\r\nfor (j = 0; j < cursor->width; j++) {\r\na = (*src >> 30) & 3;\r\nr = (*src >> 22) & 3;\r\ng = (*src >> 14) & 3;\r\nb = (*src >> 6) & 3;\r\n*dst = a << 6 | r << 4 | g << 2 | b;\r\nsrc++;\r\ndst++;\r\n}\r\n}\r\n}\r\nstatic int sti_cursor_prepare_layer(struct sti_layer *layer, bool first_prepare)\r\n{\r\nstruct sti_cursor *cursor = to_sti_cursor(layer);\r\nstruct drm_display_mode *mode = layer->mode;\r\nu32 y, x;\r\nu32 val;\r\nDRM_DEBUG_DRIVER("\n");\r\ndev_dbg(layer->dev, "%s %s\n", __func__, sti_layer_to_str(layer));\r\nif (layer->src_w < STI_CURS_MIN_SIZE ||\r\nlayer->src_h < STI_CURS_MIN_SIZE ||\r\nlayer->src_w > STI_CURS_MAX_SIZE ||\r\nlayer->src_h > STI_CURS_MAX_SIZE) {\r\nDRM_ERROR("Invalid cursor size (%dx%d)\n",\r\nlayer->src_w, layer->src_h);\r\nreturn -EINVAL;\r\n}\r\nif (!cursor->pixmap.base ||\r\n(cursor->width != layer->src_w) ||\r\n(cursor->height != layer->src_h)) {\r\ncursor->width = layer->src_w;\r\ncursor->height = layer->src_h;\r\nif (cursor->pixmap.base)\r\ndma_free_writecombine(layer->dev,\r\ncursor->pixmap.size,\r\ncursor->pixmap.base,\r\ncursor->pixmap.paddr);\r\ncursor->pixmap.size = cursor->width * cursor->height;\r\ncursor->pixmap.base = dma_alloc_writecombine(layer->dev,\r\ncursor->pixmap.size,\r\n&cursor->pixmap.paddr,\r\nGFP_KERNEL | GFP_DMA);\r\nif (!cursor->pixmap.base) {\r\nDRM_ERROR("Failed to allocate memory for pixmap\n");\r\nreturn -ENOMEM;\r\n}\r\n}\r\nsti_cursor_argb8888_to_clut8(layer);\r\ny = sti_vtg_get_line_number(*mode, 0);\r\nx = sti_vtg_get_pixel_number(*mode, 0);\r\nval = y << 16 | x;\r\nwritel(val, layer->regs + CUR_AWS);\r\ny = sti_vtg_get_line_number(*mode, mode->vdisplay - 1);\r\nx = sti_vtg_get_pixel_number(*mode, mode->hdisplay - 1);\r\nval = y << 16 | x;\r\nwritel(val, layer->regs + CUR_AWE);\r\nif (first_prepare) {\r\nwritel(cursor->clut_paddr, layer->regs + CUR_CML);\r\nwritel(CUR_CTL_CLUT_UPDATE, layer->regs + CUR_CTL);\r\n}\r\nreturn 0;\r\n}\r\nstatic int sti_cursor_commit_layer(struct sti_layer *layer)\r\n{\r\nstruct sti_cursor *cursor = to_sti_cursor(layer);\r\nstruct drm_display_mode *mode = layer->mode;\r\nu32 ydo, xdo;\r\ndev_dbg(layer->dev, "%s %s\n", __func__, sti_layer_to_str(layer));\r\nwritel(cursor->pixmap.paddr, layer->regs + CUR_PML);\r\nwritel(cursor->width, layer->regs + CUR_PMP);\r\nwritel(cursor->height << 16 | cursor->width, layer->regs + CUR_SIZE);\r\nydo = sti_vtg_get_line_number(*mode, layer->dst_y);\r\nxdo = sti_vtg_get_pixel_number(*mode, layer->dst_y);\r\nwritel((ydo << 16) | xdo, layer->regs + CUR_VPO);\r\nreturn 0;\r\n}\r\nstatic int sti_cursor_disable_layer(struct sti_layer *layer)\r\n{\r\nreturn 0;\r\n}\r\nstatic void sti_cursor_init(struct sti_layer *layer)\r\n{\r\nstruct sti_cursor *cursor = to_sti_cursor(layer);\r\nunsigned short *base = cursor->clut;\r\nunsigned int a, r, g, b;\r\nfor (a = 0; a < 4; a++)\r\nfor (r = 0; r < 4; r++)\r\nfor (g = 0; g < 4; g++)\r\nfor (b = 0; b < 4; b++)\r\n*base++ = (a * 5) << 12 |\r\n(r * 5) << 8 |\r\n(g * 5) << 4 |\r\n(b * 5);\r\n}\r\nstruct sti_layer *sti_cursor_create(struct device *dev)\r\n{\r\nstruct sti_cursor *cursor;\r\ncursor = devm_kzalloc(dev, sizeof(*cursor), GFP_KERNEL);\r\nif (!cursor) {\r\nDRM_ERROR("Failed to allocate memory for cursor\n");\r\nreturn NULL;\r\n}\r\ncursor->clut = dma_alloc_writecombine(dev,\r\n0x100 * sizeof(unsigned short),\r\n&cursor->clut_paddr,\r\nGFP_KERNEL | GFP_DMA);\r\nif (!cursor->clut) {\r\nDRM_ERROR("Failed to allocate memory for cursor clut\n");\r\ndevm_kfree(dev, cursor);\r\nreturn NULL;\r\n}\r\ncursor->layer.ops = &cursor_ops;\r\nreturn (struct sti_layer *)cursor;\r\n}

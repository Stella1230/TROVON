static int cpia_usb_transferCmd(struct gspca_dev *gspca_dev, u8 *command)\r\n{\r\nu8 requesttype;\r\nunsigned int pipe;\r\nint ret, databytes = command[6] | (command[7] << 8);\r\nint retries = 3;\r\nif (command[0] == DATA_IN) {\r\npipe = usb_rcvctrlpipe(gspca_dev->dev, 0);\r\nrequesttype = USB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE;\r\n} else if (command[0] == DATA_OUT) {\r\npipe = usb_sndctrlpipe(gspca_dev->dev, 0);\r\nrequesttype = USB_TYPE_VENDOR | USB_RECIP_DEVICE;\r\n} else {\r\nPERR("Unexpected first byte of command: %x", command[0]);\r\nreturn -EINVAL;\r\n}\r\nretry:\r\nret = usb_control_msg(gspca_dev->dev, pipe,\r\ncommand[1],\r\nrequesttype,\r\ncommand[2] | (command[3] << 8),\r\ncommand[4] | (command[5] << 8),\r\ngspca_dev->usb_buf, databytes, 1000);\r\nif (ret < 0)\r\npr_err("usb_control_msg %02x, error %d\n", command[1], ret);\r\nif (ret == -EPIPE && retries > 0) {\r\nretries--;\r\ngoto retry;\r\n}\r\nreturn (ret < 0) ? ret : 0;\r\n}\r\nstatic int do_command(struct gspca_dev *gspca_dev, u16 command,\r\nu8 a, u8 b, u8 c, u8 d)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint ret, datasize;\r\nu8 cmd[8];\r\nswitch (command) {\r\ncase CPIA_COMMAND_GetCPIAVersion:\r\ncase CPIA_COMMAND_GetPnPID:\r\ncase CPIA_COMMAND_GetCameraStatus:\r\ncase CPIA_COMMAND_GetVPVersion:\r\ncase CPIA_COMMAND_GetColourParams:\r\ncase CPIA_COMMAND_GetColourBalance:\r\ncase CPIA_COMMAND_GetExposure:\r\ndatasize = 8;\r\nbreak;\r\ncase CPIA_COMMAND_ReadMCPorts:\r\ncase CPIA_COMMAND_ReadVCRegs:\r\ndatasize = 4;\r\nbreak;\r\ndefault:\r\ndatasize = 0;\r\nbreak;\r\n}\r\ncmd[0] = command >> 8;\r\ncmd[1] = command & 0xff;\r\ncmd[2] = a;\r\ncmd[3] = b;\r\ncmd[4] = c;\r\ncmd[5] = d;\r\ncmd[6] = datasize;\r\ncmd[7] = 0;\r\nret = cpia_usb_transferCmd(gspca_dev, cmd);\r\nif (ret)\r\nreturn ret;\r\nswitch (command) {\r\ncase CPIA_COMMAND_GetCPIAVersion:\r\nsd->params.version.firmwareVersion = gspca_dev->usb_buf[0];\r\nsd->params.version.firmwareRevision = gspca_dev->usb_buf[1];\r\nsd->params.version.vcVersion = gspca_dev->usb_buf[2];\r\nsd->params.version.vcRevision = gspca_dev->usb_buf[3];\r\nbreak;\r\ncase CPIA_COMMAND_GetPnPID:\r\nsd->params.pnpID.vendor =\r\ngspca_dev->usb_buf[0] | (gspca_dev->usb_buf[1] << 8);\r\nsd->params.pnpID.product =\r\ngspca_dev->usb_buf[2] | (gspca_dev->usb_buf[3] << 8);\r\nsd->params.pnpID.deviceRevision =\r\ngspca_dev->usb_buf[4] | (gspca_dev->usb_buf[5] << 8);\r\nbreak;\r\ncase CPIA_COMMAND_GetCameraStatus:\r\nsd->params.status.systemState = gspca_dev->usb_buf[0];\r\nsd->params.status.grabState = gspca_dev->usb_buf[1];\r\nsd->params.status.streamState = gspca_dev->usb_buf[2];\r\nsd->params.status.fatalError = gspca_dev->usb_buf[3];\r\nsd->params.status.cmdError = gspca_dev->usb_buf[4];\r\nsd->params.status.debugFlags = gspca_dev->usb_buf[5];\r\nsd->params.status.vpStatus = gspca_dev->usb_buf[6];\r\nsd->params.status.errorCode = gspca_dev->usb_buf[7];\r\nbreak;\r\ncase CPIA_COMMAND_GetVPVersion:\r\nsd->params.vpVersion.vpVersion = gspca_dev->usb_buf[0];\r\nsd->params.vpVersion.vpRevision = gspca_dev->usb_buf[1];\r\nsd->params.vpVersion.cameraHeadID =\r\ngspca_dev->usb_buf[2] | (gspca_dev->usb_buf[3] << 8);\r\nbreak;\r\ncase CPIA_COMMAND_GetColourParams:\r\nsd->params.colourParams.brightness = gspca_dev->usb_buf[0];\r\nsd->params.colourParams.contrast = gspca_dev->usb_buf[1];\r\nsd->params.colourParams.saturation = gspca_dev->usb_buf[2];\r\nbreak;\r\ncase CPIA_COMMAND_GetColourBalance:\r\nsd->params.colourBalance.redGain = gspca_dev->usb_buf[0];\r\nsd->params.colourBalance.greenGain = gspca_dev->usb_buf[1];\r\nsd->params.colourBalance.blueGain = gspca_dev->usb_buf[2];\r\nbreak;\r\ncase CPIA_COMMAND_GetExposure:\r\nsd->params.exposure.gain = gspca_dev->usb_buf[0];\r\nsd->params.exposure.fineExp = gspca_dev->usb_buf[1];\r\nsd->params.exposure.coarseExpLo = gspca_dev->usb_buf[2];\r\nsd->params.exposure.coarseExpHi = gspca_dev->usb_buf[3];\r\nsd->params.exposure.redComp = gspca_dev->usb_buf[4];\r\nsd->params.exposure.green1Comp = gspca_dev->usb_buf[5];\r\nsd->params.exposure.green2Comp = gspca_dev->usb_buf[6];\r\nsd->params.exposure.blueComp = gspca_dev->usb_buf[7];\r\nbreak;\r\ncase CPIA_COMMAND_ReadMCPorts:\r\na = ((gspca_dev->usb_buf[1] & 0x02) == 0);\r\nif (a != sd->params.qx3.button) {\r\n#if IS_ENABLED(CONFIG_INPUT)\r\ninput_report_key(gspca_dev->input_dev, KEY_CAMERA, a);\r\ninput_sync(gspca_dev->input_dev);\r\n#endif\r\nsd->params.qx3.button = a;\r\n}\r\nif (sd->params.qx3.button) {\r\ndo_command(gspca_dev, CPIA_COMMAND_WriteMCPort,\r\n3, 0xdf, 0xdf, 0);\r\ndo_command(gspca_dev, CPIA_COMMAND_WriteMCPort,\r\n3, 0xff, 0xff, 0);\r\n}\r\nsd->params.qx3.cradled = ((gspca_dev->usb_buf[2] & 0x40) == 0);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int do_command_extended(struct gspca_dev *gspca_dev, u16 command,\r\nu8 a, u8 b, u8 c, u8 d,\r\nu8 e, u8 f, u8 g, u8 h,\r\nu8 i, u8 j, u8 k, u8 l)\r\n{\r\nu8 cmd[8];\r\ncmd[0] = command >> 8;\r\ncmd[1] = command & 0xff;\r\ncmd[2] = a;\r\ncmd[3] = b;\r\ncmd[4] = c;\r\ncmd[5] = d;\r\ncmd[6] = 8;\r\ncmd[7] = 0;\r\ngspca_dev->usb_buf[0] = e;\r\ngspca_dev->usb_buf[1] = f;\r\ngspca_dev->usb_buf[2] = g;\r\ngspca_dev->usb_buf[3] = h;\r\ngspca_dev->usb_buf[4] = i;\r\ngspca_dev->usb_buf[5] = j;\r\ngspca_dev->usb_buf[6] = k;\r\ngspca_dev->usb_buf[7] = l;\r\nreturn cpia_usb_transferCmd(gspca_dev, cmd);\r\n}\r\nstatic int find_over_exposure(int brightness)\r\n{\r\nint MaxAllowableOverExposure, OverExposure;\r\nMaxAllowableOverExposure = FLICKER_MAX_EXPOSURE - brightness -\r\nFLICKER_BRIGHTNESS_CONSTANT;\r\nif (MaxAllowableOverExposure < FLICKER_ALLOWABLE_OVER_EXPOSURE)\r\nOverExposure = MaxAllowableOverExposure;\r\nelse\r\nOverExposure = FLICKER_ALLOWABLE_OVER_EXPOSURE;\r\nreturn OverExposure;\r\n}\r\nstatic void reset_camera_params(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam_params *params = &sd->params;\r\nparams->colourParams.brightness = BRIGHTNESS_DEF;\r\nparams->colourParams.contrast = CONTRAST_DEF;\r\nparams->colourParams.saturation = SATURATION_DEF;\r\nparams->exposure.gainMode = 4;\r\nparams->exposure.expMode = 2;\r\nparams->exposure.compMode = 1;\r\nparams->exposure.centreWeight = 1;\r\nparams->exposure.gain = 0;\r\nparams->exposure.fineExp = 0;\r\nparams->exposure.coarseExpLo = 185;\r\nparams->exposure.coarseExpHi = 0;\r\nparams->exposure.redComp = COMP_RED;\r\nparams->exposure.green1Comp = COMP_GREEN1;\r\nparams->exposure.green2Comp = COMP_GREEN2;\r\nparams->exposure.blueComp = COMP_BLUE;\r\nparams->colourBalance.balanceMode = 2;\r\nparams->colourBalance.redGain = 32;\r\nparams->colourBalance.greenGain = 6;\r\nparams->colourBalance.blueGain = 92;\r\nparams->apcor.gain1 = 0x18;\r\nparams->apcor.gain2 = 0x16;\r\nparams->apcor.gain4 = 0x24;\r\nparams->apcor.gain8 = 0x34;\r\nparams->vlOffset.gain1 = 20;\r\nparams->vlOffset.gain2 = 24;\r\nparams->vlOffset.gain4 = 26;\r\nparams->vlOffset.gain8 = 26;\r\nparams->compressionParams.hysteresis = 3;\r\nparams->compressionParams.threshMax = 11;\r\nparams->compressionParams.smallStep = 1;\r\nparams->compressionParams.largeStep = 3;\r\nparams->compressionParams.decimationHysteresis = 2;\r\nparams->compressionParams.frDiffStepThresh = 5;\r\nparams->compressionParams.qDiffStepThresh = 3;\r\nparams->compressionParams.decimationThreshMod = 2;\r\nparams->sensorFps.divisor = 1;\r\nparams->sensorFps.baserate = 1;\r\nparams->flickerControl.flickerMode = 0;\r\nparams->flickerControl.disabled = 1;\r\nparams->flickerControl.coarseJump =\r\nflicker_jumps[sd->mainsFreq]\r\n[params->sensorFps.baserate]\r\n[params->sensorFps.divisor];\r\nparams->flickerControl.allowableOverExposure =\r\nfind_over_exposure(params->colourParams.brightness);\r\nparams->yuvThreshold.yThreshold = 6;\r\nparams->yuvThreshold.uvThreshold = 6;\r\nparams->format.subSample = SUBSAMPLE_420;\r\nparams->format.yuvOrder = YUVORDER_YUYV;\r\nparams->compression.mode = CPIA_COMPRESSION_AUTO;\r\nparams->compression.decimation = NO_DECIMATION;\r\nparams->compressionTarget.frTargeting = COMP_TARGET_DEF;\r\nparams->compressionTarget.targetFR = 15;\r\nparams->compressionTarget.targetQ = 5;\r\nparams->qx3.qx3_detected = 0;\r\nparams->qx3.toplight = 0;\r\nparams->qx3.bottomlight = 0;\r\nparams->qx3.button = 0;\r\nparams->qx3.cradled = 0;\r\n}\r\nstatic void printstatus(struct gspca_dev *gspca_dev, struct cam_params *params)\r\n{\r\nPDEBUG(D_PROBE, "status: %02x %02x %02x %02x %02x %02x %02x %02x",\r\nparams->status.systemState, params->status.grabState,\r\nparams->status.streamState, params->status.fatalError,\r\nparams->status.cmdError, params->status.debugFlags,\r\nparams->status.vpStatus, params->status.errorCode);\r\n}\r\nstatic int goto_low_power(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_GotoLoPower, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nif (sd->params.status.systemState != LO_POWER_STATE) {\r\nif (sd->params.status.systemState != WARM_BOOT_STATE) {\r\nPERR("unexpected state after lo power cmd: %02x",\r\nsd->params.status.systemState);\r\nprintstatus(gspca_dev, &sd->params);\r\n}\r\nreturn -EIO;\r\n}\r\nPDEBUG(D_CONF, "camera now in LOW power state");\r\nreturn 0;\r\n}\r\nstatic int goto_high_power(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_GotoHiPower, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nmsleep_interruptible(40);\r\nif (signal_pending(current))\r\nreturn -EINTR;\r\nret = do_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nif (sd->params.status.systemState != HI_POWER_STATE) {\r\nPERR("unexpected state after hi power cmd: %02x",\r\nsd->params.status.systemState);\r\nprintstatus(gspca_dev, &sd->params);\r\nreturn -EIO;\r\n}\r\nPDEBUG(D_CONF, "camera now in HIGH power state");\r\nreturn 0;\r\n}\r\nstatic int get_version_information(struct gspca_dev *gspca_dev)\r\n{\r\nint ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_GetCPIAVersion, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_GetPnPID, 0, 0, 0, 0);\r\n}\r\nstatic int save_camera_state(struct gspca_dev *gspca_dev)\r\n{\r\nint ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_GetColourBalance, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_GetExposure, 0, 0, 0, 0);\r\n}\r\nstatic int command_setformat(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_SetFormat,\r\nsd->params.format.videoSize,\r\nsd->params.format.subSample,\r\nsd->params.format.yuvOrder, 0);\r\nif (ret)\r\nreturn ret;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetROI,\r\nsd->params.roi.colStart, sd->params.roi.colEnd,\r\nsd->params.roi.rowStart, sd->params.roi.rowEnd);\r\n}\r\nstatic int command_setcolourparams(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetColourParams,\r\nsd->params.colourParams.brightness,\r\nsd->params.colourParams.contrast,\r\nsd->params.colourParams.saturation, 0);\r\n}\r\nstatic int command_setapcor(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetApcor,\r\nsd->params.apcor.gain1,\r\nsd->params.apcor.gain2,\r\nsd->params.apcor.gain4,\r\nsd->params.apcor.gain8);\r\n}\r\nstatic int command_setvloffset(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetVLOffset,\r\nsd->params.vlOffset.gain1,\r\nsd->params.vlOffset.gain2,\r\nsd->params.vlOffset.gain4,\r\nsd->params.vlOffset.gain8);\r\n}\r\nstatic int command_setexposure(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint ret;\r\nret = do_command_extended(gspca_dev, CPIA_COMMAND_SetExposure,\r\nsd->params.exposure.gainMode,\r\n1,\r\nsd->params.exposure.compMode,\r\nsd->params.exposure.centreWeight,\r\nsd->params.exposure.gain,\r\nsd->params.exposure.fineExp,\r\nsd->params.exposure.coarseExpLo,\r\nsd->params.exposure.coarseExpHi,\r\nsd->params.exposure.redComp,\r\nsd->params.exposure.green1Comp,\r\nsd->params.exposure.green2Comp,\r\nsd->params.exposure.blueComp);\r\nif (ret)\r\nreturn ret;\r\nif (sd->params.exposure.expMode != 1) {\r\nret = do_command_extended(gspca_dev, CPIA_COMMAND_SetExposure,\r\n0,\r\nsd->params.exposure.expMode,\r\n0, 0,\r\nsd->params.exposure.gain,\r\nsd->params.exposure.fineExp,\r\nsd->params.exposure.coarseExpLo,\r\nsd->params.exposure.coarseExpHi,\r\n0, 0, 0, 0);\r\n}\r\nreturn ret;\r\n}\r\nstatic int command_setcolourbalance(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (sd->params.colourBalance.balanceMode == 1) {\r\nint ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\r\n1,\r\nsd->params.colourBalance.redGain,\r\nsd->params.colourBalance.greenGain,\r\nsd->params.colourBalance.blueGain);\r\nif (ret)\r\nreturn ret;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\r\n3, 0, 0, 0);\r\n}\r\nif (sd->params.colourBalance.balanceMode == 2) {\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\r\n2, 0, 0, 0);\r\n}\r\nif (sd->params.colourBalance.balanceMode == 3) {\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\r\n3, 0, 0, 0);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int command_setcompressiontarget(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetCompressionTarget,\r\nsd->params.compressionTarget.frTargeting,\r\nsd->params.compressionTarget.targetFR,\r\nsd->params.compressionTarget.targetQ, 0);\r\n}\r\nstatic int command_setyuvtresh(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetYUVThresh,\r\nsd->params.yuvThreshold.yThreshold,\r\nsd->params.yuvThreshold.uvThreshold, 0, 0);\r\n}\r\nstatic int command_setcompressionparams(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command_extended(gspca_dev,\r\nCPIA_COMMAND_SetCompressionParams,\r\n0, 0, 0, 0,\r\nsd->params.compressionParams.hysteresis,\r\nsd->params.compressionParams.threshMax,\r\nsd->params.compressionParams.smallStep,\r\nsd->params.compressionParams.largeStep,\r\nsd->params.compressionParams.decimationHysteresis,\r\nsd->params.compressionParams.frDiffStepThresh,\r\nsd->params.compressionParams.qDiffStepThresh,\r\nsd->params.compressionParams.decimationThreshMod);\r\n}\r\nstatic int command_setcompression(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetCompression,\r\nsd->params.compression.mode,\r\nsd->params.compression.decimation, 0, 0);\r\n}\r\nstatic int command_setsensorfps(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetSensorFPS,\r\nsd->params.sensorFps.divisor,\r\nsd->params.sensorFps.baserate, 0, 0);\r\n}\r\nstatic int command_setflickerctrl(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetFlickerCtrl,\r\nsd->params.flickerControl.flickerMode,\r\nsd->params.flickerControl.coarseJump,\r\nsd->params.flickerControl.allowableOverExposure,\r\n0);\r\n}\r\nstatic int command_setecptiming(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_SetECPTiming,\r\nsd->params.ecpTiming, 0, 0, 0);\r\n}\r\nstatic int command_pause(struct gspca_dev *gspca_dev)\r\n{\r\nreturn do_command(gspca_dev, CPIA_COMMAND_EndStreamCap, 0, 0, 0, 0);\r\n}\r\nstatic int command_resume(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_InitStreamCap,\r\n0, sd->params.streamStartLine, 0, 0);\r\n}\r\nstatic int command_setlights(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint ret, p1, p2;\r\np1 = (sd->params.qx3.bottomlight == 0) << 1;\r\np2 = (sd->params.qx3.toplight == 0) << 3;\r\nret = do_command(gspca_dev, CPIA_COMMAND_WriteVCReg,\r\n0x90, 0x8f, 0x50, 0);\r\nif (ret)\r\nreturn ret;\r\nreturn do_command(gspca_dev, CPIA_COMMAND_WriteMCPort, 2, 0,\r\np1 | p2 | 0xe0, 0);\r\n}\r\nstatic int set_flicker(struct gspca_dev *gspca_dev, int on, int apply)\r\n{\r\n#if 0\r\n#define COMPGAIN(base, curexp, newexp) \\r\n(u8) ((((float) base - 128.0) * ((float) curexp / (float) newexp)) + 128.5)\r\n#define EXP_FROM_COMP(basecomp, curcomp, curexp) \\r\n(u16)((float)curexp * (float)(u8)(curcomp + 128) / \\r\n(float)(u8)(basecomp - 128))\r\n#else\r\n#define COMPGAIN(base, curexp, newexp) \\r\n(u8)(128 + (((u32)(2*(base-128)*curexp + newexp)) / (2 * newexp)))\r\n#define EXP_FROM_COMP(basecomp, curcomp, curexp) \\r\n(u16)(((u32)(curexp * (u8)(curcomp + 128)) / (u8)(basecomp - 128)))\r\n#endif\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint currentexp = sd->params.exposure.coarseExpLo +\r\nsd->params.exposure.coarseExpHi * 256;\r\nint ret, startexp;\r\nif (on) {\r\nint cj = sd->params.flickerControl.coarseJump;\r\nsd->params.flickerControl.flickerMode = 1;\r\nsd->params.flickerControl.disabled = 0;\r\nif (sd->params.exposure.expMode != 2) {\r\nsd->params.exposure.expMode = 2;\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\n}\r\ncurrentexp = currentexp << sd->params.exposure.gain;\r\nsd->params.exposure.gain = 0;\r\nstartexp = (currentexp + ROUND_UP_EXP_FOR_FLICKER) / cj;\r\nif (startexp < 1)\r\nstartexp = 1;\r\nstartexp = (startexp * cj) - 1;\r\nif (FIRMWARE_VERSION(1, 2))\r\nwhile (startexp > MAX_EXP_102)\r\nstartexp -= cj;\r\nelse\r\nwhile (startexp > MAX_EXP)\r\nstartexp -= cj;\r\nsd->params.exposure.coarseExpLo = startexp & 0xff;\r\nsd->params.exposure.coarseExpHi = startexp >> 8;\r\nif (currentexp > startexp) {\r\nif (currentexp > (2 * startexp))\r\ncurrentexp = 2 * startexp;\r\nsd->params.exposure.redComp =\r\nCOMPGAIN(COMP_RED, currentexp, startexp);\r\nsd->params.exposure.green1Comp =\r\nCOMPGAIN(COMP_GREEN1, currentexp, startexp);\r\nsd->params.exposure.green2Comp =\r\nCOMPGAIN(COMP_GREEN2, currentexp, startexp);\r\nsd->params.exposure.blueComp =\r\nCOMPGAIN(COMP_BLUE, currentexp, startexp);\r\n} else {\r\nsd->params.exposure.redComp = COMP_RED;\r\nsd->params.exposure.green1Comp = COMP_GREEN1;\r\nsd->params.exposure.green2Comp = COMP_GREEN2;\r\nsd->params.exposure.blueComp = COMP_BLUE;\r\n}\r\nif (FIRMWARE_VERSION(1, 2))\r\nsd->params.exposure.compMode = 0;\r\nelse\r\nsd->params.exposure.compMode = 1;\r\nsd->params.apcor.gain1 = 0x18;\r\nsd->params.apcor.gain2 = 0x18;\r\nsd->params.apcor.gain4 = 0x16;\r\nsd->params.apcor.gain8 = 0x14;\r\n} else {\r\nsd->params.flickerControl.flickerMode = 0;\r\nsd->params.flickerControl.disabled = 1;\r\nstartexp = EXP_FROM_COMP(COMP_RED,\r\nsd->params.exposure.redComp, currentexp);\r\nstartexp += EXP_FROM_COMP(COMP_GREEN1,\r\nsd->params.exposure.green1Comp, currentexp);\r\nstartexp += EXP_FROM_COMP(COMP_GREEN2,\r\nsd->params.exposure.green2Comp, currentexp);\r\nstartexp += EXP_FROM_COMP(COMP_BLUE,\r\nsd->params.exposure.blueComp, currentexp);\r\nstartexp = startexp >> 2;\r\nwhile (startexp > MAX_EXP && sd->params.exposure.gain <\r\nsd->params.exposure.gainMode - 1) {\r\nstartexp = startexp >> 1;\r\n++sd->params.exposure.gain;\r\n}\r\nif (FIRMWARE_VERSION(1, 2) && startexp > MAX_EXP_102)\r\nstartexp = MAX_EXP_102;\r\nif (startexp > MAX_EXP)\r\nstartexp = MAX_EXP;\r\nsd->params.exposure.coarseExpLo = startexp & 0xff;\r\nsd->params.exposure.coarseExpHi = startexp >> 8;\r\nsd->params.exposure.redComp = COMP_RED;\r\nsd->params.exposure.green1Comp = COMP_GREEN1;\r\nsd->params.exposure.green2Comp = COMP_GREEN2;\r\nsd->params.exposure.blueComp = COMP_BLUE;\r\nsd->params.exposure.compMode = 1;\r\nsd->params.apcor.gain1 = 0x18;\r\nsd->params.apcor.gain2 = 0x16;\r\nsd->params.apcor.gain4 = 0x24;\r\nsd->params.apcor.gain8 = 0x34;\r\n}\r\nsd->params.vlOffset.gain1 = 20;\r\nsd->params.vlOffset.gain2 = 24;\r\nsd->params.vlOffset.gain4 = 26;\r\nsd->params.vlOffset.gain8 = 26;\r\nif (apply) {\r\nret = command_setexposure(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setapcor(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setvloffset(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setflickerctrl(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n#undef EXP_FROM_COMP\r\n#undef COMPGAIN\r\n}\r\nstatic void monitor_exposure(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nu8 exp_acc, bcomp, cmd[8];\r\nint ret, light_exp, dark_exp, very_dark_exp;\r\nint old_exposure, new_exposure, framerate;\r\nint setfps = 0, setexp = 0, setflicker = 0;\r\ncmd[0] = CPIA_COMMAND_ReadVPRegs >> 8;\r\ncmd[1] = CPIA_COMMAND_ReadVPRegs & 0xff;\r\ncmd[2] = 30;\r\ncmd[3] = 4;\r\ncmd[4] = 9;\r\ncmd[5] = 8;\r\ncmd[6] = 8;\r\ncmd[7] = 0;\r\nret = cpia_usb_transferCmd(gspca_dev, cmd);\r\nif (ret) {\r\npr_err("ReadVPRegs(30,4,9,8) - failed: %d\n", ret);\r\nreturn;\r\n}\r\nexp_acc = gspca_dev->usb_buf[0];\r\nbcomp = gspca_dev->usb_buf[1];\r\nlight_exp = sd->params.colourParams.brightness +\r\nTC - 50 + EXP_ACC_LIGHT;\r\nif (light_exp > 255)\r\nlight_exp = 255;\r\ndark_exp = sd->params.colourParams.brightness +\r\nTC - 50 - EXP_ACC_DARK;\r\nif (dark_exp < 0)\r\ndark_exp = 0;\r\nvery_dark_exp = dark_exp / 2;\r\nold_exposure = sd->params.exposure.coarseExpHi * 256 +\r\nsd->params.exposure.coarseExpLo;\r\nif (!sd->params.flickerControl.disabled) {\r\nint max_comp = FIRMWARE_VERSION(1, 2) ? MAX_COMP :\r\nHIGH_COMP_102;\r\nbcomp += 128;\r\nif (bcomp >= max_comp && exp_acc < dark_exp) {\r\nif (exp_acc < very_dark_exp) {\r\nif (sd->exposure_status == EXPOSURE_VERY_DARK)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status =\r\nEXPOSURE_VERY_DARK;\r\nsd->exposure_count = 1;\r\n}\r\n} else {\r\nif (sd->exposure_status == EXPOSURE_DARK)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status = EXPOSURE_DARK;\r\nsd->exposure_count = 1;\r\n}\r\n}\r\n} else if (old_exposure <= LOW_EXP || exp_acc > light_exp) {\r\nif (old_exposure <= VERY_LOW_EXP) {\r\nif (sd->exposure_status == EXPOSURE_VERY_LIGHT)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status =\r\nEXPOSURE_VERY_LIGHT;\r\nsd->exposure_count = 1;\r\n}\r\n} else {\r\nif (sd->exposure_status == EXPOSURE_LIGHT)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status = EXPOSURE_LIGHT;\r\nsd->exposure_count = 1;\r\n}\r\n}\r\n} else {\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\n}\r\n} else {\r\nif (old_exposure >= MAX_EXP && exp_acc < dark_exp) {\r\nif (exp_acc < very_dark_exp) {\r\nif (sd->exposure_status == EXPOSURE_VERY_DARK)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status =\r\nEXPOSURE_VERY_DARK;\r\nsd->exposure_count = 1;\r\n}\r\n} else {\r\nif (sd->exposure_status == EXPOSURE_DARK)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status = EXPOSURE_DARK;\r\nsd->exposure_count = 1;\r\n}\r\n}\r\n} else if (old_exposure <= LOW_EXP || exp_acc > light_exp) {\r\nif (old_exposure <= VERY_LOW_EXP) {\r\nif (sd->exposure_status == EXPOSURE_VERY_LIGHT)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status =\r\nEXPOSURE_VERY_LIGHT;\r\nsd->exposure_count = 1;\r\n}\r\n} else {\r\nif (sd->exposure_status == EXPOSURE_LIGHT)\r\n++sd->exposure_count;\r\nelse {\r\nsd->exposure_status = EXPOSURE_LIGHT;\r\nsd->exposure_count = 1;\r\n}\r\n}\r\n} else {\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\n}\r\n}\r\nframerate = atomic_read(&sd->fps);\r\nif (framerate > 30 || framerate < 1)\r\nframerate = 1;\r\nif (!sd->params.flickerControl.disabled) {\r\nif ((sd->exposure_status == EXPOSURE_VERY_DARK ||\r\nsd->exposure_status == EXPOSURE_DARK) &&\r\nsd->exposure_count >= DARK_TIME * framerate &&\r\nsd->params.sensorFps.divisor < 2) {\r\n++sd->params.sensorFps.divisor;\r\nsetfps = 1;\r\nsd->params.flickerControl.coarseJump =\r\nflicker_jumps[sd->mainsFreq]\r\n[sd->params.sensorFps.baserate]\r\n[sd->params.sensorFps.divisor];\r\nsetflicker = 1;\r\nnew_exposure = sd->params.flickerControl.coarseJump-1;\r\nwhile (new_exposure < old_exposure / 2)\r\nnew_exposure +=\r\nsd->params.flickerControl.coarseJump;\r\nsd->params.exposure.coarseExpLo = new_exposure & 0xff;\r\nsd->params.exposure.coarseExpHi = new_exposure >> 8;\r\nsetexp = 1;\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\nPDEBUG(D_CONF, "Automatically decreasing sensor_fps");\r\n} else if ((sd->exposure_status == EXPOSURE_VERY_LIGHT ||\r\nsd->exposure_status == EXPOSURE_LIGHT) &&\r\nsd->exposure_count >= LIGHT_TIME * framerate &&\r\nsd->params.sensorFps.divisor > 0) {\r\nint max_exp = FIRMWARE_VERSION(1, 2) ? MAX_EXP_102 :\r\nMAX_EXP;\r\n--sd->params.sensorFps.divisor;\r\nsetfps = 1;\r\nsd->params.flickerControl.coarseJump =\r\nflicker_jumps[sd->mainsFreq]\r\n[sd->params.sensorFps.baserate]\r\n[sd->params.sensorFps.divisor];\r\nsetflicker = 1;\r\nnew_exposure = sd->params.flickerControl.coarseJump-1;\r\nwhile (new_exposure < 2 * old_exposure &&\r\nnew_exposure +\r\nsd->params.flickerControl.coarseJump < max_exp)\r\nnew_exposure +=\r\nsd->params.flickerControl.coarseJump;\r\nsd->params.exposure.coarseExpLo = new_exposure & 0xff;\r\nsd->params.exposure.coarseExpHi = new_exposure >> 8;\r\nsetexp = 1;\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\nPDEBUG(D_CONF, "Automatically increasing sensor_fps");\r\n}\r\n} else {\r\nif ((sd->exposure_status == EXPOSURE_VERY_DARK ||\r\nsd->exposure_status == EXPOSURE_DARK) &&\r\nsd->exposure_count >= DARK_TIME * framerate &&\r\nsd->params.sensorFps.divisor < 2) {\r\n++sd->params.sensorFps.divisor;\r\nsetfps = 1;\r\nif (sd->params.exposure.gain > 0) {\r\n--sd->params.exposure.gain;\r\nsetexp = 1;\r\n}\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\nPDEBUG(D_CONF, "Automatically decreasing sensor_fps");\r\n} else if ((sd->exposure_status == EXPOSURE_VERY_LIGHT ||\r\nsd->exposure_status == EXPOSURE_LIGHT) &&\r\nsd->exposure_count >= LIGHT_TIME * framerate &&\r\nsd->params.sensorFps.divisor > 0) {\r\n--sd->params.sensorFps.divisor;\r\nsetfps = 1;\r\nif (sd->params.exposure.gain <\r\nsd->params.exposure.gainMode - 1) {\r\n++sd->params.exposure.gain;\r\nsetexp = 1;\r\n}\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\nPDEBUG(D_CONF, "Automatically increasing sensor_fps");\r\n}\r\n}\r\nif (setexp)\r\ncommand_setexposure(gspca_dev);\r\nif (setfps)\r\ncommand_setsensorfps(gspca_dev);\r\nif (setflicker)\r\ncommand_setflickerctrl(gspca_dev);\r\n}\r\nstatic void restart_flicker(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint cam_exposure, old_exp;\r\nif (!FIRMWARE_VERSION(1, 2))\r\nreturn;\r\ncam_exposure = atomic_read(&sd->cam_exposure);\r\nif (sd->params.flickerControl.flickerMode == 0 ||\r\ncam_exposure == 0)\r\nreturn;\r\nold_exp = sd->params.exposure.coarseExpLo +\r\nsd->params.exposure.coarseExpHi*256;\r\ncam_exposure %= sd->params.flickerControl.coarseJump;\r\nif (!sd->params.flickerControl.disabled &&\r\ncam_exposure <= sd->params.flickerControl.coarseJump - 3) {\r\nsd->params.flickerControl.disabled = 1;\r\n}\r\nif (sd->params.flickerControl.disabled &&\r\nold_exp > sd->params.flickerControl.coarseJump +\r\nROUND_UP_EXP_FOR_FLICKER) {\r\nset_flicker(gspca_dev, 1, 1);\r\n}\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam *cam;\r\nsd->mainsFreq = FREQ_DEF == V4L2_CID_POWER_LINE_FREQUENCY_60HZ;\r\nreset_camera_params(gspca_dev);\r\nPDEBUG(D_PROBE, "cpia CPiA camera detected (vid/pid 0x%04X:0x%04X)",\r\nid->idVendor, id->idProduct);\r\ncam = &gspca_dev->cam;\r\ncam->cam_mode = mode;\r\ncam->nmodes = ARRAY_SIZE(mode);\r\ngoto_low_power(gspca_dev);\r\nsd->params.version.firmwareVersion = 0;\r\nget_version_information(gspca_dev);\r\nif (sd->params.version.firmwareVersion != 1) {\r\nPERR("only firmware version 1 is supported (got: %d)",\r\nsd->params.version.firmwareVersion);\r\nreturn -ENODEV;\r\n}\r\nif (sd->params.version.firmwareRevision <= 2 &&\r\nsd->params.exposure.gainMode > 2) {\r\nsd->params.exposure.gainMode = 2;\r\n}\r\nsd->params.qx3.qx3_detected = (sd->params.pnpID.vendor == 0x0813 &&\r\nsd->params.pnpID.product == 0x0001);\r\nreturn 0;\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint priv, ret;\r\nif (goto_low_power(gspca_dev)) {\r\nif (sd->params.status.systemState != WARM_BOOT_STATE) {\r\nPERR("unexpected systemstate: %02x",\r\nsd->params.status.systemState);\r\nprintstatus(gspca_dev, &sd->params);\r\nreturn -ENODEV;\r\n}\r\nret = goto_high_power(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_DiscardFrame,\r\n0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nret = goto_low_power(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nsd->params.version.firmwareVersion = 0;\r\nget_version_information(gspca_dev);\r\nret = do_command(gspca_dev, CPIA_COMMAND_ModifyCameraStatus,\r\nSTREAMSTATE, 0, STREAM_NOT_READY, 0);\r\nif (ret)\r\nreturn ret;\r\nret = goto_high_power(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nif (sd->params.status.fatalError) {\r\nPERR("fatal_error: %04x, vp_status: %04x",\r\nsd->params.status.fatalError, sd->params.status.vpStatus);\r\nreturn -EIO;\r\n}\r\nret = do_command(gspca_dev, CPIA_COMMAND_GetVPVersion, 0, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nsd->params.streamStartLine = 120;\r\npriv = gspca_dev->cam.cam_mode[gspca_dev->curr_mode].priv;\r\nif (priv & 0x01) {\r\nsd->params.roi.colStart = 2;\r\nsd->params.roi.rowStart = 6;\r\n} else {\r\nsd->params.roi.colStart = 0;\r\nsd->params.roi.rowStart = 0;\r\n}\r\nif (priv & 0x02) {\r\nsd->params.format.videoSize = VIDEOSIZE_QCIF;\r\nsd->params.roi.colStart /= 2;\r\nsd->params.roi.rowStart /= 2;\r\nsd->params.streamStartLine /= 2;\r\n} else\r\nsd->params.format.videoSize = VIDEOSIZE_CIF;\r\nsd->params.roi.colEnd = sd->params.roi.colStart +\r\n(gspca_dev->pixfmt.width >> 3);\r\nsd->params.roi.rowEnd = sd->params.roi.rowStart +\r\n(gspca_dev->pixfmt.height >> 2);\r\nret = do_command(gspca_dev, CPIA_COMMAND_SetGrabMode,\r\nCPIA_GRAB_CONTINEOUS, 0, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nret = do_command(gspca_dev, CPIA_COMMAND_SetCompression,\r\nCPIA_COMPRESSION_NONE,\r\nNO_DECIMATION, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nret = command_setcompressiontarget(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setcolourparams(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setformat(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setyuvtresh(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setecptiming(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setcompressionparams(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setexposure(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setcolourbalance(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setsensorfps(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setapcor(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setflickerctrl(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_setvloffset(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nret = command_resume(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nsd->first_frame = 6;\r\nsd->exposure_status = EXPOSURE_NORMAL;\r\nsd->exposure_count = 0;\r\natomic_set(&sd->cam_exposure, 0);\r\natomic_set(&sd->fps, 0);\r\nreturn 0;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ncommand_pause(gspca_dev);\r\nsave_camera_state(gspca_dev);\r\ngoto_low_power(gspca_dev);\r\ndo_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\r\n#if IS_ENABLED(CONFIG_INPUT)\r\nif (sd->params.qx3.button) {\r\ninput_report_key(gspca_dev->input_dev, KEY_CAMERA, 0);\r\ninput_sync(gspca_dev->input_dev);\r\n}\r\n#endif\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint ret;\r\nret = sd_start(gspca_dev);\r\nif (ret)\r\nreturn ret;\r\nif (sd->params.qx3.qx3_detected)\r\ncommand_setlights(gspca_dev);\r\nsd_stopN(gspca_dev);\r\nPDEBUG(D_PROBE, "CPIA Version: %d.%02d (%d.%d)",\r\nsd->params.version.firmwareVersion,\r\nsd->params.version.firmwareRevision,\r\nsd->params.version.vcVersion,\r\nsd->params.version.vcRevision);\r\nPDEBUG(D_PROBE, "CPIA PnP-ID: %04x:%04x:%04x",\r\nsd->params.pnpID.vendor, sd->params.pnpID.product,\r\nsd->params.pnpID.deviceRevision);\r\nPDEBUG(D_PROBE, "VP-Version: %d.%d %04x",\r\nsd->params.vpVersion.vpVersion,\r\nsd->params.vpVersion.vpRevision,\r\nsd->params.vpVersion.cameraHeadID);\r\nreturn 0;\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (len >= 64 &&\r\ndata[0] == MAGIC_0 && data[1] == MAGIC_1 &&\r\ndata[16] == sd->params.format.videoSize &&\r\ndata[17] == sd->params.format.subSample &&\r\ndata[18] == sd->params.format.yuvOrder &&\r\ndata[24] == sd->params.roi.colStart &&\r\ndata[25] == sd->params.roi.colEnd &&\r\ndata[26] == sd->params.roi.rowStart &&\r\ndata[27] == sd->params.roi.rowEnd) {\r\nu8 *image;\r\natomic_set(&sd->cam_exposure, data[39] * 2);\r\natomic_set(&sd->fps, data[41]);\r\nimage = gspca_dev->image;\r\nif (image != NULL &&\r\ngspca_dev->image_len > 4 &&\r\nimage[gspca_dev->image_len - 4] == 0xff &&\r\nimage[gspca_dev->image_len - 3] == 0xff &&\r\nimage[gspca_dev->image_len - 2] == 0xff &&\r\nimage[gspca_dev->image_len - 1] == 0xff)\r\ngspca_frame_add(gspca_dev, LAST_PACKET,\r\nNULL, 0);\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\r\nreturn;\r\n}\r\ngspca_frame_add(gspca_dev, INTER_PACKET, data, len);\r\n}\r\nstatic void sd_dq_callback(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (sd->first_frame) {\r\nsd->first_frame--;\r\nif (sd->first_frame == 0)\r\ncommand_setcompression(gspca_dev);\r\n}\r\nrestart_flicker(gspca_dev);\r\nif (sd->params.exposure.expMode == 2)\r\nmonitor_exposure(gspca_dev);\r\ndo_command(gspca_dev, CPIA_COMMAND_GetExposure, 0, 0, 0, 0);\r\ndo_command(gspca_dev, CPIA_COMMAND_ReadMCPorts, 0, 0, 0, 0);\r\n}\r\nstatic int sd_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct gspca_dev *gspca_dev =\r\ncontainer_of(ctrl->handler, struct gspca_dev, ctrl_handler);\r\nstruct sd *sd = (struct sd *)gspca_dev;\r\ngspca_dev->usb_err = 0;\r\nif (!gspca_dev->streaming && ctrl->id != V4L2_CID_POWER_LINE_FREQUENCY)\r\nreturn 0;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_BRIGHTNESS:\r\nsd->params.colourParams.brightness = ctrl->val;\r\nsd->params.flickerControl.allowableOverExposure =\r\nfind_over_exposure(sd->params.colourParams.brightness);\r\ngspca_dev->usb_err = command_setcolourparams(gspca_dev);\r\nif (!gspca_dev->usb_err)\r\ngspca_dev->usb_err = command_setflickerctrl(gspca_dev);\r\nbreak;\r\ncase V4L2_CID_CONTRAST:\r\nsd->params.colourParams.contrast = ctrl->val;\r\ngspca_dev->usb_err = command_setcolourparams(gspca_dev);\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\nsd->params.colourParams.saturation = ctrl->val;\r\ngspca_dev->usb_err = command_setcolourparams(gspca_dev);\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY:\r\nsd->mainsFreq = ctrl->val == V4L2_CID_POWER_LINE_FREQUENCY_60HZ;\r\nsd->params.flickerControl.coarseJump =\r\nflicker_jumps[sd->mainsFreq]\r\n[sd->params.sensorFps.baserate]\r\n[sd->params.sensorFps.divisor];\r\ngspca_dev->usb_err = set_flicker(gspca_dev,\r\nctrl->val != V4L2_CID_POWER_LINE_FREQUENCY_DISABLED,\r\ngspca_dev->streaming);\r\nbreak;\r\ncase V4L2_CID_ILLUMINATORS_1:\r\nsd->params.qx3.bottomlight = ctrl->val;\r\ngspca_dev->usb_err = command_setlights(gspca_dev);\r\nbreak;\r\ncase V4L2_CID_ILLUMINATORS_2:\r\nsd->params.qx3.toplight = ctrl->val;\r\ngspca_dev->usb_err = command_setlights(gspca_dev);\r\nbreak;\r\ncase CPIA1_CID_COMP_TARGET:\r\nsd->params.compressionTarget.frTargeting = ctrl->val;\r\ngspca_dev->usb_err = command_setcompressiontarget(gspca_dev);\r\nbreak;\r\n}\r\nreturn gspca_dev->usb_err;\r\n}\r\nstatic int sd_init_controls(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *)gspca_dev;\r\nstruct v4l2_ctrl_handler *hdl = &gspca_dev->ctrl_handler;\r\nstatic const char * const comp_target_menu[] = {\r\n"Quality",\r\n"Framerate",\r\nNULL\r\n};\r\nstatic const struct v4l2_ctrl_config comp_target = {\r\n.ops = &sd_ctrl_ops,\r\n.id = CPIA1_CID_COMP_TARGET,\r\n.type = V4L2_CTRL_TYPE_MENU,\r\n.name = "Compression Target",\r\n.qmenu = comp_target_menu,\r\n.max = 1,\r\n.def = COMP_TARGET_DEF,\r\n};\r\ngspca_dev->vdev.ctrl_handler = hdl;\r\nv4l2_ctrl_handler_init(hdl, 7);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_BRIGHTNESS, 0, 100, 1, BRIGHTNESS_DEF);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_CONTRAST, 0, 96, 8, CONTRAST_DEF);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_SATURATION, 0, 100, 1, SATURATION_DEF);\r\nsd->freq = v4l2_ctrl_new_std_menu(hdl, &sd_ctrl_ops,\r\nV4L2_CID_POWER_LINE_FREQUENCY,\r\nV4L2_CID_POWER_LINE_FREQUENCY_60HZ, 0,\r\nFREQ_DEF);\r\nif (sd->params.qx3.qx3_detected) {\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_ILLUMINATORS_1, 0, 1, 1,\r\nILLUMINATORS_1_DEF);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_ILLUMINATORS_2, 0, 1, 1,\r\nILLUMINATORS_2_DEF);\r\n}\r\nv4l2_ctrl_new_custom(hdl, &comp_target, NULL);\r\nif (hdl->error) {\r\npr_err("Could not initialize controls\n");\r\nreturn hdl->error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}

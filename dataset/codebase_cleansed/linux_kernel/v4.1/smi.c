enum smi_action smi_handle_dr_smp_send(struct ib_smp *smp,\r\nu8 node_type, int port_num)\r\n{\r\nu8 hop_ptr, hop_cnt;\r\nhop_ptr = smp->hop_ptr;\r\nhop_cnt = smp->hop_cnt;\r\nif (hop_cnt >= IB_SMP_MAX_PATH_HOPS)\r\nreturn IB_SMI_DISCARD;\r\nif (!ib_get_smp_direction(smp)) {\r\nif (hop_cnt && hop_ptr == 0) {\r\nsmp->hop_ptr++;\r\nreturn (smp->initial_path[smp->hop_ptr] ==\r\nport_num ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (hop_ptr && hop_ptr < hop_cnt) {\r\nif (node_type != RDMA_NODE_IB_SWITCH)\r\nreturn IB_SMI_DISCARD;\r\nsmp->hop_ptr++;\r\nreturn (smp->initial_path[smp->hop_ptr] ==\r\nport_num ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (hop_ptr == hop_cnt) {\r\nsmp->hop_ptr++;\r\nreturn (node_type == RDMA_NODE_IB_SWITCH ||\r\nsmp->dr_dlid == IB_LID_PERMISSIVE ?\r\nIB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nreturn (hop_ptr == hop_cnt + 1 ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n} else {\r\nif (hop_cnt && hop_ptr == hop_cnt + 1) {\r\nsmp->hop_ptr--;\r\nreturn (smp->return_path[smp->hop_ptr] ==\r\nport_num ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (2 <= hop_ptr && hop_ptr <= hop_cnt) {\r\nif (node_type != RDMA_NODE_IB_SWITCH)\r\nreturn IB_SMI_DISCARD;\r\nsmp->hop_ptr--;\r\nreturn (smp->return_path[smp->hop_ptr] ==\r\nport_num ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (hop_ptr == 1) {\r\nsmp->hop_ptr--;\r\nreturn (node_type == RDMA_NODE_IB_SWITCH ||\r\nsmp->dr_slid == IB_LID_PERMISSIVE ?\r\nIB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (hop_ptr == 0)\r\nreturn IB_SMI_HANDLE;\r\nreturn IB_SMI_DISCARD;\r\n}\r\n}\r\nenum smi_action smi_handle_dr_smp_recv(struct ib_smp *smp, u8 node_type,\r\nint port_num, int phys_port_cnt)\r\n{\r\nu8 hop_ptr, hop_cnt;\r\nhop_ptr = smp->hop_ptr;\r\nhop_cnt = smp->hop_cnt;\r\nif (hop_cnt >= IB_SMP_MAX_PATH_HOPS)\r\nreturn IB_SMI_DISCARD;\r\nif (!ib_get_smp_direction(smp)) {\r\nif (hop_cnt && hop_ptr == 0)\r\nreturn IB_SMI_DISCARD;\r\nif (hop_ptr && hop_ptr < hop_cnt) {\r\nif (node_type != RDMA_NODE_IB_SWITCH)\r\nreturn IB_SMI_DISCARD;\r\nsmp->return_path[hop_ptr] = port_num;\r\nreturn (smp->initial_path[hop_ptr+1] <= phys_port_cnt ?\r\nIB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (hop_ptr == hop_cnt) {\r\nif (hop_cnt)\r\nsmp->return_path[hop_ptr] = port_num;\r\nreturn (node_type == RDMA_NODE_IB_SWITCH ||\r\nsmp->dr_dlid == IB_LID_PERMISSIVE ?\r\nIB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nreturn (hop_ptr == hop_cnt + 1 ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n} else {\r\nif (hop_cnt && hop_ptr == hop_cnt + 1) {\r\nsmp->hop_ptr--;\r\nreturn (smp->return_path[smp->hop_ptr] ==\r\nport_num ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (2 <= hop_ptr && hop_ptr <= hop_cnt) {\r\nif (node_type != RDMA_NODE_IB_SWITCH)\r\nreturn IB_SMI_DISCARD;\r\nreturn (smp->return_path[hop_ptr-1] <= phys_port_cnt ?\r\nIB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nif (hop_ptr == 1) {\r\nif (smp->dr_slid == IB_LID_PERMISSIVE) {\r\nsmp->hop_ptr--;\r\nreturn IB_SMI_HANDLE;\r\n}\r\nreturn (node_type == RDMA_NODE_IB_SWITCH ?\r\nIB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\nreturn (hop_ptr == 0 ? IB_SMI_HANDLE : IB_SMI_DISCARD);\r\n}\r\n}\r\nenum smi_forward_action smi_check_forward_dr_smp(struct ib_smp *smp)\r\n{\r\nu8 hop_ptr, hop_cnt;\r\nhop_ptr = smp->hop_ptr;\r\nhop_cnt = smp->hop_cnt;\r\nif (!ib_get_smp_direction(smp)) {\r\nif (hop_ptr && hop_ptr < hop_cnt)\r\nreturn IB_SMI_FORWARD;\r\nif (hop_ptr == hop_cnt)\r\nreturn (smp->dr_dlid == IB_LID_PERMISSIVE ?\r\nIB_SMI_SEND : IB_SMI_LOCAL);\r\nif (hop_ptr == hop_cnt + 1)\r\nreturn IB_SMI_SEND;\r\n} else {\r\nif (2 <= hop_ptr && hop_ptr <= hop_cnt)\r\nreturn IB_SMI_FORWARD;\r\nif (hop_ptr == 1)\r\nreturn (smp->dr_slid != IB_LID_PERMISSIVE ?\r\nIB_SMI_SEND : IB_SMI_LOCAL);\r\n}\r\nreturn IB_SMI_LOCAL;\r\n}\r\nint smi_get_fwd_port(struct ib_smp *smp)\r\n{\r\nreturn (!ib_get_smp_direction(smp) ? smp->initial_path[smp->hop_ptr+1] :\r\nsmp->return_path[smp->hop_ptr-1]);\r\n}

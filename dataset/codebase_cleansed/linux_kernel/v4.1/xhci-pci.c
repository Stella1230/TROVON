static int xhci_pci_reinit(struct xhci_hcd *xhci, struct pci_dev *pdev)\r\n{\r\nif (!pci_set_mwi(pdev))\r\nxhci_dbg(xhci, "MWI active\n");\r\nxhci_dbg(xhci, "Finished xhci_pci_reinit\n");\r\nreturn 0;\r\n}\r\nstatic void xhci_pci_quirks(struct device *dev, struct xhci_hcd *xhci)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nif (pdev->vendor == PCI_VENDOR_ID_FRESCO_LOGIC &&\r\n(pdev->device == PCI_DEVICE_ID_FRESCO_LOGIC_PDK ||\r\npdev->device == PCI_DEVICE_ID_FRESCO_LOGIC_FL1400)) {\r\nif (pdev->device == PCI_DEVICE_ID_FRESCO_LOGIC_PDK &&\r\npdev->revision == 0x0) {\r\nxhci->quirks |= XHCI_RESET_EP_QUIRK;\r\nxhci_dbg_trace(xhci, trace_xhci_dbg_quirks,\r\n"QUIRK: Fresco Logic xHC needs configure"\r\n" endpoint cmd after reset endpoint");\r\n}\r\nif (pdev->device == PCI_DEVICE_ID_FRESCO_LOGIC_PDK &&\r\npdev->revision == 0x4) {\r\nxhci->quirks |= XHCI_SLOW_SUSPEND;\r\nxhci_dbg_trace(xhci, trace_xhci_dbg_quirks,\r\n"QUIRK: Fresco Logic xHC revision %u"\r\n"must be suspended extra slowly",\r\npdev->revision);\r\n}\r\nif (pdev->device == PCI_DEVICE_ID_FRESCO_LOGIC_PDK)\r\nxhci->quirks |= XHCI_BROKEN_STREAMS;\r\nxhci->quirks |= XHCI_BROKEN_MSI;\r\nxhci_dbg_trace(xhci, trace_xhci_dbg_quirks,\r\n"QUIRK: Fresco Logic revision %u "\r\n"has broken MSI implementation",\r\npdev->revision);\r\nxhci->quirks |= XHCI_TRUST_TX_LENGTH;\r\n}\r\nif (pdev->vendor == PCI_VENDOR_ID_NEC)\r\nxhci->quirks |= XHCI_NEC_HOST;\r\nif (pdev->vendor == PCI_VENDOR_ID_AMD && xhci->hci_version == 0x96)\r\nxhci->quirks |= XHCI_AMD_0x96_HOST;\r\nif (pdev->vendor == PCI_VENDOR_ID_AMD && usb_amd_find_chipset_info())\r\nxhci->quirks |= XHCI_AMD_PLL_FIX;\r\nif (pdev->vendor == PCI_VENDOR_ID_AMD)\r\nxhci->quirks |= XHCI_TRUST_TX_LENGTH;\r\nif (pdev->vendor == PCI_VENDOR_ID_INTEL) {\r\nxhci->quirks |= XHCI_LPM_SUPPORT;\r\nxhci->quirks |= XHCI_INTEL_HOST;\r\nxhci->quirks |= XHCI_AVOID_BEI;\r\n}\r\nif (pdev->vendor == PCI_VENDOR_ID_INTEL &&\r\npdev->device == PCI_DEVICE_ID_INTEL_PANTHERPOINT_XHCI) {\r\nxhci->quirks |= XHCI_EP_LIMIT_QUIRK;\r\nxhci->limit_active_eps = 64;\r\nxhci->quirks |= XHCI_SW_BW_CHECKING;\r\nxhci->quirks |= XHCI_SPURIOUS_REBOOT;\r\n}\r\nif (pdev->vendor == PCI_VENDOR_ID_INTEL &&\r\npdev->device == PCI_DEVICE_ID_INTEL_LYNXPOINT_LP_XHCI) {\r\nxhci->quirks |= XHCI_SPURIOUS_REBOOT;\r\n}\r\nif (pdev->vendor == PCI_VENDOR_ID_INTEL &&\r\n(pdev->device == PCI_DEVICE_ID_INTEL_SUNRISEPOINT_LP_XHCI ||\r\npdev->device == PCI_DEVICE_ID_INTEL_SUNRISEPOINT_H_XHCI ||\r\npdev->device == PCI_DEVICE_ID_INTEL_CHERRYVIEW_XHCI)) {\r\nxhci->quirks |= XHCI_PME_STUCK_QUIRK;\r\n}\r\nif (pdev->vendor == PCI_VENDOR_ID_ETRON &&\r\npdev->device == PCI_DEVICE_ID_EJ168) {\r\nxhci->quirks |= XHCI_RESET_ON_RESUME;\r\nxhci->quirks |= XHCI_TRUST_TX_LENGTH;\r\nxhci->quirks |= XHCI_BROKEN_STREAMS;\r\n}\r\nif (pdev->vendor == PCI_VENDOR_ID_RENESAS &&\r\npdev->device == 0x0015)\r\nxhci->quirks |= XHCI_RESET_ON_RESUME;\r\nif (pdev->vendor == PCI_VENDOR_ID_VIA)\r\nxhci->quirks |= XHCI_RESET_ON_RESUME;\r\nif (pdev->vendor == PCI_VENDOR_ID_VIA &&\r\npdev->device == 0x3432)\r\nxhci->quirks |= XHCI_BROKEN_STREAMS;\r\nif (pdev->vendor == PCI_VENDOR_ID_ASMEDIA &&\r\npdev->device == 0x1042)\r\nxhci->quirks |= XHCI_BROKEN_STREAMS;\r\nif (xhci->quirks & XHCI_RESET_ON_RESUME)\r\nxhci_dbg_trace(xhci, trace_xhci_dbg_quirks,\r\n"QUIRK: Resetting on resume");\r\n}\r\nstatic void xhci_pme_quirk(struct xhci_hcd *xhci)\r\n{\r\nu32 val;\r\nvoid __iomem *reg;\r\nreg = (void __iomem *) xhci->cap_regs + 0x80a4;\r\nval = readl(reg);\r\nwritel(val | BIT(28), reg);\r\nreadl(reg);\r\n}\r\nstatic int xhci_pci_setup(struct usb_hcd *hcd)\r\n{\r\nstruct xhci_hcd *xhci;\r\nstruct pci_dev *pdev = to_pci_dev(hcd->self.controller);\r\nint retval;\r\nretval = xhci_gen_setup(hcd, xhci_pci_quirks);\r\nif (retval)\r\nreturn retval;\r\nxhci = hcd_to_xhci(hcd);\r\nif (!usb_hcd_is_primary_hcd(hcd))\r\nreturn 0;\r\npci_read_config_byte(pdev, XHCI_SBRN_OFFSET, &xhci->sbrn);\r\nxhci_dbg(xhci, "Got SBRN %u\n", (unsigned int) xhci->sbrn);\r\nretval = xhci_pci_reinit(xhci, pdev);\r\nif (!retval)\r\nreturn retval;\r\nkfree(xhci);\r\nreturn retval;\r\n}\r\nstatic int xhci_pci_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nint retval;\r\nstruct xhci_hcd *xhci;\r\nstruct hc_driver *driver;\r\nstruct usb_hcd *hcd;\r\ndriver = (struct hc_driver *)id->driver_data;\r\npm_runtime_get_noresume(&dev->dev);\r\nretval = usb_hcd_pci_probe(dev, id);\r\nif (retval)\r\ngoto put_runtime_pm;\r\nhcd = dev_get_drvdata(&dev->dev);\r\nxhci = hcd_to_xhci(hcd);\r\nxhci->shared_hcd = usb_create_shared_hcd(driver, &dev->dev,\r\npci_name(dev), hcd);\r\nif (!xhci->shared_hcd) {\r\nretval = -ENOMEM;\r\ngoto dealloc_usb2_hcd;\r\n}\r\n*((struct xhci_hcd **) xhci->shared_hcd->hcd_priv) = xhci;\r\nretval = usb_add_hcd(xhci->shared_hcd, dev->irq,\r\nIRQF_SHARED);\r\nif (retval)\r\ngoto put_usb3_hcd;\r\nif (!(xhci->quirks & XHCI_BROKEN_STREAMS) &&\r\nHCC_MAX_PSA(xhci->hcc_params) >= 4)\r\nxhci->shared_hcd->can_do_streams = 1;\r\npm_runtime_put_noidle(&dev->dev);\r\nreturn 0;\r\nput_usb3_hcd:\r\nusb_put_hcd(xhci->shared_hcd);\r\ndealloc_usb2_hcd:\r\nusb_hcd_pci_remove(dev);\r\nput_runtime_pm:\r\npm_runtime_put_noidle(&dev->dev);\r\nreturn retval;\r\n}\r\nstatic void xhci_pci_remove(struct pci_dev *dev)\r\n{\r\nstruct xhci_hcd *xhci;\r\nxhci = hcd_to_xhci(pci_get_drvdata(dev));\r\nif (xhci->shared_hcd) {\r\nusb_remove_hcd(xhci->shared_hcd);\r\nusb_put_hcd(xhci->shared_hcd);\r\n}\r\nusb_hcd_pci_remove(dev);\r\nif (xhci->quirks & XHCI_SPURIOUS_WAKEUP)\r\npci_set_power_state(dev, PCI_D3hot);\r\nkfree(xhci);\r\n}\r\nstatic int xhci_pci_suspend(struct usb_hcd *hcd, bool do_wakeup)\r\n{\r\nstruct xhci_hcd *xhci = hcd_to_xhci(hcd);\r\nstruct pci_dev *pdev = to_pci_dev(hcd->self.controller);\r\nif (xhci->quirks & XHCI_COMP_MODE_QUIRK)\r\npdev->no_d3cold = true;\r\nif (xhci->quirks & XHCI_PME_STUCK_QUIRK)\r\nxhci_pme_quirk(xhci);\r\nreturn xhci_suspend(xhci, do_wakeup);\r\n}\r\nstatic int xhci_pci_resume(struct usb_hcd *hcd, bool hibernated)\r\n{\r\nstruct xhci_hcd *xhci = hcd_to_xhci(hcd);\r\nstruct pci_dev *pdev = to_pci_dev(hcd->self.controller);\r\nint retval = 0;\r\nif (pdev->vendor == PCI_VENDOR_ID_INTEL)\r\nusb_enable_intel_xhci_ports(pdev);\r\nif (xhci->quirks & XHCI_PME_STUCK_QUIRK)\r\nxhci_pme_quirk(xhci);\r\nretval = xhci_resume(xhci, hibernated);\r\nreturn retval;\r\n}\r\nstatic int __init xhci_pci_init(void)\r\n{\r\nxhci_init_driver(&xhci_pci_hc_driver, xhci_pci_setup);\r\n#ifdef CONFIG_PM\r\nxhci_pci_hc_driver.pci_suspend = xhci_pci_suspend;\r\nxhci_pci_hc_driver.pci_resume = xhci_pci_resume;\r\n#endif\r\nreturn pci_register_driver(&xhci_pci_driver);\r\n}\r\nstatic void __exit xhci_pci_exit(void)\r\n{\r\npci_unregister_driver(&xhci_pci_driver);\r\n}

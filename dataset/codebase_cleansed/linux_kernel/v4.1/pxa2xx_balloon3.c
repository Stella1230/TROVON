static int balloon3_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nuint16_t ver;\r\nver = __raw_readw(BALLOON3_FPGA_VER);\r\nif (ver < 0x4f08)\r\npr_warn("The FPGA code, version 0x%04x, is too old. "\r\n"PCMCIA/CF support might be broken in this version!",\r\nver);\r\nskt->socket.pci_irq = BALLOON3_BP_CF_NRDY_IRQ;\r\nskt->stat[SOC_STAT_CD].gpio = BALLOON3_GPIO_S0_CD;\r\nskt->stat[SOC_STAT_CD].name = "PCMCIA0 CD";\r\nskt->stat[SOC_STAT_BVD1].irq = BALLOON3_BP_NSTSCHG_IRQ;\r\nskt->stat[SOC_STAT_BVD1].name = "PCMCIA0 STSCHG";\r\nreturn 0;\r\n}\r\nstatic void balloon3_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nuint16_t status;\r\nint flip;\r\nstatus = __raw_readw(BALLOON3_CF_STATUS_REG);\r\nflip = (status ^ balloon3_pcmcia_status[skt->nr])\r\n& BALLOON3_CF_nSTSCHG_BVD1;\r\nif (flip) {\r\nballoon3_pcmcia_status[skt->nr] = status;\r\nif (status & BALLOON3_CF_nSTSCHG_BVD1)\r\nenable_irq(BALLOON3_BP_NSTSCHG_IRQ);\r\nelse\r\ndisable_irq(BALLOON3_BP_NSTSCHG_IRQ);\r\n}\r\nstate->ready = !!(status & BALLOON3_CF_nIRQ);\r\nstate->bvd1 = !!(status & BALLOON3_CF_nSTSCHG_BVD1);\r\nstate->bvd2 = 0;\r\nstate->vs_3v = 1;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic int balloon3_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\n__raw_writew(BALLOON3_CF_RESET, BALLOON3_CF_CONTROL_REG +\r\n((state->flags & SS_RESET) ?\r\nBALLOON3_FPGA_SETnCLR : 0));\r\nreturn 0;\r\n}\r\nstatic int __init balloon3_pcmcia_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_balloon3())\r\nreturn -ENODEV;\r\nballoon3_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!balloon3_pcmcia_device)\r\nreturn -ENOMEM;\r\nret = platform_device_add_data(balloon3_pcmcia_device,\r\n&balloon3_pcmcia_ops, sizeof(balloon3_pcmcia_ops));\r\nif (!ret)\r\nret = platform_device_add(balloon3_pcmcia_device);\r\nif (ret)\r\nplatform_device_put(balloon3_pcmcia_device);\r\nreturn ret;\r\n}\r\nstatic void __exit balloon3_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(balloon3_pcmcia_device);\r\n}

static u32 audio_config_hdmi_pixel_clock(struct drm_display_mode *mode)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(hdmi_audio_clock); i++) {\r\nif (mode->clock == hdmi_audio_clock[i].clock)\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(hdmi_audio_clock)) {\r\nDRM_DEBUG_KMS("HDMI audio pixel clock setting for %d not found, falling back to defaults\n", mode->clock);\r\ni = 1;\r\n}\r\nDRM_DEBUG_KMS("Configuring HDMI audio for pixel clock %d (0x%08x)\n",\r\nhdmi_audio_clock[i].clock,\r\nhdmi_audio_clock[i].config);\r\nreturn hdmi_audio_clock[i].config;\r\n}\r\nstatic bool intel_eld_uptodate(struct drm_connector *connector,\r\nint reg_eldv, uint32_t bits_eldv,\r\nint reg_elda, uint32_t bits_elda,\r\nint reg_edid)\r\n{\r\nstruct drm_i915_private *dev_priv = connector->dev->dev_private;\r\nuint8_t *eld = connector->eld;\r\nuint32_t tmp;\r\nint i;\r\ntmp = I915_READ(reg_eldv);\r\ntmp &= bits_eldv;\r\nif (!tmp)\r\nreturn false;\r\ntmp = I915_READ(reg_elda);\r\ntmp &= ~bits_elda;\r\nI915_WRITE(reg_elda, tmp);\r\nfor (i = 0; i < drm_eld_size(eld) / 4; i++)\r\nif (I915_READ(reg_edid) != *((uint32_t *)eld + i))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void g4x_audio_codec_disable(struct intel_encoder *encoder)\r\n{\r\nstruct drm_i915_private *dev_priv = encoder->base.dev->dev_private;\r\nuint32_t eldv, tmp;\r\nDRM_DEBUG_KMS("Disable audio codec\n");\r\ntmp = I915_READ(G4X_AUD_VID_DID);\r\nif (tmp == INTEL_AUDIO_DEVBLC || tmp == INTEL_AUDIO_DEVCL)\r\neldv = G4X_ELDV_DEVCL_DEVBLC;\r\nelse\r\neldv = G4X_ELDV_DEVCTG;\r\ntmp = I915_READ(G4X_AUD_CNTL_ST);\r\ntmp &= ~eldv;\r\nI915_WRITE(G4X_AUD_CNTL_ST, tmp);\r\n}\r\nstatic void g4x_audio_codec_enable(struct drm_connector *connector,\r\nstruct intel_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_i915_private *dev_priv = connector->dev->dev_private;\r\nuint8_t *eld = connector->eld;\r\nuint32_t eldv;\r\nuint32_t tmp;\r\nint len, i;\r\nDRM_DEBUG_KMS("Enable audio codec, %u bytes ELD\n", eld[2]);\r\ntmp = I915_READ(G4X_AUD_VID_DID);\r\nif (tmp == INTEL_AUDIO_DEVBLC || tmp == INTEL_AUDIO_DEVCL)\r\neldv = G4X_ELDV_DEVCL_DEVBLC;\r\nelse\r\neldv = G4X_ELDV_DEVCTG;\r\nif (intel_eld_uptodate(connector,\r\nG4X_AUD_CNTL_ST, eldv,\r\nG4X_AUD_CNTL_ST, G4X_ELD_ADDR_MASK,\r\nG4X_HDMIW_HDMIEDID))\r\nreturn;\r\ntmp = I915_READ(G4X_AUD_CNTL_ST);\r\ntmp &= ~(eldv | G4X_ELD_ADDR_MASK);\r\nlen = (tmp >> 9) & 0x1f;\r\nI915_WRITE(G4X_AUD_CNTL_ST, tmp);\r\nlen = min(drm_eld_size(eld) / 4, len);\r\nDRM_DEBUG_DRIVER("ELD size %d\n", len);\r\nfor (i = 0; i < len; i++)\r\nI915_WRITE(G4X_HDMIW_HDMIEDID, *((uint32_t *)eld + i));\r\ntmp = I915_READ(G4X_AUD_CNTL_ST);\r\ntmp |= eldv;\r\nI915_WRITE(G4X_AUD_CNTL_ST, tmp);\r\n}\r\nstatic void hsw_audio_codec_disable(struct intel_encoder *encoder)\r\n{\r\nstruct drm_i915_private *dev_priv = encoder->base.dev->dev_private;\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(encoder->base.crtc);\r\nenum pipe pipe = intel_crtc->pipe;\r\nuint32_t tmp;\r\nDRM_DEBUG_KMS("Disable audio codec on pipe %c\n", pipe_name(pipe));\r\ntmp = I915_READ(HSW_AUD_CFG(pipe));\r\ntmp &= ~AUD_CONFIG_N_VALUE_INDEX;\r\ntmp |= AUD_CONFIG_N_PROG_ENABLE;\r\ntmp &= ~AUD_CONFIG_UPPER_N_MASK;\r\ntmp &= ~AUD_CONFIG_LOWER_N_MASK;\r\nif (intel_pipe_has_type(intel_crtc, INTEL_OUTPUT_DISPLAYPORT))\r\ntmp |= AUD_CONFIG_N_VALUE_INDEX;\r\nI915_WRITE(HSW_AUD_CFG(pipe), tmp);\r\ntmp = I915_READ(HSW_AUD_PIN_ELD_CP_VLD);\r\ntmp &= ~AUDIO_ELD_VALID(pipe);\r\ntmp &= ~AUDIO_OUTPUT_ENABLE(pipe);\r\nI915_WRITE(HSW_AUD_PIN_ELD_CP_VLD, tmp);\r\n}\r\nstatic void hsw_audio_codec_enable(struct drm_connector *connector,\r\nstruct intel_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_i915_private *dev_priv = connector->dev->dev_private;\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(encoder->base.crtc);\r\nenum pipe pipe = intel_crtc->pipe;\r\nconst uint8_t *eld = connector->eld;\r\nuint32_t tmp;\r\nint len, i;\r\nDRM_DEBUG_KMS("Enable audio codec on pipe %c, %u bytes ELD\n",\r\npipe_name(pipe), drm_eld_size(eld));\r\ntmp = I915_READ(HSW_AUD_PIN_ELD_CP_VLD);\r\ntmp |= AUDIO_OUTPUT_ENABLE(pipe);\r\ntmp &= ~AUDIO_ELD_VALID(pipe);\r\nI915_WRITE(HSW_AUD_PIN_ELD_CP_VLD, tmp);\r\ntmp = I915_READ(HSW_AUD_DIP_ELD_CTRL(pipe));\r\ntmp &= ~IBX_ELD_ADDRESS_MASK;\r\nI915_WRITE(HSW_AUD_DIP_ELD_CTRL(pipe), tmp);\r\nlen = min(drm_eld_size(eld), 84);\r\nfor (i = 0; i < len / 4; i++)\r\nI915_WRITE(HSW_AUD_EDID_DATA(pipe), *((uint32_t *)eld + i));\r\ntmp = I915_READ(HSW_AUD_PIN_ELD_CP_VLD);\r\ntmp |= AUDIO_ELD_VALID(pipe);\r\nI915_WRITE(HSW_AUD_PIN_ELD_CP_VLD, tmp);\r\ntmp = I915_READ(HSW_AUD_CFG(pipe));\r\ntmp &= ~AUD_CONFIG_N_VALUE_INDEX;\r\ntmp &= ~AUD_CONFIG_N_PROG_ENABLE;\r\ntmp &= ~AUD_CONFIG_PIXEL_CLOCK_HDMI_MASK;\r\nif (intel_pipe_has_type(intel_crtc, INTEL_OUTPUT_DISPLAYPORT))\r\ntmp |= AUD_CONFIG_N_VALUE_INDEX;\r\nelse\r\ntmp |= audio_config_hdmi_pixel_clock(mode);\r\nI915_WRITE(HSW_AUD_CFG(pipe), tmp);\r\n}\r\nstatic void ilk_audio_codec_disable(struct intel_encoder *encoder)\r\n{\r\nstruct drm_i915_private *dev_priv = encoder->base.dev->dev_private;\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(encoder->base.crtc);\r\nstruct intel_digital_port *intel_dig_port =\r\nenc_to_dig_port(&encoder->base);\r\nenum port port = intel_dig_port->port;\r\nenum pipe pipe = intel_crtc->pipe;\r\nuint32_t tmp, eldv;\r\nint aud_config;\r\nint aud_cntrl_st2;\r\nDRM_DEBUG_KMS("Disable audio codec on port %c, pipe %c\n",\r\nport_name(port), pipe_name(pipe));\r\nif (HAS_PCH_IBX(dev_priv->dev)) {\r\naud_config = IBX_AUD_CFG(pipe);\r\naud_cntrl_st2 = IBX_AUD_CNTL_ST2;\r\n} else if (IS_VALLEYVIEW(dev_priv)) {\r\naud_config = VLV_AUD_CFG(pipe);\r\naud_cntrl_st2 = VLV_AUD_CNTL_ST2;\r\n} else {\r\naud_config = CPT_AUD_CFG(pipe);\r\naud_cntrl_st2 = CPT_AUD_CNTRL_ST2;\r\n}\r\ntmp = I915_READ(aud_config);\r\ntmp &= ~AUD_CONFIG_N_VALUE_INDEX;\r\ntmp |= AUD_CONFIG_N_PROG_ENABLE;\r\ntmp &= ~AUD_CONFIG_UPPER_N_MASK;\r\ntmp &= ~AUD_CONFIG_LOWER_N_MASK;\r\nif (intel_pipe_has_type(intel_crtc, INTEL_OUTPUT_DISPLAYPORT))\r\ntmp |= AUD_CONFIG_N_VALUE_INDEX;\r\nI915_WRITE(aud_config, tmp);\r\nif (WARN_ON(!port)) {\r\neldv = IBX_ELD_VALID(PORT_B) | IBX_ELD_VALID(PORT_C) |\r\nIBX_ELD_VALID(PORT_D);\r\n} else {\r\neldv = IBX_ELD_VALID(port);\r\n}\r\ntmp = I915_READ(aud_cntrl_st2);\r\ntmp &= ~eldv;\r\nI915_WRITE(aud_cntrl_st2, tmp);\r\n}\r\nstatic void ilk_audio_codec_enable(struct drm_connector *connector,\r\nstruct intel_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_i915_private *dev_priv = connector->dev->dev_private;\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(encoder->base.crtc);\r\nstruct intel_digital_port *intel_dig_port =\r\nenc_to_dig_port(&encoder->base);\r\nenum port port = intel_dig_port->port;\r\nenum pipe pipe = intel_crtc->pipe;\r\nuint8_t *eld = connector->eld;\r\nuint32_t eldv;\r\nuint32_t tmp;\r\nint len, i;\r\nint hdmiw_hdmiedid;\r\nint aud_config;\r\nint aud_cntl_st;\r\nint aud_cntrl_st2;\r\nDRM_DEBUG_KMS("Enable audio codec on port %c, pipe %c, %u bytes ELD\n",\r\nport_name(port), pipe_name(pipe), drm_eld_size(eld));\r\nif (HAS_PCH_IBX(connector->dev)) {\r\nhdmiw_hdmiedid = IBX_HDMIW_HDMIEDID(pipe);\r\naud_config = IBX_AUD_CFG(pipe);\r\naud_cntl_st = IBX_AUD_CNTL_ST(pipe);\r\naud_cntrl_st2 = IBX_AUD_CNTL_ST2;\r\n} else if (IS_VALLEYVIEW(connector->dev)) {\r\nhdmiw_hdmiedid = VLV_HDMIW_HDMIEDID(pipe);\r\naud_config = VLV_AUD_CFG(pipe);\r\naud_cntl_st = VLV_AUD_CNTL_ST(pipe);\r\naud_cntrl_st2 = VLV_AUD_CNTL_ST2;\r\n} else {\r\nhdmiw_hdmiedid = CPT_HDMIW_HDMIEDID(pipe);\r\naud_config = CPT_AUD_CFG(pipe);\r\naud_cntl_st = CPT_AUD_CNTL_ST(pipe);\r\naud_cntrl_st2 = CPT_AUD_CNTRL_ST2;\r\n}\r\nif (WARN_ON(!port)) {\r\neldv = IBX_ELD_VALID(PORT_B) | IBX_ELD_VALID(PORT_C) |\r\nIBX_ELD_VALID(PORT_D);\r\n} else {\r\neldv = IBX_ELD_VALID(port);\r\n}\r\ntmp = I915_READ(aud_cntrl_st2);\r\ntmp &= ~eldv;\r\nI915_WRITE(aud_cntrl_st2, tmp);\r\ntmp = I915_READ(aud_cntl_st);\r\ntmp &= ~IBX_ELD_ADDRESS_MASK;\r\nI915_WRITE(aud_cntl_st, tmp);\r\nlen = min(drm_eld_size(eld), 84);\r\nfor (i = 0; i < len / 4; i++)\r\nI915_WRITE(hdmiw_hdmiedid, *((uint32_t *)eld + i));\r\ntmp = I915_READ(aud_cntrl_st2);\r\ntmp |= eldv;\r\nI915_WRITE(aud_cntrl_st2, tmp);\r\ntmp = I915_READ(aud_config);\r\ntmp &= ~AUD_CONFIG_N_VALUE_INDEX;\r\ntmp &= ~AUD_CONFIG_N_PROG_ENABLE;\r\ntmp &= ~AUD_CONFIG_PIXEL_CLOCK_HDMI_MASK;\r\nif (intel_pipe_has_type(intel_crtc, INTEL_OUTPUT_DISPLAYPORT))\r\ntmp |= AUD_CONFIG_N_VALUE_INDEX;\r\nelse\r\ntmp |= audio_config_hdmi_pixel_clock(mode);\r\nI915_WRITE(aud_config, tmp);\r\n}\r\nvoid intel_audio_codec_enable(struct intel_encoder *intel_encoder)\r\n{\r\nstruct drm_encoder *encoder = &intel_encoder->base;\r\nstruct intel_crtc *crtc = to_intel_crtc(encoder->crtc);\r\nstruct drm_display_mode *mode = &crtc->config->base.adjusted_mode;\r\nstruct drm_connector *connector;\r\nstruct drm_device *dev = encoder->dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nconnector = drm_select_eld(encoder, mode);\r\nif (!connector)\r\nreturn;\r\nDRM_DEBUG_DRIVER("ELD on [CONNECTOR:%d:%s], [ENCODER:%d:%s]\n",\r\nconnector->base.id,\r\nconnector->name,\r\nconnector->encoder->base.id,\r\nconnector->encoder->name);\r\nconnector->eld[5] &= ~(3 << 2);\r\nif (intel_pipe_has_type(crtc, INTEL_OUTPUT_DISPLAYPORT))\r\nconnector->eld[5] |= (1 << 2);\r\nconnector->eld[6] = drm_av_sync_delay(connector, mode) / 2;\r\nif (dev_priv->display.audio_codec_enable)\r\ndev_priv->display.audio_codec_enable(connector, intel_encoder, mode);\r\n}\r\nvoid intel_audio_codec_disable(struct intel_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->base.dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nif (dev_priv->display.audio_codec_disable)\r\ndev_priv->display.audio_codec_disable(encoder);\r\n}\r\nvoid intel_init_audio(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nif (IS_G4X(dev)) {\r\ndev_priv->display.audio_codec_enable = g4x_audio_codec_enable;\r\ndev_priv->display.audio_codec_disable = g4x_audio_codec_disable;\r\n} else if (IS_VALLEYVIEW(dev)) {\r\ndev_priv->display.audio_codec_enable = ilk_audio_codec_enable;\r\ndev_priv->display.audio_codec_disable = ilk_audio_codec_disable;\r\n} else if (IS_HASWELL(dev) || INTEL_INFO(dev)->gen >= 8) {\r\ndev_priv->display.audio_codec_enable = hsw_audio_codec_enable;\r\ndev_priv->display.audio_codec_disable = hsw_audio_codec_disable;\r\n} else if (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->display.audio_codec_enable = ilk_audio_codec_enable;\r\ndev_priv->display.audio_codec_disable = ilk_audio_codec_disable;\r\n}\r\n}\r\nstatic void i915_audio_component_get_power(struct device *dev)\r\n{\r\nintel_display_power_get(dev_to_i915(dev), POWER_DOMAIN_AUDIO);\r\n}\r\nstatic void i915_audio_component_put_power(struct device *dev)\r\n{\r\nintel_display_power_put(dev_to_i915(dev), POWER_DOMAIN_AUDIO);\r\n}\r\nstatic int i915_audio_component_get_cdclk_freq(struct device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev_to_i915(dev);\r\nint ret;\r\nif (WARN_ON_ONCE(!HAS_DDI(dev_priv)))\r\nreturn -ENODEV;\r\nintel_display_power_get(dev_priv, POWER_DOMAIN_AUDIO);\r\nret = intel_ddi_get_cdclk_freq(dev_priv);\r\nintel_display_power_put(dev_priv, POWER_DOMAIN_AUDIO);\r\nreturn ret;\r\n}\r\nstatic int i915_audio_component_bind(struct device *i915_dev,\r\nstruct device *hda_dev, void *data)\r\n{\r\nstruct i915_audio_component *acomp = data;\r\nif (WARN_ON(acomp->ops || acomp->dev))\r\nreturn -EEXIST;\r\nacomp->ops = &i915_audio_component_ops;\r\nacomp->dev = i915_dev;\r\nreturn 0;\r\n}\r\nstatic void i915_audio_component_unbind(struct device *i915_dev,\r\nstruct device *hda_dev, void *data)\r\n{\r\nstruct i915_audio_component *acomp = data;\r\nacomp->ops = NULL;\r\nacomp->dev = NULL;\r\n}\r\nvoid i915_audio_component_init(struct drm_i915_private *dev_priv)\r\n{\r\nint ret;\r\nret = component_add(dev_priv->dev->dev, &i915_audio_component_bind_ops);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to add audio component (%d)\n", ret);\r\nreturn;\r\n}\r\ndev_priv->audio_component_registered = true;\r\n}\r\nvoid i915_audio_component_cleanup(struct drm_i915_private *dev_priv)\r\n{\r\nif (!dev_priv->audio_component_registered)\r\nreturn;\r\ncomponent_del(dev_priv->dev->dev, &i915_audio_component_bind_ops);\r\ndev_priv->audio_component_registered = false;\r\n}

static int buffer_activate(struct saa7134_dev *dev,\r\nstruct saa7134_buf *buf,\r\nstruct saa7134_buf *next)\r\n{\r\ndprintk("buffer_activate [%p]",buf);\r\nbuf->top_seen = 0;\r\nif (!dev->ts_started)\r\ndev->ts_field = V4L2_FIELD_TOP;\r\nif (NULL == next)\r\nnext = buf;\r\nif (V4L2_FIELD_TOP == dev->ts_field) {\r\ndprintk("- [top] buf=%p next=%p\n",buf,next);\r\nsaa_writel(SAA7134_RS_BA1(5),saa7134_buffer_base(buf));\r\nsaa_writel(SAA7134_RS_BA2(5),saa7134_buffer_base(next));\r\ndev->ts_field = V4L2_FIELD_BOTTOM;\r\n} else {\r\ndprintk("- [bottom] buf=%p next=%p\n",buf,next);\r\nsaa_writel(SAA7134_RS_BA1(5),saa7134_buffer_base(next));\r\nsaa_writel(SAA7134_RS_BA2(5),saa7134_buffer_base(buf));\r\ndev->ts_field = V4L2_FIELD_TOP;\r\n}\r\nsaa7134_set_dmabits(dev);\r\nmod_timer(&dev->ts_q.timeout, jiffies+TS_BUFFER_TIMEOUT);\r\nif (!dev->ts_started)\r\nsaa7134_ts_start(dev);\r\nreturn 0;\r\n}\r\nint saa7134_ts_buffer_init(struct vb2_buffer *vb2)\r\n{\r\nstruct saa7134_dmaqueue *dmaq = vb2->vb2_queue->drv_priv;\r\nstruct saa7134_buf *buf = container_of(vb2, struct saa7134_buf, vb2);\r\ndmaq->curr = NULL;\r\nbuf->activate = buffer_activate;\r\nreturn 0;\r\n}\r\nint saa7134_ts_buffer_prepare(struct vb2_buffer *vb2)\r\n{\r\nstruct saa7134_dmaqueue *dmaq = vb2->vb2_queue->drv_priv;\r\nstruct saa7134_dev *dev = dmaq->dev;\r\nstruct saa7134_buf *buf = container_of(vb2, struct saa7134_buf, vb2);\r\nstruct sg_table *dma = vb2_dma_sg_plane_desc(vb2, 0);\r\nunsigned int lines, llength, size;\r\ndprintk("buffer_prepare [%p]\n", buf);\r\nllength = TS_PACKET_SIZE;\r\nlines = dev->ts.nr_packets;\r\nsize = lines * llength;\r\nif (vb2_plane_size(vb2, 0) < size)\r\nreturn -EINVAL;\r\nvb2_set_plane_payload(vb2, 0, size);\r\nvb2->v4l2_buf.field = dev->field;\r\nreturn saa7134_pgtable_build(dev->pci, &dmaq->pt, dma->sgl, dma->nents,\r\nsaa7134_buffer_startpage(buf));\r\n}\r\nint saa7134_ts_queue_setup(struct vb2_queue *q, const struct v4l2_format *fmt,\r\nunsigned int *nbuffers, unsigned int *nplanes,\r\nunsigned int sizes[], void *alloc_ctxs[])\r\n{\r\nstruct saa7134_dmaqueue *dmaq = q->drv_priv;\r\nstruct saa7134_dev *dev = dmaq->dev;\r\nint size = TS_PACKET_SIZE * dev->ts.nr_packets;\r\nif (0 == *nbuffers)\r\n*nbuffers = dev->ts.nr_bufs;\r\n*nbuffers = saa7134_buffer_count(size, *nbuffers);\r\nif (*nbuffers < 3)\r\n*nbuffers = 3;\r\n*nplanes = 1;\r\nsizes[0] = size;\r\nalloc_ctxs[0] = dev->alloc_ctx;\r\nreturn 0;\r\n}\r\nint saa7134_ts_start_streaming(struct vb2_queue *vq, unsigned int count)\r\n{\r\nstruct saa7134_dmaqueue *dmaq = vq->drv_priv;\r\nstruct saa7134_dev *dev = dmaq->dev;\r\nif (vb2_is_busy(&dev->video_vbq) && dev->fmt->planar) {\r\nstruct saa7134_buf *buf, *tmp;\r\nlist_for_each_entry_safe(buf, tmp, &dmaq->queue, entry) {\r\nlist_del(&buf->entry);\r\nvb2_buffer_done(&buf->vb2, VB2_BUF_STATE_QUEUED);\r\n}\r\nif (dmaq->curr) {\r\nvb2_buffer_done(&dmaq->curr->vb2, VB2_BUF_STATE_QUEUED);\r\ndmaq->curr = NULL;\r\n}\r\nreturn -EBUSY;\r\n}\r\ndmaq->seq_nr = 0;\r\nreturn 0;\r\n}\r\nvoid saa7134_ts_stop_streaming(struct vb2_queue *vq)\r\n{\r\nstruct saa7134_dmaqueue *dmaq = vq->drv_priv;\r\nstruct saa7134_dev *dev = dmaq->dev;\r\nsaa7134_ts_stop(dev);\r\nsaa7134_stop_streaming(dev, dmaq);\r\n}\r\nint saa7134_ts_init_hw(struct saa7134_dev *dev)\r\n{\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0x6c);\r\nsaa_writeb(SAA7134_TS_PARALLEL_SERIAL, (TS_PACKET_SIZE-1));\r\nsaa_writeb(SAA7134_TS_DMA0, ((dev->ts.nr_packets-1)&0xff));\r\nsaa_writeb(SAA7134_TS_DMA1, (((dev->ts.nr_packets-1)>>8)&0xff));\r\nsaa_writeb(SAA7134_TS_DMA2,\r\n((((dev->ts.nr_packets-1)>>16)&0x3f) | 0x00));\r\nreturn 0;\r\n}\r\nint saa7134_ts_init1(struct saa7134_dev *dev)\r\n{\r\nif (tsbufs < 2)\r\ntsbufs = 2;\r\nif (tsbufs > VIDEO_MAX_FRAME)\r\ntsbufs = VIDEO_MAX_FRAME;\r\nif (ts_nr_packets < 4)\r\nts_nr_packets = 4;\r\nif (ts_nr_packets > 312)\r\nts_nr_packets = 312;\r\ndev->ts.nr_bufs = tsbufs;\r\ndev->ts.nr_packets = ts_nr_packets;\r\nINIT_LIST_HEAD(&dev->ts_q.queue);\r\ninit_timer(&dev->ts_q.timeout);\r\ndev->ts_q.timeout.function = saa7134_buffer_timeout;\r\ndev->ts_q.timeout.data = (unsigned long)(&dev->ts_q);\r\ndev->ts_q.dev = dev;\r\ndev->ts_q.need_two = 1;\r\ndev->ts_started = 0;\r\nsaa7134_pgtable_alloc(dev->pci, &dev->ts_q.pt);\r\nsaa7134_ts_init_hw(dev);\r\nreturn 0;\r\n}\r\nint saa7134_ts_stop(struct saa7134_dev *dev)\r\n{\r\ndprintk("TS stop\n");\r\nif (!dev->ts_started)\r\nreturn 0;\r\nswitch (saa7134_boards[dev->board].ts_type) {\r\ncase SAA7134_MPEG_TS_PARALLEL:\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0x6c);\r\ndev->ts_started = 0;\r\nbreak;\r\ncase SAA7134_MPEG_TS_SERIAL:\r\nsaa_writeb(SAA7134_TS_SERIAL0, 0x40);\r\ndev->ts_started = 0;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint saa7134_ts_start(struct saa7134_dev *dev)\r\n{\r\ndprintk("TS start\n");\r\nif (WARN_ON(dev->ts_started))\r\nreturn 0;\r\nsaa_writeb(SAA7134_TS_DMA0, (dev->ts.nr_packets - 1) & 0xff);\r\nsaa_writeb(SAA7134_TS_DMA1,\r\n((dev->ts.nr_packets - 1) >> 8) & 0xff);\r\nsaa_writeb(SAA7134_TS_DMA2,\r\n(((dev->ts.nr_packets - 1) >> 16) & 0x3f) | 0x00);\r\nsaa_writel(SAA7134_RS_PITCH(5), TS_PACKET_SIZE);\r\nsaa_writel(SAA7134_RS_CONTROL(5), SAA7134_RS_CONTROL_BURST_16 |\r\nSAA7134_RS_CONTROL_ME |\r\n(dev->ts_q.pt.dma >> 12));\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x03);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x01);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nswitch (saa7134_boards[dev->board].ts_type) {\r\ncase SAA7134_MPEG_TS_PARALLEL:\r\nsaa_writeb(SAA7134_TS_SERIAL0, 0x40);\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0xec |\r\n(saa7134_boards[dev->board].ts_force_val << 4));\r\nbreak;\r\ncase SAA7134_MPEG_TS_SERIAL:\r\nsaa_writeb(SAA7134_TS_SERIAL0, 0xd8);\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0x6c |\r\n(saa7134_boards[dev->board].ts_force_val << 4));\r\nsaa_writeb(SAA7134_TS_PARALLEL_SERIAL, 0xbc);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x02);\r\nbreak;\r\n}\r\ndev->ts_started = 1;\r\nreturn 0;\r\n}\r\nint saa7134_ts_fini(struct saa7134_dev *dev)\r\n{\r\nsaa7134_pgtable_free(dev->pci, &dev->ts_q.pt);\r\nreturn 0;\r\n}\r\nvoid saa7134_irq_ts_done(struct saa7134_dev *dev, unsigned long status)\r\n{\r\nenum v4l2_field field;\r\nspin_lock(&dev->slock);\r\nif (dev->ts_q.curr) {\r\nfield = dev->ts_field;\r\nif (field != V4L2_FIELD_TOP) {\r\nif ((status & 0x100000) != 0x000000)\r\ngoto done;\r\n} else {\r\nif ((status & 0x100000) != 0x100000)\r\ngoto done;\r\n}\r\nsaa7134_buffer_finish(dev, &dev->ts_q, VB2_BUF_STATE_DONE);\r\n}\r\nsaa7134_buffer_next(dev,&dev->ts_q);\r\ndone:\r\nspin_unlock(&dev->slock);\r\n}

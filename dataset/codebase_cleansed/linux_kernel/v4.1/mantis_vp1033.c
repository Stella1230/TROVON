static int lgtdqcs001f_tuner_set(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct mantis_pci *mantis = fe->dvb->priv;\r\nstruct i2c_adapter *adapter = &mantis->adapter;\r\nu8 buf[4];\r\nu32 div;\r\nstruct i2c_msg msg = {.addr = 0x61, .flags = 0, .buf = buf, .len = sizeof(buf)};\r\ndiv = p->frequency / 250;\r\nbuf[0] = (div >> 8) & 0x7f;\r\nbuf[1] = div & 0xff;\r\nbuf[2] = 0x83;\r\nbuf[3] = 0xc0;\r\nif (p->frequency < 1531000)\r\nbuf[3] |= 0x04;\r\nelse\r\nbuf[3] &= ~0x04;\r\nif (i2c_transfer(adapter, &msg, 1) < 0) {\r\ndprintk(MANTIS_ERROR, 1, "Write: I2C Transfer failed");\r\nreturn -EIO;\r\n}\r\nmsleep_interruptible(100);\r\nreturn 0;\r\n}\r\nstatic int lgtdqcs001f_set_symbol_rate(struct dvb_frontend *fe,\r\nu32 srate, u32 ratio)\r\n{\r\nu8 aclk = 0;\r\nu8 bclk = 0;\r\nif (srate < 1500000) {\r\naclk = 0xb7;\r\nbclk = 0x47;\r\n} else if (srate < 3000000) {\r\naclk = 0xb7;\r\nbclk = 0x4b;\r\n} else if (srate < 7000000) {\r\naclk = 0xb7;\r\nbclk = 0x4f;\r\n} else if (srate < 14000000) {\r\naclk = 0xb7;\r\nbclk = 0x53;\r\n} else if (srate < 30000000) {\r\naclk = 0xb6;\r\nbclk = 0x53;\r\n} else if (srate < 45000000) {\r\naclk = 0xb4;\r\nbclk = 0x51;\r\n}\r\nstv0299_writereg(fe, 0x13, aclk);\r\nstv0299_writereg(fe, 0x14, bclk);\r\nstv0299_writereg(fe, 0x1f, (ratio >> 16) & 0xff);\r\nstv0299_writereg(fe, 0x20, (ratio >> 8) & 0xff);\r\nstv0299_writereg(fe, 0x21, ratio & 0xf0);\r\nreturn 0;\r\n}\r\nstatic int vp1033_frontend_init(struct mantis_pci *mantis, struct dvb_frontend *fe)\r\n{\r\nstruct i2c_adapter *adapter = &mantis->adapter;\r\nint err = 0;\r\nerr = mantis_frontend_power(mantis, POWER_ON);\r\nif (err == 0) {\r\nmantis_frontend_soft_reset(mantis);\r\nmsleep(250);\r\ndprintk(MANTIS_ERROR, 1, "Probing for STV0299 (DVB-S)");\r\nfe = dvb_attach(stv0299_attach, &lgtdqcs001f_config, adapter);\r\nif (fe) {\r\nfe->ops.tuner_ops.set_params = lgtdqcs001f_tuner_set;\r\ndprintk(MANTIS_ERROR, 1, "found STV0299 DVB-S frontend @ 0x%02x",\r\nlgtdqcs001f_config.demod_address);\r\ndprintk(MANTIS_ERROR, 1, "Mantis DVB-S STV0299 frontend attach success");\r\n} else {\r\nreturn -1;\r\n}\r\n} else {\r\ndprintk(MANTIS_ERROR, 1, "Frontend on <%s> POWER ON failed! <%d>",\r\nadapter->name,\r\nerr);\r\nreturn -EIO;\r\n}\r\nmantis->fe = fe;\r\ndprintk(MANTIS_ERROR, 1, "Done!");\r\nreturn 0;\r\n}

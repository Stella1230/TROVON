static int ps3rom_slave_configure(struct scsi_device *scsi_dev)\r\n{\r\nstruct ps3rom_private *priv = shost_priv(scsi_dev->host);\r\nstruct ps3_storage_device *dev = priv->dev;\r\ndev_dbg(&dev->sbd.core, "%s:%u: id %u, lun %llu, channel %u\n", __func__,\r\n__LINE__, scsi_dev->id, scsi_dev->lun, scsi_dev->channel);\r\nscsi_dev->use_10_for_ms = 1;\r\nscsi_dev->use_10_for_rw = 1;\r\nreturn 0;\r\n}\r\nstatic int ps3rom_atapi_request(struct ps3_storage_device *dev,\r\nstruct scsi_cmnd *cmd)\r\n{\r\nstruct lv1_atapi_cmnd_block atapi_cmnd;\r\nunsigned char opcode = cmd->cmnd[0];\r\nint res;\r\nu64 lpar;\r\ndev_dbg(&dev->sbd.core, "%s:%u: send ATAPI command 0x%02x\n", __func__,\r\n__LINE__, opcode);\r\nmemset(&atapi_cmnd, 0, sizeof(struct lv1_atapi_cmnd_block));\r\nmemcpy(&atapi_cmnd.pkt, cmd->cmnd, 12);\r\natapi_cmnd.pktlen = 12;\r\natapi_cmnd.block_size = 1;\r\natapi_cmnd.blocks = atapi_cmnd.arglen = scsi_bufflen(cmd);\r\natapi_cmnd.buffer = dev->bounce_lpar;\r\nswitch (cmd->sc_data_direction) {\r\ncase DMA_FROM_DEVICE:\r\nif (scsi_bufflen(cmd) >= CD_FRAMESIZE)\r\natapi_cmnd.proto = DMA_PROTO;\r\nelse\r\natapi_cmnd.proto = PIO_DATA_IN_PROTO;\r\natapi_cmnd.in_out = DIR_READ;\r\nbreak;\r\ncase DMA_TO_DEVICE:\r\nif (scsi_bufflen(cmd) >= CD_FRAMESIZE)\r\natapi_cmnd.proto = DMA_PROTO;\r\nelse\r\natapi_cmnd.proto = PIO_DATA_OUT_PROTO;\r\natapi_cmnd.in_out = DIR_WRITE;\r\nscsi_sg_copy_to_buffer(cmd, dev->bounce_buf, dev->bounce_size);\r\nbreak;\r\ndefault:\r\natapi_cmnd.proto = NON_DATA_PROTO;\r\nbreak;\r\n}\r\nlpar = ps3_mm_phys_to_lpar(__pa(&atapi_cmnd));\r\nres = lv1_storage_send_device_command(dev->sbd.dev_id,\r\nLV1_STORAGE_SEND_ATAPI_COMMAND,\r\nlpar, sizeof(atapi_cmnd),\r\natapi_cmnd.buffer,\r\natapi_cmnd.arglen, &dev->tag);\r\nif (res == LV1_DENIED_BY_POLICY) {\r\ndev_dbg(&dev->sbd.core,\r\n"%s:%u: ATAPI command 0x%02x denied by policy\n",\r\n__func__, __LINE__, opcode);\r\nreturn DID_ERROR << 16;\r\n}\r\nif (res) {\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: ATAPI command 0x%02x failed %d\n", __func__,\r\n__LINE__, opcode, res);\r\nreturn DID_ERROR << 16;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline unsigned int srb10_lba(const struct scsi_cmnd *cmd)\r\n{\r\nreturn cmd->cmnd[2] << 24 | cmd->cmnd[3] << 16 | cmd->cmnd[4] << 8 |\r\ncmd->cmnd[5];\r\n}\r\nstatic inline unsigned int srb10_len(const struct scsi_cmnd *cmd)\r\n{\r\nreturn cmd->cmnd[7] << 8 | cmd->cmnd[8];\r\n}\r\nstatic int ps3rom_read_request(struct ps3_storage_device *dev,\r\nstruct scsi_cmnd *cmd, u32 start_sector,\r\nu32 sectors)\r\n{\r\nint res;\r\ndev_dbg(&dev->sbd.core, "%s:%u: read %u sectors starting at %u\n",\r\n__func__, __LINE__, sectors, start_sector);\r\nres = lv1_storage_read(dev->sbd.dev_id,\r\ndev->regions[dev->region_idx].id, start_sector,\r\nsectors, 0, dev->bounce_lpar, &dev->tag);\r\nif (res) {\r\ndev_err(&dev->sbd.core, "%s:%u: read failed %d\n", __func__,\r\n__LINE__, res);\r\nreturn DID_ERROR << 16;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ps3rom_write_request(struct ps3_storage_device *dev,\r\nstruct scsi_cmnd *cmd, u32 start_sector,\r\nu32 sectors)\r\n{\r\nint res;\r\ndev_dbg(&dev->sbd.core, "%s:%u: write %u sectors starting at %u\n",\r\n__func__, __LINE__, sectors, start_sector);\r\nscsi_sg_copy_to_buffer(cmd, dev->bounce_buf, dev->bounce_size);\r\nres = lv1_storage_write(dev->sbd.dev_id,\r\ndev->regions[dev->region_idx].id, start_sector,\r\nsectors, 0, dev->bounce_lpar, &dev->tag);\r\nif (res) {\r\ndev_err(&dev->sbd.core, "%s:%u: write failed %d\n", __func__,\r\n__LINE__, res);\r\nreturn DID_ERROR << 16;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ps3rom_queuecommand_lck(struct scsi_cmnd *cmd,\r\nvoid (*done)(struct scsi_cmnd *))\r\n{\r\nstruct ps3rom_private *priv = shost_priv(cmd->device->host);\r\nstruct ps3_storage_device *dev = priv->dev;\r\nunsigned char opcode;\r\nint res;\r\npriv->curr_cmd = cmd;\r\ncmd->scsi_done = done;\r\nopcode = cmd->cmnd[0];\r\nswitch (opcode) {\r\ncase READ_10:\r\nres = ps3rom_read_request(dev, cmd, srb10_lba(cmd),\r\nsrb10_len(cmd));\r\nbreak;\r\ncase WRITE_10:\r\nres = ps3rom_write_request(dev, cmd, srb10_lba(cmd),\r\nsrb10_len(cmd));\r\nbreak;\r\ndefault:\r\nres = ps3rom_atapi_request(dev, cmd);\r\nbreak;\r\n}\r\nif (res) {\r\nmemset(cmd->sense_buffer, 0, SCSI_SENSE_BUFFERSIZE);\r\ncmd->result = res;\r\ncmd->sense_buffer[0] = 0x70;\r\ncmd->sense_buffer[2] = ILLEGAL_REQUEST;\r\npriv->curr_cmd = NULL;\r\ncmd->scsi_done(cmd);\r\n}\r\nreturn 0;\r\n}\r\nirqreturn_t ps3rom_interrupt(int irq, void *data)\r\n{\r\nstruct ps3_storage_device *dev = data;\r\nstruct Scsi_Host *host;\r\nstruct ps3rom_private *priv;\r\nstruct scsi_cmnd *cmd;\r\nint res;\r\nu64 tag, status;\r\nunsigned char sense_key, asc, ascq;\r\nres = lv1_storage_get_async_status(dev->sbd.dev_id, &tag, &status);\r\nif (tag != dev->tag)\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: tag mismatch, got %llx, expected %llx\n",\r\n__func__, __LINE__, tag, dev->tag);\r\nif (res) {\r\ndev_err(&dev->sbd.core, "%s:%u: res=%d status=0x%llx\n",\r\n__func__, __LINE__, res, status);\r\nreturn IRQ_HANDLED;\r\n}\r\nhost = ps3_system_bus_get_drvdata(&dev->sbd);\r\npriv = shost_priv(host);\r\ncmd = priv->curr_cmd;\r\nif (!status) {\r\nif (cmd->sc_data_direction == DMA_FROM_DEVICE) {\r\nint len;\r\nlen = scsi_sg_copy_from_buffer(cmd,\r\ndev->bounce_buf,\r\ndev->bounce_size);\r\nscsi_set_resid(cmd, scsi_bufflen(cmd) - len);\r\n}\r\ncmd->result = DID_OK << 16;\r\ngoto done;\r\n}\r\nif (cmd->cmnd[0] == REQUEST_SENSE) {\r\ndev_err(&dev->sbd.core, "%s:%u: end error without autosense\n",\r\n__func__, __LINE__);\r\ncmd->result = DID_ERROR << 16 | SAM_STAT_CHECK_CONDITION;\r\ngoto done;\r\n}\r\nif (decode_lv1_status(status, &sense_key, &asc, &ascq)) {\r\ncmd->result = DID_ERROR << 16;\r\ngoto done;\r\n}\r\nscsi_build_sense_buffer(0, cmd->sense_buffer, sense_key, asc, ascq);\r\ncmd->result = SAM_STAT_CHECK_CONDITION;\r\ndone:\r\npriv->curr_cmd = NULL;\r\ncmd->scsi_done(cmd);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ps3rom_probe(struct ps3_system_bus_device *_dev)\r\n{\r\nstruct ps3_storage_device *dev = to_ps3_storage_device(&_dev->core);\r\nint error;\r\nstruct Scsi_Host *host;\r\nstruct ps3rom_private *priv;\r\nif (dev->blk_size != CD_FRAMESIZE) {\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: cannot handle block size %llu\n", __func__,\r\n__LINE__, dev->blk_size);\r\nreturn -EINVAL;\r\n}\r\ndev->bounce_size = BOUNCE_SIZE;\r\ndev->bounce_buf = kmalloc(BOUNCE_SIZE, GFP_DMA);\r\nif (!dev->bounce_buf)\r\nreturn -ENOMEM;\r\nerror = ps3stor_setup(dev, ps3rom_interrupt);\r\nif (error)\r\ngoto fail_free_bounce;\r\nhost = scsi_host_alloc(&ps3rom_host_template,\r\nsizeof(struct ps3rom_private));\r\nif (!host) {\r\ndev_err(&dev->sbd.core, "%s:%u: scsi_host_alloc failed\n",\r\n__func__, __LINE__);\r\nerror = -ENOMEM;\r\ngoto fail_teardown;\r\n}\r\npriv = shost_priv(host);\r\nps3_system_bus_set_drvdata(&dev->sbd, host);\r\npriv->dev = dev;\r\nhost->max_id = 1;\r\nhost->max_lun = 1;\r\nerror = scsi_add_host(host, &dev->sbd.core);\r\nif (error) {\r\ndev_err(&dev->sbd.core, "%s:%u: scsi_host_alloc failed %d\n",\r\n__func__, __LINE__, error);\r\nerror = -ENODEV;\r\ngoto fail_host_put;\r\n}\r\nscsi_scan_host(host);\r\nreturn 0;\r\nfail_host_put:\r\nscsi_host_put(host);\r\nps3_system_bus_set_drvdata(&dev->sbd, NULL);\r\nfail_teardown:\r\nps3stor_teardown(dev);\r\nfail_free_bounce:\r\nkfree(dev->bounce_buf);\r\nreturn error;\r\n}\r\nstatic int ps3rom_remove(struct ps3_system_bus_device *_dev)\r\n{\r\nstruct ps3_storage_device *dev = to_ps3_storage_device(&_dev->core);\r\nstruct Scsi_Host *host = ps3_system_bus_get_drvdata(&dev->sbd);\r\nscsi_remove_host(host);\r\nps3stor_teardown(dev);\r\nscsi_host_put(host);\r\nps3_system_bus_set_drvdata(&dev->sbd, NULL);\r\nkfree(dev->bounce_buf);\r\nreturn 0;\r\n}\r\nstatic int __init ps3rom_init(void)\r\n{\r\nreturn ps3_system_bus_driver_register(&ps3rom);\r\n}\r\nstatic void __exit ps3rom_exit(void)\r\n{\r\nps3_system_bus_driver_unregister(&ps3rom);\r\n}

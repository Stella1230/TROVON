void vnic_wq_copy_enable(struct vnic_wq_copy *wq)\r\n{\r\niowrite32(1, &wq->ctrl->enable);\r\n}\r\nint vnic_wq_copy_disable(struct vnic_wq_copy *wq)\r\n{\r\nunsigned int wait;\r\niowrite32(0, &wq->ctrl->enable);\r\nfor (wait = 0; wait < 100; wait++) {\r\nif (!(ioread32(&wq->ctrl->running)))\r\nreturn 0;\r\nudelay(1);\r\n}\r\nprintk(KERN_ERR "Failed to disable Copy WQ[%d],"\r\n" fetch index=%d, posted_index=%d\n",\r\nwq->index, ioread32(&wq->ctrl->fetch_index),\r\nioread32(&wq->ctrl->posted_index));\r\nreturn -ENODEV;\r\n}\r\nvoid vnic_wq_copy_clean(struct vnic_wq_copy *wq,\r\nvoid (*q_clean)(struct vnic_wq_copy *wq,\r\nstruct fcpio_host_req *wq_desc))\r\n{\r\nBUG_ON(ioread32(&wq->ctrl->enable));\r\nif (vnic_wq_copy_desc_in_use(wq))\r\nvnic_wq_copy_service(wq, -1, q_clean);\r\nwq->to_use_index = wq->to_clean_index = 0;\r\niowrite32(0, &wq->ctrl->fetch_index);\r\niowrite32(0, &wq->ctrl->posted_index);\r\niowrite32(0, &wq->ctrl->error_status);\r\nvnic_dev_clear_desc_ring(&wq->ring);\r\n}\r\nvoid vnic_wq_copy_free(struct vnic_wq_copy *wq)\r\n{\r\nstruct vnic_dev *vdev;\r\nvdev = wq->vdev;\r\nvnic_dev_free_desc_ring(vdev, &wq->ring);\r\nwq->ctrl = NULL;\r\n}\r\nint vnic_wq_copy_alloc(struct vnic_dev *vdev, struct vnic_wq_copy *wq,\r\nunsigned int index, unsigned int desc_count,\r\nunsigned int desc_size)\r\n{\r\nint err;\r\nwq->index = index;\r\nwq->vdev = vdev;\r\nwq->to_use_index = wq->to_clean_index = 0;\r\nwq->ctrl = vnic_dev_get_res(vdev, RES_TYPE_WQ, index);\r\nif (!wq->ctrl) {\r\nprintk(KERN_ERR "Failed to hook COPY WQ[%d] resource\n", index);\r\nreturn -EINVAL;\r\n}\r\nvnic_wq_copy_disable(wq);\r\nerr = vnic_dev_alloc_desc_ring(vdev, &wq->ring, desc_count, desc_size);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nvoid vnic_wq_copy_init(struct vnic_wq_copy *wq, unsigned int cq_index,\r\nunsigned int error_interrupt_enable,\r\nunsigned int error_interrupt_offset)\r\n{\r\nu64 paddr;\r\npaddr = (u64)wq->ring.base_addr | VNIC_PADDR_TARGET;\r\nwriteq(paddr, &wq->ctrl->ring_base);\r\niowrite32(wq->ring.desc_count, &wq->ctrl->ring_size);\r\niowrite32(0, &wq->ctrl->fetch_index);\r\niowrite32(0, &wq->ctrl->posted_index);\r\niowrite32(cq_index, &wq->ctrl->cq_index);\r\niowrite32(error_interrupt_enable, &wq->ctrl->error_interrupt_enable);\r\niowrite32(error_interrupt_offset, &wq->ctrl->error_interrupt_offset);\r\n}

static inline void sirfsoc_timer_count_disable(int idx)\r\n{\r\nwritel_relaxed(readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_32COUNTER_0_CTRL + 4 * idx) & ~0x7,\r\nsirfsoc_timer_base + SIRFSOC_TIMER_32COUNTER_0_CTRL + 4 * idx);\r\n}\r\nstatic inline void sirfsoc_timer_count_enable(int idx)\r\n{\r\nwritel_relaxed(readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_32COUNTER_0_CTRL + 4 * idx) | 0x3,\r\nsirfsoc_timer_base + SIRFSOC_TIMER_32COUNTER_0_CTRL + 4 * idx);\r\n}\r\nstatic irqreturn_t sirfsoc_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *ce = dev_id;\r\nint cpu = smp_processor_id();\r\nwritel_relaxed(BIT(cpu), sirfsoc_timer_base + SIRFSOC_TIMER_INTR_STATUS);\r\nif (ce->mode == CLOCK_EVT_MODE_ONESHOT)\r\nsirfsoc_timer_count_disable(cpu);\r\nce->event_handler(ce);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic cycle_t sirfsoc_timer_read(struct clocksource *cs)\r\n{\r\nu64 cycles;\r\nwritel_relaxed((readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_CTRL) |\r\nBIT(0)) & ~BIT(1), sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_CTRL);\r\ncycles = readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_RLATCHED_HI);\r\ncycles = (cycles << 32) | readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_RLATCHED_LO);\r\nreturn cycles;\r\n}\r\nstatic int sirfsoc_timer_set_next_event(unsigned long delta,\r\nstruct clock_event_device *ce)\r\n{\r\nint cpu = smp_processor_id();\r\nsirfsoc_timer_count_disable(cpu);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_COUNTER_0 +\r\n4 * cpu);\r\nwritel_relaxed(delta, sirfsoc_timer_base + SIRFSOC_TIMER_MATCH_0 +\r\n4 * cpu);\r\nsirfsoc_timer_count_enable(cpu);\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_timer_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *ce)\r\n{\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nsirfsoc_timer_count_disable(smp_processor_id());\r\n}\r\nstatic void sirfsoc_clocksource_suspend(struct clocksource *cs)\r\n{\r\nint i;\r\nfor (i = 0; i < SIRFSOC_TIMER_REG_CNT; i++)\r\nsirfsoc_timer_reg_val[i] = readl_relaxed(sirfsoc_timer_base + sirfsoc_timer_reg_list[i]);\r\n}\r\nstatic void sirfsoc_clocksource_resume(struct clocksource *cs)\r\n{\r\nint i;\r\nfor (i = 0; i < SIRFSOC_TIMER_REG_CNT - 2; i++)\r\nwritel_relaxed(sirfsoc_timer_reg_val[i], sirfsoc_timer_base + sirfsoc_timer_reg_list[i]);\r\nwritel_relaxed(sirfsoc_timer_reg_val[SIRFSOC_TIMER_REG_CNT - 2],\r\nsirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_LOAD_LO);\r\nwritel_relaxed(sirfsoc_timer_reg_val[SIRFSOC_TIMER_REG_CNT - 1],\r\nsirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_LOAD_HI);\r\nwritel_relaxed(readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_CTRL) |\r\nBIT(1) | BIT(0), sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_CTRL);\r\n}\r\nstatic int sirfsoc_local_timer_setup(struct clock_event_device *ce)\r\n{\r\nint cpu = smp_processor_id();\r\nstruct irqaction *action;\r\nif (cpu == 0)\r\naction = &sirfsoc_timer_irq;\r\nelse\r\naction = &sirfsoc_timer1_irq;\r\nce->irq = action->irq;\r\nce->name = "local_timer";\r\nce->features = CLOCK_EVT_FEAT_ONESHOT;\r\nce->rating = 200;\r\nce->set_mode = sirfsoc_timer_set_mode;\r\nce->set_next_event = sirfsoc_timer_set_next_event;\r\nclockevents_calc_mult_shift(ce, atlas7_timer_rate, 60);\r\nce->max_delta_ns = clockevent_delta2ns(-2, ce);\r\nce->min_delta_ns = clockevent_delta2ns(2, ce);\r\nce->cpumask = cpumask_of(cpu);\r\naction->dev_id = ce;\r\nBUG_ON(setup_irq(ce->irq, action));\r\nirq_force_affinity(action->irq, cpumask_of(cpu));\r\nclockevents_register_device(ce);\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_local_timer_stop(struct clock_event_device *ce)\r\n{\r\nint cpu = smp_processor_id();\r\nsirfsoc_timer_count_disable(1);\r\nif (cpu == 0)\r\nremove_irq(sirfsoc_timer_irq.irq, &sirfsoc_timer_irq);\r\nelse\r\nremove_irq(sirfsoc_timer1_irq.irq, &sirfsoc_timer1_irq);\r\n}\r\nstatic int sirfsoc_cpu_notify(struct notifier_block *self,\r\nunsigned long action, void *hcpu)\r\n{\r\nswitch (action & ~CPU_TASKS_FROZEN) {\r\ncase CPU_STARTING:\r\nsirfsoc_local_timer_setup(this_cpu_ptr(sirfsoc_clockevent));\r\nbreak;\r\ncase CPU_DYING:\r\nsirfsoc_local_timer_stop(this_cpu_ptr(sirfsoc_clockevent));\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic void __init sirfsoc_clockevent_init(void)\r\n{\r\nsirfsoc_clockevent = alloc_percpu(struct clock_event_device);\r\nBUG_ON(!sirfsoc_clockevent);\r\nBUG_ON(register_cpu_notifier(&sirfsoc_cpu_nb));\r\nsirfsoc_local_timer_setup(this_cpu_ptr(sirfsoc_clockevent));\r\n}\r\nstatic void __init sirfsoc_atlas7_timer_init(struct device_node *np)\r\n{\r\nstruct clk *clk;\r\nclk = of_clk_get(np, 0);\r\nBUG_ON(IS_ERR(clk));\r\nBUG_ON(clk_prepare_enable(clk));\r\natlas7_timer_rate = clk_get_rate(clk);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_CTRL);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_32COUNTER_0_CTRL);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_32COUNTER_1_CTRL);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_LOAD_LO);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_LOAD_HI);\r\nwritel_relaxed(readl_relaxed(sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_CTRL) |\r\nBIT(1) | BIT(0), sirfsoc_timer_base + SIRFSOC_TIMER_64COUNTER_CTRL);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_COUNTER_0);\r\nwritel_relaxed(0, sirfsoc_timer_base + SIRFSOC_TIMER_COUNTER_1);\r\nwritel_relaxed(0xFFFF, sirfsoc_timer_base + SIRFSOC_TIMER_INTR_STATUS);\r\nBUG_ON(clocksource_register_hz(&sirfsoc_clocksource, atlas7_timer_rate));\r\nsirfsoc_clockevent_init();\r\n}\r\nstatic void __init sirfsoc_of_timer_init(struct device_node *np)\r\n{\r\nsirfsoc_timer_base = of_iomap(np, 0);\r\nif (!sirfsoc_timer_base)\r\npanic("unable to map timer cpu registers\n");\r\nsirfsoc_timer_irq.irq = irq_of_parse_and_map(np, 0);\r\nif (!sirfsoc_timer_irq.irq)\r\npanic("No irq passed for timer0 via DT\n");\r\nsirfsoc_timer1_irq.irq = irq_of_parse_and_map(np, 1);\r\nif (!sirfsoc_timer1_irq.irq)\r\npanic("No irq passed for timer1 via DT\n");\r\nsirfsoc_atlas7_timer_init(np);\r\n}

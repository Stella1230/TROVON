static int tda665x_read(struct tda665x_state *state, u8 *buf)\r\n{\r\nconst struct tda665x_config *config = state->config;\r\nint err = 0;\r\nstruct i2c_msg msg = { .addr = config->addr, .flags = I2C_M_RD, .buf = buf, .len = 2 };\r\nerr = i2c_transfer(state->i2c, &msg, 1);\r\nif (err != 1)\r\ngoto exit;\r\nreturn err;\r\nexit:\r\nprintk(KERN_ERR "%s: I/O Error err=<%d>\n", __func__, err);\r\nreturn err;\r\n}\r\nstatic int tda665x_write(struct tda665x_state *state, u8 *buf, u8 length)\r\n{\r\nconst struct tda665x_config *config = state->config;\r\nint err = 0;\r\nstruct i2c_msg msg = { .addr = config->addr, .flags = 0, .buf = buf, .len = length };\r\nerr = i2c_transfer(state->i2c, &msg, 1);\r\nif (err != 1)\r\ngoto exit;\r\nreturn err;\r\nexit:\r\nprintk(KERN_ERR "%s: I/O Error err=<%d>\n", __func__, err);\r\nreturn err;\r\n}\r\nstatic int tda665x_get_state(struct dvb_frontend *fe,\r\nenum tuner_param param,\r\nstruct tuner_state *tstate)\r\n{\r\nstruct tda665x_state *state = fe->tuner_priv;\r\nint err = 0;\r\nswitch (param) {\r\ncase DVBFE_TUNER_FREQUENCY:\r\ntstate->frequency = state->frequency;\r\nbreak;\r\ncase DVBFE_TUNER_BANDWIDTH:\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s: Unknown parameter (param=%d)\n", __func__, param);\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nstatic int tda665x_get_status(struct dvb_frontend *fe, u32 *status)\r\n{\r\nstruct tda665x_state *state = fe->tuner_priv;\r\nu8 result = 0;\r\nint err = 0;\r\n*status = 0;\r\nerr = tda665x_read(state, &result);\r\nif (err < 0)\r\ngoto exit;\r\nif ((result >> 6) & 0x01) {\r\nprintk(KERN_DEBUG "%s: Tuner Phase Locked\n", __func__);\r\n*status = 1;\r\n}\r\nreturn err;\r\nexit:\r\nprintk(KERN_ERR "%s: I/O Error\n", __func__);\r\nreturn err;\r\n}\r\nstatic int tda665x_set_state(struct dvb_frontend *fe,\r\nenum tuner_param param,\r\nstruct tuner_state *tstate)\r\n{\r\nstruct tda665x_state *state = fe->tuner_priv;\r\nconst struct tda665x_config *config = state->config;\r\nu32 frequency, status = 0;\r\nu8 buf[4];\r\nint err = 0;\r\nif (param & DVBFE_TUNER_FREQUENCY) {\r\nfrequency = tstate->frequency;\r\nif ((frequency < config->frequency_max) || (frequency > config->frequency_min)) {\r\nprintk(KERN_ERR "%s: Frequency beyond limits, frequency=%d\n", __func__, frequency);\r\nreturn -EINVAL;\r\n}\r\nfrequency += config->frequency_offst;\r\nfrequency *= config->ref_multiplier;\r\nfrequency += config->ref_divider >> 1;\r\nfrequency /= config->ref_divider;\r\nbuf[0] = (u8) ((frequency & 0x7f00) >> 8);\r\nbuf[1] = (u8) (frequency & 0x00ff) >> 0;\r\nbuf[2] = 0x80 | 0x40 | 0x02;\r\nbuf[3] = 0x00;\r\nfrequency = tstate->frequency;\r\nif (frequency < 153000000) {\r\nbuf[3] |= 0x01;\r\nif (frequency < 68000000)\r\nbuf[3] |= 0x40;\r\nif (frequency < 1040000000)\r\nbuf[3] |= 0x60;\r\nif (frequency < 1250000000)\r\nbuf[3] |= 0x80;\r\nelse\r\nbuf[3] |= 0xa0;\r\n} else if (frequency < 438000000) {\r\nbuf[3] |= 0x02;\r\nif (frequency < 230000000)\r\nbuf[3] |= 0x40;\r\nif (frequency < 300000000)\r\nbuf[3] |= 0x60;\r\nelse\r\nbuf[3] |= 0x80;\r\n} else {\r\nbuf[3] |= 0x04;\r\nif (frequency < 470000000)\r\nbuf[3] |= 0x60;\r\nif (frequency < 526000000)\r\nbuf[3] |= 0x80;\r\nelse\r\nbuf[3] |= 0xa0;\r\n}\r\nerr = tda665x_write(state, buf, 5);\r\nif (err < 0)\r\ngoto exit;\r\nprintk(KERN_DEBUG "%s: Waiting to Phase LOCK\n", __func__);\r\nmsleep(20);\r\nerr = tda665x_get_status(fe, &status);\r\nif (err < 0)\r\ngoto exit;\r\nif (status == 1) {\r\nprintk(KERN_DEBUG "%s: Tuner Phase locked: status=%d\n", __func__, status);\r\nstate->frequency = frequency;\r\n} else {\r\nprintk(KERN_ERR "%s: No Phase lock: status=%d\n", __func__, status);\r\n}\r\n} else {\r\nprintk(KERN_ERR "%s: Unknown parameter (param=%d)\n", __func__, param);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\nexit:\r\nprintk(KERN_ERR "%s: I/O Error\n", __func__);\r\nreturn err;\r\n}\r\nstatic int tda665x_release(struct dvb_frontend *fe)\r\n{\r\nstruct tda665x_state *state = fe->tuner_priv;\r\nfe->tuner_priv = NULL;\r\nkfree(state);\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *tda665x_attach(struct dvb_frontend *fe,\r\nconst struct tda665x_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct tda665x_state *state = NULL;\r\nstruct dvb_tuner_info *info;\r\nstate = kzalloc(sizeof(struct tda665x_state), GFP_KERNEL);\r\nif (!state)\r\nreturn NULL;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->fe = fe;\r\nfe->tuner_priv = state;\r\nfe->ops.tuner_ops = tda665x_ops;\r\ninfo = &fe->ops.tuner_ops.info;\r\nmemcpy(info->name, config->name, sizeof(config->name));\r\ninfo->frequency_min = config->frequency_min;\r\ninfo->frequency_max = config->frequency_max;\r\ninfo->frequency_step = config->frequency_offst;\r\nprintk(KERN_DEBUG "%s: Attaching TDA665x (%s) tuner\n", __func__, info->name);\r\nreturn fe;\r\n}

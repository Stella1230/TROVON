static void tpiu_enable_hw(struct tpiu_drvdata *drvdata)\r\n{\r\nCS_UNLOCK(drvdata->base);\r\nCS_LOCK(drvdata->base);\r\n}\r\nstatic int tpiu_enable(struct coresight_device *csdev)\r\n{\r\nstruct tpiu_drvdata *drvdata = dev_get_drvdata(csdev->dev.parent);\r\nint ret;\r\nret = clk_prepare_enable(drvdata->clk);\r\nif (ret)\r\nreturn ret;\r\ntpiu_enable_hw(drvdata);\r\ndev_info(drvdata->dev, "TPIU enabled\n");\r\nreturn 0;\r\n}\r\nstatic void tpiu_disable_hw(struct tpiu_drvdata *drvdata)\r\n{\r\nCS_UNLOCK(drvdata->base);\r\nwritel_relaxed(0x0, drvdata->base + TPIU_FFCR);\r\nwritel_relaxed(FFCR_FON_MAN, drvdata->base + TPIU_FFCR);\r\nCS_LOCK(drvdata->base);\r\n}\r\nstatic void tpiu_disable(struct coresight_device *csdev)\r\n{\r\nstruct tpiu_drvdata *drvdata = dev_get_drvdata(csdev->dev.parent);\r\ntpiu_disable_hw(drvdata);\r\nclk_disable_unprepare(drvdata->clk);\r\ndev_info(drvdata->dev, "TPIU disabled\n");\r\n}\r\nstatic int tpiu_probe(struct amba_device *adev, const struct amba_id *id)\r\n{\r\nint ret;\r\nvoid __iomem *base;\r\nstruct device *dev = &adev->dev;\r\nstruct coresight_platform_data *pdata = NULL;\r\nstruct tpiu_drvdata *drvdata;\r\nstruct resource *res = &adev->res;\r\nstruct coresight_desc *desc;\r\nstruct device_node *np = adev->dev.of_node;\r\nif (np) {\r\npdata = of_get_coresight_platform_data(dev, np);\r\nif (IS_ERR(pdata))\r\nreturn PTR_ERR(pdata);\r\nadev->dev.platform_data = pdata;\r\n}\r\ndrvdata = devm_kzalloc(dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\ndrvdata->dev = &adev->dev;\r\ndev_set_drvdata(dev, drvdata);\r\nbase = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\ndrvdata->base = base;\r\ndrvdata->clk = adev->pclk;\r\nret = clk_prepare_enable(drvdata->clk);\r\nif (ret)\r\nreturn ret;\r\ntpiu_disable_hw(drvdata);\r\nclk_disable_unprepare(drvdata->clk);\r\ndesc = devm_kzalloc(dev, sizeof(*desc), GFP_KERNEL);\r\nif (!desc)\r\nreturn -ENOMEM;\r\ndesc->type = CORESIGHT_DEV_TYPE_SINK;\r\ndesc->subtype.sink_subtype = CORESIGHT_DEV_SUBTYPE_SINK_PORT;\r\ndesc->ops = &tpiu_cs_ops;\r\ndesc->pdata = pdata;\r\ndesc->dev = dev;\r\ndrvdata->csdev = coresight_register(desc);\r\nif (IS_ERR(drvdata->csdev))\r\nreturn PTR_ERR(drvdata->csdev);\r\ndev_info(dev, "TPIU initialized\n");\r\nreturn 0;\r\n}\r\nstatic int tpiu_remove(struct amba_device *adev)\r\n{\r\nstruct tpiu_drvdata *drvdata = amba_get_drvdata(adev);\r\ncoresight_unregister(drvdata->csdev);\r\nreturn 0;\r\n}

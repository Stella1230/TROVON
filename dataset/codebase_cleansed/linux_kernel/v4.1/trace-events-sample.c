static void simple_thread_func(int cnt)\r\n{\r\nint array[6];\r\nint len = cnt % 5;\r\nint i;\r\nset_current_state(TASK_INTERRUPTIBLE);\r\nschedule_timeout(HZ);\r\nfor (i = 0; i < len; i++)\r\narray[i] = i + 1;\r\narray[i] = 0;\r\ntrace_foo_bar("hello", cnt, array, random_strings[len],\r\ntsk_cpus_allowed(current));\r\ntrace_foo_with_template_simple("HELLO", cnt);\r\ntrace_foo_bar_with_cond("Some times print", cnt);\r\ntrace_foo_with_template_cond("prints other times", cnt);\r\ntrace_foo_with_template_print("I have to be different", cnt);\r\n}\r\nstatic int simple_thread(void *arg)\r\n{\r\nint cnt = 0;\r\nwhile (!kthread_should_stop())\r\nsimple_thread_func(cnt++);\r\nreturn 0;\r\n}\r\nstatic void simple_thread_func_fn(int cnt)\r\n{\r\nset_current_state(TASK_INTERRUPTIBLE);\r\nschedule_timeout(HZ);\r\ntrace_foo_bar_with_fn("Look at me", cnt);\r\ntrace_foo_with_template_fn("Look at me too", cnt);\r\n}\r\nstatic int simple_thread_fn(void *arg)\r\n{\r\nint cnt = 0;\r\nwhile (!kthread_should_stop())\r\nsimple_thread_func_fn(cnt++);\r\nreturn 0;\r\n}\r\nvoid foo_bar_reg(void)\r\n{\r\npr_info("Starting thread for foo_bar_fn\n");\r\nmutex_lock(&thread_mutex);\r\nsimple_tsk_fn = kthread_run(simple_thread_fn, NULL, "event-sample-fn");\r\nmutex_unlock(&thread_mutex);\r\n}\r\nvoid foo_bar_unreg(void)\r\n{\r\npr_info("Killing thread for foo_bar_fn\n");\r\nmutex_lock(&thread_mutex);\r\nif (simple_tsk_fn)\r\nkthread_stop(simple_tsk_fn);\r\nsimple_tsk_fn = NULL;\r\nmutex_unlock(&thread_mutex);\r\n}\r\nstatic int __init trace_event_init(void)\r\n{\r\nsimple_tsk = kthread_run(simple_thread, NULL, "event-sample");\r\nif (IS_ERR(simple_tsk))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic void __exit trace_event_exit(void)\r\n{\r\nkthread_stop(simple_tsk);\r\nmutex_lock(&thread_mutex);\r\nif (simple_tsk_fn)\r\nkthread_stop(simple_tsk_fn);\r\nsimple_tsk_fn = NULL;\r\nmutex_unlock(&thread_mutex);\r\n}

static inline int\r\nramxlat(const struct ramxlat *xlat, int id)\r\n{\r\nwhile (xlat->id >= 0) {\r\nif (xlat->id == id)\r\nreturn xlat->enc;\r\nxlat++;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint\r\nnvkm_gddr3_calc(struct nvkm_ram *ram)\r\n{\r\nint CL, WR, CWL, DLL = 0, ODT = 0, hi;\r\nswitch (ram->next->bios.timing_ver) {\r\ncase 0x10:\r\nCWL = ram->next->bios.timing_10_CWL;\r\nCL = ram->next->bios.timing_10_CL;\r\nWR = ram->next->bios.timing_10_WR;\r\nDLL = !ram->next->bios.ramcfg_10_DLLoff;\r\nODT = ram->next->bios.timing_10_ODT;\r\nbreak;\r\ncase 0x20:\r\nCWL = (ram->next->bios.timing[1] & 0x00000f80) >> 7;\r\nCL = (ram->next->bios.timing[1] & 0x0000001f) >> 0;\r\nWR = (ram->next->bios.timing[2] & 0x007f0000) >> 16;\r\nDLL = !(ram->mr[1] & 0x1);\r\nODT = (ram->mr[1] & 0x004) >> 2 |\r\n(ram->mr[1] & 0x040) >> 5 |\r\n(ram->mr[1] & 0x200) >> 7;\r\nbreak;\r\ndefault:\r\nreturn -ENOSYS;\r\n}\r\nhi = ram->mr[2] & 0x1;\r\nCL = ramxlat(hi ? ramgddr3_cl_hi : ramgddr3_cl_lo, CL);\r\nWR = ramxlat(ramgddr3_wr_lo, WR);\r\nif (CL < 0 || CWL < 1 || CWL > 7 || WR < 0)\r\nreturn -EINVAL;\r\nram->mr[0] &= ~0xf74;\r\nram->mr[0] |= (CWL & 0x07) << 9;\r\nram->mr[0] |= (CL & 0x07) << 4;\r\nram->mr[0] |= (CL & 0x08) >> 1;\r\nram->mr[1] &= ~0x3fc;\r\nram->mr[1] |= (ODT & 0x03) << 2;\r\nram->mr[1] |= (ODT & 0x03) << 8;\r\nram->mr[1] |= (WR & 0x03) << 4;\r\nram->mr[1] |= (WR & 0x04) << 5;\r\nram->mr[1] |= !DLL << 6;\r\nreturn 0;\r\n}

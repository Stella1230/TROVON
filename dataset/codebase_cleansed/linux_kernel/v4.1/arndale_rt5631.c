static int arndale_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint rfs, ret;\r\nunsigned long rclk;\r\nrfs = 256;\r\nrclk = params_rate(params) * rfs;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, SAMSUNG_I2S_CDCLK,\r\n0, SND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, SAMSUNG_I2S_RCLKSRC_0,\r\n0, SND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, rclk, SND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int arndale_audio_probe(struct platform_device *pdev)\r\n{\r\nint n, ret;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct snd_soc_card *card = &arndale_rt5631;\r\ncard->dev = &pdev->dev;\r\nfor (n = 0; np && n < ARRAY_SIZE(arndale_rt5631_dai); n++) {\r\nif (!arndale_rt5631_dai[n].cpu_dai_name) {\r\narndale_rt5631_dai[n].cpu_of_node = of_parse_phandle(np,\r\n"samsung,audio-cpu", n);\r\nif (!arndale_rt5631_dai[n].cpu_of_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'samsung,audio-cpu' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (!arndale_rt5631_dai[n].platform_name)\r\narndale_rt5631_dai[n].platform_of_node =\r\narndale_rt5631_dai[n].cpu_of_node;\r\narndale_rt5631_dai[n].codec_name = NULL;\r\narndale_rt5631_dai[n].codec_of_node = of_parse_phandle(np,\r\n"samsung,audio-codec", n);\r\nif (!arndale_rt5631_dai[0].codec_of_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'samsung,audio-codec' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nret = devm_snd_soc_register_card(card->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "snd_soc_register_card() failed:%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int arndale_audio_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_card(card);\r\nreturn 0;\r\n}

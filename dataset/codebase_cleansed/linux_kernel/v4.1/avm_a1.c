static inline u_char\r\nreadreg(unsigned int adr, u_char off)\r\n{\r\nreturn (bytein(adr + off));\r\n}\r\nstatic inline void\r\nwritereg(unsigned int adr, u_char off, u_char data)\r\n{\r\nbyteout(adr + off, data);\r\n}\r\nstatic inline void\r\nread_fifo(unsigned int adr, u_char *data, int size)\r\n{\r\ninsb(adr, data, size);\r\n}\r\nstatic void\r\nwrite_fifo(unsigned int adr, u_char *data, int size)\r\n{\r\noutsb(adr, data, size);\r\n}\r\nstatic u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.avm.isac, offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.avm.isac, offset, value);\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nread_fifo(cs->hw.avm.isacfifo, data, size);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nwrite_fifo(cs->hw.avm.isacfifo, data, size);\r\n}\r\nstatic u_char\r\nReadHSCX(struct IsdnCardState *cs, int hscx, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.avm.hscx[hscx], offset));\r\n}\r\nstatic void\r\nWriteHSCX(struct IsdnCardState *cs, int hscx, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.avm.hscx[hscx], offset, value);\r\n}\r\nstatic irqreturn_t\r\navm_a1_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val, sval;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nwhile (((sval = bytein(cs->hw.avm.cfg_reg)) & 0xf) != 0x7) {\r\nif (!(sval & AVM_A1_STAT_TIMER)) {\r\nbyteout(cs->hw.avm.cfg_reg, 0x1E);\r\nsval = bytein(cs->hw.avm.cfg_reg);\r\n} else if (cs->debug & L1_DEB_INTSTAT)\r\ndebugl1(cs, "avm IntStatus %x", sval);\r\nif (!(sval & AVM_A1_STAT_HSCX)) {\r\nval = readreg(cs->hw.avm.hscx[1], HSCX_ISTA);\r\nif (val)\r\nhscx_int_main(cs, val);\r\n}\r\nif (!(sval & AVM_A1_STAT_ISAC)) {\r\nval = readreg(cs->hw.avm.isac, ISAC_ISTA);\r\nif (val)\r\nisac_interrupt(cs, val);\r\n}\r\n}\r\nwritereg(cs->hw.avm.hscx[0], HSCX_MASK, 0xFF);\r\nwritereg(cs->hw.avm.hscx[1], HSCX_MASK, 0xFF);\r\nwritereg(cs->hw.avm.isac, ISAC_MASK, 0xFF);\r\nwritereg(cs->hw.avm.isac, ISAC_MASK, 0x0);\r\nwritereg(cs->hw.avm.hscx[0], HSCX_MASK, 0x0);\r\nwritereg(cs->hw.avm.hscx[1], HSCX_MASK, 0x0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic inline void\r\nrelease_ioregs(struct IsdnCardState *cs, int mask)\r\n{\r\nrelease_region(cs->hw.avm.cfg_reg, 8);\r\nif (mask & 1)\r\nrelease_region(cs->hw.avm.isac + 32, 32);\r\nif (mask & 2)\r\nrelease_region(cs->hw.avm.isacfifo, 1);\r\nif (mask & 4)\r\nrelease_region(cs->hw.avm.hscx[0] + 32, 32);\r\nif (mask & 8)\r\nrelease_region(cs->hw.avm.hscxfifo[0], 1);\r\nif (mask & 0x10)\r\nrelease_region(cs->hw.avm.hscx[1] + 32, 32);\r\nif (mask & 0x20)\r\nrelease_region(cs->hw.avm.hscxfifo[1], 1);\r\n}\r\nstatic int\r\nAVM_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nreturn (0);\r\ncase CARD_RELEASE:\r\nrelease_ioregs(cs, 0x3f);\r\nreturn (0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\ninithscxisac(cs, 1);\r\nbyteout(cs->hw.avm.cfg_reg, 0x16);\r\nbyteout(cs->hw.avm.cfg_reg, 0x1E);\r\ninithscxisac(cs, 2);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_TEST:\r\nreturn (0);\r\n}\r\nreturn (0);\r\n}\r\nint setup_avm_a1(struct IsdnCard *card)\r\n{\r\nu_char val;\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, avm_revision);\r\nprintk(KERN_INFO "HiSax: AVM driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_A1)\r\nreturn (0);\r\ncs->hw.avm.cfg_reg = card->para[1] + 0x1800;\r\ncs->hw.avm.isac = card->para[1] + 0x1400 - 0x20;\r\ncs->hw.avm.hscx[0] = card->para[1] + 0x400 - 0x20;\r\ncs->hw.avm.hscx[1] = card->para[1] + 0xc00 - 0x20;\r\ncs->hw.avm.isacfifo = card->para[1] + 0x1000;\r\ncs->hw.avm.hscxfifo[0] = card->para[1];\r\ncs->hw.avm.hscxfifo[1] = card->para[1] + 0x800;\r\ncs->irq = card->para[0];\r\nif (!request_region(cs->hw.avm.cfg_reg, 8, "avm cfg")) {\r\nprintk(KERN_WARNING\r\n"HiSax: AVM A1 config port %x-%x already in use\n",\r\ncs->hw.avm.cfg_reg,\r\ncs->hw.avm.cfg_reg + 8);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.avm.isac + 32, 32, "HiSax isac")) {\r\nprintk(KERN_WARNING\r\n"HiSax: AVM A1 isac ports %x-%x already in use\n",\r\ncs->hw.avm.isac + 32,\r\ncs->hw.avm.isac + 64);\r\nrelease_ioregs(cs, 0);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.avm.isacfifo, 1, "HiSax isac fifo")) {\r\nprintk(KERN_WARNING\r\n"HiSax: AVM A1 isac fifo port %x already in use\n",\r\ncs->hw.avm.isacfifo);\r\nrelease_ioregs(cs, 1);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.avm.hscx[0] + 32, 32, "HiSax hscx A")) {\r\nprintk(KERN_WARNING\r\n"HiSax: AVM A1 hscx A ports %x-%x already in use\n",\r\ncs->hw.avm.hscx[0] + 32,\r\ncs->hw.avm.hscx[0] + 64);\r\nrelease_ioregs(cs, 3);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.avm.hscxfifo[0], 1, "HiSax hscx A fifo")) {\r\nprintk(KERN_WARNING\r\n"HiSax: AVM A1 hscx A fifo port %x already in use\n",\r\ncs->hw.avm.hscxfifo[0]);\r\nrelease_ioregs(cs, 7);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.avm.hscx[1] + 32, 32, "HiSax hscx B")) {\r\nprintk(KERN_WARNING\r\n"HiSax: AVM A1 hscx B ports %x-%x already in use\n",\r\ncs->hw.avm.hscx[1] + 32,\r\ncs->hw.avm.hscx[1] + 64);\r\nrelease_ioregs(cs, 0xf);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.avm.hscxfifo[1], 1, "HiSax hscx B fifo")) {\r\nprintk(KERN_WARNING\r\n"HiSax: AVM A1 hscx B fifo port %x already in use\n",\r\ncs->hw.avm.hscxfifo[1]);\r\nrelease_ioregs(cs, 0x1f);\r\nreturn (0);\r\n}\r\nbyteout(cs->hw.avm.cfg_reg, 0x0);\r\nHZDELAY(HZ / 5 + 1);\r\nbyteout(cs->hw.avm.cfg_reg, 0x1);\r\nHZDELAY(HZ / 5 + 1);\r\nbyteout(cs->hw.avm.cfg_reg, 0x0);\r\nHZDELAY(HZ / 5 + 1);\r\nval = cs->irq;\r\nif (val == 9)\r\nval = 2;\r\nbyteout(cs->hw.avm.cfg_reg + 1, val);\r\nHZDELAY(HZ / 5 + 1);\r\nbyteout(cs->hw.avm.cfg_reg, 0x0);\r\nHZDELAY(HZ / 5 + 1);\r\nval = bytein(cs->hw.avm.cfg_reg);\r\nprintk(KERN_INFO "AVM A1: Byte at %x is %x\n",\r\ncs->hw.avm.cfg_reg, val);\r\nval = bytein(cs->hw.avm.cfg_reg + 3);\r\nprintk(KERN_INFO "AVM A1: Byte at %x is %x\n",\r\ncs->hw.avm.cfg_reg + 3, val);\r\nval = bytein(cs->hw.avm.cfg_reg + 2);\r\nprintk(KERN_INFO "AVM A1: Byte at %x is %x\n",\r\ncs->hw.avm.cfg_reg + 2, val);\r\nval = bytein(cs->hw.avm.cfg_reg);\r\nprintk(KERN_INFO "AVM A1: Byte at %x is %x\n",\r\ncs->hw.avm.cfg_reg, val);\r\nprintk(KERN_INFO "HiSax: AVM A1 config irq:%d cfg:0x%X\n",\r\ncs->irq,\r\ncs->hw.avm.cfg_reg);\r\nprintk(KERN_INFO\r\n"HiSax: isac:0x%X/0x%X\n",\r\ncs->hw.avm.isac + 32, cs->hw.avm.isacfifo);\r\nprintk(KERN_INFO\r\n"HiSax: hscx A:0x%X/0x%X hscx B:0x%X/0x%X\n",\r\ncs->hw.avm.hscx[0] + 32, cs->hw.avm.hscxfifo[0],\r\ncs->hw.avm.hscx[1] + 32, cs->hw.avm.hscxfifo[1]);\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadHSCX;\r\ncs->BC_Write_Reg = &WriteHSCX;\r\ncs->BC_Send_Data = &hscx_fill_fifo;\r\nsetup_isac(cs);\r\ncs->cardmsg = &AVM_card_msg;\r\ncs->irq_func = &avm_a1_interrupt;\r\nISACVersion(cs, "AVM A1:");\r\nif (HscxVersion(cs, "AVM A1:")) {\r\nprintk(KERN_WARNING\r\n"AVM A1: wrong HSCX versions check IO address\n");\r\nrelease_ioregs(cs, 0x3f);\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}

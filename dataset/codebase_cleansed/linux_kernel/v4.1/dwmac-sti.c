static void stih4xx_fix_retime_src(void *priv, u32 spd)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nu32 src = dwmac->tx_retime_src;\r\nu32 reg = dwmac->ctrl_reg;\r\nu32 freq = 0;\r\nif (dwmac->interface == PHY_INTERFACE_MODE_MII) {\r\nsrc = TX_RETIME_SRC_TXCLK;\r\n} else if (dwmac->interface == PHY_INTERFACE_MODE_RMII) {\r\nif (dwmac->ext_phyclk) {\r\nsrc = TX_RETIME_SRC_PHYCLK;\r\n} else {\r\nsrc = TX_RETIME_SRC_CLKGEN;\r\nfreq = DWMAC_50MHZ;\r\n}\r\n} else if (IS_PHY_IF_MODE_RGMII(dwmac->interface)) {\r\nif (spd == SPEED_1000) {\r\nfreq = DWMAC_125MHZ;\r\n} else {\r\nsrc = TX_RETIME_SRC_CLKGEN;\r\nif (spd == SPEED_100)\r\nfreq = DWMAC_25MHZ;\r\nelse if (spd == SPEED_10)\r\nfreq = DWMAC_2_5MHZ;\r\n}\r\n}\r\nif (src == TX_RETIME_SRC_CLKGEN && dwmac->clk && freq)\r\nclk_set_rate(dwmac->clk, freq);\r\nregmap_update_bits(dwmac->regmap, reg, STIH4XX_RETIME_SRC_MASK,\r\nstih4xx_tx_retime_val[src]);\r\n}\r\nstatic void stid127_fix_retime_src(void *priv, u32 spd)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nu32 reg = dwmac->ctrl_reg;\r\nu32 freq = 0;\r\nu32 val = 0;\r\nif (dwmac->interface == PHY_INTERFACE_MODE_MII) {\r\nval = STID127_ETH_SEL_INTERNAL_NOTEXT_TXCLK;\r\n} else if (dwmac->interface == PHY_INTERFACE_MODE_RMII) {\r\nif (!dwmac->ext_phyclk) {\r\nval = STID127_ETH_SEL_INTERNAL_NOTEXT_PHYCLK;\r\nfreq = DWMAC_50MHZ;\r\n}\r\n} else if (IS_PHY_IF_MODE_RGMII(dwmac->interface)) {\r\nval = STID127_ETH_SEL_INTERNAL_NOTEXT_TXCLK;\r\nif (spd == SPEED_1000)\r\nfreq = DWMAC_125MHZ;\r\nelse if (spd == SPEED_100)\r\nfreq = DWMAC_25MHZ;\r\nelse if (spd == SPEED_10)\r\nfreq = DWMAC_2_5MHZ;\r\n}\r\nif (dwmac->clk && freq)\r\nclk_set_rate(dwmac->clk, freq);\r\nregmap_update_bits(dwmac->regmap, reg, STID127_RETIME_SRC_MASK, val);\r\n}\r\nstatic void sti_dwmac_ctrl_init(struct sti_dwmac *dwmac)\r\n{\r\nstruct regmap *regmap = dwmac->regmap;\r\nint iface = dwmac->interface;\r\nstruct device *dev = dwmac->dev;\r\nstruct device_node *np = dev->of_node;\r\nu32 reg = dwmac->ctrl_reg;\r\nu32 val;\r\nif (dwmac->clk)\r\nclk_prepare_enable(dwmac->clk);\r\nif (of_property_read_bool(np, "st,gmac_en"))\r\nregmap_update_bits(regmap, reg, EN_MASK, EN);\r\nregmap_update_bits(regmap, reg, MII_PHY_SEL_MASK, phy_intf_sels[iface]);\r\nval = (iface == PHY_INTERFACE_MODE_REVMII) ? 0 : ENMII;\r\nregmap_update_bits(regmap, reg, ENMII_MASK, val);\r\n}\r\nstatic int stix4xx_init(struct platform_device *pdev, void *priv)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nu32 spd = dwmac->speed;\r\nsti_dwmac_ctrl_init(dwmac);\r\nstih4xx_fix_retime_src(priv, spd);\r\nreturn 0;\r\n}\r\nstatic int stid127_init(struct platform_device *pdev, void *priv)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nu32 spd = dwmac->speed;\r\nsti_dwmac_ctrl_init(dwmac);\r\nstid127_fix_retime_src(priv, spd);\r\nreturn 0;\r\n}\r\nstatic void sti_dwmac_exit(struct platform_device *pdev, void *priv)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nif (dwmac->clk)\r\nclk_disable_unprepare(dwmac->clk);\r\n}\r\nstatic int sti_dwmac_parse_data(struct sti_dwmac *dwmac,\r\nstruct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct regmap *regmap;\r\nint err;\r\nif (!np)\r\nreturn -EINVAL;\r\ndwmac->clk_sel_reg = -ENXIO;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "sti-clkconf");\r\nif (res)\r\ndwmac->clk_sel_reg = res->start;\r\nregmap = syscon_regmap_lookup_by_phandle(np, "st,syscon");\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nerr = of_property_read_u32_index(np, "st,syscon", 1, &dwmac->ctrl_reg);\r\nif (err) {\r\ndev_err(dev, "Can't get sysconfig ctrl offset (%d)\n", err);\r\nreturn err;\r\n}\r\ndwmac->dev = dev;\r\ndwmac->interface = of_get_phy_mode(np);\r\ndwmac->regmap = regmap;\r\ndwmac->ext_phyclk = of_property_read_bool(np, "st,ext-phyclk");\r\ndwmac->tx_retime_src = TX_RETIME_SRC_NA;\r\ndwmac->speed = SPEED_100;\r\nif (IS_PHY_IF_MODE_GBIT(dwmac->interface)) {\r\nconst char *rs;\r\nerr = of_property_read_string(np, "st,tx-retime-src", &rs);\r\nif (err < 0) {\r\ndev_warn(dev, "Use internal clock source\n");\r\ndwmac->tx_retime_src = TX_RETIME_SRC_CLKGEN;\r\n} else if (!strcasecmp(rs, "clk_125")) {\r\ndwmac->tx_retime_src = TX_RETIME_SRC_CLK_125;\r\n} else if (!strcasecmp(rs, "txclk")) {\r\ndwmac->tx_retime_src = TX_RETIME_SRC_TXCLK;\r\n}\r\ndwmac->speed = SPEED_1000;\r\n}\r\ndwmac->clk = devm_clk_get(dev, "sti-ethclk");\r\nif (IS_ERR(dwmac->clk)) {\r\ndev_warn(dev, "No phy clock provided...\n");\r\ndwmac->clk = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void *sti_dwmac_setup(struct platform_device *pdev)\r\n{\r\nstruct sti_dwmac *dwmac;\r\nint ret;\r\ndwmac = devm_kzalloc(&pdev->dev, sizeof(*dwmac), GFP_KERNEL);\r\nif (!dwmac)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = sti_dwmac_parse_data(dwmac, pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Unable to parse OF data\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn dwmac;\r\n}

static inline struct xgene_gpio *to_xgene_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct xgene_gpio, chip);\r\n}\r\nstatic int xgene_gpio_get(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct xgene_gpio *chip = to_xgene_gpio(gc);\r\nunsigned long bank_offset;\r\nu32 bit_offset;\r\nbank_offset = GPIO_DATA_OFFSET + GPIO_BANK_OFFSET(offset);\r\nbit_offset = GPIO_BIT_OFFSET(offset);\r\nreturn !!(ioread32(chip->base + bank_offset) & BIT(bit_offset));\r\n}\r\nstatic void __xgene_gpio_set(struct gpio_chip *gc, unsigned int offset, int val)\r\n{\r\nstruct xgene_gpio *chip = to_xgene_gpio(gc);\r\nunsigned long bank_offset;\r\nu32 setval, bit_offset;\r\nbank_offset = GPIO_SET_DR_OFFSET + GPIO_BANK_OFFSET(offset);\r\nbit_offset = GPIO_BIT_OFFSET(offset) + XGENE_GPIOS_PER_BANK;\r\nsetval = ioread32(chip->base + bank_offset);\r\nif (val)\r\nsetval |= BIT(bit_offset);\r\nelse\r\nsetval &= ~BIT(bit_offset);\r\niowrite32(setval, chip->base + bank_offset);\r\n}\r\nstatic void xgene_gpio_set(struct gpio_chip *gc, unsigned int offset, int val)\r\n{\r\nstruct xgene_gpio *chip = to_xgene_gpio(gc);\r\nunsigned long flags;\r\nspin_lock_irqsave(&chip->lock, flags);\r\n__xgene_gpio_set(gc, offset, val);\r\nspin_unlock_irqrestore(&chip->lock, flags);\r\n}\r\nstatic int xgene_gpio_dir_in(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct xgene_gpio *chip = to_xgene_gpio(gc);\r\nunsigned long flags, bank_offset;\r\nu32 dirval, bit_offset;\r\nbank_offset = GPIO_SET_DR_OFFSET + GPIO_BANK_OFFSET(offset);\r\nbit_offset = GPIO_BIT_OFFSET(offset);\r\nspin_lock_irqsave(&chip->lock, flags);\r\ndirval = ioread32(chip->base + bank_offset);\r\ndirval |= BIT(bit_offset);\r\niowrite32(dirval, chip->base + bank_offset);\r\nspin_unlock_irqrestore(&chip->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int xgene_gpio_dir_out(struct gpio_chip *gc,\r\nunsigned int offset, int val)\r\n{\r\nstruct xgene_gpio *chip = to_xgene_gpio(gc);\r\nunsigned long flags, bank_offset;\r\nu32 dirval, bit_offset;\r\nbank_offset = GPIO_SET_DR_OFFSET + GPIO_BANK_OFFSET(offset);\r\nbit_offset = GPIO_BIT_OFFSET(offset);\r\nspin_lock_irqsave(&chip->lock, flags);\r\ndirval = ioread32(chip->base + bank_offset);\r\ndirval &= ~BIT(bit_offset);\r\niowrite32(dirval, chip->base + bank_offset);\r\n__xgene_gpio_set(gc, offset, val);\r\nspin_unlock_irqrestore(&chip->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int xgene_gpio_suspend(struct device *dev)\r\n{\r\nstruct xgene_gpio *gpio = dev_get_drvdata(dev);\r\nunsigned long bank_offset;\r\nunsigned int bank;\r\nfor (bank = 0; bank < XGENE_MAX_GPIO_BANKS; bank++) {\r\nbank_offset = GPIO_SET_DR_OFFSET + bank * GPIO_BANK_STRIDE;\r\ngpio->set_dr_val[bank] = ioread32(gpio->base + bank_offset);\r\n}\r\nreturn 0;\r\n}\r\nstatic int xgene_gpio_resume(struct device *dev)\r\n{\r\nstruct xgene_gpio *gpio = dev_get_drvdata(dev);\r\nunsigned long bank_offset;\r\nunsigned int bank;\r\nfor (bank = 0; bank < XGENE_MAX_GPIO_BANKS; bank++) {\r\nbank_offset = GPIO_SET_DR_OFFSET + bank * GPIO_BANK_STRIDE;\r\niowrite32(gpio->set_dr_val[bank], gpio->base + bank_offset);\r\n}\r\nreturn 0;\r\n}\r\nstatic int xgene_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct xgene_gpio *gpio;\r\nint err = 0;\r\ngpio = devm_kzalloc(&pdev->dev, sizeof(*gpio), GFP_KERNEL);\r\nif (!gpio) {\r\nerr = -ENOMEM;\r\ngoto err;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ngpio->base = devm_ioremap_nocache(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!gpio->base) {\r\nerr = -ENOMEM;\r\ngoto err;\r\n}\r\ngpio->chip.ngpio = XGENE_MAX_GPIOS;\r\nspin_lock_init(&gpio->lock);\r\ngpio->chip.dev = &pdev->dev;\r\ngpio->chip.direction_input = xgene_gpio_dir_in;\r\ngpio->chip.direction_output = xgene_gpio_dir_out;\r\ngpio->chip.get = xgene_gpio_get;\r\ngpio->chip.set = xgene_gpio_set;\r\ngpio->chip.label = dev_name(&pdev->dev);\r\ngpio->chip.base = -1;\r\nplatform_set_drvdata(pdev, gpio);\r\nerr = gpiochip_add(&gpio->chip);\r\nif (err) {\r\ndev_err(&pdev->dev,\r\n"failed to register gpiochip.\n");\r\ngoto err;\r\n}\r\ndev_info(&pdev->dev, "X-Gene GPIO driver registered.\n");\r\nreturn 0;\r\nerr:\r\ndev_err(&pdev->dev, "X-Gene GPIO driver registration failed.\n");\r\nreturn err;\r\n}\r\nstatic int xgene_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct xgene_gpio *gpio = platform_get_drvdata(pdev);\r\ngpiochip_remove(&gpio->chip);\r\nreturn 0;\r\n}

static const char *dwc2_op_state_str(struct dwc2_hsotg *hsotg)\r\n{\r\nswitch (hsotg->op_state) {\r\ncase OTG_STATE_A_HOST:\r\nreturn "a_host";\r\ncase OTG_STATE_A_SUSPEND:\r\nreturn "a_suspend";\r\ncase OTG_STATE_A_PERIPHERAL:\r\nreturn "a_peripheral";\r\ncase OTG_STATE_B_PERIPHERAL:\r\nreturn "b_peripheral";\r\ncase OTG_STATE_B_HOST:\r\nreturn "b_host";\r\ndefault:\r\nreturn "unknown";\r\n}\r\n}\r\nstatic void dwc2_handle_usb_port_intr(struct dwc2_hsotg *hsotg)\r\n{\r\nu32 hprt0 = readl(hsotg->regs + HPRT0);\r\nif (hprt0 & HPRT0_ENACHG) {\r\nhprt0 &= ~HPRT0_ENA;\r\nwritel(hprt0, hsotg->regs + HPRT0);\r\n}\r\nwritel(GINTSTS_PRTINT, hsotg->regs + GINTSTS);\r\n}\r\nstatic void dwc2_handle_mode_mismatch_intr(struct dwc2_hsotg *hsotg)\r\n{\r\ndev_warn(hsotg->dev, "Mode Mismatch Interrupt: currently in %s mode\n",\r\ndwc2_is_host_mode(hsotg) ? "Host" : "Device");\r\nwritel(GINTSTS_MODEMIS, hsotg->regs + GINTSTS);\r\n}\r\nstatic void dwc2_handle_otg_intr(struct dwc2_hsotg *hsotg)\r\n{\r\nu32 gotgint;\r\nu32 gotgctl;\r\nu32 gintmsk;\r\ngotgint = readl(hsotg->regs + GOTGINT);\r\ngotgctl = readl(hsotg->regs + GOTGCTL);\r\ndev_dbg(hsotg->dev, "++OTG Interrupt gotgint=%0x [%s]\n", gotgint,\r\ndwc2_op_state_str(hsotg));\r\nif (gotgint & GOTGINT_SES_END_DET) {\r\ndev_dbg(hsotg->dev,\r\n" ++OTG Interrupt: Session End Detected++ (%s)\n",\r\ndwc2_op_state_str(hsotg));\r\ngotgctl = readl(hsotg->regs + GOTGCTL);\r\nif (dwc2_is_device_mode(hsotg))\r\ns3c_hsotg_disconnect(hsotg);\r\nif (hsotg->op_state == OTG_STATE_B_HOST) {\r\nhsotg->op_state = OTG_STATE_B_PERIPHERAL;\r\n} else {\r\nif (gotgctl & GOTGCTL_DEVHNPEN) {\r\ndev_dbg(hsotg->dev, "Session End Detected\n");\r\ndev_err(hsotg->dev,\r\n"Device Not Connected/Responding!\n");\r\n}\r\nhsotg->lx_state = DWC2_L0;\r\n}\r\ngotgctl = readl(hsotg->regs + GOTGCTL);\r\ngotgctl &= ~GOTGCTL_DEVHNPEN;\r\nwritel(gotgctl, hsotg->regs + GOTGCTL);\r\n}\r\nif (gotgint & GOTGINT_SES_REQ_SUC_STS_CHNG) {\r\ndev_dbg(hsotg->dev,\r\n" ++OTG Interrupt: Session Request Success Status Change++\n");\r\ngotgctl = readl(hsotg->regs + GOTGCTL);\r\nif (gotgctl & GOTGCTL_SESREQSCS) {\r\nif (hsotg->core_params->phy_type ==\r\nDWC2_PHY_TYPE_PARAM_FS\r\n&& hsotg->core_params->i2c_enable > 0) {\r\nhsotg->srp_success = 1;\r\n} else {\r\ngotgctl = readl(hsotg->regs + GOTGCTL);\r\ngotgctl &= ~GOTGCTL_SESREQ;\r\nwritel(gotgctl, hsotg->regs + GOTGCTL);\r\n}\r\n}\r\n}\r\nif (gotgint & GOTGINT_HST_NEG_SUC_STS_CHNG) {\r\ngotgctl = readl(hsotg->regs + GOTGCTL);\r\nif (hsotg->hw_params.snpsid >= DWC2_CORE_REV_3_00a)\r\nudelay(100);\r\nif (gotgctl & GOTGCTL_HSTNEGSCS) {\r\nif (dwc2_is_host_mode(hsotg)) {\r\nhsotg->op_state = OTG_STATE_B_HOST;\r\ngintmsk = readl(hsotg->regs + GINTMSK);\r\ngintmsk &= ~GINTSTS_SOF;\r\nwritel(gintmsk, hsotg->regs + GINTMSK);\r\nspin_unlock(&hsotg->lock);\r\ndwc2_hcd_start(hsotg);\r\nspin_lock(&hsotg->lock);\r\nhsotg->op_state = OTG_STATE_B_HOST;\r\n}\r\n} else {\r\ngotgctl = readl(hsotg->regs + GOTGCTL);\r\ngotgctl &= ~(GOTGCTL_HNPREQ | GOTGCTL_DEVHNPEN);\r\nwritel(gotgctl, hsotg->regs + GOTGCTL);\r\ndev_dbg(hsotg->dev, "HNP Failed\n");\r\ndev_err(hsotg->dev,\r\n"Device Not Connected/Responding\n");\r\n}\r\n}\r\nif (gotgint & GOTGINT_HST_NEG_DET) {\r\ndev_dbg(hsotg->dev,\r\n" ++OTG Interrupt: Host Negotiation Detected++ (%s)\n",\r\n(dwc2_is_host_mode(hsotg) ? "Host" : "Device"));\r\nif (dwc2_is_device_mode(hsotg)) {\r\ndev_dbg(hsotg->dev, "a_suspend->a_peripheral (%d)\n",\r\nhsotg->op_state);\r\nspin_unlock(&hsotg->lock);\r\ndwc2_hcd_disconnect(hsotg);\r\nspin_lock(&hsotg->lock);\r\nhsotg->op_state = OTG_STATE_A_PERIPHERAL;\r\n} else {\r\ngintmsk = readl(hsotg->regs + GINTMSK);\r\ngintmsk &= ~GINTSTS_SOF;\r\nwritel(gintmsk, hsotg->regs + GINTMSK);\r\nspin_unlock(&hsotg->lock);\r\ndwc2_hcd_start(hsotg);\r\nspin_lock(&hsotg->lock);\r\nhsotg->op_state = OTG_STATE_A_HOST;\r\n}\r\n}\r\nif (gotgint & GOTGINT_A_DEV_TOUT_CHG)\r\ndev_dbg(hsotg->dev,\r\n" ++OTG Interrupt: A-Device Timeout Change++\n");\r\nif (gotgint & GOTGINT_DBNCE_DONE)\r\ndev_dbg(hsotg->dev, " ++OTG Interrupt: Debounce Done++\n");\r\nwritel(gotgint, hsotg->regs + GOTGINT);\r\n}\r\nstatic void dwc2_handle_conn_id_status_change_intr(struct dwc2_hsotg *hsotg)\r\n{\r\nu32 gintmsk = readl(hsotg->regs + GINTMSK);\r\ngintmsk &= ~GINTSTS_SOF;\r\nwritel(gintmsk, hsotg->regs + GINTMSK);\r\ndev_dbg(hsotg->dev, " ++Connector ID Status Change Interrupt++ (%s)\n",\r\ndwc2_is_host_mode(hsotg) ? "Host" : "Device");\r\nif (hsotg->wq_otg) {\r\nspin_unlock(&hsotg->lock);\r\nqueue_work(hsotg->wq_otg, &hsotg->wf_otg);\r\nspin_lock(&hsotg->lock);\r\n}\r\nwritel(GINTSTS_CONIDSTSCHNG, hsotg->regs + GINTSTS);\r\n}\r\nstatic void dwc2_handle_session_req_intr(struct dwc2_hsotg *hsotg)\r\n{\r\ndev_dbg(hsotg->dev, "++Session Request Interrupt++\n");\r\nwritel(GINTSTS_SESSREQINT, hsotg->regs + GINTSTS);\r\nif (dwc2_is_device_mode(hsotg))\r\ns3c_hsotg_disconnect(hsotg);\r\n}\r\nstatic void dwc2_handle_wakeup_detected_intr(struct dwc2_hsotg *hsotg)\r\n{\r\ndev_dbg(hsotg->dev, "++Resume or Remote Wakeup Detected Interrupt++\n");\r\ndev_dbg(hsotg->dev, "%s lxstate = %d\n", __func__, hsotg->lx_state);\r\nif (dwc2_is_device_mode(hsotg)) {\r\ndev_dbg(hsotg->dev, "DSTS=0x%0x\n", readl(hsotg->regs + DSTS));\r\nif (hsotg->lx_state == DWC2_L2) {\r\nu32 dctl = readl(hsotg->regs + DCTL);\r\ndctl &= ~DCTL_RMTWKUPSIG;\r\nwritel(dctl, hsotg->regs + DCTL);\r\n}\r\nhsotg->lx_state = DWC2_L0;\r\n} else {\r\nif (hsotg->lx_state != DWC2_L1) {\r\nu32 pcgcctl = readl(hsotg->regs + PCGCTL);\r\npcgcctl &= ~PCGCTL_STOPPCLK;\r\nwritel(pcgcctl, hsotg->regs + PCGCTL);\r\nmod_timer(&hsotg->wkp_timer,\r\njiffies + msecs_to_jiffies(71));\r\n} else {\r\nhsotg->lx_state = DWC2_L0;\r\n}\r\n}\r\nwritel(GINTSTS_WKUPINT, hsotg->regs + GINTSTS);\r\n}\r\nstatic void dwc2_handle_disconnect_intr(struct dwc2_hsotg *hsotg)\r\n{\r\ndev_dbg(hsotg->dev, "++Disconnect Detected Interrupt++ (%s) %s\n",\r\ndwc2_is_host_mode(hsotg) ? "Host" : "Device",\r\ndwc2_op_state_str(hsotg));\r\nif (hsotg->op_state == OTG_STATE_A_HOST)\r\ndwc2_hcd_disconnect(hsotg);\r\nhsotg->lx_state = DWC2_L3;\r\nwritel(GINTSTS_DISCONNINT, hsotg->regs + GINTSTS);\r\n}\r\nstatic void dwc2_handle_usb_suspend_intr(struct dwc2_hsotg *hsotg)\r\n{\r\nu32 dsts;\r\ndev_dbg(hsotg->dev, "USB SUSPEND\n");\r\nif (dwc2_is_device_mode(hsotg)) {\r\ndsts = readl(hsotg->regs + DSTS);\r\ndev_dbg(hsotg->dev, "DSTS=0x%0x\n", dsts);\r\ndev_dbg(hsotg->dev,\r\n"DSTS.Suspend Status=%d HWCFG4.Power Optimize=%d\n",\r\n!!(dsts & DSTS_SUSPSTS),\r\nhsotg->hw_params.power_optimized);\r\n} else {\r\nif (hsotg->op_state == OTG_STATE_A_PERIPHERAL) {\r\ndev_dbg(hsotg->dev, "a_peripheral->a_host\n");\r\nspin_unlock(&hsotg->lock);\r\ndwc2_hcd_start(hsotg);\r\nspin_lock(&hsotg->lock);\r\nhsotg->op_state = OTG_STATE_A_HOST;\r\n}\r\n}\r\nhsotg->lx_state = DWC2_L2;\r\nwritel(GINTSTS_USBSUSP, hsotg->regs + GINTSTS);\r\n}\r\nstatic u32 dwc2_read_common_intr(struct dwc2_hsotg *hsotg)\r\n{\r\nu32 gintsts;\r\nu32 gintmsk;\r\nu32 gahbcfg;\r\nu32 gintmsk_common = GINTMSK_COMMON;\r\ngintsts = readl(hsotg->regs + GINTSTS);\r\ngintmsk = readl(hsotg->regs + GINTMSK);\r\ngahbcfg = readl(hsotg->regs + GAHBCFG);\r\nif (gintsts & gintmsk_common)\r\ndev_dbg(hsotg->dev, "gintsts=%08x gintmsk=%08x\n",\r\ngintsts, gintmsk);\r\nif (gahbcfg & GAHBCFG_GLBL_INTR_EN)\r\nreturn gintsts & gintmsk & gintmsk_common;\r\nelse\r\nreturn 0;\r\n}\r\nirqreturn_t dwc2_handle_common_intr(int irq, void *dev)\r\n{\r\nstruct dwc2_hsotg *hsotg = dev;\r\nu32 gintsts;\r\nirqreturn_t retval = IRQ_NONE;\r\nspin_lock(&hsotg->lock);\r\nif (!dwc2_is_controller_alive(hsotg)) {\r\ndev_warn(hsotg->dev, "Controller is dead\n");\r\ngoto out;\r\n}\r\ngintsts = dwc2_read_common_intr(hsotg);\r\nif (gintsts & ~GINTSTS_PRTINT)\r\nretval = IRQ_HANDLED;\r\nif (gintsts & GINTSTS_MODEMIS)\r\ndwc2_handle_mode_mismatch_intr(hsotg);\r\nif (gintsts & GINTSTS_OTGINT)\r\ndwc2_handle_otg_intr(hsotg);\r\nif (gintsts & GINTSTS_CONIDSTSCHNG)\r\ndwc2_handle_conn_id_status_change_intr(hsotg);\r\nif (gintsts & GINTSTS_DISCONNINT)\r\ndwc2_handle_disconnect_intr(hsotg);\r\nif (gintsts & GINTSTS_SESSREQINT)\r\ndwc2_handle_session_req_intr(hsotg);\r\nif (gintsts & GINTSTS_WKUPINT)\r\ndwc2_handle_wakeup_detected_intr(hsotg);\r\nif (gintsts & GINTSTS_USBSUSP)\r\ndwc2_handle_usb_suspend_intr(hsotg);\r\nif (gintsts & GINTSTS_PRTINT) {\r\nif (dwc2_is_device_mode(hsotg)) {\r\ndev_dbg(hsotg->dev,\r\n" --Port interrupt received in Device mode--\n");\r\ndwc2_handle_usb_port_intr(hsotg);\r\nretval = IRQ_HANDLED;\r\n}\r\n}\r\nout:\r\nspin_unlock(&hsotg->lock);\r\nreturn retval;\r\n}

static int adau1761_dejitter_fixup(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct adau *adau = snd_soc_codec_get_drvdata(codec);\r\nregmap_write(adau->regmap, ADAU1761_DEJITTER, 0);\r\nif (!adau->master)\r\nregmap_write(adau->regmap, ADAU1761_DEJITTER, 3);\r\nreturn 0;\r\n}\r\nstatic int adau1761_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct adau *adau = snd_soc_codec_get_drvdata(codec);\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nbreak;\r\ncase SND_SOC_BIAS_PREPARE:\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nregmap_update_bits(adau->regmap, ADAU17X1_CLOCK_CONTROL,\r\nADAU17X1_CLOCK_CONTROL_SYSCLK_EN,\r\nADAU17X1_CLOCK_CONTROL_SYSCLK_EN);\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nregmap_update_bits(adau->regmap, ADAU17X1_CLOCK_CONTROL,\r\nADAU17X1_CLOCK_CONTROL_SYSCLK_EN, 0);\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic enum adau1761_output_mode adau1761_get_lineout_mode(\r\nstruct snd_soc_codec *codec)\r\n{\r\nstruct adau1761_platform_data *pdata = codec->dev->platform_data;\r\nif (pdata)\r\nreturn pdata->lineout_mode;\r\nreturn ADAU1761_OUTPUT_MODE_LINE;\r\n}\r\nstatic int adau1761_setup_digmic_jackdetect(struct snd_soc_codec *codec)\r\n{\r\nstruct adau1761_platform_data *pdata = codec->dev->platform_data;\r\nstruct adau *adau = snd_soc_codec_get_drvdata(codec);\r\nenum adau1761_digmic_jackdet_pin_mode mode;\r\nunsigned int val = 0;\r\nint ret;\r\nif (pdata)\r\nmode = pdata->digmic_jackdetect_pin_mode;\r\nelse\r\nmode = ADAU1761_DIGMIC_JACKDET_PIN_MODE_NONE;\r\nswitch (mode) {\r\ncase ADAU1761_DIGMIC_JACKDET_PIN_MODE_JACKDETECT:\r\nswitch (pdata->jackdetect_debounce_time) {\r\ncase ADAU1761_JACKDETECT_DEBOUNCE_5MS:\r\ncase ADAU1761_JACKDETECT_DEBOUNCE_10MS:\r\ncase ADAU1761_JACKDETECT_DEBOUNCE_20MS:\r\ncase ADAU1761_JACKDETECT_DEBOUNCE_40MS:\r\nval |= pdata->jackdetect_debounce_time << 6;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (pdata->jackdetect_active_low)\r\nval |= ADAU1761_DIGMIC_JACKDETECT_ACTIVE_LOW;\r\nret = snd_soc_add_codec_controls(codec,\r\nadau1761_jack_detect_controls,\r\nARRAY_SIZE(adau1761_jack_detect_controls));\r\nif (ret)\r\nreturn ret;\r\ncase ADAU1761_DIGMIC_JACKDET_PIN_MODE_NONE:\r\nret = snd_soc_dapm_add_routes(&codec->dapm,\r\nadau1761_no_dmic_routes,\r\nARRAY_SIZE(adau1761_no_dmic_routes));\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase ADAU1761_DIGMIC_JACKDET_PIN_MODE_DIGMIC:\r\nret = snd_soc_dapm_new_controls(&codec->dapm,\r\nadau1761_dmic_widgets,\r\nARRAY_SIZE(adau1761_dmic_widgets));\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dapm_add_routes(&codec->dapm,\r\nadau1761_dmic_routes,\r\nARRAY_SIZE(adau1761_dmic_routes));\r\nif (ret)\r\nreturn ret;\r\nval |= ADAU1761_DIGMIC_JACKDETECT_DIGMIC;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_write(adau->regmap, ADAU1761_DIGMIC_JACKDETECT, val);\r\nreturn 0;\r\n}\r\nstatic int adau1761_setup_headphone_mode(struct snd_soc_codec *codec)\r\n{\r\nstruct adau *adau = snd_soc_codec_get_drvdata(codec);\r\nstruct adau1761_platform_data *pdata = codec->dev->platform_data;\r\nenum adau1761_output_mode mode;\r\nint ret;\r\nif (pdata)\r\nmode = pdata->headphone_mode;\r\nelse\r\nmode = ADAU1761_OUTPUT_MODE_HEADPHONE;\r\nswitch (mode) {\r\ncase ADAU1761_OUTPUT_MODE_LINE:\r\nbreak;\r\ncase ADAU1761_OUTPUT_MODE_HEADPHONE_CAPLESS:\r\nregmap_update_bits(adau->regmap, ADAU1761_PLAY_MONO_OUTPUT_VOL,\r\nADAU1761_PLAY_MONO_OUTPUT_VOL_MODE_HP |\r\nADAU1761_PLAY_MONO_OUTPUT_VOL_UNMUTE,\r\nADAU1761_PLAY_MONO_OUTPUT_VOL_MODE_HP |\r\nADAU1761_PLAY_MONO_OUTPUT_VOL_UNMUTE);\r\ncase ADAU1761_OUTPUT_MODE_HEADPHONE:\r\nregmap_update_bits(adau->regmap, ADAU1761_PLAY_HP_RIGHT_VOL,\r\nADAU1761_PLAY_HP_RIGHT_VOL_MODE_HP,\r\nADAU1761_PLAY_HP_RIGHT_VOL_MODE_HP);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (mode == ADAU1761_OUTPUT_MODE_HEADPHONE_CAPLESS) {\r\nret = snd_soc_dapm_new_controls(&codec->dapm,\r\nadau1761_capless_dapm_widgets,\r\nARRAY_SIZE(adau1761_capless_dapm_widgets));\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dapm_add_routes(&codec->dapm,\r\nadau1761_capless_dapm_routes,\r\nARRAY_SIZE(adau1761_capless_dapm_routes));\r\n} else {\r\nret = snd_soc_add_codec_controls(codec, adau1761_mono_controls,\r\nARRAY_SIZE(adau1761_mono_controls));\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dapm_new_controls(&codec->dapm,\r\nadau1761_mono_dapm_widgets,\r\nARRAY_SIZE(adau1761_mono_dapm_widgets));\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dapm_add_routes(&codec->dapm,\r\nadau1761_mono_dapm_routes,\r\nARRAY_SIZE(adau1761_mono_dapm_routes));\r\n}\r\nreturn ret;\r\n}\r\nstatic bool adau1761_readable_register(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase ADAU1761_DIGMIC_JACKDETECT:\r\ncase ADAU1761_REC_MIXER_LEFT0:\r\ncase ADAU1761_REC_MIXER_LEFT1:\r\ncase ADAU1761_REC_MIXER_RIGHT0:\r\ncase ADAU1761_REC_MIXER_RIGHT1:\r\ncase ADAU1761_LEFT_DIFF_INPUT_VOL:\r\ncase ADAU1761_RIGHT_DIFF_INPUT_VOL:\r\ncase ADAU1761_PLAY_LR_MIXER_LEFT:\r\ncase ADAU1761_PLAY_MIXER_LEFT0:\r\ncase ADAU1761_PLAY_MIXER_LEFT1:\r\ncase ADAU1761_PLAY_MIXER_RIGHT0:\r\ncase ADAU1761_PLAY_MIXER_RIGHT1:\r\ncase ADAU1761_PLAY_LR_MIXER_RIGHT:\r\ncase ADAU1761_PLAY_MIXER_MONO:\r\ncase ADAU1761_PLAY_HP_LEFT_VOL:\r\ncase ADAU1761_PLAY_HP_RIGHT_VOL:\r\ncase ADAU1761_PLAY_LINE_LEFT_VOL:\r\ncase ADAU1761_PLAY_LINE_RIGHT_VOL:\r\ncase ADAU1761_PLAY_MONO_OUTPUT_VOL:\r\ncase ADAU1761_POP_CLICK_SUPPRESS:\r\ncase ADAU1761_JACK_DETECT_PIN:\r\ncase ADAU1761_DEJITTER:\r\ncase ADAU1761_CLK_ENABLE0:\r\ncase ADAU1761_CLK_ENABLE1:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n}\r\nreturn adau17x1_readable_register(dev, reg);\r\n}\r\nstatic int adau1761_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct adau1761_platform_data *pdata = codec->dev->platform_data;\r\nstruct adau *adau = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\nret = adau17x1_add_widgets(codec);\r\nif (ret < 0)\r\nreturn ret;\r\nif (pdata && pdata->input_differential) {\r\nregmap_update_bits(adau->regmap, ADAU1761_LEFT_DIFF_INPUT_VOL,\r\nADAU1761_DIFF_INPUT_VOL_LDEN,\r\nADAU1761_DIFF_INPUT_VOL_LDEN);\r\nregmap_update_bits(adau->regmap, ADAU1761_RIGHT_DIFF_INPUT_VOL,\r\nADAU1761_DIFF_INPUT_VOL_LDEN,\r\nADAU1761_DIFF_INPUT_VOL_LDEN);\r\nret = snd_soc_add_codec_controls(codec,\r\nadau1761_differential_mode_controls,\r\nARRAY_SIZE(adau1761_differential_mode_controls));\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nret = snd_soc_add_codec_controls(codec,\r\nadau1761_single_mode_controls,\r\nARRAY_SIZE(adau1761_single_mode_controls));\r\nif (ret)\r\nreturn ret;\r\n}\r\nswitch (adau1761_get_lineout_mode(codec)) {\r\ncase ADAU1761_OUTPUT_MODE_LINE:\r\nbreak;\r\ncase ADAU1761_OUTPUT_MODE_HEADPHONE:\r\nregmap_update_bits(adau->regmap, ADAU1761_PLAY_LINE_LEFT_VOL,\r\nADAU1761_PLAY_LINE_LEFT_VOL_MODE_HP,\r\nADAU1761_PLAY_LINE_LEFT_VOL_MODE_HP);\r\nregmap_update_bits(adau->regmap, ADAU1761_PLAY_LINE_RIGHT_VOL,\r\nADAU1761_PLAY_LINE_RIGHT_VOL_MODE_HP,\r\nADAU1761_PLAY_LINE_RIGHT_VOL_MODE_HP);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = adau1761_setup_headphone_mode(codec);\r\nif (ret)\r\nreturn ret;\r\nret = adau1761_setup_digmic_jackdetect(codec);\r\nif (ret)\r\nreturn ret;\r\nif (adau->type == ADAU1761) {\r\nret = snd_soc_dapm_new_controls(&codec->dapm,\r\nadau1761_dapm_widgets,\r\nARRAY_SIZE(adau1761_dapm_widgets));\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dapm_add_routes(&codec->dapm,\r\nadau1761_dapm_routes,\r\nARRAY_SIZE(adau1761_dapm_routes));\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = adau17x1_add_routes(codec);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint adau1761_probe(struct device *dev, struct regmap *regmap,\r\nenum adau17x1_type type, void (*switch_mode)(struct device *dev))\r\n{\r\nstruct snd_soc_dai_driver *dai_drv;\r\nconst char *firmware_name;\r\nint ret;\r\nif (type == ADAU1361) {\r\ndai_drv = &adau1361_dai_driver;\r\nfirmware_name = NULL;\r\n} else {\r\ndai_drv = &adau1761_dai_driver;\r\nfirmware_name = ADAU1761_FIRMWARE;\r\n}\r\nret = adau17x1_probe(dev, regmap, type, switch_mode, firmware_name);\r\nif (ret)\r\nreturn ret;\r\nreturn snd_soc_register_codec(dev, &adau1761_codec_driver, dai_drv, 1);\r\n}

static phandle __prom_getchild(phandle node)\r\n{\r\nunsigned long flags;\r\nphandle cnode;\r\nspin_lock_irqsave(&prom_lock, flags);\r\ncnode = prom_nodeops->no_child(node);\r\nrestore_current();\r\nspin_unlock_irqrestore(&prom_lock, flags);\r\nreturn cnode;\r\n}\r\nphandle prom_getchild(phandle node)\r\n{\r\nphandle cnode;\r\nif ((s32)node == -1)\r\nreturn 0;\r\ncnode = __prom_getchild(node);\r\nif (cnode == 0 || (s32)cnode == -1)\r\nreturn 0;\r\nreturn cnode;\r\n}\r\nstatic phandle __prom_getsibling(phandle node)\r\n{\r\nunsigned long flags;\r\nphandle cnode;\r\nspin_lock_irqsave(&prom_lock, flags);\r\ncnode = prom_nodeops->no_nextnode(node);\r\nrestore_current();\r\nspin_unlock_irqrestore(&prom_lock, flags);\r\nreturn cnode;\r\n}\r\nphandle prom_getsibling(phandle node)\r\n{\r\nphandle sibnode;\r\nif ((s32)node == -1)\r\nreturn 0;\r\nsibnode = __prom_getsibling(node);\r\nif (sibnode == 0 || (s32)sibnode == -1)\r\nreturn 0;\r\nreturn sibnode;\r\n}\r\nint prom_getproplen(phandle node, const char *prop)\r\n{\r\nint ret;\r\nunsigned long flags;\r\nif((!node) || (!prop))\r\nreturn -1;\r\nspin_lock_irqsave(&prom_lock, flags);\r\nret = prom_nodeops->no_proplen(node, prop);\r\nrestore_current();\r\nspin_unlock_irqrestore(&prom_lock, flags);\r\nreturn ret;\r\n}\r\nint prom_getproperty(phandle node, const char *prop, char *buffer, int bufsize)\r\n{\r\nint plen, ret;\r\nunsigned long flags;\r\nplen = prom_getproplen(node, prop);\r\nif((plen > bufsize) || (plen == 0) || (plen == -1))\r\nreturn -1;\r\nspin_lock_irqsave(&prom_lock, flags);\r\nret = prom_nodeops->no_getprop(node, prop, buffer);\r\nrestore_current();\r\nspin_unlock_irqrestore(&prom_lock, flags);\r\nreturn ret;\r\n}\r\nint prom_getint(phandle node, char *prop)\r\n{\r\nstatic int intprop;\r\nif(prom_getproperty(node, prop, (char *) &intprop, sizeof(int)) != -1)\r\nreturn intprop;\r\nreturn -1;\r\n}\r\nint prom_getintdefault(phandle node, char *property, int deflt)\r\n{\r\nint retval;\r\nretval = prom_getint(node, property);\r\nif(retval == -1) return deflt;\r\nreturn retval;\r\n}\r\nint prom_getbool(phandle node, char *prop)\r\n{\r\nint retval;\r\nretval = prom_getproplen(node, prop);\r\nif(retval == -1) return 0;\r\nreturn 1;\r\n}\r\nvoid prom_getstring(phandle node, char *prop, char *user_buf, int ubuf_size)\r\n{\r\nint len;\r\nlen = prom_getproperty(node, prop, user_buf, ubuf_size);\r\nif(len != -1) return;\r\nuser_buf[0] = 0;\r\n}\r\nphandle prom_searchsiblings(phandle node_start, char *nodename)\r\n{\r\nphandle thisnode;\r\nint error;\r\nfor(thisnode = node_start; thisnode;\r\nthisnode=prom_getsibling(thisnode)) {\r\nerror = prom_getproperty(thisnode, "name", promlib_buf,\r\nsizeof(promlib_buf));\r\nif(error == -1) continue;\r\nif(strcmp(nodename, promlib_buf)==0) return thisnode;\r\n}\r\nreturn 0;\r\n}\r\nstatic char *__prom_nextprop(phandle node, char * oprop)\r\n{\r\nunsigned long flags;\r\nchar *prop;\r\nspin_lock_irqsave(&prom_lock, flags);\r\nprop = prom_nodeops->no_nextprop(node, oprop);\r\nrestore_current();\r\nspin_unlock_irqrestore(&prom_lock, flags);\r\nreturn prop;\r\n}\r\nchar *prom_nextprop(phandle node, char *oprop, char *buffer)\r\n{\r\nif (node == 0 || (s32)node == -1)\r\nreturn "";\r\nreturn __prom_nextprop(node, oprop);\r\n}\r\nphandle prom_finddevice(char *name)\r\n{\r\nchar nbuf[128];\r\nchar *s = name, *d;\r\nphandle node = prom_root_node, node2;\r\nunsigned int which_io, phys_addr;\r\nstruct linux_prom_registers reg[PROMREG_MAX];\r\nwhile (*s++) {\r\nif (!*s) return node;\r\nnode = prom_getchild(node);\r\nfor (d = nbuf; *s != 0 && *s != '@' && *s != '/';)\r\n*d++ = *s++;\r\n*d = 0;\r\nnode = prom_searchsiblings(node, nbuf);\r\nif (!node)\r\nreturn 0;\r\nif (*s == '@') {\r\nif (isxdigit(s[1]) && s[2] == ',') {\r\nwhich_io = simple_strtoul(s+1, NULL, 16);\r\nphys_addr = simple_strtoul(s+3, &d, 16);\r\nif (d != s + 3 && (!*d || *d == '/')\r\n&& d <= s + 3 + 8) {\r\nnode2 = node;\r\nwhile (node2 && (s32)node2 != -1) {\r\nif (prom_getproperty (node2, "reg", (char *)reg, sizeof (reg)) > 0) {\r\nif (which_io == reg[0].which_io && phys_addr == reg[0].phys_addr) {\r\nnode = node2;\r\nbreak;\r\n}\r\n}\r\nnode2 = prom_getsibling(node2);\r\nif (!node2 || (s32)node2 == -1)\r\nbreak;\r\nnode2 = prom_searchsiblings(prom_getsibling(node2), nbuf);\r\n}\r\n}\r\n}\r\nwhile (*s != 0 && *s != '/') s++;\r\n}\r\n}\r\nreturn node;\r\n}\r\nint prom_setprop(phandle node, const char *pname, char *value, int size)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nif (size == 0)\r\nreturn 0;\r\nif ((pname == NULL) || (value == NULL))\r\nreturn 0;\r\nspin_lock_irqsave(&prom_lock, flags);\r\nret = prom_nodeops->no_setprop(node, pname, value, size);\r\nrestore_current();\r\nspin_unlock_irqrestore(&prom_lock, flags);\r\nreturn ret;\r\n}\r\nphandle prom_inst2pkg(int inst)\r\n{\r\nphandle node;\r\nunsigned long flags;\r\nspin_lock_irqsave(&prom_lock, flags);\r\nnode = (*romvec->pv_v2devops.v2_inst2pkg)(inst);\r\nrestore_current();\r\nspin_unlock_irqrestore(&prom_lock, flags);\r\nif ((s32)node == -1)\r\nreturn 0;\r\nreturn node;\r\n}

static int st21nfcb_nci_open(struct nci_dev *ndev)\r\n{\r\nstruct st21nfcb_nci_info *info = nci_get_drvdata(ndev);\r\nint r;\r\nif (test_and_set_bit(ST21NFCB_NCI_RUNNING, &info->flags))\r\nreturn 0;\r\nr = ndlc_open(info->ndlc);\r\nif (r)\r\nclear_bit(ST21NFCB_NCI_RUNNING, &info->flags);\r\nreturn r;\r\n}\r\nstatic int st21nfcb_nci_close(struct nci_dev *ndev)\r\n{\r\nstruct st21nfcb_nci_info *info = nci_get_drvdata(ndev);\r\nif (!test_and_clear_bit(ST21NFCB_NCI_RUNNING, &info->flags))\r\nreturn 0;\r\nndlc_close(info->ndlc);\r\nreturn 0;\r\n}\r\nstatic int st21nfcb_nci_send(struct nci_dev *ndev, struct sk_buff *skb)\r\n{\r\nstruct st21nfcb_nci_info *info = nci_get_drvdata(ndev);\r\nskb->dev = (void *)ndev;\r\nif (!test_bit(ST21NFCB_NCI_RUNNING, &info->flags))\r\nreturn -EBUSY;\r\nreturn ndlc_send(info->ndlc, skb);\r\n}\r\nstatic __u32 st21nfcb_nci_get_rfprotocol(struct nci_dev *ndev,\r\n__u8 rf_protocol)\r\n{\r\nreturn rf_protocol == ST21NFCB_NCI1_X_PROPRIETARY_ISO15693 ?\r\nNFC_PROTO_ISO15693_MASK : 0;\r\n}\r\nint st21nfcb_nci_probe(struct llt_ndlc *ndlc, int phy_headroom,\r\nint phy_tailroom)\r\n{\r\nstruct st21nfcb_nci_info *info;\r\nint r;\r\nu32 protocols;\r\ninfo = devm_kzalloc(ndlc->dev,\r\nsizeof(struct st21nfcb_nci_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nprotocols = NFC_PROTO_JEWEL_MASK\r\n| NFC_PROTO_MIFARE_MASK\r\n| NFC_PROTO_FELICA_MASK\r\n| NFC_PROTO_ISO14443_MASK\r\n| NFC_PROTO_ISO14443_B_MASK\r\n| NFC_PROTO_ISO15693_MASK\r\n| NFC_PROTO_NFC_DEP_MASK;\r\nndlc->ndev = nci_allocate_device(&st21nfcb_nci_ops, protocols,\r\nphy_headroom, phy_tailroom);\r\nif (!ndlc->ndev) {\r\npr_err("Cannot allocate nfc ndev\n");\r\nreturn -ENOMEM;\r\n}\r\ninfo->ndlc = ndlc;\r\nnci_set_drvdata(ndlc->ndev, info);\r\nr = nci_register_device(ndlc->ndev);\r\nif (r) {\r\npr_err("Cannot register nfc device to nci core\n");\r\nnci_free_device(ndlc->ndev);\r\nreturn r;\r\n}\r\nreturn st21nfcb_se_init(ndlc->ndev);\r\n}\r\nvoid st21nfcb_nci_remove(struct nci_dev *ndev)\r\n{\r\nstruct st21nfcb_nci_info *info = nci_get_drvdata(ndev);\r\nnci_unregister_device(ndev);\r\nnci_free_device(ndev);\r\nkfree(info);\r\n}

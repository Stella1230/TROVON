void pxa27x_clear_otgph(void)\r\n{\r\nif (cpu_is_pxa27x() && (PSSR & PSSR_OTGPH))\r\nPSSR |= PSSR_OTGPH;\r\n}\r\nvoid pxa27x_configure_ac97reset(int reset_gpio, bool to_gpio)\r\n{\r\nif (reset_gpio == 113)\r\npxa2xx_mfp_config(to_gpio ? &ac97_reset_config[0] :\r\n&ac97_reset_config[1], 1);\r\nif (reset_gpio == 95)\r\npxa2xx_mfp_config(to_gpio ? &ac97_reset_config[2] :\r\n&ac97_reset_config[3], 1);\r\n}\r\nunsigned int pxa27x_get_clk_frequency_khz(int info)\r\n{\r\nunsigned long ccsr, clkcfg;\r\nunsigned int l, L, m, M, n2, N, S;\r\nint cccr_a, t, ht, b;\r\nccsr = CCSR;\r\ncccr_a = CCCR & (1 << 25);\r\nasm( "mrc\tp14, 0, %0, c6, c0, 0" : "=r" (clkcfg) );\r\nt = clkcfg & (1 << 0);\r\nht = clkcfg & (1 << 2);\r\nb = clkcfg & (1 << 3);\r\nl = ccsr & 0x1f;\r\nn2 = (ccsr>>7) & 0xf;\r\nm = (l <= 10) ? 1 : (l <= 20) ? 2 : 4;\r\nL = l * BASE_CLK;\r\nN = (L * n2) / 2;\r\nM = (!cccr_a) ? (L/m) : ((b) ? L : (L/2));\r\nS = (b) ? L : (L/2);\r\nif (info) {\r\nprintk( KERN_INFO "Run Mode clock: %d.%02dMHz (*%d)\n",\r\nL / 1000000, (L % 1000000) / 10000, l );\r\nprintk( KERN_INFO "Turbo Mode clock: %d.%02dMHz (*%d.%d, %sactive)\n",\r\nN / 1000000, (N % 1000000)/10000, n2 / 2, (n2 % 2)*5,\r\n(t) ? "" : "in" );\r\nprintk( KERN_INFO "Memory clock: %d.%02dMHz (/%d)\n",\r\nM / 1000000, (M % 1000000) / 10000, m );\r\nprintk( KERN_INFO "System bus clock: %d.%02dMHz \n",\r\nS / 1000000, (S % 1000000) / 10000 );\r\n}\r\nreturn (t) ? (N/1000) : (L/1000);\r\n}\r\nstatic unsigned long clk_pxa27x_mem_getrate(struct clk *clk)\r\n{\r\nunsigned long ccsr, clkcfg;\r\nunsigned int l, L, m, M;\r\nint cccr_a, b;\r\nccsr = CCSR;\r\ncccr_a = CCCR & (1 << 25);\r\nasm( "mrc\tp14, 0, %0, c6, c0, 0" : "=r" (clkcfg) );\r\nb = clkcfg & (1 << 3);\r\nl = ccsr & 0x1f;\r\nm = (l <= 10) ? 1 : (l <= 20) ? 2 : 4;\r\nL = l * BASE_CLK;\r\nM = (!cccr_a) ? (L/m) : ((b) ? L : (L/2));\r\nreturn M;\r\n}\r\nstatic unsigned int pxa27x_get_lcdclk_frequency_10khz(void)\r\n{\r\nunsigned long ccsr;\r\nunsigned int l, L, k, K;\r\nccsr = CCSR;\r\nl = ccsr & 0x1f;\r\nk = (l <= 7) ? 1 : (l <= 16) ? 2 : 4;\r\nL = l * BASE_CLK;\r\nK = L / k;\r\nreturn (K / 10000);\r\n}\r\nstatic unsigned long clk_pxa27x_lcd_getrate(struct clk *clk)\r\n{\r\nreturn pxa27x_get_lcdclk_frequency_10khz() * 10000;\r\n}\r\nint __init pxa27x_set_pwrmode(unsigned int mode)\r\n{\r\nswitch (mode) {\r\ncase PWRMODE_SLEEP:\r\ncase PWRMODE_DEEPSLEEP:\r\npwrmode = mode;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nvoid pxa27x_cpu_pm_save(unsigned long *sleep_save)\r\n{\r\nsleep_save[SLEEP_SAVE_MDREFR] = __raw_readl(MDREFR);\r\nSAVE(PCFR);\r\nSAVE(PSTR);\r\n}\r\nvoid pxa27x_cpu_pm_restore(unsigned long *sleep_save)\r\n{\r\n__raw_writel(sleep_save[SLEEP_SAVE_MDREFR], MDREFR);\r\nRESTORE(PCFR);\r\nPSSR = PSSR_RDH | PSSR_PH;\r\nRESTORE(PSTR);\r\n}\r\nvoid pxa27x_cpu_pm_enter(suspend_state_t state)\r\n{\r\nextern void pxa_cpu_standby(void);\r\n#ifndef CONFIG_IWMMXT\r\nu64 acc0;\r\nasm volatile("mra %Q0, %R0, acc0" : "=r" (acc0));\r\n#endif\r\nPCFR &= ~PCFR_FVC;\r\nPEDR = 0xDF12FE1B;\r\nRCSR = RCSR_HWR | RCSR_WDR | RCSR_SMR | RCSR_GPR;\r\nswitch (state) {\r\ncase PM_SUSPEND_STANDBY:\r\npxa_cpu_standby();\r\nbreak;\r\ncase PM_SUSPEND_MEM:\r\ncpu_suspend(pwrmode, pxa27x_finish_suspend);\r\n#ifndef CONFIG_IWMMXT\r\nasm volatile("mar acc0, %Q0, %R0" : "=r" (acc0));\r\n#endif\r\nbreak;\r\n}\r\n}\r\nstatic int pxa27x_cpu_pm_valid(suspend_state_t state)\r\n{\r\nreturn state == PM_SUSPEND_MEM || state == PM_SUSPEND_STANDBY;\r\n}\r\nstatic int pxa27x_cpu_pm_prepare(void)\r\n{\r\nPSPR = virt_to_phys(cpu_resume);\r\nreturn 0;\r\n}\r\nstatic void pxa27x_cpu_pm_finish(void)\r\n{\r\nPSPR = 0;\r\n}\r\nstatic void __init pxa27x_init_pm(void)\r\n{\r\npxa_cpu_pm_fns = &pxa27x_cpu_pm_fns;\r\n}\r\nstatic inline void pxa27x_init_pm(void) {}\r\nstatic int pxa27x_set_wake(struct irq_data *d, unsigned int on)\r\n{\r\nint gpio = pxa_irq_to_gpio(d->irq);\r\nuint32_t mask;\r\nif (gpio >= 0 && gpio < 128)\r\nreturn gpio_set_wake(gpio, on);\r\nif (d->irq == IRQ_KEYPAD)\r\nreturn keypad_set_wake(on);\r\nswitch (d->irq) {\r\ncase IRQ_RTCAlrm:\r\nmask = PWER_RTC;\r\nbreak;\r\ncase IRQ_USB:\r\nmask = 1u << 26;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (on)\r\nPWER |= mask;\r\nelse\r\nPWER &=~mask;\r\nreturn 0;\r\n}\r\nvoid __init pxa27x_init_irq(void)\r\n{\r\npxa_init_irq(34, pxa27x_set_wake);\r\n}\r\nvoid __init pxa27x_dt_init_irq(void)\r\n{\r\nif (IS_ENABLED(CONFIG_OF))\r\npxa_dt_irq_init(pxa27x_set_wake);\r\n}\r\nvoid __init pxa27x_map_io(void)\r\n{\r\npxa_map_io();\r\niotable_init(ARRAY_AND_SIZE(pxa27x_io_desc));\r\npxa27x_get_clk_frequency_khz(1);\r\n}\r\nvoid __init pxa27x_set_i2c_power_info(struct i2c_pxa_platform_data *info)\r\n{\r\nlocal_irq_disable();\r\nPCFR |= PCFR_PI2CEN;\r\nlocal_irq_enable();\r\npxa_register_device(&pxa27x_device_i2c_power, info);\r\n}\r\nstatic int __init pxa27x_init(void)\r\n{\r\nint ret = 0;\r\nif (cpu_is_pxa27x()) {\r\nreset_status = RCSR;\r\nclkdev_add_table(pxa27x_clkregs, ARRAY_SIZE(pxa27x_clkregs));\r\nif ((ret = pxa_init_dma(IRQ_DMA, 32)))\r\nreturn ret;\r\npxa27x_init_pm();\r\nregister_syscore_ops(&pxa_irq_syscore_ops);\r\nregister_syscore_ops(&pxa2xx_mfp_syscore_ops);\r\nregister_syscore_ops(&pxa2xx_clock_syscore_ops);\r\npxa_register_device(&pxa27x_device_gpio, &pxa27x_gpio_info);\r\nret = platform_add_devices(devices, ARRAY_SIZE(devices));\r\n}\r\nreturn ret;\r\n}

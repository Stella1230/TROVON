static inline void zynq_gpio_get_bank_pin(unsigned int pin_num,\r\nunsigned int *bank_num,\r\nunsigned int *bank_pin_num)\r\n{\r\nswitch (pin_num) {\r\ncase ZYNQ_GPIO_BANK0_PIN_MIN ... ZYNQ_GPIO_BANK0_PIN_MAX:\r\n*bank_num = 0;\r\n*bank_pin_num = pin_num;\r\nbreak;\r\ncase ZYNQ_GPIO_BANK1_PIN_MIN ... ZYNQ_GPIO_BANK1_PIN_MAX:\r\n*bank_num = 1;\r\n*bank_pin_num = pin_num - ZYNQ_GPIO_BANK1_PIN_MIN;\r\nbreak;\r\ncase ZYNQ_GPIO_BANK2_PIN_MIN ... ZYNQ_GPIO_BANK2_PIN_MAX:\r\n*bank_num = 2;\r\n*bank_pin_num = pin_num - ZYNQ_GPIO_BANK2_PIN_MIN;\r\nbreak;\r\ncase ZYNQ_GPIO_BANK3_PIN_MIN ... ZYNQ_GPIO_BANK3_PIN_MAX:\r\n*bank_num = 3;\r\n*bank_pin_num = pin_num - ZYNQ_GPIO_BANK3_PIN_MIN;\r\nbreak;\r\ndefault:\r\nWARN(true, "invalid GPIO pin number: %u", pin_num);\r\n*bank_num = 0;\r\n*bank_pin_num = 0;\r\nbreak;\r\n}\r\n}\r\nstatic int zynq_gpio_get_value(struct gpio_chip *chip, unsigned int pin)\r\n{\r\nu32 data;\r\nunsigned int bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = container_of(chip, struct zynq_gpio, chip);\r\nzynq_gpio_get_bank_pin(pin, &bank_num, &bank_pin_num);\r\ndata = readl_relaxed(gpio->base_addr +\r\nZYNQ_GPIO_DATA_RO_OFFSET(bank_num));\r\nreturn (data >> bank_pin_num) & 1;\r\n}\r\nstatic void zynq_gpio_set_value(struct gpio_chip *chip, unsigned int pin,\r\nint state)\r\n{\r\nunsigned int reg_offset, bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = container_of(chip, struct zynq_gpio, chip);\r\nzynq_gpio_get_bank_pin(pin, &bank_num, &bank_pin_num);\r\nif (bank_pin_num >= ZYNQ_GPIO_MID_PIN_NUM) {\r\nbank_pin_num -= ZYNQ_GPIO_MID_PIN_NUM;\r\nreg_offset = ZYNQ_GPIO_DATA_MSW_OFFSET(bank_num);\r\n} else {\r\nreg_offset = ZYNQ_GPIO_DATA_LSW_OFFSET(bank_num);\r\n}\r\nstate = !!state;\r\nstate = ~(1 << (bank_pin_num + ZYNQ_GPIO_MID_PIN_NUM)) &\r\n((state << bank_pin_num) | ZYNQ_GPIO_UPPER_MASK);\r\nwritel_relaxed(state, gpio->base_addr + reg_offset);\r\n}\r\nstatic int zynq_gpio_dir_in(struct gpio_chip *chip, unsigned int pin)\r\n{\r\nu32 reg;\r\nunsigned int bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = container_of(chip, struct zynq_gpio, chip);\r\nzynq_gpio_get_bank_pin(pin, &bank_num, &bank_pin_num);\r\nif (bank_num == 0 && (bank_pin_num == 7 || bank_pin_num == 8))\r\nreturn -EINVAL;\r\nreg = readl_relaxed(gpio->base_addr + ZYNQ_GPIO_DIRM_OFFSET(bank_num));\r\nreg &= ~BIT(bank_pin_num);\r\nwritel_relaxed(reg, gpio->base_addr + ZYNQ_GPIO_DIRM_OFFSET(bank_num));\r\nreturn 0;\r\n}\r\nstatic int zynq_gpio_dir_out(struct gpio_chip *chip, unsigned int pin,\r\nint state)\r\n{\r\nu32 reg;\r\nunsigned int bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = container_of(chip, struct zynq_gpio, chip);\r\nzynq_gpio_get_bank_pin(pin, &bank_num, &bank_pin_num);\r\nreg = readl_relaxed(gpio->base_addr + ZYNQ_GPIO_DIRM_OFFSET(bank_num));\r\nreg |= BIT(bank_pin_num);\r\nwritel_relaxed(reg, gpio->base_addr + ZYNQ_GPIO_DIRM_OFFSET(bank_num));\r\nreg = readl_relaxed(gpio->base_addr + ZYNQ_GPIO_OUTEN_OFFSET(bank_num));\r\nreg |= BIT(bank_pin_num);\r\nwritel_relaxed(reg, gpio->base_addr + ZYNQ_GPIO_OUTEN_OFFSET(bank_num));\r\nzynq_gpio_set_value(chip, pin, state);\r\nreturn 0;\r\n}\r\nstatic void zynq_gpio_irq_mask(struct irq_data *irq_data)\r\n{\r\nunsigned int device_pin_num, bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = irq_data_get_irq_chip_data(irq_data);\r\ndevice_pin_num = irq_data->hwirq;\r\nzynq_gpio_get_bank_pin(device_pin_num, &bank_num, &bank_pin_num);\r\nwritel_relaxed(BIT(bank_pin_num),\r\ngpio->base_addr + ZYNQ_GPIO_INTDIS_OFFSET(bank_num));\r\n}\r\nstatic void zynq_gpio_irq_unmask(struct irq_data *irq_data)\r\n{\r\nunsigned int device_pin_num, bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = irq_data_get_irq_chip_data(irq_data);\r\ndevice_pin_num = irq_data->hwirq;\r\nzynq_gpio_get_bank_pin(device_pin_num, &bank_num, &bank_pin_num);\r\nwritel_relaxed(BIT(bank_pin_num),\r\ngpio->base_addr + ZYNQ_GPIO_INTEN_OFFSET(bank_num));\r\n}\r\nstatic void zynq_gpio_irq_ack(struct irq_data *irq_data)\r\n{\r\nunsigned int device_pin_num, bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = irq_data_get_irq_chip_data(irq_data);\r\ndevice_pin_num = irq_data->hwirq;\r\nzynq_gpio_get_bank_pin(device_pin_num, &bank_num, &bank_pin_num);\r\nwritel_relaxed(BIT(bank_pin_num),\r\ngpio->base_addr + ZYNQ_GPIO_INTSTS_OFFSET(bank_num));\r\n}\r\nstatic void zynq_gpio_irq_enable(struct irq_data *irq_data)\r\n{\r\nzynq_gpio_irq_ack(irq_data);\r\nzynq_gpio_irq_unmask(irq_data);\r\n}\r\nstatic int zynq_gpio_set_irq_type(struct irq_data *irq_data, unsigned int type)\r\n{\r\nu32 int_type, int_pol, int_any;\r\nunsigned int device_pin_num, bank_num, bank_pin_num;\r\nstruct zynq_gpio *gpio = irq_data_get_irq_chip_data(irq_data);\r\ndevice_pin_num = irq_data->hwirq;\r\nzynq_gpio_get_bank_pin(device_pin_num, &bank_num, &bank_pin_num);\r\nint_type = readl_relaxed(gpio->base_addr +\r\nZYNQ_GPIO_INTTYPE_OFFSET(bank_num));\r\nint_pol = readl_relaxed(gpio->base_addr +\r\nZYNQ_GPIO_INTPOL_OFFSET(bank_num));\r\nint_any = readl_relaxed(gpio->base_addr +\r\nZYNQ_GPIO_INTANY_OFFSET(bank_num));\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\nint_type |= BIT(bank_pin_num);\r\nint_pol |= BIT(bank_pin_num);\r\nint_any &= ~BIT(bank_pin_num);\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\nint_type |= BIT(bank_pin_num);\r\nint_pol &= ~BIT(bank_pin_num);\r\nint_any &= ~BIT(bank_pin_num);\r\nbreak;\r\ncase IRQ_TYPE_EDGE_BOTH:\r\nint_type |= BIT(bank_pin_num);\r\nint_any |= BIT(bank_pin_num);\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\nint_type &= ~BIT(bank_pin_num);\r\nint_pol |= BIT(bank_pin_num);\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\nint_type &= ~BIT(bank_pin_num);\r\nint_pol &= ~BIT(bank_pin_num);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nwritel_relaxed(int_type,\r\ngpio->base_addr + ZYNQ_GPIO_INTTYPE_OFFSET(bank_num));\r\nwritel_relaxed(int_pol,\r\ngpio->base_addr + ZYNQ_GPIO_INTPOL_OFFSET(bank_num));\r\nwritel_relaxed(int_any,\r\ngpio->base_addr + ZYNQ_GPIO_INTANY_OFFSET(bank_num));\r\nif (type & IRQ_TYPE_LEVEL_MASK) {\r\n__irq_set_chip_handler_name_locked(irq_data->irq,\r\n&zynq_gpio_level_irqchip, handle_fasteoi_irq, NULL);\r\n} else {\r\n__irq_set_chip_handler_name_locked(irq_data->irq,\r\n&zynq_gpio_edge_irqchip, handle_level_irq, NULL);\r\n}\r\nreturn 0;\r\n}\r\nstatic int zynq_gpio_set_wake(struct irq_data *data, unsigned int on)\r\n{\r\nstruct zynq_gpio *gpio = irq_data_get_irq_chip_data(data);\r\nirq_set_irq_wake(gpio->irq, on);\r\nreturn 0;\r\n}\r\nstatic void zynq_gpio_handle_bank_irq(struct zynq_gpio *gpio,\r\nunsigned int bank_num,\r\nunsigned long pending)\r\n{\r\nunsigned int bank_offset = zynq_gpio_bank_offset[bank_num];\r\nstruct irq_domain *irqdomain = gpio->chip.irqdomain;\r\nint offset;\r\nif (!pending)\r\nreturn;\r\nfor_each_set_bit(offset, &pending, 32) {\r\nunsigned int gpio_irq;\r\ngpio_irq = irq_find_mapping(irqdomain, offset + bank_offset);\r\ngeneric_handle_irq(gpio_irq);\r\n}\r\n}\r\nstatic void zynq_gpio_irqhandler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nu32 int_sts, int_enb;\r\nunsigned int bank_num;\r\nstruct zynq_gpio *gpio = irq_get_handler_data(irq);\r\nstruct irq_chip *irqchip = irq_desc_get_chip(desc);\r\nchained_irq_enter(irqchip, desc);\r\nfor (bank_num = 0; bank_num < ZYNQ_GPIO_MAX_BANK; bank_num++) {\r\nint_sts = readl_relaxed(gpio->base_addr +\r\nZYNQ_GPIO_INTSTS_OFFSET(bank_num));\r\nint_enb = readl_relaxed(gpio->base_addr +\r\nZYNQ_GPIO_INTMASK_OFFSET(bank_num));\r\nzynq_gpio_handle_bank_irq(gpio, bank_num, int_sts & ~int_enb);\r\n}\r\nchained_irq_exit(irqchip, desc);\r\n}\r\nstatic int __maybe_unused zynq_gpio_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nint irq = platform_get_irq(pdev, 0);\r\nstruct irq_data *data = irq_get_irq_data(irq);\r\nif (!irqd_is_wakeup_set(data))\r\nreturn pm_runtime_force_suspend(dev);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused zynq_gpio_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nint irq = platform_get_irq(pdev, 0);\r\nstruct irq_data *data = irq_get_irq_data(irq);\r\nif (!irqd_is_wakeup_set(data))\r\nreturn pm_runtime_force_resume(dev);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused zynq_gpio_runtime_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct zynq_gpio *gpio = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(gpio->clk);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused zynq_gpio_runtime_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct zynq_gpio *gpio = platform_get_drvdata(pdev);\r\nreturn clk_prepare_enable(gpio->clk);\r\n}\r\nstatic int zynq_gpio_request(struct gpio_chip *chip, unsigned offset)\r\n{\r\nint ret;\r\nret = pm_runtime_get_sync(chip->dev);\r\nreturn ret < 0 ? ret : 0;\r\n}\r\nstatic void zynq_gpio_free(struct gpio_chip *chip, unsigned offset)\r\n{\r\npm_runtime_put(chip->dev);\r\n}\r\nstatic int zynq_gpio_probe(struct platform_device *pdev)\r\n{\r\nint ret, bank_num;\r\nstruct zynq_gpio *gpio;\r\nstruct gpio_chip *chip;\r\nstruct resource *res;\r\ngpio = devm_kzalloc(&pdev->dev, sizeof(*gpio), GFP_KERNEL);\r\nif (!gpio)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, gpio);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ngpio->base_addr = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(gpio->base_addr))\r\nreturn PTR_ERR(gpio->base_addr);\r\ngpio->irq = platform_get_irq(pdev, 0);\r\nif (gpio->irq < 0) {\r\ndev_err(&pdev->dev, "invalid IRQ\n");\r\nreturn gpio->irq;\r\n}\r\nchip = &gpio->chip;\r\nchip->label = "zynq_gpio";\r\nchip->owner = THIS_MODULE;\r\nchip->dev = &pdev->dev;\r\nchip->get = zynq_gpio_get_value;\r\nchip->set = zynq_gpio_set_value;\r\nchip->request = zynq_gpio_request;\r\nchip->free = zynq_gpio_free;\r\nchip->direction_input = zynq_gpio_dir_in;\r\nchip->direction_output = zynq_gpio_dir_out;\r\nchip->base = -1;\r\nchip->ngpio = ZYNQ_GPIO_NR_GPIOS;\r\ngpio->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(gpio->clk)) {\r\ndev_err(&pdev->dev, "input clock not found.\n");\r\nreturn PTR_ERR(gpio->clk);\r\n}\r\nret = clk_prepare_enable(gpio->clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Unable to enable clock.\n");\r\nreturn ret;\r\n}\r\nret = gpiochip_add(chip);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add gpio chip\n");\r\ngoto err_disable_clk;\r\n}\r\nfor (bank_num = 0; bank_num < ZYNQ_GPIO_MAX_BANK; bank_num++)\r\nwritel_relaxed(ZYNQ_GPIO_IXR_DISABLE_ALL, gpio->base_addr +\r\nZYNQ_GPIO_INTDIS_OFFSET(bank_num));\r\nret = gpiochip_irqchip_add(chip, &zynq_gpio_edge_irqchip, 0,\r\nhandle_level_irq, IRQ_TYPE_NONE);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add irq chip\n");\r\ngoto err_rm_gpiochip;\r\n}\r\ngpiochip_set_chained_irqchip(chip, &zynq_gpio_edge_irqchip, gpio->irq,\r\nzynq_gpio_irqhandler);\r\npm_runtime_set_active(&pdev->dev);\r\npm_runtime_enable(&pdev->dev);\r\nreturn 0;\r\nerr_rm_gpiochip:\r\ngpiochip_remove(chip);\r\nerr_disable_clk:\r\nclk_disable_unprepare(gpio->clk);\r\nreturn ret;\r\n}\r\nstatic int zynq_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct zynq_gpio *gpio = platform_get_drvdata(pdev);\r\npm_runtime_get_sync(&pdev->dev);\r\ngpiochip_remove(&gpio->chip);\r\nclk_disable_unprepare(gpio->clk);\r\ndevice_set_wakeup_capable(&pdev->dev, 0);\r\nreturn 0;\r\n}\r\nstatic int __init zynq_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&zynq_gpio_driver);\r\n}

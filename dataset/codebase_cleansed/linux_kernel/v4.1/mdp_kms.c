static void update_irq(struct mdp_kms *mdp_kms)\r\n{\r\nstruct mdp_irq *irq;\r\nuint32_t irqmask = mdp_kms->vblank_mask;\r\nassert_spin_locked(&list_lock);\r\nlist_for_each_entry(irq, &mdp_kms->irq_list, node)\r\nirqmask |= irq->irqmask;\r\nmdp_kms->funcs->set_irqmask(mdp_kms, irqmask);\r\n}\r\nvoid mdp_irq_update(struct mdp_kms *mdp_kms)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&list_lock, flags);\r\nupdate_irq(mdp_kms);\r\nspin_unlock_irqrestore(&list_lock, flags);\r\n}\r\nvoid mdp_dispatch_irqs(struct mdp_kms *mdp_kms, uint32_t status)\r\n{\r\nstruct mdp_irq *handler, *n;\r\nunsigned long flags;\r\nspin_lock_irqsave(&list_lock, flags);\r\nmdp_kms->in_irq = true;\r\nlist_for_each_entry_safe(handler, n, &mdp_kms->irq_list, node) {\r\nif (handler->irqmask & status) {\r\nspin_unlock_irqrestore(&list_lock, flags);\r\nhandler->irq(handler, handler->irqmask & status);\r\nspin_lock_irqsave(&list_lock, flags);\r\n}\r\n}\r\nmdp_kms->in_irq = false;\r\nupdate_irq(mdp_kms);\r\nspin_unlock_irqrestore(&list_lock, flags);\r\n}\r\nvoid mdp_update_vblank_mask(struct mdp_kms *mdp_kms, uint32_t mask, bool enable)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&list_lock, flags);\r\nif (enable)\r\nmdp_kms->vblank_mask |= mask;\r\nelse\r\nmdp_kms->vblank_mask &= ~mask;\r\nupdate_irq(mdp_kms);\r\nspin_unlock_irqrestore(&list_lock, flags);\r\n}\r\nstatic void wait_irq(struct mdp_irq *irq, uint32_t irqstatus)\r\n{\r\nstruct mdp_irq_wait *wait =\r\ncontainer_of(irq, struct mdp_irq_wait, irq);\r\nwait->count--;\r\nwake_up_all(&wait_event);\r\n}\r\nvoid mdp_irq_wait(struct mdp_kms *mdp_kms, uint32_t irqmask)\r\n{\r\nstruct mdp_irq_wait wait = {\r\n.irq = {\r\n.irq = wait_irq,\r\n.irqmask = irqmask,\r\n},\r\n.count = 1,\r\n};\r\nmdp_irq_register(mdp_kms, &wait.irq);\r\nwait_event_timeout(wait_event, (wait.count <= 0),\r\nmsecs_to_jiffies(100));\r\nmdp_irq_unregister(mdp_kms, &wait.irq);\r\n}\r\nvoid mdp_irq_register(struct mdp_kms *mdp_kms, struct mdp_irq *irq)\r\n{\r\nunsigned long flags;\r\nbool needs_update = false;\r\nspin_lock_irqsave(&list_lock, flags);\r\nif (!irq->registered) {\r\nirq->registered = true;\r\nlist_add(&irq->node, &mdp_kms->irq_list);\r\nneeds_update = !mdp_kms->in_irq;\r\n}\r\nspin_unlock_irqrestore(&list_lock, flags);\r\nif (needs_update)\r\nmdp_irq_update(mdp_kms);\r\n}\r\nvoid mdp_irq_unregister(struct mdp_kms *mdp_kms, struct mdp_irq *irq)\r\n{\r\nunsigned long flags;\r\nbool needs_update = false;\r\nspin_lock_irqsave(&list_lock, flags);\r\nif (irq->registered) {\r\nirq->registered = false;\r\nlist_del(&irq->node);\r\nneeds_update = !mdp_kms->in_irq;\r\n}\r\nspin_unlock_irqrestore(&list_lock, flags);\r\nif (needs_update)\r\nmdp_irq_update(mdp_kms);\r\n}

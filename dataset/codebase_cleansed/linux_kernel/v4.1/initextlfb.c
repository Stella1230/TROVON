int\r\nsisfb_mode_rate_to_dclock(struct SiS_Private *SiS_Pr, unsigned char modeno,\r\nunsigned char rateindex)\r\n{\r\nunsigned short ModeNo = modeno;\r\nunsigned short ModeIdIndex = 0, ClockIndex = 0;\r\nunsigned short RRTI = 0;\r\nint Clock;\r\nif(!SiSInitPtr(SiS_Pr)) return 65000;\r\nif(rateindex > 0) rateindex--;\r\n#ifdef CONFIG_FB_SIS_315\r\nswitch(ModeNo) {\r\ncase 0x5a: ModeNo = 0x50; break;\r\ncase 0x5b: ModeNo = 0x56;\r\n}\r\n#endif\r\nif(!(SiS_SearchModeID(SiS_Pr, &ModeNo, &ModeIdIndex))) {\r\nprintk(KERN_ERR "Could not find mode %x\n", ModeNo);\r\nreturn 65000;\r\n}\r\nRRTI = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].REFindex;\r\nif(SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag & HaveWideTiming) {\r\nif(SiS_Pr->SiS_UseWide == 1) {\r\nClockIndex = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRTVCLK_WIDE;\r\n} else {\r\nRRTI += rateindex;\r\nClockIndex = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRTVCLK_NORM;\r\n}\r\n} else {\r\nRRTI += rateindex;\r\nClockIndex = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRTVCLK;\r\n}\r\nClock = SiS_Pr->SiS_VCLKData[ClockIndex].CLOCK * 1000;\r\nreturn Clock;\r\n}\r\nint\r\nsisfb_mode_rate_to_ddata(struct SiS_Private *SiS_Pr, unsigned char modeno,\r\nunsigned char rateindex, struct fb_var_screeninfo *var)\r\n{\r\nunsigned short ModeNo = modeno;\r\nunsigned short ModeIdIndex = 0, index = 0, RRTI = 0;\r\nint j;\r\nif(!SiSInitPtr(SiS_Pr)) return 0;\r\nif(rateindex > 0) rateindex--;\r\n#ifdef CONFIG_FB_SIS_315\r\nswitch(ModeNo) {\r\ncase 0x5a: ModeNo = 0x50; break;\r\ncase 0x5b: ModeNo = 0x56;\r\n}\r\n#endif\r\nif(!(SiS_SearchModeID(SiS_Pr, &ModeNo, &ModeIdIndex))) return 0;\r\nRRTI = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].REFindex;\r\nif(SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag & HaveWideTiming) {\r\nif(SiS_Pr->SiS_UseWide == 1) {\r\nindex = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRT1CRTC_WIDE;\r\n} else {\r\nRRTI += rateindex;\r\nindex = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRT1CRTC_NORM;\r\n}\r\n} else {\r\nRRTI += rateindex;\r\nindex = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRT1CRTC;\r\n}\r\nSiS_Generic_ConvertCRData(SiS_Pr,\r\n(unsigned char *)&SiS_Pr->SiS_CRT1Table[index].CR[0],\r\nSiS_Pr->SiS_RefIndex[RRTI].XRes,\r\nSiS_Pr->SiS_RefIndex[RRTI].YRes,\r\nvar, false);\r\nif(SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag & 0x8000)\r\nvar->sync &= ~FB_SYNC_VERT_HIGH_ACT;\r\nelse\r\nvar->sync |= FB_SYNC_VERT_HIGH_ACT;\r\nif(SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag & 0x4000)\r\nvar->sync &= ~FB_SYNC_HOR_HIGH_ACT;\r\nelse\r\nvar->sync |= FB_SYNC_HOR_HIGH_ACT;\r\nvar->vmode = FB_VMODE_NONINTERLACED;\r\nif(SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag & 0x0080)\r\nvar->vmode = FB_VMODE_INTERLACED;\r\nelse {\r\nj = 0;\r\nwhile(SiS_Pr->SiS_EModeIDTable[j].Ext_ModeID != 0xff) {\r\nif(SiS_Pr->SiS_EModeIDTable[j].Ext_ModeID ==\r\nSiS_Pr->SiS_RefIndex[RRTI].ModeID) {\r\nif(SiS_Pr->SiS_EModeIDTable[j].Ext_ModeFlag & DoubleScanMode) {\r\nvar->vmode = FB_VMODE_DOUBLE;\r\n}\r\nbreak;\r\n}\r\nj++;\r\n}\r\n}\r\nif((var->vmode & FB_VMODE_MASK) == FB_VMODE_INTERLACED) {\r\n#if 0\r\nvar->upper_margin <<= 1;\r\nvar->lower_margin <<= 1;\r\nvar->vsync_len <<= 1;\r\n#endif\r\n} else if((var->vmode & FB_VMODE_MASK) == FB_VMODE_DOUBLE) {\r\nvar->upper_margin >>= 1;\r\nvar->lower_margin >>= 1;\r\nvar->vsync_len >>= 1;\r\n}\r\nreturn 1;\r\n}\r\nbool\r\nsisfb_gettotalfrommode(struct SiS_Private *SiS_Pr, unsigned char modeno, int *htotal,\r\nint *vtotal, unsigned char rateindex)\r\n{\r\nunsigned short ModeNo = modeno;\r\nunsigned short ModeIdIndex = 0, CRT1Index = 0;\r\nunsigned short RRTI = 0;\r\nunsigned char sr_data, cr_data, cr_data2;\r\nif(!SiSInitPtr(SiS_Pr)) return false;\r\nif(rateindex > 0) rateindex--;\r\n#ifdef CONFIG_FB_SIS_315\r\nswitch(ModeNo) {\r\ncase 0x5a: ModeNo = 0x50; break;\r\ncase 0x5b: ModeNo = 0x56;\r\n}\r\n#endif\r\nif(!(SiS_SearchModeID(SiS_Pr, &ModeNo, &ModeIdIndex))) return false;\r\nRRTI = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].REFindex;\r\nif(SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag & HaveWideTiming) {\r\nif(SiS_Pr->SiS_UseWide == 1) {\r\nCRT1Index = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRT1CRTC_WIDE;\r\n} else {\r\nRRTI += rateindex;\r\nCRT1Index = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRT1CRTC_NORM;\r\n}\r\n} else {\r\nRRTI += rateindex;\r\nCRT1Index = SiS_Pr->SiS_RefIndex[RRTI].Ext_CRT1CRTC;\r\n}\r\nsr_data = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[14];\r\ncr_data = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[0];\r\n*htotal = (((cr_data & 0xff) | ((unsigned short) (sr_data & 0x03) << 8)) + 5) * 8;\r\nsr_data = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[13];\r\ncr_data = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[6];\r\ncr_data2 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[7];\r\n*vtotal = ((cr_data & 0xFF) |\r\n((unsigned short)(cr_data2 & 0x01) << 8) |\r\n((unsigned short)(cr_data2 & 0x20) << 4) |\r\n((unsigned short)(sr_data & 0x01) << 10)) + 2;\r\nif(SiS_Pr->SiS_RefIndex[RRTI].Ext_InfoFlag & InterlaceMode)\r\n*vtotal *= 2;\r\nreturn true;\r\n}

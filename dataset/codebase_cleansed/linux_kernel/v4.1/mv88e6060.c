static int reg_read(struct dsa_switch *ds, int addr, int reg)\r\n{\r\nstruct mii_bus *bus = dsa_host_dev_to_mii_bus(ds->master_dev);\r\nif (bus == NULL)\r\nreturn -EINVAL;\r\nreturn mdiobus_read(bus, ds->pd->sw_addr + addr, reg);\r\n}\r\nstatic int reg_write(struct dsa_switch *ds, int addr, int reg, u16 val)\r\n{\r\nstruct mii_bus *bus = dsa_host_dev_to_mii_bus(ds->master_dev);\r\nif (bus == NULL)\r\nreturn -EINVAL;\r\nreturn mdiobus_write(bus, ds->pd->sw_addr + addr, reg, val);\r\n}\r\nstatic char *mv88e6060_probe(struct device *host_dev, int sw_addr)\r\n{\r\nstruct mii_bus *bus = dsa_host_dev_to_mii_bus(host_dev);\r\nint ret;\r\nif (bus == NULL)\r\nreturn NULL;\r\nret = mdiobus_read(bus, sw_addr + REG_PORT(0), 0x03);\r\nif (ret >= 0) {\r\nif (ret == 0x0600)\r\nreturn "Marvell 88E6060 (A0)";\r\nif (ret == 0x0601 || ret == 0x0602)\r\nreturn "Marvell 88E6060 (B0)";\r\nif ((ret & 0xfff0) == 0x0600)\r\nreturn "Marvell 88E6060";\r\n}\r\nreturn NULL;\r\n}\r\nstatic int mv88e6060_switch_reset(struct dsa_switch *ds)\r\n{\r\nint i;\r\nint ret;\r\nunsigned long timeout;\r\nfor (i = 0; i < 6; i++) {\r\nret = REG_READ(REG_PORT(i), 0x04);\r\nREG_WRITE(REG_PORT(i), 0x04, ret & 0xfffc);\r\n}\r\nusleep_range(2000, 4000);\r\nREG_WRITE(REG_GLOBAL, 0x0a, 0xa130);\r\ntimeout = jiffies + 1 * HZ;\r\nwhile (time_before(jiffies, timeout)) {\r\nret = REG_READ(REG_GLOBAL, 0x00);\r\nif ((ret & 0x8000) == 0x0000)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (time_after(jiffies, timeout))\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_setup_global(struct dsa_switch *ds)\r\n{\r\nREG_WRITE(REG_GLOBAL, 0x04, 0x0800);\r\nREG_WRITE(REG_GLOBAL, 0x0a, 0x2130);\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_setup_port(struct dsa_switch *ds, int p)\r\n{\r\nint addr = REG_PORT(p);\r\nREG_WRITE(addr, 0x04, dsa_is_cpu_port(ds, p) ? 0x4103 : 0x0003);\r\nREG_WRITE(addr, 0x06,\r\n((p & 0xf) << 12) |\r\n(dsa_is_cpu_port(ds, p) ?\r\nds->phys_port_mask :\r\n(1 << ds->dst->cpu_port)));\r\nREG_WRITE(addr, 0x0b, 1 << p);\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_setup(struct dsa_switch *ds)\r\n{\r\nint i;\r\nint ret;\r\nret = mv88e6060_switch_reset(ds);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mv88e6060_setup_global(ds);\r\nif (ret < 0)\r\nreturn ret;\r\nfor (i = 0; i < 6; i++) {\r\nret = mv88e6060_setup_port(ds, i);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_set_addr(struct dsa_switch *ds, u8 *addr)\r\n{\r\nREG_WRITE(REG_GLOBAL, 0x01, (addr[0] << 8) | addr[1]);\r\nREG_WRITE(REG_GLOBAL, 0x02, (addr[2] << 8) | addr[3]);\r\nREG_WRITE(REG_GLOBAL, 0x03, (addr[4] << 8) | addr[5]);\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_port_to_phy_addr(int port)\r\n{\r\nif (port >= 0 && port <= 5)\r\nreturn port;\r\nreturn -1;\r\n}\r\nstatic int mv88e6060_phy_read(struct dsa_switch *ds, int port, int regnum)\r\n{\r\nint addr;\r\naddr = mv88e6060_port_to_phy_addr(port);\r\nif (addr == -1)\r\nreturn 0xffff;\r\nreturn reg_read(ds, addr, regnum);\r\n}\r\nstatic int\r\nmv88e6060_phy_write(struct dsa_switch *ds, int port, int regnum, u16 val)\r\n{\r\nint addr;\r\naddr = mv88e6060_port_to_phy_addr(port);\r\nif (addr == -1)\r\nreturn 0xffff;\r\nreturn reg_write(ds, addr, regnum, val);\r\n}\r\nstatic void mv88e6060_poll_link(struct dsa_switch *ds)\r\n{\r\nint i;\r\nfor (i = 0; i < DSA_MAX_PORTS; i++) {\r\nstruct net_device *dev;\r\nint uninitialized_var(port_status);\r\nint link;\r\nint speed;\r\nint duplex;\r\nint fc;\r\ndev = ds->ports[i];\r\nif (dev == NULL)\r\ncontinue;\r\nlink = 0;\r\nif (dev->flags & IFF_UP) {\r\nport_status = reg_read(ds, REG_PORT(i), 0x00);\r\nif (port_status < 0)\r\ncontinue;\r\nlink = !!(port_status & 0x1000);\r\n}\r\nif (!link) {\r\nif (netif_carrier_ok(dev)) {\r\nnetdev_info(dev, "link down\n");\r\nnetif_carrier_off(dev);\r\n}\r\ncontinue;\r\n}\r\nspeed = (port_status & 0x0100) ? 100 : 10;\r\nduplex = (port_status & 0x0200) ? 1 : 0;\r\nfc = ((port_status & 0xc000) == 0xc000) ? 1 : 0;\r\nif (!netif_carrier_ok(dev)) {\r\nnetdev_info(dev,\r\n"link up, %d Mb/s, %s duplex, flow control %sabled\n",\r\nspeed,\r\nduplex ? "full" : "half",\r\nfc ? "en" : "dis");\r\nnetif_carrier_on(dev);\r\n}\r\n}\r\n}\r\nstatic int __init mv88e6060_init(void)\r\n{\r\nregister_switch_driver(&mv88e6060_switch_driver);\r\nreturn 0;\r\n}\r\nstatic void __exit mv88e6060_cleanup(void)\r\n{\r\nunregister_switch_driver(&mv88e6060_switch_driver);\r\n}

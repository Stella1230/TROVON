void rtl8723be_phy_rf6052_set_bandwidth(struct ieee80211_hw *hw, u8 bandwidth)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nswitch (bandwidth) {\r\ncase HT_CHANNEL_WIDTH_20:\r\nrtlphy->rfreg_chnlval[0] = ((rtlphy->rfreg_chnlval[0] &\r\n0xfffff3ff) | BIT(10) | BIT(11));\r\nrtl_set_rfreg(hw, RF90_PATH_A, RF_CHNLBW, RFREG_OFFSET_MASK,\r\nrtlphy->rfreg_chnlval[0]);\r\nbreak;\r\ncase HT_CHANNEL_WIDTH_20_40:\r\nrtlphy->rfreg_chnlval[0] = ((rtlphy->rfreg_chnlval[0] &\r\n0xfffff3ff) | BIT(10));\r\nrtl_set_rfreg(hw, RF90_PATH_A, RF_CHNLBW, RFREG_OFFSET_MASK,\r\nrtlphy->rfreg_chnlval[0]);\r\nbreak;\r\ndefault:\r\nRT_TRACE(rtlpriv, COMP_ERR, DBG_EMERG,\r\n"unknown bandwidth: %#X\n", bandwidth);\r\nbreak;\r\n}\r\n}\r\nvoid rtl8723be_phy_rf6052_set_cck_txpower(struct ieee80211_hw *hw,\r\nu8 *ppowerlevel)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\r\nu32 tx_agc[2] = {0, 0}, tmpval;\r\nbool turbo_scanoff = false;\r\nu8 idx1, idx2;\r\nu8 *ptr;\r\nu8 direction;\r\nu32 pwrtrac_value;\r\nif (rtlefuse->eeprom_regulatory != 0)\r\nturbo_scanoff = true;\r\nif (mac->act_scanning) {\r\ntx_agc[RF90_PATH_A] = 0x3f3f3f3f;\r\ntx_agc[RF90_PATH_B] = 0x3f3f3f3f;\r\nif (turbo_scanoff) {\r\nfor (idx1 = RF90_PATH_A; idx1 <= RF90_PATH_B; idx1++) {\r\ntx_agc[idx1] = ppowerlevel[idx1] |\r\n(ppowerlevel[idx1] << 8) |\r\n(ppowerlevel[idx1] << 16) |\r\n(ppowerlevel[idx1] << 24);\r\n}\r\n}\r\n} else {\r\nfor (idx1 = RF90_PATH_A; idx1 <= RF90_PATH_B; idx1++) {\r\ntx_agc[idx1] = ppowerlevel[idx1] |\r\n(ppowerlevel[idx1] << 8) |\r\n(ppowerlevel[idx1] << 16) |\r\n(ppowerlevel[idx1] << 24);\r\n}\r\nif (rtlefuse->eeprom_regulatory == 0) {\r\ntmpval =\r\n(rtlphy->mcs_txpwrlevel_origoffset[0][6]) +\r\n(rtlphy->mcs_txpwrlevel_origoffset[0][7] << 8);\r\ntx_agc[RF90_PATH_A] += tmpval;\r\ntmpval = (rtlphy->mcs_txpwrlevel_origoffset[0][14]) +\r\n(rtlphy->mcs_txpwrlevel_origoffset[0][15] <<\r\n24);\r\ntx_agc[RF90_PATH_B] += tmpval;\r\n}\r\n}\r\nfor (idx1 = RF90_PATH_A; idx1 <= RF90_PATH_B; idx1++) {\r\nptr = (u8 *)(&(tx_agc[idx1]));\r\nfor (idx2 = 0; idx2 < 4; idx2++) {\r\nif (*ptr > RF6052_MAX_TX_PWR)\r\n*ptr = RF6052_MAX_TX_PWR;\r\nptr++;\r\n}\r\n}\r\nrtl8723be_dm_txpower_track_adjust(hw, 1, &direction, &pwrtrac_value);\r\nif (direction == 1) {\r\ntx_agc[0] += pwrtrac_value;\r\ntx_agc[1] += pwrtrac_value;\r\n} else if (direction == 2) {\r\ntx_agc[0] -= pwrtrac_value;\r\ntx_agc[1] -= pwrtrac_value;\r\n}\r\ntmpval = tx_agc[RF90_PATH_A] & 0xff;\r\nrtl_set_bbreg(hw, RTXAGC_A_CCK1_MCS32, MASKBYTE1, tmpval);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"CCK PWR 1M (rf-A) = 0x%x (reg 0x%x)\n", tmpval,\r\nRTXAGC_A_CCK1_MCS32);\r\ntmpval = tx_agc[RF90_PATH_A] >> 8;\r\nrtl_set_bbreg(hw, RTXAGC_B_CCK11_A_CCK2_11, 0xffffff00, tmpval);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"CCK PWR 2~11M (rf-A) = 0x%x (reg 0x%x)\n", tmpval,\r\nRTXAGC_B_CCK11_A_CCK2_11);\r\ntmpval = tx_agc[RF90_PATH_B] >> 24;\r\nrtl_set_bbreg(hw, RTXAGC_B_CCK11_A_CCK2_11, MASKBYTE0, tmpval);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"CCK PWR 11M (rf-B) = 0x%x (reg 0x%x)\n", tmpval,\r\nRTXAGC_B_CCK11_A_CCK2_11);\r\ntmpval = tx_agc[RF90_PATH_B] & 0x00ffffff;\r\nrtl_set_bbreg(hw, RTXAGC_B_CCK1_55_MCS32, 0xffffff00, tmpval);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"CCK PWR 1~5.5M (rf-B) = 0x%x (reg 0x%x)\n", tmpval,\r\nRTXAGC_B_CCK1_55_MCS32);\r\n}\r\nstatic void rtl8723be_phy_get_power_base(struct ieee80211_hw *hw,\r\nu8 *ppowerlevel_ofdm,\r\nu8 *ppowerlevel_bw20,\r\nu8 *ppowerlevel_bw40,\r\nu8 channel, u32 *ofdmbase,\r\nu32 *mcsbase)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nu32 powerbase0, powerbase1;\r\nu8 i, powerlevel[2];\r\nfor (i = 0; i < 2; i++) {\r\npowerbase0 = ppowerlevel_ofdm[i];\r\npowerbase0 = (powerbase0 << 24) | (powerbase0 << 16) |\r\n(powerbase0 << 8) | powerbase0;\r\n*(ofdmbase + i) = powerbase0;\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n" [OFDM power base index rf(%c) = 0x%x]\n",\r\n((i == 0) ? 'A' : 'B'), *(ofdmbase + i));\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20)\r\npowerlevel[i] = ppowerlevel_bw20[i];\r\nelse\r\npowerlevel[i] = ppowerlevel_bw40[i];\r\npowerbase1 = powerlevel[i];\r\npowerbase1 = (powerbase1 << 24) | (powerbase1 << 16) |\r\n(powerbase1 << 8) | powerbase1;\r\n*(mcsbase + i) = powerbase1;\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n" [MCS power base index rf(%c) = 0x%x]\n",\r\n((i == 0) ? 'A' : 'B'), *(mcsbase + i));\r\n}\r\n}\r\nstatic void _rtl8723be_get_txpower_writeval_by_regulatory(\r\nstruct ieee80211_hw *hw,\r\nu8 channel, u8 index,\r\nu32 *powerbase0,\r\nu32 *powerbase1,\r\nu32 *p_outwriteval)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\r\nu8 i, chnlgroup = 0, pwr_diff_limit[4], pwr_diff = 0, customer_pwr_diff;\r\nu32 writeval, customer_limit, rf;\r\nfor (rf = 0; rf < 2; rf++) {\r\nswitch (rtlefuse->eeprom_regulatory) {\r\ncase 0:\r\nchnlgroup = 0;\r\nwriteval =\r\nrtlphy->mcs_txpwrlevel_origoffset[chnlgroup][index +\r\n(rf ? 8 : 0)]\r\n+ ((index < 2) ? powerbase0[rf] : powerbase1[rf]);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"RTK better performance, writeval(%c) = 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'), writeval);\r\nbreak;\r\ncase 1:\r\nif (rtlphy->pwrgroup_cnt == 1) {\r\nchnlgroup = 0;\r\n} else {\r\nif (channel < 3)\r\nchnlgroup = 0;\r\nelse if (channel < 6)\r\nchnlgroup = 1;\r\nelse if (channel < 9)\r\nchnlgroup = 2;\r\nelse if (channel < 12)\r\nchnlgroup = 3;\r\nelse if (channel < 14)\r\nchnlgroup = 4;\r\nelse if (channel == 14)\r\nchnlgroup = 5;\r\n}\r\nwriteval =\r\nrtlphy->mcs_txpwrlevel_origoffset[chnlgroup]\r\n[index + (rf ? 8 : 0)] + ((index < 2) ?\r\npowerbase0[rf] :\r\npowerbase1[rf]);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"Realtek regulatory, 20MHz, writeval(%c) = 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'), writeval);\r\nbreak;\r\ncase 2:\r\nwriteval =\r\n((index < 2) ? powerbase0[rf] : powerbase1[rf]);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"Better regulatory, writeval(%c) = 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'), writeval);\r\nbreak;\r\ncase 3:\r\nchnlgroup = 0;\r\nif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40) {\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"customer's limit, 40MHz rf(%c) = 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'),\r\nrtlefuse->pwrgroup_ht40\r\n[rf][channel - 1]);\r\n} else {\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"customer's limit, 20MHz rf(%c) = 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'),\r\nrtlefuse->pwrgroup_ht20\r\n[rf][channel - 1]);\r\n}\r\nif (index < 2)\r\npwr_diff =\r\nrtlefuse->txpwr_legacyhtdiff[rf][channel-1];\r\nelse if (rtlphy->current_chan_bw ==\r\nHT_CHANNEL_WIDTH_20)\r\npwr_diff =\r\nrtlefuse->txpwr_ht20diff[rf][channel-1];\r\nif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40)\r\ncustomer_pwr_diff =\r\nrtlefuse->pwrgroup_ht40[rf][channel-1];\r\nelse\r\ncustomer_pwr_diff =\r\nrtlefuse->pwrgroup_ht20[rf][channel-1];\r\nif (pwr_diff > customer_pwr_diff)\r\npwr_diff = 0;\r\nelse\r\npwr_diff = customer_pwr_diff - pwr_diff;\r\nfor (i = 0; i < 4; i++) {\r\npwr_diff_limit[i] =\r\n(u8)((rtlphy->mcs_txpwrlevel_origoffset\r\n[chnlgroup][index + (rf ? 8 : 0)] &\r\n(0x7f << (i * 8))) >> (i * 8));\r\nif (pwr_diff_limit[i] > pwr_diff)\r\npwr_diff_limit[i] = pwr_diff;\r\n}\r\ncustomer_limit = (pwr_diff_limit[3] << 24) |\r\n(pwr_diff_limit[2] << 16) |\r\n(pwr_diff_limit[1] << 8) |\r\n(pwr_diff_limit[0]);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"Customer's limit rf(%c) = 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'), customer_limit);\r\nwriteval = customer_limit + ((index < 2) ?\r\npowerbase0[rf] :\r\npowerbase1[rf]);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"Customer, writeval rf(%c)= 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'), writeval);\r\nbreak;\r\ndefault:\r\nchnlgroup = 0;\r\nwriteval =\r\nrtlphy->mcs_txpwrlevel_origoffset[chnlgroup]\r\n[index + (rf ? 8 : 0)]\r\n+ ((index < 2) ? powerbase0[rf] : powerbase1[rf]);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"RTK better performance, writeval rf(%c) = 0x%x\n",\r\n((rf == 0) ? 'A' : 'B'), writeval);\r\nbreak;\r\n}\r\nif (rtlpriv->dm.dynamic_txhighpower_lvl == TXHIGHPWRLEVEL_BT1)\r\nwriteval = writeval - 0x06060606;\r\nelse if (rtlpriv->dm.dynamic_txhighpower_lvl ==\r\nTXHIGHPWRLEVEL_BT2)\r\nwriteval = writeval - 0x0c0c0c0c;\r\n*(p_outwriteval + rf) = writeval;\r\n}\r\n}\r\nstatic void _rtl8723be_write_ofdm_power_reg(struct ieee80211_hw *hw,\r\nu8 index, u32 *pvalue)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu16 regoffset_a[6] = {\r\nRTXAGC_A_RATE18_06, RTXAGC_A_RATE54_24,\r\nRTXAGC_A_MCS03_MCS00, RTXAGC_A_MCS07_MCS04,\r\nRTXAGC_A_MCS11_MCS08, RTXAGC_A_MCS15_MCS12\r\n};\r\nu16 regoffset_b[6] = {\r\nRTXAGC_B_RATE18_06, RTXAGC_B_RATE54_24,\r\nRTXAGC_B_MCS03_MCS00, RTXAGC_B_MCS07_MCS04,\r\nRTXAGC_B_MCS11_MCS08, RTXAGC_B_MCS15_MCS12\r\n};\r\nu8 i, rf, pwr_val[4];\r\nu32 writeval;\r\nu16 regoffset;\r\nfor (rf = 0; rf < 2; rf++) {\r\nwriteval = pvalue[rf];\r\nfor (i = 0; i < 4; i++) {\r\npwr_val[i] = (u8)((writeval & (0x7f <<\r\n(i * 8))) >> (i * 8));\r\nif (pwr_val[i] > RF6052_MAX_TX_PWR)\r\npwr_val[i] = RF6052_MAX_TX_PWR;\r\n}\r\nwriteval = (pwr_val[3] << 24) | (pwr_val[2] << 16) |\r\n(pwr_val[1] << 8) | pwr_val[0];\r\nif (rf == 0)\r\nregoffset = regoffset_a[index];\r\nelse\r\nregoffset = regoffset_b[index];\r\nrtl_set_bbreg(hw, regoffset, MASKDWORD, writeval);\r\nRTPRINT(rtlpriv, FPHY, PHY_TXPWR,\r\n"Set 0x%x = %08x\n", regoffset, writeval);\r\n}\r\n}\r\nvoid rtl8723be_phy_rf6052_set_ofdm_txpower(struct ieee80211_hw *hw,\r\nu8 *ppowerlevel_ofdm,\r\nu8 *ppowerlevel_bw20,\r\nu8 *ppowerlevel_bw40, u8 channel)\r\n{\r\nu32 writeval[2], powerbase0[2], powerbase1[2];\r\nu8 index;\r\nu8 direction;\r\nu32 pwrtrac_value;\r\nrtl8723be_phy_get_power_base(hw, ppowerlevel_ofdm, ppowerlevel_bw20,\r\nppowerlevel_bw40, channel,\r\n&powerbase0[0], &powerbase1[0]);\r\nrtl8723be_dm_txpower_track_adjust(hw, 1, &direction, &pwrtrac_value);\r\nfor (index = 0; index < 6; index++) {\r\n_rtl8723be_get_txpower_writeval_by_regulatory(hw,\r\nchannel, index,\r\n&powerbase0[0],\r\n&powerbase1[0],\r\n&writeval[0]);\r\nif (direction == 1) {\r\nwriteval[0] += pwrtrac_value;\r\nwriteval[1] += pwrtrac_value;\r\n} else if (direction == 2) {\r\nwriteval[0] -= pwrtrac_value;\r\nwriteval[1] -= pwrtrac_value;\r\n}\r\n_rtl8723be_write_ofdm_power_reg(hw, index, &writeval[0]);\r\n}\r\n}\r\nbool rtl8723be_phy_rf6052_config(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nif (rtlphy->rf_type == RF_1T1R)\r\nrtlphy->num_total_rfpath = 1;\r\nelse\r\nrtlphy->num_total_rfpath = 2;\r\nreturn _rtl8723be_phy_rf6052_config_parafile(hw);\r\n}\r\nstatic bool _rtl8723be_phy_rf6052_config_parafile(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nu32 u4_regvalue = 0;\r\nu8 rfpath;\r\nbool rtstatus = true;\r\nstruct bb_reg_def *pphyreg;\r\nfor (rfpath = 0; rfpath < rtlphy->num_total_rfpath; rfpath++) {\r\npphyreg = &rtlphy->phyreg_def[rfpath];\r\nswitch (rfpath) {\r\ncase RF90_PATH_A:\r\ncase RF90_PATH_C:\r\nu4_regvalue = rtl_get_bbreg(hw, pphyreg->rfintfs,\r\nBRFSI_RFENV);\r\nbreak;\r\ncase RF90_PATH_B:\r\ncase RF90_PATH_D:\r\nu4_regvalue = rtl_get_bbreg(hw, pphyreg->rfintfs,\r\nBRFSI_RFENV << 16);\r\nbreak;\r\n}\r\nrtl_set_bbreg(hw, pphyreg->rfintfe, BRFSI_RFENV << 16, 0x1);\r\nudelay(1);\r\nrtl_set_bbreg(hw, pphyreg->rfintfo, BRFSI_RFENV, 0x1);\r\nudelay(1);\r\nrtl_set_bbreg(hw, pphyreg->rfhssi_para2,\r\nB3WIREADDREAALENGTH, 0x0);\r\nudelay(1);\r\nrtl_set_bbreg(hw, pphyreg->rfhssi_para2, B3WIREDATALENGTH, 0x0);\r\nudelay(1);\r\nswitch (rfpath) {\r\ncase RF90_PATH_A:\r\nrtstatus = rtl8723be_phy_config_rf_with_headerfile(hw,\r\n(enum radio_path)rfpath);\r\nbreak;\r\ncase RF90_PATH_B:\r\nrtstatus = rtl8723be_phy_config_rf_with_headerfile(hw,\r\n(enum radio_path)rfpath);\r\nbreak;\r\ncase RF90_PATH_C:\r\nbreak;\r\ncase RF90_PATH_D:\r\nbreak;\r\n}\r\nswitch (rfpath) {\r\ncase RF90_PATH_A:\r\ncase RF90_PATH_C:\r\nrtl_set_bbreg(hw, pphyreg->rfintfs,\r\nBRFSI_RFENV, u4_regvalue);\r\nbreak;\r\ncase RF90_PATH_B:\r\ncase RF90_PATH_D:\r\nrtl_set_bbreg(hw, pphyreg->rfintfs,\r\nBRFSI_RFENV << 16, u4_regvalue);\r\nbreak;\r\n}\r\nif (!rtstatus) {\r\nRT_TRACE(rtlpriv, COMP_INIT, DBG_TRACE,\r\n"Radio[%d] Fail!!", rfpath);\r\nreturn false;\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_INIT, DBG_TRACE, "\n");\r\nreturn rtstatus;\r\n}

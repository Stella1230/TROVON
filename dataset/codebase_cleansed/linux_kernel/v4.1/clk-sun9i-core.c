static void sun9i_a80_get_pll4_factors(u32 *freq, u32 parent_rate,\r\nu8 *n_ret, u8 *k, u8 *m_ret, u8 *p_ret)\r\n{\r\nint n;\r\nint m = 1;\r\nint p = 1;\r\nn = DIV_ROUND_UP(*freq, 6000000);\r\nif (n > 255) {\r\nm = 0;\r\nn = (n + 1) / 2;\r\n}\r\nif (n > 255) {\r\np = 0;\r\nn = (n + 1) / 2;\r\n}\r\nif (n > 255)\r\nn = 255;\r\nelse if (n < 12)\r\nn = 12;\r\n*freq = ((24000000 * n) >> p) / (m + 1);\r\nif (n_ret == NULL)\r\nreturn;\r\n*n_ret = n;\r\n*m_ret = m;\r\n*p_ret = p;\r\n}\r\nstatic void __init sun9i_a80_pll4_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (!reg) {\r\npr_err("Could not get registers for a80-pll4-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_pll4_data,\r\n&sun9i_a80_pll4_lock, reg);\r\n}\r\nstatic void sun9i_a80_get_gt_factors(u32 *freq, u32 parent_rate,\r\nu8 *n, u8 *k, u8 *m, u8 *p)\r\n{\r\nu32 div;\r\nif (parent_rate < *freq)\r\n*freq = parent_rate;\r\ndiv = DIV_ROUND_UP(parent_rate, *freq);\r\nif (div > 4)\r\ndiv = 4;\r\n*freq = parent_rate / div;\r\nif (!m)\r\nreturn;\r\n*m = div;\r\n}\r\nstatic void __init sun9i_a80_gt_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nstruct clk *gt;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (!reg) {\r\npr_err("Could not get registers for a80-gt-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\ngt = sunxi_factors_register(node, &sun9i_a80_gt_data,\r\n&sun9i_a80_gt_lock, reg);\r\n__clk_get(gt);\r\nclk_prepare_enable(gt);\r\n}\r\nstatic void sun9i_a80_get_ahb_factors(u32 *freq, u32 parent_rate,\r\nu8 *n, u8 *k, u8 *m, u8 *p)\r\n{\r\nu32 _p;\r\nif (parent_rate < *freq)\r\n*freq = parent_rate;\r\n_p = order_base_2(DIV_ROUND_UP(parent_rate, *freq));\r\nif (_p > 3)\r\n_p = 3;\r\n*freq = parent_rate >> _p;\r\nif (!p)\r\nreturn;\r\n*p = _p;\r\n}\r\nstatic void __init sun9i_a80_ahb_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (!reg) {\r\npr_err("Could not get registers for a80-ahb-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_ahb_data,\r\n&sun9i_a80_ahb_lock, reg);\r\n}\r\nstatic void __init sun9i_a80_apb0_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (!reg) {\r\npr_err("Could not get registers for a80-apb0-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_apb0_data,\r\n&sun9i_a80_apb0_lock, reg);\r\n}\r\nstatic void sun9i_a80_get_apb1_factors(u32 *freq, u32 parent_rate,\r\nu8 *n, u8 *k, u8 *m, u8 *p)\r\n{\r\nu32 div;\r\nu8 calcm, calcp;\r\nif (parent_rate < *freq)\r\n*freq = parent_rate;\r\ndiv = DIV_ROUND_UP(parent_rate, *freq);\r\nif (div > 256)\r\ndiv = 256;\r\ncalcp = order_base_2(div);\r\ncalcm = (parent_rate >> calcp) - 1;\r\n*freq = (parent_rate >> calcp) / (calcm + 1);\r\nif (n == NULL)\r\nreturn;\r\n*m = calcm;\r\n*p = calcp;\r\n}\r\nstatic void __init sun9i_a80_apb1_setup(struct device_node *node)\r\n{\r\nvoid __iomem *reg;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (!reg) {\r\npr_err("Could not get registers for a80-apb1-clk: %s\n",\r\nnode->name);\r\nreturn;\r\n}\r\nsunxi_factors_register(node, &sun9i_a80_apb1_data,\r\n&sun9i_a80_apb1_lock, reg);\r\n}

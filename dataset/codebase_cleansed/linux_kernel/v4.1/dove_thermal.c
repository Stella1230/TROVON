static int dove_init_sensor(const struct dove_thermal_priv *priv)\r\n{\r\nu32 reg;\r\nu32 i;\r\nreg = readl_relaxed(priv->control);\r\nreg &= ~PMU_TDC0_AVG_NUM_MASK;\r\nreg |= (0x1 << PMU_TDC0_AVG_NUM_OFFS);\r\nreg &= ~PMU_TDC0_REF_CAL_CNT_MASK;\r\nreg |= (0x0F1 << PMU_TDC0_REF_CAL_CNT_OFFS);\r\nreg &= ~PMU_TDC0_SEL_VCAL_MASK;\r\nreg |= (0x2 << PMU_TDC0_SEL_VCAL_OFFS);\r\nwritel(reg, priv->control);\r\nreg = readl_relaxed(priv->control);\r\nwritel((reg | PMU_TDC0_SW_RST_MASK), priv->control);\r\nwritel(reg, priv->control);\r\nreg = readl_relaxed(priv->sensor);\r\nreg &= ~PMU_TM_DISABLE_MASK;\r\nwritel(reg, priv->sensor);\r\nfor (i = 0; i < 1000000; i++) {\r\nreg = readl_relaxed(priv->sensor);\r\nif (reg & DOVE_THERMAL_TEMP_MASK)\r\nbreak;\r\n}\r\nif (i == 1000000)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int dove_get_temp(struct thermal_zone_device *thermal,\r\nunsigned long *temp)\r\n{\r\nunsigned long reg;\r\nstruct dove_thermal_priv *priv = thermal->devdata;\r\nreg = readl_relaxed(priv->control + PMU_TEMP_DIOD_CTRL1_REG);\r\nif ((reg & PMU_TDC1_TEMP_VALID_MASK) == 0x0) {\r\ndev_err(&thermal->device,\r\n"Temperature sensor reading not valid\n");\r\nreturn -EIO;\r\n}\r\nreg = readl_relaxed(priv->sensor);\r\nreg = (reg >> DOVE_THERMAL_TEMP_OFFSET) & DOVE_THERMAL_TEMP_MASK;\r\n*temp = ((3220000000UL - (10000000UL * reg)) / 13625);\r\nreturn 0;\r\n}\r\nstatic int dove_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct thermal_zone_device *thermal = NULL;\r\nstruct dove_thermal_priv *priv;\r\nstruct resource *res;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->sensor = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->sensor))\r\nreturn PTR_ERR(priv->sensor);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\npriv->control = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->control))\r\nreturn PTR_ERR(priv->control);\r\nret = dove_init_sensor(priv);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to initialize sensor\n");\r\nreturn ret;\r\n}\r\nthermal = thermal_zone_device_register("dove_thermal", 0, 0,\r\npriv, &ops, NULL, 0, 0);\r\nif (IS_ERR(thermal)) {\r\ndev_err(&pdev->dev,\r\n"Failed to register thermal zone device\n");\r\nreturn PTR_ERR(thermal);\r\n}\r\nplatform_set_drvdata(pdev, thermal);\r\nreturn 0;\r\n}\r\nstatic int dove_thermal_exit(struct platform_device *pdev)\r\n{\r\nstruct thermal_zone_device *dove_thermal =\r\nplatform_get_drvdata(pdev);\r\nthermal_zone_device_unregister(dove_thermal);\r\nreturn 0;\r\n}

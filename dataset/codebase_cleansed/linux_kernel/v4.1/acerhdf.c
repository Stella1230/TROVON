static int acerhdf_get_temp(int *temp)\r\n{\r\nu8 read_temp;\r\nif (ec_read(bios_cfg->tempreg, &read_temp))\r\nreturn -EINVAL;\r\n*temp = read_temp * 1000;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_get_fanstate(int *state)\r\n{\r\nu8 fan;\r\nif (ec_read(bios_cfg->fanreg, &fan))\r\nreturn -EINVAL;\r\nif (fan != bios_cfg->cmd.cmd_off)\r\n*state = ACERHDF_FAN_AUTO;\r\nelse\r\n*state = ACERHDF_FAN_OFF;\r\nreturn 0;\r\n}\r\nstatic void acerhdf_change_fanstate(int state)\r\n{\r\nunsigned char cmd;\r\nif (verbose)\r\npr_notice("fan %s\n", state == ACERHDF_FAN_OFF ? "OFF" : "ON");\r\nif ((state != ACERHDF_FAN_OFF) && (state != ACERHDF_FAN_AUTO)) {\r\npr_err("invalid fan state %d requested, setting to auto!\n",\r\nstate);\r\nstate = ACERHDF_FAN_AUTO;\r\n}\r\ncmd = (state == ACERHDF_FAN_OFF) ? bios_cfg->cmd.cmd_off\r\n: bios_cfg->cmd.cmd_auto;\r\nfanstate = state;\r\nec_write(bios_cfg->fanreg, cmd);\r\nif (bios_cfg->mcmd_enable && state == ACERHDF_FAN_OFF) {\r\nif (verbose)\r\npr_notice("turning off fan manually\n");\r\nec_write(mcmd.mreg, mcmd.moff);\r\n}\r\n}\r\nstatic void acerhdf_check_param(struct thermal_zone_device *thermal)\r\n{\r\nif (fanon > ACERHDF_MAX_FANON) {\r\npr_err("fanon temperature too high, set to %d\n",\r\nACERHDF_MAX_FANON);\r\nfanon = ACERHDF_MAX_FANON;\r\n}\r\nif (kernelmode && prev_interval != interval) {\r\nif (interval > ACERHDF_MAX_INTERVAL) {\r\npr_err("interval too high, set to %d\n",\r\nACERHDF_MAX_INTERVAL);\r\ninterval = ACERHDF_MAX_INTERVAL;\r\n}\r\nif (verbose)\r\npr_notice("interval changed to: %d\n", interval);\r\nthermal->polling_delay = interval*1000;\r\nprev_interval = interval;\r\n}\r\n}\r\nstatic int acerhdf_get_ec_temp(struct thermal_zone_device *thermal,\r\nunsigned long *t)\r\n{\r\nint temp, err = 0;\r\nacerhdf_check_param(thermal);\r\nerr = acerhdf_get_temp(&temp);\r\nif (err)\r\nreturn err;\r\nif (verbose)\r\npr_notice("temp %d\n", temp);\r\n*t = temp;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_bind(struct thermal_zone_device *thermal,\r\nstruct thermal_cooling_device *cdev)\r\n{\r\nif (cdev != cl_dev)\r\nreturn 0;\r\nif (thermal_zone_bind_cooling_device(thermal, 0, cdev,\r\nTHERMAL_NO_LIMIT, THERMAL_NO_LIMIT)) {\r\npr_err("error binding cooling dev\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int acerhdf_unbind(struct thermal_zone_device *thermal,\r\nstruct thermal_cooling_device *cdev)\r\n{\r\nif (cdev != cl_dev)\r\nreturn 0;\r\nif (thermal_zone_unbind_cooling_device(thermal, 0, cdev)) {\r\npr_err("error unbinding cooling dev\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline void acerhdf_revert_to_bios_mode(void)\r\n{\r\nacerhdf_change_fanstate(ACERHDF_FAN_AUTO);\r\nkernelmode = 0;\r\nif (thz_dev)\r\nthz_dev->polling_delay = 0;\r\npr_notice("kernel mode fan control OFF\n");\r\n}\r\nstatic inline void acerhdf_enable_kernelmode(void)\r\n{\r\nkernelmode = 1;\r\nthz_dev->polling_delay = interval*1000;\r\nthermal_zone_device_update(thz_dev);\r\npr_notice("kernel mode fan control ON\n");\r\n}\r\nstatic int acerhdf_get_mode(struct thermal_zone_device *thermal,\r\nenum thermal_device_mode *mode)\r\n{\r\nif (verbose)\r\npr_notice("kernel mode fan control %d\n", kernelmode);\r\n*mode = (kernelmode) ? THERMAL_DEVICE_ENABLED\r\n: THERMAL_DEVICE_DISABLED;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_set_mode(struct thermal_zone_device *thermal,\r\nenum thermal_device_mode mode)\r\n{\r\nif (mode == THERMAL_DEVICE_DISABLED && kernelmode)\r\nacerhdf_revert_to_bios_mode();\r\nelse if (mode == THERMAL_DEVICE_ENABLED && !kernelmode)\r\nacerhdf_enable_kernelmode();\r\nreturn 0;\r\n}\r\nstatic int acerhdf_get_trip_type(struct thermal_zone_device *thermal, int trip,\r\nenum thermal_trip_type *type)\r\n{\r\nif (trip == 0)\r\n*type = THERMAL_TRIP_ACTIVE;\r\nelse if (trip == 1)\r\n*type = THERMAL_TRIP_CRITICAL;\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_get_trip_hyst(struct thermal_zone_device *thermal, int trip,\r\nunsigned long *temp)\r\n{\r\nif (trip != 0)\r\nreturn -EINVAL;\r\n*temp = fanon - fanoff;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_get_trip_temp(struct thermal_zone_device *thermal, int trip,\r\nunsigned long *temp)\r\n{\r\nif (trip == 0)\r\n*temp = fanon;\r\nelse if (trip == 1)\r\n*temp = ACERHDF_TEMP_CRIT;\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_get_crit_temp(struct thermal_zone_device *thermal,\r\nunsigned long *temperature)\r\n{\r\n*temperature = ACERHDF_TEMP_CRIT;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_get_max_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\n*state = 1;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_get_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\nint err = 0, tmp;\r\nerr = acerhdf_get_fanstate(&tmp);\r\nif (err)\r\nreturn err;\r\n*state = (tmp == ACERHDF_FAN_AUTO) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_set_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long state)\r\n{\r\nint cur_temp, cur_state, err = 0;\r\nif (!kernelmode)\r\nreturn 0;\r\nerr = acerhdf_get_temp(&cur_temp);\r\nif (err) {\r\npr_err("error reading temperature, hand off control to BIOS\n");\r\ngoto err_out;\r\n}\r\nerr = acerhdf_get_fanstate(&cur_state);\r\nif (err) {\r\npr_err("error reading fan state, hand off control to BIOS\n");\r\ngoto err_out;\r\n}\r\nif (state == 0) {\r\nif (cur_state == ACERHDF_FAN_AUTO)\r\nacerhdf_change_fanstate(ACERHDF_FAN_OFF);\r\n} else {\r\nif (cur_state == ACERHDF_FAN_OFF)\r\nacerhdf_change_fanstate(ACERHDF_FAN_AUTO);\r\n}\r\nreturn 0;\r\nerr_out:\r\nacerhdf_revert_to_bios_mode();\r\nreturn -EINVAL;\r\n}\r\nstatic int acerhdf_suspend(struct device *dev)\r\n{\r\nif (kernelmode)\r\nacerhdf_change_fanstate(ACERHDF_FAN_AUTO);\r\nif (verbose)\r\npr_notice("going suspend\n");\r\nreturn 0;\r\n}\r\nstatic int acerhdf_probe(struct platform_device *device)\r\n{\r\nreturn 0;\r\n}\r\nstatic int acerhdf_remove(struct platform_device *device)\r\n{\r\nreturn 0;\r\n}\r\nstatic int str_starts_with(const char *str, const char *start)\r\n{\r\nunsigned long str_len = 0, start_len = 0;\r\nstr_len = strlen(str);\r\nstart_len = strlen(start);\r\nif (str_len >= start_len &&\r\n!strncmp(str, start, start_len))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int acerhdf_check_hardware(void)\r\n{\r\nchar const *vendor, *version, *product;\r\nconst struct bios_settings *bt = NULL;\r\nvendor = dmi_get_system_info(DMI_SYS_VENDOR);\r\nversion = dmi_get_system_info(DMI_BIOS_VERSION);\r\nproduct = dmi_get_system_info(DMI_PRODUCT_NAME);\r\nif (!vendor || !version || !product) {\r\npr_err("error getting hardware information\n");\r\nreturn -EINVAL;\r\n}\r\npr_info("Acer Aspire One Fan driver, v.%s\n", DRV_VER);\r\nif (force_bios[0]) {\r\nversion = force_bios;\r\npr_info("forcing BIOS version: %s\n", version);\r\nkernelmode = 0;\r\n}\r\nif (force_product[0]) {\r\nproduct = force_product;\r\npr_info("forcing BIOS product: %s\n", product);\r\nkernelmode = 0;\r\n}\r\nif (verbose)\r\npr_info("BIOS info: %s %s, product: %s\n",\r\nvendor, version, product);\r\nfor (bt = bios_tbl; bt->vendor[0]; bt++) {\r\nif (str_starts_with(vendor, bt->vendor) &&\r\nstr_starts_with(product, bt->product) &&\r\nstr_starts_with(version, bt->version)) {\r\nbios_cfg = bt;\r\nbreak;\r\n}\r\n}\r\nif (!bios_cfg) {\r\npr_err("unknown (unsupported) BIOS version %s/%s/%s, please report, aborting!\n",\r\nvendor, product, version);\r\nreturn -EINVAL;\r\n}\r\nif (!kernelmode) {\r\npr_notice("Fan control off, to enable do:\n");\r\npr_notice("echo -n \"enabled\" > /sys/class/thermal/thermal_zone0/mode\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int acerhdf_register_platform(void)\r\n{\r\nint err = 0;\r\nerr = platform_driver_register(&acerhdf_driver);\r\nif (err)\r\nreturn err;\r\nacerhdf_dev = platform_device_alloc("acerhdf", -1);\r\nif (!acerhdf_dev) {\r\nerr = -ENOMEM;\r\ngoto err_device_alloc;\r\n}\r\nerr = platform_device_add(acerhdf_dev);\r\nif (err)\r\ngoto err_device_add;\r\nreturn 0;\r\nerr_device_add:\r\nplatform_device_put(acerhdf_dev);\r\nerr_device_alloc:\r\nplatform_driver_unregister(&acerhdf_driver);\r\nreturn err;\r\n}\r\nstatic void acerhdf_unregister_platform(void)\r\n{\r\nplatform_device_unregister(acerhdf_dev);\r\nplatform_driver_unregister(&acerhdf_driver);\r\n}\r\nstatic int acerhdf_register_thermal(void)\r\n{\r\ncl_dev = thermal_cooling_device_register("acerhdf-fan", NULL,\r\n&acerhdf_cooling_ops);\r\nif (IS_ERR(cl_dev))\r\nreturn -EINVAL;\r\nthz_dev = thermal_zone_device_register("acerhdf", 2, 0, NULL,\r\n&acerhdf_dev_ops,\r\n&acerhdf_zone_params, 0,\r\n(kernelmode) ? interval*1000 : 0);\r\nif (IS_ERR(thz_dev))\r\nreturn -EINVAL;\r\nif (strcmp(thz_dev->governor->name,\r\nacerhdf_zone_params.governor_name)) {\r\npr_err("Didn't get thermal governor %s, perhaps not compiled into thermal subsystem.\n",\r\nacerhdf_zone_params.governor_name);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void acerhdf_unregister_thermal(void)\r\n{\r\nif (cl_dev) {\r\nthermal_cooling_device_unregister(cl_dev);\r\ncl_dev = NULL;\r\n}\r\nif (thz_dev) {\r\nthermal_zone_device_unregister(thz_dev);\r\nthz_dev = NULL;\r\n}\r\n}\r\nstatic int __init acerhdf_init(void)\r\n{\r\nint err = 0;\r\nerr = acerhdf_check_hardware();\r\nif (err)\r\ngoto out_err;\r\nerr = acerhdf_register_platform();\r\nif (err)\r\ngoto out_err;\r\nerr = acerhdf_register_thermal();\r\nif (err)\r\ngoto err_unreg;\r\nreturn 0;\r\nerr_unreg:\r\nacerhdf_unregister_thermal();\r\nacerhdf_unregister_platform();\r\nout_err:\r\nreturn err;\r\n}\r\nstatic void __exit acerhdf_exit(void)\r\n{\r\nacerhdf_change_fanstate(ACERHDF_FAN_AUTO);\r\nacerhdf_unregister_thermal();\r\nacerhdf_unregister_platform();\r\n}

static inline u8 HT_CONFIG(ide_drive_t *drive)\r\n{\r\nreturn ((unsigned long)ide_get_drivedata(drive) & 0xff00) >> 8;\r\n}\r\nstatic inline u8 HT_TIMING(ide_drive_t *drive)\r\n{\r\nreturn (unsigned long)ide_get_drivedata(drive) & 0x00ff;\r\n}\r\nstatic void ht6560b_dev_select(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nunsigned long flags;\r\nstatic u8 current_select = 0;\r\nstatic u8 current_timing = 0;\r\nu8 select, timing;\r\nlocal_irq_save(flags);\r\nselect = HT_CONFIG(drive);\r\ntiming = HT_TIMING(drive);\r\nif (drive->media != ide_disk ||\r\n(drive->dev_flags & IDE_DFLAG_PRESENT) == 0)\r\nselect |= HT_PREFETCH_MODE;\r\nif (select != current_select || timing != current_timing) {\r\ncurrent_select = select;\r\ncurrent_timing = timing;\r\n(void)inb(HT_CONFIG_PORT);\r\n(void)inb(HT_CONFIG_PORT);\r\n(void)inb(HT_CONFIG_PORT);\r\n(void)inb(HT_CONFIG_PORT);\r\noutb(select, HT_CONFIG_PORT);\r\noutb(timing, hwif->io_ports.device_addr);\r\n(void)inb(hwif->io_ports.status_addr);\r\n#ifdef DEBUG\r\nprintk("ht6560b: %s: select=%#x timing=%#x\n",\r\ndrive->name, select, timing);\r\n#endif\r\n}\r\nlocal_irq_restore(flags);\r\noutb(drive->select | ATA_DEVICE_OBS, hwif->io_ports.device_addr);\r\n}\r\nstatic int __init try_to_init_ht6560b(void)\r\n{\r\nu8 orig_value;\r\nint i;\r\nif ((orig_value = inb(HT_CONFIG_PORT)) == 0xff)\r\nreturn 0;\r\nfor (i=3;i>0;i--) {\r\noutb(0x00, HT_CONFIG_PORT);\r\nif (!( (~inb(HT_CONFIG_PORT)) & 0x3f )) {\r\noutb(orig_value, HT_CONFIG_PORT);\r\nreturn 0;\r\n}\r\n}\r\noutb(0x00, HT_CONFIG_PORT);\r\nif ((~inb(HT_CONFIG_PORT))& 0x3f) {\r\noutb(orig_value, HT_CONFIG_PORT);\r\nreturn 0;\r\n}\r\noutb(HT_CONFIG_DEFAULT, HT_CONFIG_PORT);\r\noutb(HT_TIMING_DEFAULT, 0x1f6);\r\n(void)inb(0x1f7);\r\nprintk("ht6560b " HT6560B_VERSION\r\n": chipset detected and initialized"\r\n#ifdef DEBUG\r\n" with debug enabled"\r\n#endif\r\n"\n"\r\n);\r\nreturn 1;\r\n}\r\nstatic u8 ht_pio2timings(ide_drive_t *drive, const u8 pio)\r\n{\r\nint active_time, recovery_time;\r\nint active_cycles, recovery_cycles;\r\nint bus_speed = ide_vlb_clk ? ide_vlb_clk : 50;\r\nif (pio) {\r\nunsigned int cycle_time;\r\nstruct ide_timing *t = ide_timing_find_mode(XFER_PIO_0 + pio);\r\ncycle_time = ide_pio_cycle_time(drive, pio);\r\nactive_time = t->active;\r\nrecovery_time = cycle_time - active_time - t->setup;\r\nactive_cycles = (active_time * bus_speed + 999) / 1000;\r\nrecovery_cycles = (recovery_time * bus_speed + 999) / 1000;\r\nif (active_cycles < 2) active_cycles = 2;\r\nif (recovery_cycles < 2) recovery_cycles = 2;\r\nif (active_cycles > 15) active_cycles = 15;\r\nif (recovery_cycles > 15) recovery_cycles = 0;\r\n#ifdef DEBUG\r\nprintk("ht6560b: drive %s setting pio=%d recovery=%d (%dns) active=%d (%dns)\n", drive->name, pio, recovery_cycles, recovery_time, active_cycles, active_time);\r\n#endif\r\nreturn (u8)((recovery_cycles << 4) | active_cycles);\r\n} else {\r\n#ifdef DEBUG\r\nprintk("ht6560b: drive %s setting pio=0\n", drive->name);\r\n#endif\r\nreturn HT_TIMING_DEFAULT;\r\n}\r\n}\r\nstatic void ht_set_prefetch(ide_drive_t *drive, u8 state)\r\n{\r\nunsigned long flags, config;\r\nint t = HT_PREFETCH_MODE << 8;\r\nspin_lock_irqsave(&ht6560b_lock, flags);\r\nconfig = (unsigned long)ide_get_drivedata(drive);\r\nif (state) {\r\nconfig |= t;\r\ndrive->dev_flags |= IDE_DFLAG_NO_UNMASK;\r\ndrive->dev_flags &= ~IDE_DFLAG_UNMASK;\r\n} else {\r\nconfig &= ~t;\r\ndrive->dev_flags &= ~IDE_DFLAG_NO_UNMASK;\r\n}\r\nide_set_drivedata(drive, (void *)config);\r\nspin_unlock_irqrestore(&ht6560b_lock, flags);\r\n#ifdef DEBUG\r\nprintk("ht6560b: drive %s prefetch mode %sabled\n", drive->name, (state ? "en" : "dis"));\r\n#endif\r\n}\r\nstatic void ht6560b_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nunsigned long flags, config;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nu8 timing;\r\nswitch (pio) {\r\ncase 8:\r\ncase 9:\r\nht_set_prefetch(drive, pio & 1);\r\nreturn;\r\n}\r\ntiming = ht_pio2timings(drive, pio);\r\nspin_lock_irqsave(&ht6560b_lock, flags);\r\nconfig = (unsigned long)ide_get_drivedata(drive);\r\nconfig &= 0xff00;\r\nconfig |= timing;\r\nide_set_drivedata(drive, (void *)config);\r\nspin_unlock_irqrestore(&ht6560b_lock, flags);\r\n#ifdef DEBUG\r\nprintk("ht6560b: drive %s tuned to pio mode %#x timing=%#x\n", drive->name, pio, timing);\r\n#endif\r\n}\r\nstatic void __init ht6560b_init_dev(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nint t = (HT_CONFIG_DEFAULT << 8) | HT_TIMING_DEFAULT;\r\nif (hwif->channel)\r\nt |= (HT_SECONDARY_IF << 8);\r\nide_set_drivedata(drive, (void *)t);\r\n}\r\nstatic int __init ht6560b_init(void)\r\n{\r\nif (probe_ht6560b == 0)\r\nreturn -ENODEV;\r\nif (!request_region(HT_CONFIG_PORT, 1, DRV_NAME)) {\r\nprintk(KERN_NOTICE "%s: HT_CONFIG_PORT not found\n",\r\n__func__);\r\nreturn -ENODEV;\r\n}\r\nif (!try_to_init_ht6560b()) {\r\nprintk(KERN_NOTICE "%s: HBA not found\n", __func__);\r\ngoto release_region;\r\n}\r\nreturn ide_legacy_device_add(&ht6560b_port_info, 0);\r\nrelease_region:\r\nrelease_region(HT_CONFIG_PORT, 1);\r\nreturn -ENODEV;\r\n}

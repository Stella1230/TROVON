void libcfs_init_nidstrings(void)\r\n{\r\nspin_lock_init(&libcfs_nidstring_lock);\r\n}\r\nstatic char *\r\nlibcfs_next_nidstring(void)\r\n{\r\nchar *str;\r\nunsigned long flags;\r\nspin_lock_irqsave(&libcfs_nidstring_lock, flags);\r\nstr = libcfs_nidstrings[libcfs_nidstring_idx++];\r\nif (libcfs_nidstring_idx == ARRAY_SIZE(libcfs_nidstrings))\r\nlibcfs_nidstring_idx = 0;\r\nspin_unlock_irqrestore(&libcfs_nidstring_lock, flags);\r\nreturn str;\r\n}\r\nstatic int libcfs_lo_str2addr(const char *str, int nob, __u32 *addr)\r\n{\r\n*addr = 0;\r\nreturn 1;\r\n}\r\nstatic void libcfs_ip_addr2str(__u32 addr, char *str)\r\n{\r\nsnprintf(str, LNET_NIDSTR_SIZE, "%u.%u.%u.%u",\r\n(addr >> 24) & 0xff, (addr >> 16) & 0xff,\r\n(addr >> 8) & 0xff, addr & 0xff);\r\n}\r\nstatic int libcfs_ip_str2addr(const char *str, int nob, __u32 *addr)\r\n{\r\nunsigned int a;\r\nunsigned int b;\r\nunsigned int c;\r\nunsigned int d;\r\nint n = nob;\r\nif (sscanf(str, "%u.%u.%u.%u%n", &a, &b, &c, &d, &n) >= 4 &&\r\nn == nob &&\r\n(a & ~0xff) == 0 && (b & ~0xff) == 0 &&\r\n(c & ~0xff) == 0 && (d & ~0xff) == 0) {\r\n*addr = ((a<<24)|(b<<16)|(c<<8)|d);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void libcfs_decnum_addr2str(__u32 addr, char *str)\r\n{\r\nsnprintf(str, LNET_NIDSTR_SIZE, "%u", addr);\r\n}\r\nstatic void libcfs_hexnum_addr2str(__u32 addr, char *str)\r\n{\r\nsnprintf(str, LNET_NIDSTR_SIZE, "0x%x", addr);\r\n}\r\nstatic int libcfs_num_str2addr(const char *str, int nob, __u32 *addr)\r\n{\r\nint n;\r\nn = nob;\r\nif (sscanf(str, "0x%x%n", addr, &n) >= 1 && n == nob)\r\nreturn 1;\r\nn = nob;\r\nif (sscanf(str, "0X%x%n", addr, &n) >= 1 && n == nob)\r\nreturn 1;\r\nn = nob;\r\nif (sscanf(str, "%u%n", addr, &n) >= 1 && n == nob)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nlibcfs_num_parse(char *str, int len, struct list_head *list)\r\n{\r\nstruct cfs_expr_list *el;\r\nint rc;\r\nrc = cfs_expr_list_parse(str, len, 0, MAX_NUMERIC_VALUE, &el);\r\nif (rc == 0)\r\nlist_add_tail(&el->el_link, list);\r\nreturn rc;\r\n}\r\nstatic int\r\nlibcfs_num_match(__u32 addr, struct list_head *numaddr)\r\n{\r\nstruct cfs_expr_list *el;\r\nLASSERT(!list_empty(numaddr));\r\nel = list_entry(numaddr->next, struct cfs_expr_list, el_link);\r\nreturn cfs_expr_list_match(addr, el);\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_lnd2netstrfns(int lnd)\r\n{\r\nint i;\r\nif (lnd >= 0)\r\nfor (i = 0; i < libcfs_nnetstrfns; i++)\r\nif (lnd == libcfs_netstrfns[i].nf_type)\r\nreturn &libcfs_netstrfns[i];\r\nreturn NULL;\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_namenum2netstrfns(const char *name)\r\n{\r\nstruct netstrfns *nf;\r\nint i;\r\nfor (i = 0; i < libcfs_nnetstrfns; i++) {\r\nnf = &libcfs_netstrfns[i];\r\nif (nf->nf_type >= 0 &&\r\n!strncmp(name, nf->nf_name, strlen(nf->nf_name)))\r\nreturn nf;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_name2netstrfns(const char *name)\r\n{\r\nint i;\r\nfor (i = 0; i < libcfs_nnetstrfns; i++)\r\nif (libcfs_netstrfns[i].nf_type >= 0 &&\r\n!strcmp(libcfs_netstrfns[i].nf_name, name))\r\nreturn &libcfs_netstrfns[i];\r\nreturn NULL;\r\n}\r\nint\r\nlibcfs_isknown_lnd(int type)\r\n{\r\nreturn libcfs_lnd2netstrfns(type) != NULL;\r\n}\r\nchar *\r\nlibcfs_lnd2modname(int lnd)\r\n{\r\nstruct netstrfns *nf = libcfs_lnd2netstrfns(lnd);\r\nreturn (nf == NULL) ? NULL : nf->nf_modname;\r\n}\r\nchar *\r\nlibcfs_lnd2str(int lnd)\r\n{\r\nchar *str;\r\nstruct netstrfns *nf = libcfs_lnd2netstrfns(lnd);\r\nif (nf != NULL)\r\nreturn nf->nf_name;\r\nstr = libcfs_next_nidstring();\r\nsnprintf(str, LNET_NIDSTR_SIZE, "?%d?", lnd);\r\nreturn str;\r\n}\r\nint\r\nlibcfs_str2lnd(const char *str)\r\n{\r\nstruct netstrfns *nf = libcfs_name2netstrfns(str);\r\nif (nf != NULL)\r\nreturn nf->nf_type;\r\nreturn -1;\r\n}\r\nchar *\r\nlibcfs_net2str(__u32 net)\r\n{\r\nint lnd = LNET_NETTYP(net);\r\nint num = LNET_NETNUM(net);\r\nstruct netstrfns *nf = libcfs_lnd2netstrfns(lnd);\r\nchar *str = libcfs_next_nidstring();\r\nif (nf == NULL)\r\nsnprintf(str, LNET_NIDSTR_SIZE, "<%d:%d>", lnd, num);\r\nelse if (num == 0)\r\nsnprintf(str, LNET_NIDSTR_SIZE, "%s", nf->nf_name);\r\nelse\r\nsnprintf(str, LNET_NIDSTR_SIZE, "%s%d", nf->nf_name, num);\r\nreturn str;\r\n}\r\nchar *\r\nlibcfs_nid2str(lnet_nid_t nid)\r\n{\r\n__u32 addr = LNET_NIDADDR(nid);\r\n__u32 net = LNET_NIDNET(nid);\r\nint lnd = LNET_NETTYP(net);\r\nint nnum = LNET_NETNUM(net);\r\nstruct netstrfns *nf;\r\nchar *str;\r\nint nob;\r\nif (nid == LNET_NID_ANY)\r\nreturn "<?>";\r\nnf = libcfs_lnd2netstrfns(lnd);\r\nstr = libcfs_next_nidstring();\r\nif (nf == NULL)\r\nsnprintf(str, LNET_NIDSTR_SIZE, "%x@<%d:%d>", addr, lnd, nnum);\r\nelse {\r\nnf->nf_addr2str(addr, str);\r\nnob = strlen(str);\r\nif (nnum == 0)\r\nsnprintf(str + nob, LNET_NIDSTR_SIZE - nob, "@%s",\r\nnf->nf_name);\r\nelse\r\nsnprintf(str + nob, LNET_NIDSTR_SIZE - nob, "@%s%d",\r\nnf->nf_name, nnum);\r\n}\r\nreturn str;\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_str2net_internal(const char *str, __u32 *net)\r\n{\r\nstruct netstrfns *uninitialized_var(nf);\r\nint nob;\r\nunsigned int netnum;\r\nint i;\r\nfor (i = 0; i < libcfs_nnetstrfns; i++) {\r\nnf = &libcfs_netstrfns[i];\r\nif (nf->nf_type >= 0 &&\r\n!strncmp(str, nf->nf_name, strlen(nf->nf_name)))\r\nbreak;\r\n}\r\nif (i == libcfs_nnetstrfns)\r\nreturn NULL;\r\nnob = strlen(nf->nf_name);\r\nif (strlen(str) == (unsigned int)nob) {\r\nnetnum = 0;\r\n} else {\r\nif (nf->nf_type == LOLND)\r\nreturn NULL;\r\nstr += nob;\r\ni = strlen(str);\r\nif (sscanf(str, "%u%n", &netnum, &i) < 1 ||\r\ni != (int)strlen(str))\r\nreturn NULL;\r\n}\r\n*net = LNET_MKNET(nf->nf_type, netnum);\r\nreturn nf;\r\n}\r\n__u32\r\nlibcfs_str2net(const char *str)\r\n{\r\n__u32 net;\r\nif (libcfs_str2net_internal(str, &net) != NULL)\r\nreturn net;\r\nreturn LNET_NIDNET(LNET_NID_ANY);\r\n}\r\nlnet_nid_t\r\nlibcfs_str2nid(const char *str)\r\n{\r\nconst char *sep = strchr(str, '@');\r\nstruct netstrfns *nf;\r\n__u32 net;\r\n__u32 addr;\r\nif (sep != NULL) {\r\nnf = libcfs_str2net_internal(sep + 1, &net);\r\nif (nf == NULL)\r\nreturn LNET_NID_ANY;\r\n} else {\r\nsep = str + strlen(str);\r\nnet = LNET_MKNET(SOCKLND, 0);\r\nnf = libcfs_lnd2netstrfns(SOCKLND);\r\nLASSERT(nf != NULL);\r\n}\r\nif (!nf->nf_str2addr(str, (int)(sep - str), &addr))\r\nreturn LNET_NID_ANY;\r\nreturn LNET_MKNID(net, addr);\r\n}\r\nchar *\r\nlibcfs_id2str(lnet_process_id_t id)\r\n{\r\nchar *str = libcfs_next_nidstring();\r\nif (id.pid == LNET_PID_ANY) {\r\nsnprintf(str, LNET_NIDSTR_SIZE,\r\n"LNET_PID_ANY-%s", libcfs_nid2str(id.nid));\r\nreturn str;\r\n}\r\nsnprintf(str, LNET_NIDSTR_SIZE, "%s%u-%s",\r\n((id.pid & LNET_PID_USERFLAG) != 0) ? "U" : "",\r\n(id.pid & ~LNET_PID_USERFLAG), libcfs_nid2str(id.nid));\r\nreturn str;\r\n}\r\nint\r\nlibcfs_str2anynid(lnet_nid_t *nidp, const char *str)\r\n{\r\nif (!strcmp(str, "*")) {\r\n*nidp = LNET_NID_ANY;\r\nreturn 1;\r\n}\r\n*nidp = libcfs_str2nid(str);\r\nreturn *nidp != LNET_NID_ANY;\r\n}\r\nstatic int\r\nparse_addrange(const struct cfs_lstr *src, struct nidrange *nidrange)\r\n{\r\nstruct addrrange *addrrange;\r\nif (src->ls_len == 1 && src->ls_str[0] == '*') {\r\nnidrange->nr_all = 1;\r\nreturn 1;\r\n}\r\nLIBCFS_ALLOC(addrrange, sizeof(struct addrrange));\r\nif (addrrange == NULL)\r\nreturn 0;\r\nlist_add_tail(&addrrange->ar_link, &nidrange->nr_addrranges);\r\nINIT_LIST_HEAD(&addrrange->ar_numaddr_ranges);\r\nreturn nidrange->nr_netstrfns->nf_parse_addrlist(src->ls_str,\r\nsrc->ls_len,\r\n&addrrange->ar_numaddr_ranges);\r\n}\r\nstatic struct nidrange *\r\nadd_nidrange(const struct cfs_lstr *src,\r\nstruct list_head *nidlist)\r\n{\r\nstruct netstrfns *nf;\r\nstruct nidrange *nr;\r\nint endlen;\r\nunsigned netnum;\r\nif (src->ls_len >= LNET_NIDSTR_SIZE)\r\nreturn NULL;\r\nnf = libcfs_namenum2netstrfns(src->ls_str);\r\nif (nf == NULL)\r\nreturn NULL;\r\nendlen = src->ls_len - strlen(nf->nf_name);\r\nif (endlen == 0)\r\nnetnum = 0;\r\nelse {\r\nif (!cfs_str2num_check(src->ls_str + strlen(nf->nf_name),\r\nendlen, &netnum, 0, MAX_NUMERIC_VALUE))\r\nreturn NULL;\r\n}\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nif (nr->nr_netstrfns != nf)\r\ncontinue;\r\nif (nr->nr_netnum != netnum)\r\ncontinue;\r\nreturn nr;\r\n}\r\nLIBCFS_ALLOC(nr, sizeof(struct nidrange));\r\nif (nr == NULL)\r\nreturn NULL;\r\nlist_add_tail(&nr->nr_link, nidlist);\r\nINIT_LIST_HEAD(&nr->nr_addrranges);\r\nnr->nr_netstrfns = nf;\r\nnr->nr_all = 0;\r\nnr->nr_netnum = netnum;\r\nreturn nr;\r\n}\r\nstatic int\r\nparse_nidrange(struct cfs_lstr *src, struct list_head *nidlist)\r\n{\r\nstruct cfs_lstr addrrange;\r\nstruct cfs_lstr net;\r\nstruct cfs_lstr tmp;\r\nstruct nidrange *nr;\r\ntmp = *src;\r\nif (cfs_gettok(src, '@', &addrrange) == 0)\r\ngoto failed;\r\nif (cfs_gettok(src, '@', &net) == 0 || src->ls_str != NULL)\r\ngoto failed;\r\nnr = add_nidrange(&net, nidlist);\r\nif (nr == NULL)\r\ngoto failed;\r\nif (parse_addrange(&addrrange, nr) != 0)\r\ngoto failed;\r\nreturn 1;\r\nfailed:\r\nCWARN("can't parse nidrange: \"%.*s\"\n", tmp.ls_len, tmp.ls_str);\r\nreturn 0;\r\n}\r\nstatic void\r\nfree_addrranges(struct list_head *list)\r\n{\r\nwhile (!list_empty(list)) {\r\nstruct addrrange *ar;\r\nar = list_entry(list->next, struct addrrange, ar_link);\r\ncfs_expr_list_free_list(&ar->ar_numaddr_ranges);\r\nlist_del(&ar->ar_link);\r\nLIBCFS_FREE(ar, sizeof(struct addrrange));\r\n}\r\n}\r\nvoid\r\ncfs_free_nidlist(struct list_head *list)\r\n{\r\nstruct list_head *pos, *next;\r\nstruct nidrange *nr;\r\nlist_for_each_safe(pos, next, list) {\r\nnr = list_entry(pos, struct nidrange, nr_link);\r\nfree_addrranges(&nr->nr_addrranges);\r\nlist_del(pos);\r\nLIBCFS_FREE(nr, sizeof(struct nidrange));\r\n}\r\n}\r\nint\r\ncfs_parse_nidlist(char *str, int len, struct list_head *nidlist)\r\n{\r\nstruct cfs_lstr src;\r\nstruct cfs_lstr res;\r\nint rc;\r\nsrc.ls_str = str;\r\nsrc.ls_len = len;\r\nINIT_LIST_HEAD(nidlist);\r\nwhile (src.ls_str) {\r\nrc = cfs_gettok(&src, ' ', &res);\r\nif (rc == 0) {\r\ncfs_free_nidlist(nidlist);\r\nreturn 0;\r\n}\r\nrc = parse_nidrange(&res, nidlist);\r\nif (rc == 0) {\r\ncfs_free_nidlist(nidlist);\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nint cfs_match_nid(lnet_nid_t nid, struct list_head *nidlist)\r\n{\r\nstruct nidrange *nr;\r\nstruct addrrange *ar;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nif (nr->nr_netstrfns->nf_type != LNET_NETTYP(LNET_NIDNET(nid)))\r\ncontinue;\r\nif (nr->nr_netnum != LNET_NETNUM(LNET_NIDNET(nid)))\r\ncontinue;\r\nif (nr->nr_all)\r\nreturn 1;\r\nlist_for_each_entry(ar, &nr->nr_addrranges, ar_link)\r\nif (nr->nr_netstrfns->nf_match_addr(LNET_NIDADDR(nid),\r\n&ar->ar_numaddr_ranges))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

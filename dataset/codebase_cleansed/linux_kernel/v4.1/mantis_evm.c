static void mantis_hifevm_work(struct work_struct *work)\r\n{\r\nstruct mantis_ca *ca = container_of(work, struct mantis_ca, hif_evm_work);\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 gpif_stat;\r\ngpif_stat = mmread(MANTIS_GPIF_STATUS);\r\nif (gpif_stat & MANTIS_GPIF_DETSTAT) {\r\nif (gpif_stat & MANTIS_CARD_PLUGIN) {\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): CAM Plugin", mantis->num);\r\nmmwrite(0xdada0000, MANTIS_CARD_RESET);\r\nmantis_event_cam_plugin(ca);\r\ndvb_ca_en50221_camchange_irq(&ca->en50221,\r\n0,\r\nDVB_CA_EN50221_CAMCHANGE_INSERTED);\r\n}\r\n} else {\r\nif (gpif_stat & MANTIS_CARD_PLUGOUT) {\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): CAM Unplug", mantis->num);\r\nmmwrite(0xdada0000, MANTIS_CARD_RESET);\r\nmantis_event_cam_unplug(ca);\r\ndvb_ca_en50221_camchange_irq(&ca->en50221,\r\n0,\r\nDVB_CA_EN50221_CAMCHANGE_REMOVED);\r\n}\r\n}\r\nif (mantis->gpif_status & MANTIS_GPIF_EXTIRQ)\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): Ext IRQ", mantis->num);\r\nif (mantis->gpif_status & MANTIS_SBUF_WSTO)\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): Smart Buffer Timeout", mantis->num);\r\nif (mantis->gpif_status & MANTIS_GPIF_OTHERR)\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): Alignment Error", mantis->num);\r\nif (gpif_stat & MANTIS_SBUF_OVFLW)\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): Smart Buffer Overflow", mantis->num);\r\nif (gpif_stat & MANTIS_GPIF_BRRDY)\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): Smart Buffer Read Ready", mantis->num);\r\nif (gpif_stat & MANTIS_GPIF_INTSTAT)\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): GPIF IRQ", mantis->num);\r\nif (gpif_stat & MANTIS_SBUF_EMPTY)\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): Smart Buffer Empty", mantis->num);\r\nif (gpif_stat & MANTIS_SBUF_OPDONE) {\r\ndprintk(MANTIS_DEBUG, 1, "Event Mgr: Adapter(%d) Slot(0): Smart Buffer operation complete", mantis->num);\r\nca->sbuf_status = MANTIS_SBUF_DATA_AVAIL;\r\nca->hif_event = MANTIS_SBUF_OPDONE;\r\nwake_up(&ca->hif_opdone_wq);\r\n}\r\n}\r\nint mantis_evmgr_init(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Initializing Mantis Host I/F Event manager");\r\nINIT_WORK(&ca->hif_evm_work, mantis_hifevm_work);\r\nmantis_pcmcia_init(ca);\r\nschedule_work(&ca->hif_evm_work);\r\nmantis_hif_init(ca);\r\nreturn 0;\r\n}\r\nvoid mantis_evmgr_exit(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Mantis Host I/F Event manager exiting");\r\nflush_work(&ca->hif_evm_work);\r\nmantis_hif_exit(ca);\r\nmantis_pcmcia_exit(ca);\r\n}

static int read_reset_stat(struct ctl_table *table, int write,\r\nvoid __user *buffer, size_t *lenp,\r\nloff_t *ppos)\r\n{\r\natomic_t *stat = (atomic_t *)table->data;\r\nif (!stat)\r\nreturn -EINVAL;\r\nif (write)\r\natomic_set(stat, 0);\r\nelse {\r\nchar str_buf[32];\r\nchar *data;\r\nint len = snprintf(str_buf, 32, "%d\n", atomic_read(stat));\r\nif (len >= 32)\r\nreturn -EFAULT;\r\nlen = strlen(str_buf);\r\nif (*ppos > len) {\r\n*lenp = 0;\r\nreturn 0;\r\n}\r\ndata = &str_buf[*ppos];\r\nlen -= *ppos;\r\nif (len > *lenp)\r\nlen = *lenp;\r\nif (len && copy_to_user(buffer, str_buf, len))\r\nreturn -EFAULT;\r\n*lenp = len;\r\n*ppos += len;\r\n}\r\nreturn 0;\r\n}\r\nvoid svc_rdma_cleanup(void)\r\n{\r\ndprintk("SVCRDMA Module Removed, deregister RPC RDMA transport\n");\r\ndestroy_workqueue(svc_rdma_wq);\r\nif (svcrdma_table_header) {\r\nunregister_sysctl_table(svcrdma_table_header);\r\nsvcrdma_table_header = NULL;\r\n}\r\nsvc_unreg_xprt_class(&svc_rdma_class);\r\nkmem_cache_destroy(svc_rdma_map_cachep);\r\nkmem_cache_destroy(svc_rdma_ctxt_cachep);\r\n}\r\nint svc_rdma_init(void)\r\n{\r\ndprintk("SVCRDMA Module Init, register RPC RDMA transport\n");\r\ndprintk("\tsvcrdma_ord : %d\n", svcrdma_ord);\r\ndprintk("\tmax_requests : %d\n", svcrdma_max_requests);\r\ndprintk("\tsq_depth : %d\n",\r\nsvcrdma_max_requests * RPCRDMA_SQ_DEPTH_MULT);\r\ndprintk("\tmax_inline : %d\n", svcrdma_max_req_size);\r\nsvc_rdma_wq = alloc_workqueue("svc_rdma", 0, 0);\r\nif (!svc_rdma_wq)\r\nreturn -ENOMEM;\r\nif (!svcrdma_table_header)\r\nsvcrdma_table_header =\r\nregister_sysctl_table(svcrdma_root_table);\r\nsvc_rdma_map_cachep = kmem_cache_create("svc_rdma_map_cache",\r\nsizeof(struct svc_rdma_req_map),\r\n0,\r\nSLAB_HWCACHE_ALIGN,\r\nNULL);\r\nif (!svc_rdma_map_cachep) {\r\nprintk(KERN_INFO "Could not allocate map cache.\n");\r\ngoto err0;\r\n}\r\nsvc_rdma_ctxt_cachep =\r\nkmem_cache_create("svc_rdma_ctxt_cache",\r\nsizeof(struct svc_rdma_op_ctxt),\r\n0,\r\nSLAB_HWCACHE_ALIGN,\r\nNULL);\r\nif (!svc_rdma_ctxt_cachep) {\r\nprintk(KERN_INFO "Could not allocate WR ctxt cache.\n");\r\ngoto err1;\r\n}\r\nsvc_reg_xprt_class(&svc_rdma_class);\r\nreturn 0;\r\nerr1:\r\nkmem_cache_destroy(svc_rdma_map_cachep);\r\nerr0:\r\nunregister_sysctl_table(svcrdma_table_header);\r\ndestroy_workqueue(svc_rdma_wq);\r\nreturn -ENOMEM;\r\n}

u64 hw_nmi_get_sample_period(int watchdog_thresh)\r\n{\r\nreturn (u64)(cpu_khz) * 1000 * watchdog_thresh;\r\n}\r\nstatic void print_seq_line(struct nmi_seq_buf *s, int start, int end)\r\n{\r\nconst char *buf = s->buffer + start;\r\nprintk("%.*s", (end - start) + 1, buf);\r\n}\r\nvoid arch_trigger_all_cpu_backtrace(bool include_self)\r\n{\r\nstruct nmi_seq_buf *s;\r\nint len;\r\nint cpu;\r\nint i;\r\nint this_cpu = get_cpu();\r\nif (test_and_set_bit(0, &backtrace_flag)) {\r\nput_cpu();\r\nreturn;\r\n}\r\ncpumask_copy(to_cpumask(backtrace_mask), cpu_online_mask);\r\nif (!include_self)\r\ncpumask_clear_cpu(this_cpu, to_cpumask(backtrace_mask));\r\ncpumask_copy(&printtrace_mask, to_cpumask(backtrace_mask));\r\nfor_each_cpu(cpu, to_cpumask(backtrace_mask)) {\r\ns = &per_cpu(nmi_print_seq, cpu);\r\nseq_buf_init(&s->seq, s->buffer, NMI_BUF_SIZE);\r\n}\r\nif (!cpumask_empty(to_cpumask(backtrace_mask))) {\r\npr_info("sending NMI to %s CPUs:\n",\r\n(include_self ? "all" : "other"));\r\napic->send_IPI_mask(to_cpumask(backtrace_mask), NMI_VECTOR);\r\n}\r\nfor (i = 0; i < 10 * 1000; i++) {\r\nif (cpumask_empty(to_cpumask(backtrace_mask)))\r\nbreak;\r\nmdelay(1);\r\ntouch_softlockup_watchdog();\r\n}\r\nfor_each_cpu(cpu, &printtrace_mask) {\r\nint last_i = 0;\r\ns = &per_cpu(nmi_print_seq, cpu);\r\nlen = seq_buf_used(&s->seq);\r\nif (!len)\r\ncontinue;\r\nfor (i = 0; i < len; i++) {\r\nif (s->buffer[i] == '\n') {\r\nprint_seq_line(s, last_i, i);\r\nlast_i = i + 1;\r\n}\r\n}\r\nif (last_i < len) {\r\nprint_seq_line(s, last_i, len - 1);\r\npr_cont("\n");\r\n}\r\n}\r\nclear_bit(0, &backtrace_flag);\r\nsmp_mb__after_atomic();\r\nput_cpu();\r\n}\r\nstatic int nmi_vprintk(const char *fmt, va_list args)\r\n{\r\nstruct nmi_seq_buf *s = this_cpu_ptr(&nmi_print_seq);\r\nunsigned int len = seq_buf_used(&s->seq);\r\nseq_buf_vprintf(&s->seq, fmt, args);\r\nreturn seq_buf_used(&s->seq) - len;\r\n}\r\nstatic int\r\narch_trigger_all_cpu_backtrace_handler(unsigned int cmd, struct pt_regs *regs)\r\n{\r\nint cpu;\r\ncpu = smp_processor_id();\r\nif (cpumask_test_cpu(cpu, to_cpumask(backtrace_mask))) {\r\nprintk_func_t printk_func_save = this_cpu_read(printk_func);\r\nthis_cpu_write(printk_func, nmi_vprintk);\r\nprintk(KERN_WARNING "NMI backtrace for cpu %d\n", cpu);\r\nshow_regs(regs);\r\nthis_cpu_write(printk_func, printk_func_save);\r\ncpumask_clear_cpu(cpu, to_cpumask(backtrace_mask));\r\nreturn NMI_HANDLED;\r\n}\r\nreturn NMI_DONE;\r\n}\r\nstatic int __init register_trigger_all_cpu_backtrace(void)\r\n{\r\nregister_nmi_handler(NMI_LOCAL, arch_trigger_all_cpu_backtrace_handler,\r\n0, "arch_bt");\r\nreturn 0;\r\n}

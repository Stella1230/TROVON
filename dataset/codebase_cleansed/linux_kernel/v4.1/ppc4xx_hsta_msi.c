static int hsta_setup_msi_irqs(struct pci_dev *dev, int nvec, int type)\r\n{\r\nstruct msi_msg msg;\r\nstruct msi_desc *entry;\r\nint irq, hwirq;\r\nu64 addr;\r\nif (type == PCI_CAP_ID_MSIX) {\r\npr_debug("%s: MSI-X not supported.\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nlist_for_each_entry(entry, &dev->msi_list, list) {\r\nirq = msi_bitmap_alloc_hwirqs(&ppc4xx_hsta_msi.bmp, 1);\r\nif (irq < 0) {\r\npr_debug("%s: Failed to allocate msi interrupt\n",\r\n__func__);\r\nreturn irq;\r\n}\r\nhwirq = ppc4xx_hsta_msi.irq_map[irq];\r\nif (hwirq == NO_IRQ) {\r\npr_err("%s: Failed mapping irq %d\n", __func__, irq);\r\nreturn -EINVAL;\r\n}\r\naddr = ppc4xx_hsta_msi.address + irq*0x10;\r\nmsg.address_hi = upper_32_bits(addr);\r\nmsg.address_lo = lower_32_bits(addr);\r\nmsg.data = 0;\r\npr_debug("%s: Setup irq %d (0x%0llx)\n", __func__, hwirq,\r\n(((u64) msg.address_hi) << 32) | msg.address_lo);\r\nif (irq_set_msi_desc(hwirq, entry)) {\r\npr_err(\r\n"%s: Invalid hwirq %d specified in device tree\n",\r\n__func__, hwirq);\r\nmsi_bitmap_free_hwirqs(&ppc4xx_hsta_msi.bmp, irq, 1);\r\nreturn -EINVAL;\r\n}\r\npci_write_msi_msg(hwirq, &msg);\r\n}\r\nreturn 0;\r\n}\r\nstatic int hsta_find_hwirq_offset(int hwirq)\r\n{\r\nint irq;\r\nfor (irq = 0; irq < ppc4xx_hsta_msi.irq_count; irq++)\r\nif (ppc4xx_hsta_msi.irq_map[irq] == hwirq)\r\nreturn irq;\r\nreturn -EINVAL;\r\n}\r\nstatic void hsta_teardown_msi_irqs(struct pci_dev *dev)\r\n{\r\nstruct msi_desc *entry;\r\nint irq;\r\nlist_for_each_entry(entry, &dev->msi_list, list) {\r\nif (entry->irq == NO_IRQ)\r\ncontinue;\r\nirq = hsta_find_hwirq_offset(entry->irq);\r\nBUG_ON(irq < 0);\r\nirq_set_msi_desc(entry->irq, NULL);\r\nmsi_bitmap_free_hwirqs(&ppc4xx_hsta_msi.bmp, irq, 1);\r\npr_debug("%s: Teardown IRQ %u (index %u)\n", __func__,\r\nentry->irq, irq);\r\n}\r\n}\r\nstatic int hsta_msi_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *mem;\r\nint irq, ret, irq_count;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (IS_ERR(mem)) {\r\ndev_err(dev, "Unable to get mmio space\n");\r\nreturn -EINVAL;\r\n}\r\nirq_count = of_irq_count(dev->of_node);\r\nif (!irq_count) {\r\ndev_err(dev, "Unable to find IRQ range\n");\r\nreturn -EINVAL;\r\n}\r\nppc4xx_hsta_msi.dev = dev;\r\nppc4xx_hsta_msi.address = mem->start;\r\nppc4xx_hsta_msi.data = ioremap(mem->start, resource_size(mem));\r\nppc4xx_hsta_msi.irq_count = irq_count;\r\nif (!ppc4xx_hsta_msi.data) {\r\ndev_err(dev, "Unable to map memory\n");\r\nreturn -ENOMEM;\r\n}\r\nret = msi_bitmap_alloc(&ppc4xx_hsta_msi.bmp, irq_count, dev->of_node);\r\nif (ret)\r\ngoto out;\r\nppc4xx_hsta_msi.irq_map = kmalloc(sizeof(int) * irq_count, GFP_KERNEL);\r\nif (IS_ERR(ppc4xx_hsta_msi.irq_map)) {\r\nret = -ENOMEM;\r\ngoto out1;\r\n}\r\nfor (irq = 0; irq < irq_count; irq++) {\r\nppc4xx_hsta_msi.irq_map[irq] =\r\nirq_of_parse_and_map(dev->of_node, irq);\r\nif (ppc4xx_hsta_msi.irq_map[irq] == NO_IRQ) {\r\ndev_err(dev, "Unable to map IRQ\n");\r\nret = -EINVAL;\r\ngoto out2;\r\n}\r\n}\r\nppc_md.setup_msi_irqs = hsta_setup_msi_irqs;\r\nppc_md.teardown_msi_irqs = hsta_teardown_msi_irqs;\r\nreturn 0;\r\nout2:\r\nkfree(ppc4xx_hsta_msi.irq_map);\r\nout1:\r\nmsi_bitmap_free(&ppc4xx_hsta_msi.bmp);\r\nout:\r\niounmap(ppc4xx_hsta_msi.data);\r\nreturn ret;\r\n}\r\nstatic int hsta_msi_init(void)\r\n{\r\nreturn platform_driver_register(&hsta_msi_driver);\r\n}

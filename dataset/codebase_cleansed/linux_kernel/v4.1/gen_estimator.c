static void est_timer(unsigned long arg)\r\n{\r\nint idx = (int)arg;\r\nstruct gen_estimator *e;\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(e, &elist[idx].list, list) {\r\nstruct gnet_stats_basic_packed b = {0};\r\nu64 brate;\r\nu32 rate;\r\nspin_lock(e->stats_lock);\r\nread_lock(&est_lock);\r\nif (e->bstats == NULL)\r\ngoto skip;\r\n__gnet_stats_copy_basic(&b, e->cpu_bstats, e->bstats);\r\nbrate = (b.bytes - e->last_bytes)<<(7 - idx);\r\ne->last_bytes = b.bytes;\r\ne->avbps += (brate >> e->ewma_log) - (e->avbps >> e->ewma_log);\r\ne->rate_est->bps = (e->avbps+0xF)>>5;\r\nrate = (b.packets - e->last_packets)<<(12 - idx);\r\ne->last_packets = b.packets;\r\ne->avpps += (rate >> e->ewma_log) - (e->avpps >> e->ewma_log);\r\ne->rate_est->pps = (e->avpps+0x1FF)>>10;\r\nskip:\r\nread_unlock(&est_lock);\r\nspin_unlock(e->stats_lock);\r\n}\r\nif (!list_empty(&elist[idx].list))\r\nmod_timer(&elist[idx].timer, jiffies + ((HZ/4) << idx));\r\nrcu_read_unlock();\r\n}\r\nstatic void gen_add_node(struct gen_estimator *est)\r\n{\r\nstruct rb_node **p = &est_root.rb_node, *parent = NULL;\r\nwhile (*p) {\r\nstruct gen_estimator *e;\r\nparent = *p;\r\ne = rb_entry(parent, struct gen_estimator, node);\r\nif (est->bstats > e->bstats)\r\np = &parent->rb_right;\r\nelse\r\np = &parent->rb_left;\r\n}\r\nrb_link_node(&est->node, parent, p);\r\nrb_insert_color(&est->node, &est_root);\r\n}\r\nstatic\r\nstruct gen_estimator *gen_find_node(const struct gnet_stats_basic_packed *bstats,\r\nconst struct gnet_stats_rate_est64 *rate_est)\r\n{\r\nstruct rb_node *p = est_root.rb_node;\r\nwhile (p) {\r\nstruct gen_estimator *e;\r\ne = rb_entry(p, struct gen_estimator, node);\r\nif (bstats > e->bstats)\r\np = p->rb_right;\r\nelse if (bstats < e->bstats || rate_est != e->rate_est)\r\np = p->rb_left;\r\nelse\r\nreturn e;\r\n}\r\nreturn NULL;\r\n}\r\nint gen_new_estimator(struct gnet_stats_basic_packed *bstats,\r\nstruct gnet_stats_basic_cpu __percpu *cpu_bstats,\r\nstruct gnet_stats_rate_est64 *rate_est,\r\nspinlock_t *stats_lock,\r\nstruct nlattr *opt)\r\n{\r\nstruct gen_estimator *est;\r\nstruct gnet_estimator *parm = nla_data(opt);\r\nstruct gnet_stats_basic_packed b = {0};\r\nint idx;\r\nif (nla_len(opt) < sizeof(*parm))\r\nreturn -EINVAL;\r\nif (parm->interval < -2 || parm->interval > 3)\r\nreturn -EINVAL;\r\nest = kzalloc(sizeof(*est), GFP_KERNEL);\r\nif (est == NULL)\r\nreturn -ENOBUFS;\r\n__gnet_stats_copy_basic(&b, cpu_bstats, bstats);\r\nidx = parm->interval + 2;\r\nest->bstats = bstats;\r\nest->rate_est = rate_est;\r\nest->stats_lock = stats_lock;\r\nest->ewma_log = parm->ewma_log;\r\nest->last_bytes = b.bytes;\r\nest->avbps = rate_est->bps<<5;\r\nest->last_packets = b.packets;\r\nest->avpps = rate_est->pps<<10;\r\nest->cpu_bstats = cpu_bstats;\r\nspin_lock_bh(&est_tree_lock);\r\nif (!elist[idx].timer.function) {\r\nINIT_LIST_HEAD(&elist[idx].list);\r\nsetup_timer(&elist[idx].timer, est_timer, idx);\r\n}\r\nif (list_empty(&elist[idx].list))\r\nmod_timer(&elist[idx].timer, jiffies + ((HZ/4) << idx));\r\nlist_add_rcu(&est->list, &elist[idx].list);\r\ngen_add_node(est);\r\nspin_unlock_bh(&est_tree_lock);\r\nreturn 0;\r\n}\r\nvoid gen_kill_estimator(struct gnet_stats_basic_packed *bstats,\r\nstruct gnet_stats_rate_est64 *rate_est)\r\n{\r\nstruct gen_estimator *e;\r\nspin_lock_bh(&est_tree_lock);\r\nwhile ((e = gen_find_node(bstats, rate_est))) {\r\nrb_erase(&e->node, &est_root);\r\nwrite_lock(&est_lock);\r\ne->bstats = NULL;\r\nwrite_unlock(&est_lock);\r\nlist_del_rcu(&e->list);\r\nkfree_rcu(e, e_rcu);\r\n}\r\nspin_unlock_bh(&est_tree_lock);\r\n}\r\nint gen_replace_estimator(struct gnet_stats_basic_packed *bstats,\r\nstruct gnet_stats_basic_cpu __percpu *cpu_bstats,\r\nstruct gnet_stats_rate_est64 *rate_est,\r\nspinlock_t *stats_lock, struct nlattr *opt)\r\n{\r\ngen_kill_estimator(bstats, rate_est);\r\nreturn gen_new_estimator(bstats, cpu_bstats, rate_est, stats_lock, opt);\r\n}\r\nbool gen_estimator_active(const struct gnet_stats_basic_packed *bstats,\r\nconst struct gnet_stats_rate_est64 *rate_est)\r\n{\r\nbool res;\r\nASSERT_RTNL();\r\nspin_lock_bh(&est_tree_lock);\r\nres = gen_find_node(bstats, rate_est) != NULL;\r\nspin_unlock_bh(&est_tree_lock);\r\nreturn res;\r\n}

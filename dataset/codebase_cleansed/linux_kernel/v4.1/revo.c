static void revo_i2s_mclk_changed(struct snd_ice1712 *ice)\r\n{\r\noutb(inb(ICEMT1724(ice, AC97_CMD)) | 0x80, ICEMT1724(ice, AC97_CMD));\r\nmdelay(5);\r\noutb(inb(ICEMT1724(ice, AC97_CMD)) & ~0x80, ICEMT1724(ice, AC97_CMD));\r\n}\r\nstatic void revo_set_rate_val(struct snd_akm4xxx *ak, unsigned int rate)\r\n{\r\nunsigned char old, tmp, dfs;\r\nint reg, shift;\r\nif (rate == 0)\r\nreturn;\r\nif (rate > 96000)\r\ndfs = 2;\r\nelse if (rate > 48000)\r\ndfs = 1;\r\nelse\r\ndfs = 0;\r\nif (ak->type == SND_AK4355 || ak->type == SND_AK4358) {\r\nreg = 2;\r\nshift = 4;\r\n} else {\r\nreg = 1;\r\nshift = 3;\r\n}\r\ntmp = snd_akm4xxx_get(ak, 0, reg);\r\nold = (tmp >> shift) & 0x03;\r\nif (old == dfs)\r\nreturn;\r\nsnd_akm4xxx_reset(ak, 1);\r\ntmp = snd_akm4xxx_get(ak, 0, reg);\r\ntmp &= ~(0x03 << shift);\r\ntmp |= dfs << shift;\r\nsnd_akm4xxx_set(ak, 0, reg, tmp);\r\nsnd_akm4xxx_reset(ak, 0);\r\n}\r\nstatic void revo_i2c_start(struct snd_i2c_bus *bus)\r\n{\r\nstruct snd_ice1712 *ice = bus->private_data;\r\nsnd_ice1712_save_gpio_status(ice);\r\n}\r\nstatic void revo_i2c_stop(struct snd_i2c_bus *bus)\r\n{\r\nstruct snd_ice1712 *ice = bus->private_data;\r\nsnd_ice1712_restore_gpio_status(ice);\r\n}\r\nstatic void revo_i2c_direction(struct snd_i2c_bus *bus, int clock, int data)\r\n{\r\nstruct snd_ice1712 *ice = bus->private_data;\r\nunsigned int mask, val;\r\nval = 0;\r\nif (clock)\r\nval |= VT1724_REVO_I2C_CLOCK;\r\nif (data)\r\nval |= VT1724_REVO_I2C_DATA;\r\nmask = VT1724_REVO_I2C_CLOCK | VT1724_REVO_I2C_DATA;\r\nice->gpio.direction &= ~mask;\r\nice->gpio.direction |= val;\r\nsnd_ice1712_gpio_set_dir(ice, ice->gpio.direction);\r\nsnd_ice1712_gpio_set_mask(ice, ~mask);\r\n}\r\nstatic void revo_i2c_setlines(struct snd_i2c_bus *bus, int clk, int data)\r\n{\r\nstruct snd_ice1712 *ice = bus->private_data;\r\nunsigned int val = 0;\r\nif (clk)\r\nval |= VT1724_REVO_I2C_CLOCK;\r\nif (data)\r\nval |= VT1724_REVO_I2C_DATA;\r\nsnd_ice1712_gpio_write_bits(ice,\r\nVT1724_REVO_I2C_DATA |\r\nVT1724_REVO_I2C_CLOCK, val);\r\nudelay(5);\r\n}\r\nstatic int revo_i2c_getdata(struct snd_i2c_bus *bus, int ack)\r\n{\r\nstruct snd_ice1712 *ice = bus->private_data;\r\nint bit;\r\nif (ack)\r\nudelay(5);\r\nbit = snd_ice1712_gpio_read_bits(ice, VT1724_REVO_I2C_DATA) ? 1 : 0;\r\nreturn bit;\r\n}\r\nstatic int revo51_i2c_init(struct snd_ice1712 *ice,\r\nstruct snd_pt2258 *pt)\r\n{\r\nstruct revo51_spec *spec;\r\nint err;\r\nspec = kzalloc(sizeof(*spec), GFP_KERNEL);\r\nif (!spec)\r\nreturn -ENOMEM;\r\nice->spec = spec;\r\nerr = snd_i2c_bus_create(ice->card, "ICE1724 GPIO6", NULL, &ice->i2c);\r\nif (err < 0)\r\nreturn err;\r\nice->i2c->private_data = ice;\r\nice->i2c->hw_ops.bit = &revo51_bit_ops;\r\nerr = snd_i2c_device_create(ice->i2c, "PT2258", 0x40, &spec->dev);\r\nif (err < 0)\r\nreturn err;\r\npt->card = ice->card;\r\npt->i2c_bus = ice->i2c;\r\npt->i2c_dev = spec->dev;\r\nspec->pt2258 = pt;\r\nsnd_pt2258_reset(pt);\r\nreturn 0;\r\n}\r\nstatic void ap192_set_rate_val(struct snd_akm4xxx *ak, unsigned int rate)\r\n{\r\nstruct snd_ice1712 *ice = ak->private_data[0];\r\nint dfs;\r\nrevo_set_rate_val(ak, rate);\r\nsnd_ice1712_gpio_write_bits(ice, 1 << 8, rate > 96000 ? 1 << 8 : 0);\r\nif (rate > 96000)\r\ndfs = 2;\r\nelse if (rate > 48000)\r\ndfs = 1;\r\nelse\r\ndfs = 0;\r\nsnd_ice1712_gpio_write_bits(ice, 3 << 9, dfs << 9);\r\nsnd_ice1712_gpio_write_bits(ice, 1 << 11, 0);\r\nsnd_ice1712_gpio_write_bits(ice, 1 << 11, 1 << 11);\r\n}\r\nstatic void write_data(struct snd_ice1712 *ice, unsigned int gpio,\r\nunsigned int data, int idx)\r\n{\r\nfor (; idx >= 0; idx--) {\r\ngpio &= ~VT1724_REVO_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\nif (data & (1 << idx))\r\ngpio |= VT1724_REVO_CDOUT;\r\nelse\r\ngpio &= ~VT1724_REVO_CDOUT;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\ngpio |= VT1724_REVO_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\n}\r\n}\r\nstatic unsigned char read_data(struct snd_ice1712 *ice, unsigned int gpio,\r\nint idx)\r\n{\r\nunsigned char data = 0;\r\nfor (; idx >= 0; idx--) {\r\ngpio &= ~VT1724_REVO_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\nif (snd_ice1712_gpio_read(ice) & VT1724_REVO_CDIN)\r\ndata |= (1 << idx);\r\nudelay(1);\r\ngpio |= VT1724_REVO_CCLK;\r\nsnd_ice1712_gpio_write(ice, gpio);\r\nudelay(1);\r\n}\r\nreturn data;\r\n}\r\nstatic unsigned int ap192_4wire_start(struct snd_ice1712 *ice)\r\n{\r\nunsigned int tmp;\r\nsnd_ice1712_save_gpio_status(ice);\r\ntmp = snd_ice1712_gpio_read(ice);\r\ntmp |= VT1724_REVO_CCLK;\r\ntmp |= VT1724_REVO_CS0;\r\ntmp &= ~VT1724_REVO_CS3;\r\nsnd_ice1712_gpio_write(ice, tmp);\r\nudelay(1);\r\nreturn tmp;\r\n}\r\nstatic void ap192_4wire_finish(struct snd_ice1712 *ice, unsigned int tmp)\r\n{\r\ntmp |= VT1724_REVO_CS3;\r\ntmp |= VT1724_REVO_CS0;\r\nsnd_ice1712_gpio_write(ice, tmp);\r\nudelay(1);\r\nsnd_ice1712_restore_gpio_status(ice);\r\n}\r\nstatic void ap192_ak4114_write(void *private_data, unsigned char addr,\r\nunsigned char data)\r\n{\r\nstruct snd_ice1712 *ice = private_data;\r\nunsigned int tmp, addrdata;\r\ntmp = ap192_4wire_start(ice);\r\naddrdata = (AK4114_ADDR << 6) | 0x20 | (addr & 0x1f);\r\naddrdata = (addrdata << 8) | data;\r\nwrite_data(ice, tmp, addrdata, 15);\r\nap192_4wire_finish(ice, tmp);\r\n}\r\nstatic unsigned char ap192_ak4114_read(void *private_data, unsigned char addr)\r\n{\r\nstruct snd_ice1712 *ice = private_data;\r\nunsigned int tmp;\r\nunsigned char data;\r\ntmp = ap192_4wire_start(ice);\r\nwrite_data(ice, tmp, (AK4114_ADDR << 6) | (addr & 0x1f), 7);\r\ndata = read_data(ice, tmp, 7);\r\nap192_4wire_finish(ice, tmp);\r\nreturn data;\r\n}\r\nstatic int ap192_ak4114_init(struct snd_ice1712 *ice)\r\n{\r\nstatic const unsigned char ak4114_init_vals[] = {\r\nAK4114_RST | AK4114_PWN | AK4114_OCKS0,\r\nAK4114_DIF_I24I2S,\r\nAK4114_TX1E,\r\nAK4114_EFH_1024 | AK4114_DIT | AK4114_IPS(0),\r\n0,\r\n0\r\n};\r\nstatic const unsigned char ak4114_init_txcsb[] = {\r\n0x41, 0x02, 0x2c, 0x00, 0x00\r\n};\r\nint err;\r\nstruct revo51_spec *spec;\r\nspec = kzalloc(sizeof(*spec), GFP_KERNEL);\r\nif (!spec)\r\nreturn -ENOMEM;\r\nice->spec = spec;\r\nerr = snd_ak4114_create(ice->card,\r\nap192_ak4114_read,\r\nap192_ak4114_write,\r\nak4114_init_vals, ak4114_init_txcsb,\r\nice, &spec->ak4114);\r\nif (err < 0)\r\nreturn err;\r\nspec->ak4114->check_flags = AK4114_CHECK_NO_RATE;\r\nreturn 0;\r\n}\r\nstatic int revo_init(struct snd_ice1712 *ice)\r\n{\r\nstruct snd_akm4xxx *ak;\r\nint err;\r\nswitch (ice->eeprom.subvendor) {\r\ncase VT1724_SUBDEVICE_REVOLUTION71:\r\nice->num_total_dacs = 8;\r\nice->num_total_adcs = 2;\r\nice->gpio.i2s_mclk_changed = revo_i2s_mclk_changed;\r\nbreak;\r\ncase VT1724_SUBDEVICE_REVOLUTION51:\r\nice->num_total_dacs = 8;\r\nice->num_total_adcs = 2;\r\nbreak;\r\ncase VT1724_SUBDEVICE_AUDIOPHILE192:\r\nice->num_total_dacs = 2;\r\nice->num_total_adcs = 2;\r\nbreak;\r\ndefault:\r\nsnd_BUG();\r\nreturn -EINVAL;\r\n}\r\nak = ice->akm = kcalloc(2, sizeof(struct snd_akm4xxx), GFP_KERNEL);\r\nif (! ak)\r\nreturn -ENOMEM;\r\nswitch (ice->eeprom.subvendor) {\r\ncase VT1724_SUBDEVICE_REVOLUTION71:\r\nice->akm_codecs = 2;\r\nerr = snd_ice1712_akm4xxx_init(ak, &akm_revo_front,\r\n&akm_revo_front_priv, ice);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ice1712_akm4xxx_init(ak+1, &akm_revo_surround,\r\n&akm_revo_surround_priv, ice);\r\nif (err < 0)\r\nreturn err;\r\nsnd_ice1712_gpio_write_bits(ice, VT1724_REVO_MUTE,\r\nVT1724_REVO_MUTE);\r\nbreak;\r\ncase VT1724_SUBDEVICE_REVOLUTION51:\r\nice->akm_codecs = 2;\r\nerr = snd_ice1712_akm4xxx_init(ak, &akm_revo51,\r\n&akm_revo51_priv, ice);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ice1712_akm4xxx_init(ak+1, &akm_revo51_adc,\r\n&akm_revo51_adc_priv, ice);\r\nif (err < 0)\r\nreturn err;\r\nerr = revo51_i2c_init(ice, &ptc_revo51_volume);\r\nif (err < 0)\r\nreturn err;\r\nsnd_ice1712_gpio_write_bits(ice, VT1724_REVO_MUTE,\r\nVT1724_REVO_MUTE);\r\nbreak;\r\ncase VT1724_SUBDEVICE_AUDIOPHILE192:\r\nice->akm_codecs = 1;\r\nerr = snd_ice1712_akm4xxx_init(ak, &akm_ap192, &akm_ap192_priv,\r\nice);\r\nif (err < 0)\r\nreturn err;\r\nerr = ap192_ak4114_init(ice);\r\nif (err < 0)\r\nreturn err;\r\nsnd_ice1712_gpio_write_bits(ice, VT1724_REVO_MUTE,\r\nVT1724_REVO_MUTE);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int revo_add_controls(struct snd_ice1712 *ice)\r\n{\r\nstruct revo51_spec *spec = ice->spec;\r\nint err;\r\nswitch (ice->eeprom.subvendor) {\r\ncase VT1724_SUBDEVICE_REVOLUTION71:\r\nerr = snd_ice1712_akm4xxx_build_controls(ice);\r\nif (err < 0)\r\nreturn err;\r\nbreak;\r\ncase VT1724_SUBDEVICE_REVOLUTION51:\r\nerr = snd_ice1712_akm4xxx_build_controls(ice);\r\nif (err < 0)\r\nreturn err;\r\nspec = ice->spec;\r\nerr = snd_pt2258_build_controls(spec->pt2258);\r\nif (err < 0)\r\nreturn err;\r\nbreak;\r\ncase VT1724_SUBDEVICE_AUDIOPHILE192:\r\nerr = snd_ice1712_akm4xxx_build_controls(ice);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ak4114_build(spec->ak4114, NULL,\r\nice->pcm->streams[SNDRV_PCM_STREAM_CAPTURE].substream);\r\nif (err < 0)\r\nreturn err;\r\nbreak;\r\n}\r\nreturn 0;\r\n}

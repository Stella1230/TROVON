static void kvmppc_emul_rfi(struct kvm_vcpu *vcpu)\r\n{\r\nvcpu->arch.pc = vcpu->arch.shared->srr0;\r\nkvmppc_set_msr(vcpu, vcpu->arch.shared->srr1);\r\n}\r\nstatic void kvmppc_emul_rfdi(struct kvm_vcpu *vcpu)\r\n{\r\nvcpu->arch.pc = vcpu->arch.dsrr0;\r\nkvmppc_set_msr(vcpu, vcpu->arch.dsrr1);\r\n}\r\nstatic void kvmppc_emul_rfci(struct kvm_vcpu *vcpu)\r\n{\r\nvcpu->arch.pc = vcpu->arch.csrr0;\r\nkvmppc_set_msr(vcpu, vcpu->arch.csrr1);\r\n}\r\nint kvmppc_booke_emulate_op(struct kvm_run *run, struct kvm_vcpu *vcpu,\r\nunsigned int inst, int *advance)\r\n{\r\nint emulated = EMULATE_DONE;\r\nint rs = get_rs(inst);\r\nint rt = get_rt(inst);\r\nswitch (get_op(inst)) {\r\ncase 19:\r\nswitch (get_xop(inst)) {\r\ncase OP_19_XOP_RFI:\r\nkvmppc_emul_rfi(vcpu);\r\nkvmppc_set_exit_type(vcpu, EMULATED_RFI_EXITS);\r\n*advance = 0;\r\nbreak;\r\ncase OP_19_XOP_RFCI:\r\nkvmppc_emul_rfci(vcpu);\r\nkvmppc_set_exit_type(vcpu, EMULATED_RFCI_EXITS);\r\n*advance = 0;\r\nbreak;\r\ncase OP_19_XOP_RFDI:\r\nkvmppc_emul_rfdi(vcpu);\r\nkvmppc_set_exit_type(vcpu, EMULATED_RFDI_EXITS);\r\n*advance = 0;\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\nbreak;\r\n}\r\nbreak;\r\ncase 31:\r\nswitch (get_xop(inst)) {\r\ncase OP_31_XOP_MFMSR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.shared->msr);\r\nkvmppc_set_exit_type(vcpu, EMULATED_MFMSR_EXITS);\r\nbreak;\r\ncase OP_31_XOP_MTMSR:\r\nkvmppc_set_exit_type(vcpu, EMULATED_MTMSR_EXITS);\r\nkvmppc_set_msr(vcpu, kvmppc_get_gpr(vcpu, rs));\r\nbreak;\r\ncase OP_31_XOP_WRTEE:\r\nvcpu->arch.shared->msr = (vcpu->arch.shared->msr & ~MSR_EE)\r\n| (kvmppc_get_gpr(vcpu, rs) & MSR_EE);\r\nkvmppc_set_exit_type(vcpu, EMULATED_WRTEE_EXITS);\r\nbreak;\r\ncase OP_31_XOP_WRTEEI:\r\nvcpu->arch.shared->msr = (vcpu->arch.shared->msr & ~MSR_EE)\r\n| (inst & MSR_EE);\r\nkvmppc_set_exit_type(vcpu, EMULATED_WRTEE_EXITS);\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nreturn emulated;\r\n}\r\nint kvmppc_booke_emulate_mtspr(struct kvm_vcpu *vcpu, int sprn, ulong spr_val)\r\n{\r\nint emulated = EMULATE_DONE;\r\nbool debug_inst = false;\r\nswitch (sprn) {\r\ncase SPRN_DEAR:\r\nvcpu->arch.shared->dar = spr_val;\r\nbreak;\r\ncase SPRN_ESR:\r\nvcpu->arch.shared->esr = spr_val;\r\nbreak;\r\ncase SPRN_CSRR0:\r\nvcpu->arch.csrr0 = spr_val;\r\nbreak;\r\ncase SPRN_CSRR1:\r\nvcpu->arch.csrr1 = spr_val;\r\nbreak;\r\ncase SPRN_DSRR0:\r\nvcpu->arch.dsrr0 = spr_val;\r\nbreak;\r\ncase SPRN_DSRR1:\r\nvcpu->arch.dsrr1 = spr_val;\r\nbreak;\r\ncase SPRN_IAC1:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.iac1 = spr_val;\r\nbreak;\r\ncase SPRN_IAC2:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.iac2 = spr_val;\r\nbreak;\r\n#if CONFIG_PPC_ADV_DEBUG_IACS > 2\r\ncase SPRN_IAC3:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.iac3 = spr_val;\r\nbreak;\r\ncase SPRN_IAC4:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.iac4 = spr_val;\r\nbreak;\r\n#endif\r\ncase SPRN_DAC1:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.dac1 = spr_val;\r\nbreak;\r\ncase SPRN_DAC2:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.dac2 = spr_val;\r\nbreak;\r\ncase SPRN_DBCR0:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nspr_val &= (DBCR0_IDM | DBCR0_IC | DBCR0_BT | DBCR0_TIE |\r\nDBCR0_IAC1 | DBCR0_IAC2 | DBCR0_IAC3 | DBCR0_IAC4 |\r\nDBCR0_DAC1R | DBCR0_DAC1W | DBCR0_DAC2R | DBCR0_DAC2W);\r\nvcpu->arch.dbg_reg.dbcr0 = spr_val;\r\nbreak;\r\ncase SPRN_DBCR1:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.dbcr1 = spr_val;\r\nbreak;\r\ncase SPRN_DBCR2:\r\nif (vcpu->guest_debug)\r\nbreak;\r\ndebug_inst = true;\r\nvcpu->arch.dbg_reg.dbcr2 = spr_val;\r\nbreak;\r\ncase SPRN_DBSR:\r\nif (vcpu->guest_debug)\r\nbreak;\r\nvcpu->arch.dbsr &= ~spr_val;\r\nif (!(vcpu->arch.dbsr & ~DBSR_IDE))\r\nkvmppc_core_dequeue_debug(vcpu);\r\nbreak;\r\ncase SPRN_TSR:\r\nkvmppc_clr_tsr_bits(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_TCR:\r\nif (vcpu->arch.tcr & TCR_WRC_MASK) {\r\nspr_val &= ~TCR_WRC_MASK;\r\nspr_val |= vcpu->arch.tcr & TCR_WRC_MASK;\r\n}\r\nkvmppc_set_tcr(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_DECAR:\r\nvcpu->arch.decar = spr_val;\r\nbreak;\r\ncase SPRN_SPRG4:\r\nkvmppc_set_sprg4(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_SPRG5:\r\nkvmppc_set_sprg5(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_SPRG6:\r\nkvmppc_set_sprg6(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_SPRG7:\r\nkvmppc_set_sprg7(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_IVPR:\r\nvcpu->arch.ivpr = spr_val;\r\n#ifdef CONFIG_KVM_BOOKE_HV\r\nmtspr(SPRN_GIVPR, spr_val);\r\n#endif\r\nbreak;\r\ncase SPRN_IVOR0:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_CRITICAL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR1:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_MACHINE_CHECK] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR2:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DATA_STORAGE] = spr_val;\r\n#ifdef CONFIG_KVM_BOOKE_HV\r\nmtspr(SPRN_GIVOR2, spr_val);\r\n#endif\r\nbreak;\r\ncase SPRN_IVOR3:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_INST_STORAGE] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR4:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_EXTERNAL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR5:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_ALIGNMENT] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR6:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PROGRAM] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR7:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_FP_UNAVAIL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR8:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SYSCALL] = spr_val;\r\n#ifdef CONFIG_KVM_BOOKE_HV\r\nmtspr(SPRN_GIVOR8, spr_val);\r\n#endif\r\nbreak;\r\ncase SPRN_IVOR9:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_AP_UNAVAIL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR10:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DECREMENTER] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR11:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_FIT] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR12:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_WATCHDOG] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR13:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DTLB_MISS] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR14:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_ITLB_MISS] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR15:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DEBUG] = spr_val;\r\nbreak;\r\ncase SPRN_MCSR:\r\nvcpu->arch.mcsr &= ~spr_val;\r\nbreak;\r\n#if defined(CONFIG_64BIT)\r\ncase SPRN_EPCR:\r\nkvmppc_set_epcr(vcpu, spr_val);\r\n#ifdef CONFIG_KVM_BOOKE_HV\r\nmtspr(SPRN_EPCR, vcpu->arch.shadow_epcr);\r\n#endif\r\nbreak;\r\n#endif\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nif (debug_inst) {\r\ncurrent->thread.debug = vcpu->arch.dbg_reg;\r\nswitch_booke_debug_regs(&vcpu->arch.dbg_reg);\r\n}\r\nreturn emulated;\r\n}\r\nint kvmppc_booke_emulate_mfspr(struct kvm_vcpu *vcpu, int sprn, ulong *spr_val)\r\n{\r\nint emulated = EMULATE_DONE;\r\nswitch (sprn) {\r\ncase SPRN_IVPR:\r\n*spr_val = vcpu->arch.ivpr;\r\nbreak;\r\ncase SPRN_DEAR:\r\n*spr_val = vcpu->arch.shared->dar;\r\nbreak;\r\ncase SPRN_ESR:\r\n*spr_val = vcpu->arch.shared->esr;\r\nbreak;\r\ncase SPRN_EPR:\r\n*spr_val = vcpu->arch.epr;\r\nbreak;\r\ncase SPRN_CSRR0:\r\n*spr_val = vcpu->arch.csrr0;\r\nbreak;\r\ncase SPRN_CSRR1:\r\n*spr_val = vcpu->arch.csrr1;\r\nbreak;\r\ncase SPRN_DSRR0:\r\n*spr_val = vcpu->arch.dsrr0;\r\nbreak;\r\ncase SPRN_DSRR1:\r\n*spr_val = vcpu->arch.dsrr1;\r\nbreak;\r\ncase SPRN_IAC1:\r\n*spr_val = vcpu->arch.dbg_reg.iac1;\r\nbreak;\r\ncase SPRN_IAC2:\r\n*spr_val = vcpu->arch.dbg_reg.iac2;\r\nbreak;\r\n#if CONFIG_PPC_ADV_DEBUG_IACS > 2\r\ncase SPRN_IAC3:\r\n*spr_val = vcpu->arch.dbg_reg.iac3;\r\nbreak;\r\ncase SPRN_IAC4:\r\n*spr_val = vcpu->arch.dbg_reg.iac4;\r\nbreak;\r\n#endif\r\ncase SPRN_DAC1:\r\n*spr_val = vcpu->arch.dbg_reg.dac1;\r\nbreak;\r\ncase SPRN_DAC2:\r\n*spr_val = vcpu->arch.dbg_reg.dac2;\r\nbreak;\r\ncase SPRN_DBCR0:\r\n*spr_val = vcpu->arch.dbg_reg.dbcr0;\r\nif (vcpu->guest_debug)\r\n*spr_val = *spr_val | DBCR0_EDM;\r\nbreak;\r\ncase SPRN_DBCR1:\r\n*spr_val = vcpu->arch.dbg_reg.dbcr1;\r\nbreak;\r\ncase SPRN_DBCR2:\r\n*spr_val = vcpu->arch.dbg_reg.dbcr2;\r\nbreak;\r\ncase SPRN_DBSR:\r\n*spr_val = vcpu->arch.dbsr;\r\nbreak;\r\ncase SPRN_TSR:\r\n*spr_val = vcpu->arch.tsr;\r\nbreak;\r\ncase SPRN_TCR:\r\n*spr_val = vcpu->arch.tcr;\r\nbreak;\r\ncase SPRN_IVOR0:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_CRITICAL];\r\nbreak;\r\ncase SPRN_IVOR1:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_MACHINE_CHECK];\r\nbreak;\r\ncase SPRN_IVOR2:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_DATA_STORAGE];\r\nbreak;\r\ncase SPRN_IVOR3:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_INST_STORAGE];\r\nbreak;\r\ncase SPRN_IVOR4:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_EXTERNAL];\r\nbreak;\r\ncase SPRN_IVOR5:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_ALIGNMENT];\r\nbreak;\r\ncase SPRN_IVOR6:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_PROGRAM];\r\nbreak;\r\ncase SPRN_IVOR7:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_FP_UNAVAIL];\r\nbreak;\r\ncase SPRN_IVOR8:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_SYSCALL];\r\nbreak;\r\ncase SPRN_IVOR9:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_AP_UNAVAIL];\r\nbreak;\r\ncase SPRN_IVOR10:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_DECREMENTER];\r\nbreak;\r\ncase SPRN_IVOR11:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_FIT];\r\nbreak;\r\ncase SPRN_IVOR12:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_WATCHDOG];\r\nbreak;\r\ncase SPRN_IVOR13:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_DTLB_MISS];\r\nbreak;\r\ncase SPRN_IVOR14:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_ITLB_MISS];\r\nbreak;\r\ncase SPRN_IVOR15:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_DEBUG];\r\nbreak;\r\ncase SPRN_MCSR:\r\n*spr_val = vcpu->arch.mcsr;\r\nbreak;\r\n#if defined(CONFIG_64BIT)\r\ncase SPRN_EPCR:\r\n*spr_val = vcpu->arch.epcr;\r\nbreak;\r\n#endif\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nreturn emulated;\r\n}

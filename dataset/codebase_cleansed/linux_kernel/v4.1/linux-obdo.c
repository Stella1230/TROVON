void obdo_from_la(struct obdo *dst, struct lu_attr *la, __u64 valid)\r\n{\r\nu32 newvalid = 0;\r\nif (valid & LA_ATIME) {\r\ndst->o_atime = la->la_atime;\r\nnewvalid |= OBD_MD_FLATIME;\r\n}\r\nif (valid & LA_MTIME) {\r\ndst->o_mtime = la->la_mtime;\r\nnewvalid |= OBD_MD_FLMTIME;\r\n}\r\nif (valid & LA_CTIME) {\r\ndst->o_ctime = la->la_ctime;\r\nnewvalid |= OBD_MD_FLCTIME;\r\n}\r\nif (valid & LA_SIZE) {\r\ndst->o_size = la->la_size;\r\nnewvalid |= OBD_MD_FLSIZE;\r\n}\r\nif (valid & LA_BLOCKS) {\r\ndst->o_blocks = la->la_blocks;\r\nnewvalid |= OBD_MD_FLBLOCKS;\r\n}\r\nif (valid & LA_TYPE) {\r\ndst->o_mode = (dst->o_mode & S_IALLUGO) |\r\n(la->la_mode & S_IFMT);\r\nnewvalid |= OBD_MD_FLTYPE;\r\n}\r\nif (valid & LA_MODE) {\r\ndst->o_mode = (dst->o_mode & S_IFMT) |\r\n(la->la_mode & S_IALLUGO);\r\nnewvalid |= OBD_MD_FLMODE;\r\n}\r\nif (valid & LA_UID) {\r\ndst->o_uid = la->la_uid;\r\nnewvalid |= OBD_MD_FLUID;\r\n}\r\nif (valid & LA_GID) {\r\ndst->o_gid = la->la_gid;\r\nnewvalid |= OBD_MD_FLGID;\r\n}\r\ndst->o_valid |= newvalid;\r\n}\r\nvoid la_from_obdo(struct lu_attr *dst, struct obdo *obdo, u32 valid)\r\n{\r\n__u64 newvalid = 0;\r\nvalid &= obdo->o_valid;\r\nif (valid & OBD_MD_FLATIME) {\r\ndst->la_atime = obdo->o_atime;\r\nnewvalid |= LA_ATIME;\r\n}\r\nif (valid & OBD_MD_FLMTIME) {\r\ndst->la_mtime = obdo->o_mtime;\r\nnewvalid |= LA_MTIME;\r\n}\r\nif (valid & OBD_MD_FLCTIME) {\r\ndst->la_ctime = obdo->o_ctime;\r\nnewvalid |= LA_CTIME;\r\n}\r\nif (valid & OBD_MD_FLSIZE) {\r\ndst->la_size = obdo->o_size;\r\nnewvalid |= LA_SIZE;\r\n}\r\nif (valid & OBD_MD_FLBLOCKS) {\r\ndst->la_blocks = obdo->o_blocks;\r\nnewvalid |= LA_BLOCKS;\r\n}\r\nif (valid & OBD_MD_FLTYPE) {\r\ndst->la_mode = (dst->la_mode & S_IALLUGO) |\r\n(obdo->o_mode & S_IFMT);\r\nnewvalid |= LA_TYPE;\r\n}\r\nif (valid & OBD_MD_FLMODE) {\r\ndst->la_mode = (dst->la_mode & S_IFMT) |\r\n(obdo->o_mode & S_IALLUGO);\r\nnewvalid |= LA_MODE;\r\n}\r\nif (valid & OBD_MD_FLUID) {\r\ndst->la_uid = obdo->o_uid;\r\nnewvalid |= LA_UID;\r\n}\r\nif (valid & OBD_MD_FLGID) {\r\ndst->la_gid = obdo->o_gid;\r\nnewvalid |= LA_GID;\r\n}\r\ndst->la_valid = newvalid;\r\n}\r\nvoid obdo_refresh_inode(struct inode *dst, struct obdo *src, u32 valid)\r\n{\r\nvalid &= src->o_valid;\r\nif (valid & (OBD_MD_FLCTIME | OBD_MD_FLMTIME))\r\nCDEBUG(D_INODE,\r\n"valid %#llx, cur time %lu/%lu, new %llu/%llu\n",\r\nsrc->o_valid, LTIME_S(dst->i_mtime),\r\nLTIME_S(dst->i_ctime), src->o_mtime, src->o_ctime);\r\nif (valid & OBD_MD_FLATIME && src->o_atime > LTIME_S(dst->i_atime))\r\nLTIME_S(dst->i_atime) = src->o_atime;\r\nif (valid & OBD_MD_FLMTIME && src->o_mtime > LTIME_S(dst->i_mtime))\r\nLTIME_S(dst->i_mtime) = src->o_mtime;\r\nif (valid & OBD_MD_FLCTIME && src->o_ctime > LTIME_S(dst->i_ctime))\r\nLTIME_S(dst->i_ctime) = src->o_ctime;\r\nif (valid & OBD_MD_FLSIZE)\r\ni_size_write(dst, src->o_size);\r\nif (valid & OBD_MD_FLBLKSZ && src->o_blksize > (1 << dst->i_blkbits))\r\ndst->i_blkbits = ffs(src->o_blksize) - 1;\r\nif (dst->i_blkbits < PAGE_CACHE_SHIFT)\r\ndst->i_blkbits = PAGE_CACHE_SHIFT;\r\nif (valid & OBD_MD_FLBLOCKS && src->o_blocks > dst->i_blocks)\r\ndst->i_blocks = src->o_blocks;\r\n}\r\nvoid obdo_to_inode(struct inode *dst, struct obdo *src, u32 valid)\r\n{\r\nvalid &= src->o_valid;\r\nLASSERTF(!(valid & (OBD_MD_FLTYPE | OBD_MD_FLGENER | OBD_MD_FLFID |\r\nOBD_MD_FLID | OBD_MD_FLGROUP)),\r\n"object "DOSTID", valid %x\n", POSTID(&src->o_oi), valid);\r\nif (valid & (OBD_MD_FLCTIME | OBD_MD_FLMTIME))\r\nCDEBUG(D_INODE,\r\n"valid %#llx, cur time %lu/%lu, new %llu/%llu\n",\r\nsrc->o_valid, LTIME_S(dst->i_mtime),\r\nLTIME_S(dst->i_ctime), src->o_mtime, src->o_ctime);\r\nif (valid & OBD_MD_FLATIME)\r\nLTIME_S(dst->i_atime) = src->o_atime;\r\nif (valid & OBD_MD_FLMTIME)\r\nLTIME_S(dst->i_mtime) = src->o_mtime;\r\nif (valid & OBD_MD_FLCTIME && src->o_ctime > LTIME_S(dst->i_ctime))\r\nLTIME_S(dst->i_ctime) = src->o_ctime;\r\nif (valid & OBD_MD_FLSIZE)\r\ni_size_write(dst, src->o_size);\r\nif (valid & OBD_MD_FLBLOCKS) {\r\ndst->i_blocks = src->o_blocks;\r\nif (dst->i_blocks < src->o_blocks)\r\ndst->i_blocks = -1;\r\n}\r\nif (valid & OBD_MD_FLBLKSZ)\r\ndst->i_blkbits = ffs(src->o_blksize)-1;\r\nif (valid & OBD_MD_FLMODE)\r\ndst->i_mode = (dst->i_mode & S_IFMT) | (src->o_mode & ~S_IFMT);\r\nif (valid & OBD_MD_FLUID)\r\ndst->i_uid = make_kuid(&init_user_ns, src->o_uid);\r\nif (valid & OBD_MD_FLGID)\r\ndst->i_gid = make_kgid(&init_user_ns, src->o_gid);\r\nif (valid & OBD_MD_FLFLAGS)\r\ndst->i_flags = src->o_flags;\r\n}

void qxl_gem_object_free(struct drm_gem_object *gobj)\r\n{\r\nstruct qxl_bo *qobj = gem_to_qxl_bo(gobj);\r\nif (qobj)\r\nqxl_bo_unref(&qobj);\r\n}\r\nint qxl_gem_object_create(struct qxl_device *qdev, int size,\r\nint alignment, int initial_domain,\r\nbool discardable, bool kernel,\r\nstruct qxl_surface *surf,\r\nstruct drm_gem_object **obj)\r\n{\r\nstruct qxl_bo *qbo;\r\nint r;\r\n*obj = NULL;\r\nif (alignment < PAGE_SIZE)\r\nalignment = PAGE_SIZE;\r\nr = qxl_bo_create(qdev, size, kernel, false, initial_domain, surf, &qbo);\r\nif (r) {\r\nif (r != -ERESTARTSYS)\r\nDRM_ERROR(\r\n"Failed to allocate GEM object (%d, %d, %u, %d)\n",\r\nsize, initial_domain, alignment, r);\r\nreturn r;\r\n}\r\n*obj = &qbo->gem_base;\r\nmutex_lock(&qdev->gem.mutex);\r\nlist_add_tail(&qbo->list, &qdev->gem.objects);\r\nmutex_unlock(&qdev->gem.mutex);\r\nreturn 0;\r\n}\r\nint qxl_gem_object_create_with_handle(struct qxl_device *qdev,\r\nstruct drm_file *file_priv,\r\nu32 domain,\r\nsize_t size,\r\nstruct qxl_surface *surf,\r\nstruct qxl_bo **qobj,\r\nuint32_t *handle)\r\n{\r\nstruct drm_gem_object *gobj;\r\nint r;\r\nBUG_ON(!qobj);\r\nBUG_ON(!handle);\r\nr = qxl_gem_object_create(qdev, size, 0,\r\ndomain,\r\nfalse, false, surf,\r\n&gobj);\r\nif (r)\r\nreturn -ENOMEM;\r\nr = drm_gem_handle_create(file_priv, gobj, handle);\r\nif (r)\r\nreturn r;\r\n*qobj = gem_to_qxl_bo(gobj);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn 0;\r\n}\r\nint qxl_gem_object_open(struct drm_gem_object *obj, struct drm_file *file_priv)\r\n{\r\nreturn 0;\r\n}\r\nvoid qxl_gem_object_close(struct drm_gem_object *obj,\r\nstruct drm_file *file_priv)\r\n{\r\n}\r\nint qxl_gem_init(struct qxl_device *qdev)\r\n{\r\nINIT_LIST_HEAD(&qdev->gem.objects);\r\nreturn 0;\r\n}\r\nvoid qxl_gem_fini(struct qxl_device *qdev)\r\n{\r\nqxl_bo_force_delete(qdev);\r\n}

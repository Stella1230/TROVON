static inline void xtfpga_spi_write32(const struct xtfpga_spi *spi,\r\nunsigned addr, u32 val)\r\n{\r\niowrite32(val, spi->regs + addr);\r\n}\r\nstatic inline unsigned int xtfpga_spi_read32(const struct xtfpga_spi *spi,\r\nunsigned addr)\r\n{\r\nreturn ioread32(spi->regs + addr);\r\n}\r\nstatic inline void xtfpga_spi_wait_busy(struct xtfpga_spi *xspi)\r\n{\r\nunsigned i;\r\nfor (i = 0; xtfpga_spi_read32(xspi, XTFPGA_SPI_BUSY) &&\r\ni < BUSY_WAIT_US; ++i)\r\nudelay(1);\r\nWARN_ON_ONCE(i == BUSY_WAIT_US);\r\n}\r\nstatic u32 xtfpga_spi_txrx_word(struct spi_device *spi, unsigned nsecs,\r\nu32 v, u8 bits)\r\n{\r\nstruct xtfpga_spi *xspi = spi_master_get_devdata(spi->master);\r\nxspi->data = (xspi->data << bits) | (v & GENMASK(bits - 1, 0));\r\nxspi->data_sz += bits;\r\nif (xspi->data_sz >= 16) {\r\nxtfpga_spi_write32(xspi, XTFPGA_SPI_DATA,\r\nxspi->data >> (xspi->data_sz - 16));\r\nxspi->data_sz -= 16;\r\nxtfpga_spi_write32(xspi, XTFPGA_SPI_START, 1);\r\nxtfpga_spi_wait_busy(xspi);\r\nxtfpga_spi_write32(xspi, XTFPGA_SPI_START, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic void xtfpga_spi_chipselect(struct spi_device *spi, int is_on)\r\n{\r\nstruct xtfpga_spi *xspi = spi_master_get_devdata(spi->master);\r\nWARN_ON(xspi->data_sz != 0);\r\nxspi->data_sz = 0;\r\n}\r\nstatic int xtfpga_spi_probe(struct platform_device *pdev)\r\n{\r\nstruct xtfpga_spi *xspi;\r\nstruct resource *mem;\r\nint ret;\r\nstruct spi_master *master;\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(struct xtfpga_spi));\r\nif (!master)\r\nreturn -ENOMEM;\r\nmaster->flags = SPI_MASTER_NO_RX;\r\nmaster->bits_per_word_mask = SPI_BPW_RANGE_MASK(1, 16);\r\nmaster->bus_num = pdev->dev.id;\r\nmaster->dev.of_node = pdev->dev.of_node;\r\nxspi = spi_master_get_devdata(master);\r\nxspi->bitbang.master = master;\r\nxspi->bitbang.chipselect = xtfpga_spi_chipselect;\r\nxspi->bitbang.txrx_word[SPI_MODE_0] = xtfpga_spi_txrx_word;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem) {\r\ndev_err(&pdev->dev, "No memory resource\n");\r\nret = -ENODEV;\r\ngoto err;\r\n}\r\nxspi->regs = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(xspi->regs)) {\r\nret = PTR_ERR(xspi->regs);\r\ngoto err;\r\n}\r\nxtfpga_spi_write32(xspi, XTFPGA_SPI_START, 0);\r\nusleep_range(1000, 2000);\r\nif (xtfpga_spi_read32(xspi, XTFPGA_SPI_BUSY)) {\r\ndev_err(&pdev->dev, "Device stuck in busy state\n");\r\nret = -EBUSY;\r\ngoto err;\r\n}\r\nret = spi_bitbang_start(&xspi->bitbang);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "spi_bitbang_start failed\n");\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, master);\r\nreturn 0;\r\nerr:\r\nspi_master_put(master);\r\nreturn ret;\r\n}\r\nstatic int xtfpga_spi_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct xtfpga_spi *xspi = spi_master_get_devdata(master);\r\nspi_bitbang_stop(&xspi->bitbang);\r\nspi_master_put(master);\r\nreturn 0;\r\n}

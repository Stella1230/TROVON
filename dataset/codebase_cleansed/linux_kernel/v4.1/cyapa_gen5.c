static int cyapa_gen5_initialize(struct cyapa *cyapa)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\ninit_completion(&gen5_pip->cmd_ready);\r\natomic_set(&gen5_pip->cmd_issued, 0);\r\nmutex_init(&gen5_pip->cmd_lock);\r\ngen5_pip->resp_sort_func = NULL;\r\ngen5_pip->in_progress_cmd = TSG_INVALID_CMD;\r\ngen5_pip->resp_data = NULL;\r\ngen5_pip->resp_len = NULL;\r\ncyapa->dev_pwr_mode = UNINIT_PWR_MODE;\r\ncyapa->dev_sleep_time = UNINIT_SLEEP_TIME;\r\nreturn 0;\r\n}\r\nstatic ssize_t cyapa_i2c_pip_read(struct cyapa *cyapa, u8 *buf, size_t size)\r\n{\r\nint ret;\r\nif (size == 0)\r\nreturn 0;\r\nif (!buf || size > CYAPA_REG_MAP_SIZE)\r\nreturn -EINVAL;\r\nret = i2c_master_recv(cyapa->client, buf, size);\r\nif (ret != size)\r\nreturn (ret < 0) ? ret : -EIO;\r\nreturn size;\r\n}\r\nstatic ssize_t cyapa_i2c_pip_write(struct cyapa *cyapa, u8 *buf, size_t size)\r\n{\r\nint ret;\r\nif (!buf || !size)\r\nreturn -EINVAL;\r\nret = i2c_master_send(cyapa->client, buf, size);\r\nif (ret != size)\r\nreturn (ret < 0) ? ret : -EIO;\r\nreturn 0;\r\n}\r\nstatic int cyapa_empty_pip_output_data(struct cyapa *cyapa,\r\nu8 *buf, int *len, cb_sort func)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\nint length;\r\nint report_count;\r\nint empty_count;\r\nint buf_len;\r\nint error;\r\nbuf_len = 0;\r\nif (len) {\r\nbuf_len = (*len < CYAPA_REG_MAP_SIZE) ?\r\n*len : CYAPA_REG_MAP_SIZE;\r\n*len = 0;\r\n}\r\nreport_count = 8;\r\nempty_count = 0;\r\ndo {\r\nif (empty_count > 5)\r\nreturn 0;\r\nerror = cyapa_i2c_pip_read(cyapa, gen5_pip->empty_buf,\r\nGEN5_RESP_LENGTH_SIZE);\r\nif (error < 0)\r\nreturn error;\r\nlength = get_unaligned_le16(gen5_pip->empty_buf);\r\nif (length == GEN5_RESP_LENGTH_SIZE) {\r\nempty_count++;\r\ncontinue;\r\n} else if (length > CYAPA_REG_MAP_SIZE) {\r\nreturn -EINVAL;\r\n} else if (length == 0) {\r\nlength = GEN5_RESP_LENGTH_SIZE;\r\nif (buf && buf_len && func &&\r\nfunc(cyapa, gen5_pip->empty_buf, length)) {\r\nlength = min(buf_len, length);\r\nmemcpy(buf, gen5_pip->empty_buf, length);\r\n*len = length;\r\nreturn 0;\r\n}\r\ncontinue;\r\n}\r\nerror = cyapa_i2c_pip_read(cyapa, gen5_pip->empty_buf, length);\r\nif (error < 0)\r\nreturn error;\r\nreport_count--;\r\nempty_count = 0;\r\nlength = get_unaligned_le16(gen5_pip->empty_buf);\r\nif (length <= GEN5_RESP_LENGTH_SIZE) {\r\nempty_count++;\r\n} else if (buf && buf_len && func &&\r\nfunc(cyapa, gen5_pip->empty_buf, length)) {\r\nlength = min(buf_len, length);\r\nmemcpy(buf, gen5_pip->empty_buf, length);\r\n*len = length;\r\nreturn 0;\r\n}\r\nerror = -EINVAL;\r\n} while (report_count);\r\nreturn error;\r\n}\r\nstatic int cyapa_do_i2c_pip_cmd_irq_sync(\r\nstruct cyapa *cyapa,\r\nu8 *cmd, size_t cmd_len,\r\nunsigned long timeout)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\nint error;\r\ninit_completion(&gen5_pip->cmd_ready);\r\natomic_inc(&gen5_pip->cmd_issued);\r\nerror = cyapa_i2c_pip_write(cyapa, cmd, cmd_len);\r\nif (error) {\r\natomic_dec(&gen5_pip->cmd_issued);\r\nreturn (error < 0) ? error : -EIO;\r\n}\r\ntimeout = wait_for_completion_timeout(&gen5_pip->cmd_ready,\r\nmsecs_to_jiffies(timeout));\r\nif (timeout == 0) {\r\natomic_dec(&gen5_pip->cmd_issued);\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cyapa_do_i2c_pip_cmd_polling(\r\nstruct cyapa *cyapa,\r\nu8 *cmd, size_t cmd_len,\r\nu8 *resp_data, int *resp_len,\r\nunsigned long timeout,\r\ncb_sort func)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\nint tries;\r\nint length;\r\nint error;\r\natomic_inc(&gen5_pip->cmd_issued);\r\nerror = cyapa_i2c_pip_write(cyapa, cmd, cmd_len);\r\nif (error) {\r\natomic_dec(&gen5_pip->cmd_issued);\r\nreturn error < 0 ? error : -EIO;\r\n}\r\nlength = resp_len ? *resp_len : 0;\r\nif (resp_data && resp_len && length != 0 && func) {\r\ntries = timeout / 5;\r\ndo {\r\nusleep_range(3000, 5000);\r\n*resp_len = length;\r\nerror = cyapa_empty_pip_output_data(cyapa,\r\nresp_data, resp_len, func);\r\nif (error || *resp_len == 0)\r\ncontinue;\r\nelse\r\nbreak;\r\n} while (--tries > 0);\r\nif ((error || *resp_len == 0) || tries <= 0)\r\nerror = error ? error : -ETIMEDOUT;\r\n}\r\natomic_dec(&gen5_pip->cmd_issued);\r\nreturn error;\r\n}\r\nstatic int cyapa_i2c_pip_cmd_irq_sync(\r\nstruct cyapa *cyapa,\r\nu8 *cmd, int cmd_len,\r\nu8 *resp_data, int *resp_len,\r\nunsigned long timeout,\r\ncb_sort func,\r\nbool irq_mode)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\nint error;\r\nif (!cmd || !cmd_len)\r\nreturn -EINVAL;\r\nerror = mutex_lock_interruptible(&gen5_pip->cmd_lock);\r\nif (error)\r\nreturn error;\r\ngen5_pip->resp_sort_func = func;\r\ngen5_pip->resp_data = resp_data;\r\ngen5_pip->resp_len = resp_len;\r\nif (cmd_len >= GEN5_MIN_APP_CMD_LENGTH &&\r\ncmd[4] == GEN5_APP_CMD_REPORT_ID) {\r\ngen5_pip->in_progress_cmd = cmd[6] & 0x7f;\r\n} else if (cmd_len >= GEN5_MIN_BL_CMD_LENGTH &&\r\ncmd[4] == GEN5_BL_CMD_REPORT_ID) {\r\ngen5_pip->in_progress_cmd = cmd[7];\r\n}\r\nif (irq_mode) {\r\ngen5_pip->is_irq_mode = true;\r\nerror = cyapa_do_i2c_pip_cmd_irq_sync(cyapa, cmd, cmd_len,\r\ntimeout);\r\nif (error == -ETIMEDOUT && resp_data &&\r\nresp_len && *resp_len != 0 && func) {\r\nerror = cyapa_empty_pip_output_data(cyapa,\r\nresp_data, resp_len, func);\r\nif (error || *resp_len == 0)\r\nerror = error ? error : -ETIMEDOUT;\r\n}\r\n} else {\r\ngen5_pip->is_irq_mode = false;\r\nerror = cyapa_do_i2c_pip_cmd_polling(cyapa, cmd, cmd_len,\r\nresp_data, resp_len, timeout, func);\r\n}\r\ngen5_pip->resp_sort_func = NULL;\r\ngen5_pip->resp_data = NULL;\r\ngen5_pip->resp_len = NULL;\r\ngen5_pip->in_progress_cmd = TSG_INVALID_CMD;\r\nmutex_unlock(&gen5_pip->cmd_lock);\r\nreturn error;\r\n}\r\nstatic bool cyapa_gen5_sort_tsg_pip_bl_resp_data(struct cyapa *cyapa,\r\nu8 *data, int len)\r\n{\r\nif (!data || len < GEN5_MIN_BL_RESP_LENGTH)\r\nreturn false;\r\nif (data[GEN5_RESP_REPORT_ID_OFFSET] == GEN5_BL_RESP_REPORT_ID &&\r\ndata[GEN5_RESP_RSVD_OFFSET] == GEN5_RESP_RSVD_KEY &&\r\ndata[GEN5_RESP_BL_SOP_OFFSET] == GEN5_SOP_KEY)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool cyapa_gen5_sort_tsg_pip_app_resp_data(struct cyapa *cyapa,\r\nu8 *data, int len)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\nint resp_len;\r\nif (!data || len < GEN5_MIN_APP_RESP_LENGTH)\r\nreturn false;\r\nif (data[GEN5_RESP_REPORT_ID_OFFSET] == GEN5_APP_RESP_REPORT_ID &&\r\ndata[GEN5_RESP_RSVD_OFFSET] == GEN5_RESP_RSVD_KEY) {\r\nresp_len = get_unaligned_le16(&data[GEN5_RESP_LENGTH_OFFSET]);\r\nif (GET_GEN5_CMD_CODE(data[GEN5_RESP_APP_CMD_OFFSET]) == 0x00 &&\r\nresp_len == GEN5_UNSUPPORTED_CMD_RESP_LENGTH &&\r\ndata[5] == gen5_pip->in_progress_cmd) {\r\nreturn false;\r\n} else if (GET_GEN5_CMD_CODE(data[GEN5_RESP_APP_CMD_OFFSET]) ==\r\ngen5_pip->in_progress_cmd) {\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic bool cyapa_gen5_sort_application_launch_data(struct cyapa *cyapa,\r\nu8 *buf, int len)\r\n{\r\nif (buf == NULL || len < GEN5_RESP_LENGTH_SIZE)\r\nreturn false;\r\nif (buf[0] == 0 && buf[1] == 0)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool cyapa_gen5_sort_hid_descriptor_data(struct cyapa *cyapa,\r\nu8 *buf, int len)\r\n{\r\nint resp_len;\r\nint max_output_len;\r\nif (len != GEN5_HID_DESCRIPTOR_SIZE)\r\nreturn false;\r\nresp_len = get_unaligned_le16(&buf[GEN5_RESP_LENGTH_OFFSET]);\r\nmax_output_len = get_unaligned_le16(&buf[16]);\r\nif (resp_len == GEN5_HID_DESCRIPTOR_SIZE) {\r\nif (buf[GEN5_RESP_REPORT_ID_OFFSET] == GEN5_BL_HID_REPORT_ID &&\r\nmax_output_len == GEN5_BL_MAX_OUTPUT_LENGTH) {\r\nreturn true;\r\n} else if ((buf[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_APP_HID_REPORT_ID) &&\r\nmax_output_len == GEN5_APP_MAX_OUTPUT_LENGTH) {\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic bool cyapa_gen5_sort_deep_sleep_data(struct cyapa *cyapa,\r\nu8 *buf, int len)\r\n{\r\nif (len == GEN5_DEEP_SLEEP_RESP_LENGTH &&\r\nbuf[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_APP_DEEP_SLEEP_REPORT_ID &&\r\n(buf[4] & GEN5_DEEP_SLEEP_OPCODE_MASK) ==\r\nGEN5_DEEP_SLEEP_OPCODE)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic int gen5_idle_state_parse(struct cyapa *cyapa)\r\n{\r\nu8 resp_data[GEN5_HID_DESCRIPTOR_SIZE];\r\nint max_output_len;\r\nint length;\r\nu8 cmd[2];\r\nint ret;\r\nint error;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nmemset(resp_data, 0, sizeof(resp_data));\r\nret = cyapa_i2c_pip_read(cyapa, resp_data, 3);\r\nif (ret != 3)\r\nreturn ret < 0 ? ret : -EIO;\r\nlength = get_unaligned_le16(&resp_data[GEN5_RESP_LENGTH_OFFSET]);\r\nif (length == GEN5_RESP_LENGTH_SIZE) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\ncmd[0] = 0x01;\r\ncmd[1] = 0x00;\r\nlength = GEN5_HID_DESCRIPTOR_SIZE;\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, GEN5_RESP_LENGTH_SIZE,\r\nresp_data, &length,\r\n300,\r\ncyapa_gen5_sort_hid_descriptor_data,\r\nfalse);\r\nif (error)\r\nreturn error;\r\nlength = get_unaligned_le16(\r\n&resp_data[GEN5_RESP_LENGTH_OFFSET]);\r\nmax_output_len = get_unaligned_le16(&resp_data[16]);\r\nif ((length == GEN5_HID_DESCRIPTOR_SIZE ||\r\nlength == GEN5_RESP_LENGTH_SIZE) &&\r\n(resp_data[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_BL_HID_REPORT_ID) &&\r\nmax_output_len == GEN5_BL_MAX_OUTPUT_LENGTH) {\r\ncyapa->state = CYAPA_STATE_GEN5_BL;\r\n} else if ((length == GEN5_HID_DESCRIPTOR_SIZE ||\r\nlength == GEN5_RESP_LENGTH_SIZE) &&\r\n(resp_data[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_APP_HID_REPORT_ID) &&\r\nmax_output_len == GEN5_APP_MAX_OUTPUT_LENGTH) {\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\n} else {\r\ncyapa->state = CYAPA_STATE_NO_DEVICE;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int gen5_hid_description_header_parse(struct cyapa *cyapa, u8 *reg_data)\r\n{\r\nint length;\r\nu8 resp_data[32];\r\nint max_output_len;\r\nint ret;\r\nret = cyapa_i2c_pip_read(cyapa, resp_data,\r\nGEN5_HID_DESCRIPTOR_SIZE);\r\nif (ret != GEN5_HID_DESCRIPTOR_SIZE)\r\nreturn ret < 0 ? ret : -EIO;\r\nlength = get_unaligned_le16(&resp_data[GEN5_RESP_LENGTH_OFFSET]);\r\nmax_output_len = get_unaligned_le16(&resp_data[16]);\r\nif (length == GEN5_RESP_LENGTH_SIZE) {\r\nif (reg_data[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_BL_HID_REPORT_ID) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_BL;\r\n} else {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\n}\r\n} else if (length == GEN5_HID_DESCRIPTOR_SIZE &&\r\nresp_data[2] == GEN5_BL_HID_REPORT_ID &&\r\nmax_output_len == GEN5_BL_MAX_OUTPUT_LENGTH) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_BL;\r\n} else if (length == GEN5_HID_DESCRIPTOR_SIZE &&\r\n(resp_data[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_APP_HID_REPORT_ID) &&\r\nmax_output_len == GEN5_APP_MAX_OUTPUT_LENGTH) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\n} else {\r\ncyapa->state = CYAPA_STATE_NO_DEVICE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gen5_report_data_header_parse(struct cyapa *cyapa, u8 *reg_data)\r\n{\r\nint length;\r\nlength = get_unaligned_le16(&reg_data[GEN5_RESP_LENGTH_OFFSET]);\r\nswitch (reg_data[GEN5_RESP_REPORT_ID_OFFSET]) {\r\ncase GEN5_TOUCH_REPORT_ID:\r\nif (length < GEN5_TOUCH_REPORT_HEAD_SIZE ||\r\nlength > GEN5_TOUCH_REPORT_MAX_SIZE)\r\nreturn -EINVAL;\r\nbreak;\r\ncase GEN5_BTN_REPORT_ID:\r\ncase GEN5_OLD_PUSH_BTN_REPORT_ID:\r\ncase GEN5_PUSH_BTN_REPORT_ID:\r\nif (length < GEN5_BTN_REPORT_HEAD_SIZE ||\r\nlength > GEN5_BTN_REPORT_MAX_SIZE)\r\nreturn -EINVAL;\r\nbreak;\r\ncase GEN5_WAKEUP_EVENT_REPORT_ID:\r\nif (length != GEN5_WAKEUP_EVENT_SIZE)\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\nreturn 0;\r\n}\r\nstatic int gen5_cmd_resp_header_parse(struct cyapa *cyapa, u8 *reg_data)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\nint length;\r\nint ret;\r\nlength = get_unaligned_le16(&reg_data[GEN5_RESP_LENGTH_OFFSET]);\r\nret = cyapa_i2c_pip_read(cyapa, gen5_pip->empty_buf, length);\r\nif (ret != length)\r\nreturn ret < 0 ? ret : -EIO;\r\nif (length == GEN5_RESP_LENGTH_SIZE) {\r\nif (reg_data[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_BL_RESP_REPORT_ID) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_BL;\r\n} else {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\n}\r\n} else if ((gen5_pip->empty_buf[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_BL_RESP_REPORT_ID) &&\r\n(gen5_pip->empty_buf[GEN5_RESP_RSVD_OFFSET] ==\r\nGEN5_RESP_RSVD_KEY) &&\r\n(gen5_pip->empty_buf[GEN5_RESP_BL_SOP_OFFSET] ==\r\nGEN5_SOP_KEY) &&\r\n(gen5_pip->empty_buf[length - 1] ==\r\nGEN5_EOP_KEY)) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_BL;\r\n} else if (gen5_pip->empty_buf[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_APP_RESP_REPORT_ID &&\r\ngen5_pip->empty_buf[GEN5_RESP_RSVD_OFFSET] ==\r\nGEN5_RESP_RSVD_KEY) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\n} else {\r\ncyapa->state = CYAPA_STATE_NO_DEVICE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_state_parse(struct cyapa *cyapa, u8 *reg_data, int len)\r\n{\r\nint length;\r\nif (!reg_data || len < 3)\r\nreturn -EINVAL;\r\ncyapa->state = CYAPA_STATE_NO_DEVICE;\r\nlength = get_unaligned_le16(&reg_data[GEN5_RESP_LENGTH_OFFSET]);\r\nif (length == 0 || length == GEN5_RESP_LENGTH_SIZE) {\r\ngen5_idle_state_parse(cyapa);\r\n} else if (length == GEN5_HID_DESCRIPTOR_SIZE &&\r\n(reg_data[2] == GEN5_BL_HID_REPORT_ID ||\r\nreg_data[2] == GEN5_APP_HID_REPORT_ID)) {\r\ngen5_hid_description_header_parse(cyapa, reg_data);\r\n} else if ((length == GEN5_APP_REPORT_DESCRIPTOR_SIZE ||\r\nlength == GEN5_APP_CONTRACT_REPORT_DESCRIPTOR_SIZE) &&\r\nreg_data[2] == GEN5_APP_REPORT_DESCRIPTOR_ID) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\n} else if (length == GEN5_BL_REPORT_DESCRIPTOR_SIZE &&\r\nreg_data[2] == GEN5_BL_REPORT_DESCRIPTOR_ID) {\r\ncyapa->gen = CYAPA_GEN5;\r\ncyapa->state = CYAPA_STATE_GEN5_BL;\r\n} else if (reg_data[2] == GEN5_TOUCH_REPORT_ID ||\r\nreg_data[2] == GEN5_BTN_REPORT_ID ||\r\nreg_data[2] == GEN5_OLD_PUSH_BTN_REPORT_ID ||\r\nreg_data[2] == GEN5_PUSH_BTN_REPORT_ID ||\r\nreg_data[2] == GEN5_WAKEUP_EVENT_REPORT_ID) {\r\ngen5_report_data_header_parse(cyapa, reg_data);\r\n} else if (reg_data[2] == GEN5_BL_RESP_REPORT_ID ||\r\nreg_data[2] == GEN5_APP_RESP_REPORT_ID) {\r\ngen5_cmd_resp_header_parse(cyapa, reg_data);\r\n}\r\nif (cyapa->gen == CYAPA_GEN5) {\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nif (cyapa->state == CYAPA_STATE_GEN5_APP ||\r\ncyapa->state == CYAPA_STATE_GEN5_BL)\r\nreturn 0;\r\n}\r\nreturn -EAGAIN;\r\n}\r\nstatic int cyapa_gen5_bl_initiate(struct cyapa *cyapa,\r\nconst struct firmware *fw)\r\n{\r\nstruct cyapa_tsg_bin_image *image;\r\nstruct gen5_bl_cmd_head *bl_cmd_head;\r\nstruct gen5_bl_packet_start *bl_packet_start;\r\nstruct gen5_bl_initiate_cmd_data *cmd_data;\r\nstruct gen5_bl_packet_end *bl_packet_end;\r\nu8 cmd[CYAPA_TSG_MAX_CMD_SIZE];\r\nint cmd_len;\r\nu16 cmd_data_len;\r\nu16 cmd_crc = 0;\r\nu16 meta_data_crc = 0;\r\nu8 resp_data[11];\r\nint resp_len;\r\nint records_num;\r\nu8 *data;\r\nint error;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nmemset(cmd, 0, CYAPA_TSG_MAX_CMD_SIZE);\r\nbl_cmd_head = (struct gen5_bl_cmd_head *)cmd;\r\ncmd_data_len = CYAPA_TSG_BL_KEY_SIZE + CYAPA_TSG_FLASH_MAP_BLOCK_SIZE;\r\ncmd_len = sizeof(struct gen5_bl_cmd_head) + cmd_data_len +\r\nsizeof(struct gen5_bl_packet_end);\r\nput_unaligned_le16(GEN5_OUTPUT_REPORT_ADDR, &bl_cmd_head->addr);\r\nput_unaligned_le16(cmd_len - 2, &bl_cmd_head->length);\r\nbl_cmd_head->report_id = GEN5_BL_CMD_REPORT_ID;\r\nbl_packet_start = &bl_cmd_head->packet_start;\r\nbl_packet_start->sop = GEN5_SOP_KEY;\r\nbl_packet_start->cmd_code = GEN5_BL_CMD_INITIATE_BL;\r\nput_unaligned_le16(cmd_data_len, &bl_packet_start->data_length);\r\ncmd_data = (struct gen5_bl_initiate_cmd_data *)bl_cmd_head->data;\r\nmemcpy(cmd_data->key, cyapa_gen5_bl_cmd_key, CYAPA_TSG_BL_KEY_SIZE);\r\nimage = (struct cyapa_tsg_bin_image *)fw->data;\r\nrecords_num = (fw->size - sizeof(struct cyapa_tsg_bin_image_head)) /\r\nsizeof(struct cyapa_tsg_bin_image_data_record);\r\ndata = image->records[records_num - 1].record_data;\r\nmemcpy(cmd_data->metadata_raw_parameter, data,\r\nCYAPA_TSG_FLASH_MAP_METADATA_SIZE);\r\nmeta_data_crc = crc_itu_t(0xffff, cmd_data->metadata_raw_parameter,\r\nCYAPA_TSG_FLASH_MAP_METADATA_SIZE);\r\nput_unaligned_le16(meta_data_crc, &cmd_data->metadata_crc);\r\nbl_packet_end = (struct gen5_bl_packet_end *)(bl_cmd_head->data +\r\ncmd_data_len);\r\ncmd_crc = crc_itu_t(0xffff, (u8 *)bl_packet_start,\r\nsizeof(struct gen5_bl_packet_start) + cmd_data_len);\r\nput_unaligned_le16(cmd_crc, &bl_packet_end->crc);\r\nbl_packet_end->eop = GEN5_EOP_KEY;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, cmd_len,\r\nresp_data, &resp_len, 12000,\r\ncyapa_gen5_sort_tsg_pip_bl_resp_data, true);\r\nif (error || resp_len != GEN5_BL_INITIATE_RESP_LEN ||\r\nresp_data[2] != GEN5_BL_RESP_REPORT_ID ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]))\r\nreturn error ? error : -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic bool cyapa_gen5_sort_bl_exit_data(struct cyapa *cyapa, u8 *buf, int len)\r\n{\r\nif (buf == NULL || len < GEN5_RESP_LENGTH_SIZE)\r\nreturn false;\r\nif (buf[0] == 0 && buf[1] == 0)\r\nreturn true;\r\nif (len == GEN5_BL_FAIL_EXIT_RESP_LEN &&\r\nbuf[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_BL_RESP_REPORT_ID &&\r\nbuf[GEN5_RESP_RSVD_OFFSET] == GEN5_RESP_RSVD_KEY &&\r\nbuf[GEN5_RESP_BL_SOP_OFFSET] == GEN5_SOP_KEY &&\r\nbuf[10] == GEN5_EOP_KEY)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic int cyapa_gen5_bl_exit(struct cyapa *cyapa)\r\n{\r\nu8 bl_gen5_bl_exit[] = { 0x04, 0x00,\r\n0x0B, 0x00, 0x40, 0x00, 0x01, 0x3b, 0x00, 0x00,\r\n0x20, 0xc7, 0x17\r\n};\r\nu8 resp_data[11];\r\nint resp_len;\r\nint error;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\nbl_gen5_bl_exit, sizeof(bl_gen5_bl_exit),\r\nresp_data, &resp_len,\r\n5000, cyapa_gen5_sort_bl_exit_data, false);\r\nif (error)\r\nreturn error;\r\nif (resp_len == GEN5_BL_FAIL_EXIT_RESP_LEN ||\r\nresp_data[GEN5_RESP_REPORT_ID_OFFSET] ==\r\nGEN5_BL_RESP_REPORT_ID)\r\nreturn -EAGAIN;\r\nif (resp_data[0] == 0x00 && resp_data[1] == 0x00)\r\nreturn 0;\r\nreturn -ENODEV;\r\n}\r\nstatic int cyapa_gen5_bl_enter(struct cyapa *cyapa)\r\n{\r\nu8 cmd[] = { 0x04, 0x00, 0x05, 0x00, 0x2F, 0x00, 0x01 };\r\nu8 resp_data[2];\r\nint resp_len;\r\nint error;\r\nerror = cyapa_poll_state(cyapa, 500);\r\nif (error < 0)\r\nreturn error;\r\nif (cyapa->gen != CYAPA_GEN5)\r\nreturn -EINVAL;\r\nif (cyapa->state == CYAPA_STATE_GEN5_BL)\r\nreturn 0;\r\nif (cyapa->state != CYAPA_STATE_GEN5_APP)\r\nreturn -EAGAIN;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nresp_len = sizeof(resp_data);\r\nmemset(resp_data, 0, resp_len);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n5000, cyapa_gen5_sort_application_launch_data,\r\ntrue);\r\nif (error || resp_data[0] != 0x00 || resp_data[1] != 0x00)\r\nreturn error < 0 ? error : -EAGAIN;\r\ncyapa->operational = false;\r\ncyapa->state = CYAPA_STATE_GEN5_BL;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_check_fw(struct cyapa *cyapa, const struct firmware *fw)\r\n{\r\nstruct device *dev = &cyapa->client->dev;\r\nconst struct cyapa_tsg_bin_image *image = (const void *)fw->data;\r\nconst struct cyapa_tsg_bin_image_data_record *app_integrity;\r\nconst struct gen5_bl_metadata_row_params *metadata;\r\nsize_t flash_records_count;\r\nu32 fw_app_start, fw_upgrade_start;\r\nu16 fw_app_len, fw_upgrade_len;\r\nu16 app_crc;\r\nu16 app_integrity_crc;\r\nint record_index;\r\nint i;\r\nflash_records_count = (fw->size -\r\nsizeof(struct cyapa_tsg_bin_image_head)) /\r\nsizeof(struct cyapa_tsg_bin_image_data_record);\r\napp_integrity = &image->records[flash_records_count - 1];\r\nif (app_integrity->flash_array_id != 0x00 ||\r\nget_unaligned_be16(&app_integrity->row_number) != 0x01ff) {\r\ndev_err(dev, "%s: invalid app_integrity data.\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nmetadata = (const void *)app_integrity->record_data;\r\napp_integrity_crc = crc_itu_t(0xffff, app_integrity->record_data,\r\nCYAPA_TSG_APP_INTEGRITY_SIZE);\r\nif (app_integrity_crc != get_unaligned_le16(&metadata->metadata_crc)) {\r\ndev_err(dev, "%s: invalid app_integrity crc.\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nfw_app_start = get_unaligned_le32(&metadata->app_start);\r\nfw_app_len = get_unaligned_le16(&metadata->app_len);\r\nfw_upgrade_start = get_unaligned_le32(&metadata->upgrade_start);\r\nfw_upgrade_len = get_unaligned_le16(&metadata->upgrade_len);\r\nif (fw_app_start % CYAPA_TSG_FW_ROW_SIZE ||\r\nfw_app_len % CYAPA_TSG_FW_ROW_SIZE ||\r\nfw_upgrade_start % CYAPA_TSG_FW_ROW_SIZE ||\r\nfw_upgrade_len % CYAPA_TSG_FW_ROW_SIZE) {\r\ndev_err(dev, "%s: invalid image alignment.\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nrecord_index = fw_app_start / CYAPA_TSG_FW_ROW_SIZE -\r\nCYAPA_TSG_IMG_START_ROW_NUM;\r\napp_crc = 0xffffU;\r\nfor (i = 0; i < fw_app_len / CYAPA_TSG_FW_ROW_SIZE; i++) {\r\nconst u8 *data = image->records[record_index + i].record_data;\r\napp_crc = crc_itu_t(app_crc, data, CYAPA_TSG_FW_ROW_SIZE);\r\n}\r\nif (app_crc != get_unaligned_le16(&metadata->app_crc)) {\r\ndev_err(dev, "%s: invalid firmware app crc check.\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_write_fw_block(struct cyapa *cyapa,\r\nstruct cyapa_tsg_bin_image_data_record *flash_record)\r\n{\r\nstruct gen5_bl_cmd_head *bl_cmd_head;\r\nstruct gen5_bl_packet_start *bl_packet_start;\r\nstruct gen5_bl_flash_row_head *flash_row_head;\r\nstruct gen5_bl_packet_end *bl_packet_end;\r\nu8 cmd[CYAPA_TSG_MAX_CMD_SIZE];\r\nu16 cmd_len;\r\nu8 flash_array_id;\r\nu16 flash_row_id;\r\nu16 record_len;\r\nu8 *record_data;\r\nu16 data_len;\r\nu16 crc;\r\nu8 resp_data[11];\r\nint resp_len;\r\nint error;\r\nflash_array_id = flash_record->flash_array_id;\r\nflash_row_id = get_unaligned_be16(&flash_record->row_number);\r\nrecord_len = get_unaligned_be16(&flash_record->record_len);\r\nrecord_data = flash_record->record_data;\r\nmemset(cmd, 0, CYAPA_TSG_MAX_CMD_SIZE);\r\nbl_cmd_head = (struct gen5_bl_cmd_head *)cmd;\r\nbl_packet_start = &bl_cmd_head->packet_start;\r\ncmd_len = sizeof(struct gen5_bl_cmd_head) +\r\nsizeof(struct gen5_bl_flash_row_head) +\r\nCYAPA_TSG_FLASH_MAP_BLOCK_SIZE +\r\nsizeof(struct gen5_bl_packet_end);\r\nput_unaligned_le16(GEN5_OUTPUT_REPORT_ADDR, &bl_cmd_head->addr);\r\nput_unaligned_le16(cmd_len - 2, &bl_cmd_head->length);\r\nbl_cmd_head->report_id = GEN5_BL_CMD_REPORT_ID;\r\nbl_packet_start->sop = GEN5_SOP_KEY;\r\nbl_packet_start->cmd_code = GEN5_BL_CMD_PROGRAM_VERIFY_ROW;\r\ndata_len = sizeof(struct gen5_bl_flash_row_head) + record_len;\r\nput_unaligned_le16(data_len, &bl_packet_start->data_length);\r\nflash_row_head = (struct gen5_bl_flash_row_head *)bl_cmd_head->data;\r\nflash_row_head->flash_array_id = flash_array_id;\r\nput_unaligned_le16(flash_row_id, &flash_row_head->flash_row_id);\r\nmemcpy(flash_row_head->flash_data, record_data, record_len);\r\nbl_packet_end = (struct gen5_bl_packet_end *)(bl_cmd_head->data +\r\ndata_len);\r\ncrc = crc_itu_t(0xffff, (u8 *)bl_packet_start,\r\nsizeof(struct gen5_bl_packet_start) + data_len);\r\nput_unaligned_le16(crc, &bl_packet_end->crc);\r\nbl_packet_end->eop = GEN5_EOP_KEY;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa, cmd, cmd_len,\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_bl_resp_data, true);\r\nif (error || resp_len != GEN5_BL_BLOCK_WRITE_RESP_LEN ||\r\nresp_data[2] != GEN5_BL_RESP_REPORT_ID ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]))\r\nreturn error < 0 ? error : -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_do_fw_update(struct cyapa *cyapa,\r\nconst struct firmware *fw)\r\n{\r\nstruct device *dev = &cyapa->client->dev;\r\nstruct cyapa_tsg_bin_image_data_record *flash_record;\r\nstruct cyapa_tsg_bin_image *image =\r\n(struct cyapa_tsg_bin_image *)fw->data;\r\nint flash_records_count;\r\nint i;\r\nint error;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nflash_records_count =\r\n(fw->size - sizeof(struct cyapa_tsg_bin_image_head)) /\r\nsizeof(struct cyapa_tsg_bin_image_data_record);\r\nfor (i = 0; i < (flash_records_count - 1); i++) {\r\nflash_record = &image->records[i];\r\nerror = cyapa_gen5_write_fw_block(cyapa, flash_record);\r\nif (error) {\r\ndev_err(dev, "%s: Gen5 FW update aborted: %d\n",\r\n__func__, error);\r\nreturn error;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_change_power_state(struct cyapa *cyapa, u8 power_state)\r\n{\r\nu8 cmd[8] = { 0x04, 0x00, 0x06, 0x00, 0x2f, 0x00, 0x08, 0x01 };\r\nu8 resp_data[6];\r\nint resp_len;\r\nint error;\r\ncmd[7] = power_state;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa, cmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, false);\r\nif (error || !VALID_CMD_RESP_HEADER(resp_data, 0x08) ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]))\r\nreturn error < 0 ? error : -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_set_interval_time(struct cyapa *cyapa,\r\nu8 parameter_id, u16 interval_time)\r\n{\r\nstruct gen5_app_cmd_head *app_cmd_head;\r\nstruct gen5_app_set_parameter_data *parameter_data;\r\nu8 cmd[CYAPA_TSG_MAX_CMD_SIZE];\r\nint cmd_len;\r\nu8 resp_data[7];\r\nint resp_len;\r\nu8 parameter_size;\r\nint error;\r\nmemset(cmd, 0, CYAPA_TSG_MAX_CMD_SIZE);\r\napp_cmd_head = (struct gen5_app_cmd_head *)cmd;\r\nparameter_data = (struct gen5_app_set_parameter_data *)\r\napp_cmd_head->parameter_data;\r\ncmd_len = sizeof(struct gen5_app_cmd_head) +\r\nsizeof(struct gen5_app_set_parameter_data);\r\nswitch (parameter_id) {\r\ncase GEN5_PARAMETER_ACT_INTERVL_ID:\r\nparameter_size = GEN5_PARAMETER_ACT_INTERVL_SIZE;\r\nbreak;\r\ncase GEN5_PARAMETER_ACT_LFT_INTERVL_ID:\r\nparameter_size = GEN5_PARAMETER_ACT_LFT_INTERVL_SIZE;\r\nbreak;\r\ncase GEN5_PARAMETER_LP_INTRVL_ID:\r\nparameter_size = GEN5_PARAMETER_LP_INTRVL_SIZE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nput_unaligned_le16(GEN5_OUTPUT_REPORT_ADDR, &app_cmd_head->addr);\r\nput_unaligned_le16(cmd_len - (4 - parameter_size) - 2,\r\n&app_cmd_head->length);\r\napp_cmd_head->report_id = GEN5_APP_CMD_REPORT_ID;\r\napp_cmd_head->cmd_code = GEN5_CMD_SET_PARAMETER;\r\nparameter_data->parameter_id = parameter_id;\r\nparameter_data->parameter_size = parameter_size;\r\nput_unaligned_le32((u32)interval_time, &parameter_data->value);\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa, cmd, cmd_len,\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, false);\r\nif (error || resp_data[5] != parameter_id ||\r\nresp_data[6] != parameter_size ||\r\n!VALID_CMD_RESP_HEADER(resp_data, GEN5_CMD_SET_PARAMETER))\r\nreturn error < 0 ? error : -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_get_interval_time(struct cyapa *cyapa,\r\nu8 parameter_id, u16 *interval_time)\r\n{\r\nstruct gen5_app_cmd_head *app_cmd_head;\r\nstruct gen5_app_get_parameter_data *parameter_data;\r\nu8 cmd[CYAPA_TSG_MAX_CMD_SIZE];\r\nint cmd_len;\r\nu8 resp_data[11];\r\nint resp_len;\r\nu8 parameter_size;\r\nu16 mask, i;\r\nint error;\r\nmemset(cmd, 0, CYAPA_TSG_MAX_CMD_SIZE);\r\napp_cmd_head = (struct gen5_app_cmd_head *)cmd;\r\nparameter_data = (struct gen5_app_get_parameter_data *)\r\napp_cmd_head->parameter_data;\r\ncmd_len = sizeof(struct gen5_app_cmd_head) +\r\nsizeof(struct gen5_app_get_parameter_data);\r\n*interval_time = 0;\r\nswitch (parameter_id) {\r\ncase GEN5_PARAMETER_ACT_INTERVL_ID:\r\nparameter_size = GEN5_PARAMETER_ACT_INTERVL_SIZE;\r\nbreak;\r\ncase GEN5_PARAMETER_ACT_LFT_INTERVL_ID:\r\nparameter_size = GEN5_PARAMETER_ACT_LFT_INTERVL_SIZE;\r\nbreak;\r\ncase GEN5_PARAMETER_LP_INTRVL_ID:\r\nparameter_size = GEN5_PARAMETER_LP_INTRVL_SIZE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nput_unaligned_le16(GEN5_HID_DESCRIPTOR_ADDR, &app_cmd_head->addr);\r\nput_unaligned_le16(cmd_len - 2, &app_cmd_head->length);\r\napp_cmd_head->report_id = GEN5_APP_CMD_REPORT_ID;\r\napp_cmd_head->cmd_code = GEN5_CMD_GET_PARAMETER;\r\nparameter_data->parameter_id = parameter_id;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa, cmd, cmd_len,\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, false);\r\nif (error || resp_data[5] != parameter_id || resp_data[6] == 0 ||\r\n!VALID_CMD_RESP_HEADER(resp_data, GEN5_CMD_GET_PARAMETER))\r\nreturn error < 0 ? error : -EINVAL;\r\nmask = 0;\r\nfor (i = 0; i < parameter_size; i++)\r\nmask |= (0xff << (i * 8));\r\n*interval_time = get_unaligned_le16(&resp_data[7]) & mask;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_disable_pip_report(struct cyapa *cyapa)\r\n{\r\nstruct gen5_app_cmd_head *app_cmd_head;\r\nu8 cmd[10];\r\nu8 resp_data[7];\r\nint resp_len;\r\nint error;\r\nmemset(cmd, 0, sizeof(cmd));\r\napp_cmd_head = (struct gen5_app_cmd_head *)cmd;\r\nput_unaligned_le16(GEN5_HID_DESCRIPTOR_ADDR, &app_cmd_head->addr);\r\nput_unaligned_le16(sizeof(cmd) - 2, &app_cmd_head->length);\r\napp_cmd_head->report_id = GEN5_APP_CMD_REPORT_ID;\r\napp_cmd_head->cmd_code = GEN5_CMD_SET_PARAMETER;\r\napp_cmd_head->parameter_data[0] = GEN5_PARAMETER_DISABLE_PIP_REPORT;\r\napp_cmd_head->parameter_data[1] = 0x01;\r\napp_cmd_head->parameter_data[2] = 0x01;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa, cmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, false);\r\nif (error || resp_data[5] != GEN5_PARAMETER_DISABLE_PIP_REPORT ||\r\n!VALID_CMD_RESP_HEADER(resp_data, GEN5_CMD_SET_PARAMETER) ||\r\nresp_data[6] != 0x01)\r\nreturn error < 0 ? error : -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_deep_sleep(struct cyapa *cyapa, u8 state)\r\n{\r\nu8 cmd[] = { 0x05, 0x00, 0x00, 0x08};\r\nu8 resp_data[5];\r\nint resp_len;\r\nint error;\r\ncmd[2] = state & GEN5_DEEP_SLEEP_STATE_MASK;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa, cmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_deep_sleep_data, false);\r\nif (error || ((resp_data[3] & GEN5_DEEP_SLEEP_STATE_MASK) != state))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_set_power_mode(struct cyapa *cyapa,\r\nu8 power_mode, u16 sleep_time)\r\n{\r\nstruct device *dev = &cyapa->client->dev;\r\nu8 power_state;\r\nint error;\r\nif (cyapa->state != CYAPA_STATE_GEN5_APP)\r\nreturn 0;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nif (GEN5_DEV_GET_PWR_STATE(cyapa) == UNINIT_PWR_MODE) {\r\nGEN5_DEV_SET_PWR_STATE(cyapa, PWR_MODE_OFF);\r\n}\r\nif (GEN5_DEV_UNINIT_SLEEP_TIME(cyapa) &&\r\nGEN5_DEV_GET_PWR_STATE(cyapa) != PWR_MODE_OFF)\r\nif (cyapa_gen5_get_interval_time(cyapa,\r\nGEN5_PARAMETER_LP_INTRVL_ID,\r\n&cyapa->dev_sleep_time) != 0)\r\nGEN5_DEV_SET_SLEEP_TIME(cyapa, UNINIT_SLEEP_TIME);\r\nif (GEN5_DEV_GET_PWR_STATE(cyapa) == power_mode) {\r\nif (power_mode == PWR_MODE_OFF ||\r\npower_mode == PWR_MODE_FULL_ACTIVE ||\r\npower_mode == PWR_MODE_BTN_ONLY ||\r\nGEN5_DEV_GET_SLEEP_TIME(cyapa) == sleep_time) {\r\nreturn 0;\r\n}\r\n}\r\nif (power_mode == PWR_MODE_OFF) {\r\nerror = cyapa_gen5_deep_sleep(cyapa, GEN5_DEEP_SLEEP_STATE_OFF);\r\nif (error) {\r\ndev_err(dev, "enter deep sleep fail: %d\n", error);\r\nreturn error;\r\n}\r\nGEN5_DEV_SET_PWR_STATE(cyapa, PWR_MODE_OFF);\r\nreturn 0;\r\n}\r\nif (GEN5_DEV_GET_PWR_STATE(cyapa) == PWR_MODE_OFF) {\r\nerror = cyapa_gen5_deep_sleep(cyapa, GEN5_DEEP_SLEEP_STATE_ON);\r\nif (error) {\r\ndev_err(dev, "deep sleep wake fail: %d\n", error);\r\nreturn error;\r\n}\r\n}\r\nif (power_mode == PWR_MODE_FULL_ACTIVE) {\r\nerror = cyapa_gen5_change_power_state(cyapa,\r\nGEN5_POWER_STATE_ACTIVE);\r\nif (error) {\r\ndev_err(dev, "change to active fail: %d\n", error);\r\nreturn error;\r\n}\r\nGEN5_DEV_SET_PWR_STATE(cyapa, PWR_MODE_FULL_ACTIVE);\r\n} else if (power_mode == PWR_MODE_BTN_ONLY) {\r\nerror = cyapa_gen5_change_power_state(cyapa,\r\nGEN5_POWER_STATE_BTN_ONLY);\r\nif (error) {\r\ndev_err(dev, "fail to button only mode: %d\n", error);\r\nreturn error;\r\n}\r\nGEN5_DEV_SET_PWR_STATE(cyapa, PWR_MODE_BTN_ONLY);\r\n} else {\r\nif (GEN5_DEV_UNINIT_SLEEP_TIME(cyapa) ||\r\nsleep_time != GEN5_DEV_GET_SLEEP_TIME(cyapa))\r\nif (cyapa_gen5_set_interval_time(cyapa,\r\nGEN5_PARAMETER_LP_INTRVL_ID,\r\nsleep_time) == 0)\r\nGEN5_DEV_SET_SLEEP_TIME(cyapa, sleep_time);\r\nif (sleep_time <= GEN5_POWER_READY_MAX_INTRVL_TIME)\r\npower_state = GEN5_POWER_STATE_READY;\r\nelse\r\npower_state = GEN5_POWER_STATE_IDLE;\r\nerror = cyapa_gen5_change_power_state(cyapa, power_state);\r\nif (error) {\r\ndev_err(dev, "set power state to 0x%02x failed: %d\n",\r\npower_state, error);\r\nreturn error;\r\n}\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\ncyapa_gen5_disable_pip_report(cyapa);\r\nGEN5_DEV_SET_PWR_STATE(cyapa,\r\ncyapa_sleep_time_to_pwr_cmd(sleep_time));\r\n}\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_resume_scanning(struct cyapa *cyapa)\r\n{\r\nu8 cmd[] = { 0x04, 0x00, 0x05, 0x00, 0x2f, 0x00, 0x04 };\r\nu8 resp_data[6];\r\nint resp_len;\r\nint error;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, true);\r\nif (error || !VALID_CMD_RESP_HEADER(resp_data, 0x04))\r\nreturn -EINVAL;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_suspend_scanning(struct cyapa *cyapa)\r\n{\r\nu8 cmd[] = { 0x04, 0x00, 0x05, 0x00, 0x2f, 0x00, 0x03 };\r\nu8 resp_data[6];\r\nint resp_len;\r\nint error;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, true);\r\nif (error || !VALID_CMD_RESP_HEADER(resp_data, 0x03))\r\nreturn -EINVAL;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_calibrate_pwcs(struct cyapa *cyapa,\r\nu8 calibrate_sensing_mode_type)\r\n{\r\nstruct gen5_app_cmd_head *app_cmd_head;\r\nu8 cmd[8];\r\nu8 resp_data[6];\r\nint resp_len;\r\nint error;\r\ncyapa_empty_pip_output_data(cyapa, NULL, NULL, NULL);\r\nmemset(cmd, 0, sizeof(cmd));\r\napp_cmd_head = (struct gen5_app_cmd_head *)cmd;\r\nput_unaligned_le16(GEN5_OUTPUT_REPORT_ADDR, &app_cmd_head->addr);\r\nput_unaligned_le16(sizeof(cmd) - 2, &app_cmd_head->length);\r\napp_cmd_head->report_id = GEN5_APP_CMD_REPORT_ID;\r\napp_cmd_head->cmd_code = GEN5_CMD_CALIBRATE;\r\napp_cmd_head->parameter_data[0] = calibrate_sensing_mode_type;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n5000, cyapa_gen5_sort_tsg_pip_app_resp_data, true);\r\nif (error || !VALID_CMD_RESP_HEADER(resp_data, GEN5_CMD_CALIBRATE) ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]))\r\nreturn error < 0 ? error : -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic ssize_t cyapa_gen5_do_calibrate(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cyapa *cyapa = dev_get_drvdata(dev);\r\nint error, calibrate_error;\r\nerror = cyapa_gen5_suspend_scanning(cyapa);\r\nif (error)\r\nreturn error;\r\ncalibrate_error = cyapa_gen5_calibrate_pwcs(cyapa,\r\nCYAPA_SENSING_MODE_MUTUAL_CAP_FINE);\r\nif (calibrate_error)\r\ngoto resume_scanning;\r\ncalibrate_error = cyapa_gen5_calibrate_pwcs(cyapa,\r\nCYAPA_SENSING_MODE_SELF_CAP);\r\nif (calibrate_error)\r\ngoto resume_scanning;\r\nresume_scanning:\r\nerror = cyapa_gen5_resume_scanning(cyapa);\r\nif (error || calibrate_error)\r\nreturn error ? error : calibrate_error;\r\nreturn count;\r\n}\r\nstatic s32 twos_complement_to_s32(s32 value, int num_bits)\r\n{\r\nif (value >> (num_bits - 1))\r\nvalue |= -1 << num_bits;\r\nreturn value;\r\n}\r\nstatic s32 cyapa_parse_structure_data(u8 data_format, u8 *buf, int buf_len)\r\n{\r\nint data_size;\r\nbool big_endian;\r\nbool unsigned_type;\r\ns32 value;\r\ndata_size = (data_format & 0x07);\r\nbig_endian = ((data_format & 0x10) == 0x00);\r\nunsigned_type = ((data_format & 0x20) == 0x00);\r\nif (buf_len < data_size)\r\nreturn 0;\r\nswitch (data_size) {\r\ncase 1:\r\nvalue = buf[0];\r\nbreak;\r\ncase 2:\r\nif (big_endian)\r\nvalue = get_unaligned_be16(buf);\r\nelse\r\nvalue = get_unaligned_le16(buf);\r\nbreak;\r\ncase 4:\r\nif (big_endian)\r\nvalue = get_unaligned_be32(buf);\r\nelse\r\nvalue = get_unaligned_le32(buf);\r\nbreak;\r\ndefault:\r\nvalue = 0;\r\nbreak;\r\n}\r\nif (!unsigned_type)\r\nvalue = twos_complement_to_s32(value, data_size * 8);\r\nreturn value;\r\n}\r\nstatic void cyapa_gen5_guess_electrodes(struct cyapa *cyapa,\r\nint *electrodes_rx, int *electrodes_tx)\r\n{\r\nif (cyapa->electrodes_rx != 0) {\r\n*electrodes_rx = cyapa->electrodes_rx;\r\n*electrodes_tx = (cyapa->electrodes_x == *electrodes_rx) ?\r\ncyapa->electrodes_y : cyapa->electrodes_x;\r\n} else {\r\n*electrodes_tx = min(cyapa->electrodes_x, cyapa->electrodes_y);\r\n*electrodes_rx = max(cyapa->electrodes_x, cyapa->electrodes_y);\r\n}\r\n}\r\nstatic int cyapa_gen5_read_idac_data(struct cyapa *cyapa,\r\nu8 cmd_code, u8 idac_data_type, int *data_size,\r\nint *idac_max, int *idac_min, int *idac_ave)\r\n{\r\nstruct gen5_app_cmd_head *cmd_head;\r\nu8 cmd[12];\r\nu8 resp_data[256];\r\nint resp_len;\r\nint read_len;\r\nint value;\r\nu16 offset;\r\nint read_elements;\r\nbool read_global_idac;\r\nint sum, count, max_element_cnt;\r\nint tmp_max, tmp_min, tmp_ave, tmp_sum, tmp_count;\r\nint electrodes_rx, electrodes_tx;\r\nint i;\r\nint error;\r\nif (cmd_code != GEN5_CMD_RETRIEVE_DATA_STRUCTURE ||\r\n(idac_data_type != GEN5_RETRIEVE_MUTUAL_PWC_DATA &&\r\nidac_data_type != GEN5_RETRIEVE_SELF_CAP_PWC_DATA) ||\r\n!data_size || !idac_max || !idac_min || !idac_ave)\r\nreturn -EINVAL;\r\n*idac_max = INT_MIN;\r\n*idac_min = INT_MAX;\r\nsum = count = tmp_count = 0;\r\nelectrodes_rx = electrodes_tx = 0;\r\nif (*data_size == 0) {\r\nread_global_idac = true;\r\noffset = 0;\r\n*data_size = 4;\r\ntmp_max = INT_MIN;\r\ntmp_min = INT_MAX;\r\ntmp_ave = tmp_sum = tmp_count = 0;\r\nif (idac_data_type == GEN5_RETRIEVE_MUTUAL_PWC_DATA) {\r\nif (cyapa->aligned_electrodes_rx == 0) {\r\ncyapa_gen5_guess_electrodes(cyapa,\r\n&electrodes_rx, &electrodes_tx);\r\ncyapa->aligned_electrodes_rx =\r\n(electrodes_rx + 3) & ~3u;\r\n}\r\nmax_element_cnt =\r\n(cyapa->aligned_electrodes_rx + 7) & ~7u;\r\n} else {\r\nmax_element_cnt = 2;\r\n}\r\n} else {\r\nread_global_idac = false;\r\nif (*data_size > 4)\r\n*data_size = 4;\r\nif (idac_data_type == GEN5_RETRIEVE_MUTUAL_PWC_DATA) {\r\noffset = cyapa->aligned_electrodes_rx * (*data_size);\r\nif (cyapa->electrodes_rx == cyapa->electrodes_x)\r\nelectrodes_tx = cyapa->electrodes_y;\r\nelse\r\nelectrodes_tx = cyapa->electrodes_x;\r\nmax_element_cnt = ((cyapa->aligned_electrodes_rx + 7) &\r\n~7u) * electrodes_tx;\r\n} else {\r\noffset = 2;\r\nmax_element_cnt = cyapa->electrodes_x +\r\ncyapa->electrodes_y;\r\nmax_element_cnt = (max_element_cnt + 3) & ~3u;\r\n}\r\n}\r\nmemset(cmd, 0, sizeof(cmd));\r\ncmd_head = (struct gen5_app_cmd_head *)cmd;\r\nput_unaligned_le16(GEN5_OUTPUT_REPORT_ADDR, &cmd_head->addr);\r\nput_unaligned_le16(sizeof(cmd) - 2, &cmd_head->length);\r\ncmd_head->report_id = GEN5_APP_CMD_REPORT_ID;\r\ncmd_head->cmd_code = cmd_code;\r\ndo {\r\nread_elements = (256 - GEN5_RESP_DATA_STRUCTURE_OFFSET) /\r\n(*data_size);\r\nread_elements = min(read_elements, max_element_cnt - count);\r\nread_len = read_elements * (*data_size);\r\nput_unaligned_le16(offset, &cmd_head->parameter_data[0]);\r\nput_unaligned_le16(read_len, &cmd_head->parameter_data[2]);\r\ncmd_head->parameter_data[4] = idac_data_type;\r\nresp_len = GEN5_RESP_DATA_STRUCTURE_OFFSET + read_len;\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data,\r\ntrue);\r\nif (error || resp_len < GEN5_RESP_DATA_STRUCTURE_OFFSET ||\r\n!VALID_CMD_RESP_HEADER(resp_data, cmd_code) ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]) ||\r\nresp_data[6] != idac_data_type)\r\nreturn (error < 0) ? error : -EAGAIN;\r\nread_len = get_unaligned_le16(&resp_data[7]);\r\nif (read_len == 0)\r\nbreak;\r\n*data_size = (resp_data[9] & GEN5_PWC_DATA_ELEMENT_SIZE_MASK);\r\nif (read_len < *data_size)\r\nreturn -EINVAL;\r\nif (read_global_idac &&\r\nidac_data_type == GEN5_RETRIEVE_SELF_CAP_PWC_DATA) {\r\n*idac_max = cyapa_parse_structure_data(\r\nresp_data[9],\r\n&resp_data[GEN5_RESP_DATA_STRUCTURE_OFFSET],\r\n*data_size);\r\n*idac_min = cyapa_parse_structure_data(\r\nresp_data[9],\r\n&resp_data[GEN5_RESP_DATA_STRUCTURE_OFFSET +\r\n*data_size],\r\n*data_size);\r\nbreak;\r\n}\r\noffset += read_len;\r\nfor (i = 10; i < (read_len + GEN5_RESP_DATA_STRUCTURE_OFFSET);\r\ni += *data_size) {\r\nvalue = cyapa_parse_structure_data(resp_data[9],\r\n&resp_data[i], *data_size);\r\n*idac_min = min(value, *idac_min);\r\n*idac_max = max(value, *idac_max);\r\nif (idac_data_type == GEN5_RETRIEVE_MUTUAL_PWC_DATA &&\r\ntmp_count < cyapa->aligned_electrodes_rx &&\r\nread_global_idac) {\r\nif (!tmp_ave || value > tmp_ave / 2) {\r\ntmp_min = min(value, tmp_min);\r\ntmp_max = max(value, tmp_max);\r\ntmp_sum += value;\r\ntmp_count++;\r\ntmp_ave = tmp_sum / tmp_count;\r\n}\r\n}\r\nsum += value;\r\ncount++;\r\nif (count >= max_element_cnt)\r\ngoto out;\r\n}\r\n} while (true);\r\nout:\r\n*idac_ave = count ? (sum / count) : 0;\r\nif (read_global_idac &&\r\nidac_data_type == GEN5_RETRIEVE_MUTUAL_PWC_DATA) {\r\nif (tmp_count == 0)\r\nreturn 0;\r\nif (tmp_count == cyapa->aligned_electrodes_rx) {\r\ncyapa->electrodes_rx = cyapa->electrodes_rx ?\r\ncyapa->electrodes_rx : electrodes_rx;\r\n} else if (tmp_count == electrodes_rx) {\r\ncyapa->electrodes_rx = cyapa->electrodes_rx ?\r\ncyapa->electrodes_rx : electrodes_rx;\r\ncyapa->aligned_electrodes_rx = electrodes_rx;\r\n} else {\r\ncyapa->electrodes_rx = cyapa->electrodes_rx ?\r\ncyapa->electrodes_rx : electrodes_tx;\r\ncyapa->aligned_electrodes_rx = tmp_count;\r\n}\r\n*idac_min = tmp_min;\r\n*idac_max = tmp_max;\r\n*idac_ave = tmp_ave;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_read_mutual_idac_data(struct cyapa *cyapa,\r\nint *gidac_mutual_max, int *gidac_mutual_min, int *gidac_mutual_ave,\r\nint *lidac_mutual_max, int *lidac_mutual_min, int *lidac_mutual_ave)\r\n{\r\nint data_size;\r\nint error;\r\n*gidac_mutual_max = *gidac_mutual_min = *gidac_mutual_ave = 0;\r\n*lidac_mutual_max = *lidac_mutual_min = *lidac_mutual_ave = 0;\r\ndata_size = 0;\r\nerror = cyapa_gen5_read_idac_data(cyapa,\r\nGEN5_CMD_RETRIEVE_DATA_STRUCTURE,\r\nGEN5_RETRIEVE_MUTUAL_PWC_DATA,\r\n&data_size,\r\ngidac_mutual_max, gidac_mutual_min, gidac_mutual_ave);\r\nif (error)\r\nreturn error;\r\nerror = cyapa_gen5_read_idac_data(cyapa,\r\nGEN5_CMD_RETRIEVE_DATA_STRUCTURE,\r\nGEN5_RETRIEVE_MUTUAL_PWC_DATA,\r\n&data_size,\r\nlidac_mutual_max, lidac_mutual_min, lidac_mutual_ave);\r\nreturn error;\r\n}\r\nstatic int cyapa_gen5_read_self_idac_data(struct cyapa *cyapa,\r\nint *gidac_self_rx, int *gidac_self_tx,\r\nint *lidac_self_max, int *lidac_self_min, int *lidac_self_ave)\r\n{\r\nint data_size;\r\nint error;\r\n*gidac_self_rx = *gidac_self_tx = 0;\r\n*lidac_self_max = *lidac_self_min = *lidac_self_ave = 0;\r\ndata_size = 0;\r\nerror = cyapa_gen5_read_idac_data(cyapa,\r\nGEN5_CMD_RETRIEVE_DATA_STRUCTURE,\r\nGEN5_RETRIEVE_SELF_CAP_PWC_DATA,\r\n&data_size,\r\nlidac_self_max, lidac_self_min, lidac_self_ave);\r\nif (error)\r\nreturn error;\r\n*gidac_self_rx = *lidac_self_max;\r\n*gidac_self_tx = *lidac_self_min;\r\nerror = cyapa_gen5_read_idac_data(cyapa,\r\nGEN5_CMD_RETRIEVE_DATA_STRUCTURE,\r\nGEN5_RETRIEVE_SELF_CAP_PWC_DATA,\r\n&data_size,\r\nlidac_self_max, lidac_self_min, lidac_self_ave);\r\nreturn error;\r\n}\r\nstatic ssize_t cyapa_gen5_execute_panel_scan(struct cyapa *cyapa)\r\n{\r\nstruct gen5_app_cmd_head *app_cmd_head;\r\nu8 cmd[7];\r\nu8 resp_data[6];\r\nint resp_len;\r\nint error;\r\nmemset(cmd, 0, sizeof(cmd));\r\napp_cmd_head = (struct gen5_app_cmd_head *)cmd;\r\nput_unaligned_le16(GEN5_OUTPUT_REPORT_ADDR, &app_cmd_head->addr);\r\nput_unaligned_le16(sizeof(cmd) - 2, &app_cmd_head->length);\r\napp_cmd_head->report_id = GEN5_APP_CMD_REPORT_ID;\r\napp_cmd_head->cmd_code = GEN5_CMD_EXECUTE_PANEL_SCAN;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, true);\r\nif (error || resp_len != sizeof(resp_data) ||\r\n!VALID_CMD_RESP_HEADER(resp_data,\r\nGEN5_CMD_EXECUTE_PANEL_SCAN) ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]))\r\nreturn error ? error : -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_read_panel_scan_raw_data(struct cyapa *cyapa,\r\nu8 cmd_code, u8 raw_data_type, int raw_data_max_num,\r\nint *raw_data_max, int *raw_data_min, int *raw_data_ave,\r\nu8 *buffer)\r\n{\r\nstruct gen5_app_cmd_head *app_cmd_head;\r\nstruct gen5_retrieve_panel_scan_data *panel_sacn_data;\r\nu8 cmd[12];\r\nu8 resp_data[256];\r\nint resp_len;\r\nint read_elements;\r\nint read_len;\r\nu16 offset;\r\ns32 value;\r\nint sum, count;\r\nint data_size;\r\ns32 *intp;\r\nint i;\r\nint error;\r\nif (cmd_code != GEN5_CMD_RETRIEVE_PANEL_SCAN ||\r\n(raw_data_type > GEN5_PANEL_SCAN_SELF_DIFFCOUNT) ||\r\n!raw_data_max || !raw_data_min || !raw_data_ave)\r\nreturn -EINVAL;\r\nintp = (s32 *)buffer;\r\n*raw_data_max = INT_MIN;\r\n*raw_data_min = INT_MAX;\r\nsum = count = 0;\r\noffset = 0;\r\nread_elements = (256 - GEN5_RESP_DATA_STRUCTURE_OFFSET) / 4;\r\nread_len = read_elements * 4;\r\napp_cmd_head = (struct gen5_app_cmd_head *)cmd;\r\nput_unaligned_le16(GEN5_OUTPUT_REPORT_ADDR, &app_cmd_head->addr);\r\nput_unaligned_le16(sizeof(cmd) - 2, &app_cmd_head->length);\r\napp_cmd_head->report_id = GEN5_APP_CMD_REPORT_ID;\r\napp_cmd_head->cmd_code = cmd_code;\r\npanel_sacn_data = (struct gen5_retrieve_panel_scan_data *)\r\napp_cmd_head->parameter_data;\r\ndo {\r\nput_unaligned_le16(offset, &panel_sacn_data->read_offset);\r\nput_unaligned_le16(read_elements,\r\n&panel_sacn_data->read_elements);\r\npanel_sacn_data->data_id = raw_data_type;\r\nresp_len = GEN5_RESP_DATA_STRUCTURE_OFFSET + read_len;\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\ncmd, sizeof(cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_app_resp_data, true);\r\nif (error || resp_len < GEN5_RESP_DATA_STRUCTURE_OFFSET ||\r\n!VALID_CMD_RESP_HEADER(resp_data, cmd_code) ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]) ||\r\nresp_data[6] != raw_data_type)\r\nreturn error ? error : -EAGAIN;\r\nread_elements = get_unaligned_le16(&resp_data[7]);\r\nif (read_elements == 0)\r\nbreak;\r\ndata_size = (resp_data[9] & GEN5_PWC_DATA_ELEMENT_SIZE_MASK);\r\noffset += read_elements;\r\nif (read_elements) {\r\nfor (i = GEN5_RESP_DATA_STRUCTURE_OFFSET;\r\ni < (read_elements * data_size +\r\nGEN5_RESP_DATA_STRUCTURE_OFFSET);\r\ni += data_size) {\r\nvalue = cyapa_parse_structure_data(resp_data[9],\r\n&resp_data[i], data_size);\r\n*raw_data_min = min(value, *raw_data_min);\r\n*raw_data_max = max(value, *raw_data_max);\r\nif (intp)\r\nput_unaligned_le32(value, &intp[count]);\r\nsum += value;\r\ncount++;\r\n}\r\n}\r\nif (count >= raw_data_max_num)\r\nbreak;\r\nread_elements = (sizeof(resp_data) -\r\nGEN5_RESP_DATA_STRUCTURE_OFFSET) / data_size;\r\nread_len = read_elements * data_size;\r\n} while (true);\r\n*raw_data_ave = count ? (sum / count) : 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t cyapa_gen5_show_baseline(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct cyapa *cyapa = dev_get_drvdata(dev);\r\nint gidac_mutual_max, gidac_mutual_min, gidac_mutual_ave;\r\nint lidac_mutual_max, lidac_mutual_min, lidac_mutual_ave;\r\nint gidac_self_rx, gidac_self_tx;\r\nint lidac_self_max, lidac_self_min, lidac_self_ave;\r\nint raw_cap_mutual_max, raw_cap_mutual_min, raw_cap_mutual_ave;\r\nint raw_cap_self_max, raw_cap_self_min, raw_cap_self_ave;\r\nint mutual_diffdata_max, mutual_diffdata_min, mutual_diffdata_ave;\r\nint self_diffdata_max, self_diffdata_min, self_diffdata_ave;\r\nint mutual_baseline_max, mutual_baseline_min, mutual_baseline_ave;\r\nint self_baseline_max, self_baseline_min, self_baseline_ave;\r\nint error, resume_error;\r\nint size;\r\nif (cyapa->state != CYAPA_STATE_GEN5_APP)\r\nreturn -EBUSY;\r\nerror = cyapa_gen5_suspend_scanning(cyapa);\r\nif (error)\r\nreturn error;\r\ngidac_self_rx = gidac_self_tx = 0;\r\nerror = cyapa_gen5_read_mutual_idac_data(cyapa,\r\n&gidac_mutual_max, &gidac_mutual_min,\r\n&gidac_mutual_ave, &lidac_mutual_max,\r\n&lidac_mutual_min, &lidac_mutual_ave);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_read_self_idac_data(cyapa,\r\n&gidac_self_rx, &gidac_self_tx,\r\n&lidac_self_max, &lidac_self_min,\r\n&lidac_self_ave);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_execute_panel_scan(cyapa);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_read_panel_scan_raw_data(cyapa,\r\nGEN5_CMD_RETRIEVE_PANEL_SCAN,\r\nGEN5_PANEL_SCAN_MUTUAL_RAW_DATA,\r\ncyapa->electrodes_x * cyapa->electrodes_y,\r\n&raw_cap_mutual_max, &raw_cap_mutual_min,\r\n&raw_cap_mutual_ave,\r\nNULL);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_read_panel_scan_raw_data(cyapa,\r\nGEN5_CMD_RETRIEVE_PANEL_SCAN,\r\nGEN5_PANEL_SCAN_SELF_RAW_DATA,\r\ncyapa->electrodes_x + cyapa->electrodes_y,\r\n&raw_cap_self_max, &raw_cap_self_min,\r\n&raw_cap_self_ave,\r\nNULL);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_read_panel_scan_raw_data(cyapa,\r\nGEN5_CMD_RETRIEVE_PANEL_SCAN,\r\nGEN5_PANEL_SCAN_MUTUAL_DIFFCOUNT,\r\ncyapa->electrodes_x * cyapa->electrodes_y,\r\n&mutual_diffdata_max, &mutual_diffdata_min,\r\n&mutual_diffdata_ave,\r\nNULL);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_read_panel_scan_raw_data(cyapa,\r\nGEN5_CMD_RETRIEVE_PANEL_SCAN,\r\nGEN5_PANEL_SCAN_SELF_DIFFCOUNT,\r\ncyapa->electrodes_x + cyapa->electrodes_y,\r\n&self_diffdata_max, &self_diffdata_min,\r\n&self_diffdata_ave,\r\nNULL);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_read_panel_scan_raw_data(cyapa,\r\nGEN5_CMD_RETRIEVE_PANEL_SCAN,\r\nGEN5_PANEL_SCAN_MUTUAL_BASELINE,\r\ncyapa->electrodes_x * cyapa->electrodes_y,\r\n&mutual_baseline_max, &mutual_baseline_min,\r\n&mutual_baseline_ave,\r\nNULL);\r\nif (error)\r\ngoto resume_scanning;\r\nerror = cyapa_gen5_read_panel_scan_raw_data(cyapa,\r\nGEN5_CMD_RETRIEVE_PANEL_SCAN,\r\nGEN5_PANEL_SCAN_SELF_BASELINE,\r\ncyapa->electrodes_x + cyapa->electrodes_y,\r\n&self_baseline_max, &self_baseline_min,\r\n&self_baseline_ave,\r\nNULL);\r\nif (error)\r\ngoto resume_scanning;\r\nresume_scanning:\r\nresume_error = cyapa_gen5_resume_scanning(cyapa);\r\nif (resume_error || error)\r\nreturn resume_error ? resume_error : error;\r\nsize = scnprintf(buf, PAGE_SIZE, "%d %d %d %d %d %d %d %d %d %d %d ",\r\ngidac_mutual_min, gidac_mutual_max, gidac_mutual_ave,\r\nlidac_mutual_min, lidac_mutual_max, lidac_mutual_ave,\r\ngidac_self_rx, gidac_self_tx,\r\nlidac_self_min, lidac_self_max, lidac_self_ave);\r\nsize += scnprintf(buf + size, PAGE_SIZE - size,\r\n"%d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d\n",\r\nraw_cap_mutual_min, raw_cap_mutual_max, raw_cap_mutual_ave,\r\nraw_cap_self_min, raw_cap_self_max, raw_cap_self_ave,\r\nmutual_diffdata_min, mutual_diffdata_max, mutual_diffdata_ave,\r\nself_diffdata_min, self_diffdata_max, self_diffdata_ave,\r\nmutual_baseline_min, mutual_baseline_max, mutual_baseline_ave,\r\nself_baseline_min, self_baseline_max, self_baseline_ave);\r\nreturn size;\r\n}\r\nstatic bool cyapa_gen5_sort_system_info_data(struct cyapa *cyapa,\r\nu8 *buf, int len)\r\n{\r\nif (VALID_CMD_RESP_HEADER(buf, 0x02))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic int cyapa_gen5_bl_query_data(struct cyapa *cyapa)\r\n{\r\nu8 bl_query_data_cmd[] = { 0x04, 0x00, 0x0b, 0x00, 0x40, 0x00,\r\n0x01, 0x3c, 0x00, 0x00, 0xb0, 0x42, 0x17\r\n};\r\nu8 resp_data[GEN5_BL_READ_APP_INFO_RESP_LEN];\r\nint resp_len;\r\nint error;\r\nresp_len = GEN5_BL_READ_APP_INFO_RESP_LEN;\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\nbl_query_data_cmd, sizeof(bl_query_data_cmd),\r\nresp_data, &resp_len,\r\n500, cyapa_gen5_sort_tsg_pip_bl_resp_data, false);\r\nif (error || resp_len != GEN5_BL_READ_APP_INFO_RESP_LEN ||\r\n!GEN5_CMD_COMPLETE_SUCCESS(resp_data[5]))\r\nreturn error ? error : -EIO;\r\nmemcpy(&cyapa->product_id[0], &resp_data[8], 5);\r\ncyapa->product_id[5] = '-';\r\nmemcpy(&cyapa->product_id[6], &resp_data[13], 6);\r\ncyapa->product_id[12] = '-';\r\nmemcpy(&cyapa->product_id[13], &resp_data[19], 2);\r\ncyapa->product_id[15] = '\0';\r\ncyapa->fw_maj_ver = resp_data[22];\r\ncyapa->fw_min_ver = resp_data[23];\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_get_query_data(struct cyapa *cyapa)\r\n{\r\nu8 get_system_information[] = {\r\n0x04, 0x00, 0x05, 0x00, 0x2f, 0x00, 0x02\r\n};\r\nu8 resp_data[71];\r\nint resp_len;\r\nu16 product_family;\r\nint error;\r\nresp_len = sizeof(resp_data);\r\nerror = cyapa_i2c_pip_cmd_irq_sync(cyapa,\r\nget_system_information, sizeof(get_system_information),\r\nresp_data, &resp_len,\r\n2000, cyapa_gen5_sort_system_info_data, false);\r\nif (error || resp_len < sizeof(resp_data))\r\nreturn error ? error : -EIO;\r\nproduct_family = get_unaligned_le16(&resp_data[7]);\r\nif ((product_family & GEN5_PRODUCT_FAMILY_MASK) !=\r\nGEN5_PRODUCT_FAMILY_TRACKPAD)\r\nreturn -EINVAL;\r\ncyapa->fw_maj_ver = resp_data[15];\r\ncyapa->fw_min_ver = resp_data[16];\r\ncyapa->electrodes_x = resp_data[52];\r\ncyapa->electrodes_y = resp_data[53];\r\ncyapa->physical_size_x = get_unaligned_le16(&resp_data[54]) / 100;\r\ncyapa->physical_size_y = get_unaligned_le16(&resp_data[56]) / 100;\r\ncyapa->max_abs_x = get_unaligned_le16(&resp_data[58]);\r\ncyapa->max_abs_y = get_unaligned_le16(&resp_data[60]);\r\ncyapa->max_z = get_unaligned_le16(&resp_data[62]);\r\ncyapa->x_origin = resp_data[64] & 0x01;\r\ncyapa->y_origin = resp_data[65] & 0x01;\r\ncyapa->btn_capability = (resp_data[70] << 3) & CAPABILITY_BTN_MASK;\r\nmemcpy(&cyapa->product_id[0], &resp_data[33], 5);\r\ncyapa->product_id[5] = '-';\r\nmemcpy(&cyapa->product_id[6], &resp_data[38], 6);\r\ncyapa->product_id[12] = '-';\r\nmemcpy(&cyapa->product_id[13], &resp_data[44], 2);\r\ncyapa->product_id[15] = '\0';\r\nif (!cyapa->electrodes_x || !cyapa->electrodes_y ||\r\n!cyapa->physical_size_x || !cyapa->physical_size_y ||\r\n!cyapa->max_abs_x || !cyapa->max_abs_y || !cyapa->max_z)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_do_operational_check(struct cyapa *cyapa)\r\n{\r\nstruct device *dev = &cyapa->client->dev;\r\nint error;\r\nif (cyapa->gen != CYAPA_GEN5)\r\nreturn -ENODEV;\r\nswitch (cyapa->state) {\r\ncase CYAPA_STATE_GEN5_BL:\r\nerror = cyapa_gen5_bl_exit(cyapa);\r\nif (error) {\r\ncyapa_gen5_bl_query_data(cyapa);\r\ngoto out;\r\n}\r\ncyapa->state = CYAPA_STATE_GEN5_APP;\r\ncase CYAPA_STATE_GEN5_APP:\r\nerror = cyapa_gen5_set_power_mode(cyapa,\r\nPWR_MODE_FULL_ACTIVE, 0);\r\nif (error)\r\ndev_warn(dev, "%s: failed to set power active mode.\n",\r\n__func__);\r\nerror = cyapa_gen5_get_query_data(cyapa);\r\nif (error)\r\ngoto out;\r\nif (memcmp(cyapa->product_id, product_id,\r\nstrlen(product_id)) != 0) {\r\ndev_err(dev, "%s: unknown product ID (%s)\n",\r\n__func__, cyapa->product_id);\r\nerror = -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nerror = -EINVAL;\r\n}\r\nout:\r\nreturn error;\r\n}\r\nstatic bool cyapa_gen5_irq_cmd_handler(struct cyapa *cyapa)\r\n{\r\nstruct cyapa_gen5_cmd_states *gen5_pip = &cyapa->cmd_states.gen5;\r\nint length;\r\nif (atomic_read(&gen5_pip->cmd_issued)) {\r\nif (gen5_pip->is_irq_mode == false)\r\nreturn false;\r\ncyapa_i2c_pip_read(cyapa, gen5_pip->irq_cmd_buf,\r\nGEN5_RESP_LENGTH_SIZE);\r\nlength = get_unaligned_le16(gen5_pip->irq_cmd_buf);\r\nlength = (length <= GEN5_RESP_LENGTH_SIZE) ?\r\nGEN5_RESP_LENGTH_SIZE : length;\r\nif (length > GEN5_RESP_LENGTH_SIZE)\r\ncyapa_i2c_pip_read(cyapa,\r\ngen5_pip->irq_cmd_buf, length);\r\nif (!(gen5_pip->resp_sort_func &&\r\ngen5_pip->resp_sort_func(cyapa,\r\ngen5_pip->irq_cmd_buf, length))) {\r\nlength = 0;\r\nif (gen5_pip->resp_len)\r\nlength = *gen5_pip->resp_len;\r\ncyapa_empty_pip_output_data(cyapa,\r\ngen5_pip->resp_data,\r\n&length,\r\ngen5_pip->resp_sort_func);\r\nif (gen5_pip->resp_len && length != 0) {\r\n*gen5_pip->resp_len = length;\r\natomic_dec(&gen5_pip->cmd_issued);\r\ncomplete(&gen5_pip->cmd_ready);\r\n}\r\nreturn false;\r\n}\r\nif (gen5_pip->resp_data && gen5_pip->resp_len) {\r\n*gen5_pip->resp_len = (*gen5_pip->resp_len < length) ?\r\n*gen5_pip->resp_len : length;\r\nmemcpy(gen5_pip->resp_data, gen5_pip->irq_cmd_buf,\r\n*gen5_pip->resp_len);\r\n}\r\natomic_dec(&gen5_pip->cmd_issued);\r\ncomplete(&gen5_pip->cmd_ready);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic void cyapa_gen5_report_buttons(struct cyapa *cyapa,\r\nconst struct cyapa_gen5_report_data *report_data)\r\n{\r\nstruct input_dev *input = cyapa->input;\r\nu8 buttons = report_data->report_head[GEN5_BUTTONS_OFFSET];\r\nbuttons = (buttons << CAPABILITY_BTN_SHIFT) & CAPABILITY_BTN_MASK;\r\nif (cyapa->btn_capability & CAPABILITY_LEFT_BTN_MASK) {\r\ninput_report_key(input, BTN_LEFT,\r\n!!(buttons & CAPABILITY_LEFT_BTN_MASK));\r\n}\r\nif (cyapa->btn_capability & CAPABILITY_MIDDLE_BTN_MASK) {\r\ninput_report_key(input, BTN_MIDDLE,\r\n!!(buttons & CAPABILITY_MIDDLE_BTN_MASK));\r\n}\r\nif (cyapa->btn_capability & CAPABILITY_RIGHT_BTN_MASK) {\r\ninput_report_key(input, BTN_RIGHT,\r\n!!(buttons & CAPABILITY_RIGHT_BTN_MASK));\r\n}\r\ninput_sync(input);\r\n}\r\nstatic void cyapa_gen5_report_slot_data(struct cyapa *cyapa,\r\nconst struct cyapa_gen5_touch_record *touch)\r\n{\r\nstruct input_dev *input = cyapa->input;\r\nu8 event_id = GEN5_GET_EVENT_ID(touch->touch_tip_event_id);\r\nint slot = GEN5_GET_TOUCH_ID(touch->touch_tip_event_id);\r\nint x, y;\r\nif (event_id == RECORD_EVENT_LIFTOFF)\r\nreturn;\r\ninput_mt_slot(input, slot);\r\ninput_mt_report_slot_state(input, MT_TOOL_FINGER, true);\r\nx = (touch->x_hi << 8) | touch->x_lo;\r\nif (cyapa->x_origin)\r\nx = cyapa->max_abs_x - x;\r\ninput_report_abs(input, ABS_MT_POSITION_X, x);\r\ny = (touch->y_hi << 8) | touch->y_lo;\r\nif (cyapa->y_origin)\r\ny = cyapa->max_abs_y - y;\r\ninput_report_abs(input, ABS_MT_POSITION_Y, y);\r\ninput_report_abs(input, ABS_MT_PRESSURE,\r\ntouch->z);\r\ninput_report_abs(input, ABS_MT_TOUCH_MAJOR,\r\ntouch->major_axis_len);\r\ninput_report_abs(input, ABS_MT_TOUCH_MINOR,\r\ntouch->minor_axis_len);\r\ninput_report_abs(input, ABS_MT_WIDTH_MAJOR,\r\ntouch->major_tool_len);\r\ninput_report_abs(input, ABS_MT_WIDTH_MINOR,\r\ntouch->minor_tool_len);\r\ninput_report_abs(input, ABS_MT_ORIENTATION,\r\ntouch->orientation);\r\n}\r\nstatic void cyapa_gen5_report_touches(struct cyapa *cyapa,\r\nconst struct cyapa_gen5_report_data *report_data)\r\n{\r\nstruct input_dev *input = cyapa->input;\r\nunsigned int touch_num;\r\nint i;\r\ntouch_num = report_data->report_head[GEN5_NUMBER_OF_TOUCH_OFFSET] &\r\nGEN5_NUMBER_OF_TOUCH_MASK;\r\nfor (i = 0; i < touch_num; i++)\r\ncyapa_gen5_report_slot_data(cyapa,\r\n&report_data->touch_records[i]);\r\ninput_mt_sync_frame(input);\r\ninput_sync(input);\r\n}\r\nstatic int cyapa_gen5_irq_handler(struct cyapa *cyapa)\r\n{\r\nstruct device *dev = &cyapa->client->dev;\r\nstruct cyapa_gen5_report_data report_data;\r\nint ret;\r\nu8 report_id;\r\nunsigned int report_len;\r\nif (cyapa->gen != CYAPA_GEN5 ||\r\ncyapa->state != CYAPA_STATE_GEN5_APP) {\r\ndev_err(dev, "invalid device state, gen=%d, state=0x%02x\n",\r\ncyapa->gen, cyapa->state);\r\nreturn -EINVAL;\r\n}\r\nret = cyapa_i2c_pip_read(cyapa, (u8 *)&report_data,\r\nGEN5_RESP_LENGTH_SIZE);\r\nif (ret != GEN5_RESP_LENGTH_SIZE) {\r\ndev_err(dev, "failed to read length bytes, (%d)\n", ret);\r\nreturn -EINVAL;\r\n}\r\nreport_len = get_unaligned_le16(\r\n&report_data.report_head[GEN5_RESP_LENGTH_OFFSET]);\r\nif (report_len < GEN5_RESP_LENGTH_SIZE) {\r\ndev_err(dev, "invalid report_len=%d. bytes: %02x %02x\n",\r\nreport_len, report_data.report_head[0],\r\nreport_data.report_head[1]);\r\nreturn -EINVAL;\r\n}\r\nif (report_len == GEN5_RESP_LENGTH_SIZE)\r\nreturn 0;\r\nret = cyapa_i2c_pip_read(cyapa, (u8 *)&report_data, report_len);\r\nif (ret != report_len) {\r\ndev_err(dev, "failed to read %d bytes report data, (%d)\n",\r\nreport_len, ret);\r\nreturn -EINVAL;\r\n}\r\nreport_id = report_data.report_head[GEN5_RESP_REPORT_ID_OFFSET];\r\nif (report_id == GEN5_WAKEUP_EVENT_REPORT_ID &&\r\nreport_len == GEN5_WAKEUP_EVENT_SIZE) {\r\nreturn 0;\r\n} else if (report_id != GEN5_TOUCH_REPORT_ID &&\r\nreport_id != GEN5_BTN_REPORT_ID &&\r\nreport_id != GEN5_OLD_PUSH_BTN_REPORT_ID &&\r\nreport_id != GEN5_PUSH_BTN_REPORT_ID) {\r\ndev_err(dev, "invalid report_id=0x%02x\n", report_id);\r\nreturn -EINVAL;\r\n}\r\nif (report_id == GEN5_TOUCH_REPORT_ID &&\r\n(report_len < GEN5_TOUCH_REPORT_HEAD_SIZE ||\r\nreport_len > GEN5_TOUCH_REPORT_MAX_SIZE)) {\r\ndev_err(dev, "invalid touch packet length=%d\n", report_len);\r\nreturn 0;\r\n}\r\nif ((report_id == GEN5_BTN_REPORT_ID ||\r\nreport_id == GEN5_OLD_PUSH_BTN_REPORT_ID ||\r\nreport_id == GEN5_PUSH_BTN_REPORT_ID) &&\r\n(report_len < GEN5_BTN_REPORT_HEAD_SIZE ||\r\nreport_len > GEN5_BTN_REPORT_MAX_SIZE)) {\r\ndev_err(dev, "invalid button packet length=%d\n", report_len);\r\nreturn 0;\r\n}\r\nif (report_id == GEN5_TOUCH_REPORT_ID)\r\ncyapa_gen5_report_touches(cyapa, &report_data);\r\nelse\r\ncyapa_gen5_report_buttons(cyapa, &report_data);\r\nreturn 0;\r\n}\r\nstatic int cyapa_gen5_bl_activate(struct cyapa *cyapa) { return 0; }\r\nstatic int cyapa_gen5_bl_deactivate(struct cyapa *cyapa) { return 0; }

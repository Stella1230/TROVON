static u32\r\nnv40_instmem_rd32(struct nvkm_object *object, u64 addr)\r\n{\r\nstruct nv04_instmem_priv *priv = (void *)object;\r\nreturn ioread32_native(priv->iomem + addr);\r\n}\r\nstatic void\r\nnv40_instmem_wr32(struct nvkm_object *object, u64 addr, u32 data)\r\n{\r\nstruct nv04_instmem_priv *priv = (void *)object;\r\niowrite32_native(data, priv->iomem + addr);\r\n}\r\nstatic int\r\nnv40_instmem_ctor(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nstruct nvkm_device *device = nv_device(parent);\r\nstruct nv04_instmem_priv *priv;\r\nint ret, bar, vs;\r\nret = nvkm_instmem_create(parent, engine, oclass, &priv);\r\n*pobject = nv_object(priv);\r\nif (ret)\r\nreturn ret;\r\nif (nv_device_resource_len(device, 2))\r\nbar = 2;\r\nelse\r\nbar = 3;\r\npriv->iomem = ioremap(nv_device_resource_start(device, bar),\r\nnv_device_resource_len(device, bar));\r\nif (!priv->iomem) {\r\nnv_error(priv, "unable to map PRAMIN BAR\n");\r\nreturn -EFAULT;\r\n}\r\nvs = hweight8((nv_rd32(priv, 0x001540) & 0x0000ff00) >> 8);\r\nif (device->chipset == 0x40) priv->base.reserved = 0x6aa0 * vs;\r\nelse if (device->chipset < 0x43) priv->base.reserved = 0x4f00 * vs;\r\nelse if (nv44_gr_class(priv)) priv->base.reserved = 0x4980 * vs;\r\nelse priv->base.reserved = 0x4a40 * vs;\r\npriv->base.reserved += 16 * 1024;\r\npriv->base.reserved *= 32;\r\npriv->base.reserved += 512 * 1024;\r\npriv->base.reserved += 512 * 1024;\r\npriv->base.reserved = round_up(priv->base.reserved, 4096);\r\nret = nvkm_mm_init(&priv->heap, 0, priv->base.reserved, 1);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_gpuobj_new(nv_object(priv), NULL, 0x10000, 0, 0,\r\n&priv->vbios);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_ramht_new(nv_object(priv), NULL, 0x08000, 0, &priv->ramht);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_gpuobj_new(nv_object(priv), NULL, 0x08000, 0, 0,\r\n&priv->ramro);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_gpuobj_new(nv_object(priv), NULL, 0x20000, 0,\r\nNVOBJ_FLAG_ZERO_ALLOC, &priv->ramfc);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}

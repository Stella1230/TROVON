static inline struct mmio_74xx_gpio_priv *to_74xx_gpio(struct gpio_chip *gc)\r\n{\r\nstruct bgpio_chip *bgc = to_bgpio_chip(gc);\r\nreturn container_of(bgc, struct mmio_74xx_gpio_priv, bgc);\r\n}\r\nstatic int mmio_74xx_get_direction(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct mmio_74xx_gpio_priv *priv = to_74xx_gpio(gc);\r\nreturn (priv->flags & MMIO_74XX_DIR_OUT) ? GPIOF_DIR_OUT : GPIOF_DIR_IN;\r\n}\r\nstatic int mmio_74xx_dir_in(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nstruct mmio_74xx_gpio_priv *priv = to_74xx_gpio(gc);\r\nreturn (priv->flags & MMIO_74XX_DIR_OUT) ? -ENOTSUPP : 0;\r\n}\r\nstatic int mmio_74xx_dir_out(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nstruct mmio_74xx_gpio_priv *priv = to_74xx_gpio(gc);\r\nif (priv->flags & MMIO_74XX_DIR_OUT) {\r\ngc->set(gc, gpio, val);\r\nreturn 0;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int mmio_74xx_gpio_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *of_id =\r\nof_match_device(mmio_74xx_gpio_ids, &pdev->dev);\r\nstruct mmio_74xx_gpio_priv *priv;\r\nstruct resource *res;\r\nvoid __iomem *dat;\r\nint err;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndat = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dat))\r\nreturn PTR_ERR(dat);\r\npriv->flags = (unsigned)of_id->data;\r\nerr = bgpio_init(&priv->bgc, &pdev->dev,\r\nDIV_ROUND_UP(MMIO_74XX_BIT_CNT(priv->flags), 8),\r\ndat, NULL, NULL, NULL, NULL, 0);\r\nif (err)\r\nreturn err;\r\npriv->bgc.gc.direction_input = mmio_74xx_dir_in;\r\npriv->bgc.gc.direction_output = mmio_74xx_dir_out;\r\npriv->bgc.gc.get_direction = mmio_74xx_get_direction;\r\npriv->bgc.gc.ngpio = MMIO_74XX_BIT_CNT(priv->flags);\r\npriv->bgc.gc.owner = THIS_MODULE;\r\nplatform_set_drvdata(pdev, priv);\r\nreturn gpiochip_add(&priv->bgc.gc);\r\n}\r\nstatic int mmio_74xx_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct mmio_74xx_gpio_priv *priv = platform_get_drvdata(pdev);\r\nreturn bgpio_remove(&priv->bgc);\r\n}

static acpi_status\r\nacpi_ut_check_text_mode_corruption(u8 *table, u32 table_length, u32 file_length)\r\n{\r\nu32 i;\r\nu32 pairs = 0;\r\nif (table_length != file_length) {\r\nACPI_WARNING((AE_INFO,\r\n"File length (0x%X) is not the same as the table length (0x%X)",\r\nfile_length, table_length));\r\n}\r\nfor (i = 1; i < file_length; i++) {\r\nif (table[i] == 0x0A) {\r\nif (table[i - 1] != 0x0D) {\r\nreturn (AE_OK);\r\n} else {\r\npairs++;\r\n}\r\ni++;\r\n}\r\n}\r\nif (!pairs) {\r\nreturn (AE_OK);\r\n}\r\nacpi_os_printf("Table has been corrupted by text mode conversion\n");\r\nacpi_os_printf("All LFs (%u) were changed to CR/LF pairs\n", pairs);\r\nacpi_os_printf("Table cannot be repaired!\n");\r\nreturn (AE_BAD_VALUE);\r\n}\r\nstatic acpi_status\r\nacpi_ut_read_table(FILE * fp,\r\nstruct acpi_table_header **table, u32 *table_length)\r\n{\r\nstruct acpi_table_header table_header;\r\nu32 actual;\r\nacpi_status status;\r\nu32 file_size;\r\nu8 standard_header = TRUE;\r\ns32 count;\r\nfile_size = cm_get_file_size(fp);\r\nif (file_size == ACPI_UINT32_MAX) {\r\nreturn (AE_ERROR);\r\n}\r\nif (file_size < 4) {\r\nreturn (AE_BAD_HEADER);\r\n}\r\nfseek(fp, 0, SEEK_SET);\r\ncount = fread(&table_header, 1, sizeof(struct acpi_table_header), fp);\r\nif (count != sizeof(struct acpi_table_header)) {\r\nacpi_os_printf("Could not read the table header\n");\r\nreturn (AE_BAD_HEADER);\r\n}\r\nif (ACPI_VALIDATE_RSDP_SIG(table_header.signature)) {\r\n*table_length = file_size;\r\nstandard_header = FALSE;\r\n} else {\r\n#if 0\r\nstatus = acpi_tb_validate_table_header(&table_header);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_os_printf("Table header is invalid!\n");\r\nreturn (status);\r\n}\r\n#endif\r\nif (table_header.length > file_size) {\r\nacpi_os_printf\r\n("TableHeader length [0x%X] greater than the input file size [0x%X]\n",\r\ntable_header.length, file_size);\r\n#ifdef ACPI_ASL_COMPILER\r\nstatus = fl_check_for_ascii(fp, NULL, FALSE);\r\nif (ACPI_SUCCESS(status)) {\r\nacpi_os_printf\r\n("File appears to be ASCII only, must be binary\n");\r\n}\r\n#endif\r\nreturn (AE_BAD_HEADER);\r\n}\r\n#ifdef ACPI_OBSOLETE_CODE\r\nif (!ACPI_COMPARE_NAME\r\n((char *)table_header.signature, ACPI_SIG_DSDT)\r\n&& !ACPI_COMPARE_NAME((char *)table_header.signature,\r\nACPI_SIG_PSDT)\r\n&& !ACPI_COMPARE_NAME((char *)table_header.signature,\r\nACPI_SIG_SSDT)) {\r\nacpi_os_printf\r\n("Table signature [%4.4s] is invalid or not supported\n",\r\n(char *)table_header.signature);\r\nACPI_DUMP_BUFFER(&table_header,\r\nsizeof(struct acpi_table_header));\r\nreturn (AE_ERROR);\r\n}\r\n#endif\r\n*table_length = table_header.length;\r\n}\r\n*table = acpi_os_allocate((size_t) file_size);\r\nif (!*table) {\r\nacpi_os_printf\r\n("Could not allocate memory for ACPI table %4.4s (size=0x%X)\n",\r\ntable_header.signature, *table_length);\r\nreturn (AE_NO_MEMORY);\r\n}\r\nfseek(fp, 0, SEEK_SET);\r\nactual = fread(*table, 1, (size_t) file_size, fp);\r\nif (actual == file_size) {\r\nif (standard_header) {\r\nstatus = acpi_tb_verify_checksum((void *)*table,\r\nACPI_CAST_PTR(struct\r\nacpi_table_header,\r\n*table)->\r\nlength);\r\nif (status == AE_BAD_CHECKSUM) {\r\nstatus =\r\nacpi_ut_check_text_mode_corruption((u8 *)\r\n*table,\r\nfile_size,\r\n(*table)->\r\nlength);\r\nreturn (status);\r\n}\r\n}\r\nreturn (AE_OK);\r\n}\r\nif (actual > 0) {\r\nacpi_os_printf("Warning - reading table, asked for %X got %X\n",\r\nfile_size, actual);\r\nreturn (AE_OK);\r\n}\r\nacpi_os_printf("Error - could not read the table file\n");\r\nacpi_os_free(*table);\r\n*table = NULL;\r\n*table_length = 0;\r\nreturn (AE_ERROR);\r\n}\r\nacpi_status\r\nacpi_ut_read_table_from_file(char *filename, struct acpi_table_header ** table)\r\n{\r\nFILE *file;\r\nu32 file_size;\r\nu32 table_length;\r\nacpi_status status = AE_ERROR;\r\nfile = fopen(filename, "rb");\r\nif (!file) {\r\nperror("Could not open input file");\r\nreturn (status);\r\n}\r\nfile_size = cm_get_file_size(file);\r\nif (file_size == ACPI_UINT32_MAX) {\r\ngoto exit;\r\n}\r\nfprintf(stderr,\r\n"Loading Acpi table from file %10s - Length %.8u (%06X)\n",\r\nfilename, file_size, file_size);\r\nstatus = acpi_ut_read_table(file, table, &table_length);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_os_printf("Could not get table from the file\n");\r\n}\r\nexit:\r\nfclose(file);\r\nreturn (status);\r\n}

int eprintf(int level, int var, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint ret = 0;\r\nif (var >= level) {\r\nva_start(args, fmt);\r\nret = vfprintf(stderr, fmt, args);\r\nva_end(args);\r\n}\r\nreturn ret;\r\n}\r\nstatic PyObject *pyrf_mmap_event__repr(struct pyrf_event *pevent)\r\n{\r\nPyObject *ret;\r\nchar *s;\r\nif (asprintf(&s, "{ type: mmap, pid: %u, tid: %u, start: %#" PRIx64 ", "\r\n"length: %#" PRIx64 ", offset: %#" PRIx64 ", "\r\n"filename: %s }",\r\npevent->event.mmap.pid, pevent->event.mmap.tid,\r\npevent->event.mmap.start, pevent->event.mmap.len,\r\npevent->event.mmap.pgoff, pevent->event.mmap.filename) < 0) {\r\nret = PyErr_NoMemory();\r\n} else {\r\nret = PyString_FromString(s);\r\nfree(s);\r\n}\r\nreturn ret;\r\n}\r\nstatic PyObject *pyrf_task_event__repr(struct pyrf_event *pevent)\r\n{\r\nreturn PyString_FromFormat("{ type: %s, pid: %u, ppid: %u, tid: %u, "\r\n"ptid: %u, time: %" PRIu64 "}",\r\npevent->event.header.type == PERF_RECORD_FORK ? "fork" : "exit",\r\npevent->event.fork.pid,\r\npevent->event.fork.ppid,\r\npevent->event.fork.tid,\r\npevent->event.fork.ptid,\r\npevent->event.fork.time);\r\n}\r\nstatic PyObject *pyrf_comm_event__repr(struct pyrf_event *pevent)\r\n{\r\nreturn PyString_FromFormat("{ type: comm, pid: %u, tid: %u, comm: %s }",\r\npevent->event.comm.pid,\r\npevent->event.comm.tid,\r\npevent->event.comm.comm);\r\n}\r\nstatic PyObject *pyrf_throttle_event__repr(struct pyrf_event *pevent)\r\n{\r\nstruct throttle_event *te = (struct throttle_event *)(&pevent->event.header + 1);\r\nreturn PyString_FromFormat("{ type: %sthrottle, time: %" PRIu64 ", id: %" PRIu64\r\n", stream_id: %" PRIu64 " }",\r\npevent->event.header.type == PERF_RECORD_THROTTLE ? "" : "un",\r\nte->time, te->id, te->stream_id);\r\n}\r\nstatic PyObject *pyrf_lost_event__repr(struct pyrf_event *pevent)\r\n{\r\nPyObject *ret;\r\nchar *s;\r\nif (asprintf(&s, "{ type: lost, id: %#" PRIx64 ", "\r\n"lost: %#" PRIx64 " }",\r\npevent->event.lost.id, pevent->event.lost.lost) < 0) {\r\nret = PyErr_NoMemory();\r\n} else {\r\nret = PyString_FromString(s);\r\nfree(s);\r\n}\r\nreturn ret;\r\n}\r\nstatic PyObject *pyrf_read_event__repr(struct pyrf_event *pevent)\r\n{\r\nreturn PyString_FromFormat("{ type: read, pid: %u, tid: %u }",\r\npevent->event.read.pid,\r\npevent->event.read.tid);\r\n}\r\nstatic PyObject *pyrf_sample_event__repr(struct pyrf_event *pevent)\r\n{\r\nPyObject *ret;\r\nchar *s;\r\nif (asprintf(&s, "{ type: sample }") < 0) {\r\nret = PyErr_NoMemory();\r\n} else {\r\nret = PyString_FromString(s);\r\nfree(s);\r\n}\r\nreturn ret;\r\n}\r\nstatic int pyrf_event__setup_types(void)\r\n{\r\nint err;\r\npyrf_mmap_event__type.tp_new =\r\npyrf_task_event__type.tp_new =\r\npyrf_comm_event__type.tp_new =\r\npyrf_lost_event__type.tp_new =\r\npyrf_read_event__type.tp_new =\r\npyrf_sample_event__type.tp_new =\r\npyrf_throttle_event__type.tp_new = PyType_GenericNew;\r\nerr = PyType_Ready(&pyrf_mmap_event__type);\r\nif (err < 0)\r\ngoto out;\r\nerr = PyType_Ready(&pyrf_lost_event__type);\r\nif (err < 0)\r\ngoto out;\r\nerr = PyType_Ready(&pyrf_task_event__type);\r\nif (err < 0)\r\ngoto out;\r\nerr = PyType_Ready(&pyrf_comm_event__type);\r\nif (err < 0)\r\ngoto out;\r\nerr = PyType_Ready(&pyrf_throttle_event__type);\r\nif (err < 0)\r\ngoto out;\r\nerr = PyType_Ready(&pyrf_read_event__type);\r\nif (err < 0)\r\ngoto out;\r\nerr = PyType_Ready(&pyrf_sample_event__type);\r\nif (err < 0)\r\ngoto out;\r\nout:\r\nreturn err;\r\n}\r\nstatic PyObject *pyrf_event__new(union perf_event *event)\r\n{\r\nstruct pyrf_event *pevent;\r\nPyTypeObject *ptype;\r\nif (event->header.type < PERF_RECORD_MMAP ||\r\nevent->header.type > PERF_RECORD_SAMPLE)\r\nreturn NULL;\r\nptype = pyrf_event__type[event->header.type];\r\npevent = PyObject_New(struct pyrf_event, ptype);\r\nif (pevent != NULL)\r\nmemcpy(&pevent->event, event, event->header.size);\r\nreturn (PyObject *)pevent;\r\n}\r\nstatic int pyrf_cpu_map__init(struct pyrf_cpu_map *pcpus,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstatic char *kwlist[] = { "cpustr", NULL };\r\nchar *cpustr = NULL;\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs, "|s",\r\nkwlist, &cpustr))\r\nreturn -1;\r\npcpus->cpus = cpu_map__new(cpustr);\r\nif (pcpus->cpus == NULL)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic void pyrf_cpu_map__delete(struct pyrf_cpu_map *pcpus)\r\n{\r\ncpu_map__delete(pcpus->cpus);\r\npcpus->ob_type->tp_free((PyObject*)pcpus);\r\n}\r\nstatic Py_ssize_t pyrf_cpu_map__length(PyObject *obj)\r\n{\r\nstruct pyrf_cpu_map *pcpus = (void *)obj;\r\nreturn pcpus->cpus->nr;\r\n}\r\nstatic PyObject *pyrf_cpu_map__item(PyObject *obj, Py_ssize_t i)\r\n{\r\nstruct pyrf_cpu_map *pcpus = (void *)obj;\r\nif (i >= pcpus->cpus->nr)\r\nreturn NULL;\r\nreturn Py_BuildValue("i", pcpus->cpus->map[i]);\r\n}\r\nstatic int pyrf_cpu_map__setup_types(void)\r\n{\r\npyrf_cpu_map__type.tp_new = PyType_GenericNew;\r\nreturn PyType_Ready(&pyrf_cpu_map__type);\r\n}\r\nstatic int pyrf_thread_map__init(struct pyrf_thread_map *pthreads,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstatic char *kwlist[] = { "pid", "tid", "uid", NULL };\r\nint pid = -1, tid = -1, uid = UINT_MAX;\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs, "|iii",\r\nkwlist, &pid, &tid, &uid))\r\nreturn -1;\r\npthreads->threads = thread_map__new(pid, tid, uid);\r\nif (pthreads->threads == NULL)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic void pyrf_thread_map__delete(struct pyrf_thread_map *pthreads)\r\n{\r\nthread_map__delete(pthreads->threads);\r\npthreads->ob_type->tp_free((PyObject*)pthreads);\r\n}\r\nstatic Py_ssize_t pyrf_thread_map__length(PyObject *obj)\r\n{\r\nstruct pyrf_thread_map *pthreads = (void *)obj;\r\nreturn pthreads->threads->nr;\r\n}\r\nstatic PyObject *pyrf_thread_map__item(PyObject *obj, Py_ssize_t i)\r\n{\r\nstruct pyrf_thread_map *pthreads = (void *)obj;\r\nif (i >= pthreads->threads->nr)\r\nreturn NULL;\r\nreturn Py_BuildValue("i", pthreads->threads->map[i]);\r\n}\r\nstatic int pyrf_thread_map__setup_types(void)\r\n{\r\npyrf_thread_map__type.tp_new = PyType_GenericNew;\r\nreturn PyType_Ready(&pyrf_thread_map__type);\r\n}\r\nstatic int pyrf_evsel__init(struct pyrf_evsel *pevsel,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstruct perf_event_attr attr = {\r\n.type = PERF_TYPE_HARDWARE,\r\n.config = PERF_COUNT_HW_CPU_CYCLES,\r\n.sample_type = PERF_SAMPLE_PERIOD | PERF_SAMPLE_TID,\r\n};\r\nstatic char *kwlist[] = {\r\n"type",\r\n"config",\r\n"sample_freq",\r\n"sample_period",\r\n"sample_type",\r\n"read_format",\r\n"disabled",\r\n"inherit",\r\n"pinned",\r\n"exclusive",\r\n"exclude_user",\r\n"exclude_kernel",\r\n"exclude_hv",\r\n"exclude_idle",\r\n"mmap",\r\n"comm",\r\n"freq",\r\n"inherit_stat",\r\n"enable_on_exec",\r\n"task",\r\n"watermark",\r\n"precise_ip",\r\n"mmap_data",\r\n"sample_id_all",\r\n"wakeup_events",\r\n"bp_type",\r\n"bp_addr",\r\n"bp_len",\r\nNULL\r\n};\r\nu64 sample_period = 0;\r\nu32 disabled = 0,\r\ninherit = 0,\r\npinned = 0,\r\nexclusive = 0,\r\nexclude_user = 0,\r\nexclude_kernel = 0,\r\nexclude_hv = 0,\r\nexclude_idle = 0,\r\nmmap = 0,\r\ncomm = 0,\r\nfreq = 1,\r\ninherit_stat = 0,\r\nenable_on_exec = 0,\r\ntask = 0,\r\nwatermark = 0,\r\nprecise_ip = 0,\r\nmmap_data = 0,\r\nsample_id_all = 1;\r\nint idx = 0;\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs,\r\n"|iKiKKiiiiiiiiiiiiiiiiiiiiiKK", kwlist,\r\n&attr.type, &attr.config, &attr.sample_freq,\r\n&sample_period, &attr.sample_type,\r\n&attr.read_format, &disabled, &inherit,\r\n&pinned, &exclusive, &exclude_user,\r\n&exclude_kernel, &exclude_hv, &exclude_idle,\r\n&mmap, &comm, &freq, &inherit_stat,\r\n&enable_on_exec, &task, &watermark,\r\n&precise_ip, &mmap_data, &sample_id_all,\r\n&attr.wakeup_events, &attr.bp_type,\r\n&attr.bp_addr, &attr.bp_len, &idx))\r\nreturn -1;\r\nif (sample_period != 0) {\r\nif (attr.sample_freq != 0)\r\nreturn -1;\r\nattr.sample_period = sample_period;\r\n}\r\nattr.disabled = disabled;\r\nattr.inherit = inherit;\r\nattr.pinned = pinned;\r\nattr.exclusive = exclusive;\r\nattr.exclude_user = exclude_user;\r\nattr.exclude_kernel = exclude_kernel;\r\nattr.exclude_hv = exclude_hv;\r\nattr.exclude_idle = exclude_idle;\r\nattr.mmap = mmap;\r\nattr.comm = comm;\r\nattr.freq = freq;\r\nattr.inherit_stat = inherit_stat;\r\nattr.enable_on_exec = enable_on_exec;\r\nattr.task = task;\r\nattr.watermark = watermark;\r\nattr.precise_ip = precise_ip;\r\nattr.mmap_data = mmap_data;\r\nattr.sample_id_all = sample_id_all;\r\nperf_evsel__init(&pevsel->evsel, &attr, idx);\r\nreturn 0;\r\n}\r\nstatic void pyrf_evsel__delete(struct pyrf_evsel *pevsel)\r\n{\r\nperf_evsel__exit(&pevsel->evsel);\r\npevsel->ob_type->tp_free((PyObject*)pevsel);\r\n}\r\nstatic PyObject *pyrf_evsel__open(struct pyrf_evsel *pevsel,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstruct perf_evsel *evsel = &pevsel->evsel;\r\nstruct cpu_map *cpus = NULL;\r\nstruct thread_map *threads = NULL;\r\nPyObject *pcpus = NULL, *pthreads = NULL;\r\nint group = 0, inherit = 0;\r\nstatic char *kwlist[] = { "cpus", "threads", "group", "inherit", NULL };\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs, "|OOii", kwlist,\r\n&pcpus, &pthreads, &group, &inherit))\r\nreturn NULL;\r\nif (pthreads != NULL)\r\nthreads = ((struct pyrf_thread_map *)pthreads)->threads;\r\nif (pcpus != NULL)\r\ncpus = ((struct pyrf_cpu_map *)pcpus)->cpus;\r\nevsel->attr.inherit = inherit;\r\nif (perf_evsel__open(evsel, cpus, threads) < 0) {\r\nPyErr_SetFromErrno(PyExc_OSError);\r\nreturn NULL;\r\n}\r\nPy_INCREF(Py_None);\r\nreturn Py_None;\r\n}\r\nstatic int pyrf_evsel__setup_types(void)\r\n{\r\npyrf_evsel__type.tp_new = PyType_GenericNew;\r\nreturn PyType_Ready(&pyrf_evsel__type);\r\n}\r\nstatic int pyrf_evlist__init(struct pyrf_evlist *pevlist,\r\nPyObject *args, PyObject *kwargs __maybe_unused)\r\n{\r\nPyObject *pcpus = NULL, *pthreads = NULL;\r\nstruct cpu_map *cpus;\r\nstruct thread_map *threads;\r\nif (!PyArg_ParseTuple(args, "OO", &pcpus, &pthreads))\r\nreturn -1;\r\nthreads = ((struct pyrf_thread_map *)pthreads)->threads;\r\ncpus = ((struct pyrf_cpu_map *)pcpus)->cpus;\r\nperf_evlist__init(&pevlist->evlist, cpus, threads);\r\nreturn 0;\r\n}\r\nstatic void pyrf_evlist__delete(struct pyrf_evlist *pevlist)\r\n{\r\nperf_evlist__exit(&pevlist->evlist);\r\npevlist->ob_type->tp_free((PyObject*)pevlist);\r\n}\r\nstatic PyObject *pyrf_evlist__mmap(struct pyrf_evlist *pevlist,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstruct perf_evlist *evlist = &pevlist->evlist;\r\nstatic char *kwlist[] = { "pages", "overwrite", NULL };\r\nint pages = 128, overwrite = false;\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs, "|ii", kwlist,\r\n&pages, &overwrite))\r\nreturn NULL;\r\nif (perf_evlist__mmap(evlist, pages, overwrite) < 0) {\r\nPyErr_SetFromErrno(PyExc_OSError);\r\nreturn NULL;\r\n}\r\nPy_INCREF(Py_None);\r\nreturn Py_None;\r\n}\r\nstatic PyObject *pyrf_evlist__poll(struct pyrf_evlist *pevlist,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstruct perf_evlist *evlist = &pevlist->evlist;\r\nstatic char *kwlist[] = { "timeout", NULL };\r\nint timeout = -1, n;\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs, "|i", kwlist, &timeout))\r\nreturn NULL;\r\nn = perf_evlist__poll(evlist, timeout);\r\nif (n < 0) {\r\nPyErr_SetFromErrno(PyExc_OSError);\r\nreturn NULL;\r\n}\r\nreturn Py_BuildValue("i", n);\r\n}\r\nstatic PyObject *pyrf_evlist__get_pollfd(struct pyrf_evlist *pevlist,\r\nPyObject *args __maybe_unused,\r\nPyObject *kwargs __maybe_unused)\r\n{\r\nstruct perf_evlist *evlist = &pevlist->evlist;\r\nPyObject *list = PyList_New(0);\r\nint i;\r\nfor (i = 0; i < evlist->pollfd.nr; ++i) {\r\nPyObject *file;\r\nFILE *fp = fdopen(evlist->pollfd.entries[i].fd, "r");\r\nif (fp == NULL)\r\ngoto free_list;\r\nfile = PyFile_FromFile(fp, "perf", "r", NULL);\r\nif (file == NULL)\r\ngoto free_list;\r\nif (PyList_Append(list, file) != 0) {\r\nPy_DECREF(file);\r\ngoto free_list;\r\n}\r\nPy_DECREF(file);\r\n}\r\nreturn list;\r\nfree_list:\r\nreturn PyErr_NoMemory();\r\n}\r\nstatic PyObject *pyrf_evlist__add(struct pyrf_evlist *pevlist,\r\nPyObject *args,\r\nPyObject *kwargs __maybe_unused)\r\n{\r\nstruct perf_evlist *evlist = &pevlist->evlist;\r\nPyObject *pevsel;\r\nstruct perf_evsel *evsel;\r\nif (!PyArg_ParseTuple(args, "O", &pevsel))\r\nreturn NULL;\r\nPy_INCREF(pevsel);\r\nevsel = &((struct pyrf_evsel *)pevsel)->evsel;\r\nevsel->idx = evlist->nr_entries;\r\nperf_evlist__add(evlist, evsel);\r\nreturn Py_BuildValue("i", evlist->nr_entries);\r\n}\r\nstatic PyObject *pyrf_evlist__read_on_cpu(struct pyrf_evlist *pevlist,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstruct perf_evlist *evlist = &pevlist->evlist;\r\nunion perf_event *event;\r\nint sample_id_all = 1, cpu;\r\nstatic char *kwlist[] = { "cpu", "sample_id_all", NULL };\r\nint err;\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs, "i|i", kwlist,\r\n&cpu, &sample_id_all))\r\nreturn NULL;\r\nevent = perf_evlist__mmap_read(evlist, cpu);\r\nif (event != NULL) {\r\nPyObject *pyevent = pyrf_event__new(event);\r\nstruct pyrf_event *pevent = (struct pyrf_event *)pyevent;\r\nperf_evlist__mmap_consume(evlist, cpu);\r\nif (pyevent == NULL)\r\nreturn PyErr_NoMemory();\r\nerr = perf_evlist__parse_sample(evlist, event, &pevent->sample);\r\nif (err)\r\nreturn PyErr_Format(PyExc_OSError,\r\n"perf: can't parse sample, err=%d", err);\r\nreturn pyevent;\r\n}\r\nPy_INCREF(Py_None);\r\nreturn Py_None;\r\n}\r\nstatic PyObject *pyrf_evlist__open(struct pyrf_evlist *pevlist,\r\nPyObject *args, PyObject *kwargs)\r\n{\r\nstruct perf_evlist *evlist = &pevlist->evlist;\r\nint group = 0;\r\nstatic char *kwlist[] = { "group", NULL };\r\nif (!PyArg_ParseTupleAndKeywords(args, kwargs, "|OOii", kwlist, &group))\r\nreturn NULL;\r\nif (group)\r\nperf_evlist__set_leader(evlist);\r\nif (perf_evlist__open(evlist) < 0) {\r\nPyErr_SetFromErrno(PyExc_OSError);\r\nreturn NULL;\r\n}\r\nPy_INCREF(Py_None);\r\nreturn Py_None;\r\n}\r\nstatic Py_ssize_t pyrf_evlist__length(PyObject *obj)\r\n{\r\nstruct pyrf_evlist *pevlist = (void *)obj;\r\nreturn pevlist->evlist.nr_entries;\r\n}\r\nstatic PyObject *pyrf_evlist__item(PyObject *obj, Py_ssize_t i)\r\n{\r\nstruct pyrf_evlist *pevlist = (void *)obj;\r\nstruct perf_evsel *pos;\r\nif (i >= pevlist->evlist.nr_entries)\r\nreturn NULL;\r\nevlist__for_each(&pevlist->evlist, pos) {\r\nif (i-- == 0)\r\nbreak;\r\n}\r\nreturn Py_BuildValue("O", container_of(pos, struct pyrf_evsel, evsel));\r\n}\r\nstatic int pyrf_evlist__setup_types(void)\r\n{\r\npyrf_evlist__type.tp_new = PyType_GenericNew;\r\nreturn PyType_Ready(&pyrf_evlist__type);\r\n}\r\nPyMODINIT_FUNC initperf(void)\r\n{\r\nPyObject *obj;\r\nint i;\r\nPyObject *dict, *module = Py_InitModule("perf", perf__methods);\r\nif (module == NULL ||\r\npyrf_event__setup_types() < 0 ||\r\npyrf_evlist__setup_types() < 0 ||\r\npyrf_evsel__setup_types() < 0 ||\r\npyrf_thread_map__setup_types() < 0 ||\r\npyrf_cpu_map__setup_types() < 0)\r\nreturn;\r\npage_size = sysconf(_SC_PAGE_SIZE);\r\nPy_INCREF(&pyrf_evlist__type);\r\nPyModule_AddObject(module, "evlist", (PyObject*)&pyrf_evlist__type);\r\nPy_INCREF(&pyrf_evsel__type);\r\nPyModule_AddObject(module, "evsel", (PyObject*)&pyrf_evsel__type);\r\nPy_INCREF(&pyrf_thread_map__type);\r\nPyModule_AddObject(module, "thread_map", (PyObject*)&pyrf_thread_map__type);\r\nPy_INCREF(&pyrf_cpu_map__type);\r\nPyModule_AddObject(module, "cpu_map", (PyObject*)&pyrf_cpu_map__type);\r\ndict = PyModule_GetDict(module);\r\nif (dict == NULL)\r\ngoto error;\r\nfor (i = 0; perf__constants[i].name != NULL; i++) {\r\nobj = PyInt_FromLong(perf__constants[i].value);\r\nif (obj == NULL)\r\ngoto error;\r\nPyDict_SetItemString(dict, perf__constants[i].name, obj);\r\nPy_DECREF(obj);\r\n}\r\nerror:\r\nif (PyErr_Occurred())\r\nPyErr_SetString(PyExc_ImportError, "perf: Init failed!");\r\n}\r\nvoid test_attr__open(struct perf_event_attr *attr, pid_t pid, int cpu,\r\nint fd, int group_fd, unsigned long flags)\r\n{\r\n}

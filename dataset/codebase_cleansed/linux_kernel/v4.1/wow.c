static u8 ath9k_wow_map_triggers(struct ath_softc *sc,\r\nstruct cfg80211_wowlan *wowlan)\r\n{\r\nu8 wow_triggers = 0;\r\nif (wowlan->disconnect)\r\nwow_triggers |= AH_WOW_LINK_CHANGE |\r\nAH_WOW_BEACON_MISS;\r\nif (wowlan->magic_pkt)\r\nwow_triggers |= AH_WOW_MAGIC_PATTERN_EN;\r\nif (wowlan->n_patterns)\r\nwow_triggers |= AH_WOW_USER_PATTERN_EN;\r\nreturn wow_triggers;\r\n}\r\nstatic int ath9k_wow_add_disassoc_deauth_pattern(struct ath_softc *sc)\r\n{\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nint pattern_count = 0;\r\nint ret, i, byte_cnt = 0;\r\nu8 dis_deauth_pattern[MAX_PATTERN_SIZE];\r\nu8 dis_deauth_mask[MAX_PATTERN_SIZE];\r\nmemset(dis_deauth_pattern, 0, MAX_PATTERN_SIZE);\r\nmemset(dis_deauth_mask, 0, MAX_PATTERN_SIZE);\r\nfor (i = 0; i < MAX_PATTERN_MASK_SIZE; i++)\r\ndis_deauth_mask[i] = 0xff;\r\ndis_deauth_pattern[byte_cnt] = 0xa0;\r\nbyte_cnt++;\r\nbyte_cnt += 3;\r\nbyte_cnt += 6;\r\nmemcpy((dis_deauth_pattern + byte_cnt), common->curbssid, ETH_ALEN);\r\nbyte_cnt += 6;\r\nmemcpy((dis_deauth_pattern + byte_cnt), common->curbssid, ETH_ALEN);\r\ndis_deauth_mask[0] = 0xfe;\r\ndis_deauth_mask[1] = 0x03;\r\ndis_deauth_mask[2] = 0xc0;\r\nret = ath9k_hw_wow_apply_pattern(ah, dis_deauth_pattern, dis_deauth_mask,\r\npattern_count, byte_cnt);\r\nif (ret)\r\ngoto exit;\r\npattern_count++;\r\ndis_deauth_pattern[0] = 0xC0;\r\nret = ath9k_hw_wow_apply_pattern(ah, dis_deauth_pattern, dis_deauth_mask,\r\npattern_count, byte_cnt);\r\nexit:\r\nreturn ret;\r\n}\r\nstatic int ath9k_wow_add_pattern(struct ath_softc *sc,\r\nstruct cfg80211_wowlan *wowlan)\r\n{\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct cfg80211_pkt_pattern *patterns = wowlan->patterns;\r\nu8 wow_pattern[MAX_PATTERN_SIZE];\r\nu8 wow_mask[MAX_PATTERN_SIZE];\r\nint mask_len, ret = 0;\r\ns8 i = 0;\r\nfor (i = 0; i < wowlan->n_patterns; i++) {\r\nmask_len = DIV_ROUND_UP(patterns[i].pattern_len, 8);\r\nmemset(wow_pattern, 0, MAX_PATTERN_SIZE);\r\nmemset(wow_mask, 0, MAX_PATTERN_SIZE);\r\nmemcpy(wow_pattern, patterns[i].pattern, patterns[i].pattern_len);\r\nmemcpy(wow_mask, patterns[i].mask, mask_len);\r\nret = ath9k_hw_wow_apply_pattern(ah,\r\nwow_pattern,\r\nwow_mask,\r\ni + 2,\r\npatterns[i].pattern_len);\r\nif (ret)\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nint ath9k_suspend(struct ieee80211_hw *hw,\r\nstruct cfg80211_wowlan *wowlan)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu8 triggers;\r\nint ret = 0;\r\nath9k_deinit_channel_context(sc);\r\nmutex_lock(&sc->mutex);\r\nif (test_bit(ATH_OP_INVALID, &common->op_flags)) {\r\nath_err(common, "Device not present\n");\r\nret = -ENODEV;\r\ngoto fail_wow;\r\n}\r\nif (WARN_ON(!wowlan)) {\r\nath_err(common, "None of the WoW triggers enabled\n");\r\nret = -EINVAL;\r\ngoto fail_wow;\r\n}\r\nif (sc->cur_chan->nvifs > 1) {\r\nath_dbg(common, WOW, "WoW for multivif is not yet supported\n");\r\nret = 1;\r\ngoto fail_wow;\r\n}\r\nif (ath9k_is_chanctx_enabled()) {\r\nif (test_bit(ATH_OP_MULTI_CHANNEL, &common->op_flags)) {\r\nath_dbg(common, WOW,\r\n"Multi-channel WOW is not supported\n");\r\nret = 1;\r\ngoto fail_wow;\r\n}\r\n}\r\nif (!test_bit(ATH_OP_PRIM_STA_VIF, &common->op_flags)) {\r\nath_dbg(common, WOW, "None of the STA vifs are associated\n");\r\nret = 1;\r\ngoto fail_wow;\r\n}\r\ntriggers = ath9k_wow_map_triggers(sc, wowlan);\r\nif (!triggers) {\r\nath_dbg(common, WOW, "No valid WoW triggers\n");\r\nret = 1;\r\ngoto fail_wow;\r\n}\r\nath_cancel_work(sc);\r\nath_stop_ani(sc);\r\nath9k_ps_wakeup(sc);\r\nath9k_stop_btcoex(sc);\r\nret = ath9k_wow_add_disassoc_deauth_pattern(sc);\r\nif (ret) {\r\nath_err(common,\r\n"Unable to add disassoc/deauth pattern: %d\n", ret);\r\ngoto fail_wow;\r\n}\r\nif (triggers & AH_WOW_USER_PATTERN_EN) {\r\nret = ath9k_wow_add_pattern(sc, wowlan);\r\nif (ret) {\r\nath_err(common,\r\n"Unable to add user pattern: %d\n", ret);\r\ngoto fail_wow;\r\n}\r\n}\r\nspin_lock_bh(&sc->sc_pcu_lock);\r\nsc->wow_intr_before_sleep = ah->imask;\r\nah->imask &= ~ATH9K_INT_GLOBAL;\r\nath9k_hw_disable_interrupts(ah);\r\nah->imask = ATH9K_INT_BMISS | ATH9K_INT_GLOBAL;\r\nath9k_hw_set_interrupts(ah);\r\nath9k_hw_enable_interrupts(ah);\r\nspin_unlock_bh(&sc->sc_pcu_lock);\r\nsynchronize_irq(sc->irq);\r\ntasklet_kill(&sc->intr_tq);\r\nath9k_hw_wow_enable(ah, triggers);\r\nath9k_ps_restore(sc);\r\nath_dbg(common, WOW, "Suspend with WoW triggers: 0x%x\n", triggers);\r\nset_bit(ATH_OP_WOW_ENABLED, &common->op_flags);\r\nfail_wow:\r\nmutex_unlock(&sc->mutex);\r\nreturn ret;\r\n}\r\nint ath9k_resume(struct ieee80211_hw *hw)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu8 status;\r\nmutex_lock(&sc->mutex);\r\nath9k_ps_wakeup(sc);\r\nspin_lock_bh(&sc->sc_pcu_lock);\r\nath9k_hw_disable_interrupts(ah);\r\nah->imask = sc->wow_intr_before_sleep;\r\nath9k_hw_set_interrupts(ah);\r\nath9k_hw_enable_interrupts(ah);\r\nspin_unlock_bh(&sc->sc_pcu_lock);\r\nstatus = ath9k_hw_wow_wakeup(ah);\r\nath_dbg(common, WOW, "Resume with WoW status: 0x%x\n", status);\r\nath_restart_work(sc);\r\nath9k_start_btcoex(sc);\r\nclear_bit(ATH_OP_WOW_ENABLED, &common->op_flags);\r\nath9k_ps_restore(sc);\r\nmutex_unlock(&sc->mutex);\r\nreturn 0;\r\n}\r\nvoid ath9k_set_wakeup(struct ieee80211_hw *hw, bool enabled)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nstruct ath_common *common = ath9k_hw_common(sc->sc_ah);\r\nmutex_lock(&sc->mutex);\r\ndevice_set_wakeup_enable(sc->dev, enabled);\r\nmutex_unlock(&sc->mutex);\r\nath_dbg(common, WOW, "WoW wakeup source is %s\n",\r\n(enabled) ? "enabled" : "disabled");\r\n}\r\nvoid ath9k_init_wow(struct ieee80211_hw *hw)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nif ((sc->driver_data & ATH9K_PCI_WOW) || sc->force_wow) {\r\nif (AR_SREV_9462_20_OR_LATER(ah) || AR_SREV_9565_11_OR_LATER(ah))\r\nhw->wiphy->wowlan = &ath9k_wowlan_support;\r\nelse\r\nhw->wiphy->wowlan = &ath9k_wowlan_support_legacy;\r\ndevice_init_wakeup(sc->dev, 1);\r\n}\r\n}\r\nvoid ath9k_deinit_wow(struct ieee80211_hw *hw)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nif ((sc->driver_data & ATH9K_PCI_WOW) || sc->force_wow)\r\ndevice_init_wakeup(sc->dev, 0);\r\n}

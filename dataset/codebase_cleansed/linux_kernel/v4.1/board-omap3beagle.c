static void __init omap3_beagle_init_rev(void)\r\n{\r\nint ret;\r\nu16 beagle_rev = 0;\r\nomap_mux_init_gpio(171, OMAP_PIN_INPUT_PULLUP);\r\nomap_mux_init_gpio(172, OMAP_PIN_INPUT_PULLUP);\r\nomap_mux_init_gpio(173, OMAP_PIN_INPUT_PULLUP);\r\nret = gpio_request_array(omap3_beagle_rev_gpios,\r\nARRAY_SIZE(omap3_beagle_rev_gpios));\r\nif (ret < 0) {\r\nprintk(KERN_ERR "Unable to get revision detection GPIO pins\n");\r\nomap3_beagle_version = OMAP3BEAGLE_BOARD_UNKN;\r\nreturn;\r\n}\r\nbeagle_rev = gpio_get_value(171) | (gpio_get_value(172) << 1)\r\n| (gpio_get_value(173) << 2);\r\ngpio_free_array(omap3_beagle_rev_gpios,\r\nARRAY_SIZE(omap3_beagle_rev_gpios));\r\nswitch (beagle_rev) {\r\ncase 7:\r\nprintk(KERN_INFO "OMAP3 Beagle Rev: Ax/Bx\n");\r\nomap3_beagle_version = OMAP3BEAGLE_BOARD_AXBX;\r\nbeagle_config.mmc1_gpio_wp = 29;\r\nbeagle_config.dvi_pd_gpio = 170;\r\nbeagle_config.usr_button_gpio = 7;\r\nbreak;\r\ncase 6:\r\nprintk(KERN_INFO "OMAP3 Beagle Rev: C1/C2/C3\n");\r\nomap3_beagle_version = OMAP3BEAGLE_BOARD_C1_3;\r\nbeagle_config.mmc1_gpio_wp = 23;\r\nbeagle_config.dvi_pd_gpio = 170;\r\nbeagle_config.usr_button_gpio = 7;\r\nbreak;\r\ncase 5:\r\nprintk(KERN_INFO "OMAP3 Beagle Rev: C4\n");\r\nomap3_beagle_version = OMAP3BEAGLE_BOARD_C4;\r\nbeagle_config.mmc1_gpio_wp = 23;\r\nbeagle_config.dvi_pd_gpio = 170;\r\nbeagle_config.usr_button_gpio = 7;\r\nbreak;\r\ncase 0:\r\nprintk(KERN_INFO "OMAP3 Beagle Rev: xM Ax/Bx\n");\r\nomap3_beagle_version = OMAP3BEAGLE_BOARD_XM;\r\nbeagle_config.usb_pwr_level = 1;\r\nbeagle_config.mmc_caps &= ~MMC_CAP_8_BIT_DATA;\r\nbreak;\r\ncase 2:\r\nprintk(KERN_INFO "OMAP3 Beagle Rev: xM C\n");\r\nomap3_beagle_version = OMAP3BEAGLE_BOARD_XMC;\r\nbeagle_config.mmc_caps &= ~MMC_CAP_8_BIT_DATA;\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "OMAP3 Beagle Rev: unknown %hd\n", beagle_rev);\r\nomap3_beagle_version = OMAP3BEAGLE_BOARD_UNKN;\r\n}\r\n}\r\nstatic int beagle_twl_gpio_setup(struct device *dev,\r\nunsigned gpio, unsigned ngpio)\r\n{\r\nint r;\r\nmmc[0].gpio_wp = beagle_config.mmc1_gpio_wp;\r\nmmc[0].gpio_cd = gpio + 0;\r\nomap_hsmmc_late_init(mmc);\r\nif (cpu_is_omap3630()) {\r\nr = gpio_request_one(gpio + 1, GPIOF_OUT_INIT_LOW,\r\n"nDVI_PWR_EN");\r\nif (r)\r\npr_err("%s: unable to configure nDVI_PWR_EN\n",\r\n__func__);\r\nbeagle_config.dvi_pd_gpio = gpio + 2;\r\n} else {\r\nif (gpio_request_one(gpio + 1, GPIOF_IN, "EHCI_nOC"))\r\npr_err("%s: unable to configure EHCI_nOC\n", __func__);\r\n}\r\nbeagle_tfp410_pdata.power_down_gpio = beagle_config.dvi_pd_gpio;\r\nplatform_device_register(&beagle_tfp410_device);\r\nplatform_device_register(&beagle_dvi_connector_device);\r\nplatform_device_register(&beagle_tv_connector_device);\r\nphy_data[0].vcc_gpio = gpio + TWL4030_GPIO_MAX;\r\nphy_data[0].vcc_polarity = beagle_config.usb_pwr_level;\r\nusbhs_init_phys(phy_data, ARRAY_SIZE(phy_data));\r\nreturn 0;\r\n}\r\nstatic int __init omap3_beagle_i2c_init(void)\r\n{\r\nomap3_pmic_get_config(&beagle_twldata,\r\nTWL_COMMON_PDATA_USB | TWL_COMMON_PDATA_MADC |\r\nTWL_COMMON_PDATA_AUDIO,\r\nTWL_COMMON_REGULATOR_VDAC | TWL_COMMON_REGULATOR_VPLL2);\r\nbeagle_twldata.vpll2->constraints.name = "VDVI";\r\nomap3_pmic_init("twl4030", &beagle_twldata);\r\nomap_register_i2c_bus(3, 100, beagle_i2c_eeprom, ARRAY_SIZE(beagle_i2c_eeprom));\r\nreturn 0;\r\n}\r\nstatic int __init beagle_opp_init(void)\r\n{\r\nint r = 0;\r\nif (!machine_is_omap3_beagle())\r\nreturn 0;\r\nr = omap3_opp_init();\r\nif (r < 0 && (r != -EEXIST)) {\r\npr_err("%s: opp default init failed\n", __func__);\r\nreturn r;\r\n}\r\nif (cpu_is_omap3630()) {\r\nstruct device *mpu_dev, *iva_dev;\r\nmpu_dev = get_cpu_device(0);\r\niva_dev = omap_device_get_by_hwmod_name("iva");\r\nif (!mpu_dev || IS_ERR(iva_dev)) {\r\npr_err("%s: Aiee.. no mpu/dsp devices? %p %p\n",\r\n__func__, mpu_dev, iva_dev);\r\nreturn -ENODEV;\r\n}\r\nr = dev_pm_opp_enable(mpu_dev, 800000000);\r\nr |= dev_pm_opp_enable(iva_dev, 660000000);\r\nif (r) {\r\npr_err("%s: failed to enable higher opp %d\n",\r\n__func__, r);\r\ndev_pm_opp_disable(mpu_dev, 800000000);\r\ndev_pm_opp_disable(iva_dev, 660000000);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init omap3_beagle_init(void)\r\n{\r\nomap3_mux_init(board_mux, OMAP_PACKAGE_CBB);\r\nomap3_beagle_init_rev();\r\nif (gpio_is_valid(beagle_config.mmc1_gpio_wp))\r\nomap_mux_init_gpio(beagle_config.mmc1_gpio_wp, OMAP_PIN_INPUT);\r\nmmc[0].caps = beagle_config.mmc_caps;\r\nomap_hsmmc_init(mmc);\r\nomap3_beagle_i2c_init();\r\ngpio_buttons[0].gpio = beagle_config.usr_button_gpio;\r\nplatform_add_devices(omap3_beagle_devices,\r\nARRAY_SIZE(omap3_beagle_devices));\r\nif (gpio_is_valid(beagle_config.dvi_pd_gpio))\r\nomap_mux_init_gpio(beagle_config.dvi_pd_gpio, OMAP_PIN_OUTPUT);\r\nomap_display_init(&beagle_dss_data);\r\nomap_serial_init();\r\nomap_sdrc_init(mt46h32m32lf6_sdrc_params,\r\nmt46h32m32lf6_sdrc_params);\r\nusb_bind_phy("musb-hdrc.0.auto", 0, "twl4030_usb");\r\nusb_musb_init(NULL);\r\nusbhs_init(&usbhs_bdata);\r\nboard_nand_init(omap3beagle_nand_partitions,\r\nARRAY_SIZE(omap3beagle_nand_partitions), NAND_CS,\r\nNAND_BUSWIDTH_16, NULL);\r\nomap_twl4030_audio_init("omap3beagle", NULL);\r\nomap_mux_init_signal("sys_drm_msecure", OMAP_PIN_OFF_OUTPUT_HIGH);\r\nomap_mux_init_signal("sdrc_cke0", OMAP_PIN_OUTPUT);\r\nomap_mux_init_signal("sdrc_cke1", OMAP_PIN_OUTPUT);\r\npwm_add_table(pwm_lookup, ARRAY_SIZE(pwm_lookup));\r\n}

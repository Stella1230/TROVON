const char *get_system_type(void)\r\n{\r\n#define STR_BUF_LEN 64\r\nstatic char system[STR_BUF_LEN];\r\nstatic int called = 0;\r\nif (called == 0) {\r\ncalled = 1;\r\nsnprintf(system, STR_BUF_LEN, "Digital %s",\r\ndec_system_strings[mips_machtype]);\r\n}\r\nreturn system;\r\n}\r\nstatic inline void prom_init_kn01(void)\r\n{\r\ndec_kn_slot_base = KN01_SLOT_BASE;\r\ndec_kn_slot_size = KN01_SLOT_SIZE;\r\ndec_rtc_base = (void *)CKSEG1ADDR(dec_kn_slot_base + KN01_RTC);\r\n}\r\nstatic inline void prom_init_kn230(void)\r\n{\r\ndec_kn_slot_base = KN01_SLOT_BASE;\r\ndec_kn_slot_size = KN01_SLOT_SIZE;\r\ndec_rtc_base = (void *)CKSEG1ADDR(dec_kn_slot_base + KN01_RTC);\r\n}\r\nstatic inline void prom_init_kn02(void)\r\n{\r\ndec_kn_slot_base = KN02_SLOT_BASE;\r\ndec_kn_slot_size = KN02_SLOT_SIZE;\r\ndec_tc_bus = 1;\r\ndec_rtc_base = (void *)CKSEG1ADDR(dec_kn_slot_base + KN02_RTC);\r\n}\r\nstatic inline void prom_init_kn02xa(void)\r\n{\r\ndec_kn_slot_base = KN02XA_SLOT_BASE;\r\ndec_kn_slot_size = IOASIC_SLOT_SIZE;\r\ndec_tc_bus = 1;\r\nioasic_base = (void *)CKSEG1ADDR(dec_kn_slot_base + IOASIC_IOCTL);\r\ndec_rtc_base = (void *)CKSEG1ADDR(dec_kn_slot_base + IOASIC_TOY);\r\n}\r\nstatic inline void prom_init_kn03(void)\r\n{\r\ndec_kn_slot_base = KN03_SLOT_BASE;\r\ndec_kn_slot_size = IOASIC_SLOT_SIZE;\r\ndec_tc_bus = 1;\r\nioasic_base = (void *)CKSEG1ADDR(dec_kn_slot_base + IOASIC_IOCTL);\r\ndec_rtc_base = (void *)CKSEG1ADDR(dec_kn_slot_base + IOASIC_TOY);\r\n}\r\nvoid __init prom_identify_arch(u32 magic)\r\n{\r\nunsigned char dec_cpunum, dec_firmrev, dec_etc, dec_systype;\r\nu32 dec_sysid;\r\nif (!prom_is_rex(magic)) {\r\ndec_sysid = simple_strtoul(prom_getenv("systype"),\r\n(char **)0, 0);\r\n} else {\r\ndec_sysid = rex_getsysid();\r\nif (dec_sysid == 0) {\r\nprintk("Zero sysid returned from PROM! "\r\n"Assuming a PMAX-like machine.\n");\r\ndec_sysid = 1;\r\n}\r\n}\r\ndec_cpunum = (dec_sysid & 0xff000000) >> 24;\r\ndec_systype = (dec_sysid & 0xff0000) >> 16;\r\ndec_firmrev = (dec_sysid & 0xff00) >> 8;\r\ndec_etc = dec_sysid & 0xff;\r\nswitch (dec_systype) {\r\ncase DS2100_3100:\r\nmips_machtype = MACH_DS23100;\r\nprom_init_kn01();\r\nbreak;\r\ncase DS5100:\r\nmips_machtype = MACH_DS5100;\r\nprom_init_kn230();\r\nbreak;\r\ncase DS5000_200:\r\nmips_machtype = MACH_DS5000_200;\r\nprom_init_kn02();\r\nbreak;\r\ncase DS5000_1XX:\r\nmips_machtype = MACH_DS5000_1XX;\r\nprom_init_kn02xa();\r\nbreak;\r\ncase DS5000_2X0:\r\nmips_machtype = MACH_DS5000_2X0;\r\nprom_init_kn03();\r\nif (!(ioasic_read(IO_REG_SIR) & KN03_IO_INR_3MAXP))\r\nmips_machtype = MACH_DS5900;\r\nbreak;\r\ncase DS5000_XX:\r\nmips_machtype = MACH_DS5000_XX;\r\nprom_init_kn02xa();\r\nbreak;\r\ncase DS5800:\r\nmips_machtype = MACH_DS5800;\r\nbreak;\r\ncase DS5400:\r\nmips_machtype = MACH_DS5400;\r\nbreak;\r\ncase DS5500:\r\nmips_machtype = MACH_DS5500;\r\nbreak;\r\ndefault:\r\nmips_machtype = MACH_DSUNKNOWN;\r\nbreak;\r\n}\r\nif (mips_machtype == MACH_DSUNKNOWN)\r\nprintk("This is an %s, id is %x\n",\r\ndec_system_strings[mips_machtype], dec_systype);\r\nelse\r\nprintk("This is a %s\n", dec_system_strings[mips_machtype]);\r\n}

static int per_cpu_sw_state_rd(u32 cpu)\r\n{\r\nsync_cache_r(SHIFT_PERCPU_PTR(&per_cpu_sw_state, per_cpu_offset(cpu)));\r\nreturn per_cpu(per_cpu_sw_state, cpu);\r\n}\r\nstatic void per_cpu_sw_state_wr(u32 cpu, int val)\r\n{\r\ndmb();\r\nper_cpu(per_cpu_sw_state, cpu) = val;\r\nsync_cache_w(SHIFT_PERCPU_PTR(&per_cpu_sw_state, per_cpu_offset(cpu)));\r\n}\r\nstatic inline void per_cpu_sw_state_wr(u32 cpu, int val) { }\r\nstatic void __iomem *pwr_ctrl_get_base(u32 cpu)\r\n{\r\nvoid __iomem *base = cpubiuctrl_block + cpu0_pwr_zone_ctrl_reg;\r\nbase += (cpu_logical_map(cpu) * 4);\r\nreturn base;\r\n}\r\nstatic u32 pwr_ctrl_rd(u32 cpu)\r\n{\r\nvoid __iomem *base = pwr_ctrl_get_base(cpu);\r\nreturn readl_relaxed(base);\r\n}\r\nstatic void pwr_ctrl_set(unsigned int cpu, u32 val, u32 mask)\r\n{\r\nvoid __iomem *base = pwr_ctrl_get_base(cpu);\r\nwritel((readl(base) & mask) | val, base);\r\n}\r\nstatic void pwr_ctrl_clr(unsigned int cpu, u32 val, u32 mask)\r\n{\r\nvoid __iomem *base = pwr_ctrl_get_base(cpu);\r\nwritel((readl(base) & mask) & ~val, base);\r\n}\r\nstatic int pwr_ctrl_wait_tmout(unsigned int cpu, u32 set, u32 mask)\r\n{\r\nconst unsigned long timeo = jiffies + msecs_to_jiffies(POLL_TMOUT_MS);\r\nu32 tmp;\r\ndo {\r\ntmp = pwr_ctrl_rd(cpu) & mask;\r\nif (!set == !tmp)\r\nreturn 0;\r\n} while (time_before(jiffies, timeo));\r\ntmp = pwr_ctrl_rd(cpu) & mask;\r\nif (!set == !tmp)\r\nreturn 0;\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic void cpu_rst_cfg_set(u32 cpu, int set)\r\n{\r\nu32 val;\r\nval = readl_relaxed(cpubiuctrl_block + cpu_rst_cfg_reg);\r\nif (set)\r\nval |= BIT(cpu_logical_map(cpu));\r\nelse\r\nval &= ~BIT(cpu_logical_map(cpu));\r\nwritel_relaxed(val, cpubiuctrl_block + cpu_rst_cfg_reg);\r\n}\r\nstatic void cpu_set_boot_addr(u32 cpu, unsigned long boot_addr)\r\n{\r\nconst int reg_ofs = cpu_logical_map(cpu) * 8;\r\nwritel_relaxed(0, hif_cont_block + hif_cont_reg + reg_ofs);\r\nwritel_relaxed(boot_addr, hif_cont_block + hif_cont_reg + 4 + reg_ofs);\r\n}\r\nstatic void brcmstb_cpu_boot(u32 cpu)\r\n{\r\nper_cpu_sw_state_wr(cpu, 1);\r\ncpu_set_boot_addr(cpu, virt_to_phys(brcmstb_secondary_startup));\r\ncpu_rst_cfg_set(cpu, 0);\r\n}\r\nstatic void brcmstb_cpu_power_on(u32 cpu)\r\n{\r\npwr_ctrl_set(cpu, ZONE_MAN_ISO_CNTL_MASK, 0xffffff00);\r\npwr_ctrl_set(cpu, ZONE_MANUAL_CONTROL_MASK, -1);\r\npwr_ctrl_set(cpu, ZONE_RESERVED_1_MASK, -1);\r\npwr_ctrl_set(cpu, ZONE_MAN_MEM_PWR_MASK, -1);\r\nif (pwr_ctrl_wait_tmout(cpu, 1, ZONE_MEM_PWR_STATE_MASK))\r\npanic("ZONE_MEM_PWR_STATE_MASK set timeout");\r\npwr_ctrl_set(cpu, ZONE_MAN_CLKEN_MASK, -1);\r\nif (pwr_ctrl_wait_tmout(cpu, 1, ZONE_DPG_PWR_STATE_MASK))\r\npanic("ZONE_DPG_PWR_STATE_MASK set timeout");\r\npwr_ctrl_clr(cpu, ZONE_MAN_ISO_CNTL_MASK, -1);\r\npwr_ctrl_set(cpu, ZONE_MAN_RESET_CNTL_MASK, -1);\r\n}\r\nstatic int brcmstb_cpu_get_power_state(u32 cpu)\r\n{\r\nint tmp = pwr_ctrl_rd(cpu);\r\nreturn (tmp & ZONE_RESET_STATE_MASK) ? 0 : 1;\r\n}\r\nstatic void brcmstb_cpu_die(u32 cpu)\r\n{\r\nv7_exit_coherency_flush(all);\r\nper_cpu_sw_state_wr(cpu, 0);\r\nwfi();\r\nwhile (1)\r\n;\r\n}\r\nstatic int brcmstb_cpu_kill(u32 cpu)\r\n{\r\nif (cpu == 0) {\r\npr_warn("SMP: refusing to power off CPU0\n");\r\nreturn 1;\r\n}\r\nwhile (per_cpu_sw_state_rd(cpu))\r\n;\r\npwr_ctrl_set(cpu, ZONE_MANUAL_CONTROL_MASK, -1);\r\npwr_ctrl_clr(cpu, ZONE_MAN_RESET_CNTL_MASK, -1);\r\npwr_ctrl_clr(cpu, ZONE_MAN_CLKEN_MASK, -1);\r\npwr_ctrl_set(cpu, ZONE_MAN_ISO_CNTL_MASK, -1);\r\npwr_ctrl_clr(cpu, ZONE_MAN_MEM_PWR_MASK, -1);\r\nif (pwr_ctrl_wait_tmout(cpu, 0, ZONE_MEM_PWR_STATE_MASK))\r\npanic("ZONE_MEM_PWR_STATE_MASK clear timeout");\r\npwr_ctrl_clr(cpu, ZONE_RESERVED_1_MASK, -1);\r\nif (pwr_ctrl_wait_tmout(cpu, 0, ZONE_DPG_PWR_STATE_MASK))\r\npanic("ZONE_DPG_PWR_STATE_MASK clear timeout");\r\nmb();\r\ncpu_rst_cfg_set(cpu, 1);\r\nreturn 1;\r\n}\r\nstatic int __init setup_hifcpubiuctrl_regs(struct device_node *np)\r\n{\r\nint rc = 0;\r\nchar *name;\r\nstruct device_node *syscon_np = NULL;\r\nname = "syscon-cpu";\r\nsyscon_np = of_parse_phandle(np, name, 0);\r\nif (!syscon_np) {\r\npr_err("can't find phandle %s\n", name);\r\nrc = -EINVAL;\r\ngoto cleanup;\r\n}\r\ncpubiuctrl_block = of_iomap(syscon_np, 0);\r\nif (!cpubiuctrl_block) {\r\npr_err("iomap failed for cpubiuctrl_block\n");\r\nrc = -EINVAL;\r\ngoto cleanup;\r\n}\r\nrc = of_property_read_u32_index(np, name, CPU0_PWR_ZONE_CTRL_REG,\r\n&cpu0_pwr_zone_ctrl_reg);\r\nif (rc) {\r\npr_err("failed to read 1st entry from %s property (%d)\n", name,\r\nrc);\r\nrc = -EINVAL;\r\ngoto cleanup;\r\n}\r\nrc = of_property_read_u32_index(np, name, CPU_RESET_CONFIG_REG,\r\n&cpu_rst_cfg_reg);\r\nif (rc) {\r\npr_err("failed to read 2nd entry from %s property (%d)\n", name,\r\nrc);\r\nrc = -EINVAL;\r\ngoto cleanup;\r\n}\r\ncleanup:\r\nof_node_put(syscon_np);\r\nreturn rc;\r\n}\r\nstatic int __init setup_hifcont_regs(struct device_node *np)\r\n{\r\nint rc = 0;\r\nchar *name;\r\nstruct device_node *syscon_np = NULL;\r\nname = "syscon-cont";\r\nsyscon_np = of_parse_phandle(np, name, 0);\r\nif (!syscon_np) {\r\npr_err("can't find phandle %s\n", name);\r\nrc = -EINVAL;\r\ngoto cleanup;\r\n}\r\nhif_cont_block = of_iomap(syscon_np, 0);\r\nif (!hif_cont_block) {\r\npr_err("iomap failed for hif_cont_block\n");\r\nrc = -EINVAL;\r\ngoto cleanup;\r\n}\r\nhif_cont_reg = 0;\r\ncleanup:\r\nof_node_put(syscon_np);\r\nreturn rc;\r\n}\r\nstatic void __init brcmstb_cpu_ctrl_setup(unsigned int max_cpus)\r\n{\r\nint rc;\r\nstruct device_node *np;\r\nchar *name;\r\nname = "brcm,brcmstb-smpboot";\r\nnp = of_find_compatible_node(NULL, NULL, name);\r\nif (!np) {\r\npr_err("can't find compatible node %s\n", name);\r\nreturn;\r\n}\r\nrc = setup_hifcpubiuctrl_regs(np);\r\nif (rc)\r\nreturn;\r\nrc = setup_hifcont_regs(np);\r\nif (rc)\r\nreturn;\r\n}\r\nstatic int brcmstb_boot_secondary(unsigned int cpu, struct task_struct *idle)\r\n{\r\nif (!cpubiuctrl_block || !hif_cont_block)\r\nreturn -ENODEV;\r\nif (brcmstb_cpu_get_power_state(cpu) == 0)\r\nbrcmstb_cpu_power_on(cpu);\r\nbrcmstb_cpu_boot(cpu);\r\nreturn 0;\r\n}

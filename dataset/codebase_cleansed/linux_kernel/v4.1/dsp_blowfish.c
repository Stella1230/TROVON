void\r\ndsp_bf_encrypt(struct dsp *dsp, u8 *data, int len)\r\n{\r\nint i = 0, j = dsp->bf_crypt_pos;\r\nu8 *bf_data_in = dsp->bf_data_in;\r\nu8 *bf_crypt_out = dsp->bf_crypt_out;\r\nu32 *P = dsp->bf_p;\r\nu32 *S = dsp->bf_s;\r\nu32 yl, yr;\r\nu32 cs;\r\nu8 nibble;\r\nwhile (i < len) {\r\nif (j < 9) {\r\nbf_data_in[j] = *data;\r\n*data++ = bf_crypt_out[j++];\r\ni++;\r\ncontinue;\r\n}\r\nj = 0;\r\nyl = dsp_audio_law2seven[bf_data_in[0]];\r\nyl = (yl << 7) | dsp_audio_law2seven[bf_data_in[1]];\r\nyl = (yl << 7) | dsp_audio_law2seven[bf_data_in[2]];\r\nyl = (yl << 7) | dsp_audio_law2seven[bf_data_in[3]];\r\nnibble = dsp_audio_law2seven[bf_data_in[4]];\r\nyr = nibble;\r\nyl = (yl << 4) | (nibble >> 3);\r\nyr = (yr << 7) | dsp_audio_law2seven[bf_data_in[5]];\r\nyr = (yr << 7) | dsp_audio_law2seven[bf_data_in[6]];\r\nyr = (yr << 7) | dsp_audio_law2seven[bf_data_in[7]];\r\nyr = (yr << 7) | dsp_audio_law2seven[bf_data_in[8]];\r\nyr = (yr << 1) | (bf_data_in[0] & 1);\r\nEROUND(yr, yl, 0);\r\nEROUND(yl, yr, 1);\r\nEROUND(yr, yl, 2);\r\nEROUND(yl, yr, 3);\r\nEROUND(yr, yl, 4);\r\nEROUND(yl, yr, 5);\r\nEROUND(yr, yl, 6);\r\nEROUND(yl, yr, 7);\r\nEROUND(yr, yl, 8);\r\nEROUND(yl, yr, 9);\r\nEROUND(yr, yl, 10);\r\nEROUND(yl, yr, 11);\r\nEROUND(yr, yl, 12);\r\nEROUND(yl, yr, 13);\r\nEROUND(yr, yl, 14);\r\nEROUND(yl, yr, 15);\r\nyl ^= P[16];\r\nyr ^= P[17];\r\ncs = yl ^ (yl >> 3) ^ (yl >> 6) ^ (yl >> 9) ^ (yl >> 12) ^ (yl >> 15)\r\n^ (yl >> 18) ^ (yl >> 21) ^ (yl >> 24) ^ (yl >> 27) ^ (yl >> 30)\r\n^ (yr << 2) ^ (yr >> 1) ^ (yr >> 4) ^ (yr >> 7) ^ (yr >> 10)\r\n^ (yr >> 13) ^ (yr >> 16) ^ (yr >> 19) ^ (yr >> 22) ^ (yr >> 25)\r\n^ (yr >> 28) ^ (yr >> 31);\r\nbf_crypt_out[0] = (yl >> 25) | 0x80;\r\nbf_crypt_out[1] = (yl >> 18) & 0x7f;\r\nbf_crypt_out[2] = (yl >> 11) & 0x7f;\r\nbf_crypt_out[3] = (yl >> 4) & 0x7f;\r\nbf_crypt_out[4] = ((yl << 3) & 0x78) | ((yr >> 29) & 0x07);\r\nbf_crypt_out[5] = ((yr >> 22) & 0x7f) | ((cs << 5) & 0x80);\r\nbf_crypt_out[6] = ((yr >> 15) & 0x7f) | ((cs << 6) & 0x80);\r\nbf_crypt_out[7] = ((yr >> 8) & 0x7f) | (cs << 7);\r\nbf_crypt_out[8] = yr;\r\n}\r\ndsp->bf_crypt_pos = j;\r\n}\r\nvoid\r\ndsp_bf_decrypt(struct dsp *dsp, u8 *data, int len)\r\n{\r\nint i = 0;\r\nu8 j = dsp->bf_decrypt_in_pos;\r\nu8 k = dsp->bf_decrypt_out_pos;\r\nu8 *bf_crypt_inring = dsp->bf_crypt_inring;\r\nu8 *bf_data_out = dsp->bf_data_out;\r\nu16 sync = dsp->bf_sync;\r\nu32 *P = dsp->bf_p;\r\nu32 *S = dsp->bf_s;\r\nu32 yl, yr;\r\nu8 nibble;\r\nu8 cs, cs0, cs1, cs2;\r\nwhile (i < len) {\r\nsync = (sync << 1) | ((*data) >> 7);\r\nbf_crypt_inring[j++ & 15] = *data;\r\n*data++ = bf_data_out[k++];\r\ni++;\r\nif (k == 9)\r\nk = 0;\r\nif ((sync & 0x1f0) != 0x100)\r\ncontinue;\r\nj -= 9;\r\nyl = bf_crypt_inring[j++ & 15];\r\nyl = (yl << 7) | bf_crypt_inring[j++ & 15];\r\nyl = (yl << 7) | bf_crypt_inring[j++ & 15];\r\nyl = (yl << 7) | bf_crypt_inring[j++ & 15];\r\nnibble = bf_crypt_inring[j++ & 15];\r\nyr = nibble;\r\nyl = (yl << 4) | (nibble >> 3);\r\ncs2 = bf_crypt_inring[j++ & 15];\r\nyr = (yr << 7) | (cs2 & 0x7f);\r\ncs1 = bf_crypt_inring[j++ & 15];\r\nyr = (yr << 7) | (cs1 & 0x7f);\r\ncs0 = bf_crypt_inring[j++ & 15];\r\nyr = (yr << 7) | (cs0 & 0x7f);\r\nyr = (yr << 8) | bf_crypt_inring[j++ & 15];\r\ncs = yl ^ (yl >> 3) ^ (yl >> 6) ^ (yl >> 9) ^ (yl >> 12) ^ (yl >> 15)\r\n^ (yl >> 18) ^ (yl >> 21) ^ (yl >> 24) ^ (yl >> 27) ^ (yl >> 30)\r\n^ (yr << 2) ^ (yr >> 1) ^ (yr >> 4) ^ (yr >> 7) ^ (yr >> 10)\r\n^ (yr >> 13) ^ (yr >> 16) ^ (yr >> 19) ^ (yr >> 22) ^ (yr >> 25)\r\n^ (yr >> 28) ^ (yr >> 31);\r\nif ((cs & 0x7) != (((cs2 >> 5) & 4) | ((cs1 >> 6) & 2) | (cs0 >> 7))) {\r\nif (dsp_debug & DEBUG_DSP_BLOWFISH)\r\nprintk(KERN_DEBUG\r\n"DSP BLOWFISH: received corrupt frame, "\r\n"checksumme is not correct\n");\r\ncontinue;\r\n}\r\nyr ^= P[17];\r\nyl ^= P[16];\r\nDROUND(yl, yr, 15);\r\nDROUND(yr, yl, 14);\r\nDROUND(yl, yr, 13);\r\nDROUND(yr, yl, 12);\r\nDROUND(yl, yr, 11);\r\nDROUND(yr, yl, 10);\r\nDROUND(yl, yr, 9);\r\nDROUND(yr, yl, 8);\r\nDROUND(yl, yr, 7);\r\nDROUND(yr, yl, 6);\r\nDROUND(yl, yr, 5);\r\nDROUND(yr, yl, 4);\r\nDROUND(yl, yr, 3);\r\nDROUND(yr, yl, 2);\r\nDROUND(yl, yr, 1);\r\nDROUND(yr, yl, 0);\r\nbf_data_out[0] = dsp_audio_seven2law[(yl >> 25) & 0x7f];\r\nbf_data_out[1] = dsp_audio_seven2law[(yl >> 18) & 0x7f];\r\nbf_data_out[2] = dsp_audio_seven2law[(yl >> 11) & 0x7f];\r\nbf_data_out[3] = dsp_audio_seven2law[(yl >> 4) & 0x7f];\r\nbf_data_out[4] = dsp_audio_seven2law[((yl << 3) & 0x78) |\r\n((yr >> 29) & 0x07)];\r\nbf_data_out[5] = dsp_audio_seven2law[(yr >> 22) & 0x7f];\r\nbf_data_out[6] = dsp_audio_seven2law[(yr >> 15) & 0x7f];\r\nbf_data_out[7] = dsp_audio_seven2law[(yr >> 8) & 0x7f];\r\nbf_data_out[8] = dsp_audio_seven2law[(yr >> 1) & 0x7f];\r\nk = 0;\r\n}\r\ndsp->bf_decrypt_in_pos = j;\r\ndsp->bf_decrypt_out_pos = k;\r\ndsp->bf_sync = sync;\r\n}\r\nstatic inline void\r\nencrypt_block(const u32 *P, const u32 *S, u32 *dst, u32 *src)\r\n{\r\nu32 yl = src[0];\r\nu32 yr = src[1];\r\nEROUND(yr, yl, 0);\r\nEROUND(yl, yr, 1);\r\nEROUND(yr, yl, 2);\r\nEROUND(yl, yr, 3);\r\nEROUND(yr, yl, 4);\r\nEROUND(yl, yr, 5);\r\nEROUND(yr, yl, 6);\r\nEROUND(yl, yr, 7);\r\nEROUND(yr, yl, 8);\r\nEROUND(yl, yr, 9);\r\nEROUND(yr, yl, 10);\r\nEROUND(yl, yr, 11);\r\nEROUND(yr, yl, 12);\r\nEROUND(yl, yr, 13);\r\nEROUND(yr, yl, 14);\r\nEROUND(yl, yr, 15);\r\nyl ^= P[16];\r\nyr ^= P[17];\r\ndst[0] = yr;\r\ndst[1] = yl;\r\n}\r\nint\r\ndsp_bf_init(struct dsp *dsp, const u8 *key, uint keylen)\r\n{\r\nshort i, j, count;\r\nu32 data[2], temp;\r\nu32 *P = (u32 *)dsp->bf_p;\r\nu32 *S = (u32 *)dsp->bf_s;\r\nif (keylen < 4 || keylen > 56)\r\nreturn 1;\r\ni = 0;\r\nwhile (i < 9) {\r\ndsp->bf_crypt_out[i] = 0xff;\r\ndsp->bf_data_out[i] = dsp_silence;\r\ni++;\r\n}\r\ndsp->bf_crypt_pos = 0;\r\ndsp->bf_decrypt_in_pos = 0;\r\ndsp->bf_decrypt_out_pos = 0;\r\ndsp->bf_sync = 0x1ff;\r\ndsp->bf_enable = 1;\r\nfor (i = 0, count = 0; i < 256; i++)\r\nfor (j = 0; j < 4; j++, count++)\r\nS[count] = bf_sbox[count];\r\nfor (i = 0; i < 16 + 2; i++)\r\nP[i] = bf_pbox[i];\r\nfor (j = 0, i = 0; i < 16 + 2; i++) {\r\ntemp = (((u32)key[j] << 24) |\r\n((u32)key[(j + 1) % keylen] << 16) |\r\n((u32)key[(j + 2) % keylen] << 8) |\r\n((u32)key[(j + 3) % keylen]));\r\nP[i] = P[i] ^ temp;\r\nj = (j + 4) % keylen;\r\n}\r\ndata[0] = 0x00000000;\r\ndata[1] = 0x00000000;\r\nfor (i = 0; i < 16 + 2; i += 2) {\r\nencrypt_block(P, S, data, data);\r\nP[i] = data[0];\r\nP[i + 1] = data[1];\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nfor (j = 0, count = i * 256; j < 256; j += 2, count += 2) {\r\nencrypt_block(P, S, data, data);\r\nS[count] = data[0];\r\nS[count + 1] = data[1];\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\ndsp_bf_cleanup(struct dsp *dsp)\r\n{\r\ndsp->bf_enable = 0;\r\n}

static bool disable_pll_rejection(struct sti_hdmi *hdmi)\r\n{\r\nu32 val;\r\nDRM_DEBUG_DRIVER("\n");\r\nval = readl(hdmi->syscfg + HDMI_REJECTION_PLL_CONFIGURATION);\r\nval &= ~REJECTION_PLL_HDMI_ENABLE_MASK;\r\nwritel(val, hdmi->syscfg + HDMI_REJECTION_PLL_CONFIGURATION);\r\nmsleep(PLL_CHANGE_DELAY);\r\nval = readl(hdmi->syscfg + HDMI_REJECTION_PLL_STATUS);\r\nreturn !(val & REJECTION_PLL_HDMI_REJ_PLL_LOCK);\r\n}\r\nstatic bool enable_pll_rejection(struct sti_hdmi *hdmi)\r\n{\r\nunsigned int inputclock;\r\nu32 mdiv, ndiv, pdiv, val;\r\nDRM_DEBUG_DRIVER("\n");\r\nif (!disable_pll_rejection(hdmi))\r\nreturn false;\r\ninputclock = hdmi->mode.clock * 1000;\r\nDRM_DEBUG_DRIVER("hdmi rejection pll input clock = %dHz\n", inputclock);\r\nif (inputclock < 50000000) {\r\npdiv = 4;\r\nndiv = 240;\r\nmdiv = 30;\r\n} else {\r\npdiv = 2;\r\nndiv = 60;\r\nmdiv = 30;\r\n}\r\nval = readl(hdmi->syscfg + HDMI_REJECTION_PLL_CONFIGURATION);\r\nval &= ~(REJECTION_PLL_HDMI_PDIV_MASK |\r\nREJECTION_PLL_HDMI_NDIV_MASK |\r\nREJECTION_PLL_HDMI_MDIV_MASK |\r\nREJECTION_PLL_HDMI_ENABLE_MASK);\r\nval |= (pdiv << REJECTION_PLL_HDMI_PDIV_SHIFT) |\r\n(ndiv << REJECTION_PLL_HDMI_NDIV_SHIFT) |\r\n(mdiv << REJECTION_PLL_HDMI_MDIV_SHIFT) |\r\n(0x1 << REJECTION_PLL_HDMI_ENABLE_SHIFT);\r\nwritel(val, hdmi->syscfg + HDMI_REJECTION_PLL_CONFIGURATION);\r\nmsleep(PLL_CHANGE_DELAY);\r\nval = readl(hdmi->syscfg + HDMI_REJECTION_PLL_STATUS);\r\nreturn (val & REJECTION_PLL_HDMI_REJ_PLL_LOCK);\r\n}\r\nstatic bool sti_hdmi_tx3g0c55phy_start(struct sti_hdmi *hdmi)\r\n{\r\nu32 ckpxpll = hdmi->mode.clock * 1000;\r\nu32 val, tmdsck, freqvco, pllctrl = 0;\r\nunsigned int i;\r\nif (!enable_pll_rejection(hdmi))\r\nreturn false;\r\nDRM_DEBUG_DRIVER("ckpxpll = %dHz\n", ckpxpll);\r\ntmdsck = ckpxpll;\r\npllctrl = 2 << HDMI_SRZ_PLL_CFG_NDIV_SHIFT;\r\nfor (i = 0; i < NB_PLL_MODE; i++) {\r\nif (ckpxpll >= pllmodes[i].min && ckpxpll <= pllmodes[i].max)\r\npllctrl |= HDMI_SRZ_PLL_CFG_MODE(pllmodes[i].mode);\r\n}\r\nfreqvco = tmdsck * 10;\r\nif (freqvco <= 425000000UL)\r\npllctrl |= HDMI_SRZ_PLL_CFG_VCOR(HDMI_SRZ_PLL_CFG_VCOR_425MHZ);\r\nelse if (freqvco <= 850000000UL)\r\npllctrl |= HDMI_SRZ_PLL_CFG_VCOR(HDMI_SRZ_PLL_CFG_VCOR_850MHZ);\r\nelse if (freqvco <= 1700000000UL)\r\npllctrl |= HDMI_SRZ_PLL_CFG_VCOR(HDMI_SRZ_PLL_CFG_VCOR_1700MHZ);\r\nelse if (freqvco <= 2970000000UL)\r\npllctrl |= HDMI_SRZ_PLL_CFG_VCOR(HDMI_SRZ_PLL_CFG_VCOR_3000MHZ);\r\nelse {\r\nDRM_ERROR("PHY serializer clock out of range\n");\r\ngoto err;\r\n}\r\nhdmi->event_received = false;\r\nDRM_DEBUG_DRIVER("pllctrl = 0x%x\n", pllctrl);\r\nhdmi_write(hdmi, pllctrl, HDMI_SRZ_PLL_CFG);\r\nwait_event_interruptible_timeout(hdmi->wait_event,\r\nhdmi->event_received == true,\r\nmsecs_to_jiffies\r\n(HDMI_TIMEOUT_PLL_LOCK));\r\nif ((hdmi_read(hdmi, HDMI_STA) & HDMI_STA_DLL_LCK) == 0) {\r\nDRM_ERROR("hdmi phy pll not locked\n");\r\ngoto err;\r\n}\r\nDRM_DEBUG_DRIVER("got PHY PLL Lock\n");\r\nfor (i = 0; i < NB_HDMI_PHY_CONFIG; i++) {\r\nif ((hdmiphy_config[i].min_tmds_freq <= tmdsck) &&\r\n(hdmiphy_config[i].max_tmds_freq >= tmdsck)) {\r\nval = hdmiphy_config[i].config[0];\r\nhdmi_write(hdmi, val, HDMI_SRZ_TAP_1);\r\nval = hdmiphy_config[i].config[1];\r\nhdmi_write(hdmi, val, HDMI_SRZ_TAP_2);\r\nval = hdmiphy_config[i].config[2];\r\nhdmi_write(hdmi, val, HDMI_SRZ_TAP_3);\r\nval = hdmiphy_config[i].config[3];\r\nval |= HDMI_SRZ_CTRL_EXTERNAL_DATA_EN;\r\nval &= ~HDMI_SRZ_CTRL_POWER_DOWN;\r\nhdmi_write(hdmi, val, HDMI_SRZ_CTRL);\r\nDRM_DEBUG_DRIVER("serializer cfg 0x%x 0x%x 0x%x 0x%x\n",\r\nhdmiphy_config[i].config[0],\r\nhdmiphy_config[i].config[1],\r\nhdmiphy_config[i].config[2],\r\nhdmiphy_config[i].config[3]);\r\nreturn true;\r\n}\r\n}\r\nhdmi_write(hdmi, 0x0, HDMI_SRZ_TAP_1);\r\nhdmi_write(hdmi, 0x0, HDMI_SRZ_TAP_2);\r\nhdmi_write(hdmi, 0x0, HDMI_SRZ_TAP_3);\r\nhdmi_write(hdmi, HDMI_SRZ_CTRL_EXTERNAL_DATA_EN, HDMI_SRZ_CTRL);\r\nreturn true;\r\nerr:\r\ndisable_pll_rejection(hdmi);\r\nreturn false;\r\n}\r\nstatic void sti_hdmi_tx3g0c55phy_stop(struct sti_hdmi *hdmi)\r\n{\r\nDRM_DEBUG_DRIVER("\n");\r\nhdmi->event_received = false;\r\nhdmi_write(hdmi, HDMI_SRZ_CTRL_POWER_DOWN, HDMI_SRZ_CTRL);\r\nhdmi_write(hdmi, HDMI_SRZ_PLL_CFG_POWER_DOWN, HDMI_SRZ_PLL_CFG);\r\nwait_event_interruptible_timeout(hdmi->wait_event,\r\nhdmi->event_received == true,\r\nmsecs_to_jiffies\r\n(HDMI_TIMEOUT_PLL_LOCK));\r\nif (hdmi_read(hdmi, HDMI_STA) & HDMI_STA_DLL_LCK)\r\nDRM_ERROR("hdmi phy pll not well disabled\n");\r\ndisable_pll_rejection(hdmi);\r\n}

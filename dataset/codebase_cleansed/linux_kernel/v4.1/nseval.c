acpi_status acpi_ns_evaluate(struct acpi_evaluate_info *info)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ns_evaluate);\r\nif (!info) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (!info->node) {\r\nstatus =\r\nacpi_ns_get_node(info->prefix_node, info->relative_pathname,\r\nACPI_NS_NO_UPSEARCH, &info->node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nif (acpi_ns_get_type(info->node) == ACPI_TYPE_LOCAL_METHOD_ALIAS) {\r\ninfo->node =\r\nACPI_CAST_PTR(struct acpi_namespace_node,\r\ninfo->node->object);\r\n}\r\ninfo->return_object = NULL;\r\ninfo->node_flags = info->node->flags;\r\ninfo->obj_desc = acpi_ns_get_attached_object(info->node);\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES, "%s [%p] Value %p\n",\r\ninfo->relative_pathname, info->node,\r\nacpi_ns_get_attached_object(info->node)));\r\ninfo->predefined =\r\nacpi_ut_match_predefined_method(info->node->name.ascii);\r\ninfo->full_pathname = acpi_ns_get_external_pathname(info->node);\r\nif (!info->full_pathname) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\ninfo->param_count = 0;\r\nif (info->parameters) {\r\nwhile (info->parameters[info->param_count]) {\r\ninfo->param_count++;\r\n}\r\nif (info->param_count > ACPI_METHOD_NUM_ARGS) {\r\nACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\r\nACPI_WARN_ALWAYS,\r\n"Excess arguments (%u) - using only %u",\r\ninfo->param_count,\r\nACPI_METHOD_NUM_ARGS));\r\ninfo->param_count = ACPI_METHOD_NUM_ARGS;\r\n}\r\n}\r\nacpi_ns_check_acpi_compliance(info->full_pathname, info->node,\r\ninfo->predefined);\r\nacpi_ns_check_argument_count(info->full_pathname, info->node,\r\ninfo->param_count, info->predefined);\r\nacpi_ns_check_argument_types(info);\r\nswitch (acpi_ns_get_type(info->node)) {\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_EVENT:\r\ncase ACPI_TYPE_MUTEX:\r\ncase ACPI_TYPE_REGION:\r\ncase ACPI_TYPE_THERMAL:\r\ncase ACPI_TYPE_LOCAL_SCOPE:\r\nACPI_ERROR((AE_INFO,\r\n"%s: Evaluation of object type [%s] is not supported",\r\ninfo->full_pathname,\r\nacpi_ut_get_type_name(info->node->type)));\r\nstatus = AE_TYPE;\r\ngoto cleanup;\r\ncase ACPI_TYPE_METHOD:\r\nif (!info->obj_desc) {\r\nACPI_ERROR((AE_INFO,\r\n"%s: Method has no attached sub-object",\r\ninfo->full_pathname));\r\nstatus = AE_NULL_OBJECT;\r\ngoto cleanup;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"**** Execute method [%s] at AML address %p length %X\n",\r\ninfo->full_pathname,\r\ninfo->obj_desc->method.aml_start + 1,\r\ninfo->obj_desc->method.aml_length - 1));\r\nacpi_ex_enter_interpreter();\r\nstatus = acpi_ps_execute_method(info);\r\nacpi_ex_exit_interpreter();\r\nbreak;\r\ndefault:\r\nacpi_ex_enter_interpreter();\r\ninfo->return_object =\r\nACPI_CAST_PTR(union acpi_operand_object, info->node);\r\nstatus =\r\nacpi_ex_resolve_node_to_value(ACPI_CAST_INDIRECT_PTR\r\n(struct acpi_namespace_node,\r\n&info->return_object), NULL);\r\nacpi_ex_exit_interpreter();\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES, "Returned object %p [%s]\n",\r\ninfo->return_object,\r\nacpi_ut_get_object_type_name(info->\r\nreturn_object)));\r\nstatus = AE_CTRL_RETURN_VALUE;\r\nbreak;\r\n}\r\n(void)acpi_ns_check_return_value(info->node, info, info->param_count,\r\nstatus, &info->return_object);\r\nif (status == AE_CTRL_RETURN_VALUE) {\r\nif (info->flags & ACPI_IGNORE_RETURN_VALUE) {\r\nacpi_ut_remove_reference(info->return_object);\r\ninfo->return_object = NULL;\r\n}\r\nstatus = AE_OK;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES,\r\n"*** Completed evaluation of object %s ***\n",\r\ninfo->relative_pathname));\r\ncleanup:\r\nACPI_FREE(info->full_pathname);\r\ninfo->full_pathname = NULL;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nvoid acpi_ns_exec_module_code_list(void)\r\n{\r\nunion acpi_operand_object *prev;\r\nunion acpi_operand_object *next;\r\nstruct acpi_evaluate_info *info;\r\nu32 method_count = 0;\r\nACPI_FUNCTION_TRACE(ns_exec_module_code_list);\r\nnext = acpi_gbl_module_code_list;\r\nif (!next) {\r\nreturn_VOID;\r\n}\r\ninfo = ACPI_ALLOCATE(sizeof(struct acpi_evaluate_info));\r\nif (!info) {\r\nreturn_VOID;\r\n}\r\nwhile (next) {\r\nprev = next;\r\nnext = next->method.mutex;\r\nprev->method.mutex = NULL;\r\nacpi_ns_exec_module_code(prev, info);\r\nmethod_count++;\r\nacpi_ut_remove_reference(prev);\r\n}\r\nACPI_INFO((AE_INFO,\r\n"Executed %u blocks of module-level executable AML code",\r\nmethod_count));\r\nACPI_FREE(info);\r\nacpi_gbl_module_code_list = NULL;\r\nreturn_VOID;\r\n}\r\nstatic void\r\nacpi_ns_exec_module_code(union acpi_operand_object *method_obj,\r\nstruct acpi_evaluate_info *info)\r\n{\r\nunion acpi_operand_object *parent_obj;\r\nstruct acpi_namespace_node *parent_node;\r\nacpi_object_type type;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ns_exec_module_code);\r\nparent_node = ACPI_CAST_PTR(struct acpi_namespace_node,\r\nmethod_obj->method.next_object);\r\ntype = acpi_ns_get_type(parent_node);\r\nif ((type == ACPI_TYPE_DEVICE) && parent_node->object) {\r\nmethod_obj->method.dispatch.handler =\r\nparent_node->object->device.handler;\r\n}\r\nmethod_obj->method.next_object = NULL;\r\nACPI_MEMSET(info, 0, sizeof(struct acpi_evaluate_info));\r\ninfo->prefix_node = parent_node;\r\nparent_obj = acpi_ns_get_attached_object(parent_node);\r\nif (parent_obj) {\r\nacpi_ut_add_reference(parent_obj);\r\n}\r\nstatus = acpi_ns_attach_object(parent_node, method_obj,\r\nACPI_TYPE_METHOD);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit;\r\n}\r\nstatus = acpi_ns_evaluate(info);\r\nACPI_DEBUG_PRINT((ACPI_DB_INIT, "Executed module-level code at %p\n",\r\nmethod_obj->method.aml_start));\r\nif (info->return_object) {\r\nacpi_ut_remove_reference(info->return_object);\r\n}\r\nacpi_ns_detach_object(parent_node);\r\nif (parent_obj) {\r\nstatus = acpi_ns_attach_object(parent_node, parent_obj, type);\r\n} else {\r\nparent_node->type = (u8)type;\r\n}\r\nexit:\r\nif (parent_obj) {\r\nacpi_ut_remove_reference(parent_obj);\r\n}\r\nreturn_VOID;\r\n}

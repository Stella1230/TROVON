static bool ts3a227e_readable_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TS3A227E_REG_DEVICE_ID ... TS3A227E_REG_KP_THRESHOLD_3:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool ts3a227e_writeable_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TS3A227E_REG_INTERRUPT_DISABLE ... TS3A227E_REG_SWITCH_CONTROL_2:\r\ncase TS3A227E_REG_KP_THRESHOLD_1 ... TS3A227E_REG_KP_THRESHOLD_3:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool ts3a227e_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TS3A227E_REG_INTERRUPT ... TS3A227E_REG_INTERRUPT_DISABLE:\r\ncase TS3A227E_REG_SETTING_2:\r\ncase TS3A227E_REG_SWITCH_STATUS_1 ... TS3A227E_REG_ADC_OUTPUT:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic void ts3a227e_jack_report(struct ts3a227e *ts3a227e)\r\n{\r\nunsigned int i;\r\nint report = 0;\r\nif (!ts3a227e->jack)\r\nreturn;\r\nif (ts3a227e->plugged)\r\nreport = SND_JACK_HEADPHONE;\r\nif (ts3a227e->mic_present)\r\nreport |= SND_JACK_MICROPHONE;\r\nfor (i = 0; i < TS3A227E_NUM_BUTTONS; i++) {\r\nif (ts3a227e->buttons_held & (1 << i))\r\nreport |= ts3a227e_buttons[i];\r\n}\r\nsnd_soc_jack_report(ts3a227e->jack, report, TS3A227E_JACK_MASK);\r\n}\r\nstatic void ts3a227e_new_jack_state(struct ts3a227e *ts3a227e, unsigned acc_reg)\r\n{\r\nbool plugged, mic_present;\r\nplugged = !!(acc_reg & JACK_INSERTED);\r\nmic_present = plugged && !!(acc_reg & EITHER_MIC_MASK);\r\nts3a227e->plugged = plugged;\r\nif (mic_present != ts3a227e->mic_present) {\r\nts3a227e->mic_present = mic_present;\r\nts3a227e->buttons_held = 0;\r\nif (mic_present) {\r\nregmap_update_bits(ts3a227e->regmap,\r\nTS3A227E_REG_SETTING_2,\r\nKP_ENABLE, KP_ENABLE);\r\n}\r\n}\r\n}\r\nstatic irqreturn_t ts3a227e_interrupt(int irq, void *data)\r\n{\r\nstruct ts3a227e *ts3a227e = (struct ts3a227e *)data;\r\nstruct regmap *regmap = ts3a227e->regmap;\r\nunsigned int int_reg, kp_int_reg, acc_reg, i;\r\nregmap_read(regmap, TS3A227E_REG_INTERRUPT, &int_reg);\r\nif (int_reg & (DETECTION_COMPLETE_EVENT | INS_REM_EVENT)) {\r\nregmap_read(regmap, TS3A227E_REG_ACCESSORY_STATUS, &acc_reg);\r\nts3a227e_new_jack_state(ts3a227e, acc_reg);\r\n}\r\nregmap_read(regmap, TS3A227E_REG_KP_INTERRUPT, &kp_int_reg);\r\nfor (i = 0; i < TS3A227E_NUM_BUTTONS; i++) {\r\nif (kp_int_reg & PRESS_MASK(i))\r\nts3a227e->buttons_held |= (1 << i);\r\nif (kp_int_reg & RELEASE_MASK(i))\r\nts3a227e->buttons_held &= ~(1 << i);\r\n}\r\nts3a227e_jack_report(ts3a227e);\r\nreturn IRQ_HANDLED;\r\n}\r\nint ts3a227e_enable_jack_detect(struct snd_soc_component *component,\r\nstruct snd_soc_jack *jack)\r\n{\r\nstruct ts3a227e *ts3a227e = snd_soc_component_get_drvdata(component);\r\nsnd_jack_set_key(jack->jack, SND_JACK_BTN_0, KEY_MEDIA);\r\nsnd_jack_set_key(jack->jack, SND_JACK_BTN_1, KEY_VOICECOMMAND);\r\nsnd_jack_set_key(jack->jack, SND_JACK_BTN_2, KEY_VOLUMEUP);\r\nsnd_jack_set_key(jack->jack, SND_JACK_BTN_3, KEY_VOLUMEDOWN);\r\nts3a227e->jack = jack;\r\nts3a227e_jack_report(ts3a227e);\r\nreturn 0;\r\n}\r\nstatic int ts3a227e_parse_dt(struct ts3a227e *ts3a227e, struct device_node *np)\r\n{\r\nu32 micbias;\r\nint err;\r\nerr = of_property_read_u32(np, "ti,micbias", &micbias);\r\nif (!err) {\r\nregmap_update_bits(ts3a227e->regmap, TS3A227E_REG_SETTING_3,\r\nMICBIAS_SETTING_MASK,\r\n(micbias & 0x07) << MICBIAS_SETTING_SFT);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ts3a227e_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ts3a227e *ts3a227e;\r\nstruct device *dev = &i2c->dev;\r\nint ret;\r\nunsigned int acc_reg;\r\nts3a227e = devm_kzalloc(&i2c->dev, sizeof(*ts3a227e), GFP_KERNEL);\r\nif (ts3a227e == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, ts3a227e);\r\nts3a227e->regmap = devm_regmap_init_i2c(i2c, &ts3a227e_regmap_config);\r\nif (IS_ERR(ts3a227e->regmap))\r\nreturn PTR_ERR(ts3a227e->regmap);\r\nif (dev->of_node) {\r\nret = ts3a227e_parse_dt(ts3a227e, dev->of_node);\r\nif (ret) {\r\ndev_err(dev, "Failed to parse device tree: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nret = devm_request_threaded_irq(dev, i2c->irq, NULL, ts3a227e_interrupt,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"TS3A227E", ts3a227e);\r\nif (ret) {\r\ndev_err(dev, "Cannot request irq %d (%d)\n", i2c->irq, ret);\r\nreturn ret;\r\n}\r\nret = devm_snd_soc_register_component(&i2c->dev, &ts3a227e_soc_driver,\r\nNULL, 0);\r\nif (ret)\r\nreturn ret;\r\nregmap_update_bits(ts3a227e->regmap, TS3A227E_REG_INTERRUPT_DISABLE,\r\nINTB_DISABLE | ADC_COMPLETE_INT_DISABLE,\r\nADC_COMPLETE_INT_DISABLE);\r\nregmap_read(ts3a227e->regmap, TS3A227E_REG_ACCESSORY_STATUS, &acc_reg);\r\nts3a227e_new_jack_state(ts3a227e, acc_reg);\r\nts3a227e_jack_report(ts3a227e);\r\nreturn 0;\r\n}

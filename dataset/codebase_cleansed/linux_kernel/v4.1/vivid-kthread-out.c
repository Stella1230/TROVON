static void vivid_thread_vid_out_tick(struct vivid_dev *dev)\r\n{\r\nstruct vivid_buffer *vid_out_buf = NULL;\r\nstruct vivid_buffer *vbi_out_buf = NULL;\r\ndprintk(dev, 1, "Video Output Thread Tick\n");\r\nif (dev->perc_dropped_buffers &&\r\nprandom_u32_max(100) < dev->perc_dropped_buffers)\r\nreturn;\r\nspin_lock(&dev->slock);\r\nif (!list_empty(&dev->vid_out_active) &&\r\n!list_is_singular(&dev->vid_out_active)) {\r\nvid_out_buf = list_entry(dev->vid_out_active.next,\r\nstruct vivid_buffer, list);\r\nlist_del(&vid_out_buf->list);\r\n}\r\nif (!list_empty(&dev->vbi_out_active) &&\r\n(dev->field_out != V4L2_FIELD_ALTERNATE ||\r\n(dev->vbi_out_seq_count & 1))) {\r\nvbi_out_buf = list_entry(dev->vbi_out_active.next,\r\nstruct vivid_buffer, list);\r\nlist_del(&vbi_out_buf->list);\r\n}\r\nspin_unlock(&dev->slock);\r\nif (!vid_out_buf && !vbi_out_buf)\r\nreturn;\r\nif (vid_out_buf) {\r\nvid_out_buf->vb.v4l2_buf.sequence = dev->vid_out_seq_count;\r\nif (dev->field_out == V4L2_FIELD_ALTERNATE) {\r\nvid_out_buf->vb.v4l2_buf.sequence /= 2;\r\n}\r\nv4l2_get_timestamp(&vid_out_buf->vb.v4l2_buf.timestamp);\r\nvid_out_buf->vb.v4l2_buf.timestamp.tv_sec += dev->time_wrap_offset;\r\nvb2_buffer_done(&vid_out_buf->vb, dev->dqbuf_error ?\r\nVB2_BUF_STATE_ERROR : VB2_BUF_STATE_DONE);\r\ndprintk(dev, 2, "vid_out buffer %d done\n",\r\nvid_out_buf->vb.v4l2_buf.index);\r\n}\r\nif (vbi_out_buf) {\r\nif (dev->stream_sliced_vbi_out)\r\nvivid_sliced_vbi_out_process(dev, vbi_out_buf);\r\nvbi_out_buf->vb.v4l2_buf.sequence = dev->vbi_out_seq_count;\r\nv4l2_get_timestamp(&vbi_out_buf->vb.v4l2_buf.timestamp);\r\nvbi_out_buf->vb.v4l2_buf.timestamp.tv_sec += dev->time_wrap_offset;\r\nvb2_buffer_done(&vbi_out_buf->vb, dev->dqbuf_error ?\r\nVB2_BUF_STATE_ERROR : VB2_BUF_STATE_DONE);\r\ndprintk(dev, 2, "vbi_out buffer %d done\n",\r\nvbi_out_buf->vb.v4l2_buf.index);\r\n}\r\ndev->dqbuf_error = false;\r\n}\r\nstatic int vivid_thread_vid_out(void *data)\r\n{\r\nstruct vivid_dev *dev = data;\r\nu64 numerators_since_start;\r\nu64 buffers_since_start;\r\nu64 next_jiffies_since_start;\r\nunsigned long jiffies_since_start;\r\nunsigned long cur_jiffies;\r\nunsigned wait_jiffies;\r\nunsigned numerator;\r\nunsigned denominator;\r\ndprintk(dev, 1, "Video Output Thread Start\n");\r\nset_freezable();\r\ndev->out_seq_offset = 0;\r\nif (dev->seq_wrap)\r\ndev->out_seq_count = 0xffffff80U;\r\ndev->jiffies_vid_out = jiffies;\r\ndev->vid_out_seq_start = dev->vbi_out_seq_start = 0;\r\ndev->out_seq_resync = false;\r\nfor (;;) {\r\ntry_to_freeze();\r\nif (kthread_should_stop())\r\nbreak;\r\nmutex_lock(&dev->mutex);\r\ncur_jiffies = jiffies;\r\nif (dev->out_seq_resync) {\r\ndev->jiffies_vid_out = cur_jiffies;\r\ndev->out_seq_offset = dev->out_seq_count + 1;\r\ndev->out_seq_count = 0;\r\ndev->out_seq_resync = false;\r\n}\r\nnumerator = dev->timeperframe_vid_out.numerator;\r\ndenominator = dev->timeperframe_vid_out.denominator;\r\nif (dev->field_out == V4L2_FIELD_ALTERNATE)\r\ndenominator *= 2;\r\njiffies_since_start = cur_jiffies - dev->jiffies_vid_out;\r\nbuffers_since_start = (u64)jiffies_since_start * denominator +\r\n(HZ * numerator) / 2;\r\ndo_div(buffers_since_start, HZ * numerator);\r\nif (jiffies_since_start > JIFFIES_RESYNC) {\r\ndev->jiffies_vid_out = cur_jiffies;\r\ndev->out_seq_offset = buffers_since_start;\r\nbuffers_since_start = 0;\r\n}\r\ndev->out_seq_count = buffers_since_start + dev->out_seq_offset;\r\ndev->vid_out_seq_count = dev->out_seq_count - dev->vid_out_seq_start;\r\ndev->vbi_out_seq_count = dev->out_seq_count - dev->vbi_out_seq_start;\r\nvivid_thread_vid_out_tick(dev);\r\nmutex_unlock(&dev->mutex);\r\nnumerators_since_start = buffers_since_start * numerator;\r\njiffies_since_start = jiffies - dev->jiffies_vid_out;\r\nnumerators_since_start += numerator;\r\nnext_jiffies_since_start = numerators_since_start * HZ +\r\ndenominator / 2;\r\ndo_div(next_jiffies_since_start, denominator);\r\nif (next_jiffies_since_start < jiffies_since_start)\r\nnext_jiffies_since_start = jiffies_since_start;\r\nwait_jiffies = next_jiffies_since_start - jiffies_since_start;\r\nschedule_timeout_interruptible(wait_jiffies ? wait_jiffies : 1);\r\n}\r\ndprintk(dev, 1, "Video Output Thread End\n");\r\nreturn 0;\r\n}\r\nstatic void vivid_grab_controls(struct vivid_dev *dev, bool grab)\r\n{\r\nv4l2_ctrl_grab(dev->ctrl_has_crop_out, grab);\r\nv4l2_ctrl_grab(dev->ctrl_has_compose_out, grab);\r\nv4l2_ctrl_grab(dev->ctrl_has_scaler_out, grab);\r\nv4l2_ctrl_grab(dev->ctrl_tx_mode, grab);\r\nv4l2_ctrl_grab(dev->ctrl_tx_rgb_range, grab);\r\n}\r\nint vivid_start_generating_vid_out(struct vivid_dev *dev, bool *pstreaming)\r\n{\r\ndprintk(dev, 1, "%s\n", __func__);\r\nif (dev->kthread_vid_out) {\r\nu32 seq_count = dev->out_seq_count + dev->seq_wrap * 128;\r\nif (pstreaming == &dev->vid_out_streaming)\r\ndev->vid_out_seq_start = seq_count;\r\nelse\r\ndev->vbi_out_seq_start = seq_count;\r\n*pstreaming = true;\r\nreturn 0;\r\n}\r\ndev->jiffies_vid_out = jiffies;\r\ndev->vid_out_seq_start = dev->seq_wrap * 128;\r\ndev->vbi_out_seq_start = dev->seq_wrap * 128;\r\ndev->kthread_vid_out = kthread_run(vivid_thread_vid_out, dev,\r\n"%s-vid-out", dev->v4l2_dev.name);\r\nif (IS_ERR(dev->kthread_vid_out)) {\r\nv4l2_err(&dev->v4l2_dev, "kernel_thread() failed\n");\r\nreturn PTR_ERR(dev->kthread_vid_out);\r\n}\r\n*pstreaming = true;\r\nvivid_grab_controls(dev, true);\r\ndprintk(dev, 1, "returning from %s\n", __func__);\r\nreturn 0;\r\n}\r\nvoid vivid_stop_generating_vid_out(struct vivid_dev *dev, bool *pstreaming)\r\n{\r\ndprintk(dev, 1, "%s\n", __func__);\r\nif (dev->kthread_vid_out == NULL)\r\nreturn;\r\n*pstreaming = false;\r\nif (pstreaming == &dev->vid_out_streaming) {\r\nwhile (!list_empty(&dev->vid_out_active)) {\r\nstruct vivid_buffer *buf;\r\nbuf = list_entry(dev->vid_out_active.next,\r\nstruct vivid_buffer, list);\r\nlist_del(&buf->list);\r\nvb2_buffer_done(&buf->vb, VB2_BUF_STATE_ERROR);\r\ndprintk(dev, 2, "vid_out buffer %d done\n",\r\nbuf->vb.v4l2_buf.index);\r\n}\r\n}\r\nif (pstreaming == &dev->vbi_out_streaming) {\r\nwhile (!list_empty(&dev->vbi_out_active)) {\r\nstruct vivid_buffer *buf;\r\nbuf = list_entry(dev->vbi_out_active.next,\r\nstruct vivid_buffer, list);\r\nlist_del(&buf->list);\r\nvb2_buffer_done(&buf->vb, VB2_BUF_STATE_ERROR);\r\ndprintk(dev, 2, "vbi_out buffer %d done\n",\r\nbuf->vb.v4l2_buf.index);\r\n}\r\n}\r\nif (dev->vid_out_streaming || dev->vbi_out_streaming)\r\nreturn;\r\nvivid_grab_controls(dev, false);\r\nmutex_unlock(&dev->mutex);\r\nkthread_stop(dev->kthread_vid_out);\r\ndev->kthread_vid_out = NULL;\r\nmutex_lock(&dev->mutex);\r\n}

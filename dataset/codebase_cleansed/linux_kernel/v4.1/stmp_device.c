static int stmp_clear_poll_bit(void __iomem *addr, u32 mask)\r\n{\r\nint timeout = 0x400;\r\nwritel(mask, addr + STMP_OFFSET_REG_CLR);\r\nudelay(1);\r\nwhile ((readl(addr) & mask) && --timeout)\r\n;\r\nreturn !timeout;\r\n}\r\nint stmp_reset_block(void __iomem *reset_addr)\r\n{\r\nint ret;\r\nint timeout = 0x400;\r\nret = stmp_clear_poll_bit(reset_addr, STMP_MODULE_SFTRST);\r\nif (unlikely(ret))\r\ngoto error;\r\nwritel(STMP_MODULE_CLKGATE, reset_addr + STMP_OFFSET_REG_CLR);\r\nwritel(STMP_MODULE_SFTRST, reset_addr + STMP_OFFSET_REG_SET);\r\nudelay(1);\r\nwhile ((!(readl(reset_addr) & STMP_MODULE_CLKGATE)) && --timeout)\r\n;\r\nif (unlikely(!timeout))\r\ngoto error;\r\nret = stmp_clear_poll_bit(reset_addr, STMP_MODULE_SFTRST);\r\nif (unlikely(ret))\r\ngoto error;\r\nret = stmp_clear_poll_bit(reset_addr, STMP_MODULE_CLKGATE);\r\nif (unlikely(ret))\r\ngoto error;\r\nreturn 0;\r\nerror:\r\npr_err("%s(%p): module reset timeout\n", __func__, reset_addr);\r\nreturn -ETIMEDOUT;\r\n}

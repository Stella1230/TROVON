static int masquerade_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct nf_nat_ipv4_multi_range_compat *mr = par->targinfo;\r\nif (mr->range[0].flags & NF_NAT_RANGE_MAP_IPS) {\r\npr_debug("bad MAP_IPS.\n");\r\nreturn -EINVAL;\r\n}\r\nif (mr->rangesize != 1) {\r\npr_debug("bad rangesize %u\n", mr->rangesize);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int\r\nmasquerade_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nstruct nf_nat_range range;\r\nconst struct nf_nat_ipv4_multi_range_compat *mr;\r\nmr = par->targinfo;\r\nrange.flags = mr->range[0].flags;\r\nrange.min_proto = mr->range[0].min;\r\nrange.max_proto = mr->range[0].max;\r\nreturn nf_nat_masquerade_ipv4(skb, par->hooknum, &range, par->out);\r\n}\r\nstatic int __init masquerade_tg_init(void)\r\n{\r\nint ret;\r\nret = xt_register_target(&masquerade_tg_reg);\r\nif (ret == 0)\r\nnf_nat_masquerade_ipv4_register_notifier();\r\nreturn ret;\r\n}\r\nstatic void __exit masquerade_tg_exit(void)\r\n{\r\nxt_unregister_target(&masquerade_tg_reg);\r\nnf_nat_masquerade_ipv4_unregister_notifier();\r\n}

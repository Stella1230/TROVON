int nfc_mei_phy_enable(void *phy_id)\r\n{\r\nint r;\r\nstruct nfc_mei_phy *phy = phy_id;\r\npr_info("%s\n", __func__);\r\nif (phy->powered == 1)\r\nreturn 0;\r\nr = mei_cl_enable_device(phy->device);\r\nif (r < 0) {\r\npr_err("Could not enable device\n");\r\nreturn r;\r\n}\r\nr = mei_cl_register_event_cb(phy->device, nfc_mei_event_cb, phy);\r\nif (r) {\r\npr_err("Event cb registration failed\n");\r\nmei_cl_disable_device(phy->device);\r\nphy->powered = 0;\r\nreturn r;\r\n}\r\nphy->powered = 1;\r\nreturn 0;\r\n}\r\nvoid nfc_mei_phy_disable(void *phy_id)\r\n{\r\nstruct nfc_mei_phy *phy = phy_id;\r\npr_info("%s\n", __func__);\r\nmei_cl_disable_device(phy->device);\r\nphy->powered = 0;\r\n}\r\nstatic int nfc_mei_phy_write(void *phy_id, struct sk_buff *skb)\r\n{\r\nstruct nfc_mei_phy *phy = phy_id;\r\nint r;\r\nMEI_DUMP_SKB_OUT("mei frame sent", skb);\r\nr = mei_cl_send(phy->device, skb->data, skb->len);\r\nif (r > 0)\r\nr = 0;\r\nreturn r;\r\n}\r\nvoid nfc_mei_event_cb(struct mei_cl_device *device, u32 events, void *context)\r\n{\r\nstruct nfc_mei_phy *phy = context;\r\nif (phy->hard_fault != 0)\r\nreturn;\r\nif (events & BIT(MEI_CL_EVENT_RX)) {\r\nstruct sk_buff *skb;\r\nint reply_size;\r\nskb = alloc_skb(MEI_NFC_MAX_READ, GFP_KERNEL);\r\nif (!skb)\r\nreturn;\r\nreply_size = mei_cl_recv(device, skb->data, MEI_NFC_MAX_READ);\r\nif (reply_size < MEI_NFC_HEADER_SIZE) {\r\nkfree_skb(skb);\r\nreturn;\r\n}\r\nskb_put(skb, reply_size);\r\nskb_pull(skb, MEI_NFC_HEADER_SIZE);\r\nMEI_DUMP_SKB_IN("mei frame read", skb);\r\nnfc_hci_recv_frame(phy->hdev, skb);\r\n}\r\n}\r\nstruct nfc_mei_phy *nfc_mei_phy_alloc(struct mei_cl_device *device)\r\n{\r\nstruct nfc_mei_phy *phy;\r\nphy = kzalloc(sizeof(struct nfc_mei_phy), GFP_KERNEL);\r\nif (!phy)\r\nreturn NULL;\r\nphy->device = device;\r\nmei_cl_set_drvdata(device, phy);\r\nreturn phy;\r\n}\r\nvoid nfc_mei_phy_free(struct nfc_mei_phy *phy)\r\n{\r\nkfree(phy);\r\n}

static inline struct xfs_inode_log_item *INODE_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_inode_log_item, ili_item);\r\n}\r\nSTATIC void\r\nxfs_inode_item_data_fork_size(\r\nstruct xfs_inode_log_item *iip,\r\nint *nvecs,\r\nint *nbytes)\r\n{\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nswitch (ip->i_d.di_format) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nif ((iip->ili_fields & XFS_ILOG_DEXT) &&\r\nip->i_d.di_nextents > 0 &&\r\nip->i_df.if_bytes > 0) {\r\n*nbytes += XFS_IFORK_DSIZE(ip);\r\n*nvecs += 1;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nif ((iip->ili_fields & XFS_ILOG_DBROOT) &&\r\nip->i_df.if_broot_bytes > 0) {\r\n*nbytes += ip->i_df.if_broot_bytes;\r\n*nvecs += 1;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\nif ((iip->ili_fields & XFS_ILOG_DDATA) &&\r\nip->i_df.if_bytes > 0) {\r\n*nbytes += roundup(ip->i_df.if_bytes, 4);\r\n*nvecs += 1;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_DEV:\r\ncase XFS_DINODE_FMT_UUID:\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\n}\r\nSTATIC void\r\nxfs_inode_item_attr_fork_size(\r\nstruct xfs_inode_log_item *iip,\r\nint *nvecs,\r\nint *nbytes)\r\n{\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nswitch (ip->i_d.di_aformat) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nif ((iip->ili_fields & XFS_ILOG_AEXT) &&\r\nip->i_d.di_anextents > 0 &&\r\nip->i_afp->if_bytes > 0) {\r\n*nbytes += XFS_IFORK_ASIZE(ip);\r\n*nvecs += 1;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nif ((iip->ili_fields & XFS_ILOG_ABROOT) &&\r\nip->i_afp->if_broot_bytes > 0) {\r\n*nbytes += ip->i_afp->if_broot_bytes;\r\n*nvecs += 1;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\nif ((iip->ili_fields & XFS_ILOG_ADATA) &&\r\nip->i_afp->if_bytes > 0) {\r\n*nbytes += roundup(ip->i_afp->if_bytes, 4);\r\n*nvecs += 1;\r\n}\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\n}\r\nSTATIC void\r\nxfs_inode_item_size(\r\nstruct xfs_log_item *lip,\r\nint *nvecs,\r\nint *nbytes)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\n*nvecs += 2;\r\n*nbytes += sizeof(struct xfs_inode_log_format) +\r\nxfs_icdinode_size(ip->i_d.di_version);\r\nxfs_inode_item_data_fork_size(iip, nvecs, nbytes);\r\nif (XFS_IFORK_Q(ip))\r\nxfs_inode_item_attr_fork_size(iip, nvecs, nbytes);\r\n}\r\nSTATIC void\r\nxfs_inode_item_format_data_fork(\r\nstruct xfs_inode_log_item *iip,\r\nstruct xfs_inode_log_format *ilf,\r\nstruct xfs_log_vec *lv,\r\nstruct xfs_log_iovec **vecp)\r\n{\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nsize_t data_bytes;\r\nswitch (ip->i_d.di_format) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEV | XFS_ILOG_UUID);\r\nif ((iip->ili_fields & XFS_ILOG_DEXT) &&\r\nip->i_d.di_nextents > 0 &&\r\nip->i_df.if_bytes > 0) {\r\nstruct xfs_bmbt_rec *p;\r\nASSERT(ip->i_df.if_u1.if_extents != NULL);\r\nASSERT(ip->i_df.if_bytes / sizeof(xfs_bmbt_rec_t) > 0);\r\np = xlog_prepare_iovec(lv, vecp, XLOG_REG_TYPE_IEXT);\r\ndata_bytes = xfs_iextents_copy(ip, p, XFS_DATA_FORK);\r\nxlog_finish_iovec(lv, *vecp, data_bytes);\r\nASSERT(data_bytes <= ip->i_df.if_bytes);\r\nilf->ilf_dsize = data_bytes;\r\nilf->ilf_size++;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_DEXT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DEXT |\r\nXFS_ILOG_DEV | XFS_ILOG_UUID);\r\nif ((iip->ili_fields & XFS_ILOG_DBROOT) &&\r\nip->i_df.if_broot_bytes > 0) {\r\nASSERT(ip->i_df.if_broot != NULL);\r\nxlog_copy_iovec(lv, vecp, XLOG_REG_TYPE_IBROOT,\r\nip->i_df.if_broot,\r\nip->i_df.if_broot_bytes);\r\nilf->ilf_dsize = ip->i_df.if_broot_bytes;\r\nilf->ilf_size++;\r\n} else {\r\nASSERT(!(iip->ili_fields &\r\nXFS_ILOG_DBROOT));\r\niip->ili_fields &= ~XFS_ILOG_DBROOT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DEXT | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEV | XFS_ILOG_UUID);\r\nif ((iip->ili_fields & XFS_ILOG_DDATA) &&\r\nip->i_df.if_bytes > 0) {\r\ndata_bytes = roundup(ip->i_df.if_bytes, 4);\r\nASSERT(ip->i_df.if_real_bytes == 0 ||\r\nip->i_df.if_real_bytes == data_bytes);\r\nASSERT(ip->i_df.if_u1.if_data != NULL);\r\nASSERT(ip->i_d.di_size > 0);\r\nxlog_copy_iovec(lv, vecp, XLOG_REG_TYPE_ILOCAL,\r\nip->i_df.if_u1.if_data, data_bytes);\r\nilf->ilf_dsize = (unsigned)data_bytes;\r\nilf->ilf_size++;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_DDATA;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_DEV:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEXT | XFS_ILOG_UUID);\r\nif (iip->ili_fields & XFS_ILOG_DEV)\r\nilf->ilf_u.ilfu_rdev = ip->i_df.if_u2.if_rdev;\r\nbreak;\r\ncase XFS_DINODE_FMT_UUID:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEXT | XFS_ILOG_DEV);\r\nif (iip->ili_fields & XFS_ILOG_UUID)\r\nilf->ilf_u.ilfu_uuid = ip->i_df.if_u2.if_uuid;\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\n}\r\nSTATIC void\r\nxfs_inode_item_format_attr_fork(\r\nstruct xfs_inode_log_item *iip,\r\nstruct xfs_inode_log_format *ilf,\r\nstruct xfs_log_vec *lv,\r\nstruct xfs_log_iovec **vecp)\r\n{\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nsize_t data_bytes;\r\nswitch (ip->i_d.di_aformat) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\niip->ili_fields &=\r\n~(XFS_ILOG_ADATA | XFS_ILOG_ABROOT);\r\nif ((iip->ili_fields & XFS_ILOG_AEXT) &&\r\nip->i_d.di_anextents > 0 &&\r\nip->i_afp->if_bytes > 0) {\r\nstruct xfs_bmbt_rec *p;\r\nASSERT(ip->i_afp->if_bytes / sizeof(xfs_bmbt_rec_t) ==\r\nip->i_d.di_anextents);\r\nASSERT(ip->i_afp->if_u1.if_extents != NULL);\r\np = xlog_prepare_iovec(lv, vecp, XLOG_REG_TYPE_IATTR_EXT);\r\ndata_bytes = xfs_iextents_copy(ip, p, XFS_ATTR_FORK);\r\nxlog_finish_iovec(lv, *vecp, data_bytes);\r\nilf->ilf_asize = data_bytes;\r\nilf->ilf_size++;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_AEXT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\niip->ili_fields &=\r\n~(XFS_ILOG_ADATA | XFS_ILOG_AEXT);\r\nif ((iip->ili_fields & XFS_ILOG_ABROOT) &&\r\nip->i_afp->if_broot_bytes > 0) {\r\nASSERT(ip->i_afp->if_broot != NULL);\r\nxlog_copy_iovec(lv, vecp, XLOG_REG_TYPE_IATTR_BROOT,\r\nip->i_afp->if_broot,\r\nip->i_afp->if_broot_bytes);\r\nilf->ilf_asize = ip->i_afp->if_broot_bytes;\r\nilf->ilf_size++;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_ABROOT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\niip->ili_fields &=\r\n~(XFS_ILOG_AEXT | XFS_ILOG_ABROOT);\r\nif ((iip->ili_fields & XFS_ILOG_ADATA) &&\r\nip->i_afp->if_bytes > 0) {\r\ndata_bytes = roundup(ip->i_afp->if_bytes, 4);\r\nASSERT(ip->i_afp->if_real_bytes == 0 ||\r\nip->i_afp->if_real_bytes == data_bytes);\r\nASSERT(ip->i_afp->if_u1.if_data != NULL);\r\nxlog_copy_iovec(lv, vecp, XLOG_REG_TYPE_IATTR_LOCAL,\r\nip->i_afp->if_u1.if_data,\r\ndata_bytes);\r\nilf->ilf_asize = (unsigned)data_bytes;\r\nilf->ilf_size++;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_ADATA;\r\n}\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\n}\r\nSTATIC void\r\nxfs_inode_item_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_vec *lv)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nstruct xfs_inode_log_format *ilf;\r\nstruct xfs_log_iovec *vecp = NULL;\r\nASSERT(ip->i_d.di_version > 1);\r\nilf = xlog_prepare_iovec(lv, &vecp, XLOG_REG_TYPE_IFORMAT);\r\nilf->ilf_type = XFS_LI_INODE;\r\nilf->ilf_ino = ip->i_ino;\r\nilf->ilf_blkno = ip->i_imap.im_blkno;\r\nilf->ilf_len = ip->i_imap.im_len;\r\nilf->ilf_boffset = ip->i_imap.im_boffset;\r\nilf->ilf_fields = XFS_ILOG_CORE;\r\nilf->ilf_size = 2;\r\nxlog_finish_iovec(lv, vecp, sizeof(struct xfs_inode_log_format));\r\nxlog_copy_iovec(lv, &vecp, XLOG_REG_TYPE_ICORE,\r\n&ip->i_d,\r\nxfs_icdinode_size(ip->i_d.di_version));\r\nxfs_inode_item_format_data_fork(iip, ilf, lv, &vecp);\r\nif (XFS_IFORK_Q(ip)) {\r\nxfs_inode_item_format_attr_fork(iip, ilf, lv, &vecp);\r\n} else {\r\niip->ili_fields &=\r\n~(XFS_ILOG_ADATA | XFS_ILOG_ABROOT | XFS_ILOG_AEXT);\r\n}\r\nilf->ilf_fields |= (iip->ili_fields & ~XFS_ILOG_TIMESTAMP);\r\n}\r\nSTATIC void\r\nxfs_inode_item_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_inode *ip = INODE_ITEM(lip)->ili_inode;\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\ntrace_xfs_inode_pin(ip, _RET_IP_);\r\natomic_inc(&ip->i_pincount);\r\n}\r\nSTATIC void\r\nxfs_inode_item_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\nstruct xfs_inode *ip = INODE_ITEM(lip)->ili_inode;\r\ntrace_xfs_inode_unpin(ip, _RET_IP_);\r\nASSERT(atomic_read(&ip->i_pincount) > 0);\r\nif (atomic_dec_and_test(&ip->i_pincount))\r\nwake_up_bit(&ip->i_flags, __XFS_IPINNED_BIT);\r\n}\r\nSTATIC uint\r\nxfs_inode_item_push(\r\nstruct xfs_log_item *lip,\r\nstruct list_head *buffer_list)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nstruct xfs_buf *bp = NULL;\r\nuint rval = XFS_ITEM_SUCCESS;\r\nint error;\r\nif (xfs_ipincount(ip) > 0)\r\nreturn XFS_ITEM_PINNED;\r\nif (!xfs_ilock_nowait(ip, XFS_ILOCK_SHARED))\r\nreturn XFS_ITEM_LOCKED;\r\nif (xfs_ipincount(ip) > 0) {\r\nrval = XFS_ITEM_PINNED;\r\ngoto out_unlock;\r\n}\r\nif (ip->i_flags & XFS_ISTALE) {\r\nrval = XFS_ITEM_PINNED;\r\ngoto out_unlock;\r\n}\r\nif (!xfs_iflock_nowait(ip)) {\r\nrval = XFS_ITEM_FLUSHING;\r\ngoto out_unlock;\r\n}\r\nASSERT(iip->ili_fields != 0 || XFS_FORCED_SHUTDOWN(ip->i_mount));\r\nASSERT(iip->ili_logged == 0 || XFS_FORCED_SHUTDOWN(ip->i_mount));\r\nspin_unlock(&lip->li_ailp->xa_lock);\r\nerror = xfs_iflush(ip, &bp);\r\nif (!error) {\r\nif (!xfs_buf_delwri_queue(bp, buffer_list))\r\nrval = XFS_ITEM_FLUSHING;\r\nxfs_buf_relse(bp);\r\n}\r\nspin_lock(&lip->li_ailp->xa_lock);\r\nout_unlock:\r\nxfs_iunlock(ip, XFS_ILOCK_SHARED);\r\nreturn rval;\r\n}\r\nSTATIC void\r\nxfs_inode_item_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nunsigned short lock_flags;\r\nASSERT(ip->i_itemp != NULL);\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\nlock_flags = iip->ili_lock_flags;\r\niip->ili_lock_flags = 0;\r\nif (lock_flags)\r\nxfs_iunlock(ip, lock_flags);\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_inode_item_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nif (xfs_iflags_test(ip, XFS_ISTALE)) {\r\nxfs_inode_item_unpin(lip, 0);\r\nreturn -1;\r\n}\r\nreturn lsn;\r\n}\r\nSTATIC void\r\nxfs_inode_item_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nINODE_ITEM(lip)->ili_last_lsn = lsn;\r\n}\r\nvoid\r\nxfs_inode_item_init(\r\nstruct xfs_inode *ip,\r\nstruct xfs_mount *mp)\r\n{\r\nstruct xfs_inode_log_item *iip;\r\nASSERT(ip->i_itemp == NULL);\r\niip = ip->i_itemp = kmem_zone_zalloc(xfs_ili_zone, KM_SLEEP);\r\niip->ili_inode = ip;\r\nxfs_log_item_init(mp, &iip->ili_item, XFS_LI_INODE,\r\n&xfs_inode_item_ops);\r\n}\r\nvoid\r\nxfs_inode_item_destroy(\r\nxfs_inode_t *ip)\r\n{\r\nkmem_zone_free(xfs_ili_zone, ip->i_itemp);\r\n}\r\nvoid\r\nxfs_iflush_done(\r\nstruct xfs_buf *bp,\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_inode_log_item *iip;\r\nstruct xfs_log_item *blip;\r\nstruct xfs_log_item *next;\r\nstruct xfs_log_item *prev;\r\nstruct xfs_ail *ailp = lip->li_ailp;\r\nint need_ail = 0;\r\nblip = bp->b_fspriv;\r\nprev = NULL;\r\nwhile (blip != NULL) {\r\nif (blip->li_cb != xfs_iflush_done) {\r\nprev = blip;\r\nblip = blip->li_bio_list;\r\ncontinue;\r\n}\r\nnext = blip->li_bio_list;\r\nif (!prev) {\r\nbp->b_fspriv = next;\r\n} else {\r\nprev->li_bio_list = next;\r\n}\r\nblip->li_bio_list = lip->li_bio_list;\r\nlip->li_bio_list = blip;\r\niip = INODE_ITEM(blip);\r\nif (iip->ili_logged && blip->li_lsn == iip->ili_flush_lsn)\r\nneed_ail++;\r\nblip = next;\r\n}\r\niip = INODE_ITEM(lip);\r\nif (iip->ili_logged && lip->li_lsn == iip->ili_flush_lsn)\r\nneed_ail++;\r\nif (need_ail) {\r\nstruct xfs_log_item *log_items[need_ail];\r\nint i = 0;\r\nspin_lock(&ailp->xa_lock);\r\nfor (blip = lip; blip; blip = blip->li_bio_list) {\r\niip = INODE_ITEM(blip);\r\nif (iip->ili_logged &&\r\nblip->li_lsn == iip->ili_flush_lsn) {\r\nlog_items[i++] = blip;\r\n}\r\nASSERT(i <= need_ail);\r\n}\r\nxfs_trans_ail_delete_bulk(ailp, log_items, i,\r\nSHUTDOWN_CORRUPT_INCORE);\r\n}\r\nfor (blip = lip; blip; blip = next) {\r\nnext = blip->li_bio_list;\r\nblip->li_bio_list = NULL;\r\niip = INODE_ITEM(blip);\r\niip->ili_logged = 0;\r\niip->ili_last_fields = 0;\r\nxfs_ifunlock(iip->ili_inode);\r\n}\r\n}\r\nvoid\r\nxfs_iflush_abort(\r\nxfs_inode_t *ip,\r\nbool stale)\r\n{\r\nxfs_inode_log_item_t *iip = ip->i_itemp;\r\nif (iip) {\r\nstruct xfs_ail *ailp = iip->ili_item.li_ailp;\r\nif (iip->ili_item.li_flags & XFS_LI_IN_AIL) {\r\nspin_lock(&ailp->xa_lock);\r\nif (iip->ili_item.li_flags & XFS_LI_IN_AIL) {\r\nxfs_trans_ail_delete(ailp, &iip->ili_item,\r\nstale ?\r\nSHUTDOWN_LOG_IO_ERROR :\r\nSHUTDOWN_CORRUPT_INCORE);\r\n} else\r\nspin_unlock(&ailp->xa_lock);\r\n}\r\niip->ili_logged = 0;\r\niip->ili_last_fields = 0;\r\niip->ili_fields = 0;\r\n}\r\nxfs_ifunlock(ip);\r\n}\r\nvoid\r\nxfs_istale_done(\r\nstruct xfs_buf *bp,\r\nstruct xfs_log_item *lip)\r\n{\r\nxfs_iflush_abort(INODE_ITEM(lip)->ili_inode, true);\r\n}\r\nint\r\nxfs_inode_item_format_convert(\r\nxfs_log_iovec_t *buf,\r\nxfs_inode_log_format_t *in_f)\r\n{\r\nif (buf->i_len == sizeof(xfs_inode_log_format_32_t)) {\r\nxfs_inode_log_format_32_t *in_f32 = buf->i_addr;\r\nin_f->ilf_type = in_f32->ilf_type;\r\nin_f->ilf_size = in_f32->ilf_size;\r\nin_f->ilf_fields = in_f32->ilf_fields;\r\nin_f->ilf_asize = in_f32->ilf_asize;\r\nin_f->ilf_dsize = in_f32->ilf_dsize;\r\nin_f->ilf_ino = in_f32->ilf_ino;\r\nmemcpy(in_f->ilf_u.ilfu_uuid.__u_bits,\r\nin_f32->ilf_u.ilfu_uuid.__u_bits,\r\nsizeof(uuid_t));\r\nin_f->ilf_blkno = in_f32->ilf_blkno;\r\nin_f->ilf_len = in_f32->ilf_len;\r\nin_f->ilf_boffset = in_f32->ilf_boffset;\r\nreturn 0;\r\n} else if (buf->i_len == sizeof(xfs_inode_log_format_64_t)){\r\nxfs_inode_log_format_64_t *in_f64 = buf->i_addr;\r\nin_f->ilf_type = in_f64->ilf_type;\r\nin_f->ilf_size = in_f64->ilf_size;\r\nin_f->ilf_fields = in_f64->ilf_fields;\r\nin_f->ilf_asize = in_f64->ilf_asize;\r\nin_f->ilf_dsize = in_f64->ilf_dsize;\r\nin_f->ilf_ino = in_f64->ilf_ino;\r\nmemcpy(in_f->ilf_u.ilfu_uuid.__u_bits,\r\nin_f64->ilf_u.ilfu_uuid.__u_bits,\r\nsizeof(uuid_t));\r\nin_f->ilf_blkno = in_f64->ilf_blkno;\r\nin_f->ilf_len = in_f64->ilf_len;\r\nin_f->ilf_boffset = in_f64->ilf_boffset;\r\nreturn 0;\r\n}\r\nreturn -EFSCORRUPTED;\r\n}

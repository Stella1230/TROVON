static void __init of_dump_addr(const char *s, const __be32 *addr, int na)\r\n{\r\npr_debug("%s", s);\r\nwhile(na--)\r\npr_cont(" %08x", *(addr++));\r\npr_debug("\n");\r\n}\r\nstatic void __init of_dump_addr(const char *s, const __be32 *addr, int na) { }\r\nstatic void __init fdt_bus_default_count_cells(const void *blob, int parentoffset,\r\nint *addrc, int *sizec)\r\n{\r\nconst __be32 *prop;\r\nif (addrc) {\r\nprop = fdt_getprop(blob, parentoffset, "#address-cells", NULL);\r\nif (prop)\r\n*addrc = be32_to_cpup(prop);\r\nelse\r\n*addrc = dt_root_addr_cells;\r\n}\r\nif (sizec) {\r\nprop = fdt_getprop(blob, parentoffset, "#size-cells", NULL);\r\nif (prop)\r\n*sizec = be32_to_cpup(prop);\r\nelse\r\n*sizec = dt_root_size_cells;\r\n}\r\n}\r\nstatic u64 __init fdt_bus_default_map(__be32 *addr, const __be32 *range,\r\nint na, int ns, int pna)\r\n{\r\nu64 cp, s, da;\r\ncp = of_read_number(range, na);\r\ns = of_read_number(range + na + pna, ns);\r\nda = of_read_number(addr, na);\r\npr_debug("FDT: default map, cp=%llx, s=%llx, da=%llx\n",\r\ncp, s, da);\r\nif (da < cp || da >= (cp + s))\r\nreturn OF_BAD_ADDR;\r\nreturn da - cp;\r\n}\r\nstatic int __init fdt_bus_default_translate(__be32 *addr, u64 offset, int na)\r\n{\r\nu64 a = of_read_number(addr, na);\r\nmemset(addr, 0, na * 4);\r\na += offset;\r\nif (na > 1)\r\naddr[na - 2] = cpu_to_fdt32(a >> 32);\r\naddr[na - 1] = cpu_to_fdt32(a & 0xffffffffu);\r\nreturn 0;\r\n}\r\nstatic int __init fdt_translate_one(const void *blob, int parent,\r\nconst struct of_bus *bus,\r\nconst struct of_bus *pbus, __be32 *addr,\r\nint na, int ns, int pna, const char *rprop)\r\n{\r\nconst __be32 *ranges;\r\nint rlen;\r\nint rone;\r\nu64 offset = OF_BAD_ADDR;\r\nranges = fdt_getprop(blob, parent, rprop, &rlen);\r\nif (!ranges)\r\nreturn 1;\r\nif (rlen == 0) {\r\noffset = of_read_number(addr, na);\r\nmemset(addr, 0, pna * 4);\r\npr_debug("FDT: empty ranges, 1:1 translation\n");\r\ngoto finish;\r\n}\r\npr_debug("FDT: walking ranges...\n");\r\nrlen /= 4;\r\nrone = na + pna + ns;\r\nfor (; rlen >= rone; rlen -= rone, ranges += rone) {\r\noffset = bus->map(addr, ranges, na, ns, pna);\r\nif (offset != OF_BAD_ADDR)\r\nbreak;\r\n}\r\nif (offset == OF_BAD_ADDR) {\r\npr_debug("FDT: not found !\n");\r\nreturn 1;\r\n}\r\nmemcpy(addr, ranges + na, 4 * pna);\r\nfinish:\r\nof_dump_addr("FDT: parent translation for:", addr, pna);\r\npr_debug("FDT: with offset: %llx\n", offset);\r\nreturn pbus->translate(addr, offset, pna);\r\n}\r\nu64 __init fdt_translate_address(const void *blob, int node_offset)\r\n{\r\nint parent, len;\r\nconst struct of_bus *bus, *pbus;\r\nconst __be32 *reg;\r\n__be32 addr[OF_MAX_ADDR_CELLS];\r\nint na, ns, pna, pns;\r\nu64 result = OF_BAD_ADDR;\r\npr_debug("FDT: ** translation for device %s **\n",\r\nfdt_get_name(blob, node_offset, NULL));\r\nreg = fdt_getprop(blob, node_offset, "reg", &len);\r\nif (!reg) {\r\npr_err("FDT: warning: device tree node '%s' has no address.\n",\r\nfdt_get_name(blob, node_offset, NULL));\r\ngoto bail;\r\n}\r\nparent = fdt_parent_offset(blob, node_offset);\r\nif (parent < 0)\r\ngoto bail;\r\nbus = &of_busses[0];\r\nbus->count_cells(blob, parent, &na, &ns);\r\nif (!OF_CHECK_COUNTS(na, ns)) {\r\npr_err("FDT: Bad cell count for %s\n",\r\nfdt_get_name(blob, node_offset, NULL));\r\ngoto bail;\r\n}\r\nmemcpy(addr, reg, na * 4);\r\npr_debug("FDT: bus (na=%d, ns=%d) on %s\n",\r\nna, ns, fdt_get_name(blob, parent, NULL));\r\nof_dump_addr("OF: translating address:", addr, na);\r\nfor (;;) {\r\nnode_offset = parent;\r\nparent = fdt_parent_offset(blob, node_offset);\r\nif (parent < 0) {\r\npr_debug("FDT: reached root node\n");\r\nresult = of_read_number(addr, na);\r\nbreak;\r\n}\r\npbus = &of_busses[0];\r\npbus->count_cells(blob, parent, &pna, &pns);\r\nif (!OF_CHECK_COUNTS(pna, pns)) {\r\npr_err("FDT: Bad cell count for %s\n",\r\nfdt_get_name(blob, node_offset, NULL));\r\nbreak;\r\n}\r\npr_debug("FDT: parent bus (na=%d, ns=%d) on %s\n",\r\npna, pns, fdt_get_name(blob, parent, NULL));\r\nif (fdt_translate_one(blob, node_offset, bus, pbus,\r\naddr, na, ns, pna, "ranges"))\r\nbreak;\r\nna = pna;\r\nns = pns;\r\nbus = pbus;\r\nof_dump_addr("FDT: one level translation:", addr, na);\r\n}\r\nbail:\r\nreturn result;\r\n}

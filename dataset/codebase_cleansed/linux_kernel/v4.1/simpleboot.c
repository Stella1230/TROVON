void platform_init(unsigned long r3, unsigned long r4, unsigned long r5,\r\nunsigned long r6, unsigned long r7)\r\n{\r\nconst u32 *na, *ns, *reg, *timebase;\r\nu64 memsize64;\r\nint node, size, i;\r\nif (fdt_check_header(_dtb_start) != 0)\r\nfatal("Invalid device tree blob\n");\r\nnode = fdt_path_offset(_dtb_start, "/");\r\nif (node < 0)\r\nfatal("Cannot find root node\n");\r\nna = fdt_getprop(_dtb_start, node, "#address-cells", &size);\r\nif (!na || (size != 4))\r\nfatal("Cannot find #address-cells property");\r\nns = fdt_getprop(_dtb_start, node, "#size-cells", &size);\r\nif (!ns || (size != 4))\r\nfatal("Cannot find #size-cells property");\r\nnode = fdt_node_offset_by_prop_value(_dtb_start, -1, "device_type",\r\n"memory", sizeof("memory"));\r\nif (node < 0)\r\nfatal("Cannot find memory node\n");\r\nreg = fdt_getprop(_dtb_start, node, "reg", &size);\r\nif (size < (*na+*ns) * sizeof(u32))\r\nfatal("cannot get memory range\n");\r\nfor (i = 0; i < *na; i++)\r\nif (*reg++ != 0)\r\nfatal("Memory range is not based at address 0\n");\r\nmemsize64 = 0;\r\nfor (i = 0; i < *ns; i++)\r\nmemsize64 = (memsize64 << 32) | *reg++;\r\nif (sizeof(void *) == 4 && memsize64 >= 0x100000000ULL)\r\nmemsize64 = 0xffffffff;\r\nnode = fdt_node_offset_by_prop_value(_dtb_start, -1, "device_type",\r\n"cpu", sizeof("cpu"));\r\nif (!node)\r\nfatal("Cannot find cpu node\n");\r\ntimebase = fdt_getprop(_dtb_start, node, "timebase-frequency", &size);\r\nif (timebase && (size == 4))\r\ntimebase_period_ns = 1000000000 / *timebase;\r\nsimple_alloc_init(_end, memsize64 - (unsigned long)_end, 32, 64);\r\nfdt_init(_dtb_start);\r\nif (platform_specific_init)\r\nplatform_specific_init();\r\nserial_console_init();\r\n}

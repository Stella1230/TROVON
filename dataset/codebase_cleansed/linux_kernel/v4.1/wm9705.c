static unsigned int ac97_read(struct snd_soc_codec *codec, unsigned int reg)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nu16 *cache = codec->reg_cache;\r\nswitch (reg) {\r\ncase AC97_RESET:\r\ncase AC97_VENDOR_ID1:\r\ncase AC97_VENDOR_ID2:\r\nreturn soc_ac97_ops->read(ac97, reg);\r\ndefault:\r\nreg = reg >> 1;\r\nif (reg >= (ARRAY_SIZE(wm9705_reg)))\r\nreturn -EIO;\r\nreturn cache[reg];\r\n}\r\n}\r\nstatic int ac97_write(struct snd_soc_codec *codec, unsigned int reg,\r\nunsigned int val)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nu16 *cache = codec->reg_cache;\r\nsoc_ac97_ops->write(ac97, reg, val);\r\nreg = reg >> 1;\r\nif (reg < (ARRAY_SIZE(wm9705_reg)))\r\ncache[reg] = val;\r\nreturn 0;\r\n}\r\nstatic int ac97_prepare(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nint reg;\r\nu16 vra;\r\nvra = ac97_read(codec, AC97_EXTENDED_STATUS);\r\nac97_write(codec, AC97_EXTENDED_STATUS, vra | 0x1);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nreg = AC97_PCM_FRONT_DAC_RATE;\r\nelse\r\nreg = AC97_PCM_LR_ADC_RATE;\r\nreturn ac97_write(codec, reg, substream->runtime->rate);\r\n}\r\nstatic int wm9705_reset(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nif (soc_ac97_ops->reset) {\r\nsoc_ac97_ops->reset(ac97);\r\nif (ac97_read(codec, 0) == wm9705_reg[0])\r\nreturn 0;\r\n}\r\ndev_err(codec->dev, "Failed to reset: AC97 link error\n");\r\nreturn -EIO;\r\n}\r\nstatic int wm9705_soc_suspend(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nsoc_ac97_ops->write(ac97, AC97_POWERDOWN, 0xffff);\r\nreturn 0;\r\n}\r\nstatic int wm9705_soc_resume(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nint i, ret;\r\nu16 *cache = codec->reg_cache;\r\nret = wm9705_reset(codec);\r\nif (ret < 0)\r\nreturn ret;\r\nfor (i = 2; i < ARRAY_SIZE(wm9705_reg) << 1; i += 2) {\r\nsoc_ac97_ops->write(ac97, i, cache[i>>1]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm9705_soc_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97;\r\nint ret = 0;\r\nac97 = snd_soc_alloc_ac97_codec(codec);\r\nif (IS_ERR(ac97)) {\r\nret = PTR_ERR(ac97);\r\ndev_err(codec->dev, "Failed to register AC97 codec\n");\r\nreturn ret;\r\n}\r\nret = wm9705_reset(codec);\r\nif (ret)\r\ngoto err_put_device;\r\nret = device_add(&ac97->dev);\r\nif (ret)\r\ngoto err_put_device;\r\nsnd_soc_codec_set_drvdata(codec, ac97);\r\nreturn 0;\r\nerr_put_device:\r\nput_device(&ac97->dev);\r\nreturn ret;\r\n}\r\nstatic int wm9705_soc_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nsnd_soc_free_ac97_codec(ac97);\r\nreturn 0;\r\n}\r\nstatic int wm9705_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_codec(&pdev->dev,\r\n&soc_codec_dev_wm9705, wm9705_dai, ARRAY_SIZE(wm9705_dai));\r\n}\r\nstatic int wm9705_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nreturn 0;\r\n}

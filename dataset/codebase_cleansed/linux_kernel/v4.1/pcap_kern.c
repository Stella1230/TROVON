void pcap_init(struct net_device *dev, void *data)\r\n{\r\nstruct uml_net_private *pri;\r\nstruct pcap_data *ppri;\r\nstruct pcap_init *init = data;\r\npri = netdev_priv(dev);\r\nppri = (struct pcap_data *) pri->user;\r\nppri->host_if = init->host_if;\r\nppri->promisc = init->promisc;\r\nppri->optimize = init->optimize;\r\nppri->filter = init->filter;\r\nprintk("pcap backend, host interface %s\n", ppri->host_if);\r\n}\r\nstatic int pcap_read(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nreturn pcap_user_read(fd, skb_mac_header(skb),\r\nskb->dev->mtu + ETH_HEADER_OTHER,\r\n(struct pcap_data *) &lp->user);\r\n}\r\nstatic int pcap_write(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nreturn -EPERM;\r\n}\r\nint pcap_setup(char *str, char **mac_out, void *data)\r\n{\r\nstruct pcap_init *init = data;\r\nchar *remain, *host_if = NULL, *options[2] = { NULL, NULL };\r\nint i;\r\n*init = ((struct pcap_init)\r\n{ .host_if = "eth0",\r\n.promisc = 1,\r\n.optimize = 0,\r\n.filter = NULL });\r\nremain = split_if_spec(str, &host_if, &init->filter,\r\n&options[0], &options[1], mac_out, NULL);\r\nif (remain != NULL) {\r\nprintk(KERN_ERR "pcap_setup - Extra garbage on "\r\n"specification : '%s'\n", remain);\r\nreturn 0;\r\n}\r\nif (host_if != NULL)\r\ninit->host_if = host_if;\r\nfor (i = 0; i < ARRAY_SIZE(options); i++) {\r\nif (options[i] == NULL)\r\ncontinue;\r\nif (!strcmp(options[i], "promisc"))\r\ninit->promisc = 1;\r\nelse if (!strcmp(options[i], "nopromisc"))\r\ninit->promisc = 0;\r\nelse if (!strcmp(options[i], "optimize"))\r\ninit->optimize = 1;\r\nelse if (!strcmp(options[i], "nooptimize"))\r\ninit->optimize = 0;\r\nelse {\r\nprintk(KERN_ERR "pcap_setup : bad option - '%s'\n",\r\noptions[i]);\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nstatic int register_pcap(void)\r\n{\r\nregister_transport(&pcap_transport);\r\nreturn 0;\r\n}

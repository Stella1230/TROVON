static s8 fix_rssi_inv_only(u8 rssi_val)\r\n{\r\nif (rssi_val == 128)\r\nrssi_val = 0;\r\nreturn (s8) rssi_val;\r\n}\r\nstatic void ath_debug_send_fft_sample(struct ath_spec_scan_priv *spec_priv,\r\nstruct fft_sample_tlv *fft_sample_tlv)\r\n{\r\nint length;\r\nif (!spec_priv->rfs_chan_spec_scan)\r\nreturn;\r\nlength = __be16_to_cpu(fft_sample_tlv->length) +\r\nsizeof(*fft_sample_tlv);\r\nrelay_write(spec_priv->rfs_chan_spec_scan, fft_sample_tlv, length);\r\n}\r\nint ath_cmn_process_fft(struct ath_spec_scan_priv *spec_priv, struct ieee80211_hdr *hdr,\r\nstruct ath_rx_status *rs, u64 tsf)\r\n{\r\nstruct ath_hw *ah = spec_priv->ah;\r\nstruct ath_common *common = ath9k_hw_common(spec_priv->ah);\r\nu8 num_bins, *bins, *vdata = (u8 *)hdr;\r\nstruct fft_sample_ht20 fft_sample_20;\r\nstruct fft_sample_ht20_40 fft_sample_40;\r\nstruct fft_sample_tlv *tlv;\r\nstruct ath_radar_info *radar_info;\r\nint len = rs->rs_datalen;\r\nint dc_pos;\r\nu16 fft_len, length, freq = ah->curchan->chan->center_freq;\r\nenum nl80211_channel_type chan_type;\r\nif (rs->rs_phyerr != ATH9K_PHYERR_RADAR &&\r\nrs->rs_phyerr != ATH9K_PHYERR_FALSE_RADAR_EXT &&\r\nrs->rs_phyerr != ATH9K_PHYERR_SPECTRAL)\r\nreturn 0;\r\nradar_info = ((struct ath_radar_info *)&vdata[len]) - 1;\r\nif (!(radar_info->pulse_bw_info & SPECTRAL_SCAN_BITMASK))\r\nreturn 0;\r\nchan_type = cfg80211_get_chandef_type(&common->hw->conf.chandef);\r\nif ((chan_type == NL80211_CHAN_HT40MINUS) ||\r\n(chan_type == NL80211_CHAN_HT40PLUS)) {\r\nfft_len = SPECTRAL_HT20_40_TOTAL_DATA_LEN;\r\nnum_bins = SPECTRAL_HT20_40_NUM_BINS;\r\nbins = (u8 *)fft_sample_40.data;\r\n} else {\r\nfft_len = SPECTRAL_HT20_TOTAL_DATA_LEN;\r\nnum_bins = SPECTRAL_HT20_NUM_BINS;\r\nbins = (u8 *)fft_sample_20.data;\r\n}\r\nif ((len > fft_len + 2) || (len < fft_len - 1))\r\nreturn 1;\r\nswitch (len - fft_len) {\r\ncase 0:\r\nmemcpy(bins, vdata, num_bins);\r\nbreak;\r\ncase -1:\r\nmemcpy(&bins[1], vdata, num_bins - 1);\r\nbins[0] = vdata[0];\r\nbreak;\r\ncase 2:\r\nmemcpy(bins, vdata, 30);\r\nbins[30] = vdata[31];\r\nmemcpy(&bins[31], &vdata[33], num_bins - 31);\r\nbreak;\r\ncase 1:\r\nbins[0] = vdata[0];\r\nmemcpy(&bins[1], vdata, 30);\r\nbins[31] = vdata[31];\r\nmemcpy(&bins[32], &vdata[33], num_bins - 32);\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\ndc_pos = num_bins / 2;\r\nbins[dc_pos] = (bins[dc_pos + 1] + bins[dc_pos - 1]) / 2;\r\nif ((chan_type == NL80211_CHAN_HT40MINUS) ||\r\n(chan_type == NL80211_CHAN_HT40PLUS)) {\r\ns8 lower_rssi, upper_rssi;\r\ns16 ext_nf;\r\nu8 lower_max_index, upper_max_index;\r\nu8 lower_bitmap_w, upper_bitmap_w;\r\nu16 lower_mag, upper_mag;\r\nstruct ath9k_hw_cal_data *caldata = ah->caldata;\r\nstruct ath_ht20_40_mag_info *mag_info;\r\nif (caldata)\r\next_nf = ath9k_hw_getchan_noise(ah, ah->curchan,\r\ncaldata->nfCalHist[3].privNF);\r\nelse\r\next_nf = ATH_DEFAULT_NOISE_FLOOR;\r\nlength = sizeof(fft_sample_40) - sizeof(struct fft_sample_tlv);\r\nfft_sample_40.tlv.type = ATH_FFT_SAMPLE_HT20_40;\r\nfft_sample_40.tlv.length = __cpu_to_be16(length);\r\nfft_sample_40.freq = __cpu_to_be16(freq);\r\nfft_sample_40.channel_type = chan_type;\r\nif (chan_type == NL80211_CHAN_HT40PLUS) {\r\nlower_rssi = fix_rssi_inv_only(rs->rs_rssi_ctl[0]);\r\nupper_rssi = fix_rssi_inv_only(rs->rs_rssi_ext[0]);\r\nfft_sample_40.lower_noise = ah->noise;\r\nfft_sample_40.upper_noise = ext_nf;\r\n} else {\r\nlower_rssi = fix_rssi_inv_only(rs->rs_rssi_ext[0]);\r\nupper_rssi = fix_rssi_inv_only(rs->rs_rssi_ctl[0]);\r\nfft_sample_40.lower_noise = ext_nf;\r\nfft_sample_40.upper_noise = ah->noise;\r\n}\r\nfft_sample_40.lower_rssi = lower_rssi;\r\nfft_sample_40.upper_rssi = upper_rssi;\r\nmag_info = ((struct ath_ht20_40_mag_info *)radar_info) - 1;\r\nlower_mag = spectral_max_magnitude(mag_info->lower_bins);\r\nupper_mag = spectral_max_magnitude(mag_info->upper_bins);\r\nfft_sample_40.lower_max_magnitude = __cpu_to_be16(lower_mag);\r\nfft_sample_40.upper_max_magnitude = __cpu_to_be16(upper_mag);\r\nlower_max_index = spectral_max_index(mag_info->lower_bins);\r\nupper_max_index = spectral_max_index(mag_info->upper_bins);\r\nfft_sample_40.lower_max_index = lower_max_index;\r\nfft_sample_40.upper_max_index = upper_max_index;\r\nlower_bitmap_w = spectral_bitmap_weight(mag_info->lower_bins);\r\nupper_bitmap_w = spectral_bitmap_weight(mag_info->upper_bins);\r\nfft_sample_40.lower_bitmap_weight = lower_bitmap_w;\r\nfft_sample_40.upper_bitmap_weight = upper_bitmap_w;\r\nfft_sample_40.max_exp = mag_info->max_exp & 0xf;\r\nfft_sample_40.tsf = __cpu_to_be64(tsf);\r\ntlv = (struct fft_sample_tlv *)&fft_sample_40;\r\n} else {\r\nu8 max_index, bitmap_w;\r\nu16 magnitude;\r\nstruct ath_ht20_mag_info *mag_info;\r\nlength = sizeof(fft_sample_20) - sizeof(struct fft_sample_tlv);\r\nfft_sample_20.tlv.type = ATH_FFT_SAMPLE_HT20;\r\nfft_sample_20.tlv.length = __cpu_to_be16(length);\r\nfft_sample_20.freq = __cpu_to_be16(freq);\r\nfft_sample_20.rssi = fix_rssi_inv_only(rs->rs_rssi_ctl[0]);\r\nfft_sample_20.noise = ah->noise;\r\nmag_info = ((struct ath_ht20_mag_info *)radar_info) - 1;\r\nmagnitude = spectral_max_magnitude(mag_info->all_bins);\r\nfft_sample_20.max_magnitude = __cpu_to_be16(magnitude);\r\nmax_index = spectral_max_index(mag_info->all_bins);\r\nfft_sample_20.max_index = max_index;\r\nbitmap_w = spectral_bitmap_weight(mag_info->all_bins);\r\nfft_sample_20.bitmap_weight = bitmap_w;\r\nfft_sample_20.max_exp = mag_info->max_exp & 0xf;\r\nfft_sample_20.tsf = __cpu_to_be64(tsf);\r\ntlv = (struct fft_sample_tlv *)&fft_sample_20;\r\n}\r\nath_debug_send_fft_sample(spec_priv, tlv);\r\nreturn 1;\r\n}\r\nstatic ssize_t read_file_spec_scan_ctl(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nchar *mode = "";\r\nunsigned int len;\r\nswitch (spec_priv->spectral_mode) {\r\ncase SPECTRAL_DISABLED:\r\nmode = "disable";\r\nbreak;\r\ncase SPECTRAL_BACKGROUND:\r\nmode = "background";\r\nbreak;\r\ncase SPECTRAL_CHANSCAN:\r\nmode = "chanscan";\r\nbreak;\r\ncase SPECTRAL_MANUAL:\r\nmode = "manual";\r\nbreak;\r\n}\r\nlen = strlen(mode);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, mode, len);\r\n}\r\nvoid ath9k_cmn_spectral_scan_trigger(struct ath_common *common,\r\nstruct ath_spec_scan_priv *spec_priv)\r\n{\r\nstruct ath_hw *ah = spec_priv->ah;\r\nu32 rxfilter;\r\nif (config_enabled(CONFIG_ATH9K_TX99))\r\nreturn;\r\nif (!ath9k_hw_ops(ah)->spectral_scan_trigger) {\r\nath_err(common, "spectrum analyzer not implemented on this hardware\n");\r\nreturn;\r\n}\r\nath_ps_ops(common)->wakeup(common);\r\nrxfilter = ath9k_hw_getrxfilter(ah);\r\nath9k_hw_setrxfilter(ah, rxfilter |\r\nATH9K_RX_FILTER_PHYRADAR |\r\nATH9K_RX_FILTER_PHYERR);\r\nath9k_cmn_spectral_scan_config(common, spec_priv, spec_priv->spectral_mode);\r\nath9k_hw_ops(ah)->spectral_scan_trigger(ah);\r\nath_ps_ops(common)->restore(common);\r\n}\r\nint ath9k_cmn_spectral_scan_config(struct ath_common *common,\r\nstruct ath_spec_scan_priv *spec_priv,\r\nenum spectral_mode spectral_mode)\r\n{\r\nstruct ath_hw *ah = spec_priv->ah;\r\nif (!ath9k_hw_ops(ah)->spectral_scan_trigger) {\r\nath_err(common, "spectrum analyzer not implemented on this hardware\n");\r\nreturn -1;\r\n}\r\nswitch (spectral_mode) {\r\ncase SPECTRAL_DISABLED:\r\nspec_priv->spec_config.enabled = 0;\r\nbreak;\r\ncase SPECTRAL_BACKGROUND:\r\nspec_priv->spec_config.endless = 1;\r\nspec_priv->spec_config.enabled = 1;\r\nbreak;\r\ncase SPECTRAL_CHANSCAN:\r\ncase SPECTRAL_MANUAL:\r\nspec_priv->spec_config.endless = 0;\r\nspec_priv->spec_config.enabled = 1;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nath_ps_ops(common)->wakeup(common);\r\nath9k_hw_ops(ah)->spectral_scan_config(ah, &spec_priv->spec_config);\r\nath_ps_ops(common)->restore(common);\r\nspec_priv->spectral_mode = spectral_mode;\r\nreturn 0;\r\n}\r\nstatic ssize_t write_file_spec_scan_ctl(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nstruct ath_common *common = ath9k_hw_common(spec_priv->ah);\r\nchar buf[32];\r\nssize_t len;\r\nif (config_enabled(CONFIG_ATH9K_TX99))\r\nreturn -EOPNOTSUPP;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (strncmp("trigger", buf, 7) == 0) {\r\nath9k_cmn_spectral_scan_trigger(common, spec_priv);\r\n} else if (strncmp("background", buf, 10) == 0) {\r\nath9k_cmn_spectral_scan_config(common, spec_priv, SPECTRAL_BACKGROUND);\r\nath_dbg(common, CONFIG, "spectral scan: background mode enabled\n");\r\n} else if (strncmp("chanscan", buf, 8) == 0) {\r\nath9k_cmn_spectral_scan_config(common, spec_priv, SPECTRAL_CHANSCAN);\r\nath_dbg(common, CONFIG, "spectral scan: channel scan mode enabled\n");\r\n} else if (strncmp("manual", buf, 6) == 0) {\r\nath9k_cmn_spectral_scan_config(common, spec_priv, SPECTRAL_MANUAL);\r\nath_dbg(common, CONFIG, "spectral scan: manual mode enabled\n");\r\n} else if (strncmp("disable", buf, 7) == 0) {\r\nath9k_cmn_spectral_scan_config(common, spec_priv, SPECTRAL_DISABLED);\r\nath_dbg(common, CONFIG, "spectral scan: disabled\n");\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t read_file_spectral_short_repeat(struct file *file,\r\nchar __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nchar buf[32];\r\nunsigned int len;\r\nlen = sprintf(buf, "%d\n", spec_priv->spec_config.short_repeat);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t write_file_spectral_short_repeat(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nunsigned long val;\r\nchar buf[32];\r\nssize_t len;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (kstrtoul(buf, 0, &val))\r\nreturn -EINVAL;\r\nif (val > 1)\r\nreturn -EINVAL;\r\nspec_priv->spec_config.short_repeat = val;\r\nreturn count;\r\n}\r\nstatic ssize_t read_file_spectral_count(struct file *file,\r\nchar __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nchar buf[32];\r\nunsigned int len;\r\nlen = sprintf(buf, "%d\n", spec_priv->spec_config.count);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t write_file_spectral_count(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nunsigned long val;\r\nchar buf[32];\r\nssize_t len;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (kstrtoul(buf, 0, &val))\r\nreturn -EINVAL;\r\nif (val > 255)\r\nreturn -EINVAL;\r\nspec_priv->spec_config.count = val;\r\nreturn count;\r\n}\r\nstatic ssize_t read_file_spectral_period(struct file *file,\r\nchar __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nchar buf[32];\r\nunsigned int len;\r\nlen = sprintf(buf, "%d\n", spec_priv->spec_config.period);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t write_file_spectral_period(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nunsigned long val;\r\nchar buf[32];\r\nssize_t len;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (kstrtoul(buf, 0, &val))\r\nreturn -EINVAL;\r\nif (val > 255)\r\nreturn -EINVAL;\r\nspec_priv->spec_config.period = val;\r\nreturn count;\r\n}\r\nstatic ssize_t read_file_spectral_fft_period(struct file *file,\r\nchar __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nchar buf[32];\r\nunsigned int len;\r\nlen = sprintf(buf, "%d\n", spec_priv->spec_config.fft_period);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t write_file_spectral_fft_period(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_spec_scan_priv *spec_priv = file->private_data;\r\nunsigned long val;\r\nchar buf[32];\r\nssize_t len;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (kstrtoul(buf, 0, &val))\r\nreturn -EINVAL;\r\nif (val > 15)\r\nreturn -EINVAL;\r\nspec_priv->spec_config.fft_period = val;\r\nreturn count;\r\n}\r\nstatic struct dentry *create_buf_file_handler(const char *filename,\r\nstruct dentry *parent,\r\numode_t mode,\r\nstruct rchan_buf *buf,\r\nint *is_global)\r\n{\r\nstruct dentry *buf_file;\r\nbuf_file = debugfs_create_file(filename, mode, parent, buf,\r\n&relay_file_operations);\r\n*is_global = 1;\r\nreturn buf_file;\r\n}\r\nstatic int remove_buf_file_handler(struct dentry *dentry)\r\n{\r\ndebugfs_remove(dentry);\r\nreturn 0;\r\n}\r\nvoid ath9k_cmn_spectral_deinit_debug(struct ath_spec_scan_priv *spec_priv)\r\n{\r\nif (config_enabled(CONFIG_ATH9K_DEBUGFS)) {\r\nrelay_close(spec_priv->rfs_chan_spec_scan);\r\nspec_priv->rfs_chan_spec_scan = NULL;\r\n}\r\n}\r\nvoid ath9k_cmn_spectral_init_debug(struct ath_spec_scan_priv *spec_priv,\r\nstruct dentry *debugfs_phy)\r\n{\r\nspec_priv->rfs_chan_spec_scan = relay_open("spectral_scan",\r\ndebugfs_phy,\r\n1024, 256, &rfs_spec_scan_cb,\r\nNULL);\r\ndebugfs_create_file("spectral_scan_ctl",\r\nS_IRUSR | S_IWUSR,\r\ndebugfs_phy, spec_priv,\r\n&fops_spec_scan_ctl);\r\ndebugfs_create_file("spectral_short_repeat",\r\nS_IRUSR | S_IWUSR,\r\ndebugfs_phy, spec_priv,\r\n&fops_spectral_short_repeat);\r\ndebugfs_create_file("spectral_count",\r\nS_IRUSR | S_IWUSR,\r\ndebugfs_phy, spec_priv,\r\n&fops_spectral_count);\r\ndebugfs_create_file("spectral_period",\r\nS_IRUSR | S_IWUSR,\r\ndebugfs_phy, spec_priv,\r\n&fops_spectral_period);\r\ndebugfs_create_file("spectral_fft_period",\r\nS_IRUSR | S_IWUSR,\r\ndebugfs_phy, spec_priv,\r\n&fops_spectral_fft_period);\r\n}

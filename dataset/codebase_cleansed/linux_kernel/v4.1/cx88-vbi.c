int cx8800_vbi_fmt (struct file *file, void *priv,\r\nstruct v4l2_format *f)\r\n{\r\nstruct cx8800_dev *dev = video_drvdata(file);\r\nf->fmt.vbi.samples_per_line = VBI_LINE_LENGTH;\r\nf->fmt.vbi.sample_format = V4L2_PIX_FMT_GREY;\r\nf->fmt.vbi.offset = 244;\r\nif (dev->core->tvnorm & V4L2_STD_525_60) {\r\nf->fmt.vbi.sampling_rate = 28636363;\r\nf->fmt.vbi.start[0] = 10;\r\nf->fmt.vbi.start[1] = 273;\r\nf->fmt.vbi.count[0] = VBI_LINE_NTSC_COUNT;\r\nf->fmt.vbi.count[1] = VBI_LINE_NTSC_COUNT;\r\n} else if (dev->core->tvnorm & V4L2_STD_625_50) {\r\nf->fmt.vbi.sampling_rate = 35468950;\r\nf->fmt.vbi.start[0] = V4L2_VBI_ITU_625_F1_START + 5;\r\nf->fmt.vbi.start[1] = V4L2_VBI_ITU_625_F2_START + 5;\r\nf->fmt.vbi.count[0] = VBI_LINE_PAL_COUNT;\r\nf->fmt.vbi.count[1] = VBI_LINE_PAL_COUNT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cx8800_start_vbi_dma(struct cx8800_dev *dev,\r\nstruct cx88_dmaqueue *q,\r\nstruct cx88_buffer *buf)\r\n{\r\nstruct cx88_core *core = dev->core;\r\ncx88_sram_channel_setup(dev->core, &cx88_sram_channels[SRAM_CH24],\r\nVBI_LINE_LENGTH, buf->risc.dma);\r\ncx_write(MO_VBOS_CONTROL, ( (1 << 18) |\r\n(1 << 15) |\r\n(1 << 11) ));\r\ncx_write(MO_VBI_GPCNTRL, GP_COUNT_CONTROL_RESET);\r\nq->count = 1;\r\ncx_set(MO_PCI_INTMSK, core->pci_irqmask | PCI_INT_VIDINT);\r\ncx_set(MO_VID_INTMSK, 0x0f0088);\r\ncx_set(VID_CAPTURE_CONTROL,0x18);\r\ncx_set(MO_DEV_CNTRL2, (1<<5));\r\ncx_set(MO_VID_DMACNTRL, 0x88);\r\nreturn 0;\r\n}\r\nvoid cx8800_stop_vbi_dma(struct cx8800_dev *dev)\r\n{\r\nstruct cx88_core *core = dev->core;\r\ncx_clear(MO_VID_DMACNTRL, 0x88);\r\ncx_clear(VID_CAPTURE_CONTROL,0x18);\r\ncx_clear(MO_PCI_INTMSK, PCI_INT_VIDINT);\r\ncx_clear(MO_VID_INTMSK, 0x0f0088);\r\n}\r\nint cx8800_restart_vbi_queue(struct cx8800_dev *dev,\r\nstruct cx88_dmaqueue *q)\r\n{\r\nstruct cx88_buffer *buf;\r\nif (list_empty(&q->active))\r\nreturn 0;\r\nbuf = list_entry(q->active.next, struct cx88_buffer, list);\r\ndprintk(2,"restart_queue [%p/%d]: restart dma\n",\r\nbuf, buf->vb.v4l2_buf.index);\r\ncx8800_start_vbi_dma(dev, q, buf);\r\nlist_for_each_entry(buf, &q->active, list)\r\nbuf->count = q->count++;\r\nreturn 0;\r\n}\r\nstatic int queue_setup(struct vb2_queue *q, const struct v4l2_format *fmt,\r\nunsigned int *num_buffers, unsigned int *num_planes,\r\nunsigned int sizes[], void *alloc_ctxs[])\r\n{\r\nstruct cx8800_dev *dev = q->drv_priv;\r\n*num_planes = 1;\r\nif (dev->core->tvnorm & V4L2_STD_525_60)\r\nsizes[0] = VBI_LINE_NTSC_COUNT * VBI_LINE_LENGTH * 2;\r\nelse\r\nsizes[0] = VBI_LINE_PAL_COUNT * VBI_LINE_LENGTH * 2;\r\nalloc_ctxs[0] = dev->alloc_ctx;\r\nreturn 0;\r\n}\r\nstatic int buffer_prepare(struct vb2_buffer *vb)\r\n{\r\nstruct cx8800_dev *dev = vb->vb2_queue->drv_priv;\r\nstruct cx88_buffer *buf = container_of(vb, struct cx88_buffer, vb);\r\nstruct sg_table *sgt = vb2_dma_sg_plane_desc(vb, 0);\r\nunsigned int lines;\r\nunsigned int size;\r\nif (dev->core->tvnorm & V4L2_STD_525_60)\r\nlines = VBI_LINE_NTSC_COUNT;\r\nelse\r\nlines = VBI_LINE_PAL_COUNT;\r\nsize = lines * VBI_LINE_LENGTH * 2;\r\nif (vb2_plane_size(vb, 0) < size)\r\nreturn -EINVAL;\r\nvb2_set_plane_payload(vb, 0, size);\r\ncx88_risc_buffer(dev->pci, &buf->risc, sgt->sgl,\r\n0, VBI_LINE_LENGTH * lines,\r\nVBI_LINE_LENGTH, 0,\r\nlines);\r\nreturn 0;\r\n}\r\nstatic void buffer_finish(struct vb2_buffer *vb)\r\n{\r\nstruct cx8800_dev *dev = vb->vb2_queue->drv_priv;\r\nstruct cx88_buffer *buf = container_of(vb, struct cx88_buffer, vb);\r\nstruct cx88_riscmem *risc = &buf->risc;\r\nif (risc->cpu)\r\npci_free_consistent(dev->pci, risc->size, risc->cpu, risc->dma);\r\nmemset(risc, 0, sizeof(*risc));\r\n}\r\nstatic void buffer_queue(struct vb2_buffer *vb)\r\n{\r\nstruct cx8800_dev *dev = vb->vb2_queue->drv_priv;\r\nstruct cx88_buffer *buf = container_of(vb, struct cx88_buffer, vb);\r\nstruct cx88_buffer *prev;\r\nstruct cx88_dmaqueue *q = &dev->vbiq;\r\nbuf->risc.cpu[1] = cpu_to_le32(buf->risc.dma + 8);\r\nbuf->risc.jmp[0] = cpu_to_le32(RISC_JUMP | RISC_CNT_INC);\r\nbuf->risc.jmp[1] = cpu_to_le32(buf->risc.dma + 8);\r\nif (list_empty(&q->active)) {\r\nlist_add_tail(&buf->list, &q->active);\r\ncx8800_start_vbi_dma(dev, q, buf);\r\nbuf->count = q->count++;\r\ndprintk(2,"[%p/%d] vbi_queue - first active\n",\r\nbuf, buf->vb.v4l2_buf.index);\r\n} else {\r\nbuf->risc.cpu[0] |= cpu_to_le32(RISC_IRQ1);\r\nprev = list_entry(q->active.prev, struct cx88_buffer, list);\r\nlist_add_tail(&buf->list, &q->active);\r\nbuf->count = q->count++;\r\nprev->risc.jmp[1] = cpu_to_le32(buf->risc.dma);\r\ndprintk(2,"[%p/%d] buffer_queue - append to active\n",\r\nbuf, buf->vb.v4l2_buf.index);\r\n}\r\n}\r\nstatic int start_streaming(struct vb2_queue *q, unsigned int count)\r\n{\r\nstruct cx8800_dev *dev = q->drv_priv;\r\nstruct cx88_dmaqueue *dmaq = &dev->vbiq;\r\nstruct cx88_buffer *buf = list_entry(dmaq->active.next,\r\nstruct cx88_buffer, list);\r\ncx8800_start_vbi_dma(dev, dmaq, buf);\r\nreturn 0;\r\n}\r\nstatic void stop_streaming(struct vb2_queue *q)\r\n{\r\nstruct cx8800_dev *dev = q->drv_priv;\r\nstruct cx88_core *core = dev->core;\r\nstruct cx88_dmaqueue *dmaq = &dev->vbiq;\r\nunsigned long flags;\r\ncx_clear(MO_VID_DMACNTRL, 0x11);\r\ncx_clear(VID_CAPTURE_CONTROL, 0x06);\r\ncx8800_stop_vbi_dma(dev);\r\nspin_lock_irqsave(&dev->slock, flags);\r\nwhile (!list_empty(&dmaq->active)) {\r\nstruct cx88_buffer *buf = list_entry(dmaq->active.next,\r\nstruct cx88_buffer, list);\r\nlist_del(&buf->list);\r\nvb2_buffer_done(&buf->vb, VB2_BUF_STATE_ERROR);\r\n}\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\n}

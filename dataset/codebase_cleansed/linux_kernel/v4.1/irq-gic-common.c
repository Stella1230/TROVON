int gic_configure_irq(unsigned int irq, unsigned int type,\r\nvoid __iomem *base, void (*sync_access)(void))\r\n{\r\nu32 enablemask = 1 << (irq % 32);\r\nu32 enableoff = (irq / 32) * 4;\r\nu32 confmask = 0x2 << ((irq % 16) * 2);\r\nu32 confoff = (irq / 16) * 4;\r\nbool enabled = false;\r\nu32 val, oldval;\r\nint ret = 0;\r\nval = oldval = readl_relaxed(base + GIC_DIST_CONFIG + confoff);\r\nif (type & IRQ_TYPE_LEVEL_MASK)\r\nval &= ~confmask;\r\nelse if (type & IRQ_TYPE_EDGE_BOTH)\r\nval |= confmask;\r\nif (readl_relaxed(base + GIC_DIST_ENABLE_SET + enableoff) & enablemask) {\r\nwritel_relaxed(enablemask, base + GIC_DIST_ENABLE_CLEAR + enableoff);\r\nif (sync_access)\r\nsync_access();\r\nenabled = true;\r\n}\r\nwritel_relaxed(val, base + GIC_DIST_CONFIG + confoff);\r\nif (readl_relaxed(base + GIC_DIST_CONFIG + confoff) != val && val != oldval)\r\nret = -EINVAL;\r\nif (enabled)\r\nwritel_relaxed(enablemask, base + GIC_DIST_ENABLE_SET + enableoff);\r\nif (sync_access)\r\nsync_access();\r\nreturn ret;\r\n}\r\nvoid __init gic_dist_config(void __iomem *base, int gic_irqs,\r\nvoid (*sync_access)(void))\r\n{\r\nunsigned int i;\r\nfor (i = 32; i < gic_irqs; i += 16)\r\nwritel_relaxed(GICD_INT_ACTLOW_LVLTRIG,\r\nbase + GIC_DIST_CONFIG + i / 4);\r\nfor (i = 32; i < gic_irqs; i += 4)\r\nwritel_relaxed(GICD_INT_DEF_PRI_X4, base + GIC_DIST_PRI + i);\r\nfor (i = 32; i < gic_irqs; i += 32)\r\nwritel_relaxed(GICD_INT_EN_CLR_X32,\r\nbase + GIC_DIST_ENABLE_CLEAR + i / 8);\r\nif (sync_access)\r\nsync_access();\r\n}\r\nvoid gic_cpu_config(void __iomem *base, void (*sync_access)(void))\r\n{\r\nint i;\r\nwritel_relaxed(GICD_INT_EN_CLR_PPI, base + GIC_DIST_ENABLE_CLEAR);\r\nwritel_relaxed(GICD_INT_EN_SET_SGI, base + GIC_DIST_ENABLE_SET);\r\nfor (i = 0; i < 32; i += 4)\r\nwritel_relaxed(GICD_INT_DEF_PRI_X4,\r\nbase + GIC_DIST_PRI + i * 4 / 4);\r\nif (sync_access)\r\nsync_access();\r\n}

static int wm5110_sysclk_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nstruct regmap *regmap = arizona->regmap;\r\nconst struct reg_default *patch = NULL;\r\nint i, patch_size;\r\nswitch (arizona->rev) {\r\ncase 3:\r\npatch = wm5110_sysclk_revd_patch;\r\npatch_size = ARRAY_SIZE(wm5110_sysclk_revd_patch);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nif (patch)\r\nfor (i = 0; i < patch_size; i++)\r\nregmap_write_async(regmap, patch[i].reg,\r\npatch[i].def);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm5110_set_fll(struct snd_soc_codec *codec, int fll_id, int source,\r\nunsigned int Fref, unsigned int Fout)\r\n{\r\nstruct wm5110_priv *wm5110 = snd_soc_codec_get_drvdata(codec);\r\nswitch (fll_id) {\r\ncase WM5110_FLL1:\r\nreturn arizona_set_fll(&wm5110->fll[0], source, Fref, Fout);\r\ncase WM5110_FLL2:\r\nreturn arizona_set_fll(&wm5110->fll[1], source, Fref, Fout);\r\ncase WM5110_FLL1_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm5110->fll[0], source, Fref,\r\nFout);\r\ncase WM5110_FLL2_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm5110->fll[1], source, Fref,\r\nFout);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int wm5110_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct wm5110_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\npriv->core.arizona->dapm = &codec->dapm;\r\narizona_init_spk(codec);\r\narizona_init_gpio(codec);\r\narizona_init_mono(codec);\r\nret = snd_soc_add_codec_controls(codec, wm_adsp2_fw_controls, 8);\r\nif (ret != 0)\r\nreturn ret;\r\nsnd_soc_dapm_disable_pin(&codec->dapm, "HAPTICS");\r\npriv->core.arizona->dapm = &codec->dapm;\r\nreturn 0;\r\n}\r\nstatic int wm5110_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct wm5110_priv *priv = snd_soc_codec_get_drvdata(codec);\r\npriv->core.arizona->dapm = NULL;\r\nreturn 0;\r\n}\r\nstatic struct regmap *wm5110_get_regmap(struct device *dev)\r\n{\r\nstruct wm5110_priv *priv = dev_get_drvdata(dev);\r\nreturn priv->core.arizona->regmap;\r\n}\r\nstatic int wm5110_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm5110_priv *wm5110;\r\nint i, ret;\r\nwm5110 = devm_kzalloc(&pdev->dev, sizeof(struct wm5110_priv),\r\nGFP_KERNEL);\r\nif (wm5110 == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wm5110);\r\nwm5110->core.arizona = arizona;\r\nwm5110->core.num_inputs = 8;\r\nfor (i = 0; i < WM5110_NUM_ADSP; i++) {\r\nwm5110->core.adsp[i].part = "wm5110";\r\nwm5110->core.adsp[i].num = i + 1;\r\nwm5110->core.adsp[i].type = WMFW_ADSP2;\r\nwm5110->core.adsp[i].dev = arizona->dev;\r\nwm5110->core.adsp[i].regmap = arizona->regmap;\r\nwm5110->core.adsp[i].base = ARIZONA_DSP1_CONTROL_1\r\n+ (0x100 * i);\r\nwm5110->core.adsp[i].mem = wm5110_dsp_regions[i];\r\nwm5110->core.adsp[i].num_mems\r\n= ARRAY_SIZE(wm5110_dsp1_regions);\r\nret = wm_adsp2_init(&wm5110->core.adsp[i], false);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(wm5110->fll); i++)\r\nwm5110->fll[i].vco_mult = 3;\r\narizona_init_fll(arizona, 1, ARIZONA_FLL1_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL1_LOCK, ARIZONA_IRQ_FLL1_CLOCK_OK,\r\n&wm5110->fll[0]);\r\narizona_init_fll(arizona, 2, ARIZONA_FLL2_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL2_LOCK, ARIZONA_IRQ_FLL2_CLOCK_OK,\r\n&wm5110->fll[1]);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_2,\r\nARIZONA_SAMPLE_RATE_2_MASK, 0x11);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_3,\r\nARIZONA_SAMPLE_RATE_3_MASK, 0x12);\r\nfor (i = 0; i < ARRAY_SIZE(wm5110_dai); i++)\r\narizona_init_dai(&wm5110->core, i);\r\nfor (i = 0; i < ARRAY_SIZE(wm5110_digital_vu); i++)\r\nregmap_update_bits(arizona->regmap, wm5110_digital_vu[i],\r\nWM5110_DIG_VU, WM5110_DIG_VU);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_idle(&pdev->dev);\r\nreturn snd_soc_register_codec(&pdev->dev, &soc_codec_dev_wm5110,\r\nwm5110_dai, ARRAY_SIZE(wm5110_dai));\r\n}\r\nstatic int wm5110_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn 0;\r\n}

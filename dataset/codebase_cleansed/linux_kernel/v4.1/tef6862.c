static inline struct tef6862_state *to_state(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct tef6862_state, sd);\r\n}\r\nstatic u16 tef6862_sigstr(struct i2c_client *client)\r\n{\r\nu8 buf[4];\r\nint err = i2c_master_recv(client, buf, sizeof(buf));\r\nif (err == sizeof(buf))\r\nreturn buf[3] << 8;\r\nreturn 0;\r\n}\r\nstatic int tef6862_g_tuner(struct v4l2_subdev *sd, struct v4l2_tuner *v)\r\n{\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->type = V4L2_TUNER_RADIO;\r\nv->rangelow = TEF6862_LO_FREQ;\r\nv->rangehigh = TEF6862_HI_FREQ;\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nv->capability = V4L2_TUNER_CAP_LOW;\r\nv->audmode = V4L2_TUNER_MODE_STEREO;\r\nv->signal = tef6862_sigstr(v4l2_get_subdevdata(sd));\r\nreturn 0;\r\n}\r\nstatic int tef6862_s_tuner(struct v4l2_subdev *sd, const struct v4l2_tuner *v)\r\n{\r\nreturn v->index ? -EINVAL : 0;\r\n}\r\nstatic int tef6862_s_frequency(struct v4l2_subdev *sd, const struct v4l2_frequency *f)\r\n{\r\nstruct tef6862_state *state = to_state(sd);\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nunsigned freq = f->frequency;\r\nu16 pll;\r\nu8 i2cmsg[3];\r\nint err;\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nfreq = clamp(freq, TEF6862_LO_FREQ, TEF6862_HI_FREQ);\r\npll = 1964 + ((freq - TEF6862_LO_FREQ) * 20) / FREQ_MUL;\r\ni2cmsg[0] = (MSA_MODE_PRESET << MSA_MODE_SHIFT) | WM_SUB_PLLM;\r\ni2cmsg[1] = (pll >> 8) & 0xff;\r\ni2cmsg[2] = pll & 0xff;\r\nerr = i2c_master_send(client, i2cmsg, sizeof(i2cmsg));\r\nif (err != sizeof(i2cmsg))\r\nreturn err < 0 ? err : -EIO;\r\nstate->freq = freq;\r\nreturn 0;\r\n}\r\nstatic int tef6862_g_frequency(struct v4l2_subdev *sd, struct v4l2_frequency *f)\r\n{\r\nstruct tef6862_state *state = to_state(sd);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = state->freq;\r\nreturn 0;\r\n}\r\nstatic int tef6862_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tef6862_state *state;\r\nstruct v4l2_subdev *sd;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -EIO;\r\nv4l_info(client, "chip found @ 0x%02x (%s)\n",\r\nclient->addr << 1, client->adapter->name);\r\nstate = kzalloc(sizeof(struct tef6862_state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn -ENOMEM;\r\nstate->freq = TEF6862_LO_FREQ;\r\nsd = &state->sd;\r\nv4l2_i2c_subdev_init(sd, client, &tef6862_ops);\r\nreturn 0;\r\n}\r\nstatic int tef6862_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nv4l2_device_unregister_subdev(sd);\r\nkfree(to_state(sd));\r\nreturn 0;\r\n}

static void __zpci_event_error(struct zpci_ccdf_err *ccdf)\r\n{\r\nstruct zpci_dev *zdev = get_zdev_by_fid(ccdf->fid);\r\nzpci_err("error CCDF:\n");\r\nzpci_err_hex(ccdf, sizeof(*ccdf));\r\nif (!zdev)\r\nreturn;\r\npr_err("%s: Event 0x%x reports an error for PCI function 0x%x\n",\r\npci_name(zdev->pdev), ccdf->pec, ccdf->fid);\r\n}\r\nvoid zpci_event_error(void *data)\r\n{\r\nif (zpci_is_enabled())\r\n__zpci_event_error(data);\r\n}\r\nstatic void __zpci_event_availability(struct zpci_ccdf_avail *ccdf)\r\n{\r\nstruct zpci_dev *zdev = get_zdev_by_fid(ccdf->fid);\r\nstruct pci_dev *pdev = zdev ? zdev->pdev : NULL;\r\nint ret;\r\npr_info("%s: Event 0x%x reconfigured PCI function 0x%x\n",\r\npdev ? pci_name(pdev) : "n/a", ccdf->pec, ccdf->fid);\r\nzpci_err("avail CCDF:\n");\r\nzpci_err_hex(ccdf, sizeof(*ccdf));\r\nswitch (ccdf->pec) {\r\ncase 0x0301:\r\nif (!zdev || zdev->state != ZPCI_FN_STATE_STANDBY)\r\nbreak;\r\nzdev->state = ZPCI_FN_STATE_CONFIGURED;\r\nzdev->fh = ccdf->fh;\r\nret = zpci_enable_device(zdev);\r\nif (ret)\r\nbreak;\r\npci_rescan_bus(zdev->bus);\r\nbreak;\r\ncase 0x0302:\r\nif (!zdev)\r\nclp_add_pci_device(ccdf->fid, ccdf->fh, 0);\r\nbreak;\r\ncase 0x0303:\r\nif (pdev)\r\npci_stop_and_remove_bus_device(pdev);\r\nret = zpci_disable_device(zdev);\r\nif (ret)\r\nbreak;\r\nret = sclp_pci_deconfigure(zdev->fid);\r\nzpci_dbg(3, "deconf fid:%x, rc:%d\n", zdev->fid, ret);\r\nif (!ret)\r\nzdev->state = ZPCI_FN_STATE_STANDBY;\r\nbreak;\r\ncase 0x0304:\r\nif (pdev) {\r\npdev->error_state = pci_channel_io_perm_failure;\r\npci_stop_and_remove_bus_device(pdev);\r\n}\r\nzdev->fh = ccdf->fh;\r\nzpci_disable_device(zdev);\r\nzdev->state = ZPCI_FN_STATE_STANDBY;\r\nbreak;\r\ncase 0x0306:\r\nclp_rescan_pci_devices();\r\nbreak;\r\ncase 0x0308:\r\nif (!zdev)\r\nbreak;\r\npci_stop_root_bus(zdev->bus);\r\npci_remove_root_bus(zdev->bus);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid zpci_event_availability(void *data)\r\n{\r\nif (zpci_is_enabled())\r\n__zpci_event_availability(data);\r\n}

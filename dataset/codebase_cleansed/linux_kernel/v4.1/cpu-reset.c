int mvebu_cpu_reset_deassert(int cpu)\r\n{\r\nu32 reg;\r\nif (!cpu_reset_base)\r\nreturn -ENODEV;\r\nif (CPU_RESET_OFFSET(cpu) >= cpu_reset_size)\r\nreturn -EINVAL;\r\nreg = readl(cpu_reset_base + CPU_RESET_OFFSET(cpu));\r\nreg &= ~CPU_RESET_ASSERT;\r\nwritel(reg, cpu_reset_base + CPU_RESET_OFFSET(cpu));\r\nreturn 0;\r\n}\r\nstatic int mvebu_cpu_reset_map(struct device_node *np, int res_idx)\r\n{\r\nstruct resource res;\r\nif (of_address_to_resource(np, res_idx, &res)) {\r\npr_err("unable to get resource\n");\r\nreturn -ENOENT;\r\n}\r\nif (!request_mem_region(res.start, resource_size(&res),\r\nnp->full_name)) {\r\npr_err("unable to request region\n");\r\nreturn -EBUSY;\r\n}\r\ncpu_reset_base = ioremap(res.start, resource_size(&res));\r\nif (!cpu_reset_base) {\r\npr_err("unable to map registers\n");\r\nrelease_mem_region(res.start, resource_size(&res));\r\nreturn -ENOMEM;\r\n}\r\ncpu_reset_size = resource_size(&res);\r\nreturn 0;\r\n}\r\nstatic int __init mvebu_cpu_reset_init(void)\r\n{\r\nstruct device_node *np;\r\nint res_idx;\r\nint ret;\r\nnp = of_find_compatible_node(NULL, NULL,\r\n"marvell,armada-370-cpu-reset");\r\nif (np) {\r\nres_idx = 0;\r\n} else {\r\nnp = of_find_compatible_node(NULL, NULL,\r\n"marvell,armada-370-xp-pmsu");\r\nif (np) {\r\npr_warn(FW_WARN "deprecated pmsu binding\n");\r\nres_idx = 1;\r\n}\r\n}\r\nif (!np)\r\nreturn -ENODEV;\r\nret = mvebu_cpu_reset_map(np, res_idx);\r\nof_node_put(np);\r\nreturn ret;\r\n}

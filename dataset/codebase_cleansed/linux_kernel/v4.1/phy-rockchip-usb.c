static int rockchip_usb_phy_power(struct rockchip_usb_phy *phy,\r\nbool siddq)\r\n{\r\nreturn regmap_write(phy->reg_base, phy->reg_offset,\r\nSIDDQ_WRITE_ENA | (siddq ? SIDDQ_ON : SIDDQ_OFF));\r\n}\r\nstatic int rockchip_usb_phy_power_off(struct phy *_phy)\r\n{\r\nstruct rockchip_usb_phy *phy = phy_get_drvdata(_phy);\r\nint ret = 0;\r\nret = rockchip_usb_phy_power(phy, 1);\r\nif (ret)\r\nreturn ret;\r\nclk_disable_unprepare(phy->clk);\r\nreturn 0;\r\n}\r\nstatic int rockchip_usb_phy_power_on(struct phy *_phy)\r\n{\r\nstruct rockchip_usb_phy *phy = phy_get_drvdata(_phy);\r\nint ret = 0;\r\nret = clk_prepare_enable(phy->clk);\r\nif (ret)\r\nreturn ret;\r\nret = rockchip_usb_phy_power(phy, 0);\r\nif (ret) {\r\nclk_disable_unprepare(phy->clk);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rockchip_usb_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct rockchip_usb_phy *rk_phy;\r\nstruct phy_provider *phy_provider;\r\nstruct device_node *child;\r\nstruct regmap *grf;\r\nunsigned int reg_offset;\r\ngrf = syscon_regmap_lookup_by_phandle(dev->of_node, "rockchip,grf");\r\nif (IS_ERR(grf)) {\r\ndev_err(&pdev->dev, "Missing rockchip,grf property\n");\r\nreturn PTR_ERR(grf);\r\n}\r\nfor_each_available_child_of_node(dev->of_node, child) {\r\nrk_phy = devm_kzalloc(dev, sizeof(*rk_phy), GFP_KERNEL);\r\nif (!rk_phy)\r\nreturn -ENOMEM;\r\nif (of_property_read_u32(child, "reg", &reg_offset)) {\r\ndev_err(dev, "missing reg property in node %s\n",\r\nchild->name);\r\nreturn -EINVAL;\r\n}\r\nrk_phy->reg_offset = reg_offset;\r\nrk_phy->reg_base = grf;\r\nrk_phy->clk = of_clk_get_by_name(child, "phyclk");\r\nif (IS_ERR(rk_phy->clk))\r\nrk_phy->clk = NULL;\r\nrk_phy->phy = devm_phy_create(dev, child, &ops);\r\nif (IS_ERR(rk_phy->phy)) {\r\ndev_err(dev, "failed to create PHY\n");\r\nreturn PTR_ERR(rk_phy->phy);\r\n}\r\nphy_set_drvdata(rk_phy->phy, rk_phy);\r\n}\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

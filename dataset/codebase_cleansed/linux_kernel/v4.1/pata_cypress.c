static void cy82c693_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstruct ata_timing t;\r\nconst unsigned long T = 1000000 / 33;\r\nshort time_16, time_8;\r\nu32 addr;\r\nif (ata_timing_compute(adev, adev->pio_mode, &t, T, 1) < 0) {\r\nprintk(KERN_ERR DRV_NAME ": mome computation failed.\n");\r\nreturn;\r\n}\r\ntime_16 = clamp_val(t.recover - 1, 0, 15) |\r\n(clamp_val(t.active - 1, 0, 15) << 4);\r\ntime_8 = clamp_val(t.act8b - 1, 0, 15) |\r\n(clamp_val(t.rec8b - 1, 0, 15) << 4);\r\nif (adev->devno == 0) {\r\npci_read_config_dword(pdev, CY82_IDE_ADDRSETUP, &addr);\r\naddr &= ~0x0F;\r\naddr |= clamp_val(t.setup - 1, 0, 15);\r\npci_write_config_dword(pdev, CY82_IDE_ADDRSETUP, addr);\r\npci_write_config_byte(pdev, CY82_IDE_MASTER_IOR, time_16);\r\npci_write_config_byte(pdev, CY82_IDE_MASTER_IOW, time_16);\r\npci_write_config_byte(pdev, CY82_IDE_MASTER_8BIT, time_8);\r\n} else {\r\npci_read_config_dword(pdev, CY82_IDE_ADDRSETUP, &addr);\r\naddr &= ~0xF0;\r\naddr |= (clamp_val(t.setup - 1, 0, 15) << 4);\r\npci_write_config_dword(pdev, CY82_IDE_ADDRSETUP, addr);\r\npci_write_config_byte(pdev, CY82_IDE_SLAVE_IOR, time_16);\r\npci_write_config_byte(pdev, CY82_IDE_SLAVE_IOW, time_16);\r\npci_write_config_byte(pdev, CY82_IDE_SLAVE_8BIT, time_8);\r\n}\r\n}\r\nstatic void cy82c693_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nint reg = CY82_INDEX_CHANNEL0 + ap->port_no;\r\noutb(reg, 0x22);\r\noutb(adev->dma_mode - XFER_MW_DMA_0, 0x23);\r\noutb(CY82_INDEX_TIMEOUT, 0x22);\r\noutb(0x50, 0x23);\r\n}\r\nstatic int cy82c693_init_one(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.port_ops = &cy82c693_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, &ata_dummy_port_info };\r\nif (PCI_FUNC(pdev->devfn) != 1)\r\nreturn -ENODEV;\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &cy82c693_sht, NULL, 0);\r\n}

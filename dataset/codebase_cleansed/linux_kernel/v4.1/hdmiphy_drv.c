static inline struct hdmiphy_ctx *sd_to_ctx(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct hdmiphy_ctx, sd);\r\n}\r\nstatic const u8 *hdmiphy_find_conf(unsigned long pixclk,\r\nconst struct hdmiphy_conf *conf)\r\n{\r\nfor (; conf->pixclk; ++conf)\r\nif (conf->pixclk == pixclk)\r\nreturn conf->data;\r\nreturn NULL;\r\n}\r\nstatic int hdmiphy_s_power(struct v4l2_subdev *sd, int on)\r\n{\r\nreturn 0;\r\n}\r\nstatic int hdmiphy_s_dv_timings(struct v4l2_subdev *sd,\r\nstruct v4l2_dv_timings *timings)\r\n{\r\nconst u8 *data;\r\nu8 buffer[32];\r\nint ret;\r\nstruct hdmiphy_ctx *ctx = sd_to_ctx(sd);\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nstruct device *dev = &client->dev;\r\nunsigned long pixclk = timings->bt.pixelclock;\r\ndev_info(dev, "s_dv_timings\n");\r\nif ((timings->bt.flags & V4L2_DV_FL_REDUCED_FPS) && pixclk == 74250000)\r\npixclk = 74176000;\r\ndata = hdmiphy_find_conf(pixclk, ctx->conf_tab);\r\nif (!data) {\r\ndev_err(dev, "format not supported\n");\r\nreturn -EINVAL;\r\n}\r\nmemcpy(buffer, data, 32);\r\nret = i2c_master_send(client, buffer, 32);\r\nif (ret != 32) {\r\ndev_err(dev, "failed to configure HDMIPHY via I2C\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmiphy_dv_timings_cap(struct v4l2_subdev *sd,\r\nstruct v4l2_dv_timings_cap *cap)\r\n{\r\nif (cap->pad != 0)\r\nreturn -EINVAL;\r\ncap->type = V4L2_DV_BT_656_1120;\r\ncap->bt.min_pixelclock = 27000000;\r\ncap->bt.max_pixelclock = 148500000;\r\nreturn 0;\r\n}\r\nstatic int hdmiphy_s_stream(struct v4l2_subdev *sd, int enable)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nstruct device *dev = &client->dev;\r\nu8 buffer[2];\r\nint ret;\r\ndev_info(dev, "s_stream(%d)\n", enable);\r\nbuffer[0] = 0x1f;\r\nbuffer[1] = enable ? 0x80 : 0x00;\r\nret = i2c_master_send(client, buffer, 2);\r\nif (ret != 2) {\r\ndev_err(dev, "stream (%d) failed\n", enable);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmiphy_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct hdmiphy_ctx *ctx;\r\nctx = kzalloc(sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nctx->conf_tab = (struct hdmiphy_conf *)id->driver_data;\r\nv4l2_i2c_subdev_init(&ctx->sd, client, &hdmiphy_ops);\r\ndev_info(&client->dev, "probe successful\n");\r\nreturn 0;\r\n}\r\nstatic int hdmiphy_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nstruct hdmiphy_ctx *ctx = sd_to_ctx(sd);\r\nkfree(ctx);\r\ndev_info(&client->dev, "remove successful\n");\r\nreturn 0;\r\n}

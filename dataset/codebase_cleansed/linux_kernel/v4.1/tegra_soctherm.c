static int calculate_shared_calibration(struct tsensor_shared_calibration *r)\r\n{\r\nu32 val, shifted_cp, shifted_ft;\r\nint err;\r\nerr = tegra_fuse_readl(FUSE_TSENSOR8_CALIB, &val);\r\nif (err)\r\nreturn err;\r\nr->base_cp = val & FUSE_TSENSOR8_CALIB_CP_TS_BASE_MASK;\r\nr->base_ft = (val & FUSE_TSENSOR8_CALIB_FT_TS_BASE_MASK)\r\n>> FUSE_TSENSOR8_CALIB_FT_TS_BASE_SHIFT;\r\nval = ((val & FUSE_SPARE_REALIGNMENT_REG_SHIFT_FT_MASK)\r\n>> FUSE_SPARE_REALIGNMENT_REG_SHIFT_FT_SHIFT);\r\nshifted_ft = sign_extend32(val, 4);\r\nerr = tegra_fuse_readl(FUSE_SPARE_REALIGNMENT_REG_0, &val);\r\nif (err)\r\nreturn err;\r\nshifted_cp = sign_extend32(val, 5);\r\nr->actual_temp_cp = 2 * NOMINAL_CALIB_CP_T124 + shifted_cp;\r\nr->actual_temp_ft = 2 * NOMINAL_CALIB_FT_T124 + shifted_ft;\r\nreturn 0;\r\n}\r\nstatic s64 div64_s64_precise(s64 a, s64 b)\r\n{\r\ns64 r, al;\r\nal = a << 16;\r\nr = div64_s64(al * 2 + 1, 2 * b);\r\nreturn r >> 16;\r\n}\r\nstatic int\r\ncalculate_tsensor_calibration(const struct tegra_tsensor *sensor,\r\nconst struct tsensor_shared_calibration *shared,\r\nu32 *calib)\r\n{\r\nu32 val;\r\ns32 actual_tsensor_ft, actual_tsensor_cp, delta_sens, delta_temp,\r\nmult, div;\r\ns16 therma, thermb;\r\ns64 tmp;\r\nint err;\r\nerr = tegra_fuse_readl(sensor->calib_fuse_offset, &val);\r\nif (err)\r\nreturn err;\r\nactual_tsensor_cp = (shared->base_cp * 64) + sign_extend32(val, 12);\r\nval = (val & FUSE_TSENSOR_CALIB_FT_TS_BASE_MASK)\r\n>> FUSE_TSENSOR_CALIB_FT_TS_BASE_SHIFT;\r\nactual_tsensor_ft = (shared->base_ft * 32) + sign_extend32(val, 12);\r\ndelta_sens = actual_tsensor_ft - actual_tsensor_cp;\r\ndelta_temp = shared->actual_temp_ft - shared->actual_temp_cp;\r\nmult = sensor->config->pdiv * sensor->config->tsample_ate;\r\ndiv = sensor->config->tsample * sensor->config->pdiv_ate;\r\ntherma = div64_s64_precise((s64) delta_temp * (1LL << 13) * mult,\r\n(s64) delta_sens * div);\r\ntmp = (s64)actual_tsensor_ft * shared->actual_temp_cp -\r\n(s64)actual_tsensor_cp * shared->actual_temp_ft;\r\nthermb = div64_s64_precise(tmp, (s64)delta_sens);\r\ntherma = div64_s64_precise((s64)therma * sensor->fuse_corr_alpha,\r\n(s64)1000000LL);\r\nthermb = div64_s64_precise((s64)thermb * sensor->fuse_corr_alpha +\r\nsensor->fuse_corr_beta, (s64)1000000LL);\r\n*calib = ((u16)therma << SENSOR_CONFIG2_THERMA_SHIFT) |\r\n((u16)thermb << SENSOR_CONFIG2_THERMB_SHIFT);\r\nreturn 0;\r\n}\r\nstatic int enable_tsensor(struct tegra_soctherm *tegra,\r\nconst struct tegra_tsensor *sensor,\r\nconst struct tsensor_shared_calibration *shared)\r\n{\r\nvoid __iomem *base = tegra->regs + sensor->base;\r\nunsigned int val;\r\nu32 calib;\r\nint err;\r\nerr = calculate_tsensor_calibration(sensor, shared, &calib);\r\nif (err)\r\nreturn err;\r\nval = sensor->config->tall << SENSOR_CONFIG0_TALL_SHIFT;\r\nwritel(val, base + SENSOR_CONFIG0);\r\nval = (sensor->config->tsample - 1) << SENSOR_CONFIG1_TSAMPLE_SHIFT;\r\nval |= sensor->config->tiddq_en << SENSOR_CONFIG1_TIDDQ_EN_SHIFT;\r\nval |= sensor->config->ten_count << SENSOR_CONFIG1_TEN_COUNT_SHIFT;\r\nval |= SENSOR_CONFIG1_TEMP_ENABLE;\r\nwritel(val, base + SENSOR_CONFIG1);\r\nwritel(calib, base + SENSOR_CONFIG2);\r\nreturn 0;\r\n}\r\nstatic long translate_temp(u16 val)\r\n{\r\nlong t;\r\nt = ((val & READBACK_VALUE_MASK) >> READBACK_VALUE_SHIFT) * 1000;\r\nif (val & READBACK_ADD_HALF)\r\nt += 500;\r\nif (val & READBACK_NEGATE)\r\nt *= -1;\r\nreturn t;\r\n}\r\nstatic int tegra_thermctl_get_temp(void *data, long *out_temp)\r\n{\r\nstruct tegra_thermctl_zone *zone = data;\r\nu32 val;\r\nval = (readl(zone->reg) >> zone->shift) & SENSOR_TEMP_MASK;\r\n*out_temp = translate_temp(val);\r\nreturn 0;\r\n}\r\nstatic int tegra_soctherm_probe(struct platform_device *pdev)\r\n{\r\nstruct tegra_soctherm *tegra;\r\nstruct thermal_zone_device *tz;\r\nstruct tsensor_shared_calibration shared_calib;\r\nstruct resource *res;\r\nunsigned int i;\r\nint err;\r\nconst struct tegra_tsensor *tsensors = t124_tsensors;\r\ntegra = devm_kzalloc(&pdev->dev, sizeof(*tegra), GFP_KERNEL);\r\nif (!tegra)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ntegra->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(tegra->regs))\r\nreturn PTR_ERR(tegra->regs);\r\ntegra->reset = devm_reset_control_get(&pdev->dev, "soctherm");\r\nif (IS_ERR(tegra->reset)) {\r\ndev_err(&pdev->dev, "can't get soctherm reset\n");\r\nreturn PTR_ERR(tegra->reset);\r\n}\r\ntegra->clock_tsensor = devm_clk_get(&pdev->dev, "tsensor");\r\nif (IS_ERR(tegra->clock_tsensor)) {\r\ndev_err(&pdev->dev, "can't get tsensor clock\n");\r\nreturn PTR_ERR(tegra->clock_tsensor);\r\n}\r\ntegra->clock_soctherm = devm_clk_get(&pdev->dev, "soctherm");\r\nif (IS_ERR(tegra->clock_soctherm)) {\r\ndev_err(&pdev->dev, "can't get soctherm clock\n");\r\nreturn PTR_ERR(tegra->clock_soctherm);\r\n}\r\nreset_control_assert(tegra->reset);\r\nerr = clk_prepare_enable(tegra->clock_soctherm);\r\nif (err)\r\nreturn err;\r\nerr = clk_prepare_enable(tegra->clock_tsensor);\r\nif (err) {\r\nclk_disable_unprepare(tegra->clock_soctherm);\r\nreturn err;\r\n}\r\nreset_control_deassert(tegra->reset);\r\nerr = calculate_shared_calibration(&shared_calib);\r\nif (err)\r\ngoto disable_clocks;\r\nfor (i = 0; i < ARRAY_SIZE(t124_tsensors); ++i) {\r\nerr = enable_tsensor(tegra, tsensors + i, &shared_calib);\r\nif (err)\r\ngoto disable_clocks;\r\n}\r\nwritel(SENSOR_PDIV_T124, tegra->regs + SENSOR_PDIV);\r\nwritel(SENSOR_HOTSPOT_OFF_T124, tegra->regs + SENSOR_HOTSPOT_OFF);\r\nfor (i = 0; i < ARRAY_SIZE(tegra->thermctl_tzs); ++i) {\r\nstruct tegra_thermctl_zone *zone =\r\ndevm_kzalloc(&pdev->dev, sizeof(*zone), GFP_KERNEL);\r\nif (!zone) {\r\nerr = -ENOMEM;\r\ngoto unregister_tzs;\r\n}\r\nzone->reg = tegra->regs + t124_thermctl_temp_zones[i].offset;\r\nzone->shift = t124_thermctl_temp_zones[i].shift;\r\ntz = thermal_zone_of_sensor_register(&pdev->dev, i, zone,\r\n&tegra_of_thermal_ops);\r\nif (IS_ERR(tz)) {\r\nerr = PTR_ERR(tz);\r\ndev_err(&pdev->dev, "failed to register sensor: %d\n",\r\nerr);\r\ngoto unregister_tzs;\r\n}\r\ntegra->thermctl_tzs[i] = tz;\r\n}\r\nreturn 0;\r\nunregister_tzs:\r\nwhile (i--)\r\nthermal_zone_of_sensor_unregister(&pdev->dev,\r\ntegra->thermctl_tzs[i]);\r\ndisable_clocks:\r\nclk_disable_unprepare(tegra->clock_tsensor);\r\nclk_disable_unprepare(tegra->clock_soctherm);\r\nreturn err;\r\n}\r\nstatic int tegra_soctherm_remove(struct platform_device *pdev)\r\n{\r\nstruct tegra_soctherm *tegra = platform_get_drvdata(pdev);\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(tegra->thermctl_tzs); ++i) {\r\nthermal_zone_of_sensor_unregister(&pdev->dev,\r\ntegra->thermctl_tzs[i]);\r\n}\r\nclk_disable_unprepare(tegra->clock_tsensor);\r\nclk_disable_unprepare(tegra->clock_soctherm);\r\nreturn 0;\r\n}

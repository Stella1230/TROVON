static int systick_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nstruct systick_device *sdev;\r\nu32 count;\r\nsdev = container_of(evt, struct systick_device, dev);\r\ncount = ioread32(sdev->membase + SYSTICK_COUNT);\r\ncount = (count + delta) % SYSTICK_FREQ;\r\niowrite32(count + delta, sdev->membase + SYSTICK_COMPARE);\r\nreturn 0;\r\n}\r\nstatic void systick_event_handler(struct clock_event_device *dev)\r\n{\r\n}\r\nstatic irqreturn_t systick_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *dev = (struct clock_event_device *) dev_id;\r\ndev->event_handler(dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void systick_set_clock_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\nstruct systick_device *sdev;\r\nsdev = container_of(evt, struct systick_device, dev);\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nif (!sdev->irq_requested)\r\nsetup_irq(systick.dev.irq, &systick_irqaction);\r\nsdev->irq_requested = 1;\r\niowrite32(CFG_EXT_STK_EN | CFG_CNT_EN,\r\nsystick.membase + SYSTICK_CONFIG);\r\nbreak;\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\nif (sdev->irq_requested)\r\nfree_irq(systick.dev.irq, &systick_irqaction);\r\nsdev->irq_requested = 0;\r\niowrite32(0, systick.membase + SYSTICK_CONFIG);\r\nbreak;\r\ndefault:\r\npr_err("%s: Unhandeled mips clock_mode\n", systick.dev.name);\r\nbreak;\r\n}\r\n}\r\nstatic void __init ralink_systick_init(struct device_node *np)\r\n{\r\nsystick.membase = of_iomap(np, 0);\r\nif (!systick.membase)\r\nreturn;\r\nsystick_irqaction.name = np->name;\r\nsystick.dev.name = np->name;\r\nclockevents_calc_mult_shift(&systick.dev, SYSTICK_FREQ, 60);\r\nsystick.dev.max_delta_ns = clockevent_delta2ns(0x7fff, &systick.dev);\r\nsystick.dev.min_delta_ns = clockevent_delta2ns(0x3, &systick.dev);\r\nsystick.dev.irq = irq_of_parse_and_map(np, 0);\r\nif (!systick.dev.irq) {\r\npr_err("%s: request_irq failed", np->name);\r\nreturn;\r\n}\r\nclocksource_mmio_init(systick.membase + SYSTICK_COUNT, np->name,\r\nSYSTICK_FREQ, 301, 16, clocksource_mmio_readl_up);\r\nclockevents_register_device(&systick.dev);\r\npr_info("%s: running - mult: %d, shift: %d\n",\r\nnp->name, systick.dev.mult, systick.dev.shift);\r\n}

static void nmi_timer_callback(struct perf_event *event,\r\nstruct perf_sample_data *data,\r\nstruct pt_regs *regs)\r\n{\r\nevent->hw.interrupts = 0;\r\noprofile_add_sample(regs, 0);\r\n}\r\nstatic int nmi_timer_start_cpu(int cpu)\r\n{\r\nstruct perf_event *event = per_cpu(nmi_timer_events, cpu);\r\nif (!event) {\r\nevent = perf_event_create_kernel_counter(&nmi_timer_attr, cpu, NULL,\r\nnmi_timer_callback, NULL);\r\nif (IS_ERR(event))\r\nreturn PTR_ERR(event);\r\nper_cpu(nmi_timer_events, cpu) = event;\r\n}\r\nif (event && ctr_running)\r\nperf_event_enable(event);\r\nreturn 0;\r\n}\r\nstatic void nmi_timer_stop_cpu(int cpu)\r\n{\r\nstruct perf_event *event = per_cpu(nmi_timer_events, cpu);\r\nif (event && ctr_running)\r\nperf_event_disable(event);\r\n}\r\nstatic int nmi_timer_cpu_notifier(struct notifier_block *b, unsigned long action,\r\nvoid *data)\r\n{\r\nint cpu = (unsigned long)data;\r\nswitch (action) {\r\ncase CPU_DOWN_FAILED:\r\ncase CPU_ONLINE:\r\nnmi_timer_start_cpu(cpu);\r\nbreak;\r\ncase CPU_DOWN_PREPARE:\r\nnmi_timer_stop_cpu(cpu);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int nmi_timer_start(void)\r\n{\r\nint cpu;\r\nget_online_cpus();\r\nctr_running = 1;\r\nfor_each_online_cpu(cpu)\r\nnmi_timer_start_cpu(cpu);\r\nput_online_cpus();\r\nreturn 0;\r\n}\r\nstatic void nmi_timer_stop(void)\r\n{\r\nint cpu;\r\nget_online_cpus();\r\nfor_each_online_cpu(cpu)\r\nnmi_timer_stop_cpu(cpu);\r\nctr_running = 0;\r\nput_online_cpus();\r\n}\r\nstatic void nmi_timer_shutdown(void)\r\n{\r\nstruct perf_event *event;\r\nint cpu;\r\ncpu_notifier_register_begin();\r\n__unregister_cpu_notifier(&nmi_timer_cpu_nb);\r\nfor_each_possible_cpu(cpu) {\r\nevent = per_cpu(nmi_timer_events, cpu);\r\nif (!event)\r\ncontinue;\r\nperf_event_disable(event);\r\nper_cpu(nmi_timer_events, cpu) = NULL;\r\nperf_event_release_kernel(event);\r\n}\r\ncpu_notifier_register_done();\r\n}\r\nstatic int nmi_timer_setup(void)\r\n{\r\nint cpu, err;\r\nu64 period;\r\nperiod = (u64)cpu_khz * 1000;\r\ndo_div(period, HZ);\r\nnmi_timer_attr.sample_period = period;\r\ncpu_notifier_register_begin();\r\nerr = __register_cpu_notifier(&nmi_timer_cpu_nb);\r\nif (err)\r\ngoto out;\r\nfor_each_online_cpu(cpu) {\r\nerr = nmi_timer_start_cpu(cpu);\r\nif (err) {\r\ncpu_notifier_register_done();\r\nnmi_timer_shutdown();\r\nreturn err;\r\n}\r\n}\r\nout:\r\ncpu_notifier_register_done();\r\nreturn err;\r\n}\r\nint __init op_nmi_timer_init(struct oprofile_operations *ops)\r\n{\r\nint err = 0;\r\nerr = nmi_timer_setup();\r\nif (err)\r\nreturn err;\r\nnmi_timer_shutdown();\r\nops->create_files = NULL;\r\nops->setup = nmi_timer_setup;\r\nops->shutdown = nmi_timer_shutdown;\r\nops->start = nmi_timer_start;\r\nops->stop = nmi_timer_stop;\r\nops->cpu_type = "timer";\r\nprintk(KERN_INFO "oprofile: using NMI timer interrupt.\n");\r\nreturn 0;\r\n}

static u64 vp_get_features(struct virtio_device *vdev)\r\n{\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vdev);\r\nreturn ioread32(vp_dev->ioaddr + VIRTIO_PCI_HOST_FEATURES);\r\n}\r\nstatic int vp_finalize_features(struct virtio_device *vdev)\r\n{\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vdev);\r\nvring_transport_features(vdev);\r\nBUG_ON((u32)vdev->features != vdev->features);\r\niowrite32(vdev->features, vp_dev->ioaddr + VIRTIO_PCI_GUEST_FEATURES);\r\nreturn 0;\r\n}\r\nstatic void vp_get(struct virtio_device *vdev, unsigned offset,\r\nvoid *buf, unsigned len)\r\n{\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vdev);\r\nvoid __iomem *ioaddr = vp_dev->ioaddr +\r\nVIRTIO_PCI_CONFIG(vp_dev) + offset;\r\nu8 *ptr = buf;\r\nint i;\r\nfor (i = 0; i < len; i++)\r\nptr[i] = ioread8(ioaddr + i);\r\n}\r\nstatic void vp_set(struct virtio_device *vdev, unsigned offset,\r\nconst void *buf, unsigned len)\r\n{\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vdev);\r\nvoid __iomem *ioaddr = vp_dev->ioaddr +\r\nVIRTIO_PCI_CONFIG(vp_dev) + offset;\r\nconst u8 *ptr = buf;\r\nint i;\r\nfor (i = 0; i < len; i++)\r\niowrite8(ptr[i], ioaddr + i);\r\n}\r\nstatic u8 vp_get_status(struct virtio_device *vdev)\r\n{\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vdev);\r\nreturn ioread8(vp_dev->ioaddr + VIRTIO_PCI_STATUS);\r\n}\r\nstatic void vp_set_status(struct virtio_device *vdev, u8 status)\r\n{\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vdev);\r\nBUG_ON(status == 0);\r\niowrite8(status, vp_dev->ioaddr + VIRTIO_PCI_STATUS);\r\n}\r\nstatic void vp_reset(struct virtio_device *vdev)\r\n{\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vdev);\r\niowrite8(0, vp_dev->ioaddr + VIRTIO_PCI_STATUS);\r\nioread8(vp_dev->ioaddr + VIRTIO_PCI_STATUS);\r\nvp_synchronize_vectors(vdev);\r\n}\r\nstatic u16 vp_config_vector(struct virtio_pci_device *vp_dev, u16 vector)\r\n{\r\niowrite16(vector, vp_dev->ioaddr + VIRTIO_MSI_CONFIG_VECTOR);\r\nreturn ioread16(vp_dev->ioaddr + VIRTIO_MSI_CONFIG_VECTOR);\r\n}\r\nstatic struct virtqueue *setup_vq(struct virtio_pci_device *vp_dev,\r\nstruct virtio_pci_vq_info *info,\r\nunsigned index,\r\nvoid (*callback)(struct virtqueue *vq),\r\nconst char *name,\r\nu16 msix_vec)\r\n{\r\nstruct virtqueue *vq;\r\nunsigned long size;\r\nu16 num;\r\nint err;\r\niowrite16(index, vp_dev->ioaddr + VIRTIO_PCI_QUEUE_SEL);\r\nnum = ioread16(vp_dev->ioaddr + VIRTIO_PCI_QUEUE_NUM);\r\nif (!num || ioread32(vp_dev->ioaddr + VIRTIO_PCI_QUEUE_PFN))\r\nreturn ERR_PTR(-ENOENT);\r\ninfo->num = num;\r\ninfo->msix_vector = msix_vec;\r\nsize = PAGE_ALIGN(vring_size(num, VIRTIO_PCI_VRING_ALIGN));\r\ninfo->queue = alloc_pages_exact(size, GFP_KERNEL|__GFP_ZERO);\r\nif (info->queue == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\niowrite32(virt_to_phys(info->queue) >> VIRTIO_PCI_QUEUE_ADDR_SHIFT,\r\nvp_dev->ioaddr + VIRTIO_PCI_QUEUE_PFN);\r\nvq = vring_new_virtqueue(index, info->num,\r\nVIRTIO_PCI_VRING_ALIGN, &vp_dev->vdev,\r\ntrue, info->queue, vp_notify, callback, name);\r\nif (!vq) {\r\nerr = -ENOMEM;\r\ngoto out_activate_queue;\r\n}\r\nvq->priv = (void __force *)vp_dev->ioaddr + VIRTIO_PCI_QUEUE_NOTIFY;\r\nif (msix_vec != VIRTIO_MSI_NO_VECTOR) {\r\niowrite16(msix_vec, vp_dev->ioaddr + VIRTIO_MSI_QUEUE_VECTOR);\r\nmsix_vec = ioread16(vp_dev->ioaddr + VIRTIO_MSI_QUEUE_VECTOR);\r\nif (msix_vec == VIRTIO_MSI_NO_VECTOR) {\r\nerr = -EBUSY;\r\ngoto out_assign;\r\n}\r\n}\r\nreturn vq;\r\nout_assign:\r\nvring_del_virtqueue(vq);\r\nout_activate_queue:\r\niowrite32(0, vp_dev->ioaddr + VIRTIO_PCI_QUEUE_PFN);\r\nfree_pages_exact(info->queue, size);\r\nreturn ERR_PTR(err);\r\n}\r\nstatic void del_vq(struct virtio_pci_vq_info *info)\r\n{\r\nstruct virtqueue *vq = info->vq;\r\nstruct virtio_pci_device *vp_dev = to_vp_device(vq->vdev);\r\nunsigned long size;\r\niowrite16(vq->index, vp_dev->ioaddr + VIRTIO_PCI_QUEUE_SEL);\r\nif (vp_dev->msix_enabled) {\r\niowrite16(VIRTIO_MSI_NO_VECTOR,\r\nvp_dev->ioaddr + VIRTIO_MSI_QUEUE_VECTOR);\r\nioread8(vp_dev->ioaddr + VIRTIO_PCI_ISR);\r\n}\r\nvring_del_virtqueue(vq);\r\niowrite32(0, vp_dev->ioaddr + VIRTIO_PCI_QUEUE_PFN);\r\nsize = PAGE_ALIGN(vring_size(info->num, VIRTIO_PCI_VRING_ALIGN));\r\nfree_pages_exact(info->queue, size);\r\n}\r\nint virtio_pci_legacy_probe(struct virtio_pci_device *vp_dev)\r\n{\r\nstruct pci_dev *pci_dev = vp_dev->pci_dev;\r\nif (pci_dev->device < 0x1000 || pci_dev->device > 0x103f)\r\nreturn -ENODEV;\r\nif (pci_dev->revision != VIRTIO_PCI_ABI_VERSION) {\r\nprintk(KERN_ERR "virtio_pci: expected ABI version %d, got %d\n",\r\nVIRTIO_PCI_ABI_VERSION, pci_dev->revision);\r\nreturn -ENODEV;\r\n}\r\nvp_dev->ioaddr = pci_iomap(pci_dev, 0, 0);\r\nif (!vp_dev->ioaddr)\r\nreturn -ENOMEM;\r\nvp_dev->isr = vp_dev->ioaddr + VIRTIO_PCI_ISR;\r\nvp_dev->vdev.id.vendor = pci_dev->subsystem_vendor;\r\nvp_dev->vdev.id.device = pci_dev->subsystem_device;\r\nvp_dev->vdev.config = &virtio_pci_config_ops;\r\nvp_dev->config_vector = vp_config_vector;\r\nvp_dev->setup_vq = setup_vq;\r\nvp_dev->del_vq = del_vq;\r\nreturn 0;\r\n}\r\nvoid virtio_pci_legacy_remove(struct virtio_pci_device *vp_dev)\r\n{\r\nstruct pci_dev *pci_dev = vp_dev->pci_dev;\r\npci_iounmap(pci_dev, vp_dev->ioaddr);\r\n}

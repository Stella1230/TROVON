static int adc_enable_delay_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nmsleep(200);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void enable_and_reset_codec(struct regmap *regmap,\r\nu32 codec_enable_bits, u32 codec_reset_bits)\r\n{\r\nregmap_update_bits(regmap, AUDIO_IC_CODEC_CTRL1,\r\ncodec_enable_bits | codec_reset_bits,\r\ncodec_enable_bits);\r\nmsleep(20);\r\nregmap_update_bits(regmap, AUDIO_IC_CODEC_CTRL1,\r\ncodec_reset_bits, codec_reset_bits);\r\n}\r\nstatic int atlas6_codec_enable_and_reset_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\n#define ATLAS6_CODEC_ENABLE_BITS (1 << 29)\r\n#define ATLAS6_CODEC_RESET_BITS (1 << 28)\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct sirf_audio_codec *sirf_audio_codec = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nenable_and_reset_codec(sirf_audio_codec->regmap,\r\nATLAS6_CODEC_ENABLE_BITS, ATLAS6_CODEC_RESET_BITS);\r\nbreak;\r\ncase SND_SOC_DAPM_POST_PMD:\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_IC_CODEC_CTRL1, ATLAS6_CODEC_ENABLE_BITS, 0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int prima2_codec_enable_and_reset_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\n#define PRIMA2_CODEC_ENABLE_BITS (1 << 27)\r\n#define PRIMA2_CODEC_RESET_BITS (1 << 26)\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct sirf_audio_codec *sirf_audio_codec = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nenable_and_reset_codec(sirf_audio_codec->regmap,\r\nPRIMA2_CODEC_ENABLE_BITS, PRIMA2_CODEC_RESET_BITS);\r\nbreak;\r\ncase SND_SOC_DAPM_POST_PMD:\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_IC_CODEC_CTRL1, PRIMA2_CODEC_ENABLE_BITS, 0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void sirf_audio_codec_tx_enable(struct sirf_audio_codec *sirf_audio_codec)\r\n{\r\nregmap_update_bits(sirf_audio_codec->regmap, AUDIO_PORT_IC_TXFIFO_OP,\r\nAUDIO_FIFO_RESET, AUDIO_FIFO_RESET);\r\nregmap_update_bits(sirf_audio_codec->regmap, AUDIO_PORT_IC_TXFIFO_OP,\r\nAUDIO_FIFO_RESET, ~AUDIO_FIFO_RESET);\r\nregmap_write(sirf_audio_codec->regmap, AUDIO_PORT_IC_TXFIFO_INT_MSK, 0);\r\nregmap_write(sirf_audio_codec->regmap, AUDIO_PORT_IC_TXFIFO_OP, 0);\r\nregmap_update_bits(sirf_audio_codec->regmap, AUDIO_PORT_IC_TXFIFO_OP,\r\nAUDIO_FIFO_START, AUDIO_FIFO_START);\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_PORT_IC_CODEC_TX_CTRL, IC_TX_ENABLE, IC_TX_ENABLE);\r\n}\r\nstatic void sirf_audio_codec_tx_disable(struct sirf_audio_codec *sirf_audio_codec)\r\n{\r\nregmap_write(sirf_audio_codec->regmap, AUDIO_PORT_IC_TXFIFO_OP, 0);\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_PORT_IC_CODEC_TX_CTRL, IC_TX_ENABLE, ~IC_TX_ENABLE);\r\n}\r\nstatic void sirf_audio_codec_rx_enable(struct sirf_audio_codec *sirf_audio_codec,\r\nint channels)\r\n{\r\nregmap_update_bits(sirf_audio_codec->regmap, AUDIO_PORT_IC_RXFIFO_OP,\r\nAUDIO_FIFO_RESET, AUDIO_FIFO_RESET);\r\nregmap_update_bits(sirf_audio_codec->regmap, AUDIO_PORT_IC_RXFIFO_OP,\r\nAUDIO_FIFO_RESET, ~AUDIO_FIFO_RESET);\r\nregmap_write(sirf_audio_codec->regmap,\r\nAUDIO_PORT_IC_RXFIFO_INT_MSK, 0);\r\nregmap_write(sirf_audio_codec->regmap, AUDIO_PORT_IC_RXFIFO_OP, 0);\r\nregmap_update_bits(sirf_audio_codec->regmap, AUDIO_PORT_IC_RXFIFO_OP,\r\nAUDIO_FIFO_START, AUDIO_FIFO_START);\r\nif (channels == 1)\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_PORT_IC_CODEC_RX_CTRL,\r\nIC_RX_ENABLE_MONO, IC_RX_ENABLE_MONO);\r\nelse\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_PORT_IC_CODEC_RX_CTRL,\r\nIC_RX_ENABLE_STEREO, IC_RX_ENABLE_STEREO);\r\n}\r\nstatic void sirf_audio_codec_rx_disable(struct sirf_audio_codec *sirf_audio_codec)\r\n{\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_PORT_IC_CODEC_RX_CTRL,\r\nIC_RX_ENABLE_STEREO, ~IC_RX_ENABLE_STEREO);\r\n}\r\nstatic int sirf_audio_codec_trigger(struct snd_pcm_substream *substream,\r\nint cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct sirf_audio_codec *sirf_audio_codec = snd_soc_codec_get_drvdata(codec);\r\nint playback = substream->stream == SNDRV_PCM_STREAM_PLAYBACK;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nif (playback) {\r\nsnd_soc_update_bits(codec, AUDIO_IC_CODEC_CTRL0,\r\nIC_HSLEN | IC_HSREN, 0);\r\nsirf_audio_codec_tx_disable(sirf_audio_codec);\r\n} else\r\nsirf_audio_codec_rx_disable(sirf_audio_codec);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nif (playback) {\r\nsirf_audio_codec_tx_enable(sirf_audio_codec);\r\nsnd_soc_update_bits(codec, AUDIO_IC_CODEC_CTRL0,\r\nIC_HSLEN | IC_HSREN, IC_HSLEN | IC_HSREN);\r\n} else\r\nsirf_audio_codec_rx_enable(sirf_audio_codec,\r\nsubstream->runtime->channels);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sirf_audio_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\npm_runtime_enable(codec->dev);\r\nif (of_device_is_compatible(codec->dev->of_node, "sirf,prima2-audio-codec")) {\r\nsnd_soc_dapm_new_controls(dapm,\r\nprima2_output_driver_dapm_widgets,\r\nARRAY_SIZE(prima2_output_driver_dapm_widgets));\r\nsnd_soc_dapm_new_controls(dapm,\r\n&prima2_codec_clock_dapm_widget, 1);\r\nreturn snd_soc_add_codec_controls(codec,\r\nvolume_controls_prima2,\r\nARRAY_SIZE(volume_controls_prima2));\r\n}\r\nif (of_device_is_compatible(codec->dev->of_node, "sirf,atlas6-audio-codec")) {\r\nsnd_soc_dapm_new_controls(dapm,\r\natlas6_output_driver_dapm_widgets,\r\nARRAY_SIZE(atlas6_output_driver_dapm_widgets));\r\nsnd_soc_dapm_new_controls(dapm,\r\n&atlas6_codec_clock_dapm_widget, 1);\r\nreturn snd_soc_add_codec_controls(codec,\r\nvolume_controls_atlas6,\r\nARRAY_SIZE(volume_controls_atlas6));\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int sirf_audio_codec_remove(struct snd_soc_codec *codec)\r\n{\r\npm_runtime_disable(codec->dev);\r\nreturn 0;\r\n}\r\nstatic int sirf_audio_codec_driver_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct sirf_audio_codec *sirf_audio_codec;\r\nvoid __iomem *base;\r\nstruct resource *mem_res;\r\nconst struct of_device_id *match;\r\nmatch = of_match_node(sirf_audio_codec_of_match, pdev->dev.of_node);\r\nsirf_audio_codec = devm_kzalloc(&pdev->dev,\r\nsizeof(struct sirf_audio_codec), GFP_KERNEL);\r\nif (!sirf_audio_codec)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, sirf_audio_codec);\r\nmem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, mem_res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nsirf_audio_codec->regmap = devm_regmap_init_mmio(&pdev->dev, base,\r\n&sirf_audio_codec_regmap_config);\r\nif (IS_ERR(sirf_audio_codec->regmap))\r\nreturn PTR_ERR(sirf_audio_codec->regmap);\r\nsirf_audio_codec->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sirf_audio_codec->clk)) {\r\ndev_err(&pdev->dev, "Get clock failed.\n");\r\nreturn PTR_ERR(sirf_audio_codec->clk);\r\n}\r\nret = clk_prepare_enable(sirf_audio_codec->clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Enable clock failed.\n");\r\nreturn ret;\r\n}\r\nret = snd_soc_register_codec(&(pdev->dev),\r\n&soc_codec_device_sirf_audio_codec,\r\n&sirf_audio_codec_dai, 1);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Register Audio Codec dai failed.\n");\r\ngoto err_clk_put;\r\n}\r\nregmap_update_bits(sirf_audio_codec->regmap, AUDIO_IC_CODEC_CTRL0,\r\nIC_CPFREQ, IC_CPFREQ);\r\nif (of_device_is_compatible(pdev->dev.of_node, "sirf,atlas6-audio-codec"))\r\nregmap_update_bits(sirf_audio_codec->regmap,\r\nAUDIO_IC_CODEC_CTRL0, IC_CPEN, IC_CPEN);\r\nreturn 0;\r\nerr_clk_put:\r\nclk_disable_unprepare(sirf_audio_codec->clk);\r\nreturn ret;\r\n}\r\nstatic int sirf_audio_codec_driver_remove(struct platform_device *pdev)\r\n{\r\nstruct sirf_audio_codec *sirf_audio_codec = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(sirf_audio_codec->clk);\r\nsnd_soc_unregister_codec(&(pdev->dev));\r\nreturn 0;\r\n}\r\nstatic int sirf_audio_codec_suspend(struct device *dev)\r\n{\r\nstruct sirf_audio_codec *sirf_audio_codec = dev_get_drvdata(dev);\r\nregmap_read(sirf_audio_codec->regmap, AUDIO_IC_CODEC_CTRL0,\r\n&sirf_audio_codec->reg_ctrl0);\r\nregmap_read(sirf_audio_codec->regmap, AUDIO_IC_CODEC_CTRL1,\r\n&sirf_audio_codec->reg_ctrl1);\r\nclk_disable_unprepare(sirf_audio_codec->clk);\r\nreturn 0;\r\n}\r\nstatic int sirf_audio_codec_resume(struct device *dev)\r\n{\r\nstruct sirf_audio_codec *sirf_audio_codec = dev_get_drvdata(dev);\r\nint ret;\r\nret = clk_prepare_enable(sirf_audio_codec->clk);\r\nif (ret)\r\nreturn ret;\r\nregmap_write(sirf_audio_codec->regmap, AUDIO_IC_CODEC_CTRL0,\r\nsirf_audio_codec->reg_ctrl0);\r\nregmap_write(sirf_audio_codec->regmap, AUDIO_IC_CODEC_CTRL1,\r\nsirf_audio_codec->reg_ctrl1);\r\nreturn 0;\r\n}

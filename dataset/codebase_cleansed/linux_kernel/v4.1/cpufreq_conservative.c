static inline unsigned int get_freq_target(struct cs_dbs_tuners *cs_tuners,\r\nstruct cpufreq_policy *policy)\r\n{\r\nunsigned int freq_target = (cs_tuners->freq_step * policy->max) / 100;\r\nif (unlikely(freq_target == 0))\r\nfreq_target = DEF_FREQUENCY_STEP;\r\nreturn freq_target;\r\n}\r\nstatic void cs_check_cpu(int cpu, unsigned int load)\r\n{\r\nstruct cs_cpu_dbs_info_s *dbs_info = &per_cpu(cs_cpu_dbs_info, cpu);\r\nstruct cpufreq_policy *policy = dbs_info->cdbs.cur_policy;\r\nstruct dbs_data *dbs_data = policy->governor_data;\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nif (cs_tuners->freq_step == 0)\r\nreturn;\r\nif (load > cs_tuners->up_threshold) {\r\ndbs_info->down_skip = 0;\r\nif (dbs_info->requested_freq == policy->max)\r\nreturn;\r\ndbs_info->requested_freq += get_freq_target(cs_tuners, policy);\r\nif (dbs_info->requested_freq > policy->max)\r\ndbs_info->requested_freq = policy->max;\r\n__cpufreq_driver_target(policy, dbs_info->requested_freq,\r\nCPUFREQ_RELATION_H);\r\nreturn;\r\n}\r\nif (++dbs_info->down_skip < cs_tuners->sampling_down_factor)\r\nreturn;\r\ndbs_info->down_skip = 0;\r\nif (load < cs_tuners->down_threshold) {\r\nunsigned int freq_target;\r\nif (policy->cur == policy->min)\r\nreturn;\r\nfreq_target = get_freq_target(cs_tuners, policy);\r\nif (dbs_info->requested_freq > freq_target)\r\ndbs_info->requested_freq -= freq_target;\r\nelse\r\ndbs_info->requested_freq = policy->min;\r\n__cpufreq_driver_target(policy, dbs_info->requested_freq,\r\nCPUFREQ_RELATION_L);\r\nreturn;\r\n}\r\n}\r\nstatic void cs_dbs_timer(struct work_struct *work)\r\n{\r\nstruct cs_cpu_dbs_info_s *dbs_info = container_of(work,\r\nstruct cs_cpu_dbs_info_s, cdbs.work.work);\r\nunsigned int cpu = dbs_info->cdbs.cur_policy->cpu;\r\nstruct cs_cpu_dbs_info_s *core_dbs_info = &per_cpu(cs_cpu_dbs_info,\r\ncpu);\r\nstruct dbs_data *dbs_data = dbs_info->cdbs.cur_policy->governor_data;\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nint delay = delay_for_sampling_rate(cs_tuners->sampling_rate);\r\nbool modify_all = true;\r\nmutex_lock(&core_dbs_info->cdbs.timer_mutex);\r\nif (!need_load_eval(&core_dbs_info->cdbs, cs_tuners->sampling_rate))\r\nmodify_all = false;\r\nelse\r\ndbs_check_cpu(dbs_data, cpu);\r\ngov_queue_work(dbs_data, dbs_info->cdbs.cur_policy, delay, modify_all);\r\nmutex_unlock(&core_dbs_info->cdbs.timer_mutex);\r\n}\r\nstatic int dbs_cpufreq_notifier(struct notifier_block *nb, unsigned long val,\r\nvoid *data)\r\n{\r\nstruct cpufreq_freqs *freq = data;\r\nstruct cs_cpu_dbs_info_s *dbs_info =\r\n&per_cpu(cs_cpu_dbs_info, freq->cpu);\r\nstruct cpufreq_policy *policy;\r\nif (!dbs_info->enable)\r\nreturn 0;\r\npolicy = dbs_info->cdbs.cur_policy;\r\nif (dbs_info->requested_freq > policy->max\r\n|| dbs_info->requested_freq < policy->min)\r\ndbs_info->requested_freq = freq->new;\r\nreturn 0;\r\n}\r\nstatic ssize_t store_sampling_down_factor(struct dbs_data *dbs_data,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1 || input > MAX_SAMPLING_DOWN_FACTOR || input < 1)\r\nreturn -EINVAL;\r\ncs_tuners->sampling_down_factor = input;\r\nreturn count;\r\n}\r\nstatic ssize_t store_sampling_rate(struct dbs_data *dbs_data, const char *buf,\r\nsize_t count)\r\n{\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1)\r\nreturn -EINVAL;\r\ncs_tuners->sampling_rate = max(input, dbs_data->min_sampling_rate);\r\nreturn count;\r\n}\r\nstatic ssize_t store_up_threshold(struct dbs_data *dbs_data, const char *buf,\r\nsize_t count)\r\n{\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1 || input > 100 || input <= cs_tuners->down_threshold)\r\nreturn -EINVAL;\r\ncs_tuners->up_threshold = input;\r\nreturn count;\r\n}\r\nstatic ssize_t store_down_threshold(struct dbs_data *dbs_data, const char *buf,\r\nsize_t count)\r\n{\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1 || input < 11 || input > 100 ||\r\ninput >= cs_tuners->up_threshold)\r\nreturn -EINVAL;\r\ncs_tuners->down_threshold = input;\r\nreturn count;\r\n}\r\nstatic ssize_t store_ignore_nice_load(struct dbs_data *dbs_data,\r\nconst char *buf, size_t count)\r\n{\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input, j;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1)\r\nreturn -EINVAL;\r\nif (input > 1)\r\ninput = 1;\r\nif (input == cs_tuners->ignore_nice_load)\r\nreturn count;\r\ncs_tuners->ignore_nice_load = input;\r\nfor_each_online_cpu(j) {\r\nstruct cs_cpu_dbs_info_s *dbs_info;\r\ndbs_info = &per_cpu(cs_cpu_dbs_info, j);\r\ndbs_info->cdbs.prev_cpu_idle = get_cpu_idle_time(j,\r\n&dbs_info->cdbs.prev_cpu_wall, 0);\r\nif (cs_tuners->ignore_nice_load)\r\ndbs_info->cdbs.prev_cpu_nice =\r\nkcpustat_cpu(j).cpustat[CPUTIME_NICE];\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t store_freq_step(struct dbs_data *dbs_data, const char *buf,\r\nsize_t count)\r\n{\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1)\r\nreturn -EINVAL;\r\nif (input > 100)\r\ninput = 100;\r\ncs_tuners->freq_step = input;\r\nreturn count;\r\n}\r\nstatic int cs_init(struct dbs_data *dbs_data)\r\n{\r\nstruct cs_dbs_tuners *tuners;\r\ntuners = kzalloc(sizeof(*tuners), GFP_KERNEL);\r\nif (!tuners) {\r\npr_err("%s: kzalloc failed\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\ntuners->up_threshold = DEF_FREQUENCY_UP_THRESHOLD;\r\ntuners->down_threshold = DEF_FREQUENCY_DOWN_THRESHOLD;\r\ntuners->sampling_down_factor = DEF_SAMPLING_DOWN_FACTOR;\r\ntuners->ignore_nice_load = 0;\r\ntuners->freq_step = DEF_FREQUENCY_STEP;\r\ndbs_data->tuners = tuners;\r\ndbs_data->min_sampling_rate = MIN_SAMPLING_RATE_RATIO *\r\njiffies_to_usecs(10);\r\nmutex_init(&dbs_data->mutex);\r\nreturn 0;\r\n}\r\nstatic void cs_exit(struct dbs_data *dbs_data)\r\n{\r\nkfree(dbs_data->tuners);\r\n}\r\nstatic int cs_cpufreq_governor_dbs(struct cpufreq_policy *policy,\r\nunsigned int event)\r\n{\r\nreturn cpufreq_governor_dbs(policy, &cs_dbs_cdata, event);\r\n}\r\nstatic int __init cpufreq_gov_dbs_init(void)\r\n{\r\nreturn cpufreq_register_governor(&cpufreq_gov_conservative);\r\n}\r\nstatic void __exit cpufreq_gov_dbs_exit(void)\r\n{\r\ncpufreq_unregister_governor(&cpufreq_gov_conservative);\r\n}

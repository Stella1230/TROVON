static int spear13xx_pcie_establish_link(struct pcie_port *pp)\r\n{\r\nu32 val;\r\nint count = 0;\r\nstruct spear13xx_pcie *spear13xx_pcie = to_spear13xx_pcie(pp);\r\nstruct pcie_app_reg *app_reg = spear13xx_pcie->app_base;\r\nu32 exp_cap_off = EXP_CAP_ID_OFFSET;\r\nif (dw_pcie_link_up(pp)) {\r\ndev_err(pp->dev, "link already up\n");\r\nreturn 0;\r\n}\r\ndw_pcie_setup_rc(pp);\r\ndw_pcie_cfg_read(pp->dbi_base, exp_cap_off + PCI_EXP_DEVCTL, 4, &val);\r\nval &= ~PCI_EXP_DEVCTL_READRQ;\r\ndw_pcie_cfg_write(pp->dbi_base, exp_cap_off + PCI_EXP_DEVCTL, 4, val);\r\ndw_pcie_cfg_write(pp->dbi_base, PCI_VENDOR_ID, 2, 0x104A);\r\ndw_pcie_cfg_write(pp->dbi_base, PCI_DEVICE_ID, 2, 0xCD80);\r\nif (spear13xx_pcie->is_gen1) {\r\ndw_pcie_cfg_read(pp->dbi_base, exp_cap_off + PCI_EXP_LNKCAP, 4,\r\n&val);\r\nif ((val & PCI_EXP_LNKCAP_SLS) != PCI_EXP_LNKCAP_SLS_2_5GB) {\r\nval &= ~((u32)PCI_EXP_LNKCAP_SLS);\r\nval |= PCI_EXP_LNKCAP_SLS_2_5GB;\r\ndw_pcie_cfg_write(pp->dbi_base, exp_cap_off +\r\nPCI_EXP_LNKCAP, 4, val);\r\n}\r\ndw_pcie_cfg_read(pp->dbi_base, exp_cap_off + PCI_EXP_LNKCTL2, 4,\r\n&val);\r\nif ((val & PCI_EXP_LNKCAP_SLS) != PCI_EXP_LNKCAP_SLS_2_5GB) {\r\nval &= ~((u32)PCI_EXP_LNKCAP_SLS);\r\nval |= PCI_EXP_LNKCAP_SLS_2_5GB;\r\ndw_pcie_cfg_write(pp->dbi_base, exp_cap_off +\r\nPCI_EXP_LNKCTL2, 4, val);\r\n}\r\n}\r\nwritel(DEVICE_TYPE_RC | (1 << MISCTRL_EN_ID)\r\n| (1 << APP_LTSSM_ENABLE_ID)\r\n| ((u32)1 << REG_TRANSLATION_ENABLE),\r\n&app_reg->app_ctrl_0);\r\nwhile (!dw_pcie_link_up(pp)) {\r\nmdelay(100);\r\ncount++;\r\nif (count == 10) {\r\ndev_err(pp->dev, "link Fail\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\ndev_info(pp->dev, "link up\n");\r\nreturn 0;\r\n}\r\nstatic irqreturn_t spear13xx_pcie_irq_handler(int irq, void *arg)\r\n{\r\nstruct pcie_port *pp = arg;\r\nstruct spear13xx_pcie *spear13xx_pcie = to_spear13xx_pcie(pp);\r\nstruct pcie_app_reg *app_reg = spear13xx_pcie->app_base;\r\nunsigned int status;\r\nstatus = readl(&app_reg->int_sts);\r\nif (status & MSI_CTRL_INT) {\r\nif (!IS_ENABLED(CONFIG_PCI_MSI))\r\nBUG();\r\ndw_handle_msi_irq(pp);\r\n}\r\nwritel(status, &app_reg->int_clr);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void spear13xx_pcie_enable_interrupts(struct pcie_port *pp)\r\n{\r\nstruct spear13xx_pcie *spear13xx_pcie = to_spear13xx_pcie(pp);\r\nstruct pcie_app_reg *app_reg = spear13xx_pcie->app_base;\r\nif (IS_ENABLED(CONFIG_PCI_MSI)) {\r\ndw_pcie_msi_init(pp);\r\nwritel(readl(&app_reg->int_mask) |\r\nMSI_CTRL_INT, &app_reg->int_mask);\r\n}\r\n}\r\nstatic int spear13xx_pcie_link_up(struct pcie_port *pp)\r\n{\r\nstruct spear13xx_pcie *spear13xx_pcie = to_spear13xx_pcie(pp);\r\nstruct pcie_app_reg *app_reg = spear13xx_pcie->app_base;\r\nif (readl(&app_reg->app_status_1) & XMLH_LINK_UP)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void spear13xx_pcie_host_init(struct pcie_port *pp)\r\n{\r\nspear13xx_pcie_establish_link(pp);\r\nspear13xx_pcie_enable_interrupts(pp);\r\n}\r\nstatic int spear13xx_add_pcie_port(struct pcie_port *pp,\r\nstruct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nint ret;\r\npp->irq = platform_get_irq(pdev, 0);\r\nif (!pp->irq) {\r\ndev_err(dev, "failed to get irq\n");\r\nreturn -ENODEV;\r\n}\r\nret = devm_request_irq(dev, pp->irq, spear13xx_pcie_irq_handler,\r\nIRQF_SHARED, "spear1340-pcie", pp);\r\nif (ret) {\r\ndev_err(dev, "failed to request irq %d\n", pp->irq);\r\nreturn ret;\r\n}\r\npp->root_bus_nr = -1;\r\npp->ops = &spear13xx_pcie_host_ops;\r\nret = dw_pcie_host_init(pp);\r\nif (ret) {\r\ndev_err(dev, "failed to initialize host\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int spear13xx_pcie_probe(struct platform_device *pdev)\r\n{\r\nstruct spear13xx_pcie *spear13xx_pcie;\r\nstruct pcie_port *pp;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct resource *dbi_base;\r\nint ret;\r\nspear13xx_pcie = devm_kzalloc(dev, sizeof(*spear13xx_pcie), GFP_KERNEL);\r\nif (!spear13xx_pcie)\r\nreturn -ENOMEM;\r\nspear13xx_pcie->phy = devm_phy_get(dev, "pcie-phy");\r\nif (IS_ERR(spear13xx_pcie->phy)) {\r\nret = PTR_ERR(spear13xx_pcie->phy);\r\nif (ret == -EPROBE_DEFER)\r\ndev_info(dev, "probe deferred\n");\r\nelse\r\ndev_err(dev, "couldn't get pcie-phy\n");\r\nreturn ret;\r\n}\r\nphy_init(spear13xx_pcie->phy);\r\nspear13xx_pcie->clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(spear13xx_pcie->clk)) {\r\ndev_err(dev, "couldn't get clk for pcie\n");\r\nreturn PTR_ERR(spear13xx_pcie->clk);\r\n}\r\nret = clk_prepare_enable(spear13xx_pcie->clk);\r\nif (ret) {\r\ndev_err(dev, "couldn't enable clk for pcie\n");\r\nreturn ret;\r\n}\r\npp = &spear13xx_pcie->pp;\r\npp->dev = dev;\r\ndbi_base = platform_get_resource_byname(pdev, IORESOURCE_MEM, "dbi");\r\npp->dbi_base = devm_ioremap_resource(dev, dbi_base);\r\nif (IS_ERR(pp->dbi_base)) {\r\ndev_err(dev, "couldn't remap dbi base %p\n", dbi_base);\r\nret = PTR_ERR(pp->dbi_base);\r\ngoto fail_clk;\r\n}\r\nspear13xx_pcie->app_base = pp->dbi_base + 0x2000;\r\nif (of_property_read_bool(np, "st,pcie-is-gen1"))\r\nspear13xx_pcie->is_gen1 = true;\r\nret = spear13xx_add_pcie_port(pp, pdev);\r\nif (ret < 0)\r\ngoto fail_clk;\r\nplatform_set_drvdata(pdev, spear13xx_pcie);\r\nreturn 0;\r\nfail_clk:\r\nclk_disable_unprepare(spear13xx_pcie->clk);\r\nreturn ret;\r\n}\r\nstatic int __init spear13xx_pcie_init(void)\r\n{\r\nreturn platform_driver_register(&spear13xx_pcie_driver);\r\n}

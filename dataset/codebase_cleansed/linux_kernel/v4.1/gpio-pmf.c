static void pmf_gpio_set_hw_reset(struct gpio_runtime *rt, int on)\r\n{\r\nstruct pmf_args args = { .count = 1, .u[0].v = !!on };\r\nint rc;\r\nif (unlikely(!rt)) return;\r\nrc = pmf_call_function(rt->node, "hw-reset", &args);\r\nif (rc)\r\nprintk(KERN_WARNING "pmf_gpio_set_hw_reset"\r\n" failed, rc: %d\n", rc);\r\n}\r\nstatic void pmf_gpio_all_amps_off(struct gpio_runtime *rt)\r\n{\r\nint saved;\r\nif (unlikely(!rt)) return;\r\nsaved = rt->implementation_private;\r\npmf_gpio_set_headphone(rt, 0);\r\npmf_gpio_set_amp(rt, 0);\r\npmf_gpio_set_lineout(rt, 0);\r\nrt->implementation_private = saved;\r\n}\r\nstatic void pmf_gpio_all_amps_restore(struct gpio_runtime *rt)\r\n{\r\nint s;\r\nif (unlikely(!rt)) return;\r\ns = rt->implementation_private;\r\npmf_gpio_set_headphone(rt, (s>>0)&1);\r\npmf_gpio_set_amp(rt, (s>>1)&1);\r\npmf_gpio_set_lineout(rt, (s>>2)&1);\r\n}\r\nstatic void pmf_handle_notify(struct work_struct *work)\r\n{\r\nstruct gpio_notification *notif =\r\ncontainer_of(work, struct gpio_notification, work.work);\r\nmutex_lock(&notif->mutex);\r\nif (notif->notify)\r\nnotif->notify(notif->data);\r\nmutex_unlock(&notif->mutex);\r\n}\r\nstatic void pmf_gpio_init(struct gpio_runtime *rt)\r\n{\r\npmf_gpio_all_amps_off(rt);\r\nrt->implementation_private = 0;\r\nINIT_DELAYED_WORK(&rt->headphone_notify.work, pmf_handle_notify);\r\nINIT_DELAYED_WORK(&rt->line_in_notify.work, pmf_handle_notify);\r\nINIT_DELAYED_WORK(&rt->line_out_notify.work, pmf_handle_notify);\r\nmutex_init(&rt->headphone_notify.mutex);\r\nmutex_init(&rt->line_in_notify.mutex);\r\nmutex_init(&rt->line_out_notify.mutex);\r\n}\r\nstatic void pmf_gpio_exit(struct gpio_runtime *rt)\r\n{\r\npmf_gpio_all_amps_off(rt);\r\nrt->implementation_private = 0;\r\nif (rt->headphone_notify.gpio_private)\r\npmf_unregister_irq_client(rt->headphone_notify.gpio_private);\r\nif (rt->line_in_notify.gpio_private)\r\npmf_unregister_irq_client(rt->line_in_notify.gpio_private);\r\nif (rt->line_out_notify.gpio_private)\r\npmf_unregister_irq_client(rt->line_out_notify.gpio_private);\r\ncancel_delayed_work_sync(&rt->headphone_notify.work);\r\ncancel_delayed_work_sync(&rt->line_in_notify.work);\r\ncancel_delayed_work_sync(&rt->line_out_notify.work);\r\nmutex_destroy(&rt->headphone_notify.mutex);\r\nmutex_destroy(&rt->line_in_notify.mutex);\r\nmutex_destroy(&rt->line_out_notify.mutex);\r\nkfree(rt->headphone_notify.gpio_private);\r\nkfree(rt->line_in_notify.gpio_private);\r\nkfree(rt->line_out_notify.gpio_private);\r\n}\r\nstatic void pmf_handle_notify_irq(void *data)\r\n{\r\nstruct gpio_notification *notif = data;\r\nschedule_delayed_work(&notif->work, 0);\r\n}\r\nstatic int pmf_set_notify(struct gpio_runtime *rt,\r\nenum notify_type type,\r\nnotify_func_t notify,\r\nvoid *data)\r\n{\r\nstruct gpio_notification *notif;\r\nnotify_func_t old;\r\nstruct pmf_irq_client *irq_client;\r\nchar *name;\r\nint err = -EBUSY;\r\nswitch (type) {\r\ncase AOA_NOTIFY_HEADPHONE:\r\nnotif = &rt->headphone_notify;\r\nname = "headphone-detect";\r\nbreak;\r\ncase AOA_NOTIFY_LINE_IN:\r\nnotif = &rt->line_in_notify;\r\nname = "linein-detect";\r\nbreak;\r\ncase AOA_NOTIFY_LINE_OUT:\r\nnotif = &rt->line_out_notify;\r\nname = "lineout-detect";\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&notif->mutex);\r\nold = notif->notify;\r\nif (!old && !notify) {\r\nerr = 0;\r\ngoto out_unlock;\r\n}\r\nif (old && notify) {\r\nif (old == notify && notif->data == data)\r\nerr = 0;\r\ngoto out_unlock;\r\n}\r\nif (old && !notify) {\r\nirq_client = notif->gpio_private;\r\npmf_unregister_irq_client(irq_client);\r\nkfree(irq_client);\r\nnotif->gpio_private = NULL;\r\n}\r\nif (!old && notify) {\r\nirq_client = kzalloc(sizeof(struct pmf_irq_client),\r\nGFP_KERNEL);\r\nif (!irq_client) {\r\nerr = -ENOMEM;\r\ngoto out_unlock;\r\n}\r\nirq_client->data = notif;\r\nirq_client->handler = pmf_handle_notify_irq;\r\nirq_client->owner = THIS_MODULE;\r\nerr = pmf_register_irq_client(rt->node,\r\nname,\r\nirq_client);\r\nif (err) {\r\nprintk(KERN_ERR "snd-aoa: gpio layer failed to"\r\n" register %s irq (%d)\n", name, err);\r\nkfree(irq_client);\r\ngoto out_unlock;\r\n}\r\nnotif->gpio_private = irq_client;\r\n}\r\nnotif->notify = notify;\r\nnotif->data = data;\r\nerr = 0;\r\nout_unlock:\r\nmutex_unlock(&notif->mutex);\r\nreturn err;\r\n}\r\nstatic int pmf_get_detect(struct gpio_runtime *rt,\r\nenum notify_type type)\r\n{\r\nchar *name;\r\nint err = -EBUSY, ret;\r\nstruct pmf_args args = { .count = 1, .u[0].p = &ret };\r\nswitch (type) {\r\ncase AOA_NOTIFY_HEADPHONE:\r\nname = "headphone-detect";\r\nbreak;\r\ncase AOA_NOTIFY_LINE_IN:\r\nname = "linein-detect";\r\nbreak;\r\ncase AOA_NOTIFY_LINE_OUT:\r\nname = "lineout-detect";\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nerr = pmf_call_function(rt->node, name, &args);\r\nif (err)\r\nreturn err;\r\nreturn ret;\r\n}

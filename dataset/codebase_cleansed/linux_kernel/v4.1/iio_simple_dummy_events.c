int iio_simple_dummy_read_event_config(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nreturn st->event_en;\r\n}\r\nint iio_simple_dummy_write_event_config(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir,\r\nint state)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nswitch (chan->type) {\r\ncase IIO_VOLTAGE:\r\nswitch (type) {\r\ncase IIO_EV_TYPE_THRESH:\r\nif (dir == IIO_EV_DIR_RISING)\r\nst->event_en = state;\r\nelse\r\nreturn -EINVAL;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase IIO_ACTIVITY:\r\nswitch (type) {\r\ncase IIO_EV_TYPE_THRESH:\r\nst->event_en = state;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase IIO_STEPS:\r\nswitch (type) {\r\ncase IIO_EV_TYPE_CHANGE:\r\nst->event_en = state;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint iio_simple_dummy_read_event_value(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir,\r\nenum iio_event_info info,\r\nint *val, int *val2)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\n*val = st->event_val;\r\nreturn IIO_VAL_INT;\r\n}\r\nint iio_simple_dummy_write_event_value(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir,\r\nenum iio_event_info info,\r\nint val, int val2)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nst->event_val = val;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t iio_simple_dummy_event_handler(int irq, void *private)\r\n{\r\nstruct iio_dev *indio_dev = private;\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\ndev_dbg(&indio_dev->dev, "id %x event %x\n",\r\nst->regs->reg_id, st->regs->reg_data);\r\nswitch (st->regs->reg_data) {\r\ncase 0:\r\niio_push_event(indio_dev,\r\nIIO_EVENT_CODE(IIO_VOLTAGE, 0, 0,\r\nIIO_EV_DIR_RISING,\r\nIIO_EV_TYPE_THRESH, 0, 0, 0),\r\niio_get_time_ns());\r\nbreak;\r\ncase 1:\r\nif (st->activity_running > st->event_val)\r\niio_push_event(indio_dev,\r\nIIO_EVENT_CODE(IIO_ACTIVITY, 0,\r\nIIO_MOD_RUNNING,\r\nIIO_EV_DIR_RISING,\r\nIIO_EV_TYPE_THRESH,\r\n0, 0, 0),\r\niio_get_time_ns());\r\nbreak;\r\ncase 2:\r\nif (st->activity_walking < st->event_val)\r\niio_push_event(indio_dev,\r\nIIO_EVENT_CODE(IIO_ACTIVITY, 0,\r\nIIO_MOD_WALKING,\r\nIIO_EV_DIR_FALLING,\r\nIIO_EV_TYPE_THRESH,\r\n0, 0, 0),\r\niio_get_time_ns());\r\nbreak;\r\ncase 3:\r\niio_push_event(indio_dev,\r\nIIO_EVENT_CODE(IIO_STEPS, 0, IIO_NO_MOD,\r\nIIO_EV_DIR_NONE,\r\nIIO_EV_TYPE_CHANGE, 0, 0, 0),\r\niio_get_time_ns());\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint iio_simple_dummy_events_register(struct iio_dev *indio_dev)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nint ret;\r\nst->event_irq = iio_dummy_evgen_get_irq();\r\nif (st->event_irq < 0) {\r\nret = st->event_irq;\r\ngoto error_ret;\r\n}\r\nst->regs = iio_dummy_evgen_get_regs(st->event_irq);\r\nret = request_threaded_irq(st->event_irq,\r\nNULL,\r\n&iio_simple_dummy_event_handler,\r\nIRQF_ONESHOT,\r\n"iio_simple_event",\r\nindio_dev);\r\nif (ret < 0)\r\ngoto error_free_evgen;\r\nreturn 0;\r\nerror_free_evgen:\r\niio_dummy_evgen_release_irq(st->event_irq);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nint iio_simple_dummy_events_unregister(struct iio_dev *indio_dev)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nfree_irq(st->event_irq, indio_dev);\r\niio_dummy_evgen_release_irq(st->event_irq);\r\nreturn 0;\r\n}

int arch_gnttab_map_shared(unsigned long *frames, unsigned long nr_gframes,\r\nunsigned long max_nr_gframes,\r\nvoid **__shared)\r\n{\r\nvoid *shared = *__shared;\r\nunsigned long addr;\r\nunsigned long i;\r\nif (shared == NULL)\r\n*__shared = shared = gnttab_shared_vm_area.area->addr;\r\naddr = (unsigned long)shared;\r\nfor (i = 0; i < nr_gframes; i++) {\r\nset_pte_at(&init_mm, addr, gnttab_shared_vm_area.ptes[i],\r\nmfn_pte(frames[i], PAGE_KERNEL));\r\naddr += PAGE_SIZE;\r\n}\r\nreturn 0;\r\n}\r\nvoid arch_gnttab_unmap(void *shared, unsigned long nr_gframes)\r\n{\r\nunsigned long addr;\r\nunsigned long i;\r\naddr = (unsigned long)shared;\r\nfor (i = 0; i < nr_gframes; i++) {\r\nset_pte_at(&init_mm, addr, gnttab_shared_vm_area.ptes[i],\r\n__pte(0));\r\naddr += PAGE_SIZE;\r\n}\r\n}\r\nstatic int arch_gnttab_valloc(struct gnttab_vm_area *area, unsigned nr_frames)\r\n{\r\narea->ptes = kmalloc(sizeof(pte_t *) * nr_frames, GFP_KERNEL);\r\nif (area->ptes == NULL)\r\nreturn -ENOMEM;\r\narea->area = alloc_vm_area(PAGE_SIZE * nr_frames, area->ptes);\r\nif (area->area == NULL) {\r\nkfree(area->ptes);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nint arch_gnttab_init(unsigned long nr_shared)\r\n{\r\nif (!xen_pv_domain())\r\nreturn 0;\r\nreturn arch_gnttab_valloc(&gnttab_shared_vm_area, nr_shared);\r\n}\r\nstatic int __init xlated_setup_gnttab_pages(void)\r\n{\r\nstruct page **pages;\r\nxen_pfn_t *pfns;\r\nvoid *vaddr;\r\nint rc;\r\nunsigned int i;\r\nunsigned long nr_grant_frames = gnttab_max_grant_frames();\r\nBUG_ON(nr_grant_frames == 0);\r\npages = kcalloc(nr_grant_frames, sizeof(pages[0]), GFP_KERNEL);\r\nif (!pages)\r\nreturn -ENOMEM;\r\npfns = kcalloc(nr_grant_frames, sizeof(pfns[0]), GFP_KERNEL);\r\nif (!pfns) {\r\nkfree(pages);\r\nreturn -ENOMEM;\r\n}\r\nrc = alloc_xenballooned_pages(nr_grant_frames, pages, 0 );\r\nif (rc) {\r\npr_warn("%s Couldn't balloon alloc %ld pfns rc:%d\n", __func__,\r\nnr_grant_frames, rc);\r\nkfree(pages);\r\nkfree(pfns);\r\nreturn rc;\r\n}\r\nfor (i = 0; i < nr_grant_frames; i++)\r\npfns[i] = page_to_pfn(pages[i]);\r\nvaddr = vmap(pages, nr_grant_frames, 0, PAGE_KERNEL);\r\nif (!vaddr) {\r\npr_warn("%s Couldn't map %ld pfns rc:%d\n", __func__,\r\nnr_grant_frames, rc);\r\nfree_xenballooned_pages(nr_grant_frames, pages);\r\nkfree(pages);\r\nkfree(pfns);\r\nreturn -ENOMEM;\r\n}\r\nkfree(pages);\r\nxen_auto_xlat_grant_frames.pfn = pfns;\r\nxen_auto_xlat_grant_frames.count = nr_grant_frames;\r\nxen_auto_xlat_grant_frames.vaddr = vaddr;\r\nreturn 0;\r\n}\r\nstatic int __init xen_pvh_gnttab_setup(void)\r\n{\r\nif (!xen_pvh_domain())\r\nreturn -ENODEV;\r\nreturn xlated_setup_gnttab_pages();\r\n}

unsigned int EmulateCPDO(const unsigned int opcode)\r\n{\r\nFPA11 *fpa11 = GET_FPA11();\r\nFPREG *rFd;\r\nunsigned int nType, nDest, nRc;\r\nstruct roundingData roundData;\r\nnDest = getDestinationSize(opcode);\r\nif (typeNone == nDest)\r\nreturn 0;\r\nroundData.mode = SetRoundingMode(opcode);\r\nroundData.precision = SetRoundingPrecision(opcode);\r\nroundData.exception = 0;\r\nif (MONADIC_INSTRUCTION(opcode))\r\nnType = nDest;\r\nelse\r\nnType = fpa11->fType[getFn(opcode)];\r\nif (!CONSTANT_FM(opcode)) {\r\nregister unsigned int Fm = getFm(opcode);\r\nif (nType < fpa11->fType[Fm]) {\r\nnType = fpa11->fType[Fm];\r\n}\r\n}\r\nrFd = &fpa11->fpreg[getFd(opcode)];\r\nswitch (nType) {\r\ncase typeSingle:\r\nnRc = SingleCPDO(&roundData, opcode, rFd);\r\nbreak;\r\ncase typeDouble:\r\nnRc = DoubleCPDO(&roundData, opcode, rFd);\r\nbreak;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\ncase typeExtended:\r\nnRc = ExtendedCPDO(&roundData, opcode, rFd);\r\nbreak;\r\n#endif\r\ndefault:\r\nnRc = 0;\r\n}\r\nif (nRc != 0) {\r\nfpa11->fType[getFd(opcode)] = nDest;\r\n#ifdef CONFIG_FPE_NWFPE_XP\r\nif (nDest != nType) {\r\nswitch (nDest) {\r\ncase typeSingle:\r\n{\r\nif (typeDouble == nType)\r\nrFd->fSingle = float64_to_float32(&roundData, rFd->fDouble);\r\nelse\r\nrFd->fSingle = floatx80_to_float32(&roundData, rFd->fExtended);\r\n}\r\nbreak;\r\ncase typeDouble:\r\n{\r\nif (typeSingle == nType)\r\nrFd->fDouble = float32_to_float64(rFd->fSingle);\r\nelse\r\nrFd->fDouble = floatx80_to_float64(&roundData, rFd->fExtended);\r\n}\r\nbreak;\r\ncase typeExtended:\r\n{\r\nif (typeSingle == nType)\r\nrFd->fExtended = float32_to_floatx80(rFd->fSingle);\r\nelse\r\nrFd->fExtended = float64_to_floatx80(rFd->fDouble);\r\n}\r\nbreak;\r\n}\r\n}\r\n#else\r\nif (nDest != nType) {\r\nif (nDest == typeSingle)\r\nrFd->fSingle = float64_to_float32(&roundData, rFd->fDouble);\r\nelse\r\nrFd->fDouble = float32_to_float64(rFd->fSingle);\r\n}\r\n#endif\r\n}\r\nif (roundData.exception)\r\nfloat_raise(roundData.exception);\r\nreturn nRc;\r\n}

static inline int htu21_temp_ticks_to_millicelsius(int ticks)\r\n{\r\nticks &= ~0x0003;\r\nreturn ((21965 * ticks) >> 13) - 46850;\r\n}\r\nstatic inline int htu21_rh_ticks_to_per_cent_mille(int ticks)\r\n{\r\nticks &= ~0x0003;\r\nreturn ((15625 * ticks) >> 13) - 6000;\r\n}\r\nstatic int htu21_update_measurements(struct device *dev)\r\n{\r\nstruct htu21 *htu21 = dev_get_drvdata(dev);\r\nstruct i2c_client *client = htu21->client;\r\nint ret = 0;\r\nmutex_lock(&htu21->lock);\r\nif (time_after(jiffies, htu21->last_update + HZ / 2) ||\r\n!htu21->valid) {\r\nret = i2c_smbus_read_word_swapped(client,\r\nHTU21_T_MEASUREMENT_HM);\r\nif (ret < 0)\r\ngoto out;\r\nhtu21->temperature = htu21_temp_ticks_to_millicelsius(ret);\r\nret = i2c_smbus_read_word_swapped(client,\r\nHTU21_RH_MEASUREMENT_HM);\r\nif (ret < 0)\r\ngoto out;\r\nhtu21->humidity = htu21_rh_ticks_to_per_cent_mille(ret);\r\nhtu21->last_update = jiffies;\r\nhtu21->valid = true;\r\n}\r\nout:\r\nmutex_unlock(&htu21->lock);\r\nreturn ret >= 0 ? 0 : ret;\r\n}\r\nstatic ssize_t htu21_show_temperature(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct htu21 *htu21 = dev_get_drvdata(dev);\r\nint ret;\r\nret = htu21_update_measurements(dev);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", htu21->temperature);\r\n}\r\nstatic ssize_t htu21_show_humidity(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct htu21 *htu21 = dev_get_drvdata(dev);\r\nint ret;\r\nret = htu21_update_measurements(dev);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", htu21->humidity);\r\n}\r\nstatic int htu21_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct htu21 *htu21;\r\nstruct device *hwmon_dev;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_WORD_DATA)) {\r\ndev_err(&client->dev,\r\n"adapter does not support SMBus word transactions\n");\r\nreturn -ENODEV;\r\n}\r\nhtu21 = devm_kzalloc(dev, sizeof(*htu21), GFP_KERNEL);\r\nif (!htu21)\r\nreturn -ENOMEM;\r\nhtu21->client = client;\r\nmutex_init(&htu21->lock);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\r\nhtu21,\r\nhtu21_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

static int hip04_mdio_wait_ready(struct mii_bus *bus)\r\n{\r\nstruct hip04_mdio_priv *priv = bus->priv;\r\nint i;\r\nfor (i = 0; readl_relaxed(priv->base + MDIO_CMD_REG) & MDIO_START; i++) {\r\nif (i == WAIT_TIMEOUT)\r\nreturn -ETIMEDOUT;\r\nmsleep(20);\r\n}\r\nreturn 0;\r\n}\r\nstatic int hip04_mdio_read(struct mii_bus *bus, int mii_id, int regnum)\r\n{\r\nstruct hip04_mdio_priv *priv = bus->priv;\r\nu32 val;\r\nint ret;\r\nret = hip04_mdio_wait_ready(bus);\r\nif (ret < 0)\r\ngoto out;\r\nval = regnum | (mii_id << 5) | MDIO_READ;\r\nwritel_relaxed(val, priv->base + MDIO_CMD_REG);\r\nret = hip04_mdio_wait_ready(bus);\r\nif (ret < 0)\r\ngoto out;\r\nval = readl_relaxed(priv->base + MDIO_STA_REG);\r\nif (val & MDIO_R_VALID) {\r\ndev_err(bus->parent, "SMI bus read not valid\n");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nval = readl_relaxed(priv->base + MDIO_RDATA_REG);\r\nret = val & 0xFFFF;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int hip04_mdio_write(struct mii_bus *bus, int mii_id,\r\nint regnum, u16 value)\r\n{\r\nstruct hip04_mdio_priv *priv = bus->priv;\r\nu32 val;\r\nint ret;\r\nret = hip04_mdio_wait_ready(bus);\r\nif (ret < 0)\r\ngoto out;\r\nwritel_relaxed(value, priv->base + MDIO_WDATA_REG);\r\nval = regnum | (mii_id << 5) | MDIO_WRITE;\r\nwritel_relaxed(val, priv->base + MDIO_CMD_REG);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int hip04_mdio_reset(struct mii_bus *bus)\r\n{\r\nint temp, i;\r\nfor (i = 0; i < PHY_MAX_ADDR; i++) {\r\nhip04_mdio_write(bus, i, 22, 0);\r\ntemp = hip04_mdio_read(bus, i, MII_BMCR);\r\nif (temp < 0)\r\ncontinue;\r\ntemp |= BMCR_RESET;\r\nif (hip04_mdio_write(bus, i, MII_BMCR, temp) < 0)\r\ncontinue;\r\n}\r\nmdelay(500);\r\nreturn 0;\r\n}\r\nstatic int hip04_mdio_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *r;\r\nstruct mii_bus *bus;\r\nstruct hip04_mdio_priv *priv;\r\nint ret;\r\nbus = mdiobus_alloc_size(sizeof(struct hip04_mdio_priv));\r\nif (!bus) {\r\ndev_err(&pdev->dev, "Cannot allocate MDIO bus\n");\r\nreturn -ENOMEM;\r\n}\r\nbus->name = "hip04_mdio_bus";\r\nbus->read = hip04_mdio_read;\r\nbus->write = hip04_mdio_write;\r\nbus->reset = hip04_mdio_reset;\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%s-mii", dev_name(&pdev->dev));\r\nbus->parent = &pdev->dev;\r\npriv = bus->priv;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->base = devm_ioremap_resource(&pdev->dev, r);\r\nif (IS_ERR(priv->base)) {\r\nret = PTR_ERR(priv->base);\r\ngoto out_mdio;\r\n}\r\nret = of_mdiobus_register(bus, pdev->dev.of_node);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Cannot register MDIO bus (%d)\n", ret);\r\ngoto out_mdio;\r\n}\r\nplatform_set_drvdata(pdev, bus);\r\nreturn 0;\r\nout_mdio:\r\nmdiobus_free(bus);\r\nreturn ret;\r\n}\r\nstatic int hip04_mdio_remove(struct platform_device *pdev)\r\n{\r\nstruct mii_bus *bus = platform_get_drvdata(pdev);\r\nmdiobus_unregister(bus);\r\nmdiobus_free(bus);\r\nreturn 0;\r\n}

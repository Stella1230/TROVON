void diva_xdi_provide_istream_info(ADAPTER *a,\r\ndiva_xdi_stream_interface_t *pi) {\r\npi->provided_service = 0;\r\n}\r\nint diva_istream_write(void *context,\r\nint Id,\r\nvoid *data,\r\nint length,\r\nint final,\r\nbyte usr1,\r\nbyte usr2) {\r\nADAPTER *a = (ADAPTER *)context;\r\nint written = 0, to_write = -1;\r\nchar tmp[4];\r\nbyte *data_ptr = (byte *)data;\r\nfor (;;) {\r\na->ram_in_dw(a,\r\n#ifdef PLATFORM_GT_32BIT\r\nULongToPtr(a->tx_stream[Id] + a->tx_pos[Id]),\r\n#else\r\n(void *)(a->tx_stream[Id] + a->tx_pos[Id]),\r\n#endif\r\n(dword *)&tmp[0],\r\n1);\r\nif (tmp[0] & DIVA_DFIFO_READY) {\r\nif (to_write < 0)\r\nreturn (-1);\r\nbreak;\r\n}\r\nto_write = min(length, DIVA_DFIFO_DATA_SZ);\r\nif (to_write) {\r\na->ram_out_buffer(a,\r\n#ifdef PLATFORM_GT_32BIT\r\nULongToPtr(a->tx_stream[Id] + a->tx_pos[Id] + 4),\r\n#else\r\n(void *)(a->tx_stream[Id] + a->tx_pos[Id] + 4),\r\n#endif\r\ndata_ptr,\r\n(word)to_write);\r\nlength -= to_write;\r\nwritten += to_write;\r\ndata_ptr += to_write;\r\n}\r\ntmp[1] = (char)to_write;\r\ntmp[0] = (tmp[0] & DIVA_DFIFO_WRAP) |\r\nDIVA_DFIFO_READY |\r\n((!length && final) ? DIVA_DFIFO_LAST : 0);\r\nif (tmp[0] & DIVA_DFIFO_LAST) {\r\ntmp[2] = usr1;\r\ntmp[3] = usr2;\r\n}\r\na->ram_out_dw(a,\r\n#ifdef PLATFORM_GT_32BIT\r\nULongToPtr(a->tx_stream[Id] + a->tx_pos[Id]),\r\n#else\r\n(void *)(a->tx_stream[Id] + a->tx_pos[Id]),\r\n#endif\r\n(dword *)&tmp[0],\r\n1);\r\nif (tmp[0] & DIVA_DFIFO_WRAP) {\r\na->tx_pos[Id] = 0;\r\n} else {\r\na->tx_pos[Id] += DIVA_DFIFO_STEP;\r\n}\r\nif (!length) {\r\nbreak;\r\n}\r\n}\r\nreturn (written);\r\n}\r\nint diva_istream_read(void *context,\r\nint Id,\r\nvoid *data,\r\nint max_length,\r\nint *final,\r\nbyte *usr1,\r\nbyte *usr2) {\r\nADAPTER *a = (ADAPTER *)context;\r\nint read = 0, to_read = -1;\r\nchar tmp[4];\r\nbyte *data_ptr = (byte *)data;\r\n*final = 0;\r\nfor (;;) {\r\na->ram_in_dw(a,\r\n#ifdef PLATFORM_GT_32BIT\r\nULongToPtr(a->rx_stream[Id] + a->rx_pos[Id]),\r\n#else\r\n(void *)(a->rx_stream[Id] + a->rx_pos[Id]),\r\n#endif\r\n(dword *)&tmp[0],\r\n1);\r\nif (tmp[1] > max_length) {\r\nif (to_read < 0)\r\nreturn (-2);\r\nbreak;\r\n}\r\nif (!(tmp[0] & DIVA_DFIFO_READY)) {\r\nif (to_read < 0)\r\nreturn (-1);\r\nbreak;\r\n}\r\nto_read = min(max_length, (int)tmp[1]);\r\nif (to_read) {\r\na->ram_in_buffer(a,\r\n#ifdef PLATFORM_GT_32BIT\r\nULongToPtr(a->rx_stream[Id] + a->rx_pos[Id] + 4),\r\n#else\r\n(void *)(a->rx_stream[Id] + a->rx_pos[Id] + 4),\r\n#endif\r\ndata_ptr,\r\n(word)to_read);\r\nmax_length -= to_read;\r\nread += to_read;\r\ndata_ptr += to_read;\r\n}\r\nif (tmp[0] & DIVA_DFIFO_LAST) {\r\n*final = 1;\r\n}\r\ntmp[0] &= DIVA_DFIFO_WRAP;\r\na->ram_out_dw(a,\r\n#ifdef PLATFORM_GT_32BIT\r\nULongToPtr(a->rx_stream[Id] + a->rx_pos[Id]),\r\n#else\r\n(void *)(a->rx_stream[Id] + a->rx_pos[Id]),\r\n#endif\r\n(dword *)&tmp[0],\r\n1);\r\nif (tmp[0] & DIVA_DFIFO_WRAP) {\r\na->rx_pos[Id] = 0;\r\n} else {\r\na->rx_pos[Id] += DIVA_DFIFO_STEP;\r\n}\r\nif (*final) {\r\nif (usr1)\r\n*usr1 = tmp[2];\r\nif (usr2)\r\n*usr2 = tmp[3];\r\nbreak;\r\n}\r\n}\r\nreturn (read);\r\n}\r\nvoid pr_stream(ADAPTER *a) {\r\n}

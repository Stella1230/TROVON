static int xgbe_mdio_read(struct mii_bus *mii, int prtad, int mmd_reg)\r\n{\r\nstruct xgbe_prv_data *pdata = mii->priv;\r\nstruct xgbe_hw_if *hw_if = &pdata->hw_if;\r\nint mmd_data;\r\nDBGPR_MDIO("-->xgbe_mdio_read: prtad=%#x mmd_reg=%#x\n",\r\nprtad, mmd_reg);\r\nmmd_data = hw_if->read_mmd_regs(pdata, prtad, mmd_reg);\r\nDBGPR_MDIO("<--xgbe_mdio_read: mmd_data=%#x\n", mmd_data);\r\nreturn mmd_data;\r\n}\r\nstatic int xgbe_mdio_write(struct mii_bus *mii, int prtad, int mmd_reg,\r\nu16 mmd_val)\r\n{\r\nstruct xgbe_prv_data *pdata = mii->priv;\r\nstruct xgbe_hw_if *hw_if = &pdata->hw_if;\r\nint mmd_data = mmd_val;\r\nDBGPR_MDIO("-->xgbe_mdio_write: prtad=%#x mmd_reg=%#x mmd_data=%#x\n",\r\nprtad, mmd_reg, mmd_data);\r\nhw_if->write_mmd_regs(pdata, prtad, mmd_reg, mmd_data);\r\nDBGPR_MDIO("<--xgbe_mdio_write\n");\r\nreturn 0;\r\n}\r\nvoid xgbe_dump_phy_registers(struct xgbe_prv_data *pdata)\r\n{\r\nstruct device *dev = pdata->dev;\r\nstruct phy_device *phydev = pdata->mii->phy_map[XGBE_PRTAD];\r\nint i;\r\ndev_alert(dev, "\n************* PHY Reg dump **********************\n");\r\ndev_alert(dev, "PCS Control Reg (%#04x) = %#04x\n", MDIO_CTRL1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1));\r\ndev_alert(dev, "PCS Status Reg (%#04x) = %#04x\n", MDIO_STAT1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1));\r\ndev_alert(dev, "Phy Id (PHYS ID 1 %#04x)= %#04x\n", MDIO_DEVID1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVID1));\r\ndev_alert(dev, "Phy Id (PHYS ID 2 %#04x)= %#04x\n", MDIO_DEVID2,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVID2));\r\ndev_alert(dev, "Devices in Package (%#04x)= %#04x\n", MDIO_DEVS1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVS1));\r\ndev_alert(dev, "Devices in Package (%#04x)= %#04x\n", MDIO_DEVS2,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVS2));\r\ndev_alert(dev, "Auto-Neg Control Reg (%#04x) = %#04x\n", MDIO_CTRL1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_CTRL1));\r\ndev_alert(dev, "Auto-Neg Status Reg (%#04x) = %#04x\n", MDIO_STAT1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_STAT1));\r\ndev_alert(dev, "Auto-Neg Ad Reg 1 (%#04x) = %#04x\n",\r\nMDIO_AN_ADVERTISE,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE));\r\ndev_alert(dev, "Auto-Neg Ad Reg 2 (%#04x) = %#04x\n",\r\nMDIO_AN_ADVERTISE + 1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1));\r\ndev_alert(dev, "Auto-Neg Ad Reg 3 (%#04x) = %#04x\n",\r\nMDIO_AN_ADVERTISE + 2,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2));\r\ndev_alert(dev, "Auto-Neg Completion Reg (%#04x) = %#04x\n",\r\nMDIO_AN_COMP_STAT,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_COMP_STAT));\r\ndev_alert(dev, "MMD Device Mask = %#x\n",\r\nphydev->c45_ids.devices_in_package);\r\nfor (i = 0; i < ARRAY_SIZE(phydev->c45_ids.device_ids); i++)\r\ndev_alert(dev, " MMD %d: ID = %#08x\n", i,\r\nphydev->c45_ids.device_ids[i]);\r\ndev_alert(dev, "\n*************************************************\n");\r\n}\r\nint xgbe_mdio_register(struct xgbe_prv_data *pdata)\r\n{\r\nstruct mii_bus *mii;\r\nstruct phy_device *phydev;\r\nint ret = 0;\r\nDBGPR("-->xgbe_mdio_register\n");\r\nmii = mdiobus_alloc();\r\nif (!mii) {\r\ndev_err(pdata->dev, "mdiobus_alloc failed\n");\r\nreturn -ENOMEM;\r\n}\r\nmii->name = XGBE_PHY_NAME;\r\nmii->read = xgbe_mdio_read;\r\nmii->write = xgbe_mdio_write;\r\nsnprintf(mii->id, sizeof(mii->id), "%s", pdata->mii_bus_id);\r\nmii->priv = pdata;\r\nmii->phy_mask = ~0;\r\nmii->parent = pdata->dev;\r\nret = mdiobus_register(mii);\r\nif (ret) {\r\ndev_err(pdata->dev, "mdiobus_register failed\n");\r\ngoto err_mdiobus_alloc;\r\n}\r\nDBGPR(" mdiobus_register succeeded for %s\n", pdata->mii_bus_id);\r\nphydev = get_phy_device(mii, XGBE_PRTAD, true);\r\nif (IS_ERR(phydev) || !phydev ||\r\n!phydev->c45_ids.device_ids[MDIO_MMD_PCS]) {\r\ndev_err(pdata->dev, "get_phy_device failed\n");\r\nret = phydev ? PTR_ERR(phydev) : -ENOLINK;\r\ngoto err_mdiobus_register;\r\n}\r\nrequest_module(MDIO_MODULE_PREFIX MDIO_ID_FMT,\r\nMDIO_ID_ARGS(phydev->c45_ids.device_ids[MDIO_MMD_PCS]));\r\nret = phy_device_register(phydev);\r\nif (ret) {\r\ndev_err(pdata->dev, "phy_device_register failed\n");\r\ngoto err_phy_device;\r\n}\r\nif (!phydev->dev.driver) {\r\ndev_err(pdata->dev, "phy driver probe failed\n");\r\nret = -EIO;\r\ngoto err_phy_device;\r\n}\r\npdata->phy_module = phydev->dev.driver->owner;\r\nif (!try_module_get(pdata->phy_module)) {\r\ndev_err(pdata->dev, "try_module_get failed\n");\r\nret = -EIO;\r\ngoto err_phy_device;\r\n}\r\npdata->mii = mii;\r\npdata->mdio_mmd = MDIO_MMD_PCS;\r\nphydev->autoneg = pdata->default_autoneg;\r\nif (phydev->autoneg == AUTONEG_DISABLE) {\r\nphydev->speed = pdata->default_speed;\r\nphydev->duplex = DUPLEX_FULL;\r\nphydev->advertising &= ~ADVERTISED_Autoneg;\r\n}\r\npdata->phydev = phydev;\r\nDBGPHY_REGS(pdata);\r\nDBGPR("<--xgbe_mdio_register\n");\r\nreturn 0;\r\nerr_phy_device:\r\nphy_device_free(phydev);\r\nerr_mdiobus_register:\r\nmdiobus_unregister(mii);\r\nerr_mdiobus_alloc:\r\nmdiobus_free(mii);\r\nreturn ret;\r\n}\r\nvoid xgbe_mdio_unregister(struct xgbe_prv_data *pdata)\r\n{\r\nDBGPR("-->xgbe_mdio_unregister\n");\r\npdata->phydev = NULL;\r\nmodule_put(pdata->phy_module);\r\npdata->phy_module = NULL;\r\nmdiobus_unregister(pdata->mii);\r\npdata->mii->priv = NULL;\r\nmdiobus_free(pdata->mii);\r\npdata->mii = NULL;\r\nDBGPR("<--xgbe_mdio_unregister\n");\r\n}

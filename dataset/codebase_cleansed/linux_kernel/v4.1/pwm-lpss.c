static inline struct pwm_lpss_chip *to_lpwm(struct pwm_chip *chip)\r\n{\r\nreturn container_of(chip, struct pwm_lpss_chip, chip);\r\n}\r\nstatic int pwm_lpss_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nstruct pwm_lpss_chip *lpwm = to_lpwm(chip);\r\nu8 on_time_div;\r\nunsigned long c;\r\nunsigned long long base_unit, freq = NSECS_PER_SEC;\r\nu32 ctrl;\r\ndo_div(freq, period_ns);\r\nbase_unit = freq * 65536;\r\nc = lpwm->clk_rate;\r\nif (!c)\r\nreturn -EINVAL;\r\ndo_div(base_unit, c);\r\nbase_unit += PWM_DIVISION_CORRECTION;\r\nif (base_unit > PWM_LIMIT)\r\nreturn -EINVAL;\r\nif (duty_ns <= 0)\r\nduty_ns = 1;\r\non_time_div = 255 - (255 * duty_ns / period_ns);\r\nctrl = readl(lpwm->regs + PWM);\r\nctrl &= ~(PWM_BASE_UNIT_MASK | PWM_ON_TIME_DIV_MASK);\r\nctrl |= (u16) base_unit << PWM_BASE_UNIT_SHIFT;\r\nctrl |= on_time_div;\r\nctrl |= PWM_SW_UPDATE;\r\nwritel(ctrl, lpwm->regs + PWM);\r\nreturn 0;\r\n}\r\nstatic int pwm_lpss_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct pwm_lpss_chip *lpwm = to_lpwm(chip);\r\nu32 ctrl;\r\nctrl = readl(lpwm->regs + PWM);\r\nwritel(ctrl | PWM_ENABLE, lpwm->regs + PWM);\r\nreturn 0;\r\n}\r\nstatic void pwm_lpss_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct pwm_lpss_chip *lpwm = to_lpwm(chip);\r\nu32 ctrl;\r\nctrl = readl(lpwm->regs + PWM);\r\nwritel(ctrl & ~PWM_ENABLE, lpwm->regs + PWM);\r\n}\r\nstruct pwm_lpss_chip *pwm_lpss_probe(struct device *dev, struct resource *r,\r\nconst struct pwm_lpss_boardinfo *info)\r\n{\r\nstruct pwm_lpss_chip *lpwm;\r\nint ret;\r\nlpwm = devm_kzalloc(dev, sizeof(*lpwm), GFP_KERNEL);\r\nif (!lpwm)\r\nreturn ERR_PTR(-ENOMEM);\r\nlpwm->regs = devm_ioremap_resource(dev, r);\r\nif (IS_ERR(lpwm->regs))\r\nreturn ERR_CAST(lpwm->regs);\r\nlpwm->clk_rate = info->clk_rate;\r\nlpwm->chip.dev = dev;\r\nlpwm->chip.ops = &pwm_lpss_ops;\r\nlpwm->chip.base = -1;\r\nlpwm->chip.npwm = 1;\r\nret = pwmchip_add(&lpwm->chip);\r\nif (ret) {\r\ndev_err(dev, "failed to add PWM chip: %d\n", ret);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn lpwm;\r\n}\r\nint pwm_lpss_remove(struct pwm_lpss_chip *lpwm)\r\n{\r\nu32 ctrl;\r\nctrl = readl(lpwm->regs + PWM);\r\nwritel(ctrl & ~PWM_ENABLE, lpwm->regs + PWM);\r\nreturn pwmchip_remove(&lpwm->chip);\r\n}

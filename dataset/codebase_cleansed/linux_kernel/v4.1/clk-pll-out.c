static int clk_pll_out_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_pll_out *pll_out = to_clk_pll_out(hw);\r\nu32 val = readl_relaxed(pll_out->reg);\r\nint state;\r\nstate = (val & pll_out_enb(pll_out)) ? 1 : 0;\r\nif (!(val & (pll_out_rst(pll_out))))\r\nstate = 0;\r\nreturn state;\r\n}\r\nstatic int clk_pll_out_enable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_pll_out *pll_out = to_clk_pll_out(hw);\r\nunsigned long flags = 0;\r\nu32 val;\r\nif (pll_out->lock)\r\nspin_lock_irqsave(pll_out->lock, flags);\r\nval = readl_relaxed(pll_out->reg);\r\nval |= (pll_out_enb(pll_out) | pll_out_rst(pll_out));\r\nwritel_relaxed(val, pll_out->reg);\r\nudelay(2);\r\nif (pll_out->lock)\r\nspin_unlock_irqrestore(pll_out->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void clk_pll_out_disable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_pll_out *pll_out = to_clk_pll_out(hw);\r\nunsigned long flags = 0;\r\nu32 val;\r\nif (pll_out->lock)\r\nspin_lock_irqsave(pll_out->lock, flags);\r\nval = readl_relaxed(pll_out->reg);\r\nval &= ~(pll_out_enb(pll_out) | pll_out_rst(pll_out));\r\nwritel_relaxed(val, pll_out->reg);\r\nudelay(2);\r\nif (pll_out->lock)\r\nspin_unlock_irqrestore(pll_out->lock, flags);\r\n}\r\nstruct clk *tegra_clk_register_pll_out(const char *name,\r\nconst char *parent_name, void __iomem *reg, u8 enb_bit_idx,\r\nu8 rst_bit_idx, unsigned long flags, u8 pll_out_flags,\r\nspinlock_t *lock)\r\n{\r\nstruct tegra_clk_pll_out *pll_out;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\npll_out = kzalloc(sizeof(*pll_out), GFP_KERNEL);\r\nif (!pll_out)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &tegra_clk_pll_out_ops;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\ninit.flags = flags;\r\npll_out->reg = reg;\r\npll_out->enb_bit_idx = enb_bit_idx;\r\npll_out->rst_bit_idx = rst_bit_idx;\r\npll_out->flags = pll_out_flags;\r\npll_out->lock = lock;\r\npll_out->hw.init = &init;\r\nclk = clk_register(NULL, &pll_out->hw);\r\nif (IS_ERR(clk))\r\nkfree(pll_out);\r\nreturn clk;\r\n}

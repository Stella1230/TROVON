int\r\nxfs_rtbuf_get(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t block,\r\nint issum,\r\nxfs_buf_t **bpp)\r\n{\r\nxfs_buf_t *bp;\r\nxfs_inode_t *ip;\r\nxfs_bmbt_irec_t map;\r\nint nmap = 1;\r\nint error;\r\nip = issum ? mp->m_rsumip : mp->m_rbmip;\r\nerror = xfs_bmapi_read(ip, block, 1, &map, &nmap, XFS_DATA_FORK);\r\nif (error)\r\nreturn error;\r\nASSERT(map.br_startblock != NULLFSBLOCK);\r\nerror = xfs_trans_read_buf(mp, tp, mp->m_ddev_targp,\r\nXFS_FSB_TO_DADDR(mp, map.br_startblock),\r\nmp->m_bsize, 0, &bp, NULL);\r\nif (error)\r\nreturn error;\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtfind_back(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_rtblock_t limit,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtblock_t firstbit;\r\nxfs_rtblock_t i;\r\nxfs_rtblock_t len;\r\nxfs_rtword_t mask;\r\nxfs_rtword_t want;\r\nxfs_rtword_t wdiff;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nb = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nlen = start - limit + 1;\r\nwant = (*b & ((xfs_rtword_t)1 << bit)) ? -1 : 0;\r\nif (bit < XFS_NBWORD - 1) {\r\nfirstbit = XFS_RTMAX((xfs_srtblock_t)(bit - len + 1), 0);\r\nmask = (((xfs_rtword_t)1 << (bit - firstbit + 1)) - 1) <<\r\nfirstbit;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni = bit - XFS_RTHIBIT(wdiff);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n}\r\ni = bit - firstbit + 1;\r\nif (--word == -1 && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, --block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BLOCKWMASK(mp);\r\nb = &bufp[word];\r\n} else {\r\nb--;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\nif ((wdiff = *b ^ want)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_NBWORD - 1 - XFS_RTHIBIT(wdiff);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n}\r\ni += XFS_NBWORD;\r\nif (--word == -1 && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, --block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BLOCKWMASK(mp);\r\nb = &bufp[word];\r\n} else {\r\nb--;\r\n}\r\n}\r\nif (len - i) {\r\nfirstbit = XFS_NBWORD - (len - i);\r\nmask = (((xfs_rtword_t)1 << (len - i)) - 1) << firstbit;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_NBWORD - 1 - XFS_RTHIBIT(wdiff);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n} else\r\ni = len;\r\n}\r\nxfs_trans_brelse(tp, bp);\r\n*rtblock = start - i + 1;\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtfind_forw(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_rtblock_t limit,\r\nxfs_rtblock_t *rtblock)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtblock_t i;\r\nxfs_rtblock_t lastbit;\r\nxfs_rtblock_t len;\r\nxfs_rtword_t mask;\r\nxfs_rtword_t want;\r\nxfs_rtword_t wdiff;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nb = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nlen = limit - start + 1;\r\nwant = (*b & ((xfs_rtword_t)1 << bit)) ? -1 : 0;\r\nif (bit) {\r\nlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\r\nmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni = XFS_RTLOBIT(wdiff) - bit;\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n}\r\ni = lastbit - bit;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\nif ((wdiff = *b ^ want)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n}\r\ni += XFS_NBWORD;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n}\r\nif ((lastbit = len - i)) {\r\nmask = ((xfs_rtword_t)1 << lastbit) - 1;\r\nif ((wdiff = (*b ^ want) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n} else\r\ni = len;\r\n}\r\nxfs_trans_brelse(tp, bp);\r\n*rtblock = start + i - 1;\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtmodify_summary_int(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nint log,\r\nxfs_rtblock_t bbno,\r\nint delta,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb,\r\nxfs_suminfo_t *sum)\r\n{\r\nxfs_buf_t *bp;\r\nint error;\r\nxfs_fsblock_t sb;\r\nint so;\r\nxfs_suminfo_t *sp;\r\nso = XFS_SUMOFFS(mp, log, bbno);\r\nsb = XFS_SUMOFFSTOBLOCK(mp, so);\r\nif (*rbpp && *rsb == sb)\r\nbp = *rbpp;\r\nelse {\r\nif (*rbpp)\r\nxfs_trans_brelse(tp, *rbpp);\r\nerror = xfs_rtbuf_get(mp, tp, sb, 1, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\n*rbpp = bp;\r\n*rsb = sb;\r\n}\r\nsp = XFS_SUMPTR(mp, bp, so);\r\nif (delta) {\r\nuint first = (uint)((char *)sp - (char *)bp->b_addr);\r\n*sp += delta;\r\nxfs_trans_log_buf(tp, bp, first, first + sizeof(*sp) - 1);\r\n}\r\nif (sum)\r\n*sum = *sp;\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtmodify_summary(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nint log,\r\nxfs_rtblock_t bbno,\r\nint delta,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb)\r\n{\r\nreturn xfs_rtmodify_summary_int(mp, tp, log, bbno,\r\ndelta, rbpp, rsb, NULL);\r\n}\r\nint\r\nxfs_rtmodify_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_extlen_t len,\r\nint val)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtword_t *first;\r\nint i;\r\nint lastbit;\r\nxfs_rtword_t mask;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nfirst = b = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nval = -val;\r\nif (bit) {\r\nlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\r\nmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\r\nif (val)\r\n*b |= mask;\r\nelse\r\n*b &= ~mask;\r\ni = lastbit - bit;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_log_buf(tp, bp,\r\n(uint)((char *)first - (char *)bufp),\r\n(uint)((char *)b - (char *)bufp));\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nfirst = b = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\n*b = val;\r\ni += XFS_NBWORD;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_log_buf(tp, bp,\r\n(uint)((char *)first - (char *)bufp),\r\n(uint)((char *)b - (char *)bufp));\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nfirst = b = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n}\r\nif ((lastbit = len - i)) {\r\nbit = 0;\r\nmask = ((xfs_rtword_t)1 << lastbit) - 1;\r\nif (val)\r\n*b |= mask;\r\nelse\r\n*b &= ~mask;\r\nb++;\r\n}\r\nif (b > first)\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)first - (char *)bufp),\r\n(uint)((char *)b - (char *)bufp - 1));\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtfree_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_extlen_t len,\r\nxfs_buf_t **rbpp,\r\nxfs_fsblock_t *rsb)\r\n{\r\nxfs_rtblock_t end;\r\nint error;\r\nxfs_rtblock_t postblock;\r\nxfs_rtblock_t preblock;\r\nend = start + len - 1;\r\nerror = xfs_rtmodify_range(mp, tp, start, len, 1);\r\nif (error) {\r\nreturn error;\r\n}\r\nerror = xfs_rtfind_back(mp, tp, start, 0, &preblock);\r\nif (error) {\r\nreturn error;\r\n}\r\nerror = xfs_rtfind_forw(mp, tp, end, mp->m_sb.sb_rextents - 1,\r\n&postblock);\r\nif (error)\r\nreturn error;\r\nif (preblock < start) {\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(start - preblock),\r\nXFS_BITTOBLOCK(mp, preblock), -1, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n}\r\nif (postblock > end) {\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(postblock - end),\r\nXFS_BITTOBLOCK(mp, end + 1), -1, rbpp, rsb);\r\nif (error) {\r\nreturn error;\r\n}\r\n}\r\nerror = xfs_rtmodify_summary(mp, tp,\r\nXFS_RTBLOCKLOG(postblock + 1 - preblock),\r\nXFS_BITTOBLOCK(mp, preblock), 1, rbpp, rsb);\r\nreturn error;\r\n}\r\nint\r\nxfs_rtcheck_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t start,\r\nxfs_extlen_t len,\r\nint val,\r\nxfs_rtblock_t *new,\r\nint *stat)\r\n{\r\nxfs_rtword_t *b;\r\nint bit;\r\nxfs_rtblock_t block;\r\nxfs_buf_t *bp;\r\nxfs_rtword_t *bufp;\r\nint error;\r\nxfs_rtblock_t i;\r\nxfs_rtblock_t lastbit;\r\nxfs_rtword_t mask;\r\nxfs_rtword_t wdiff;\r\nint word;\r\nblock = XFS_BITTOBLOCK(mp, start);\r\nerror = xfs_rtbuf_get(mp, tp, block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nbufp = bp->b_addr;\r\nword = XFS_BITTOWORD(mp, start);\r\nb = &bufp[word];\r\nbit = (int)(start & (XFS_NBWORD - 1));\r\nval = -val;\r\nif (bit) {\r\nlastbit = XFS_RTMIN(bit + len, XFS_NBWORD);\r\nmask = (((xfs_rtword_t)1 << (lastbit - bit)) - 1) << bit;\r\nif ((wdiff = (*b ^ val) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni = XFS_RTLOBIT(wdiff) - bit;\r\n*new = start + i;\r\n*stat = 0;\r\nreturn 0;\r\n}\r\ni = lastbit - bit;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n} else {\r\ni = 0;\r\n}\r\nwhile (len - i >= XFS_NBWORD) {\r\nif ((wdiff = *b ^ val)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*new = start + i;\r\n*stat = 0;\r\nreturn 0;\r\n}\r\ni += XFS_NBWORD;\r\nif (++word == XFS_BLOCKWSIZE(mp) && i < len) {\r\nxfs_trans_brelse(tp, bp);\r\nerror = xfs_rtbuf_get(mp, tp, ++block, 0, &bp);\r\nif (error) {\r\nreturn error;\r\n}\r\nb = bufp = bp->b_addr;\r\nword = 0;\r\n} else {\r\nb++;\r\n}\r\n}\r\nif ((lastbit = len - i)) {\r\nmask = ((xfs_rtword_t)1 << lastbit) - 1;\r\nif ((wdiff = (*b ^ val) & mask)) {\r\nxfs_trans_brelse(tp, bp);\r\ni += XFS_RTLOBIT(wdiff);\r\n*new = start + i;\r\n*stat = 0;\r\nreturn 0;\r\n} else\r\ni = len;\r\n}\r\nxfs_trans_brelse(tp, bp);\r\n*new = start + i;\r\n*stat = 1;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_rtcheck_alloc_range(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bno,\r\nxfs_extlen_t len)\r\n{\r\nxfs_rtblock_t new;\r\nint stat;\r\nint error;\r\nerror = xfs_rtcheck_range(mp, tp, bno, len, 0, &new, &stat);\r\nif (error)\r\nreturn error;\r\nASSERT(stat);\r\nreturn 0;\r\n}\r\nint\r\nxfs_rtfree_extent(\r\nxfs_trans_t *tp,\r\nxfs_rtblock_t bno,\r\nxfs_extlen_t len)\r\n{\r\nint error;\r\nxfs_mount_t *mp;\r\nxfs_fsblock_t sb;\r\nxfs_buf_t *sumbp = NULL;\r\nmp = tp->t_mountp;\r\nASSERT(mp->m_rbmip->i_itemp != NULL);\r\nASSERT(xfs_isilocked(mp->m_rbmip, XFS_ILOCK_EXCL));\r\nerror = xfs_rtcheck_alloc_range(mp, tp, bno, len);\r\nif (error)\r\nreturn error;\r\nerror = xfs_rtfree_range(mp, tp, bno, len, &sumbp, &sb);\r\nif (error) {\r\nreturn error;\r\n}\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_FREXTENTS, (long)len);\r\nif (tp->t_frextents_delta + mp->m_sb.sb_frextents ==\r\nmp->m_sb.sb_rextents) {\r\nif (!(mp->m_rbmip->i_d.di_flags & XFS_DIFLAG_NEWRTBM))\r\nmp->m_rbmip->i_d.di_flags |= XFS_DIFLAG_NEWRTBM;\r\n*(__uint64_t *)&mp->m_rbmip->i_d.di_atime = 0;\r\nxfs_trans_log_inode(tp, mp->m_rbmip, XFS_ILOG_CORE);\r\n}\r\nreturn 0;\r\n}

static unsigned long sdrc_get_fclk_period(long rate)\r\n{\r\nreturn 1000000000 / rate;\r\n}\r\nstatic unsigned int sdrc_ps_to_ticks(unsigned int time_ps, long rate)\r\n{\r\nunsigned long tick_ps;\r\ntick_ps = sdrc_get_fclk_period(rate);\r\nreturn (time_ps + tick_ps - 1) / tick_ps;\r\n}\r\nstatic int sdrc_timings(int id, long rate,\r\nconst struct sdram_timings *memory_timings)\r\n{\r\nu32 ticks_per_ms;\r\nu32 rfr, l;\r\nu32 actim_ctrla = 0, actim_ctrlb = 0;\r\nu32 rfr_ctrl;\r\nint err = 0;\r\nlong l3_rate = rate / 1000;\r\nSDRC_SET_ONE_PS(&actim_ctrla, 0, 4, tDAL, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrla, 6, 8, tDPL, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrla, 9, 11, tRRD, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrla, 12, 14, tRCD, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrla, 15, 17, tRP, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrla, 18, 21, tRAS, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrla, 22, 26, tRC, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrla, 27, 31, tRFC, l3_rate);\r\nSDRC_SET_ONE_PS(&actim_ctrlb, 0, 7, tXSR, l3_rate);\r\nSDRC_SET_ONE(&actim_ctrlb, 8, 10, tXP, l3_rate);\r\nSDRC_SET_ONE(&actim_ctrlb, 12, 14, tCKE, l3_rate);\r\nSDRC_SET_ONE(&actim_ctrlb, 16, 17, tWTR, l3_rate);\r\nticks_per_ms = l3_rate;\r\nrfr = memory_timings[0].tREF * ticks_per_ms / 1000000;\r\nif (rfr > 65535 + 50)\r\nrfr = 65535;\r\nelse\r\nrfr -= 50;\r\n#ifdef DEBUG\r\nprintk(KERN_INFO "SDRC tREF: %i ticks\n", rfr);\r\n#endif\r\nl = rfr << 8;\r\nrfr_ctrl = l | 0x1;\r\nnokia_sdrc_params[id].rate = rate;\r\nnokia_sdrc_params[id].actim_ctrla = actim_ctrla;\r\nnokia_sdrc_params[id].actim_ctrlb = actim_ctrlb;\r\nnokia_sdrc_params[id].rfr_ctrl = rfr_ctrl;\r\nnokia_sdrc_params[id].mr = 0x32;\r\nnokia_sdrc_params[id + 1].rate = 0;\r\nreturn err;\r\n}\r\nstruct omap_sdrc_params *nokia_get_sdram_timings(void)\r\n{\r\nint err = 0;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(nokia_timings); i++) {\r\nerr |= sdrc_timings(i, nokia_timings[i].rate,\r\nnokia_timings[i].data);\r\nif (err)\r\npr_err("%s: error with rate %ld: %d\n", __func__,\r\nnokia_timings[i].rate, err);\r\n}\r\nreturn err ? NULL : nokia_sdrc_params;\r\n}

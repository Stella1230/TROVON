static void sun4m_mask_irq(struct irq_data *data)\r\n{\r\nstruct sun4m_handler_data *handler_data = data->handler_data;\r\nint cpu = smp_processor_id();\r\nif (handler_data->mask) {\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (handler_data->percpu) {\r\nsbus_writel(handler_data->mask, &sun4m_irq_percpu[cpu]->set);\r\n} else {\r\nsbus_writel(handler_data->mask, &sun4m_irq_global->mask_set);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nstatic void sun4m_unmask_irq(struct irq_data *data)\r\n{\r\nstruct sun4m_handler_data *handler_data = data->handler_data;\r\nint cpu = smp_processor_id();\r\nif (handler_data->mask) {\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (handler_data->percpu) {\r\nsbus_writel(handler_data->mask, &sun4m_irq_percpu[cpu]->clear);\r\n} else {\r\nsbus_writel(handler_data->mask, &sun4m_irq_global->mask_clear);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nstatic unsigned int sun4m_startup_irq(struct irq_data *data)\r\n{\r\nirq_link(data->irq);\r\nsun4m_unmask_irq(data);\r\nreturn 0;\r\n}\r\nstatic void sun4m_shutdown_irq(struct irq_data *data)\r\n{\r\nsun4m_mask_irq(data);\r\nirq_unlink(data->irq);\r\n}\r\nstatic unsigned int sun4m_build_device_irq(struct platform_device *op,\r\nunsigned int real_irq)\r\n{\r\nstruct sun4m_handler_data *handler_data;\r\nunsigned int irq;\r\nunsigned int pil;\r\nif (real_irq >= OBP_INT_LEVEL_VME) {\r\nprom_printf("Bogus sun4m IRQ %u\n", real_irq);\r\nprom_halt();\r\n}\r\npil = (real_irq & 0xf);\r\nirq = irq_alloc(real_irq, pil);\r\nif (irq == 0)\r\ngoto out;\r\nhandler_data = irq_get_handler_data(irq);\r\nif (unlikely(handler_data))\r\ngoto out;\r\nhandler_data = kzalloc(sizeof(struct sun4m_handler_data), GFP_ATOMIC);\r\nif (unlikely(!handler_data)) {\r\nprom_printf("IRQ: kzalloc(sun4m_handler_data) failed.\n");\r\nprom_halt();\r\n}\r\nhandler_data->mask = sun4m_imask[real_irq];\r\nhandler_data->percpu = real_irq < OBP_INT_LEVEL_ONBOARD;\r\nirq_set_chip_and_handler_name(irq, &sun4m_irq,\r\nhandle_level_irq, "level");\r\nirq_set_handler_data(irq, handler_data);\r\nout:\r\nreturn irq;\r\n}\r\nstatic void sun4m_clear_clock_irq(void)\r\n{\r\nsbus_readl(&timers_global->l10_limit);\r\n}\r\nvoid sun4m_nmi(struct pt_regs *regs)\r\n{\r\nunsigned long afsr, afar, si;\r\nprintk(KERN_ERR "Aieee: sun4m NMI received!\n");\r\n__asm__ __volatile__("mov 0x500, %%g1\n\t"\r\n"lda [%%g1] 0x4, %0\n\t"\r\n"mov 0x600, %%g1\n\t"\r\n"lda [%%g1] 0x4, %1\n\t" :\r\n"=r" (afsr), "=r" (afar));\r\nprintk(KERN_ERR "afsr=%08lx afar=%08lx\n", afsr, afar);\r\nsi = sbus_readl(&sun4m_irq_global->pending);\r\nprintk(KERN_ERR "si=%08lx\n", si);\r\nif (si & SUN4M_INT_MODULE_ERR)\r\nprintk(KERN_ERR "Module async error\n");\r\nif (si & SUN4M_INT_M2S_WRITE_ERR)\r\nprintk(KERN_ERR "MBus/SBus async error\n");\r\nif (si & SUN4M_INT_ECC_ERR)\r\nprintk(KERN_ERR "ECC memory error\n");\r\nif (si & SUN4M_INT_VME_ERR)\r\nprintk(KERN_ERR "VME async error\n");\r\nprintk(KERN_ERR "you lose buddy boy...\n");\r\nshow_regs(regs);\r\nprom_halt();\r\n}\r\nvoid sun4m_unmask_profile_irq(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nsbus_writel(sun4m_imask[SUN4M_PROFILE_IRQ], &sun4m_irq_global->mask_clear);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid sun4m_clear_profile_irq(int cpu)\r\n{\r\nsbus_readl(&timers_percpu[cpu]->l14_limit);\r\n}\r\nstatic void sun4m_load_profile_irq(int cpu, unsigned int limit)\r\n{\r\nunsigned int value = limit ? timer_value(limit) : 0;\r\nsbus_writel(value, &timers_percpu[cpu]->l14_limit);\r\n}\r\nstatic void __init sun4m_init_timers(void)\r\n{\r\nstruct device_node *dp = of_find_node_by_name(NULL, "counter");\r\nint i, err, len, num_cpu_timers;\r\nunsigned int irq;\r\nconst u32 *addr;\r\nif (!dp) {\r\nprintk(KERN_ERR "sun4m_init_timers: No 'counter' node.\n");\r\nreturn;\r\n}\r\naddr = of_get_property(dp, "address", &len);\r\nof_node_put(dp);\r\nif (!addr) {\r\nprintk(KERN_ERR "sun4m_init_timers: No 'address' prop.\n");\r\nreturn;\r\n}\r\nnum_cpu_timers = (len / sizeof(u32)) - 1;\r\nfor (i = 0; i < num_cpu_timers; i++) {\r\ntimers_percpu[i] = (void __iomem *)\r\n(unsigned long) addr[i];\r\n}\r\ntimers_global = (void __iomem *)\r\n(unsigned long) addr[num_cpu_timers];\r\nsbus_writel(0x00000000, &timers_global->timer_config);\r\n#ifdef CONFIG_SMP\r\nsparc_config.cs_period = SBUS_CLOCK_RATE * 2;\r\nsparc_config.features |= FEAT_L14_ONESHOT;\r\n#else\r\nsparc_config.cs_period = SBUS_CLOCK_RATE / HZ;\r\nsparc_config.features |= FEAT_L10_CLOCKEVENT;\r\n#endif\r\nsparc_config.features |= FEAT_L10_CLOCKSOURCE;\r\nsbus_writel(timer_value(sparc_config.cs_period),\r\n&timers_global->l10_limit);\r\nmaster_l10_counter = &timers_global->l10_count;\r\nirq = sun4m_build_device_irq(NULL, SUN4M_TIMER_IRQ);\r\nerr = request_irq(irq, timer_interrupt, IRQF_TIMER, "timer", NULL);\r\nif (err) {\r\nprintk(KERN_ERR "sun4m_init_timers: Register IRQ error %d.\n",\r\nerr);\r\nreturn;\r\n}\r\nfor (i = 0; i < num_cpu_timers; i++)\r\nsbus_writel(0, &timers_percpu[i]->l14_limit);\r\nif (num_cpu_timers == 4)\r\nsbus_writel(SUN4M_INT_E14, &sun4m_irq_global->mask_set);\r\n#ifdef CONFIG_SMP\r\n{\r\nunsigned long flags;\r\nstruct tt_entry *trap_table = &sparc_ttable[SP_TRAP_IRQ1 + (14 - 1)];\r\nlocal_irq_save(flags);\r\ntrap_table->inst_one = lvl14_save[0];\r\ntrap_table->inst_two = lvl14_save[1];\r\ntrap_table->inst_three = lvl14_save[2];\r\ntrap_table->inst_four = lvl14_save[3];\r\nlocal_ops->cache_all();\r\nlocal_irq_restore(flags);\r\n}\r\n#endif\r\n}\r\nvoid __init sun4m_init_IRQ(void)\r\n{\r\nstruct device_node *dp = of_find_node_by_name(NULL, "interrupt");\r\nint len, i, mid, num_cpu_iregs;\r\nconst u32 *addr;\r\nif (!dp) {\r\nprintk(KERN_ERR "sun4m_init_IRQ: No 'interrupt' node.\n");\r\nreturn;\r\n}\r\naddr = of_get_property(dp, "address", &len);\r\nof_node_put(dp);\r\nif (!addr) {\r\nprintk(KERN_ERR "sun4m_init_IRQ: No 'address' prop.\n");\r\nreturn;\r\n}\r\nnum_cpu_iregs = (len / sizeof(u32)) - 1;\r\nfor (i = 0; i < num_cpu_iregs; i++) {\r\nsun4m_irq_percpu[i] = (void __iomem *)\r\n(unsigned long) addr[i];\r\n}\r\nsun4m_irq_global = (void __iomem *)\r\n(unsigned long) addr[num_cpu_iregs];\r\nlocal_irq_disable();\r\nsbus_writel(~SUN4M_INT_MASKALL, &sun4m_irq_global->mask_set);\r\nfor (i = 0; !cpu_find_by_instance(i, NULL, &mid); i++)\r\nsbus_writel(~0x17fff, &sun4m_irq_percpu[mid]->clear);\r\nif (num_cpu_iregs == 4)\r\nsbus_writel(0, &sun4m_irq_global->interrupt_target);\r\nsparc_config.init_timers = sun4m_init_timers;\r\nsparc_config.build_device_irq = sun4m_build_device_irq;\r\nsparc_config.clock_rate = SBUS_CLOCK_RATE;\r\nsparc_config.clear_clock_irq = sun4m_clear_clock_irq;\r\nsparc_config.load_profile_irq = sun4m_load_profile_irq;\r\n}

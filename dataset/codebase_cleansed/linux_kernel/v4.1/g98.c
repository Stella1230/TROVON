static void\r\ng98_sec_intr(struct nvkm_subdev *subdev)\r\n{\r\nstruct nvkm_fifo *pfifo = nvkm_fifo(subdev);\r\nstruct nvkm_engine *engine = nv_engine(subdev);\r\nstruct nvkm_object *engctx;\r\nstruct g98_sec_priv *priv = (void *)subdev;\r\nu32 disp = nv_rd32(priv, 0x08701c);\r\nu32 stat = nv_rd32(priv, 0x087008) & disp & ~(disp >> 16);\r\nu32 inst = nv_rd32(priv, 0x087050) & 0x3fffffff;\r\nu32 ssta = nv_rd32(priv, 0x087040) & 0x0000ffff;\r\nu32 addr = nv_rd32(priv, 0x087040) >> 16;\r\nu32 mthd = (addr & 0x07ff) << 2;\r\nu32 subc = (addr & 0x3800) >> 11;\r\nu32 data = nv_rd32(priv, 0x087044);\r\nint chid;\r\nengctx = nvkm_engctx_get(engine, inst);\r\nchid = pfifo->chid(pfifo, engctx);\r\nif (stat & 0x00000040) {\r\nnv_error(priv, "DISPATCH_ERROR [");\r\nnvkm_enum_print(g98_sec_isr_error_name, ssta);\r\npr_cont("] ch %d [0x%010llx %s] subc %d mthd 0x%04x data 0x%08x\n",\r\nchid, (u64)inst << 12, nvkm_client_name(engctx),\r\nsubc, mthd, data);\r\nnv_wr32(priv, 0x087004, 0x00000040);\r\nstat &= ~0x00000040;\r\n}\r\nif (stat) {\r\nnv_error(priv, "unhandled intr 0x%08x\n", stat);\r\nnv_wr32(priv, 0x087004, stat);\r\n}\r\nnvkm_engctx_put(engctx);\r\n}\r\nstatic int\r\ng98_sec_ctor(struct nvkm_object *parent, struct nvkm_object *engine,\r\nstruct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nstruct g98_sec_priv *priv;\r\nint ret;\r\nret = nvkm_falcon_create(parent, engine, oclass, 0x087000, true,\r\n"PSEC", "sec", &priv);\r\n*pobject = nv_object(priv);\r\nif (ret)\r\nreturn ret;\r\nnv_subdev(priv)->unit = 0x00004000;\r\nnv_subdev(priv)->intr = g98_sec_intr;\r\nnv_engine(priv)->cclass = &g98_sec_cclass;\r\nnv_engine(priv)->sclass = g98_sec_sclass;\r\nnv_falcon(priv)->code.data = g98_psec_code;\r\nnv_falcon(priv)->code.size = sizeof(g98_psec_code);\r\nnv_falcon(priv)->data.data = g98_psec_data;\r\nnv_falcon(priv)->data.size = sizeof(g98_psec_data);\r\nreturn 0;\r\n}

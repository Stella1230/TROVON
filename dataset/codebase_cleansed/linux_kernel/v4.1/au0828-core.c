u32 au0828_readreg(struct au0828_dev *dev, u16 reg)\r\n{\r\nu8 result = 0;\r\nrecv_control_msg(dev, CMD_REQUEST_IN, 0, reg, &result, 1);\r\ndprintk(8, "%s(0x%04x) = 0x%02x\n", __func__, reg, result);\r\nreturn result;\r\n}\r\nu32 au0828_writereg(struct au0828_dev *dev, u16 reg, u32 val)\r\n{\r\ndprintk(8, "%s(0x%04x, 0x%02x)\n", __func__, reg, val);\r\nreturn send_control_msg(dev, CMD_REQUEST_OUT, val, reg);\r\n}\r\nstatic int send_control_msg(struct au0828_dev *dev, u16 request, u32 value,\r\nu16 index)\r\n{\r\nint status = -ENODEV;\r\nif (dev->usbdev) {\r\nstatus = usb_control_msg(dev->usbdev,\r\nusb_sndctrlpipe(dev->usbdev, 0),\r\nrequest,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR |\r\nUSB_RECIP_DEVICE,\r\nvalue, index, NULL, 0, 1000);\r\nstatus = min(status, 0);\r\nif (status < 0) {\r\npr_err("%s() Failed sending control message, error %d.\n",\r\n__func__, status);\r\n}\r\n}\r\nreturn status;\r\n}\r\nstatic int recv_control_msg(struct au0828_dev *dev, u16 request, u32 value,\r\nu16 index, unsigned char *cp, u16 size)\r\n{\r\nint status = -ENODEV;\r\nmutex_lock(&dev->mutex);\r\nif (dev->usbdev) {\r\nstatus = usb_control_msg(dev->usbdev,\r\nusb_rcvctrlpipe(dev->usbdev, 0),\r\nrequest,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\nvalue, index,\r\ndev->ctrlmsg, size, 1000);\r\nstatus = min(status, 0);\r\nif (status < 0) {\r\npr_err("%s() Failed receiving control message, error %d.\n",\r\n__func__, status);\r\n}\r\nmemcpy(cp, dev->ctrlmsg, size);\r\n}\r\nmutex_unlock(&dev->mutex);\r\nreturn status;\r\n}\r\nstatic void au0828_usb_release(struct au0828_dev *dev)\r\n{\r\nau0828_i2c_unregister(dev);\r\nkfree(dev);\r\n}\r\nstatic void au0828_usb_v4l2_release(struct v4l2_device *v4l2_dev)\r\n{\r\nstruct au0828_dev *dev =\r\ncontainer_of(v4l2_dev, struct au0828_dev, v4l2_dev);\r\nv4l2_ctrl_handler_free(&dev->v4l2_ctrl_hdl);\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\nau0828_usb_release(dev);\r\n}\r\nstatic void au0828_usb_disconnect(struct usb_interface *interface)\r\n{\r\nstruct au0828_dev *dev = usb_get_intfdata(interface);\r\ndprintk(1, "%s()\n", __func__);\r\ndev->dev_state = DEV_DISCONNECTED;\r\nau0828_rc_unregister(dev);\r\nau0828_dvb_unregister(dev);\r\nusb_set_intfdata(interface, NULL);\r\nmutex_lock(&dev->mutex);\r\ndev->usbdev = NULL;\r\nmutex_unlock(&dev->mutex);\r\n#ifdef CONFIG_VIDEO_AU0828_V4L2\r\nif (AUVI_INPUT(0).type != AU0828_VMUX_UNDEFINED) {\r\nau0828_analog_unregister(dev);\r\nv4l2_device_disconnect(&dev->v4l2_dev);\r\nv4l2_device_put(&dev->v4l2_dev);\r\nreturn;\r\n}\r\n#endif\r\nau0828_usb_release(dev);\r\n}\r\nstatic int au0828_usb_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nint ifnum;\r\nint retval = 0;\r\nstruct au0828_dev *dev;\r\nstruct usb_device *usbdev = interface_to_usbdev(interface);\r\nifnum = interface->altsetting->desc.bInterfaceNumber;\r\nif (ifnum != 0)\r\nreturn -ENODEV;\r\ndprintk(1, "%s() vendor id 0x%x device id 0x%x ifnum:%d\n", __func__,\r\nle16_to_cpu(usbdev->descriptor.idVendor),\r\nle16_to_cpu(usbdev->descriptor.idProduct),\r\nifnum);\r\nif (usbdev->speed != USB_SPEED_HIGH && disable_usb_speed_check == 0) {\r\npr_err("au0828: Device initialization failed.\n");\r\npr_err("au0828: Device must be connected to a high-speed USB 2.0 port.\n");\r\nreturn -ENODEV;\r\n}\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (dev == NULL) {\r\npr_err("%s() Unable to allocate memory\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nmutex_init(&dev->lock);\r\nmutex_lock(&dev->lock);\r\nmutex_init(&dev->mutex);\r\nmutex_init(&dev->dvb.lock);\r\ndev->usbdev = usbdev;\r\ndev->boardnr = id->driver_info;\r\n#ifdef CONFIG_VIDEO_AU0828_V4L2\r\ndev->v4l2_dev.release = au0828_usb_v4l2_release;\r\nretval = v4l2_device_register(&interface->dev, &dev->v4l2_dev);\r\nif (retval) {\r\npr_err("%s() v4l2_device_register failed\n",\r\n__func__);\r\nmutex_unlock(&dev->lock);\r\nkfree(dev);\r\nreturn retval;\r\n}\r\nretval = v4l2_ctrl_handler_init(&dev->v4l2_ctrl_hdl, 4);\r\nif (retval) {\r\npr_err("%s() v4l2_ctrl_handler_init failed\n",\r\n__func__);\r\nmutex_unlock(&dev->lock);\r\nkfree(dev);\r\nreturn retval;\r\n}\r\ndev->v4l2_dev.ctrl_handler = &dev->v4l2_ctrl_hdl;\r\n#endif\r\nau0828_write(dev, REG_600, 1 << 4);\r\nau0828_gpio_setup(dev);\r\nau0828_i2c_register(dev);\r\nau0828_card_setup(dev);\r\n#ifdef CONFIG_VIDEO_AU0828_V4L2\r\nif (AUVI_INPUT(0).type != AU0828_VMUX_UNDEFINED)\r\nau0828_analog_register(dev, interface);\r\n#endif\r\nretval = au0828_dvb_register(dev);\r\nif (retval)\r\npr_err("%s() au0282_dev_register failed\n",\r\n__func__);\r\nau0828_rc_register(dev);\r\nusb_set_intfdata(interface, dev);\r\npr_info("Registered device AU0828 [%s]\n",\r\ndev->board.name == NULL ? "Unset" : dev->board.name);\r\nmutex_unlock(&dev->lock);\r\nreturn retval;\r\n}\r\nstatic int au0828_suspend(struct usb_interface *interface,\r\npm_message_t message)\r\n{\r\nstruct au0828_dev *dev = usb_get_intfdata(interface);\r\nif (!dev)\r\nreturn 0;\r\npr_info("Suspend\n");\r\nau0828_rc_suspend(dev);\r\nau0828_v4l2_suspend(dev);\r\nau0828_dvb_suspend(dev);\r\nreturn 0;\r\n}\r\nstatic int au0828_resume(struct usb_interface *interface)\r\n{\r\nstruct au0828_dev *dev = usb_get_intfdata(interface);\r\nif (!dev)\r\nreturn 0;\r\npr_info("Resume\n");\r\nau0828_write(dev, REG_600, 1 << 4);\r\nau0828_gpio_setup(dev);\r\nau0828_rc_resume(dev);\r\nau0828_v4l2_resume(dev);\r\nau0828_dvb_resume(dev);\r\nreturn 0;\r\n}\r\nstatic int __init au0828_init(void)\r\n{\r\nint ret;\r\nif (au0828_debug & 1)\r\npr_info("%s() Debugging is enabled\n", __func__);\r\nif (au0828_debug & 2)\r\npr_info("%s() USB Debugging is enabled\n", __func__);\r\nif (au0828_debug & 4)\r\npr_info("%s() I2C Debugging is enabled\n", __func__);\r\nif (au0828_debug & 8)\r\npr_info("%s() Bridge Debugging is enabled\n",\r\n__func__);\r\nif (au0828_debug & 16)\r\npr_info("%s() IR Debugging is enabled\n",\r\n__func__);\r\npr_info("au0828 driver loaded\n");\r\nret = usb_register(&au0828_usb_driver);\r\nif (ret)\r\npr_err("usb_register failed, error = %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit au0828_exit(void)\r\n{\r\nusb_deregister(&au0828_usb_driver);\r\n}

static int __init apc_setup(char *str)\r\n{\r\nif(!strncmp(str, "noidle", strlen("noidle"))) {\r\napc_no_idle = 1;\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void apc_swift_idle(void)\r\n{\r\n#ifdef APC_DEBUG_LED\r\nset_auxio(0x00, AUXIO_LED);\r\n#endif\r\napc_writeb(apc_readb(APC_IDLE_REG) | APC_IDLE_ON, APC_IDLE_REG);\r\n#ifdef APC_DEBUG_LED\r\nset_auxio(AUXIO_LED, 0x00);\r\n#endif\r\n}\r\nstatic inline void apc_free(struct platform_device *op)\r\n{\r\nof_iounmap(&op->resource[0], regs, resource_size(&op->resource[0]));\r\n}\r\nstatic int apc_open(struct inode *inode, struct file *f)\r\n{\r\nreturn 0;\r\n}\r\nstatic int apc_release(struct inode *inode, struct file *f)\r\n{\r\nreturn 0;\r\n}\r\nstatic long apc_ioctl(struct file *f, unsigned int cmd, unsigned long __arg)\r\n{\r\n__u8 inarg, __user *arg = (__u8 __user *) __arg;\r\nswitch (cmd) {\r\ncase APCIOCGFANCTL:\r\nif (put_user(apc_readb(APC_FANCTL_REG) & APC_REGMASK, arg))\r\nreturn -EFAULT;\r\nbreak;\r\ncase APCIOCGCPWR:\r\nif (put_user(apc_readb(APC_CPOWER_REG) & APC_REGMASK, arg))\r\nreturn -EFAULT;\r\nbreak;\r\ncase APCIOCGBPORT:\r\nif (put_user(apc_readb(APC_BPORT_REG) & APC_BPMASK, arg))\r\nreturn -EFAULT;\r\nbreak;\r\ncase APCIOCSFANCTL:\r\nif (get_user(inarg, arg))\r\nreturn -EFAULT;\r\napc_writeb(inarg & APC_REGMASK, APC_FANCTL_REG);\r\nbreak;\r\ncase APCIOCSCPWR:\r\nif (get_user(inarg, arg))\r\nreturn -EFAULT;\r\napc_writeb(inarg & APC_REGMASK, APC_CPOWER_REG);\r\nbreak;\r\ncase APCIOCSBPORT:\r\nif (get_user(inarg, arg))\r\nreturn -EFAULT;\r\napc_writeb(inarg & APC_BPMASK, APC_BPORT_REG);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int apc_probe(struct platform_device *op)\r\n{\r\nint err;\r\nregs = of_ioremap(&op->resource[0], 0,\r\nresource_size(&op->resource[0]), APC_OBPNAME);\r\nif (!regs) {\r\nprintk(KERN_ERR "%s: unable to map registers\n", APC_DEVNAME);\r\nreturn -ENODEV;\r\n}\r\nerr = misc_register(&apc_miscdev);\r\nif (err) {\r\nprintk(KERN_ERR "%s: unable to register device\n", APC_DEVNAME);\r\napc_free(op);\r\nreturn -ENODEV;\r\n}\r\nif (!apc_no_idle)\r\nsparc_idle = apc_swift_idle;\r\nprintk(KERN_INFO "%s: power management initialized%s\n",\r\nAPC_DEVNAME, apc_no_idle ? " (CPU idle disabled)" : "");\r\nreturn 0;\r\n}\r\nstatic int __init apc_init(void)\r\n{\r\nreturn platform_driver_register(&apc_driver);\r\n}
